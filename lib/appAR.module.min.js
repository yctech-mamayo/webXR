function UI(){this.setProjectModal=function(e){if(projectPicture.innerHTML="",projectNameInfo.innerHTML=e.proj_name,projectUserName.innerHTML=e.name,projectLastUpdateDate.textContent=e.last_update_date.substring(0,10),console.log("arUI.js: setProjectModal: chooseProject ",e),Array.isArray(e.loc))if(e.loc.length>1&&e.module_type.find((function(e){return"gps"==e}))){console.log("arUI.js: showProjectInfo: project with gps ",e,"\n",e.loc[0]+", "+e.loc[1]),projectGPSDiv.style.display="block",projectGPSDivEndLine.style.display="block",projectStartButton.style.pointerEvents="none",startBGImage.style.display="none",startTitle.textContent="wait for GPS",projectGPSInfo.textContent=e.loc[0]+", "+e.loc[1];let t=window.geoState=0;if(navigator.geolocation){navigator.geolocation.getCurrentPosition((function(e){console.log("arUI.js: showProjectInfo: get Geolocation position=.",e.coords.latitude,e.coords.longitude),t=1}),(function(e){console.log("arUI.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),t=2}),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0})}else console.log("arUI.js: showProjectInfo: Geolocation is not supported by this browser."),t=3;!function r(){if(0==t)setTimeout(r,1e3);else if(1==t){navigator.geolocation.getCurrentPosition((function(t){console.log("arUI.js: showProjectInfo: geoPosition = ",t.coords.latitude,t.coords.longitude),function(e,t,r,o,i="K"){if(e==r&&t==o)return 0;{let n=Math.PI*e/180,a=Math.PI*r/180,s=t-o,l=Math.PI*s/180,c=Math.sin(n)*Math.sin(a)+Math.cos(n)*Math.cos(a)*Math.cos(l);c>1&&(c=1),c=Math.acos(c),c=180*c/Math.PI,c=60*c*1.1515,"K"==i&&(c*=1.609344),"N"==i&&(c*=.8684),console.log("arUI.js: calculateGeosToDistanceGCD: dist=",c)}}(t.coords.latitude,t.coords.longitude,e.loc[0],e.loc[1]);let r=function(e,t,r,o,i="M"){if(e==r&&t==o)return 0;{let n=Math.PI*e/180,a=Math.PI*r/180,s=n-a,l=Math.PI*t/180-Math.PI*o/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(s/2),2)+Math.cos(n)*Math.cos(a)*Math.pow(Math.sin(l/2),2)));return"M"==i&&(c*=6378137),console.log("arUI.js: calculateGeosToDistanceHaversine dist=",c),c}}(t.coords.latitude,t.coords.longitude,e.loc[0],e.loc[1]);projectGPSInfo.textContent=e.loc[0]+", "+e.loc[1]+", dist="+Math.floor(r),getViewerConfig(serverUrl,(function(e){r<e.data.gps_range_distance?(projectStartButton.style.pointerEvents="auto",startBGImage.style.display="inline",startTitle.textContent=parent.htmlContent.modalButtonStart[parent.languageType]):(projectStartButton.style.pointerEvents="none",startBGImage.style.display="none",startTitle.textContent=parent.htmlContent.modalButtonDisable[parent.languageType])}))}),(function(e){console.warn("arUI.js: showProjectInfo: e=",e.code,e.message),projectStartButton.style.pointerEvents="none",startBGImage.style.display="none",startTitle.textContent="GPS error"}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}else console.warn("arUI.js: showProjectInfo: not allow GPS, geoState = ",t),projectStartButton.style.pointerEvents="none",startBGImage.style.display="none",startTitle.textContent="GPS not support"}()}else projectGPSDiv.style.display="none",projectGPSDivEndLine.style.display="none",projectStartButton.style.pointerEvents="auto",startBGImage.style.display="inline",startTitle.textContent=parent.htmlContent.modalButtonStart[parent.languageType];switch(e.proj_type){case"ar":projectTypeInfo.innerHTML="AR 圖像辨識",projectUsageInfo.innerHTML="掃描辨識圖即可觀賞AR",projectPicture.style.display="block",getARProjsByProjID([e.proj_id],(function(e){let t=e.data.result[0].targets_img_urls;if(Array.isArray(t)){scanList.style.display="block",scanListEndLine.style.display="block";for(let e=0;e<t.length;e++){let r=document.createElement("img");r.src=t[e],projectPicture.appendChild(r)}}else scanList.style.display="none",scanListEndLine.style.display="none"})),projectStartButton.onclick=function(){console.log("UI.js: ar to ar, click"),document.getElementById("snapshot_"+parent.selectedProject.proj_id).className="circular--square",parent.aUI.startCoreIframe(e,!1);for(let t=0;t<publishARProjs.result.length;t++)if(publishARProjs.result[t].proj_id==e.proj_id){console.log("UI.js: _setProjectModal: i=",t),document.getElementById("snapshot_"+e.proj_id).className="circular--square-marker",projectModal.style.display="none";break}};break;case"vr":projectTypeInfo.innerHTML="VR 虛擬實境",projectUsageInfo.innerHTML="開啟專案即可觀賞VR",projectPicture.style.display="none",scanList.style.display="none",scanListEndLine.style.display="none",projectStartButton.onclick=function(){console.log("UI.js: ar to vr, click"),leavedSendLog(),parent.aUI.startCoreIframe(e,!0)};break;case"ar_slam":projectTypeInfo.innerHTML="AR 空間辨識",projectUsageInfo.innerHTML="開啟專案即可觀賞AR",projectPicture.style.display="none",scanList.style.display="none",scanListEndLine.style.display="none",projectStartButton.onclick=function(){console.log("UI.js: ar to xr, click"),leavedSendLog(),parent.aUI.startCoreIframe(e,!0)}}projectDescription.textContent=e.proj_descr,function e(){var t=projectStartButton.offsetTop-projectDescriptionDiv.offsetTop-projectDescriptionTitle.offsetHeight-10;projectDescription.style.height=t+"px",setTimeout(e,3e3)}()},this.cleanProjectModal=function(){},this.setProjectTable=function(){let e=document.getElementById("projsTable"),t=e.rows.proj_snapshot,r=e.rows.proj_name,o=t.children.length,i=r.children.length;for(let e=0;e<o;e++)t.deleteCell(0);for(let e=0;e<i;e++)r.deleteCell(0);if(userPublishProjs){let e=0;for(let o=0;o<userPublishProjs.proj_list.length;o++){if(parent.useEditorWebTag&&!userPublishProjs.proj_list[o].proj_platform.find((e=>"web"==e)))continue;let i=r.insertCell(e);i.style.paddingLeft=0==e?"16px":"8px";let n=document.createElement("div");n.innerText=userPublishProjs.proj_list[o].proj_name,n.className="projNameOneRow",i.appendChild(n);let a=t.insertCell(e);a.style.paddingLeft=0==e?"16px":"8px",1==window.allowedMakarIDUseWeb||1==userPublishProjs.proj_list[o].web_ar||(a.style.opacity=.5,a.style.pointerEvents="none",n.style.opacity=.5,n.style.pointerEvents="none");let s=document.createElement("img");if(s.src=userPublishProjs.proj_list[o].snapshot_url,s.width=50,s.height=50,s.className="circular--square",s.setAttribute("id","snapshot_"+userPublishProjs.proj_list[o].proj_id),parent.selectedProject&&userPublishProjs.proj_list[o].proj_id==parent.selectedProject.proj_id){s.className="circular--square-marker";let e=leftTopButton.children[0].innerHTML.replace("專案標題",userPublishProjs.proj_list[o].proj_name);leftTopButton.children[0].innerHTML=e}s.onclick=function(){1==window.allowedMakarIDUseWeb||1==userPublishProjs.proj_list[o].web_ar?(console.log("UI.js: _img click, switch project( allow ) ",window.allowedMakarIDUseWeb,userPublishProjs.proj_list[o].web_ar),projectModal.style.display="block",arUI.setProjectModal(userPublishProjs.proj_list[o])):console.log("UI.js: _img click, switch project( denied ) ",window.allowedMakarIDUseWeb,userPublishProjs.proj_list[o].web_ar)},a.appendChild(s),e++}let o=r.insertCell(0);o.style.paddingLeft="25px",o.style.paddingRight="15px",o.style.borderRight="1px solid white";let i=document.createElement("div");i.innerText="作者頁面",i.className="projNameOneRow",o.appendChild(i);let n=t.insertCell(0);n.style.paddingLeft="25px",n.style.paddingRight="15px",n.style.borderRight="1px solid white";let a=document.createElement("img");getOneUserInfo(window.serverUrl,userPublishProjs.proj_list[0].user_id,["head_pic"],(function(e){""!=e.data.head_pic?a.src=e.data.head_pic:a.src="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/icon/me2.png"})),a.style.borderRadius="50%",a.width=50,a.height=50,n.appendChild(a)}}}let arUI=new UI;function scracthCard(){"use strict";this.moduleLoaded=!1,this.currentMakarObject=null;var e=this;this.createContent=function(){this.scratchCardExchangeDiv=document.createElement("div"),this.scratchCardExchangeDiv.setAttribute("id","scratchCardExchangeDiv"),this.scratchCardExchangeDiv.innerText="尚未完成括括卡",this.scratchCardExchangeDiv.style.width="100%",this.scratchCardExchangeDiv.style.left="0%",this.scratchCardExchangeDiv.style.bottom="60px",this.scratchCardExchangeDiv.addEventListener("click",(function(e){let t=aScratchCard.currentMakarObject;t.scratchedAreaPercentage>30&&-1==t.exchanged?(console.log("-------------------------- can exchange show Div ",t.scratchedAreaPercentage,publishARProjs.proj_list[t.parent.GCSSID]),document.getElementById("inputPasswordDiv").style.display="inline"):console.log("-------------------------- can not exchange ",t.scratchedAreaPercentage,t.exchanged)}),!1),document.body.appendChild(this.scratchCardExchangeDiv),this.inputPasswordDiv=document.createElement("div"),this.inputPasswordDiv.setAttribute("id","inputPasswordDiv"),document.body.appendChild(this.inputPasswordDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.inputPasswordDiv.style.left=(innerWidth-e)/2+"px",this.inputPasswordDiv.style.top=(innerHeight-t)/2+"px",this.inputPasswordDiv.style.width=e+"px",this.inputPasswordDiv.style.height=t+"px",this.inputPasswordDiv.innerHTML="<br> 輸入密碼 <br>";var r=document.createElement("input");r.setAttribute("id","inputPasswordInputText"),r.setAttribute("type","text"),r.setAttribute("placeholder","pwd"),this.inputPasswordDiv.appendChild(r);var o=document.createElement("div");o.setAttribute("id","inputPasswordResultText"),this.inputPasswordDiv.appendChild(o),o.innerText="";var i=document.createElement("div");i.setAttribute("class","bottomLeftCell"),i.setAttribute("id","scratchCardPasswordCancel"),i.innerText="取消",this.inputPasswordDiv.appendChild(i),i.addEventListener("click",(function(){inputPasswordDiv.style.display="none",r.value="",o.innerText=""}));var n=document.createElement("div");n.setAttribute("class","bottomRightCell"),n.setAttribute("id","scratchCardPasswordConfirm"),n.innerText="確認",this.inputPasswordDiv.appendChild(n),n.addEventListener("click",this.passwordConfirm)},this.passwordConfirm=function(){if(inputPasswordInputText.value==e.currentMakarObject.password){inputPasswordResultText.innerText="密碼正確",scratchCardExchangeDiv.innerText="已兌換",e.currentMakarObject.exchanged=1,setTimeout((function(){inputPasswordDiv.style.display="none"}),1e3);let t=e.currentMakarObject,r=3;parent.mdb.setScratchProjectStateFromProjID(publishARProjs.proj_list[t.parent.GCSSID].proj_id,r).then((e=>{e.is_exchanged=!0,delete e.scratch_image_url,delete e.awards_image_url,console.log("scratchCard.js: _passwordConfirm: exchange upload setProjRet= ",e),scratchCardLog(window.serverUrl,e)}))}else inputPasswordResultText.innerText="密碼錯誤"},this.hideScratchCanvas=function(e){for(let t in e.children){let r=e.children[t];if("module"==r.main_type&&"scratch_card"==r.sub_type){r.canvasDomElement.style.display="none",this.scratchCardExchangeDiv.style.display="none",this.inputPasswordDiv.style.display="none",inputPasswordInputText.value="",inputPasswordResultText.innerText=""}}},this.showScratchCanvas=function(e){for(let t in e.children){let r=e.children[t];if("module"==r.main_type&&"scratch_card"==r.sub_type){let e=r.canvasDomElement;console.log("scratchCard.js: _showScratchCanvas: makarObj=",r),r.scratchedAreaPercentage>30?r.exchanged>0?this.scratchCardExchangeDiv.innerText="已兌換":this.scratchCardExchangeDiv.innerText="按此兌換獎項":this.scratchCardExchangeDiv.innerText="尚未完成括括卡",e.style.display="inline",this.scratchCardExchangeDiv.style.display="inline",this.currentMakarObject=r}}},this.clearScratchCanvas=function(e){e.scratchedAreaPercentage=100;let t=e.canvasDomElement.children[0];t&&(t.parentNode.removeChild(t),e.canvasDomElement.parentNode.removeChild(e.canvasDomElement)),e.exchanged>0?this.scratchCardExchangeDiv.innerText="已兌換":this.scratchCardExchangeDiv.innerText="按此兌換獎項"},this.randomChooseAward=function(e){let t=null;if(Array.isArray(e.project_module)&&1==e.project_module.length&&(t=e.project_module[0].award_list),!t)return-1;let r=0,o=[];for(let e in t)r+=t[e].probability,o.push(r);let i=Math.floor(Math.random()*r)+1,n=-1;console.log("scratchCard.js: _chooseAward: awardArray=",o,", getNum=",i);for(let e=0;e<o.length;e++)if(i<=o[e]){n=e;break}return n},this.clearScratchCard=function(){},this.setCanvas=function(t,r,o){this.moduleLoaded||(this.createContent(),this.moduleLoaded=!0),this.scratchCardExchangeDiv.style.display="inline",this.scratchCardExchangeDiv.innerText="尚未完成括括卡",o.scratchedAreaPercentage=-1,o.exchanged=-1,this.currentMakarObject=o;let i=t,n=i.width,a=i.height,s=i.getContext("2d");var l,c;let d=new Image;d.onload=function(){};let u=new XMLHttpRequest;function h(e,t){var r=0,o=0;if(void 0!==t.offsetParent)do{r+=t.offsetLeft,o+=t.offsetTop}while(t=t.offsetParent);return{x:(e.pageX||e.touches[0].clientX)-r,y:(e.pageY||e.touches[0].clientY)-o}}function p(e){l=!0,c=h(e,i)}function m(t){if(l){t.preventDefault();for(var r,u,p,m,f=h(t,i),g=(p=c,m=f,Math.sqrt(Math.pow(m.x-p.x,2)+Math.pow(m.y-p.y,2))),b=function(e,t){return Math.atan2(t.x-e.x,t.y-e.y)}(c,f),_=0;_<g;_++)r=c.x+Math.sin(b)*_-15,u=c.y+Math.cos(b)*_-15,s.globalCompositeOperation="destination-out",s.drawImage(d,r,u,80,40);c=f,function(t){if(t=t||0,o.scratchedAreaPercentage=t,t>30){console.log("scratchCard.js: _handlePercentage: clear scratch canvas ",e.currentMakarObject),e.clearScratchCanvas(e.currentMakarObject);let t=2;parent.mdb.setScratchProjectStateFromProjID(publishARProjs.proj_list[o.parent.GCSSID].proj_id,t).then((e=>{console.log("scratchCard.js: _passwordConfirm: exchange upload setProjRet= ",e),scratchCardLog(window.serverUrl,e)})),o.exchanged>0?scratchCardExchangeDiv.innerText="已兌換":scratchCardExchangeDiv.innerText="按此兌換獎項"}else scratchCardExchangeDiv.innerText="尚未完成括括卡"}(function(e){(!e||e<1)&&(e=1);for(var t=s.getImageData(0,0,n,a).data,r=t.length,o=r/e,i=0,l=i=0;l<r;l+=e)t[l+0]+t[l+1]+t[l+2]===0&&i++;return Math.round(i/o*100)}(32))}}function f(e){l=!1}u.open("GET","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/brush.png"),u.responseType="blob",u.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);d.src=t},u.send(),i.addEventListener("mousedown",p,!1),i.addEventListener("touchstart",p,!1),i.addEventListener("mousemove",m,!1),i.addEventListener("touchmove",m,!1),i.addEventListener("mouseup",f,!1),i.addEventListener("touchend",f,!1)}}let aScratchCard=new scracthCard;function pointCard(){"use strict";this.moduleLoaded=!1,this.currentMarkerRoot2D=null,this.mdb=null,this.canExchange=!1;let e=this;parent.mdb?this.mdb=parent.mdb:console.log("pointCard.js: the parent mdb not existm, error"),this.createPointCardContent=function(t){if(this.moduleLoaded)return;this.moduleLoaded=!0,this.currentMarkerRoot2D=t,this.currentMarkerRoot2D.exchanged=-1,this.pointCardExchangeDiv=document.createElement("div"),this.pointCardExchangeDiv.setAttribute("id","pointCardExchangeDiv"),this.pointCardExchangeDiv.setAttribute("class","moduleExchangeDiv"),this.pointCardExchangeDiv.style.display="inline",this.pointCardExchangeDiv.style.width="100%",this.pointCardExchangeDiv.style.left="0%",this.pointCardExchangeDiv.style.bottom="60px",this.pointCardExchangeDiv.innerText="text",this.pointCardExchangeDiv.onclick=function(t){console.log("pointCard.js: _exChangeClick: self.canExchange = ",e.canExchange),e.canExchange&&(e.pointCardPWDBG.style.display="inline")},document.body.appendChild(this.pointCardExchangeDiv),this.pointCardPWDBG=document.createElement("div"),this.pointCardPWDBG.setAttribute("id","pointCardPWDBG"),this.pointCardPWDBG.setAttribute("class","backgroundModal"),document.body.appendChild(this.pointCardPWDBG),this.pointCardPWDiv=document.createElement("div"),this.pointCardPWDiv.setAttribute("id","pointCardPWDiv"),this.pointCardPWDiv.setAttribute("class","modulePWDDiv"),this.pointCardPWDiv.style.display="block",this.pointCardPWDBG.appendChild(this.pointCardPWDiv);let r=innerWidth>600?300:.5*innerWidth,o=innerHeight>900?270:.3*innerHeight;this.pointCardPWDiv.style.left=(innerWidth-r)/2+"px",this.pointCardPWDiv.style.top=(innerHeight-o)/2+"px",this.pointCardPWDiv.style.width=r+"px",this.pointCardPWDiv.style.height=o+"px",this.pointCardPWDiv.innerHTML="<br> 輸入密碼 <br>";var i=document.createElement("input");i.setAttribute("id","pointCardPWDInputText"),i.setAttribute("class","modulePWDInputText"),i.setAttribute("type","text"),i.setAttribute("placeholder","pwd"),this.pointCardPWDiv.appendChild(i);var n=document.createElement("div");n.setAttribute("id","pointCardPWDRetText"),n.setAttribute("class","modulePWDRetText"),this.pointCardPWDiv.appendChild(n),n.innerText="";var a=document.createElement("div");a.setAttribute("class","bottomLeftCell"),a.setAttribute("id","pointCardPWDCancel"),a.innerText="取消",this.pointCardPWDiv.appendChild(a),a.onclick=function(){console.log("pointCard.js: cancel button click "),pointCardPWDBG.style.display="none",i.value="",n.innerText=""};var s=document.createElement("div");s.setAttribute("class","bottomRightCell"),s.setAttribute("id","pointCardPWDConfirm"),s.innerText="確認",this.pointCardPWDiv.appendChild(s),s.onclick=this.passwordConfirm},this.passwordConfirm=function(){pointCardPWDInputText.value==e.currentMarkerRoot2D.project_module.reward_password?(console.log("pointCard.js: confirm button click password correct ",pointCardPWDInputText.value,e.currentMarkerRoot2D.project_module.reward_password),pointCardPWDRetText.innerText="密碼正確",e.pointCardExchangeDiv.innerText="已兌換",e.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",e.currentMarkerRoot2D.exchanged=1,e.canExchange=!1,console.log("pointCard.js: _passwordConfirm: self.currentMarkerRoot2D = ",e.currentMarkerRoot2D),parent.mdb.getPointCardProject(e.currentMarkerRoot2D.proj_id).then((e=>{console.log("pointCard.js: _passwordConfirm getProjRet = ",e),e.is_exchanged=!0,parent.mdb.setPointCardProject(e).then((t=>{console.log("pointCard.js: _setPointCardProject setProjRet = ",t);let r={user_id:e.user_id,playing_user:"",proj_id:e.proj_id,proj_type:"ar",card_id:e.card_id,device_id:e.device_id,can_reward_point_count:e.can_reward_point_count,is_exchanged:!0,brand:"",os:Browser.name+Browser.version,location_long:0,location_lan:0};console.log(" pointCard.js: _passwordConfirm: collect target upload=",r),pointCardLog(window.serverUrl,r)}))})),setTimeout((function(){e.pointCardPWDBG.style.display="none"}),2e3)):(console.log("pointCard.js: confirm button click password wrong ",pointCardPWDInputText.value,e.currentMarkerRoot2D.project_module.reward_password),pointCardPWDRetText.innerText="密碼錯誤")},this.showPointCardCanvas=function(t,r,o){console.log("pointCard.js: _showPointCardCanvas: diffPoints=",r,o),e.currentMarkerRoot2D=t,this.pointCardExchangeDiv.style.display="inline",o?(this.pointCardExchangeDiv.innerText="已兌換",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",e.canExchange=!1):r>=0?(e.canExchange=!0,this.pointCardExchangeDiv.innerText="按此兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)"):(e.canExchange=!1,this.pointCardExchangeDiv.innerText="還差 "+-r+" 點就可兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )")},this.hidePointCardCanvas=function(e){console.log("pointCard.js: _hidePointCardCanvas: obj_2D = ",e),(e.loadModule="pointCard")&&(this.pointCardExchangeDiv.style.display="none",this.pointCardPWDBG.style.display="none",pointCardPWDInputText.value="",pointCardPWDRetText.innerText="")},this.setPointCardProject=function(e,t){parent.mdb.setPointCardProject(e).then((e=>{console.log("pointCard.js: _setPointCardProject projRet = ",e),t&&t(e)}))},this.getPointCardProject=function(e,t){parent.mdb.getPointCardProject(e).then((e=>{console.log("pointCard.js: _getPointCardProject projRet = ",e),t&&t(e)}))},this.addPoint=function(t,r,o){let i=t.collected_points.find((function(e){return e==r}));i?(console.log("pointCard.js: _addPoint: there alreay are project, and got target: ",i,t),o&&o(t)):(console.log("pointCard.js: _addPoint: there alreay are project, but no got target: ",i,t),t.collected_points.push(r),e.setPointCardProject(t,(e=>{parent.mdb.getPointCardProject(t.proj_id).then((e=>{console.log("pointCard.js: _addPoint: projRet = ",e),o&&o(e)}))})))}}let aPointCard=new pointCard;!function(){var e=function(){ARController.getUserMediaThreeScene=function(e){var t={};for(var r in e)t[r]=e[r];var o=e.onSuccess;return t.onSuccess=function(e,t){var r=e.createThreeScene();o(r,e,t)},this.getUserMediaARController(t)},ARController.prototype.UrlExistsFetch=async function(e){let t=await fetch(e,{method:"HEAD"});return console.log("_ARController: _UrlExistsFetch: ret ",t),!!t.status&&"200"==t.status},ARController.prototype.createThreeScene=function(e){e=e||this.image,this.setupThree();var t=new THREE.VideoTexture(e);t.minFilter=THREE.LinearFilter,t.flipY=!1,this.cameraTexture=t;var r=new THREE.Mesh(new THREE.PlaneGeometry(t.image.videoWidth,t.image.videoHeight),new THREE.MeshBasicMaterial({map:t,side:THREE.BackSide}));r.material.depthTest=!1,r.material.depthWrite=!1,r.position.set(0,0,-1);var o=new THREE.OrthographicCamera(-t.image.videoWidth/2,t.image.videoWidth/2,-t.image.videoHeight/2,t.image.videoHeight/2,-100,2e4);let i,n,a=document.getElementById("arfScene"),s=t.image.videoWidth,l=t.image.videoHeight;window.innerWidth/window.innerHeight>s/l?(i=window.innerWidth,n=window.innerWidth/s*l):(i=window.innerHeight/l*s,n=window.innerHeight);var c=new THREE.OrthographicCamera(-i/2,i/2,-n/2,n/2,-100,2e4),d=new THREE.Scene;d.name="videoScene",d.add(r),d.add(o);var u=new THREE.Scene;u.name="glScene";var h=new THREE.Scene;h.name="scene2D";var p=new THREE.Scene,m=new THREE.PerspectiveCamera(45,1.33333,1,2e4);if(m.projectionMatrix.fromArray(this.getCameraMatrix()),m.rotation.set(0,180*Math.PI/180,180*Math.PI/180),m.projectionMatrix.elements[5]=-m.projectionMatrix.elements[5],m.projectionMatrix.elements[8]=-m.projectionMatrix.elements[8],m.projectionMatrix.elements[9]=-m.projectionMatrix.elements[9],m.projectionMatrix.elements[10]=-m.projectionMatrix.elements[10],m.projectionMatrix.elements[11]=-m.projectionMatrix.elements[11],m.projectionMatrixInverse.getInverse)m.projectionMatrixInverse.getInverse(m.projectionMatrix);else{let e=m.projectionMatrix.clone();m.projectionMatrixInverse.copy(e.invert())}let f=m.clone(),g=document.getElementById("oCamera"),b=new THREE.PerspectiveCamera(60,i/n,.3,1e4),_=g.getObject3D("camera").position.clone();b.position.copy(_);let v={aspect:i/n,near:.3,far:1e4,fov:60};g.setObject3D("camera",b),g.setAttribute("camera",v),g.components.camera.camera=b,g.components["orbit-controls"].controls.object=b;var y=new THREE.PerspectiveCamera(45,1.33333,1,2e4);y.projectionMatrix.fromArray(this.getCameraMatrix()),this.orientation,this.glScene=u,this.camera=m,this.aCamera=m,this.oCamera=g,this.oCamera3D=b,this.bkCamera=f,this.CSScamera=y,this.videoCamera=o,this.videoScene=d,this.scene2D=h,this.camera2D=c,this.videoStreamPlane=r,this.enableTracking=!0;var w=new THREE.Clock;this.clock=w,this.cssScene=p;var E=this;return{glScene:u,videoScene:d,scene2D:h,cssScene:p,camera:m,CSScamera:y,videoCamera:o,camera2D:c,arController:this,video:e,clock:w,process:function(){for(var t in E.aframeNFTMarkers)E.aframeNFTMarkers[t].object3D.visible=!1;E.process(e)},renderOn:function(e,r){t.needsUpdate=!0,e.autoClear=!1,E.arScene.video.paused||e.render(this.videoScene,this.videoCamera),e.clearDepth(),e.render(a.object3D,arController.camera),e.render(this.scene2D,this.camera2D)}}},ARController.prototype.createThreeMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.markerTracker=this.trackPatternMarkerId(e,t),r.matrixAutoUpdate=!1,this.threePatternMarkers[e]=r,r},ARController.prototype.createThreeNFTMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.visible=!1,r.GCSSID=e,r.loadedObjects=!1,r.showObjects=!0,r.matrixAutoUpdate=!1,this.threeNFTMarkers[e]=r,r},ARController.prototype.createAframeNFTMarker=function(e){this.setupThree();let t=document.createElement("a-entity"),r=this;if(e<publishARProjs.result.length){let o=publishARProjs.result[e].target_ids[0];t_index=r.sceneTargetList.findIndex((e=>e.target_id==o)),t.setAttribute("id",o),t.GCSSID=t_index}return t.setAttribute("visible",!1),t.loadedObjects=!1,t.showObjects=!0,t.addEventListener("loaded",(function(){t.object3D.matrixAutoUpdate=!1,t.object3D.targetRoot=!0})),this.aframeNFTMarkers[e]=t,t},ARController.prototype.createThreeNFTMarker2D=function(e){this.setupThree();let t=this;var r=new THREE.Object3D;if(r.visible=!1,e<publishARProjs.result.length&&e>-1){let o=publishARProjs.result[e].target_ids[0];t_index=t.sceneTargetList.findIndex((e=>e.target_id==o)),r.GCSSID=t_index}else r.GCSSID=e;return r.loadedObjects=!1,r.matrixAutoUpdate=!1,this.threeNFTMarkers2D[e]=r,r},ARController.prototype.createThreeNFTMarkerCSS=function(e){var t=new THREE.Object3D;return t.visible=!1,t.GCSSID=e,t.loadedObjects=!1,t.matrixAutoUpdate=!1,this.threeNFTMarkersCSS[e]=t,t},ARController.prototype.createThreeMultiMarker=function(e){this.setupThree();var t=new THREE.Object3D;return t.matrixAutoUpdate=!1,t.markers=[],this.threeMultiMarkers[e]=t,t},ARController.prototype.createThreeBarcodeMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.markerTracker=this.trackBarcodeMarkerId(e,t),r.matrixAutoUpdate=!1,this.threeBarcodeMarkers[e]=r,r},ARController.prototype.setupThree=function(){if(!this.THREE_JS_ENABLED){this.THREE_JS_ENABLED=!0;var e=this;this.addEventListener("loadNFTDone",(function(t){e.gcssTargets=t.data})),this.addEventListener("getMarker",(function(e){var t;e.data.marker})),this.addEventListener("getFrameTarget",(function(t){if(console.log("three.js, listened getFrameTarget, ev=",t),t.data.index<0){if(console.log("three.js: listened getFrameTarget index < 0, return ",this.threeNFTMarkers2D[-3]),this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name){this.threeNFTMarkers2D[-3].visible=!0;let e=this;setTimeout((function(){e.threeNFTMarkers2D[-3].visible=!1}),2e3)}}else{this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name&&(this.threeNFTMarkers2D[-3].visible=!1);var r=t.data.uArray,o=new ImageData(r,256,256);this.targetCtx.putImageData(o,0,0);let i=this.aframeNFTMarkers[e.sceneTargetList[t.data.index].projIndex],n=this.threeNFTMarkers2D[e.sceneTargetList[t.data.index].projIndex],a=this.threeNFTMarkersCSS[e.sceneTargetList[t.data.index].projIndex];console.log("artk.three.js, listened getFrameTarget, obj=",i,"\nobj2D=",n),console.log(" ************* ",t.data.index,e.sceneTargetList[t.data.index].projIndex),i.coloringStatus=1,i.loadModel=!0,e.loadMakarScene(t.data.index,i,n,a)}})),this.addEventListener("getNFTMarkerDraw",(function(t){let r=t.data.marker,o=this.aframeNFTMarkers[e.sceneTargetList[r.id].projIndex],i=this.threeNFTMarkers2D[e.sceneTargetList[r.id].projIndex],n=this.threeNFTMarkersCSS[e.sceneTargetList[r.id].projIndex];if(o){if(!o.loadedObjects||!i.loadedObjects){o.loadedObjects=i.loadedObjects=!0;let t=document.getElementById("clickToPlayAudio");t.style.display="none",t.onclick=null;let a=e.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[a].loc))if(publishARProjs.proj_list[a].loc.length>1&&publishARProjs.proj_list[a].module_type.find((function(e){return"gps"==e}))){if(warnButtonTitle.textContent=u.comfirm[d],warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none",o.loadedObjects=i.loadedObjects=!1},navigator.geolocation){navigator.geolocation.getCurrentPosition((function(t){console.log("three.js: showProjectInfo: get Geolocation geoPosition=.",t.coords.latitude,t.coords.longitude);let s=function(e,t,r,o,i="M"){if(e==r&&t==o)return 0;{let n=Math.PI*e/180,a=Math.PI*r/180,s=n-a,l=Math.PI*t/180-Math.PI*o/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(s/2),2)+Math.cos(n)*Math.cos(a)*Math.pow(Math.sin(l/2),2)));return"M"==i&&(c*=6378137),console.log("three.js: calculateGeosToDistanceHaversine dist=",c),c}}(t.coords.latitude,t.coords.longitude,publishARProjs.proj_list[a].loc[0],publishARProjs.proj_list[a].loc[1]);getViewerConfig(serverUrl,(function(t){if(s<t.data.gps_range_distance){let t=e.loadMakarScene(r.id,o,i,n),s=e.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[s].xml_urls)&&publishARProjs.proj_list[s].xml_urls[0]){console.log("three.js: _getNFTMarkerDraw: _GPS get _logic xml ",s,publishARProjs.proj_list[s].xml_urls[0]);let r=e.parseLogicXML(s,0);t.push(r)}Array.isArray(t)&&Promise.all(t).then((function(t){console.log("three.js: _getNFTMarkerDraw: _GPS _loadMakarScene done: ret = ",t),Array.isArray(publishARProjs.proj_list[s].xml_urls)&&publishARProjs.proj_list[s].xml_urls[0]&&setTimeout((function(){e.logicList[s].parseXML(),0==o.targetState&&e.logicList[s].stopLogic(),e.setupSceneBehav(a)}),1)}))}else console.log("three.js: showProjectInfo: get Geolocation distance not allow",s),warnModal.style.display="block",warnModalInfo.textContent=u.GPSDistanceMsg[d]+Math.floor(s)+" meter"}))}),(function(e){console.log("three.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),warnModal.style.display="block",warnModalInfo.textContent=u.GPSErrorMsg[d]+"\r\n"+e.message}),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0})}else console.log("three.js: showProjectInfo: Geolocation is not supported by this browser."),warnModal.style.display="block",warnModalInfo.textContent=u.GPSnotSupportMsg[d]}else{let t=e.loadMakarScene(r.id,o,i,n),s=e.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[s].xml_urls)&&publishARProjs.proj_list[s].xml_urls[0]){console.log("three.js: _getNFTMarkerDraw: get _logic xml ",s,publishARProjs.proj_list[s].xml_urls[0]);let r=e.parseLogicXML(s,0);t.push(r)}Array.isArray(t)&&Promise.all(t).then((function(t){console.log("three.js: _getNFTMarkerDraw _loadMakarScene done: ret = ",t),Array.isArray(publishARProjs.proj_list[s].xml_urls)&&publishARProjs.proj_list[s].xml_urls[0]&&setTimeout((function(){e.logicList[s].parseXML(),0==o.targetState&&e.logicList[s].stopLogic(),e.setupSceneBehav(a)}),1)}))}}if(r.found>0){if(this.currentProjectIndex=e.sceneTargetList[r.id].projIndex,2==r.found){o.targetState=2,e.logicList[e.currentProjectIndex]&&0==e.logicList[e.currentProjectIndex].logicSystemState&&e.logicList[e.currentProjectIndex].parseXML();var a=this.checkColoring(e.sceneTargetList[r.id].projIndex,o,i,t.data.marker.allowColor);1==a?parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="block"):0==a&&parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="none")}else if(o.targetState=1,addScanTimesByTargetID(window.serverUrl,publishARProjs.user_id,e.sceneTargetList[r.id].target_id),this.activeAndClearScene(t.data.marker.id),o.object3D&&o.object3D.children.length>0&&(o.object3D.traverse((function(e){e.originTransform&&(e.position.copy(e.originTransform.position),e.rotation.copy(e.originTransform.rotation),e.scale.copy(e.originTransform.scale))})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1),e.camera.projectionMatrix.elements[8]=e.bkCamera.projectionMatrix.elements[8],e.camera.projectionMatrixInverse.getInverse)e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix);else{let t=e.camera.projectionMatrix.clone();e.camera.projectionMatrixInverse.copy(t.invert())}o.object3D.matrix.fromArray(t.data.matrix)}else{o.object3D.visible=!1,console.log("three.js: losing: obj= ",o,t.data.marker.id);this.checkColoring(t.data.marker.id,o,i,0);if(1==o.showObjects){if(o.targetState=0,arController.logicList[arController.currentProjectIndex]){arController.logicList[arController.currentProjectIndex].stopLogic()}if(e.camera.projectionMatrix.elements[8]=0,e.camera.projectionMatrixInverse.getInverse)e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix);else{let t=e.camera.projectionMatrix.clone();e.camera.projectionMatrixInverse.copy(t.invert())}let r=t.data.marker.id,i=25.4*e.gcssTargets.width[r]/e.gcssTargets.dpi[r]/2;o.object3D.visible=!0,o.object3D.matrixAutoUpdate=!0,o.object3D.position.set(-i,40,250),o.object3D.rotation.x=90*Math.PI/180,o.object3D.updateMatrix(),o.object3D.updateMatrixWorld(),o.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;if(e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"image"==e.makarType||"video"==e.makarType){let t=e.getWorldQuaternion(new THREE.Quaternion),r=new THREE.Euler;r.setFromQuaternion(t),e.rotateOnAxis(new THREE.Vector3(0,1,0),0-r.y),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI-r.x),e.updateMatrixWorld(),e.updateMatrix()}"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1}}}})),this.addEventListener("getMultiMarker",(function(e){var t=this.threeMultiMarkers[e.data.multiMarkerId];t&&(t.matrix.elements.set(e.data.matrix),t.visible=!0)})),this.addEventListener("getMultiMarkerSub",(function(e){var t=e.data.multiMarkerId,r=e.data.markerIndex,o=e.data.marker,i=this.threeMultiMarkers[t];if(i&&i.markers&&i.markers[r]){var n=i.markers[r];n.matrix.elements.set(e.data.matrix),n.visible=o.visible>=0}})),this.threePatternMarkers={},this.threeNFTMarkers={},this.aframeNFTMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={},this.threeNFTMarkers2D={},this.threeNFTMarkersCSS={},this.currentProjectIndex=null,this.objectControlState=null,this.quizModule=[],this.logicList=[],this.controlObject=null,this.currentControllObject=null,this.makarObjects=[],this.makarObjects2D=[],this.sceneTargetList=null,this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.groupEventTargetDict={},this.lookAtTargetDict={},this.lookAtObjectList=[],this.lookAtTargetTimelineDict={},this.gcssTargets={},this.checkVideoOpt=function(e,t){for(let r=0;r<e.children.length;r++)1==e.children[r].makarObject&&e.children[r].mp4Video&&(t?e.children[r].mp4Video.play():e.children[r].mp4Video.pause())},this.checkAudioOpt=function(e,t){for(var r in e.children)e.children[r]&&e.children[r]&&e.children[r].type&&"Audio"==e.children[r].type&&(1==t?0==e.children[r].isPlaying&&(console.log("audio laod and play, ",e.children[r]),e.children[r].offset=0,e.children[r].play()):0==t&&1==e.children[r].isPlaying&&e.children[r].pause())},this.checkAimation=function(e,t){if(e.animationSlices&&e.animationSlices[0].uid){var r;for(let t=1;t<e.animationSlices.length;t++)e.animationSlices[0].uid==e.animationSlices[t].uid&&(r=t);if(e.animationSlices[0].changed&&(e.mixer._actions[0].time=e.animationSlices[r].startTime,e.animationSlices[0].changed=!1,e.animationSlices[0].count=0),!e.animationSlices[0].reset&&1==e.animationSlices[0].count)return void(e.mixer._actions[0].time=e.animationSlices[r].endTime);if(e.mixer._actions[0].time<e.animationSlices[r].startTime&&(e.mixer._actions[0].time=e.animationSlices[r].startTime),e.mixer._actions[0].time+0>e.animationSlices[r].endTime){if(e.animationSlices[0].uid==e.animationSlices[0].loop)e.mixer._actions[0].time=e.animationSlices[r].startTime;else if(e.animationSlices[0].reset){let t;e.animationSlices[0].uid=e.animationSlices[0].idle,e.animationSlices[0].loop=e.animationSlices[0].idle;for(let r=1;r<e.animationSlices.length;r++)if(e.animationSlices[0].uid==e.animationSlices[r].uid){t=r;for(let t=0;t<e.mixer._actions.length;t++)e.mixer._actions[t].stop();let o=e.animations.findIndex((function(r){return r.name==e.animationSlices[t].animationName}));e.mixer=new THREE.AnimationMixer(e),e.mixer.clipAction(e.animations[o]).play()}e.mixer._actions[0].time=e.animationSlices[t].startTime}e.animationSlices[0].count=1,e.mixer&&e.mixer.update(1e-6)}else e.mixer&&e.mixer.update(t)}},this.checkColoring=function(t,r,o,i){let n=e.sceneTargetList[t].projIndex;if("coloring"==window.sceneResult[n].module){if(1!=r.loadModel){if(1==i){for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=0,r.object3D.children[e].material.color.g=1);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=1,o.children[e].behav[0].enable=!0)}else{for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=1,r.object3D.children[e].material.color.g=0);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=.3,o.children[e].behav[0].enable=!1)}return 0}return 1}return-1},this.dealImageUrl=function(t){let r="";return userProjResDict[t.res_id]?(console.log("three.js: _dealImageUrl: image from user resource"),t.res_url!=userProjResDict[t.res_id].res_url&&console.log("three.js: _dealImageUrl: image from user resource, but difference ",t.res_url,userProjResDict[t.res_id].res_url),t.res_url=userProjResDict[t.res_id].res_url,r=e.getDefaultImageUrl(t.res_url),t.res_url=r):userOnlineResDict[t.res_id]?(console.log("three.js: _dealImageUrl: image from online resource",userOnlineResDict[t.res_id].res_url),t.res_url!=userOnlineResDict[t.res_id].res_url&&console.log("three.js: _dealImageUrl: image from online resource, but difference ",t.res_url,userOnlineResDict[t.res_id].res_url),t.res_url=userOnlineResDict[t.res_id].res_url,r=e.getDefaultImageUrl(t.res_url),t.res_url=r):(console.log("three.js: _dealImageUrl: image not in user/online resource",t),r=e.getDefaultImageUrl(t.res_url),t.res_url=r),r},this.getDefaultImageUrl=function(e){let t="";if(e.indexOf("https")>-1)return console.log("three.js: _getDefaultImageUrl: contain [https] direct return, imageStr=",e),e;switch(e){case"DefaultResource/Image/MakAR_Call.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Call"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"DefaultResource/Image/MakAR_Room.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Room"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"DefaultResource/Image/MakAR_Mail.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Mail"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"DefaultResource/Image/Line_icon.png":console.log("three.js: _getDefaultImageUrl: image: Line_icon"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"DefaultResource/Image/FB_icon.png":console.log("three.js: _getDefaultImageUrl: image: FB_icon"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;case"DefaultResource/ProjectModule/ScratchCardBackground.png":console.log("three.js: _getDefaultImageUrl: image: ScratchCardBackground"),t="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png";break;default:t="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/icon/qm256.png",console.log("three.js: _getDefaultImageUrl: unknown, obj=",e)}return t},this.getUserRes_onlineRes=function(e){if(userProjResDict[e.res_id])console.log("three.js: _getUserRes_onlineRes: model from user resource"),e.res_url=userProjResDict[e.res_id].res_url;else if(userOnlineResDict[e.res_id])console.log("three.js: _getUserRes_onlineRes: model from online resource",userOnlineResDict[e.res_id].res_url),e.res_url=userOnlineResDict[e.res_id].res_url;else switch(e.res_id){case"Cube":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb";break;case"Capsule":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb";break;case"Sphere":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb";break;case"ch_Bojue":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb";break;case"ch_Fei":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb";break;case"ch_Lina":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb";break;case"ch_Poyuan":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb";break;case"ch_Roger":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb";break;default:e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",console.log("three.js: _loadSceneObjects: model not exist show missing model ")}return e.res_url},this.countObject2D=function(e){let t=0;for(let r=0;r<e.length;r++){let o=e[r];"2d"==o.obj_type&&("image"==o.main_type&&t++,"module"==o.main_type&&"scratch_card"==o.sub_type&&t++)}return t},this.getMakarObjectByObjID=function(e,t){for(let r in e)if(e[r].obj_id==t)return e[r];return console.error("three.js: _getMakarObjectByObjID: get null object ",t,e),null},this.loadAssets=function(t){let r=document.createElement("a-assets");r.setAttribute("id","makarAssets"),r.setAttribute("timeout","1000"),e.arfScene.appendChild(r)},this.getProjectVersion=function(e){let t=[],r=e;return"string"!=typeof window.sceneResult[r].data.editor_ver?(console.log("three.js: _loadMakarScene: the editor_ver is not string, error and return "),-1):(t=window.sceneResult[r].data.editor_ver.split("."),t)},this.getResolutionIndex=function(e){let t=e,r=0,o=this.arScene.clientWidth,i=this.arScene.clientHeight;if(sceneResult[t]&&sceneResult[t].data.scene_objs_v2&&sceneResult[t].data.scene_objs_v2.screen&&Array.isArray(sceneResult[t].data.scene_objs_v2.screen.orientationData)){let e=sceneResult[t].data.scene_objs_v2.screen.orientationData,n=1e4;e.forEach(((e,t)=>{let a=e.width/e.height/(o/i),s=e.width/o,l=e.height/i,c=a>1?a:1/a,d=s>1?s:1/s,u=l>1?l:1/l;e.nrdScore=c*(d+u),e.nrdScore<n&&(n=e.nrdScore,r=t)}));let a=e[r];tempR=String(a.width)+","+String(a.height),console.log(" _getResolutionIndex: ",n,r,a,tempR)}else console.log(" _getResolutionIndex: error",t,sceneResult);return r},this.get2DScaleRatioByProjIndex=function(e){let t,r,o,i=this,n=e,a=i.getProjectVersion(n),s="";if(Array.isArray(a)&&3==a.length){let e=Number(a[0]),t=Number(a[1]),r=Number(a[2]);s=e>3||3==e&&t>3||3==e&&3==t&&r>8?l():function(){let e="";sceneResult[n]&&sceneResult[n].data.scene_objs_v2&&sceneResult[n].data.scene_objs_v2.resolution&&(e=sceneResult[n].data.scene_objs_v2.resolution);return e}()}else s=l();function l(){let e="",t=i.arScene.clientWidth,r=i.arScene.clientHeight;if(sceneResult[n]&&sceneResult[n].data.scene_objs_v2&&sceneResult[n].data.scene_objs_v2.screen&&Array.isArray(sceneResult[n].data.scene_objs_v2.screen.orientationData)){let o=sceneResult[n].data.scene_objs_v2.screen.orientationData,a=1e3,s=0;o.forEach(((e,o)=>{let i=e.width/e.height/(t/r),n=e.width/t,l=e.height/r,c=i>1?i:1/i,d=n>1?n:1/n,u=l>1?l:1/l;e.nrdScore=c*(d+u),e.nrdScore<a&&(a=e.nrdScore,s=o)}));let l=o[s];i.selectedResolutionIndex=s,e=String(l.width)+","+String(l.height),console.log(" _getResolution338: ",a,s,l,e)}return e}if(""==s&&(console.log(" _get2DScaleRatio: fucking lose resolutionString "),s="720,1280"),""!=s){let e=s.split(","),n=Number(e[0]),a=Number(e[1]),l=i.arfScene.clientWidth,c=i.arfScene.clientHeight;if(r=Math.abs(i.camera2D.right-i.camera2D.left),o=Math.abs(i.camera2D.bottom-i.camera2D.top),r/o>=l/c)if(l/c>=n/a){let e=c*(n/a);t=e/n,console.log(" _get2DScaleRatio: 1 ",n,a,l,c,t)}else{t=l/n,console.log(" _get2DScaleRatio: 2 ",n,a,l,c,t)}else if(l/c>=n/a){let e=c*(n/a),i=c/(l*(o/r)),s=e/l,d=e/n;t=d,console.log(" _get2DScaleRatio: 3 ",n,a,l,c,t,i,s,d)}else{let e=c/(l*(o/r)),i=l*(a/n)/c,s=l/n;t=s,console.log(" _get2DScaleRatio: 4 ",n,a,l,c,t,e,i,s)}}else console.log(" fucking lose resolutionString ");return console.log(" _get2DScaleRatio: srxy=",t),t},this.editorVersionControllObjs=function(e){let t=e,r=window.sceneResult[t].data.scene_objs_v2;var o;if("string"!=typeof window.sceneResult[t].data.editor_ver)return console.log("three.js: _loadMakarScene: the editor_ver is not string, error and return "),-1;if(o=window.sceneResult[t].data.editor_ver.split("."),""==window.sceneResult[t].data.editor_ver){if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version empty. scene=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2}else if(3==o[0]&&0==o[1]&&o[2]<=6){if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version before 3.0.9, version=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2}else if(o[0]>=3&&(0==o[1]&&o[2]>=7||o[1]>=1))console.log("three.js: _loadMakarScene: the editor version after 3.0.7, version=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2.objs;else{if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version unknown, use the 3.0.6 structure , please contact MIFLY for more information, sceneResult=",sceneResult),r=window.sceneResult[t].data.scene_objs_v2}return r},this.loadMakarScene=function(r,o,i,n){let a=e.sceneTargetList[r].projIndex;console.log("makar.three.js: _loadMakarScene, window.sceneResult[",a,"] = ",window.sceneResult[a]);let s=[];e.projStartTimeList.push({projIndex:a,time:(new Date).getTime()}),e.checkARSceneResultBehav(a),e.groupEventTargetDict[a]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",a):e.groupEventTargetDict[a]=JSON.parse(JSON.stringify(e.groupDict)),e.lookAtTargetDict[a]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",a):e.lookAtTargetDict[a]=[],e.lookAtTargetTimelineDict[a]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",a):e.lookAtTargetTimelineDict[a]=[];let l=window.sceneResult[a].data.scene_objs_v2;if(l=e.editorVersionControllObjs(a),!Array.isArray(l))return[];e.countObject2D(l);if(Array.isArray(window.sceneResult[a].data.module_type)){let n;if(0==window.sceneResult[a].data.module_type.length)console.log("three.js: _loadMakarScene: module_type is empty");else if(1==window.sceneResult[a].data.module_type.length)n=window.sceneResult[a].data.module_type[0],console.log("three.js: _loadMakarScene: only one module, ",n);else{let e,t=0;for(let r=0;r<window.sceneResult[a].data.module_type.length;r++)e=window.sceneResult[a].data.module_type[r],"gps"!=e&&("coloring"==e||"scratch_card"==e||"point_card"==e?(console.log("three.js: _loadMakarScene: detect module=",e),t++,n=e):console.log("three.js: _loadMakarScene: unknown modules, ",e));console.log("three.js: _loadMakarScene: currently not support mutiple modules, ",window.sceneResult[a].data.module_type)}if(n)switch(n){case"coloring":if(o.loadModule="coloring",1!=o.loadModel){o.showObjects=!1,o.coloringStatus=-1;var c=e.gcssTargets.dpi[o.GCSSID],h=e.gcssTargets.width[o.GCSSID],p=e.gcssTargets.height[o.GCSSID],m=new THREE.Mesh(new THREE.PlaneGeometry(1,1),new THREE.MeshBasicMaterial({transparent:!0,opacity:.25,color:new THREE.Color("rgb(255,0,0)")}));let t;m.position.set(25.4*h/c/2,25.4*p/c/2,0),m.updateMatrix(),t=new THREE.Vector3(25.4*h/c/2,25.4*p/c/2,.1),m.scale.copy(t.multiplyScalar(2)),m.name="coloredPlane",o.object3D.add(m),e.loadDeaultTexture2D(i,"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/coloring2.png",new THREE.Vector3(0,50,0),new THREE.Vector3(0,0,0),new THREE.Vector3(.3,.3,.3),[.5,0],{simple_behav:"coloring"})}else{o.object3D.remove(o.object3D.children[0]),i.remove(i.children[0]),o.showObjects=!0;for(let t in l){let r=(new THREE.Vector3).fromArray(l[t].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(l[t].transform[1].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(l[t].transform[2].split(",").map((function(e){return Number(e)})));switch(l[t].main_type){case"model":console.log("three.js: Module: color model 3d, res =",l[t]),e.loadAframeGLTFModelWithTexture(o,l[t],e.targetCanvas,r,n,a,e.cubeTex),console.log("three.js: _loadMakarScene: coloring module, load GLTF Model done ");break;case"video":"mp4"==l[t].sub_type&&(l[t].res_url&&l[t].transform?(console.log("three.js: video mp4 3d, obj with url and transform: ",l[t]),e.loadAframeVideo(o,l[t],r,n,a)):console.log("three.js: video mp4 3d, obj without url and transform(fail): ",l[t]));break;case"text":console.log("three.js: _loadText: text: ",t,l[t]),"3d"==l[t].obj_type?e.loadAframeText(o,scene_obj,r,n,a):"2d"==l[t].obj_type&&e.loadAframeText2D(i,l[t],t,l.length,r,n,a);break;case"audio":"mp3"!=l[t].sub_type&&"wav"!=l[t].sub_type&&"ogg"!=l[t].sub_type||(l[t].res_url&&l[t].transform?e.loadAframeAudio(o,l[t],r,n,a):console.log("three.js: audio mp4 3d, obj without url and transform(fail): ",l[t]));break;case"image":let s=l[t].res_url;s=e.dealImageUrl(l[t]),"3d"==l[t].obj_type&&(s&&l[t].transform?e.loadAframeTexture(o,s,l[t],r,n,a):console.log("three.js: image 3d, obj without url and transform(fail): ",l[t])),"2d"==l[t].obj_type&&(s&&l[t].transform?(console.log("three.js: image 2d, obj with url and transform(success): ",l[t]),e.loadAframeTexture2D(i,l[t],s,t,l.length,r,n,a)):console.log("three.js: image 2d, obj without url and transform(fail): ",l[t]));break;case"light":e.loadAframeLight(o,l[t],r,n,a)}}console.log("three.js: _loadMakarScene: coloring module, already catch target, markerRoot = ",o.children)}return console.log("three.js: _loadMakarScene: coloring module, return "),s;case"scratch_card":if(console.log("three.js:_loadMakarScene: scratch_card module ",l,publishARProjs.proj_list[a],window.sceneResult[a]),!parent.mdb)return[];if(parent.userlogin);else{for(let r in l){let o=(new THREE.Vector3).fromArray(l[r].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(l[r].transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(l[r].transform[2].split(",").map((function(e){return Number(e)})));if("scratch_card"==l[r].res_id&&"scratch_card"==l[r].sub_type&&Array.isArray(l[r].project_module)&&1==l[r].project_module.length){let c;c=(new Date).getTime()+"_"+t(10),localStorage.setItem("device_id",c);let d={user_id:publishARProjs.proj_list[a].user_id,playing_user:"",proj_id:publishARProjs.proj_list[a].proj_id,proj_type:"ar",card_id:l[r].project_module[0].card_id,device_id:c,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};parent.mdb.initProject(d).then((function(t){e.loadCanvas2D(i,l[r],(new THREE.Vector3).fromArray(l[r].transform[0].split(",").map((function(e){return Number(e)}))),(new THREE.Vector3).fromArray(l[r].transform[1].split(",").map((function(e){return Number(e)}))),(new THREE.Vector3).fromArray(l[r].transform[2].split(",").map((function(e){return Number(e)}))),(function(t){parent.mdb.getScratchProject(publishARProjs.proj_list[a].proj_id).then((a=>{let c;switch(a.scratchCardState){case 0:c=aScratchCard.randomChooseAward(l[r]),a.getAwardIndex=c,a.scratchCardState=1,a.scratch_image_url=l[r].project_module[0].scratch_image_url;var u=e.getDefaultImageUrl(l[r].project_module[0].award_list[c].image_url);a.awards_image_url=u,parent.mdb.setScratchProject(a),d.issuance_card=!0,d.award_list=l[r].project_module[0].award_list,console.log("three.js: scratch card init : upload to server",d),scratchCardLog(window.serverUrl,d);break;case 1:console.log("three.js: _loadMakarScene: scratch_card state[1], set award",a.getAwardIndex,t),c=a.getAwardIndex;break;case 2:console.log("three.js: _loadMakarScene: scratch_card state[2], clear scratch canvas",a.getAwardIndex,t),c=a.getAwardIndex,aScratchCard.clearScratchCanvas(t);break;case 3:console.log("three.js: _loadMakarScene: scratch_card state[3], already exchange",a.getAwardIndex,t),c=a.getAwardIndex,t.exchanged=1,aScratchCard.clearScratchCanvas(t);break;default:console.log("three.js: _loadMakarScene: scratch_card state unknow, projRet=",a)}let h=l[r].project_module[0].award_list[c].image_url;(u=e.getDefaultImageUrl(h)).indexOf("https")>=0?(l[r].sub_type="jpg",e.loadAframeTexture2D(i,l[r],u,r,l.length,o,n,s)):console.error("three.js: _loadMakarScene: scratch_card error, sceneObject.project_module[0].award_list not include [https]",l[r].project_module[0].award_list)}))}))}))}}i.loadModule="scratchCard"}break;case"point_card":if(console.log("three.js: _loadMakarScene: module point_card processing ",window.sceneResult[a].data.module_type[0],l,i),!parent.mdb)return[];i.module="PointCard",i.loadModule="pointCard";for(let o in l)if("module"==l[o].main_type&&"point_card"==l[o].sub_type){i.project_module=l[o].project_module[0],i.proj_id=publishARProjs.proj_list[a].proj_id;let n,s=(new THREE.Vector3).fromArray(l[o].transform[0].split(",").map((function(e){return Number(e)}))),c=(new THREE.Vector3).fromArray(l[o].transform[1].split(",").map((function(e){return Number(e)}))),d=(new THREE.Vector3).fromArray(l[o].transform[2].split(",").map((function(e){return Number(e)})));n=""==l[o].project_module[0].bg_image_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/PointCard_Background.png":l[o].project_module[0].bg_image_url,l[o].sub_type="jpg",e.loadAframeTexture2D(i,l[o],n,o,l.length,s,c,d),parent.userlogin;{let n;n=(new Date).getTime()+"_"+t(10),localStorage.setItem("device_id",n);let s=publishARProjs.proj_list[a];aPointCard.createPointCardContent(i),aPointCard.getPointCardProject(publishARProjs.proj_list[a].proj_id,(t=>{console.log("three.js: load pointCard, first get, getProjRet = ",t);let a=l[o].project_module[0].points.find((function(t){return t.target_id==e.sceneTargetList[r].target_id}));if(t.proj_id)aPointCard.addPoint(t,a.target_id,(function(r){for(let n=0;n<i.project_module.points.length;n++){let s=i.project_module.points[n],c=(new THREE.Vector3).fromArray(s.transform[0].split(",").map((function(e){return Number(e)}))),d=(new THREE.Vector3).fromArray(s.transform[1].split(",").map((function(e){return Number(e)}))),u=(new THREE.Vector3).fromArray(s.transform[2].split(",").map((function(e){return Number(e)})));if(r.collected_points.find((function(e){return e==i.project_module.points[n].target_id}))){""==i.project_module.points[n].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=i.project_module.points[n].collected_point_url,s.sub_type="jpg",e.loadAframeTexture2D(i,s,point_after_url,o+1,l.length,c,d,u).then((function(t){e.runAnimation2D(t,h)})),i.project_module.points[n].collected=!0;let h={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};if(t!=r&&a.target_id==i.project_module.points[n].target_id){console.log(" three.js: _loadPointCard: new target =",i.project_module.points[n]);let e={user_id:r.user_id,playing_user:"",proj_id:r.proj_id,proj_type:"ar",card_id:r.card_id,device_id:r.device_id,can_reward_point_count:r.can_reward_point_count,target_id:a.target_id,target_img_url:i.project_module.points[n].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};pointCardLog(window.serverUrl,e)}}else{let t;t=""==i.project_module.points[n].uncollected_point_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png":i.project_module.points[n].uncollected_point_url,s.sub_type="jpg",e.loadAframeTexture2D(i,s,t,o+1,l.length,c,d,u),i.project_module.points[n].collected=!1}}aPointCard.showPointCardCanvas(i,r.collected_points.length-l[o].project_module[0].can_reward_point_count,t.is_exchanged)}));else{console.log(" ******** there are no project: getPointTarget ",a,t);let r={user_id:s.user_id,proj_id:s.proj_id,device_id:n,card_id:l[o].project_module[0].card_id,is_exchanged:!1,can_reward_point_count:l[o].project_module[0].can_reward_point_count,collected_points:[a.target_id],type:"point_card"};aPointCard.setPointCardProject(r,(r=>{console.log(" 1 ------------ setProjRet = ",r);for(let t=0;t<i.project_module.points.length;t++){let r=i.project_module.points[t],c=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),d=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),u=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)})));if(a.target_id==i.project_module.points[t].target_id){""==i.project_module.points[t].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=i.project_module.points[t].collected_point_url,r.sub_type="jpg",e.loadAframeTexture2D(i,r,point_after_url,o+1,l.length,c,d,u).then((function(t){e.runAnimation2D(t,h)})),i.project_module.points[t].collected=!0;let h={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0},p={user_id:s.user_id,playing_user:"",proj_id:s.proj_id,proj_type:"ar",card_id:l[o].project_module[0].card_id,device_id:n,can_reward_point_count:l[o].project_module[0].can_reward_point_count,target_id:a.target_id,target_img_url:i.project_module.points[t].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};pointCardLog(window.serverUrl,p)}else{let n;n=""==i.project_module.points[t].uncollected_point_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png":i.project_module.points[t].uncollected_point_url,r.sub_type="jpg",e.loadAframeTexture2D(i,r,n,o+1,l.length,c,d,u),i.project_module.points[t].collected=!1}}aPointCard.showPointCardCanvas(i,1-l[o].project_module[0].can_reward_point_count,t.is_exchanged)}))}}))}}break;case"quiz":console.log("three.js: _loadMakarScene: quiz module ",window.sceneResult[a],n,l),o.loadModule=i.loadModule="quiz";for(let t=0,r=l.length;t<r;t++){let r=l[t],n=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),c=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)}))),h=document.getElementById("startQuiz"),p=document.getElementById("QuizStartButton");if("2d"==r.obj_type&&"quiz"==r.sub_type){function f(){e.load2DQuiz(i,r,n,s,c),h.style.display="none",i.visible=!0}function g(){h.style.display="none",i.visible=!0,p.onclick=null}h.style.display="block";let t=window.serverUrl,o=localStorage.getItem("login_shared_id"),l=publishARProjs.proj_list[a].proj_id;1==r.module[0].force_login?o?0==r.module[0].allow_retry?(console.log("AR.js: _getRecordModule: get remote: ",o,l),getRecordModule(t,o,l,(function(e){console.log("AR.js: _getRecordModule: ret= ",e),e.data.record_module_list?(QuizStartContent.textContent=u.userAlreadyPlayed[d],p.onclick=g):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=f)}))):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=f):(QuizStartContent.textContent=u.userNotLoginInfo[d],p.onclick=g):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=f)}if("3d"==r.obj_type&&"quiz"==r.sub_type){h.style.display="block";let i=function(){e.loadQuiz(o,r,n,s,c),h.style.display="none",o.visible=!0,p.removeEventListener("click",i)},m=function(){h.style.display="none",p.removeEventListener("click",m)},f=window.serverUrl,g=localStorage.getItem("login_shared_id"),b=publishARProjs.proj_list[a].proj_id;1==l[t].module[0].force_login?g?0==l[t].module[0].allow_retry?(console.log("AR.js: _getRecordModule: get remote: ",g,b),getRecordModule(f,g,b,(function(e){console.log("AR.js: _getRecordModule: ret= ",e),e.data.record_module_list?(QuizStartContent.textContent=u.userAlreadyPlayed[d],p.onclick=m):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=i)}))):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=i):(QuizStartContent.textContent=u.userNotLoginInfo[d],p.onclick=m):(QuizStartContent.textContent=u.clickToPlay[d],p.onclick=i)}}break;default:console.log("three.js: _loadMakarScene: unknown module type ",window.sceneResult[a].data.module_type[0],n)}}for(let t in l){let r=l[t],n=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),c=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),d=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)})));switch(r.main_type){case"model":if(userProjResDict[r.res_id])console.log("three.js: _loadSceneObjects: model from user resource"),r.res_url=userProjResDict[r.res_id].res_url;else if(userOnlineResDict[r.res_id])console.log("three.js: _loadSceneObjects: model from online resource",userOnlineResDict[r.res_id].res_url),r.res_url=userOnlineResDict[r.res_id].res_url;else switch(r.res_id){case"Cube":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb";break;case"Capsule":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb";break;case"Sphere":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb";break;case"ch_Bojue":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb";break;case"ch_Fei":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb";break;case"ch_Lina":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb";break;case"ch_Poyuan":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb";break;case"ch_Roger":r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb";break;default:if(l[a].res_gltf_resource)break;r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],console.log("three.js: _loadSceneObjects: model not exist show missing model ")}if(r.res_url&&r.transform){console.log("three.js: model 3d, obj with url and transform: ",r);let t=e.loadAframeGLTFModel(o,r,n,c,d,e.cubeTex);s.push(t)}else console.log("three.js: model 3d, obj without url or transform(fail): ",r);o.visible=!0;break;case"video":if("mp4"==l[t].sub_type)if(l[t].res_url&&l[t].transform){console.log("three.js: video mp4 3d, obj with url and transform: ",l[t]);let r=e.loadAframeVideo(o,l[t],n,c,d);s.push(r)}else console.log("three.js: video mp4 3d, obj without url and transform(fail): ",l[t]);break;case"text":if("3d"==l[t].obj_type){let t=e.loadAframeText(o,r,n,c,d);s.push(t)}else"2d"==l[t].obj_type&&e.loadAframeText2D(i,l[t],t,l.length,n,c,d);break;case"audio":if("mp3"==l[t].sub_type||"wav"==l[t].sub_type||"ogg"==l[t].sub_type)if(l[t].res_url&&l[t].transform){let r=e.loadAframeAudio(o,l[t],n,c,d);s.push(r)}else console.log("three.js: audio mp4 3d, obj without url and transform(fail): ",l[t]);break;case"image":let u=l[t].res_url;if(u=e.dealImageUrl(l[t]),"3d"==l[t].obj_type)if(u&&l[t].transform){let r=e.loadAframeTexture(o,u,l[t],n,c,d);s.push(r)}else console.log("three.js: image 3d, obj without url and transform(fail): ",l[t]);"2d"==l[t].obj_type&&(u&&l[t].transform?(console.log("three.js: image 2d, obj with url and transform(success): ",l[t]),e.loadAframeTexture2D(i,l[t],u,t,l.length,n,c,d)):console.log("three.js: image 2d, obj without url and transform(fail): ",l[t]));break;case"module":break;case"light":let h=e.loadAframeLight(o,l[t],n,c,d);s.push(h);break;default:console.log("three.js: type unknown show cube :",l[t])}}return s},this.activeAndClearScene=function(t){let r=e.sceneTargetList[t].projIndex;for(let t in this.aframeNFTMarkers)if(t==r){this.aframeNFTMarkers[t].object3D.visible=!0,this.threeNFTMarkers2D[t].visible=!0,this.aframeNFTMarkers[t].object3D.traverse((function(t){1==t.getWorldVisible()&&("video"==t.makarType&&(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location?e.dealVideoMuted():t.el.mp4Video.play()),"audio"==t.makarType&&t.el.components.sound.playSound())}))}else{if(this.aframeNFTMarkers[t].object3D.traverse((function(e){if("video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound(),e.behav_reference&&e.behav_reference.length>0)for(let t=0;t<e.behav_reference.length;t++)"ShowVideo"!=e.behav_reference[t].behav_name&&"ShowModel"!=e.behav_reference[t].behav_name&&"ShowImage"!=e.behav_reference[t].behav_name&&"PlayMusic"!=e.behav_reference[t].behav_name&&"ShowText"!=e.behav_reference[t].behav_name||e.el.setAttribute("visible",!1)})),this.aframeNFTMarkers[t].loadModule&&"quiz"==this.aframeNFTMarkers[t].loadModule){let o=this.aframeNFTMarkers[t];for(;o.children.length>0;)o.children[0].remove();for(let t=0;t<e.makarObjects.length;t++)null!=e.makarObjects[t].object3D.el&&null!=e.makarObjects[t].object3D.parent||e.makarObjects.splice(t,1);let i=document.getElementById("startQuiz");"quiz"==this.aframeNFTMarkers[r].loadModule||(i.style.display="none"),e.aframeNFTMarkers[t].loadedObjects=!1,e.threeNFTMarkers2D[t].loadedObjects=!1}if(0==this.aframeNFTMarkers[t].object3D.visible&&0==this.threeNFTMarkers2D[t].visible)continue;if(this.aframeNFTMarkers[t].object3D.visible=!1,this.threeNFTMarkers2D[t].visible=!1,this.threeNFTMarkers2D[t].loadModule)switch(this.threeNFTMarkers2D[t].loadModule){case"scratchCard":aScratchCard.hideScratchCanvas(this.threeNFTMarkers2D[t]);break;case"pointCard":console.log("three.js: recognize: _clearScene, processing pointCard "),aPointCard.hidePointCardCanvas(this.threeNFTMarkers2D[t]);break;case"coloring":console.log("three.js: recognize: _clearScene, not support coloring ");break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[t].loadModule)}}for(let o in this.threeNFTMarkers2D)if(o==r&&this.threeNFTMarkers2D[o].loadModule)switch(this.threeNFTMarkers2D[o].loadModule){case"scratchCard":aScratchCard.showScratchCanvas(this.threeNFTMarkers2D[o]);break;case"pointCard":console.log("three.js: recognize: _clearScene, pointCard processing ",e.threeNFTMarkers2D[o],publishARProjs.proj_list[o]),aPointCard.getPointCardProject(publishARProjs.proj_list[o].proj_id,(r=>{let i;console.log("three.js: _clearScene: _pointCard: getProjRet=",r),r.collected_points&&(i=r.collected_points.find((function(r){return r==e.sceneTargetList[t].target_id})),i?(console.log("three.js: _clearScene: _pointCard: already collected "),aPointCard.showPointCardCanvas(e.threeNFTMarkers2D[o],r.collected_points.length-e.threeNFTMarkers2D[o].project_module.can_reward_point_count,r.is_exchanged)):(console.log("three.js: _clearScene: _pointCard: not collected "),aPointCard.addPoint(r,e.sceneTargetList[t].target_id,(function(i){if(console.log("three.js: _clearScene: setProjRet",i),i.collected_points){for(let r=0;r<e.threeNFTMarkers2D[o].project_module.points.length;r++)if(e.threeNFTMarkers2D[o].project_module.points[r].target_id==e.sceneTargetList[t].target_id){""==e.threeNFTMarkers2D[o].project_module.points[r].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=e.threeNFTMarkers2D[o].project_module.points[r].collected_point_url;let t=e.threeNFTMarkers2D[o].project_module.points[r],n=(new THREE.Vector3).fromArray(t.transform[0].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(t.transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(t.transform[2].split(",").map((function(e){return Number(e)})));t.sub_type="jpg",e.loadAframeTexture2D(e.threeNFTMarkers2D[o],t,point_after_url,e.threeNFTMarkers2D[o].children.length,e.threeNFTMarkers2D[o].children.length,n,a,s).then((function(t){e.runAnimation2D(t,l)})),e.threeNFTMarkers2D[o].project_module.points[r].collected=!0;let l={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0},c={user_id:i.user_id,playing_user:"",proj_id:i.proj_id,proj_type:"ar",card_id:i.card_id,device_id:i.device_id,can_reward_point_count:i.can_reward_point_count,target_id:e.threeNFTMarkers2D[o].project_module.points[r].target_id,target_img_url:e.threeNFTMarkers2D[o].project_module.points[r].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};console.log(" three.js: _clearScene: collect target upload=",c),pointCardLog(window.serverUrl,c)}aPointCard.showPointCardCanvas(e.threeNFTMarkers2D[o],i.collected_points.length-e.threeNFTMarkers2D[o].project_module.can_reward_point_count,r.is_exchanged)}else console.error("three.js: _clearScene: collected_points not exist, shouldnt happen ",e.threeNFTMarkers2D[o].project_module.points)}))))}));break;case"coloring":console.log("three.js: recognize: _clearScene, not support coloring ");break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[o].loadModule)}},this.load2DQuiz=function(t,o,i,n,a){console.log("three.js: _load2DQuiz : obj=",o);let s=new THREE.Object3D;s.obj_id=o.obj_id,s.makarType="quiz2D",s.makarObject=!0,t.add(s),e.makarObjects2D.push(s);let l=[];for(let e=0;e<o.module[0].question_list.length;e++)o.module[0].question_list[e].allowRandom&&l.push(e);if(!o.module[0].display_order_list||0==o.module[0].display_order_list.length)return;let c=0;for(let e=0;e<o.module[0].display_order_list.length;e++){let t=o.module[0].display_order_list[e].index;if(-1==t){let i=r(l.length),n=l[i];o.module[0].display_order_list[e].index=n,t=n,l.splice(i,1)}o.module[0].question_list[t].active_score&&(c+=1)}let d=o.module[0].display_order_list[0].index,u=o.module[0].question_list[d],h=-1;if("Total"==o.module[0].timer_type){h=o.module[0].total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(h/3600),t=Math.floor((h-3600*e)/60),r=h-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==o.module[0].timer_type){h=u.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(h/3600),t=Math.floor((h-3600*e)/60),r=h-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}let p=document.getElementById("tipButtonDiv");if(u.show_tips?(p.style.display="block",p.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=u.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):p.style.display="none",s.quizModule={json:o.module[0],quizObject:s,currentQuestionIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:c,record:new Array(o.module[0].question_list.length),timer:{currentTimer:null,counter:h},record_time:0,qClock:Date.now()},u.questions_json&&Array.isArray(u.questions_json))for(let r=0;r<u.questions_json.length;r++){let o=u.questions_json[r],i=(new THREE.Vector3).fromArray(u.questions_json[r].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(u.questions_json[r].transform[1].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(u.questions_json[r].transform[2].split(",").map((function(e){return Number(e)})));switch(u.questions_json[r].main_type){case"text":e.loadAframeText2D(t,o,r,u.questions_json.length,i,n,a);break;case"image":let s=o.res_url;s=e.dealImageUrl(o),e.loadAframeTexture2D(t,o,s,r,u.questions_json.length,i,n,a)}}if(u.options_json&&Array.isArray(u.options_json))for(let r=0;r<u.options_json.length;r++){let o,i=u.options_json[r],n=(new THREE.Vector3).fromArray(i.transform[0].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(i.transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(i.transform[2].split(",").map((function(e){return Number(e)}))),l=i.sub_type,c=i.res_url;switch(c=e.dealImageUrl(i),l){case"txt":o=e.loadAframeText2D(t,i,r,u.options_json.length,n,a,s);break;case"gif":case"jpg":case"jpeg":case"png":o=e.loadAframeTexture2D(t,i,c,r,u.options_json.length,n,a,s);break;case"button":c="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",o=e.loadAframeTexture2D(t,i,c,r,u.options_json.length,n,a,s)}"button"==l||"MutiOption_Text"!=u.option_type&&"MutiOption_Image"!=u.option_type||o.then((function(e){let t=e,r=new THREE.Vector3(0,0,0),o=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1));new THREE.Quaternion;if("MutiOption_Text"==u.option_type){let e=t.children[0].children[1],i=e.scale.clone(),n=t.children[0].getWorldScale(new THREE.Vector3),a=Math.min(i.x*e.geometry.parameters.width,i.y*e.geometry.parameters.height,1e6);o.multiply(new THREE.Vector3(.8,.8,.8).multiplyScalar(a)),o.divide(n);let s=e.geometry.parameters.width*i.x,l=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",l.load(resUrl,(function(e){r.x=.5*-s-48*o.x;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));i.name="circle_base",i.position.copy(r.clone()),i.scale.copy(o.clone()),t.children[0].add(i);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.children[0].add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",l.load(resUrl,(function(e){r.x=.5*-s-48*o.x;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));i.name="circle_out",i.renderOrder=1,i.position.copy(r.clone()),i.scale.copy(o.clone().multiplyScalar(.9)),t.children[0].add(i)}))}else{let e=t.getWorldScale(new THREE.Vector3),i=t.scale.clone(),n=Math.max(i.x*t.children[0].geometry.parameters.width,i.y*t.children[0].geometry.parameters.height);o.multiply(new THREE.Vector3(.0025,.0025,.0025).multiplyScalar(n)),o.divide(e);let a=t.children[0].scale.clone(),s=t.children[0].geometry.parameters.height,l=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",l.load(resUrl,(function(e){r.y=a.y*s*.5+48*o.y;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));i.name="circle_base",i.position.copy(r.clone()),i.scale.copy(o.clone()),t.add(i);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",l.load(resUrl,(function(e){r.y=a.y*s*.5+48*o.y;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));i.name="circle_out",i.renderOrder=1,i.position.copy(r.clone()),i.scale.copy(o.clone().multiplyScalar(.9)),t.add(i)}))}}))}},this.loadQuiz=function(t,o,i,n,a){console.log("three.js: _loadQuiz: obj=",o);let s=document.createElement("a-entity");s.setAttribute("id",o.obj_id);let l=o.quaternionRotation.split(","),c=new THREE.Quaternion(Number(l[1]),Number(l[2]),Number(l[3]),Number(l[0])),h=e.gcssTargets.dpi[t.GCSSID],p=e.gcssTargets.width[t.GCSSID],m=e.gcssTargets.height[t.GCSSID];s.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){console.log("three.js: _loadQuiz: _loaded: ",s.object3D),s.object3D.makarType="quiz",s.object3D.makarObject=!0;let t=new THREE.Vector3;switch(window.serverVersion){case"2.0.0":a.multiplyScalar(1),t.addScaledVector(i,2540/h);break;case"3.0.0":t.addScaledVector(i,5080/h),a.multiplyScalar(2);break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}let r=t.y,l=t.z;t.y=l,t.z=r,e.setAframeTransform(s,t,n,a,c),s.object3D.position.add(new THREE.Vector3(25.4*p/h/2,25.4*m/h/2,0)),s.object3D.rotation.x+=90*Math.PI/180,s.object3D.updateMatrix(),s.object3D.obj_parent_id=o.obj_parent_id;let d=new THREE.Object3D;s.object3D.add(d)}})),t.appendChild(s),e.makarObjects.push(s);let f=[];for(let e=0;e<o.module[0].question_list.length;e++)o.module[0].question_list[e].allowRandom&&f.push(e);if(!o.module[0].display_order_list)return;let g=0;for(let e=0;e<o.module[0].display_order_list.length;e++){let t=o.module[0].display_order_list[e].index;if(-1==t){let i=r(f.length),n=f[i];o.module[0].display_order_list[e].index=n,t=n,f.splice(i,1)}o.module[0].question_list[t].active_score&&(g+=1)}let b=o.module[0].display_order_list[0].index,_=o.module[0].question_list[b],v=-1;if("Total"==o.module[0].timer_type){v=o.module[0].total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(v/3600),t=Math.floor((v-3600*e)/60),r=v-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==o.module[0].timer_type){v=_.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(v/3600),t=Math.floor((v-3600*e)/60),r=v-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}let y=document.getElementById("tipButtonDiv");_.show_tips?(y.style.display="block",y.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=_.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):y.style.display="none",e.quizModule[e.currentProjectIndex]={json:o.module[0],quizEntity:s,currentQuestionIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:g,record:new Array(o.module[0].question_list.length),timer:{currentTimer:null,counter:v},record_time:0,qClock:Date.now()},console.log("AR.js: _loadQuiz: self.quizModule , first_question =",e.quizModule,_);document.getElementById("scoreDiv");if(_.questions_json&&Array.isArray(_.questions_json))for(let r=0;r<_.questions_json.length;r++){let o=(new THREE.Vector3).fromArray(_.questions_json[r].transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(_.questions_json[r].transform[1].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(_.questions_json[r].transform[2].split(",").map((function(e){return Number(e)})));switch(_.questions_json[r].main_type){case"text":e.loadAframeText(t,_.questions_json[r],o,i,n);break;case"image":let a="";a=e.dealImageUrl(_.questions_json[r]),e.loadAframeTexture(t,a,_.questions_json[r],o,i,n);break;case"video":e.loadAframeVideo(t,_.questions_json[r],o,i,n);break;case"model":e.getUserRes_onlineRes(_.questions_json[r]);e.loadAframeGLTFModel(t,_.questions_json[r],o,i,n,e.cubeTex);break;case"audio":e.loadAframeAudio(t,_.questions_json[r],o,i,n)}}if(_.options_json&&Array.isArray(_.options_json))for(let r=0;r<_.options_json.length;r++){let o,i,n=(new THREE.Vector3).fromArray(_.options_json[r].transform[0].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(_.options_json[r].transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(_.options_json[r].transform[2].split(",").map((function(e){return Number(e)}))),l=_.options_json[r].sub_type;console.log("three.js: _loadQuiz: _loadOption: ",r,l,_.options_json[r]);let c="";switch("txt"!=l&&(c=e.dealImageUrl(_.options_json[r])),l){case"txt":i=e.loadAframeText(t,_.options_json[r],n,a,s);break;case"gif":case"jpg":case"jpeg":case"png":i=e.loadAframeTexture(t,c,_.options_json[r],n,a,s);break;case"button":c="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",i=e.loadAframeTexture(t,c,_.options_json[r],n,a,s)}"button"==l||"MutiOption_Text"!=_.option_type&&"MutiOption_Image"!=_.option_type||i.then((function(t){o=t,o.object3D.matrixWorldNeedsUpdate=!0,o.object3D.updateMatrixWorld();let r=new THREE.Vector3(0,0,0),i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1),a=new THREE.Quaternion;if("MutiOption_Text"==_.option_type){let t=new THREE.Vector3(1,1,1).multiply(o.object3D.scale).multiply(o.object3D.parent.scale).multiply(o.object3D.parent.parent.scale),s=o.object3D.children[1].scale.clone().multiply(t),l=Math.max(s.x,s.y);n.multiply(new THREE.Vector3(30,30,30).multiplyScalar(l)),n.divide(t);let c=2*Math.abs(o.getObject3D("mesh").geometry.attributes.position.array[0]);r.x=.5*-n.x-.6*c;let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),d.setAttribute("id",o.object3D.parent.el.id+"_circle_base"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.setAframeTransform(d,r,i,n,a),o.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),u.setAttribute("id",o.object3D.parent.el.id+"_circle_out"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.setAframeTransform(u,r,i,n,a),o.appendChild(u);let h=document.createElement("a-plane");h.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),h.setAttribute("id",o.object3D.parent.el.id+"_circle_in"),h.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),h.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),e.setAframeTransform(h,r,i,n,a),o.appendChild(h)}else{let t=setInterval((function(){if(o.getAttribute("heightForQuiz")){let s=o.object3D.getWorldScale(new THREE.Vector3),l=o.object3D.scale.clone(),c=Math.max(l.x,l.y);n.multiply(new THREE.Vector3(50,50,50).multiplyScalar(c)),n.divide(s);let d=o.object3D.children[0].scale.clone();r.y=.5*-n.y-.6*d.y;let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id",o.id+"_circle_base"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.setAframeTransform(u,r,i,n,a),o.appendChild(u);let h=document.createElement("a-plane");h.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),h.setAttribute("id",o.id+"_circle_out"),h.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.setAframeTransform(h,r,i,n,a),o.appendChild(h);let p=document.createElement("a-plane");p.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),p.setAttribute("id",o.id+"_circle_in"),p.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),p.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),e.setAframeTransform(p,r,i,n,a),o.appendChild(p),window.clearInterval(t)}}),100)}}))}if(e.quizModule[e.currentProjectIndex].timer.counter>=0){e.quizModule[e.currentProjectIndex].qClock=Date.now();let t=setInterval((function(){e.quizModule[e.currentProjectIndex].timer.currentTimer=t,e.quizModule[e.currentProjectIndex].timer.counter-=1;let r=Math.floor(e.quizModule[e.currentProjectIndex].timer.counter/3600),i=Math.floor((e.quizModule[e.currentProjectIndex].timer.counter-3600*r)/60),n=e.quizModule[e.currentProjectIndex].timer.counter-3600*r-60*i;if(timerContent.textContent=r.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0"),0==e.quizModule[e.currentProjectIndex].timer.counter){if(console.log("three.js: _quiz: time out ",o.module[0]),window.clearInterval(e.quizModule[e.currentProjectIndex].timer.currentTimer),"Custom"==o.module[0].timer_type)if(_.show_score){let t=document.getElementById("scoreDiv"),r=document.getElementById("score");t.style.display="block",t.onclick=function(){t.style.display="none",e.nextQuestion()},r.textContent=e.quizModule[e.currentProjectIndex].score}else e.nextQuestion();else{let t=document.getElementById("tipButtonDiv"),r=document.getElementById("tipDiv");t.style.display="none",r.style.display="none";let o=document.getElementById("startQuiz"),i=document.getElementById("QuizStartButton"),n=document.getElementById("QuizStartContent");o.style.display="block",n.textContent=u.timeIsUp[d],i.onclick=function(){o.style.display="none",e.nextQuestion()}}let t={question:b,get_score:0,answer_time:e.quizModule[e.currentProjectIndex].json.question_list[b].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};e.quizModule[e.currentProjectIndex].record[b]=t,e.quizModule[e.currentProjectIndex].record_time+=e.quizModule[e.currentProjectIndex].json.question_list[b].time_limit,e.quizModule[e.currentProjectIndex].qClock=Date.now(),console.log("three.js: _loadQuiz: module=",t,e.quizModule[e.currentProjectIndex])}}),1e3)}},this.clickQuiz2DButton=function(t){let r;t.traverseAncestors((function(e){e.quizModule&&(r=e.quizModule,console.log("three.js: _clickQuiz2DButton: get quizModule ",e,t))}));let o=[],i=!1,n=0,a=r.json.display_order_list[r.currentQuestionIndex].index,s=r.json.question_list[a],l=r.json.score_type,c=document.getElementById("makarDragon"),d=document.getElementById("makarDragonWholeMaskDiv"),u=document.getElementById("imgRight"),h=document.getElementById("imgWrong"),p=t.obj_id;if("Option_Text"==s.option_type||"Option_Image"==s.option_type){null==s.answer_list&&(s.answer_list=[]);let m=s.answer_list[0],f=s.options_json[m-1];console.log("three.js: _clickQuiz2DButton: single target=",t);for(let e=0,t=s.options_json.length;e<t;e++)s.options_json[e].obj_id==p&&o.push(e);if(f.obj_id==p){if(s.active_score)if("Custom"==l)r.score+=s.score,n=s.score;else if("Total"==l){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}i=!0,c.style.display="block",d.style.display="block",u.style.display="block",h.style.display="none",console.log("three.js: _clickQuiz2DButton: Congratulations! Correct Answer!")}else i=!1,c.style.display="block",d.style.display="block",u.style.display="none",h.style.display="block",console.log("three.js: _clickQuiz2DButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: _clickQuiz2DButton: score , currectQuestion = ",a,r,r.choices,o,n);let t={question:a,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:i};if(r.record[a]=t,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),s.show_score){let t=document.getElementById("scoreDiv"),o=document.getElementById("score");t.style.display="block",t.onclick=function(){t.style.display="none",e.nextQuestion2D(r)},o.textContent=r.score}else e.nextQuestion2D(r)}),1600),console.log("three.js: _clickQuiz2DButton: score: ",r.score,s)}else{if("MutiOption_Text"!=s.option_type&&"MutiOption_Image"!=s.option_type)return;if("text2D"!=t.makarType&&"image2D"!=t.makarType||t.traverse((function(e){if(e.isMesh){if("circle_in"==e.name)if(e.visible=!e.visible,r.choices.includes(p)){let e=r.choices.indexOf(p);r.choices.splice(e,1)}else r.choices.push(p);"circle_out"==e.name&&("7b7b7b"==e.material.color.getHexString()?e.material.color.setStyle("#00d1c1"):"00d1c1"==e.material.color.getHexString()&&e.material.color.setStyle("#7b7b7b"))}})),"button"==t.sub_type){let t=0;null==s.answer_list&&(s.answer_list=[]);for(let e of s.answer_list)if(correctAnswer=s.options_json[e],correctAnswer)for(let e of r.choices)e==correctAnswer.obj_id&&(t+=1);for(let e=0,t=s.options_json.length;e<t;e++)for(let t=0,i=r.choices.length;t<i;t++)s.options_json[e].obj_id==r.choices[t]&&o.push(e-1);if(t==s.answer_list.length&&s.answer_list.length==r.choices.length){if(s.active_score)if("Custom"==l)r.score+=s.score,n=s.score;else if("Total"==l){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}i=!0,c.style.display="block",d.style.display="block",u.style.display="block",h.style.display="none",console.log("three.js: _clickQuiz2DButton: Congratulations! Correct Answer!")}else i=!1,c.style.display="block",u.style.display="none",h.style.display="block",console.log("three.js: _clickQuiz2DButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: _clickQuiz2DButton: score , currectQuestion = ",a,r,r.choices,o,n);let t={question:a,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:i};if(r.record[a]=t,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),s.show_score){let t=document.getElementById("scoreDiv"),o=document.getElementById("score");t.style.display="block",t.onclick=function(){t.style.display="none",e.nextQuestion2D(r)},o.textContent=r.score}else e.nextQuestion2D(r)}),1600)}}},this.pushButton=function(t){let r=e.quizModule[e.currentProjectIndex],o=[],i=!1,n=0,a=r.json.display_order_list[r.currentQuestionIndex].index,s=r.json.question_list[a],l=r.json.score_type,c=document.getElementById("makarDragon"),d=document.getElementById("makarDragonWholeMaskDiv"),u=document.getElementById("imgRight"),h=document.getElementById("imgWrong");if(console.log("three.js: _pushButton: quizModule=",r,s),"Option_Text"==s.option_type||"Option_Image"==s.option_type){null==s.answer_list&&(s.answer_list=[]);let p=s.answer_list[0],m=s.options_json[p-1];console.log("three.js: _pushButton: single target=",t.el.id);let f=t.el.id;for(let e=0,t=s.options_json.length;e<t;e++)s.options_json[e].obj_id==f&&o.push(e);if(m.obj_id==f){if(s.active_score)if("Custom"==l)r.score+=s.score,n=s.score;else if("Total"==l){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}i=!0,c.style.display="block",d.style.display="block",u.style.display="block",h.style.display="none",console.log("three.js: _pushButton: Congratulations! Correct Answer!")}else i=!1,c.style.display="block",d.style.display="block",u.style.display="none",h.style.display="block",console.log("three.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: score , currectQuestion = ",a,r,r.choices,o,n);let t={question:a,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:i};if(r.record[a]=t,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),s.show_score){let t=document.getElementById("scoreDiv"),o=document.getElementById("score");t.style.display="block",t.onclick=function(){t.style.display="none",e.nextQuestion()},o.textContent=r.score}else e.nextQuestion()}),1600),console.log("three.js: _pushButton: score: ",r.score,s)}else{let p;if(console.log("three.js: _pushButton: target=",t),"text"!=t.makarType&&"image"!=t.makarType||(p=t.el.id,t.traverse((function(e){if(e.isGroup&&e.el&&e.el.id==t.el.id+"_circle_in")if(console.log(" 555555555555555 _circle_in",e),e.visible=!e.visible,r.choices.includes(p)){let e=r.choices.indexOf(p);r.choices.splice(e,1)}else r.choices.push(p);e.isMesh&&e.el&&e.el.id==t.el.id+"_circle_out"&&(console.log(" 555555555555555 _circle_out",e),"7b7b7b"==e.material.color.getHexString()?e.material.color.setStyle("#00d1c1"):"00d1c1"==e.material.color.getHexString()&&e.material.color.setStyle("#7b7b7b"))}))),"button"==t.sub_type){let t=0;null==s.answer_list&&(s.answer_list=[]);for(let e of s.answer_list)if(correctAnswer=s.options_json[e],correctAnswer)for(let e of r.choices)e==correctAnswer.obj_id&&(t+=1);for(let e=0,t=s.options_json.length;e<t;e++)for(let t=0,i=r.choices.length;t<i;t++)s.options_json[e].obj_id==r.choices[t]&&o.push(e-1);if(t==s.answer_list.length&&s.answer_list.length==r.choices.length){if(s.active_score)if("Custom"==l)r.score+=s.score,n=s.score;else if("Total"==l){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}i=!0,c.style.display="block",d.style.display="block",u.style.display="block",h.style.display="none",console.log("three.js: _pushButton: Congratulations! Correct Answer!")}else i=!1,c.style.display="block",u.style.display="none",h.style.display="block",console.log("three.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: score , currectQuestion = ",a,r,r.choices,o,n);let t={question:a,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:i};if(r.record[a]=t,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),s.show_score){let t=document.getElementById("scoreDiv"),o=document.getElementById("score");t.style.display="block",t.onclick=function(){t.style.display="none",e.nextQuestion()},o.textContent=r.score}else e.nextQuestion()}),1600)}}},this.nextQuestion2D=function(t){console.log("three.js: _nextQuestion2D: _quizModule = ",t),t.choices=[];let r=t.quizObject,o=[];for(let e of r.children)o.push(e);if(o.forEach((function(t){for(let o=0;o<e.makarObjects2D.length;o++)if(e.makarObjects2D[o].obj_id==t.obj_id){let t=e.makarObjects2D[o];r.remove(t),e.makarObjects2D.splice(o,1)}})),t.currentQuestionIndex+=1,t.currentQuestionIndex<t.json.display_order_list.length){let o=t.json.display_order_list[t.currentQuestionIndex].index,i=t.json.question_list[o];"Custom"==t.json.timer_type&&(t.timer.counter=i.time_limit);let n=document.getElementById("tipButtonDiv");i.show_tips?(n.style.display="block",n.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=i.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):n.style.display="none";let a=r.parent;if(i.questions_json&&Array.isArray(i.questions_json))for(let t=0;t<i.questions_json.length;t++){let r,o=i.questions_json[t],n=(new THREE.Vector3).fromArray(o.transform[0].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(o.transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(o.transform[2].split(",").map((function(e){return Number(e)})));switch(o.main_type){case"text":r=e.loadAframeText2D(a,o,t,i.questions_json.length,n,s,l);break;case"image":let c=i.questions_json[t].res_url;c=e.dealImageUrl(i.questions_json[t]),r=e.loadAframeTexture2D(a,o,c,t,i.questions_json.length,n,s,l)}}for(let t=0;t<i.options_json.length;t++){let r=i.options_json[t],o=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)}))),l=r.sub_type;console.log("three.js: _nextQuestion2D: _loadOption: ",t,l,i.options_json[t]);let c,d=r.res_url;switch(d=e.dealImageUrl(r),l){case"txt":c=e.loadAframeText2D(a,r,t,i.options_json.length,o,n,s);break;case"gif":case"jpg":case"jpeg":case"png":c=e.loadAframeTexture2D(a,r,d,t,i.options_json.length,o,n,s);break;case"button":d="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",c=e.loadAframeTexture2D(a,r,d,t,i.options_json.length,o,n,s)}"button"==l||"MutiOption_Text"!=i.option_type&&"MutiOption_Image"!=i.option_type||c.then((function(e){let t=e,r=new THREE.Vector3(0,0,0),o=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1));new THREE.Quaternion;if("MutiOption_Text"==i.option_type){let e=t.children[0].children[1],i=e.scale.clone(),n=t.children[0].getWorldScale(new THREE.Vector3),a=Math.min(i.x*e.geometry.parameters.width,i.y*e.geometry.parameters.height,1e6);o.multiply(new THREE.Vector3(.8,.8,.8).multiplyScalar(a)),o.divide(n);let s=e.geometry.parameters.width*i.x,l=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",l.load(resUrl,(function(e){r.x=.5*-s-48*o.x;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));i.name="circle_base",i.position.copy(r.clone()),i.scale.copy(o.clone()),t.children[0].add(i);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.children[0].add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",l.load(resUrl,(function(e){r.x=.5*-s-48*o.x;let i=new THREE.Mesh(new THREE.PlaneBufferGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));i.name="circle_out",i.renderOrder=1,i.position.copy(r.clone()),i.scale.copy(o.clone().multiplyScalar(.9)),t.children[0].add(i)}))}else{let e="",i=t.getWorldScale(new THREE.Vector3),n=t.scale.clone(),a=Math.max(n.x*t.children[0].geometry.parameters.width,n.y*t.children[0].geometry.parameters.height);o.multiply(new THREE.Vector3(.0025,.0025,.0025).multiplyScalar(a)),o.divide(i);let s=t.children[0].scale.clone(),l=t.children[0].geometry.parameters.height,c=new THREE.TextureLoader;e="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",c.load(e,(function(e){r.y=s.y*l*.5+48*o.y;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));i.name="circle_base",i.position.copy(r.clone()),i.scale.copy(o.clone()),t.add(i);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.add(n)})),e="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",c.load(e,(function(e){r.y=s.y*l*.5+48*o.y;let i=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));i.name="circle_out",i.renderOrder=1,i.position.copy(r.clone()),i.scale.copy(o.clone().multiplyScalar(.9)),t.add(i)}))}}))}if("Custom"==t.json.timer_type&&t.timer.counter>=0){document.getElementById("timerDiv");let e=Math.floor(t.timer.counter/3600),r=Math.floor((t.timer.counter-3600*e)/60),o=t.timer.counter-3600*e-60*r;timerContent.textContent=e.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}setTimeout((function(){if(t.timer.counter>=0){t.qClock=Date.now();let r=setInterval((function(){t.timer.currentTimer=r,t.timer.counter-=1;let n=Math.floor(t.timer.counter/3600),a=Math.floor((t.timer.counter-3600*n)/60),s=t.timer.counter-3600*n-60*a;if(timerContent.textContent=n.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0"),0==t.timer.counter)if(window.clearInterval(t.timer.currentTimer),"Custom"==t.json.timer_type)if(i.show_score){let r=document.getElementById("scoreDiv"),o=document.getElementById("score");r.style.display="block",r.onclick=function(){r.style.display="none",e.nextQuestion()},o.textContent=t.score}else e.nextQuestion();else{let r=[],i=t.quizEntity;for(let e of i.children)r.push(e);r.forEach((function(t){if(t.obj_parent_id==i.obj_id){i.remove(t);for(let r=0,o=e.makarObjects.length;r<o;r++)e.makarObjects[r]==t&&e.makarObjects.splice(r,1)}}));let n=document.getElementById("tipButtonDiv"),a=document.getElementById("tipDiv");n.style.display="none",a.style.display="none";let s=document.getElementById("startQuiz"),l=document.getElementById("QuizStartButton"),c=document.getElementById("QuizStartContent");s.style.display="block",c.textContent=u.timeIsUp[d];let h={question:o,get_score:0,answer_time:t.json.question_list[o].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};t.record[o]=h,t.record_time+=t.json.question_list[o].time_limit,t.qClock=Date.now(),l.onclick=function(){s.style.display="none",e.nextQuestion()}}}),1e3)}}),3e3)}else{window.clearInterval(t.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let r=document.getElementById("tipButtonDiv"),o=document.getElementById("tipDiv");r.style.display="none",o.style.display="none";let i=document.getElementById("quizEndDiv");i.style.display="block",i.addEventListener("click",(function(){i.style.display="none"})),console.log("three.js: quiz end , quizModule.record = ",t.record);let n="",a="";localStorage.getItem("login_shared_id")&&(n=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(a=localStorage.getItem("device_id"));let s={user_id:publishARProjs.result[e.currentProjectIndex].user_id,playing_user:n,proj_id:publishARProjs.result[e.currentProjectIndex].proj_id,proj_type:"ar",device_id:a,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[t.json],record_time:t.record_time,record_score:t.score,record:t.record};quizLog(window.serverUrl,s)}},this.nextQuestion=function(){let t=e.quizModule[e.currentProjectIndex];t.choices=[];let r=[],o=t.quizEntity;console.log(" three,js: _nextQuestion: quizModule = ",e.currentProjectIndex,t);for(let e of o.children)r.push(e);if(r.forEach((function(t){for(let r=0;r<e.makarObjects.length;r++)if(e.makarObjects[r].id==t.id){let t=e.makarObjects[r];if(t.getAttribute("src")){let e=t.getAttribute("src").split("#")[1];document.getElementById(e)&&document.getElementById(e).remove()}t.remove(),e.makarObjects.splice(r,1)}})),t.currentQuestionIndex+=1,t.currentQuestionIndex<t.json.display_order_list.length){let r=t.json.display_order_list[t.currentQuestionIndex].index,i=t.json.question_list[r];"Custom"==t.json.timer_type&&(t.timer.counter=i.time_limit);let n=document.getElementById("tipButtonDiv");i.show_tips?(n.style.display="block",n.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=i.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):n.style.display="none";let a=o.parentEl;if(i.questions_json&&Array.isArray(i.questions_json))for(let t=0;t<i.questions_json.length;t++){let r,o=(new THREE.Vector3).fromArray(i.questions_json[t].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(i.questions_json[t].transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(i.questions_json[t].transform[2].split(",").map((function(e){return Number(e)})));switch(i.questions_json[t].main_type){case"text":r=e.loadAframeText(a,i.questions_json[t],o,n,s);break;case"image":let l="";l=e.dealImageUrl(i.questions_json[t]),r=e.loadAframeTexture(a,l,i.questions_json[t],o,n,s);break;case"video":break;case"model":e.getUserRes_onlineRes(i.questions_json[t]);e.loadAframeGLTFModel(a,i.questions_json[t],o,n,s,e.cubeTex);break;case"audio":e.loadAframeAudio(a,i.questions_json[t],o,n,s)}}for(let t=0;t<i.options_json.length;t++){let r,o=(new THREE.Vector3).fromArray(i.options_json[t].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(i.options_json[t].transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(i.options_json[t].transform[2].split(",").map((function(e){return Number(e)}))),l=i.options_json[t].sub_type;console.log("three.js: _loadQuiz: _loadOption: ",t,l,i.options_json[t]);let c,d="";switch("txt"!=l&&(d=e.dealImageUrl(i.options_json[t])),l){case"txt":c=e.loadAframeText(a,i.options_json[t],o,n,s);break;case"gif":case"jpg":case"jpeg":case"png":c=e.loadAframeTexture(a,d,i.options_json[t],o,n,s);break;case"button":d="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",c=e.loadAframeTexture(a,d,i.options_json[t],o,n,s)}"button"==l||"MutiOption_Text"!=i.option_type&&"MutiOption_Image"!=i.option_type||c.then((function(t){r=t,r.object3D.matrixWorldNeedsUpdate=!0,r.object3D.updateMatrixWorld();let o=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,0,0),a=new THREE.Vector3(1,1,1),s=new THREE.Quaternion;if("MutiOption_Text"==i.option_type){let t=new THREE.Vector3(1,1,1).multiply(r.object3D.scale).multiply(r.object3D.parent.scale).multiply(r.object3D.parent.parent.scale),i=r.object3D.children[1].scale.clone().multiply(t),l=Math.max(i.x,i.y);a.multiply(new THREE.Vector3(30,30,30).multiplyScalar(l)),a.divide(t);let c=2*Math.abs(r.getObject3D("mesh").geometry.attributes.position.array[0]);o.x=.5*-a.x-.6*c,console.log(" 99999999999 ",a,o);let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),d.setAttribute("id",r.object3D.parent.el.id+"_circle_base"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.setAframeTransform(d,o,n,a,s),r.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),u.setAttribute("id",r.object3D.parent.el.id+"_circle_out"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.setAframeTransform(u,o,n,a,s),r.appendChild(u);let h=document.createElement("a-plane");h.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),h.setAttribute("id",r.object3D.parent.el.id+"_circle_in"),h.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),h.setAttribute("visible",!1),a.multiply(new THREE.Vector3(.7,.7,.7)),e.setAframeTransform(h,o,n,a,s),r.appendChild(h)}else{let t=setInterval((function(){if(r.getAttribute("heightForQuiz")){let i=r.object3D.getWorldScale(new THREE.Vector3),l=r.object3D.scale.clone(),c=Math.max(l.x,l.y);a.multiply(new THREE.Vector3(50,50,50).multiplyScalar(c)),a.divide(i);let d=r.object3D.children[0].scale.clone();o.y=.5*-a.y-.6*d.y;let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id",r.id+"_circle_base"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.setAframeTransform(u,o,n,a,s),r.appendChild(u);let h=document.createElement("a-plane");h.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),h.setAttribute("id",r.id+"_circle_out"),h.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.setAframeTransform(h,o,n,a,s),r.appendChild(h);let p=document.createElement("a-plane");p.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),p.setAttribute("id",r.id+"_circle_in"),p.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),p.setAttribute("visible",!1),a.multiply(new THREE.Vector3(.7,.7,.7)),e.setAframeTransform(p,o,n,a,s),r.appendChild(p),window.clearInterval(t)}}),100)}}))}if("Custom"==t.json.timer_type&&t.timer.counter>=0){document.getElementById("timerDiv");let e=Math.floor(t.timer.counter/3600),r=Math.floor((t.timer.counter-3600*e)/60),o=t.timer.counter-3600*e-60*r;timerContent.textContent=e.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}setTimeout((function(){if(t.timer.counter>=0){t.qClock=Date.now();let o=setInterval((function(){t.timer.currentTimer=o,t.timer.counter-=1;let n=Math.floor(t.timer.counter/3600),a=Math.floor((t.timer.counter-3600*n)/60),s=t.timer.counter-3600*n-60*a;if(timerContent.textContent=n.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0"),0==t.timer.counter)if(window.clearInterval(t.timer.currentTimer),"Custom"==t.json.timer_type)if(i.show_score){let r=document.getElementById("scoreDiv"),o=document.getElementById("score");r.style.display="block",r.onclick=function(){r.style.display="none",e.nextQuestion()},o.textContent=t.score}else e.nextQuestion();else{let o=[],i=t.quizEntity;for(let e of i.children)o.push(e);o.forEach((function(t){if(t.obj_parent_id==i.obj_id){i.remove(t);for(let r=0,o=e.makarObjects.length;r<o;r++)e.makarObjects[r]==t&&e.makarObjects.splice(r,1)}}));let n=document.getElementById("tipButtonDiv"),a=document.getElementById("tipDiv");n.style.display="none",a.style.display="none";let s=document.getElementById("startQuiz"),l=document.getElementById("QuizStartButton"),c=document.getElementById("QuizStartContent");s.style.display="block",c.textContent=u.timeIsUp[d];let h={question:r,get_score:0,answer_time:t.json.question_list[r].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};t.record[r]=h,t.record_time+=t.json.question_list[r].time_limit,t.qClock=Date.now(),l.onclick=function(){s.style.display="none",e.nextQuestion()}}}),1e3)}}),3e3)}else{window.clearInterval(t.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let r=document.getElementById("tipButtonDiv"),o=document.getElementById("tipDiv");r.style.display="none",o.style.display="none";let i=document.getElementById("quizEndDiv");i.style.display="block",i.addEventListener("click",(function(){i.style.display="none"})),console.log("three.js: quiz end , quizModule.record = ",t.record);let n="",a="";localStorage.getItem("login_shared_id")&&(n=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(a=localStorage.getItem("device_id"));let s={user_id:publishARProjs.result[e.currentProjectIndex].user_id,playing_user:n,proj_id:publishARProjs.result[e.currentProjectIndex].proj_id,proj_type:"ar",device_id:a,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[t.json],record_time:t.record_time,record_score:t.score,record:t.record};quizLog(window.serverUrl,s)}},this.checkGLTFMaterialIndex=function(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("three.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("three.js: _checkGLTFMaterialIndex: material error",t);let r=t.rendererIndex,o=t.materialIndex,i=-1,n=-1,a=e.object3D.children[0].ModelJson.nodes,s=-1;for(let e=0;e<a.length;e++)if("number"==typeof a[e].mesh&&s++,r==s){i=a[e].mesh;break}if(i>=0){let t=e.object3D.children[0].ModelJson.meshes[i];if(t&&t.primitives){let e=t.primitives[o];e.material>=0&&(n=e.material)}}return n},this.setGLTFMaterial=function(e,t){let r=this,o=e.getObject3D("mesh"),i=-1,n=r.cubeTex;for(let s=0;s<t.material.length;s++){o.ModelJson&&(i=r.checkGLTFMaterialIndex(e,t.material[s]));let l=t.material[s].color.split(","),c=new THREE.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]));switch(o.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),t.material[s].shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:c,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":var a=e.sceneEl.renderer;o.traverse((e=>{if(e.material){let r=e.material.name.split("_");r[r.length-1]==i&&(e.material=new THREE.MeshStandardMaterial({name:e.material.name,skinning:e.material.skinning,map:e.material.map,emissive:e.material.emissive,emissiveMap:e.material.emissiveMap,normalMap:e.material.normalMap}),e.material.color=c,e.material.metalness=t.material[s].metallic,e.material.roughness=1-t.material[s].smoothness,e.material.envMap=n.texture,e.material.envMapIntensity=1,e.material.needsUpdate=!0,e.material.reflectivity=0,e.material.side=THREE.DoubleSide,e.material.transparent=!0,e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),0==t.material[s].mode?(e.material.opacity=1,a.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor):1==t.material[s].mode?(e.material.opacity=1,e.material.alphaTest=t.material[s].cut_off,a.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[s].cut_off})):2==t.material[s].mode?(e.material.opacity=parseFloat(l[3]),e.material.depthWrite=!1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[s].cut_off})):3==t.material[s].mode&&(e.material.opacity=Math.max(parseFloat(l[3]),t.material[s].metallic),e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[s].cut_off})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.depthWrite=!1)}}));break;case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0,console.log(e.material.map)),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.onBeforeCompile=function(e){e.uniforms.tEquirect={value:r.cameraTexture},e.vertexShader="varying vec4 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = -vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1)}}));break;case"Blocks/BlocksGlass":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1)}}));break;default:console.log(`The shader of no. ${s} material is not supported currently.`)}}},this.loadAframeGLTFModelWithTexture=function(t,r,o,i,n,a,s){return new Promise((function(l){var c=new XMLHttpRequest;c.open("GET","https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/colorMeshNames.txt"),c.responseType="text",c.onload=function(d){var u=c.response.split("\n");console.log(" three.js: _loadAframeGLTFModelWithTexture , meshNameList = ",u,r);let h=e.gcssTargets.dpi[t.GCSSID],p=e.gcssTargets.width[t.GCSSID],m=e.gcssTargets.height[t.GCSSID],f=document.getElementById("makarAssets"),g=document.createElement("a-asset-item");g.setAttribute("id",r.obj_id+"_"+r.res_id),g.setAttribute("src",r.res_url),g.setAttribute("response-type","arraybuffer"),g.setAttribute("crossorigin","anonymous"),f.appendChild(g);var b,_=null;if(r.animation){_=[];for(let e=0;e<r.animation.length;e++)(r.animation[e].defaultAnimation||r.animation[e].isActive)&&(_.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),b=r.animation[e].animationName);for(let e=0;e<r.animation.length;e++)_.push({name:r.animation[e].name,animationName:r.animation[e].animationName,startTime:r.animation[e].startTime,endTime:r.animation[e].endTime,uid:r.animation[e].uid})}let v=document.createElement("a-entity");if(r.res_url){if(v.setAttribute("gltf-model","#"+r.obj_id+"_"+r.res_id),r.animation&&v.setAttribute("animation-mixer","clip: "+b),r.behav?v.setAttribute("class","clickable"):v.setAttribute("class","unclickable"),v.setAttribute("id",r.obj_id),v.setAttribute("crossorigin","anonymous"),v.setAttribute("shadow",""),r.model_shift){let e=(new THREE.Vector3).fromArray(r.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(a),i.add(e)}if(e.makarObjects.push(v),v.addEventListener("model-loaded",(function(t){if(t.target==t.currentTarget){let d=e.arfScene.renderer.capabilities.getMaxAnisotropy();v.object3D.children[0].scale.set(2540/h,2540/h,2540/h),v.object3D.children[0].rotation.y=Math.PI;let f=r.quaternionRotation.split(","),g=new THREE.Quaternion(Number(f[1]),Number(f[2]),Number(f[3]),Number(f[0])),b=new THREE.Vector3;if(r.obj_parent_id){v.object3D.obj_parent_id=r.obj_parent_id,b.addScaledVector(i,2540/h);let t=b.z;b.z=-t,e.setAframeTransform(v,b,n,a,g)}else{switch(window.serverVersion){case"2.0.0":a.multiplyScalar(1),b.addScaledVector(i,2540/h);break;case"3.0.0":a.multiplyScalar(2),b.addScaledVector(i,5080/h);break;default:console.log("three.js: loadAframeGLTFModelWithTexture: serverVersion version wrong",serverVersion)}let t=b.y,r=b.z;b.y=r,b.z=t,e.setAframeTransform(v,b,n,a,g),v.object3D.position.add(new THREE.Vector3(25.4*p/h/2,25.4*m/h/2,0)),v.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeGLTFModelWithTexture: loaded: no parent prs=",v.object3D.position,v.object3D.rotation,v.object3D.scale)}let y=v.object3D;if(y.originTransform={position:y.position.clone(),rotation:y.rotation.clone(),scale:y.scale.clone()},v.object3D.makarType="model",v.object3D.makarObject=!0,r.behav&&(v.object3D.behav=r.behav,e.setObjectBehavAll(r)),r.behav_reference&&(v.object3D.behav_reference=r.behav_reference),t.detail.model.traverse((e=>{if(!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=d,e.material.map.needsUpdate=!0),e.isMesh){for(let t=0,r=u.length;t<r;t++)e.name==u[t]&&(skinnedTexture=new THREE.CanvasTexture(o),skinnedTexture.flipY=!1,skinnedTexture.needsUpdate=!0,e.material.map=skinnedTexture,e.material.needsUpdate=!0);e.material.flatShading=!1,e.material.needsUpdate=!0}})),v.object3D){let o=v.getObject3D("mesh"),i=-1;if(r.material)for(let t=0;t<r.material.length;t++){o.ModelJson&&(i=e.checkGLTFMaterialIndex(v,r.material[t]));let n=r.material[t].color.split(","),a=new THREE.Color(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]));switch(o.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),r.material[t].shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let o=e.material.name.split("_");o[o.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:a,name:r.material[t].name,skinning:e.material.skinning}))}}));break;case"Standard":var c=v.sceneEl.renderer;o.traverse((e=>{if(e.material){let o=e.material.name.split("_");o[o.length-1]==i&&(e.material=new THREE.MeshStandardMaterial({name:e.material.name,skinning:e.material.skinning,map:e.material.map,emissive:e.material.emissive,emissiveMap:e.material.emissiveMap,normalMap:e.material.normalMap}),e.material.color=a,e.material.metalness=r.material[t].metallic,e.material.roughness=1-r.material[t].smoothness,e.material.envMap=s.texture,e.material.envMapIntensity=1,e.material.needsUpdate=!0,e.material.reflectivity=0,e.material.side=THREE.DoubleSide,e.material.transparent=!0,e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),0==r.material[t].mode?(e.material.opacity=1,c.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor):1==r.material[t].mode?(e.material.opacity=1,e.material.alphaTest=r.material[t].cut_off,c.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:r.material[t].cut_off})):2==r.material[t].mode?(e.material.opacity=parseFloat(n[3]),e.material.depthWrite=!1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:r.material[t].cut_off})):3==r.material[t].mode&&(e.material.opacity=Math.max(parseFloat(n[3]),r.material[t].metallic),e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:r.material[t].cut_off})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.depthWrite=!1)}}));break;case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let o=e.material.name.split("_");o[o.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:r.material[t].name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0,console.log(e.material.map)),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((t=>{if(t.material){let r=t.material.name.split("_");r[r.length-1]==i&&(t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.cameraTexture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = -vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1)}}));break;case"Blocks/BlocksGlass":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1)}}));break;default:console.log(`The shader of no. ${t} material is not supported currently.`)}}Array.isArray(t.detail.model.animations)&&t.detail.model.animations.length>0&&!v.getAttribute("animation-mixer")&&(console.log("three.js: _loadAframeGLTFModelWithTexture: the model with animation but no animation-mixer, probabily older version of editor "),v.setAttribute("animation-mixer","clip: "+t.detail.model.animations[0].name),(_=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),_.push({animationName:t.detail.model.animations[0].name,name:t.detail.model.animations[0].name,endTime:t.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),t.detail.model.animationSlices=_,l(v)}}})),0==r.active&&(v.setAttribute("visible",!1),v.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowModel"==r.behav_reference[e].behav_name){v.setAttribute("visible",!1),v.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(v),window.clearInterval(e))}),1)}else t.appendChild(v),console.log(" 222222222222222 ",t,v)}},c.send()}))},this.loadAframeGLTFModel=function(t,r,o,i,n,a){return new Promise((function(a){e.UrlExistsFetch(r.res_url).then((s=>{if(1==s){if(""==r.res_url||"glb"!=r.sub_type&&"gltf"!=r.sub_type&&"gltf_sketchFab"!=r.sub_type&&"gltf_sketchfab"!=r.sub_type&&"gltf_poly"!=r.sub_type)return console.log(" three.js: _loadAframeGLTFModel: obj not support ",r),void a(-1);let s=e.gcssTargets.dpi[t.GCSSID],d=e.gcssTargets.width[t.GCSSID],u=e.gcssTargets.height[t.GCSSID],h=e.sceneTargetList[t.GCSSID].projIndex,p=document.getElementById("makarAssets"),m=document.createElement("a-asset-item");m.setAttribute("id",r.obj_id+"_"+r.res_id),m.setAttribute("src",r.res_url),m.setAttribute("response-type","arraybuffer"),m.setAttribute("crossorigin","anonymous"),p.appendChild(m);var l,c=null;if(r.animation){c=[];let t=e.getProjectVersion(h);if(Array.isArray(t)&&3==t.length){let e=Number(t[0]),o=Number(t[1]),i=Number(t[2]);if(e>3||3==e&&o>3||3==e&&3==o&&i>8){for(let e=0;e<r.animation.length;e++)(r.animation[e].is_default||r.animation[e].is_active)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),l=r.animation[e].animation_name);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animation_name,startTime:r.animation[e].start_time,endTime:r.animation[e].end_time,uid:r.animation[e].uid})}else{for(let e=0;e<r.animation.length;e++)(r.animation[e].defaultAnimation||r.animation[e].isActive)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),l=r.animation[e].animationName);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animationName,startTime:r.animation[e].startTime,endTime:r.animation[e].endTime,uid:r.animation[e].uid})}}else{for(let e=0;e<r.animation.length;e++)(r.animation[e].is_default||r.animation[e].is_active)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),l=r.animation[e].animation_name);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animation_name,startTime:r.animation[e].start_time,endTime:r.animation[e].end_time,uid:r.animation[e].uid})}}let f=document.createElement("a-entity");if(!r.res_url)return;if(f.setAttribute("gltf-model","#"+r.obj_id+"_"+r.res_id),r.animation&&f.setAttribute("animation-mixer","clip: "+l),r.behav?f.setAttribute("class","clickable"):f.setAttribute("class","unclickable"),f.setAttribute("id",r.obj_id),f.setAttribute("crossorigin","anonymous"),f.setAttribute("shadow",""),r.model_shift){let e=(new THREE.Vector3).fromArray(r.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(n),o.add(e)}if(e.makarObjects.push(f),f.addEventListener("model-loaded",(function(t){if(t.target==t.currentTarget){let l=e.arfScene.renderer.capabilities.getMaxAnisotropy();f.object3D.children[0].scale.set(2540/s,2540/s,2540/s),f.object3D.children[0].rotation.y=Math.PI;let p=r.quaternionRotation.split(","),m=new THREE.Quaternion(Number(p[1]),Number(p[2]),Number(p[3]),Number(p[0])),g=new THREE.Vector3;if(r.obj_parent_id){f.object3D.obj_parent_id=r.obj_parent_id,g.addScaledVector(o,2540/s);let t=g.z;g.z=-t,e.setAframeTransform(f,g,i,n,m)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),g.addScaledVector(o,2540/s);break;case"3.0.0":n.multiplyScalar(2),g.addScaledVector(o,5080/s);break;default:console.log("three.js: _loadAframeGLTFModel: serverVersion version wrong",serverVersion)}let t=g.y,r=g.z;g.y=r,g.z=t,e.setAframeTransform(f,g,i,n,m),f.object3D.position.add(new THREE.Vector3(25.4*d/s/2,25.4*u/s/2,0)),f.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeGLTFModel: loaded: no parent prs=",f.object3D.position,f.object3D.rotation,f.object3D.scale)}let b=f.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone()},r.blockly&&(b.resetProperty=function(){e.setGLTFMaterial(f,r)}),f.object3D.makarType="model",f.object3D.makarObject=!0,r.behav&&(f.object3D.behav=r.behav,e.setObjectBehavAll(r,h)),r.behav_reference&&(f.object3D.behav_reference=r.behav_reference),t.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=l,e.material.map.needsUpdate=!0)})),f.object3D&&(e.setGLTFMaterial(f,r),Array.isArray(t.detail.model.animations)&&t.detail.model.animations.length>0&&!f.getAttribute("animation-mixer")&&(console.log("three.js: loadGFLTFModel: the model with animation but no animation-mixer, probabily older version of editor "),f.setAttribute("animation-mixer","clip: "+t.detail.model.animations[0].name),(c=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),c.push({animationName:t.detail.model.animations[0].name,name:t.detail.model.animations[0].name,endTime:t.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),t.detail.model.animationSlices=c,a(f))}})),0==r.active&&(f.setAttribute("visible",!1),f.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowModel"==r.behav_reference[e].behav_name){f.setAttribute("visible",!1),f.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(f),window.clearInterval(e))}),1)}else t.appendChild(f)}else console.log("ARFunc.js: _loadAframeGLTFModel , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],e.loadAframeGLTFModel(t,r,o,i,n,e.cubeTex),a(1)}))}))},this.checkDefaultImage=function(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;default:console.log("image: default, obj=",e)}},this.loadAframeTexture=function(t,r,o,i,n,a){return console.log("three.js: ARController: _loadAframeTexture, obj=",o,i,n,a),e.checkDefaultImage(o),new Promise((function(s){e.UrlExistsFetch(o.res_url).then((l=>{if(1==l){o.res_url=r;let l,c=e.gcssTargets.dpi[t.GCSSID],d=e.gcssTargets.width[t.GCSSID],u=e.gcssTargets.height[t.GCSSID],h=e.sceneTargetList[t.GCSSID].projIndex,p=(new THREE.TextureLoader).load(o.res_url),m=o.res_url.split(".").length,f=o.res_url.split(".")[m-1].toLowerCase();if(o.sub_type=o.sub_type.toLowerCase(),"png"==o.sub_type||"jpg"==o.sub_type||"jpeg"==o.sub_type||"bmp"==o.sub_type)f=o.sub_type,l=document.createElement("a-plane"),l.setAttribute("src",o.res_url);else if("gif"==o.sub_type)f=o.sub_type,l=document.createElement("a-entity");else{if("button"!=o.sub_type)return console.log("_loadAframeTexture: sub_type empty, create empty plane "),l=document.createElement("a-plane"),void s(l);"png"!=f&&"jpg"!=f&&"jpeg"!=f&&(f="png"),l=document.createElement("a-plane"),l.setAttribute("src",o.res_url)}l.setAttribute("id",o.obj_id),l.setAttribute("crossorigin","anonymous");let g=!1;if(o.behav)for(let e=0;e<o.behav.length;e++)"TransparentVideo"!=o.behav[e].simple_behav&&"TransparentImage"!=o.behav[e].simple_behav||(g=!0,chromaKey=o.behav[e].chromakey,slope=o.behav[e].slope,threshold=o.behav[e].threshold,transparentBehav=o.behav[e]);if(g){let e=chromaKey.split(","),t=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),r=transparentBehav.HSV.split(","),i=parseFloat(r[0]),n=parseFloat(r[1]),a=parseFloat(r[2]);"jpg"==f||"jpeg"==f||"png"==f?"RGB"==transparentBehav.mode?l.setAttribute("material","shader: chromaKey; color: #"+t.getHexString()+";transparent: true; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";"):"HSV"==transparentBehav.mode&&l.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+i+"; _keyingColorS:"+n+"; _keyingColorV:"+a+"; _deltaH:"+parseFloat(transparentBehav.hue)+"; _deltaS:"+parseFloat(transparentBehav.saturation)+"; _deltaV:"+parseFloat(transparentBehav.brightness)+";"):"gif"==f&&("RGB"==transparentBehav.mode?(l.setAttribute("geometry","primitive: plane"),l.setAttribute("material","shader:gif_RGB;  src: url("+o.res_url+"); opacity: 1; transparent: true; depthWrite:false; color: #"+t.getHexString()+"; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";")):"HSV"==transparentBehav.mode&&(l.setAttribute("geometry","primitive: plane"),l.setAttribute("material","shader:gif_HSV;  src: url("+o.res_url+"); opacity: 1; transparent: true; depthWrite:false; _keyingColorH:"+i+"; _keyingColorS:"+n+"; _keyingColorV:"+a+"; _deltaH:"+parseFloat(transparentBehav.hue)+"; _deltaS:"+parseFloat(transparentBehav.saturation)+"; _deltaV:"+parseFloat(transparentBehav.brightness)+";")))}else"jpg"==f||"jpeg"==f||"png"==f?l.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; "):"gif"==f&&(l.setAttribute("geometry","primitive: plane"),l.setAttribute("material","shader:gif;  src: url("+o.res_url+"); opacity: 1; transparent: true;"));o.behav?1==o.behav.length&&g?l.setAttribute("class","unclickable"):l.setAttribute("class","clickable"):l.setAttribute("class","unclickable"),e.makarObjects.push(l);let b=e.arfScene.renderer.capabilities.getMaxAnisotropy();if(l.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=b,e.detail.texture.needsUpdate=!0})),l.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){let t=setInterval((function(){if(p.image&&l.object3D&&l.object3D.children&&l.object3D.children[0]&&l.object3D.children[0].scale){l.object3D.children[0].scale.set(25.4*p.image.width/c,25.4*p.image.height/c,1);let r=o.quaternionRotation.split(","),h=new THREE.Quaternion(Number(r[1]),Number(r[2]),Number(r[3]),Number(r[0])),m=new THREE.Vector3;if(o.obj_parent_id){l.object3D.obj_parent_id=o.obj_parent_id,m.addScaledVector(i,2540/c);let t=m.z;m.z=-t,e.setAframeTransform(l,m,n,a,h)}else{switch(window.serverVersion){case"2.0.0":a.multiplyScalar(1),m.addScaledVector(i,2540/c);break;case"3.0.0":m.addScaledVector(i,5080/c),a.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let t=m.y,r=m.z;m.y=r,m.z=t,e.setAframeTransform(l,m,n,a,h),l.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),l.object3D.rotation.x+=90*Math.PI/180}let f=l.object3D;f.originTransform={position:f.position.clone(),rotation:f.rotation.clone(),scale:f.scale.clone()},o.blockly&&(f.resetProperty=function(){}),l.setAttribute("heightForQuiz",.01*p.image.height),window.clearInterval(t),s(l)}}),1);l.object3D.makarType="image",l.object3D.makarObject=!0,o.behav&&(l.object3D.behav=o.behav,e.setObjectBehavAll(o,h)),o.behav_reference&&(l.object3D.behav_reference=o.behav_reference),"button"==o.main_type&&(l.object3D.main_type=o.main_type,l.object3D.sub_type=o.sub_type,l.setAttribute("class","clickable"),console.log("three.js: _loadAframeTexture: button ",l))}else console.log("three.js: _loadAframeTexture: loaded target different")})),0==o.active&&(l.setAttribute("visible",!1),l.setAttribute("class","unclickable")),o.behav_reference)for(let e=0;e<o.behav_reference.length;e++)if("ShowImage"==o.behav_reference[e].behav_name){l.setAttribute("visible",!1),l.setAttribute("class","unclickable");break}if(o.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(o.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(l),window.clearInterval(e))}),1)}else t.appendChild(l)}else console.log("ARFunc.js: _loadAframeTexture , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",o.material=[],e.loadAframeGLTFModel(t,o,i,n,a,e.cubeTex),s(1)}))}))},this.loadCanvas2D=function(t,r,o,i,n,a){let s="";if(Array.isArray(r.project_module))if(1==r.project_module.length)if(r.project_module[0].scratch_image_url){var l=this.getDefaultImageUrl(r.project_module[0].scratch_image_url);l.indexOf("https")>=0?s=l:console.error("three.js: _loadCanvas2D: error, obj.project_module[0].scratch_image_url not include [https]",r)}else console.log("three.js: _loadCanvas2D: obj.project_module[0].scratch_image_url not exist or empty, use default"),s="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png";else console.error("three.js: _loadCanvas2D: error, obj.project_module length>1",r);else console.error("three.js: _loadCanvas2D: error, obj.project_module not array",r);if(""==s)return;let c,d,u,h=e.sceneTargetList[t.GCSSID].projIndex,p=e.getProjectVersion(h);if(Array.isArray(p)&&3==p.length){let e=Number(p[0]),t=Number(p[1]),o=Number(p[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=m();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadCanvas2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadCanvas2D: rect PSO=",e,t,o,i,n),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadCanvas2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}}else{let e=m();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}function m(){let t,o,a,s,l={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){let c=e.getResolutionIndex(h);Number.isFinite(c)||(console.log(" _getObj2DInfo338: error, missing _selectedResolutionIndex"),c=0);let d=r.rect_transform[c];if(d.position&&d.rotation&&d.scale){t=d.position.split(",").map((function(e){return Number(e)})),o=d.size_dalta.split(",").map((function(e){return Number(e)})),a=d.scale.split(",").map((function(e){return Number(e)})),s=d.rotation.split(",").map((function(e){return Number(e)}));let e=new THREE.Quaternion(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])),r=new THREE.Euler;r.setFromQuaternion(e),i.z=r.z/Math.PI*180,n.x=a[0],n.y=a[1],l={rectP:t,rectSizeDelta:o,rectScale:a}}}return l}let f,g,b=e.get2DScaleRatioByProjIndex(h);f=d[0]*n.x*b,g=d[1]*n.y*b;let _=document.createElement("div");_.setAttribute("class","scratchCanvasContainer"),_.setAttribute("id",r.obj_id),_.style.width=f+"px",_.style.height=g+"px",_.style.left=innerWidth/2-f/2+c[0]*b+"px",_.style.top=innerHeight/2-g/2+-c[1]*b+"px";let v=document.createElement("canvas"),y=v.getContext("2d");v.setAttribute("class","scratchCanvas"),v.setAttribute("width",f),v.setAttribute("height",g);let w=new Image;w.onload=function(){y.drawImage(w,0,0,w.width,w.height,0,0,v.width,v.height),a&&setTimeout((function(){a(j)}),1)};let E=new XMLHttpRequest;E.open("GET",s),E.responseType="blob",E.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);w.src=t},E.send(),_.appendChild(v),document.body.appendChild(_);let j=new THREE.Object3D;j.obj_id=r.obj_id,j.main_type="module",j.sub_type="scratch_card",j.canvasDomElement=_,r.project_module[0].password?j.password=r.project_module[0].password:j.password="",t.add(j),aScratchCard.setCanvas(v,_,j)},this.loadAframeTexture2D=function(t,r,o,i,n,a,s,l){console.log("three.js: arController: _loadAframeTexture2D , obj=",r,a,s,l,o),e.checkDefaultImage(r);let c=e.sceneTargetList[t.GCSSID].projIndex,d=e.getProjectVersion(c);return new Promise((function(a){(new THREE.TextureLoader).load(o,(function(u){let h,p,m,f,g;if(Array.isArray(d)&&3==d.length){let e=Number(d[0]),t=Number(d[1]),o=Number(d[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=b();e.rectP&&e.rectSizeDelta&&e.rectScale?(h=e.rectP,p=e.rectSizeDelta,m=e.rectScale):a(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadAframeTexture2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadAframeTexture2D: rect PSO=",e,t,o,s,l),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadAframeTexture2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(h=e.rectP,p=e.rectSizeDelta,m=e.rectScale):a(!1)}}else{let e=b();e.rectP&&e.rectSizeDelta&&e.rectScale?(h=e.rectP,p=e.rectSizeDelta,m=e.rectScale):a(!1)}function b(){let t,o,i,n,a={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){let d=e.getResolutionIndex(c);Number.isFinite(d)||(console.log(" _loadAframeTexture2D: _getObj2DInfo338: error, missing _selectedResolutionIndex"),d=0);let u=r.rect_transform[d];if(u.position&&u.rotation&&u.scale){t=u.position.split(",").map((function(e){return Number(e)})),o=u.size_dalta.split(",").map((function(e){return Number(e)})),i=u.scale.split(",").map((function(e){return Number(e)})),n=u.rotation.split(",").map((function(e){return Number(e)}));let e=new THREE.Quaternion(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),r=new THREE.Euler;r.setFromQuaternion(e),s.z=r.z/Math.PI*180,l.x=i[0],l.y=i[1],a={rectP:t,rectSizeDelta:o,rectScale:i}}}return a}u.flipY=!1,console.log("three.js: _loadAframeTexture2D: innerWH , camera2D ",innerWidth,innerHeight,e.arfScene.clientWidth,e.arfScene.clientHeight);let _=e.get2DScaleRatioByProjIndex(c);f=p[0]*_,g=p[1]*_;let v=r.sub_type,y=new THREE.Object3D;y.makarType="image2D";let w,E,j,T=!1;if(r.behav)for(let e=0;e<r.behav.length;e++)"TransparentImage"==r.behav[e].simple_behav&&(T=!0,arrayColor=r.behav[e].chromakey.split(","),slope=r.behav[e].slope,threshold=r.behav[e].threshold,w=r.behav[e],console.log("three.js: _loadAframeTexture2D: behav TransparentImage",r.behav[e]));if(T){let e,t=w.HSV.split(","),r=parseFloat(t[0]),i=parseFloat(t[1]),n=parseFloat(t[2]);"jpg"==v||"jpeg"==v||"png"==v||"button"==v?("RGB"==w.mode?e=new THREE.ChromaKeyMaterial({map:u,keyColor:arrayColor,side:THREE.DoubleSide,slope:slope,threshold:threshold}):"HSV"==w.mode&&(e=new THREE.HSVMattingMaterial({map:u,side:THREE.DoubleSide,_keyingColorH:r,_keyingColorS:i,_keyingColorV:n,_deltaH:w.hue,_deltaS:w.saturation,_deltaV:w.brightness})),E=new THREE.Mesh(new THREE.PlaneGeometry(f,g),e)):"gif"==v&&(j=new THREE.gifAnimator,j.init({src:o,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0,chroma:w}),y.gifObject=j,j.__texture.flipY&&(j.__texture.flipY=!1),E=new THREE.Mesh(new THREE.PlaneGeometry(f,g),j.material))}else"jpg"==v||"jpeg"==v||"png"==v||"button"==v?E=new THREE.Mesh(new THREE.PlaneGeometry(f,g),new THREE.MeshBasicMaterial({map:u,side:THREE.DoubleSide,transparent:!0})):"gif"==v&&(j=new THREE.gifAnimator,j.init({src:o,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0}),y.gifObject=j,j.__texture.flipY&&(j.__texture.flipY=!1),E=new THREE.Mesh(new THREE.PlaneGeometry(f,g),j.material));if(r.behav_reference){y.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowImage"==r.behav_reference[e].behav_name&&(y.visible=!1,"gif"==v&&(j.pause(),j.__autoplay=!1))}if(r.behav&&(y.behav=r.behav,e.setObjectBehavAll(r,c)),0==r.active&&(y.visible=!1),r.behav_reference){y.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowImage"==r.behav_reference[e].behav_name&&(y.visible=!1)}if("button"==r.main_type&&(y.main_type=r.main_type,y.sub_type=r.sub_type,console.log("three.js: _loadAframeTexture2D: button ",E)),r.obj_parent_id){let t=function(){let o=!1;for(let t=0;t<e.makarObjects2D.length;t++)e.makarObjects2D[t].obj_id==r.obj_parent_id&&(o=!0);if(0==o)setTimeout(t,500);else for(let t=0;t<e.makarObjects2D.length;t++)if(e.makarObjects2D[t].obj_id==r.obj_parent_id){y.translateX(h[0]*_),y.translateY(-h[1]*_);let o=new THREE.Vector3;e.makarObjects2D[t].getWorldPosition(o),y.translateZ(i/n-1-o.z),y.rotateZ(-s.z/180*Math.PI),y.scale.set(l.x,l.y,1),e.makarObjects2D[t].add(y),e.makarObjects2D.push(y),y.add(E),y.makarObject=!0,y.obj_id=r.obj_id,y.obj_parent_id=r.obj_parent_id,a(y),console.log("three.js: _loadAframeTexture2D: parent exit, set obj(parent) ",r,E)}};t()}else y.translateX(h[0]*_),y.translateY(-h[1]*_),y.translateZ(i/n-1),y.rotateZ(-s.z/180*Math.PI),y.scale.set(l.x,l.y,1),e.makarObjects2D.push(y),t.add(y),y.add(E),y.makarObject=!0,y.obj_id=r.obj_id,a(y)}),void 0,(function(e){console.error("An error happened. _loadAframeTexture2D , err=",e)}))}))},this.loadDeaultTexture2D=function(e,t,r,o,i,n,a){(new THREE.TextureLoader).load(t,(function(t){let s,l,c,d,u;s=[0,0,0],l=[150,150],c=n,t.flipY=!1,d=t.image.width*i.x*2/3,u=t.image.height*i.y*2/3;var h=new THREE.Mesh(new THREE.PlaneGeometry(d,u),new THREE.MeshBasicMaterial({map:t,side:THREE.DoubleSide,transparent:!0,opacity:1}));switch(.5==c[0]&&.5==c[1]||(1==c[0]&&.5==c[1]?h.translateX(240-1*d/2):0==c[0]&&.5==c[1]?h.translateX(1*d/2-240):.5==c[0]&&1==c[1]?h.translateY(1*u/2-320):.5==c[0]&&0==c[1]?h.translateY(320-1*u/2):0==c[0]&&1==c[1]?(h.translateX(1*d/2-240),h.translateY(1*u/2-320)):1==c[0]&&1==c[1]?(h.translateX(240-1*d/2),h.translateY(1*u/2-320)):0==c[0]&&0==c[1]?(h.translateX(1*d/2-240),h.translateY(320-1*u/2)):1==c[0]&&0==c[1]&&(h.translateX(240-1*d/2),h.translateY(320-1*u/2))),h.translateX(2*s[0]/3),h.translateY(1*-s[1]/2),h.translateX(r.x),h.translateY(-r.y),h.rotateZ(-o.z/180*Math.PI),a.simple_behav){case"coloring":if(h.behav=[{simple_behav:"Coloring",enable:!1}],h.makarObject=!0,h.name="colorButton",h.material.opacity=1,arController&&arController.arfScene&&arController.arfScene.clientHeight){let e=arController.arfScene.clientHeight;h.position.y=.35*e}break;case"snapShot":h.behav=[{simple_behav:"SnapShot",enable:!0}],h.makarObject=!0;break;case"exchangeCamera":h.behav=[{simple_behav:"exchangeCamera",enable:!0}],h.makarObject=!0;break;case"runAnimation2D":h.behav=[a],h.makarObject=!0;break;default:console.log("three.js: _loadDeaultTexture2D: default: behav=",a)}h.defaultTexture=!0,h.visible=!0,e.add(h)}),void 0,(function(e){console.error("An error happened. _loadDeaultTexture2D")}))},this.loadAframeVideo=function(t,r,o,i,n){return new Promise((function(a){e.UrlExistsFetch(r.res_url).then((s=>{if(1==s){let s=e.gcssTargets.dpi[t.GCSSID],c=e.gcssTargets.width[t.GCSSID],d=e.gcssTargets.height[t.GCSSID],u=(e.sceneTargetList[t.GCSSID].projIndex,document.getElementById("makarAssets"));var l;(l=document.createElement("video")).src=r.res_url,l.playsInline=!0,l.autoplay=!1,l.loop=!0,l.setAttribute("crossorigin","anonymous"),l.setAttribute("id",r.obj_id+"_"+r.res_id),u.appendChild(l),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(l.muted=!0),l.onloadedmetadata=function(){var u,h;l.videoWidth>=l.videoHeight?(u=1,h=1*l.videoHeight/l.videoWidth):(u=1*l.videoWidth/l.videoHeight,h=1);let p=document.createElement("a-video"),m=!1;if(r.behav)for(let e=0;e<r.behav.length;e++)"TransparentVideo"==r.behav[e].simple_behav&&(m=!0,chromaKey=r.behav[e].chromakey,slope=r.behav[e].slope,threshold=r.behav[e].threshold,transparentBehav=r.behav[e]);if(m){let e=chromaKey.split(",");var f=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));let t=transparentBehav.HSV.split(","),r=parseFloat(t[0]),o=parseFloat(t[1]),i=parseFloat(t[2]);"RGB"==transparentBehav.mode?p.setAttribute("material","shader: chromaKey; color: #"+f.getHexString()+";transparent: true; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";"):"HSV"==transparentBehav.mode&&p.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+r+"; _keyingColorS:"+o+"; _keyingColorV:"+i+"; _deltaH:"+transparentBehav.hue+"; _deltaS:"+transparentBehav.saturation+"; _deltaV:"+transparentBehav.brightness+";")}else p.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");r.behav?1==r.behav.length&&m?p.setAttribute("class","unclickable"):p.setAttribute("class","clickable"):p.setAttribute("class","unclickable"),p.setAttribute("id",r.obj_id),p.setAttribute("src","#"+r.obj_id+"_"+r.res_id),p.mp4Video=l;let g=e.arfScene.renderer.capabilities.getMaxAnisotropy();p.addEventListener("materialtextureloaded",(function(e){console.log("three.js: _loadVideo: _materialtextureloaded: videoPlane = ",p.object3D,e),e.detail.texture.anisotropy=g,e.detail.texture.needsUpdate=!0})),p.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){console.log("three.js: videoPlane.loaded: vw vh = ",u,h,t),p.object3D.children[0].scale.set(100*u*25.4/s,100*h*25.4/s,1);let m=r.quaternionRotation.split(","),f=new THREE.Quaternion(Number(m[1]),Number(m[2]),Number(m[3]),Number(m[0])),g=new THREE.Vector3;if(r.obj_parent_id){p.object3D.obj_parent_id=r.obj_parent_id,g.addScaledVector(o,2540/s);let t=g.z;g.z=-t,e.setAframeTransform(p,g,i,n,f)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),g.addScaledVector(o,2540/s);break;case"3.0.0":n.multiplyScalar(2),g.addScaledVector(o,5080/s);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let t=g.y,r=g.z;g.y=r,g.z=t,e.setAframeTransform(p,g,i,n,f),p.object3D.position.add(new THREE.Vector3(25.4*c/s/2,25.4*d/s/2,0)),p.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeVideo: loaded: no parent prs=",p.object3D.position,p.object3D.rotation,p.object3D.scale)}let b=p.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone()},r.blockly&&(b.resetProperty=function(){l.pause()}),p.object3D.makarType="video",p.object3D.makarObject=!0,r.behav&&(p.object3D.behav=r.behav,e.setObjectBehavAll(r)),r.behav_reference&&(p.object3D.behav_reference=r.behav_reference),a(p)}})),e.makarObjects.push(p),0==r.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable"));let b=!1;if(r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowVideo"==r.behav_reference[e].behav_name){b=!0,p.setAttribute("visible",!1),p.setAttribute("class","unclickable"),l.muted=!1;break}if(r.obj_parent_id){l.autoplay=!1;let t=setInterval((function(){let o=document.getElementById(r.obj_parent_id);o&&o.object3D.children.length>0&&(o.appendChild(p),window.clearInterval(t),o.addEventListener("child-attached",(function(t){if(console.log("three.js: arController: _loadVideo,: parent child-attached, el=",t),r.blockly)p.blockly=r.blockly,l.pause(),l.currentTime=0;else{let t=!0;p.object3D.traverseAncestors((function(r){"Scene"!=r.type?(console.log("three.js: arController: _loadVideo,: traverseAncestors: not Scene parent=",r),0==r.visible&&(t=!1)):1==t&&1==p.object3D.visible&&0==b?(console.log("three.js: arController: _loadVideo,: traverseAncestors: all parent visible true=",p.object3D),l.autoplay=!0,l.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==r.location)&&e.dealVideoMuted(l)):(console.log("three.js: arController: _loadVideo,: traverseAncestors: not all parent visible true=",p.object3D),l.muted=!1,l.autoplay=!1,l.pause(),l.currentTime=0)}))}})))}),1)}else r.blockly?(p.blockly=r.blockly,l.pause(),l.currentTime=0,l.muted=!1):(l.autoplay=!0,l.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&e.dealVideoMuted(l)),t.appendChild(p)}}else console.log("ARFunc.js: _loadAframeVideo , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],e.loadAframeGLTFModel(t,r,o,i,n,e.cubeTex),a(1)}))}))},this.loadYouTubeVideo=function(t,r,o,i,n,a){var s=e.gcssTargets.dpi[t.GCSSID],l=e.gcssTargets.width[t.GCSSID],c=e.gcssTargets.height[t.GCSSID];function d(e){}var u=!1;function h(e){console.log("onPlayerStateChange, event.target=",e.target),console.log("onPlayerStateChange, event.data=",e.data),e.data!=YT.PlayerState.PLAYING||u||(u=!0)}let p,m=r.indexOf("v=")+2,f=r.slice(m).indexOf("&");p=-1!=f?r.slice(m,m+f):r.slice(m),console.log("createCssYouTube ytID=",p);var g=document.createElement("div");g.setAttribute("id",p),document.body.appendChild(g);var b,_=(b={id:p,videoId:p},console.log("createPlayer playerInfo=",b),new YT.Player(b.id,{videoId:b.videoId,playerVars:{rel:1,fs:0,autoplay:0,showinfo:0,controls:1,disablekb:1,modestbranding:1,playsinline:1,enablejsapi:1},events:{onReady:d,onStateChange:h}}));console.log("0 curplayer.getIframe()=",_);var v=document.createElement("div");v.setAttribute("id","divContainer"),v.style.width=_.getIframe().width/1+"px",v.style.height=_.getIframe().height/1+"px";var y=document.createElement("div");y.setAttribute("id","divMask"),y.style.backgroundColor="rgba(0, 0, 0, 0)",y.style.zIndex=5,y.style.width=_.getIframe().width/1+"px",y.style.height=_.getIframe().height/1+"px",y.style.position="absolute",v.appendChild(y),v.appendChild(_.getIframe());var w=new THREE.CSS3DObject(v);console.log("loadYouTubeVideo: dpi=",s,", GCSSWidth=",l,", GCSSHeight=",c),console.log("loadYouTubeVideo: position=",i,", rotation=",n,", scale=",a),w.rotation.x=Math.PI/2,w.position.set(25.4*l/s/2,25.4*c/s/2,0);i.x;let E=i.y,j=i.z;i.y=j,i.z=E;var T=i.clone();T.addScaledVector(i,2540/s),w.position.add(T),w.scale.set(.2,.2,.2),w.updateMatrix(),t.add(w)},this.loadAframeText=function(t,r,o,i,n){return new Promise((function(a){let s=e.gcssTargets.dpi[t.GCSSID],l=e.gcssTargets.width[t.GCSSID],c=e.gcssTargets.height[t.GCSSID],d=(e.sceneTargetList[t.GCSSID].projIndex,document.createElement("a-entity"));d.setAttribute("id",r.obj_id),e.makarObjects.push(d),r.behav||"button"==r.main_type?d.setAttribute("class","clickable"):d.setAttribute("class","unclickable");let u=document.createElement("a-text");u.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),u.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let h=r.content.split("\n"),p=0;const m=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,f=e=>m.test(e);for(let e=0;e<h.length;e++){textLength=0;for(let t=0;t<h[e].length;t++)f(h[e][t])?textLength+=1.6:h[e][t]==h[e][t].toUpperCase()&&h[e][t]!=h[e][t].toLowerCase()||h[e][t]==h[e][t].toLowerCase()&&h[e][t]!=h[e][t].toUpperCase()?textLength+=1:isNaN(1*h[e][t])?textLength+=1.25:textLength+=1;textLength>p&&(p=textLength)}u.setAttribute("value",r.content),u.setAttribute("width",.08*p),u.setAttribute("wrap-count",p+1),u.setAttribute("anchor","center"),u.setAttribute("align","left"),u.setAttribute("backcolor",r.back_color),u.setAttribute("textcolor",r.color),u.setAttribute("side","double");var g="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/";fonts=[g+"1-msdf.json",g+"2-msdf.json",g+"3-msdf.json",g+"4-msdf.json",g+"5-msdf.json",g+"6-msdf.json",g+"7-msdf.json",g+"8-msdf.json",g+"9-msdf.json",g+"10-msdf.json",g+"11-msdf.json",g+"12-msdf.json"],u.setAttribute("font",fonts),u.setAttribute("negate","false"),u.setAttribute("crossorigin","anonymous");let b=r.color.split(","),_=new THREE.Color(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]));u.setAttribute("color","#"+_.getHexString());let v=0;if(u.addEventListener("geometry-set",(function e(t){console.log("three.js: _loadAframeText: textEntity geometry-set: evt=",t),0==v?v=1:1==v&&a(u),u.removeEventListener("geometry-set",e)})),d.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){console.log("three.js: _loadAframeText: anchor loaded: evt=",t),u.object3D.scale.set(2540/s,2540/s,2540/s);let h=r.quaternionRotation.split(","),p=new THREE.Quaternion(Number(h[1]),Number(h[2]),Number(h[3]),Number(h[0])),m=new THREE.Vector3;if(r.obj_parent_id){d.object3D.obj_parent_id=r.obj_parent_id,m.addScaledVector(o,2540/s);let t=m.z;m.z=-t,e.setAframeTransform(d,m,i,n,p)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),m.addScaledVector(o,2540/s);break;case"3.0.0":n.multiplyScalar(2),m.addScaledVector(o,5080/s);break;default:console.log("three.js: _loadAframeText: serverVersion version wrong",serverVersion)}let t=m.y,r=m.z;m.y=r,m.z=t,e.setAframeTransform(d,m,i,n,p),d.object3D.position.add(new THREE.Vector3(25.4*l/s/2,25.4*c/s/2,0)),d.object3D.rotation.x+=90*Math.PI/180,console.log(" +++++++++ set done",d.object3D.position,d.object3D.rotation,d.object3D.scale)}let f=d.object3D;f.originTransform={position:f.position.clone(),rotation:f.rotation.clone(),scale:f.scale.clone(),textContent:r.content,textColor:_,textBackColor:r.back_color},r.blockly&&(f.resetProperty=function(){u.getAttribute("value")!=r.content||u.components.text.attrValue.color!="#"+_.getHexString()||u.components.text.attrValue.backcolor!=r.back_color?(console.log("three.js: _loadAframeText: do reset"),u.components.text.textMesh.children.length=0,u.object3D.children.length=1,u.setAttribute("value",r.content),u.setAttribute("color","#"+_.getHexString()),u.setAttribute("backcolor",r.back_color)):console.log("three.js: _loadAframeText: text same, reset do nothing ")}),d.object3D.makarObject=!0,d.object3D.makarType="text",r.behav&&(d.object3D.behav=r.behav,e.setObjectBehavAll(r)),r.behav_reference&&(d.object3D.behav_reference=r.behav_reference),"button"==r.main_type&&(d.object3D.main_type=r.main_type),0==v?v=1:1==v&&a(u)}})),d.appendChild(u),0==r.active&&(d.setAttribute("visible",!1),d.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowText"==r.behav_reference[e].behav_name){d.setAttribute("visible",!1),d.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(d),window.clearInterval(e))}),1)}else t.appendChild(d)}))},this.loadAframeText2D=function(t,r,o,i,n,a,s){return console.log(" _loadAframeText2D: obj=",r),new Promise((function(n){let l,c,d,u,h,p=e.sceneTargetList[t.GCSSID].projIndex,m=e.getProjectVersion(p);if(Array.isArray(m)&&3==m.length){let e=Number(m[0]),t=Number(m[1]),o=Number(m[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=f();e.rectP&&e.rectSizeDelta&&e.rectScale?(l=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadAframeText2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadAframeText2D: rect PSO=",e,t,o,a,s),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadAframeText2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(l=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}}else{let e=f();e.rectP&&e.rectSizeDelta&&e.rectScale?(l=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}function f(){let t,o,i,n,l=e.getResolutionIndex(p),c={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){Number.isFinite(l)||(console.log(" _loadAframeText2D: _getObj2DInfo338: error, missing _selectedResolutionIndex",l),l=0);let e=r.rect_transform[l];if(e.position&&e.rotation&&e.scale){t=e.position.split(",").map((function(e){return Number(e)})),o=e.size_dalta.split(",").map((function(e){return Number(e)})),i=e.scale.split(",").map((function(e){return Number(e)})),n=e.rotation.split(",").map((function(e){return Number(e)}));let r=new THREE.Quaternion(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),l=new THREE.Euler;l.setFromQuaternion(r),a.z=l.z/Math.PI*180,s.x=i[0],s.y=i[1],c={rectP:t,rectSizeDelta:o,rectScale:i}}}return console.log(" _loadAframeText2D: _getObj2DInfo338: tempInfo",c),c}let g=e.get2DScaleRatioByProjIndex(p);u=c[0]*g,h=c[1]*g;let b=0,_=r.content.split("\n");for(let e=0;e<_.length;e++)_[e].length>b&&(b=_[e].length);let v=u/b*1,y=h/_.length*.9,w=175*g,E=Math.min(v,y,w);console.log(" _loadAframeText2D: fontSize: ",r.content,E,b,"[",v,",",u,"]",", [",y,",",h,"], ",w);let j=new THREE.Object3D;if(j.makarType="text2D",r.behav&&(j.behav=r.behav,e.setObjectBehavAll(r)),0==r.active&&(j.visible=!1),r.behav_reference){j.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowText"==r.behav_reference[e].behav_name&&(j.visible=!1)}let T=document.createElement("a-text");T.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),T.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let x=r.content.split("\n"),k=0;const A=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,S=e=>A.test(e);for(let e=0;e<x.length;e++){textLength=0;for(let t=0;t<x[e].length;t++)S(x[e][t])?textLength+=1.6:x[e][t]==x[e][t].toUpperCase()&&x[e][t]!=x[e][t].toLowerCase()||x[e][t]==x[e][t].toLowerCase()&&x[e][t]!=x[e][t].toUpperCase()?textLength+=1:isNaN(1*x[e][t])?textLength+=1.25:textLength+=1;textLength>k&&(k=textLength)}T.setAttribute("value",r.content),T.setAttribute("width",.08*k),T.setAttribute("width",u),T.setAttribute("height",h),T.setAttribute("fontsize",E),T.setAttribute("wrap-count",k),T.setAttribute("anchor","left"),T.setAttribute("align","left"),T.setAttribute("baseline","top"),T.setAttribute("textcolor",r.color),T.setAttribute("side","double");var D="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/";let R=[D+"1-msdf.json",D+"2-msdf.json",D+"3-msdf.json",D+"4-msdf.json",D+"5-msdf.json",D+"6-msdf.json",D+"7-msdf.json",D+"8-msdf.json",D+"9-msdf.json",D+"10-msdf.json",D+"11-msdf.json",D+"12-msdf.json"];T.setAttribute("font",R),T.setAttribute("negate","false"),T.setAttribute("crossorigin","anonymous");let C,M,I=r.color.split(","),P=new THREE.Color(parseFloat(I[0]),parseFloat(I[1]),parseFloat(I[2]));T.setAttribute("color","#"+P.getHexString()),document.getElementById("aTempScene")&&document.getElementById("aTempDiv")?M=document.getElementById("aTempScene"):(C=document.createElement("div"),C.style.display="none",M=document.createElement("a-scene"),M.setAttribute("id","aTempScene"),M.setAttribute("embedded",""),document.body.appendChild(C),C.appendChild(M)),M.appendChild(T),T.addEventListener("geometry-set",(function(e){let t=T.object3D;t&&(t.children[2]&&t.children[2],console.log("_loadAframeText2D: textEntity geometry-set: textObject=",t,e)),n(j)})),T.addEventListener("loaded",(function(n){let c=T.object3D;if("button"==r.main_type&&(j.main_type=r.main_type),c.rotation.x=Math.PI,c.scale.set(190,190,1),r.obj_parent_id){c.obj_parent_id=r.obj_parent_id;let t=function(){let n=!1;for(let t=0;t<e.makarObjects2D.length;t++)e.makarObjects2D[t].obj_id==r.obj_parent_id&&(n=!0);if(0==n)setTimeout(t,200);else for(let t=0;t<e.makarObjects2D.length;t++)if(e.makarObjects2D[t].obj_id==r.obj_parent_id){j.add(c),j.translateX(l[0]*g),j.translateY(-l[1]*g),j.translateZ(o/i-1),j.rotateZ(-a.z/180*Math.PI),j.scale.set(s.x,s.y,1),j.makarObject=!0,j.obj_id=r.obj_id,j.obj_parent_id=r.obj_parent_id,e.makarObjects2D[t].add(j),e.makarObjects2D.push(j);break}};t()}else j.add(c),j.translateX(l[0]*g),j.translateY(-l[1]*g),j.translateZ(o/i-1),j.rotateZ(-a.z/180*Math.PI),j.scale.set(s.x,s.y,1),j.makarObject=!0,j.obj_id=r.obj_id,e.makarObjects2D.push(j),t.add(j)}))}))},this.loadAframeAudio=function(t,r,o,i,n){return new Promise((function(a){e.UrlExistsFetch(r.res_url).then((s=>{if(1==s){let s=r.quaternionRotation.split(","),l=new THREE.Quaternion(Number(s[1]),Number(s[2]),Number(s[3]),Number(s[0])),c=document.getElementById("makarAssets"),d=document.createElement("audio");d.setAttribute("id",r.obj_id+"_"+r.res_id),d.setAttribute("src",r.res_url),d.setAttribute("crossorigin","anonymous"),d.setAttribute("loop",!0),d.setAttribute("preload","auto"),c.appendChild(d),d.onloadedmetadata=function(){let s=document.createElement("a-entity");s.setAttribute("sound","src: #"+r.obj_id+"_"+r.res_id+"; autoplay: true; loop: true; volume: 1; positional: false"),s.setAttribute("id",r.obj_id),e.setAframeTransform(s,o,i,n,l),e.makarObjects.push(s);let c=!0;0==r.active&&(s.setAttribute("sound","loop: false"),s.setAttribute("visible",!1),c=!1,s.setAttribute("class","unclickable"));let d=!1;if(r.behav_reference){for(let e=0;e<r.behav_reference.length;e++)if("PlayMusic"==r.behav_reference[e].behav_name){d=!0,s.setAttribute("sound","loop: false"),s.setAttribute("visible",!1),c=!1,s.setAttribute("class","unclickable"),s.setAttribute("sound","autoplay: false ");break}}else s.setAttribute("visible",!0);if(r.obj_parent_id){s.setAttribute("sound","autoplay: false");let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(s),window.clearInterval(e),t.addEventListener("child-attached",(function(e){if(r.blockly)s.blockly=r.blockly,s.setAttribute("sound","autoplay: false");else{let e=!0;s.object3D.traverseAncestors((function(t){if("Scene"!=t.type)console.log("three.js: arController: _loadAudio,: traverseAncestors: not Scene parent=",t),0==t.visible&&(e=!1);else if(1==e&&1==s.object3D.visible&&0==d&&1==c)if(console.log("three.js: arController: _loadAudio,: traverseAncestors: all parent visible true=",s.components.sound),1!=window.allowAudioClicked){s.setAttribute("sound","autoplay: false");let e=document.getElementById("clickToPlayAudio");e.style.display="block",e.addEventListener("click",(function t(){s.components.sound.playSound(),e.style.display="none",e.removeEventListener("click",t),window.allowAudioClicked=!0}))}else s.setAttribute("sound","autoplay: true");else console.log("2 three.js: arController: _loadAudio,: traverseAncestors: not all parent visible true=",s.components.sound),s.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(r.blockly)s.blockly=r.blockly,s.setAttribute("sound","autoplay: false");else if(console.log(" 6666666666666666 ",c,d),1==c&&0==d&&1!=window.allowAudioClicked){s.setAttribute("sound","autoplay: false");let e=document.getElementById("clickToPlayAudio");e.style.display="block",e.addEventListener("click",(function t(){s.components.sound.playSound(),e.style.display="none",e.removeEventListener("click",t),window.allowAudioClicked=!0}))}t.appendChild(s)}s.addEventListener("loaded",(function(t){t.target==t.currentTarget&&(s.object3D.makarType="audio",s.object3D.makarObject=!0,r.behav&&(s.object3D.behav=r.behav,e.setObjectBehavAll(r)),r.behav_reference&&(s.object3D.behav_reference=r.behav_reference),a(s))}))}}else console.log("ARFunc.js: _loadAframeAudio , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],e.loadAframeGLTFModel(t,r,o,i,n,e.cubeTex),a(1)})).catch((function(e){console.log("_loadAframeAudio: error ",e)}))}))},this.loadAframeLight=function(t,r,o,i,n){return new Promise((function(a){let s=e.gcssTargets.dpi[t.GCSSID],l=e.gcssTargets.width[t.GCSSID],c=e.gcssTargets.height[t.GCSSID],d=(e.sceneTargetList[t.GCSSID].projIndex,document.createElement("a-entity"));d.setAttribute("id",r.obj_id),attr="type:"+r.light.light_type;let u=r.light.color.split(","),h=new THREE.Color(parseFloat(u[0]),parseFloat(u[1]),parseFloat(u[2]));attr+="; color:#"+h.getHexString(),attr+=";intensity:"+r.light.intensity,"point"!=r.light.light_type&&"spot"!=r.light.light_type||(attr+=";distance:"+2*r.light.range*100*25.4/s,attr+=";decay: 2"),"spot"==r.light.light_type&&(attr+=";angle:"+(parseFloat(r.light.spotAngle)/2).toString(),attr+=";penumbra: 0.2"),r.light.shadow,d.setAttribute("light",attr),"directional"==r.light.light_type&&(d.setAttribute("castShadow",!1),d.setAttribute("light","castShadow: false; ")),0==r.active&&d.setAttribute("visible",!1);let p=r.quaternionRotation.split(","),m=new THREE.Quaternion(Number(p[1]),Number(p[2]),Number(p[3]),Number(p[0]));if(d.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){if("directional"==r.light.light_type){d.object3D.children[0].position.set(0,0,0);let e=new THREE.Object3D;e.position.set(0,0,-1),d.object3D.children[0].target=e,d.object3D.add(e)}let t=new THREE.Vector3;if(r.obj_parent_id){d.object3D.obj_parent_id=r.obj_parent_id,t.addScaledVector(o,2540/s);let a=t.z;t.z=-a,e.setAframeTransform(d,t,i,n,m)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),t.addScaledVector(o,2540/s);break;case"3.0.0":n.multiplyScalar(2),t.addScaledVector(o,5080/s);break;default:console.log("three.js: _loadAframeLight: serverVersion version wrong",serverVersion)}let r=t.y,a=t.z;t.y=a,t.z=r,e.setAframeTransform(d,t,i,n,m),d.object3D.position.add(new THREE.Vector3(25.4*l/s/2,25.4*c/s/2,0)),d.object3D.rotation.x+=90*Math.PI/180}let u=d.object3D;u.originTransform={position:u.position.clone(),rotation:u.rotation.clone(),scale:u.scale.clone()},r.blockly&&(u.resetProperty=function(){u.children[0].intensity=r.light.intensity,u.children[0].color.copy(h)}),d.object3D.makarType="light",d.object3D.makarObject=!0,e.makarObjects.push(d),a(d)}})),r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(d),window.clearInterval(e))}),1)}else console.log("three.js: _loadAframeLight: loaded: no parent prs=",d.object3D.position,d.object3D.rotation,d.object3D.scale),t.appendChild(d)}))},this.showAframeObjectEvent=function(t,r){let o=t.obj_id,i=document.getElementById(o);if(i)if(i.getAttribute("visible")){if(i.setAttribute("visible",!1),i.setAttribute("class","unclickable"),"a-video"==i.localName){let e=i.getAttribute("src");if(null!=e){e=e.split("#").pop();let t=document.getElementById(e);t instanceof HTMLElement&&t.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||e.UnMutedAndPlayAllVisibleVideo()),i.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("three.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")&&i.object3D!=e)if(e.el.blockly)console.log("three.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})),r&&i.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}else{if(window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||e.UnMutedAndPlayAllVisibleVideo(i)),i.setAttribute("visible",!0),"a-video"==i.localName){let e=i.getAttribute("src");if(null!=e){e=e.split("#").pop();let t=document.getElementById(e);t instanceof HTMLElement&&(t.play(),window.allowAudioClicked=!0)}}i.object3D.behav&&i.setAttribute("class","clickable"),i.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("three.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&i.object3D!=e&&(e.el.blockly?console.log("three.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}else console.log("three.js: _showAframeObjectEvent: target not exist",t)},this.hideAframeGroupObjectEvent=function(e){e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})))},this.checkARSceneResultBehav=function(e){if(!Number.isFinite(Number(e)))return void console.error(" _checkARSceneResultBehav: projectIdx error ",e);if(!Array.isArray(sceneResult)||!sceneResult[e])return void console.error(" _checkARSceneResultBehav: _VRSceneResult error ",e,sceneResult);if(!sceneResult[e].data.editor_ver||"string"!=typeof sceneResult[e].data.editor_ver)return void console.error(" _checkARSceneResultBehav: editor_ver error ",sceneResult[e]);let t=sceneResult[e].data.editor_ver.split(".");console.log("_checkARSceneResultBehav: _projectIdx ",e,t);let r=this.editorVersionControllObjs(e);if(console.log("_checkARSceneResultBehav: _scene_objs ",r),!Array.isArray(r))return;let o={},i={};for(let e=0,t=r.length;e<t;e++){let t=r[e];t.behav&&(o[t.obj_id]=t.behav),t.behav_reference&&delete t.behav_reference,t.obj_id&&(i[t.obj_id]=t)}for(let e in o){let t=o[e];for(let e=0,r=t.length;e<r;e++){let r=t[e];if(r.simple_behav,r.obj_id){let e=i[r.obj_id];e&&Array.isArray(e.behav_reference)?e.behav_reference.push({behav_name:r.simple_behav,target_id:r.obj_id}):e?e.behav_reference=[{behav_name:r.simple_behav,target_id:r.obj_id}]:console.error("_checkARSceneResultBehav: cant get _behavObj ",r)}}}},this.setupSceneBehav=function(e){let t=this;for(let e=0,r=t.makarObjects.length;e<r;e++){let r=t.makarObjects[e].object3D;r?(r.behav,r.behav_reference):console.error(" _setupSceneBehav: 3d obj error",e,t.makarObjects[e])}let r=t.lookAtTargetDict[e];if(Array.isArray(r))for(let o=0,i=r.length;o<i;o++){let i=r[o],n=i.lookObjId,a=document.getElementById(n),s=i.lookBehav,l=s.obj_id,c=(s.reverse,document.getElementById(l));a&&a.object3D&&c&&c.object3D?t.addLookAtTimeLine(a,c,i,e):console.log("_setupSceneBehav: _lookAt error, obj not exist",a,c)}},this.addLookAtTimeLine=function(e,t,r,o){console.log(" _addLookAtTimeLine: ",r);let i=this.lookAtTargetTimelineDict[o],n=new THREE.Vector3;t.object3D.getWorldPosition(n);let a=gsap.timeline();i[r.lookObjId]=a,a.to(e.object3D,{duration:1100,delay:0,ease:"none",repeat:-1,onUpdate:function(){t.object3D.getWorldPosition(n),e.object3D.lookAt(n),r.lookBehav&&0==r.lookBehav.reverse&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}})},this.setObjectBehavAll=function(e,t){let r=this.groupEventTargetDict[t],o=this.lookAtTargetDict[t];console.log(" _setObjectBehavAll: ",t);for(let t=0,i=e.behav.length;t<i;t++){if(""!=e.behav[t].group&&r[e.behav[t].group]){r[e.behav[t].group].objs.push({behav:e.behav[t]})}if("LookAt"==e.behav[t].simple_behav&&e.behav[t].obj_id){let r={lookBehav:e.behav[t],lookObjId:e.obj_id};o.push(r)}}},this.dealAllGroupHide=function(e,t){let r=this,o=r.groupEventTargetDict[t];if(!o)return void console.log("_dealAllGroup: missing groupDict");let i=["ShowImage2D","ShowImage","ShowText2D","ShowText","ShowModel","PlayMusic","ShowVideo"];for(let t=0;t<e.behav.length;t++){let n=e.behav[t];if(""!=n.group&&o[n.group]){o[n.group].objs.forEach(((e,t)=>{let o=e.behav.obj_id,a=r.getObjectTypeByObj_id(o);if("2d"==a.obj_type){let e=a.obj;if(n.obj_id!=o&&e.behav_reference)for(let t=0;t<e.behav_reference.length;t++)if(i.filter((r=>r==e.behav_reference[t].behav_name)).length>0){e.visible=!1;break}}else if("3d"==a.obj_type){let e=a.obj;if(e.object3D.behav_reference&&Array.isArray(e.object3D.behav_reference)&&n.obj_id!=o)for(let t=0;t<e.object3D.behav_reference.length;t++)if(i.filter((r=>r==e.object3D.behav_reference[t].behav_name)).length>0){r.hideAframeGroupObjectEvent(e);break}}}))}}},this.speechTextObj=function(e){if(console.log(" _speechTextObj: _textObj: ",e),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){1==speechSynthesis.speaking&&(speechSynthesis.pause(),speechSynthesis.cancel());let t=e.speed,r=e.language,o=e.content,i=new SpeechSynthesisUtterance(o);i.rate=t**3*.1837+t**2*-.9948+2.3352*t-.5196,i.pitch=1;let n="en",a="en-US";switch(r){case 0:n="en",a="en-US";break;case 1:n="zh-TW",a="zh-TW";break;case 2:n="zh-CN",a="zh-CN";break;case 3:n="ja",a="ja-JP";break;case 4:n="ko",a="ko-KR";break;default:n="en",a="en-US"}let s=setInterval((function(){let e=!1,t=speechSynthesis.getVoices();t.length>0&&(clearInterval(s),window.Browser&&"safari"!=window.Browser.name&&t.forEach((t=>{t.lang==a&&(e=!0,i.voice=t)})),0==e&&(i.lang=n),speechSynthesis.speak(i))}),1)}},this.dealVideoMuted=function(t){let r=document.getElementById("clickToPlayAudio");r.style.display="block",r.onclick=function(){e.UnMutedAndPlayAllVisibleVideo(),window.allowAudioClicked=!0,r.style.display="none",r.onclick=null,window.alreadyClicked=!0}},this.UnMutedAndPlayAllVisibleVideo=function(e){let t;e&&"a-video"==e.localName&&(t=e);let r=document.getElementsByTagName("a-video");if(console.log("three.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length),t)for(let e=0;e<r.length;e++){let o=r[e],i=r[e].mp4Video;if(o==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play();else{let r=!0;o.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("three.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,o.object3D.visible,o),1==r&&1==o.object3D.visible&&(i.muted=!0,i.autoplay=!0,i.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else{let e=!1;for(let t=0;t<r.length;t++){let o=r[t],i=r[t].mp4Video,n=!0;o.object3D.traverseAncestors((function(r){"Scene"!=r.type?0==r.visible&&(n=!1):(console.log("three.js: _UnMutedAndPlayAllVideo: videoPlane =",t,n,o.object3D.visible,o),1!=n||1!=o.object3D.visible||o.blockly||(0==e?(console.log("three.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",o.object3D),i.muted=!1,i.autoplay=!0,i.play(),e=!0):(console.log("three.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",o.object3D),i.muted=!0,i.autoplay=!0,i.play())))}))}}},this.entitySetTransform=function(e,t,r,o){let i=t.clone();i.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",i);let n=r.clone();n.multiply(new THREE.Vector3(1,-1,-1)),e.setAttribute("rotation",n),e.setAttribute("scale",o)},this.setTransform=function(e,t,r,i,n){if(e&&t&&r&&i&&n&&!(e.isObject3D&&r.isVector3&&i.isVector3&&n.isVector3))return console.warn("_setTransform warning, some parameter are not right"),-1;var a=r.clone();switch(window.serverVersion){case"2.0.0":a.addScaledVector(r,2540/t);break;case"3.0.0":a.addScaledVector(r,5080/t);break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}switch(e.position.add(a),o(e,new THREE.Vector3(1,0,0),-i.x*Math.PI/180),o(e,new THREE.Vector3(0,0,1),-i.y*Math.PI/180),e.rotateZ(i.z*Math.PI/180),window.serverVersion){case"2.0.0":e.scale.copy(n.multiplyScalar(1));break;case"3.0.0":e.scale.copy(n.multiplyScalar(2));break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}},this.setAframeTransform=function(e,t,r,o,i,n){e.setAttribute("position",t);let a=e.object3D,s=new THREE.Euler;s.setFromQuaternion(i),s.x=-s.x,s.y=-s.y;let l=new THREE.Quaternion;l.setFromEuler(s),a.setRotationFromQuaternion(l),e.setAttribute("scale",o)},this.setChildTransform=function(e,t,r,o,i,n){let a=r.z;r.z=-a;let s=o.x,l=o.y;o.x=-s,o.y=-l,e.position.add(r.multiplyScalar(2540/t));let c=new THREE.Euler;c.setFromQuaternion(n),c.x=-c.x,c.y=-c.y;let d=new THREE.Quaternion;d.setFromEuler(c),e.setRotationFromQuaternion(d),e.scale.copy(i)},this.getMakarObject=function(t){return 1!=t.makarObject?t.parent?e.getMakarObject(t.parent):0:t},this.getObjectTypeByObj_id=function(e){let t=this,r=null,o=null,i=null,n=null,a={obj_type:"",obj_index:null,obj:null};return e&&(t.makarObjects.forEach(((t,i)=>{t.id==e&&(r=t,o=i)})),t.makarObjects2D.forEach(((t,r)=>{t.obj_id==e&&(i=t,n=r)})),null!=r&&null!=o||null!=i&&null!=n?null!=r&&null!=o?(console.log("_getObjectTypeByObj_id: 3d: ",o,r),a.obj_type="3d",a.obj_index=o,a.obj=r):null!=i&&null!=n?(console.log("_getObjectTypeByObj_id: 2d: ",n,i),a.obj_type="2d",a.obj_index=n,a.obj=i):console.log("_getObjectTypeByObj_id: fucking logic trouble.",n,i):null!=r&&null!=o&&null!=i&&null!=n&&(console.log("_getObjectTypeByObj_id: warning, both 2D/3D object get",e,", 3d:",o,r,", 2d:",n,i),a.obj_type="3d",a.obj_index=o,a.obj=r)),a},this.triggerEvent=function(t,r,o){let i,n;switch(t.simple_behav){case"Click3dToPhoneCall":case"PhoneCall":if(console.log("Click3dToPhoneCall: phone=",t.phone),window.Browser)if(window.Browser.desktop){let e=window.document.getElementById("phoneCall");e.href="tel:"+t.phone,console.log("desktop telTag=",e),e.click()}else{let e=window.document.getElementById("phoneCall");e.href="tel:"+t.phone,console.log("cell phone telTag=",e),e.click()}break;case"Click3dToSendEmail":case"SendEmail":if(console.log("Click3dToSendEmail: mail=",t.mail_to),window.Browser)if(window.Browser.desktop){let e=window.document.getElementById("sendEmail");e.href="mailto:"+t.mail_to,e.click(),console.log("desktop: webTag=",e)}else{let e=window.document.getElementById("sendEmail");e.href="mailto:"+t.mail_to,e.click(),console.log("cellphone: webTag=",e)}break;case"Click3dToOpenWebBrowser":case"OpenWebPage":if(console.log("Click3dToOpenWebBrowser: url=",t.url),window.Browser)if(window.Browser.desktop){let e=window.document.getElementById("openWebBrowser");e.href=t.url,e.click(),console.log("desktop: webTag=",e)}else{let e=window.document.getElementById("openWebBrowser");e.href=t.url,e.click(),console.log("mobile: webTag=",e)}break;case"Coloring":console.log("triggerEvent: Coloring: event=",t),1==t.enable&&window.FuncColoring();break;case"SnapShot":let h=[];for(var a=0;a<e.arScene.scene2D.children.length;a++)e.arScene.scene2D.children[a].GCSSID<0&&1==e.arScene.scene2D.children[a].visible&&(h.push(a),e.arScene.scene2D.children[a].visible=!1);console.log("------------ self",e,this),e.GLRenderer.autoClear=!1,e.GLRenderer.render(e.arScene.videoScene,e.arScene.videoCamera),e.GLRenderer.clearDepth(),e.GLRenderer.render(e.arfScene.object3D,e.camera),e.GLRenderer.render(e.arScene.scene2D,e.arScene.camera2D);for(a=0;a<h.length;a++)e.arScene.scene2D.children[h[a]].visible=!0;e.GLRenderer.getSize();var s,l=e.GLRenderer.domElement.toDataURL("image/png",1),c=window.open(""),d=new Image;d.src=l,d.style.position="absolute",d.style.left="10%",d.style.width="80%",s=window.Browser?"safari"==window.Browser.name&&"iphone"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來儲存您的照片。 </p>':"chrome"==window.Browser.name&&"android"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來下載或分享您的照片。 </p>':"mozilla"==window.Browser.name&&"android"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來儲存您的照片。 </p>':'<br>  <p style="font-size:36px;"> 請輕觸影像來下載您的照片. </p>':"<br>  <p>Now we can only add context beside the image, because the length of img tag too long </p> <p> 請輕觸影像來下載您的照片.. </p>",c.document.write(s+d.outerHTML);break;case"exchangeCamera":localStorage.setItem("doExchangeCamera",1),console.log(" trigger exchange camera "),window.location.reload();break;case"runAnimation2D":this.runAnimation2D(r,t);break;case"touchPlayAnimation":console.log("three.js: trigger: touchPlayAnimation, event=",t,r),r.animationSlices&&r.animationSlices[0]&&r.animationSlices[0].index&&r.animationSlices.length>t.index&&(r.animationSlices[0].index=t.index),r.playAnimation=!0;break;case"ShowImage":e.showAframeObjectEvent(t,o);break;case"ShowImage2D":for(let r=0;r<e.makarObjects2D.length;r++)e.makarObjects2D[r].obj_id==t.obj_id&&(1==e.makarObjects2D[r].visible?e.makarObjects2D[r].visible=!1:e.makarObjects2D[r].visible=!0);break;case"ShowText2D":for(let r=0;r<e.makarObjects2D.length;r++)e.makarObjects2D[r].obj_id==t.obj_id&&(1==e.makarObjects2D[r].visible?e.makarObjects2D[r].visible=!1:e.makarObjects2D[r].visible=!0);break;case"ShowModel":case"ShowVideo":case"ShowText":e.showAframeObjectEvent(t,o);break;case"PlayAnimation":if(console.log("three.js: trigger: PlayAnimation, event=",t,", makarObj=",r),console.log("three.js: triggerEvent: _PlayAnimation: event=",t),i=t.obj_id,n=document.getElementById(i),!n){console.log("three.js: _PlayAnimation: target not exist",n);break}var u;for(let e=1;e<n.object3D.children[0].animationSlices.length;e++)n.object3D.children[0].animationSlices[e].uid==t.uid&&(u=n.object3D.children[0].animationSlices[e].animationName);n.setAttribute("animation-mixer","clip: "+u),t.loop?(n.object3D.children[0].animationSlices[0].loop=t.uid,n.object3D.children[0].animationSlices[0].uid=t.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=!0):(n.object3D.children[0].animationSlices[0].uid=t.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=t.reset);break;case"PlayMusic":if(i=t.obj_id,n=document.getElementById(i),!n){console.log("three.js: _PlayMusic: target not exist",n);break}console.log("three.js: triggerEvent: _PlayMusic: event=",t),e.showAframeObjectEvent(t,o),n.object3D.children[0]&&n.object3D.children[0].children[0]&&"Audio"==n.object3D.children[0].children[0].type&&(1==n.object3D.children[0].children[0].isPlaying?n.components.sound.stopSound():n.components.sound.playSound());break;case"ReadText":if(console.log("three.js: _ReadText: ",t),t.obj_id){let r=t.obj_id,o=e.currentProjectIndex;sceneResult[o].data.scene_objs_v2.objs,sceneResult&&sceneResult[o]&&sceneResult[o].data&&sceneResult[o].data.scene_objs_v2&&sceneResult[o].data.scene_objs_v2.objs&&Array.isArray(sceneResult[o].data.scene_objs_v2.objs)&&sceneResult[o].data.scene_objs_v2.objs.forEach((t=>{t.obj_id==r&&e.speechTextObj(t)}))}break;case"FingerGesture":break;default:console.log("three.js: trigger: default, event=",t,", makarObj=",r)}},this.setViewMode=function(e=""){let t=this,r=t.aCamera,o=document.getElementById("oCamera");return new Promise((function(i){if(r&&o)if("AR"==e){t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,i("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: AR err=",e)}))}else if("model"==e){t.camera=o.object3D.children[0],t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,i("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _model err=",e)}))}else if(t.camera==r){t.camera=o.object3D.children[0],t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,i("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch model err=",e)}))}else{t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,i("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch AR err=",e)}))}}))},this.setViewModeSceneObj=function(e){let t=this;return new Promise((function(r,o){let i=0;parent.selectedProject&&parent.selectedProject.proj_id&&publishARProjs.result.forEach(((e,t)=>{e.proj_id==parent.selectedProject.proj_id&&(i=t,console.log(" _setViewModeSceneObj: get id ",t,e))}));let n=0;for(let e=0,r=t.sceneTargetList.length;e<r;e++)publishARProjs.result[i].target_ids.includes(t.sceneTargetList[e].target_id)&&(n=e);console.log(" _setViewModeSceneObj: sceneNo , targetIndex",i,n),null==t.currentProjectIndex?t.currentProjectIndex=i:i=t.currentProjectIndex;let a=publishARProjs.proj_list[i].proj_descr.indexOf("_coloring");a>0&&(a=!0);let s=t.aframeNFTMarkers[i],l=t.threeNFTMarkers2D[i];for(let e in t.aframeNFTMarkers)t.aframeNFTMarkers[e].object3D.visible=!1,t.aframeNFTMarkers[e].setAttribute("visible",!1);for(let e in t.threeNFTMarkers2D)t.threeNFTMarkers2D[e].visible=!1;if("AR"==e)if(1==s.loadedObjects||1==l.loadedObjects)if(l.visible=!1,s.setAttribute("visible",!1),s.object3D.visible=!1,null!=s.coloringStatus&&1==a)if(-1==s.coloringStatus||0==s.coloringStatus){for(console.log(" _setViewModeSceneObj: model: _coloring module ",s.coloringStatus),s.loadModel=!1;s.children.length>0;)s.children[0].remove();for(;l.children.length>0;)l.remove(l.children[0]);let e=t.loadMakarScene(n,s,l);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(i),r(!0)}))}else 1==s.coloringStatus&&(console.log(" _setViewModeSceneObj: model: color 1"),r(!0));else console.log(" _setViewModeSceneObj: AR: not _coloring module "),r(!0);else r(!0);else if("model"==e){if(1!=s.loadedObjects||1!=l.loadedObjects){if(s.loadedObjects=l.loadedObjects=!0,1==a)s.loadModel=!0,s.coloringStatus=0,(c=t.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",c.fillRect(0,0,t.targetCanvas.width,t.targetCanvas.height);let e=t.loadMakarScene(n,s,l);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(i),r(!0)}))}else if(t.logicList[t.currentProjectIndex]&&0==t.logicList[t.currentProjectIndex].logicSystemState&&t.logicList[t.currentProjectIndex].parseXML(),s.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),null!=s.coloringStatus&&1==a)if(-1==s.coloringStatus){var c;for(console.log(" _setViewModeSceneObj: model: _coloring module ",s.coloringStatus),s.loadModel=!0,s.coloringStatus=0,(c=t.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",c.fillRect(0,0,t.targetCanvas.width,t.targetCanvas.height);s.children.length>0;)s.children[0].remove();for(;l.children.length>0;)l.remove(l.children[0]);let e=t.loadMakarScene(n,s,l);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(i),r(!0)}))}else console.log(" _setViewModeSceneObj: model: _coloring module ",s.coloringStatus),r(!0);else console.log(" _setViewModeSceneObj: model: not _coloring module "),r(!0);l.visible=!0;let e=t.gcssTargets.dpi[s.GCSSID],o=t.gcssTargets.width[s.GCSSID],d=t.gcssTargets.height[s.GCSSID];s.setAttribute("visible",!0),s.object3D.visible=!0,s.object3D.matrixAutoUpdate=!0,s.object3D.position.set(0,0,0),s.object3D.position.add(new THREE.Vector3(25.4*-o/e/2,25.4*-d/e/2,0)),s.object3D.rotation.x=-90*Math.PI/180,s.object3D.updateMatrix(),s.object3D.updateMatrixWorld()}else console.log(" _setViewModeSceneObj: error",e),o(e)}))},this.getSnapShot=function(){let e=this;return new Promise((function(t){if(!(e&&e.GLRenderer&&e.arScene&&e.arScene.videoScene&&e.arScene.videoCamera&&e.arScene.glScene&&e.arScene.camera&&e.arScene.scene2D&&e.arScene.camera2D&&e.GLRenderer.domElement&&e.GLRenderer.domElement.clientWidth&&e.GLRenderer.domElement.clientHeight&&e.GLRenderer.domElement.width&&e.GLRenderer.domElement.height))return console.log(" _XRController: _getSnapShot: something error ",e),void t(-1);let r=[];for(var o=0;o<e.arScene.scene2D.children.length;o++)e.arScene.scene2D.children[o].GCSSID<0&&1==e.arScene.scene2D.children[o].visible&&(r.push(o),e.arScene.scene2D.children[o].visible=!1);e.GLRenderer.autoClear=!1,e.GLRenderer.render(e.arScene.videoScene,e.arScene.videoCamera),e.GLRenderer.clearDepth(),e.GLRenderer.render(e.arfScene.object3D,e.camera),e.GLRenderer.render(e.arScene.scene2D,e.arScene.camera2D);for(o=0;o<r.length;o++)e.arScene.scene2D.children[r[o]].visible=!0;t(e.GLRenderer.domElement.toDataURL("image/png",1))}))},this.checkFBXApplication=function(e,t){if(e["LastSaved|ApplicationName"])switch(e["LastSaved|ApplicationName"].value){case"3ds Max":e.OriginalUnitScaleFactor?(console.log("LastSaved|ApplicationName = 3d Max, OriginalUnitScaleFactor exist scale*",e.OriginalUnitScaleFactor),t.multiplyScalar(e.OriginalUnitScaleFactor)):(console.log("LastSaved|ApplicationName = 3d Max, OriginalUnitScaleFactor not exist scale*100 "),t.multiplyScalar(100));break;case"Maya":e.OriginalUnitScaleFactor?(console.log("LastSaved|ApplicationName = Maya, OriginalUnitScaleFactor exist scale*",e.OriginalUnitScaleFactor),t.multiplyScalar(e.OriginalUnitScaleFactor)):console.log("LastSaved|ApplicationName = Maya, OriginalUnitScaleFactor not exist do nothong");break;default:console.log("not 3ds Max and Maya, LastSaved|ApplicationName = ",e["LastSaved|ApplicationName"])}else console.log("three.js: checkFBXApplication: object not include LastSaved|ApplicationName ")},this.runAnimation2D=function(e,t){if(!e||!t.dt)return console.warn("three.js: _runAnimation2D warning, obj is null "),-1;if(!e.isObject3D)return console.warn("three.js: _runAnimation2D warning, obj is not THREE.Object3D "),-1;if(t.dp&&t.dp.isVector3){var r=t.dp.clone().normalize(),o=t.dp.length(),i=null,n=null,a=null,s=null,l=function(c){i||(i=c),s=a?c-a:0,a=c,(n=c-i)<t.dt&&(e.translateOnAxis(r,o*(s/t.dt)),requestAnimationFrame(l))};requestAnimationFrame(l)}if(t.ds&&t.ds.isVector3){t.ds.x<0||t.ds.y<0||t.ds.z;t.ds.clone().normalize(),t.ds.length();let r=e.scale.clone(),o=t.ds,l=e.scale.clone().multiply(o),d=l.clone().sub(r),u=(new THREE.Vector3(1,1,1).divide(o),l.clone()),h=r.clone().clone().sub(u);i=null,n=null,a=null,s=null;var c=function(o){i||(i=o),s=a?o-a:0,a=o,(n=o-i)<t.dt?(e.scale.copy(r.clone().add(d.clone().multiplyScalar(n/t.dt))),requestAnimationFrame(c)):t.reverse?n<2*t.dt?(e.scale.copy(u.clone().add(h.clone().multiplyScalar((n-t.dt)/t.dt))),requestAnimationFrame(c)):(e.scale.copy(r),console.log("three.js: _runAnimation2D: ds reverse end ",e.scale)):(e.scale.copy(l),console.log("three.js: _runAnimation2D: ds end , not reverse ",e.scale))};requestAnimationFrame(c)}if(t.dopacity&&e.material&&e.material.opacity){console.log("0 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity);var d=e.material.opacity,u=d-t.dopacity,h=(i=null,n=null,function(r){i||(i=r),(n=r-i)<t.dt?(e.material.opacity=d-u*(n/t.dt),requestAnimationFrame(h)):console.log("1 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity)});requestAnimationFrame(h)}},this.switchCamera=function(t){let r=t||{facing:"environment"},o=localStorage.getItem("cameraFacing");null==o?localStorage.setItem("cameraFacing","environment"):"environment"==o?(r.facing="user",localStorage.setItem("cameraFacing","user")):"user"==o&&(r.facing="environment",localStorage.setItem("cameraFacing","environment")),e.arScene.video.srcObject.getTracks().forEach((e=>{e.stop()}));let i=function(t){if(console.log("three.js: _startWebCam: videoSuccess: stream=",t),window.videoStream=t,e.videoStreamPlane.material.map.image){let r=e.videoStreamPlane.material.map.image;r.srcObject=t,r.playsInline=!0,r.onloadedmetadata=function(){e.videoCamera?console.log("three.js: _startWebCam: videoCamera exist, donothing "):console.log("three.js: _startWebCam: videoCamera not exist, start video "),function e(){r.videoWidth>200||r.videoHeight>200?(r.play(),console.log("three.js: _switchCamera: video play  ")):setTimeout(e,100)}()},e.streamVideo=r}},n=function(e){console.log("three.js: _switchCamera: onError e = ",e)};navigator.mediaDevices.enumerateDevices().then((function(e){let t,o,a,s=!1;e=e.filter((function(e){return"videoinput"===e.kind})),o="environment"==r.facing?"back":"user"==r.facing?"front":"back";for(let r in e)-1!=e[r].label.toLowerCase().search(o)&&(t=e[r].deviceId,s=!0);if(s)console.log("three.js: _useDeviceID true, cameraID=",t),a={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},deviceId:{exact:t}}};else{let e;r.facing?(e=r.facing,console.log("three.js: _configuration.facing do exist: set facing = ",e),a={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:e}}):(console.log("api.js: _configuration.facing dosent exist: set facing = environment"),a={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:"environment"}})}navigator.mediaDevices.getUserMedia(a).then(i,n)}))},this.parseLogicXML=function(e,t){let r;if(publishARProjs.result[e].xml_urls&&publishARProjs.result[e].xml_urls[t]){let o=publishARProjs.result[e].xml_urls[t];console.log("three.js: _parseLogicXML: xmlURL = ",o);let i=new Logic;r=i.loadXMLtoDoc(o),arController.logicList[e]=i}return r}}function r(e){return Math.floor(Math.random()*Math.floor(e))}function o(e,t,r){let o;o=new THREE.Matrix4,o.makeRotationAxis(t.normalize(),r),o.multiply(e.matrix),e.matrix=o,e.rotation.setFromRotationMatrix(e.matrix)}};var e=document.createEvent("HTMLEvents");e.initEvent("integrated",!0,!0),e.eventType="message",document.dispatchEvent(e)};function t(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=r.length,i=0;i<e;i++)t+=r.charAt(Math.floor(Math.random()*o));return t}window.FuncColoring=function(){window.proxy?(console.log("three.js: proxy is created"),proxy.getFrameTarget()):console.log("three.js: proxy is not created, please StartAR first")};var r=window.leavedSendLog=function(e){if(!window.proxy||!window.publishARProjs)return;if(!proxy.arController)return;if(!proxy.arController.userStartTime)return;if(!proxy.arController.projStartTimeList)return;let r;localStorage.getItem("device_id")&&localStorage.getItem("device_id")>=24?r=localStorage.getItem("device_id"):(r=(new Date).getTime()+"_"+t(10),localStorage.setItem("device_id",r));let o=(new Date).getTime(),i={brand:Browser.name+Browser.version,os:Browser.platform,device_id:r,client:"viewer",user_id:publishARProjs.user_id,proj_id:"",proj_type:"ar",duration_time:0,explore_time:0,play_time:0,location_long:0,location_lan:0};console.log("three.js: window refresh ",proxy.arController.userStartTime,proxy.arController.projStartTimeList);let n=[];for(let e=0;e<proxy.arController.projStartTimeList.length;e++){let t=proxy.arController.projStartTimeList[e],r=proxy.arController.projStartTimeList[e+1];i.proj_id=publishARProjs.proj_list[t.projIndex].proj_id,0==e?r?(i.duration_time=(r.time-proxy.arController.userStartTime)/1e3,i.play_time=(r.time-t.time)/1e3,i.explore_time=(t.time-proxy.arController.userStartTime)/1e3):(i.duration_time=(o-proxy.arController.userStartTime)/1e3,i.play_time=(o-t.time)/1e3,i.explore_time=(t.time-proxy.arController.userStartTime)/1e3):r?(i.duration_time=(r.time-t.time)/1e3,i.play_time=(r.time-t.time)/1e3,i.explore_time=0):(i.duration_time=(o-t.time)/1e3,i.play_time=(o-t.time)/1e3,i.explore_time=0),console.log("three.js: project["+e+"] playing time = ",i.duration_time,i.play_time,i.explore_time),n.push(i)}localStorage.setItem("savedProjLogs",JSON.stringify(n))};function o(){if(window.ARController&&ARController.getUserMediaThreeScene&&window.ARThreeOnLoad)if("undefined"!=typeof sceneResult)console.log("three.js: the sceneResult is exist, do ARThreeOnLoad user_id=",sceneResult.user_id),window.ARThreeOnLoad(),window.allowedMakarIDUseWeb;else{var e=localStorage.getItem("makarID");console.log("three.js: the sceneResult isnt exist, do _getARSceneByUserID then call tick_ARThreeOnLoad again, LSmakarID=",e),window.serverUrl&&e?getARSceneByUserID(window.serverUrl,e,(function(e){e.name&&(str=e.name),"string"==typeof e?(str=e,document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="block",document.getElementById("pUserInfo").innerHTML=str,leaveIframe.onclick=function(e){e.preventDefault(),parent.aUI})):(document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="none"),o())})):console.log("three.js: fail, the LSmakarID=",e,", serverURL=",serverUrl)}else console.log("three.js: tick_ARThreeOnLoad: tick again, absence ARC && gMT && ART"),setTimeout(o,500)}window.onbeforeunload=r,window.ARThreeOnLoad=function(){var e=localStorage.getItem("cameraFacing");console.log("three.js: ARThreeOnLoad start, facing=",e),parent&&parent.fullScreenIcon&&parent.fullScreenIcon.style&&(parent.fullScreenIcon.style.display="none"),new Promise((function(e){let t=document.createElement("div");t.style.position="absolute",t.setAttribute("id","arDiv"),t.style.top="0px",t.style.width=document.documentElement.clientWidth+"px",t.style.height=Math.round(document.documentElement.clientHeight-0)+"px",document.body.appendChild(t);let r=document.createElement("a-scene");r.setAttribute("id","arfScene"),r.setAttribute("embedded",""),r.setAttribute("renderer","logarithmicDepthBuffer: true; physicallyCorrectLights: false; "),r.setAttribute("vr-mode-ui","enabled: false"),t.appendChild(r);let o=document.createElement("a-light");o.setAttribute("id","ambientLight"),o.setAttribute("type","ambient"),o.setAttribute("color","#808080"),o.setAttribute("ground-color","#fff"),o.setAttribute("intensity",1),r.appendChild(o);let i=document.createElement("a-entity");i.setAttribute("id","oCamera"),i.setAttribute("crossorigin","anonymous"),i.setAttribute("camera",{active:!0,fov:80}),i.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\tmaxPolarAngle: 180; \n\t\t\tminDistance: 0.1; \n\t\t\tmaxDistance: 1000; \n\t\t\tinitialPosition: 0 60 -300;"),r.appendChild(i),r.hasLoaded?e():r.addEventListener("loaded",(function(){e()}))})).then((function(){ARController.getUserMediaThreeScene({maxARVideoSize:640,cameraParam:"../camera_para_640_480_fei.dat",facing:e,onSuccess:function(e,t,r){var o=new ARProxy(t,"../camera_para_640_480_fei.dat",(function(){}));window.proxy=o,localStorage.setItem("doExchangeCamera",0);let i=document.getElementById("arfScene"),n=i.renderer,a=i.canvas;t.arfScene=i,t.loadAssets();let s=n;if(a.style.position="relative",s.outputEncoding=THREE.GammaEncoding,s.gammaFactor=1,s.sortObjects=!0,t.GLRenderer=s,t.arScene=e,t.ARSceneResult=sceneResult,window.arController=t,"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();t.voices=e}if(o.addEventListener("load",(function(r){if(this.processingDone=!1,window.publishARProjs&&window.sceneResult){localStorage.setItem("makarID",sceneResult.user_id);var i=this.arController.createThreeNFTMarker2D("-3");this.arController.loadDeaultTexture2D(i,"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/note1.png",new THREE.Vector3(0,-50,0),new THREE.Vector3(0,0,0),new THREE.Vector3(.9,.9,.9),[.5,1],{simple_behav:"runAnimation2D",dt:200,dopacity:.1}),i.name="note1",i.visible=!1,e.scene2D.add(i);let r=0,n=0,a=[];t.sceneTargetList=a;for(let e in window.publishARProjs.proj_list)window.publishARProjs.proj_list[e].targets_gcss_urls?r+=window.publishARProjs.proj_list[e].targets_gcss_urls.length:r++;if(console.log("three.js: _load: the total target number = ",r),r>19)return console.log("three.js: _load: languageType = ",d),warnModal.style.display="block",warnModalInfo.textContent=u.targetNumberError[d],void(warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none"});let s=function(i){console.log("three.js: _onloadNFTMarker: ev = ",i);let n=t.createAframeNFTMarker(i.result[0]),a=t.createThreeNFTMarker2D(i.result[0]);if(e.scene2D.add(a),t.arfScene.appendChild(n),Object.values(t.aframeNFTMarkers).length==r){console.log("three.js: _onloadNFTMarker done, call arScene.video.play() "),o.processingDone=!0,console.log("three.js:arScene.video.play()=>tick()"),_(),setTimeout((function(){e.video.play().then((function(){console.log("three.js:arScene.video.play()=> succes")})).catch((function(e){console.error("three.js:arScene.video.play()=> error",e)}))}),1e3),t.userStartTime=(new Date).getTime(),t.projStartTimeList=[];let r=document.getElementById("homePage");if(parent.selectedProject)if("XR"==parent.selectedProject.viewMode){t.setViewMode("AR").then((function(){r&&(r.style.display="none")}))}else if("model"==parent.selectedProject.viewMode){t.setViewMode("model").then((function(){r&&(r.style.display="none")}))}else{t.setViewMode("AR").then((function(){r&&(r.style.display="none")}))}else{t.setViewMode("AR").then((function(){r&&(r.style.display="none")}))}if(parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI(),1==!1){let e=0;parent.selectedProject&&parent.selectedProject.proj_id&&publishARProjs.result.forEach(((t,r)=>{t.proj_id==parent.selectedProject.proj_id&&(e=r,console.log(" +++++++ get id ",r,t))})),t.currentProjectIndex=e;let r=t.aframeNFTMarkers[e],o=t.threeNFTMarkers2D[e];r.loadedObjects=o.loadedObjects=!0;let i=t.loadMakarScene(e,r,o);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _debug : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let e=t.parseLogicXML(t.currentProjectIndex,0);i.push(e)}Array.isArray(i)&&Promise.all(i).then((function(r){console.log("three.js: _debug _loadMakarScene done: ret = ",r),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(e)})),o.visible=!0,r.setAttribute("visible",!0),r.object3D.visible=!0,r.object3D.matrixAutoUpdate=!0,r.object3D.position.set(-60,40,250),r.object3D.rotation.x=90*Math.PI/180,r.object3D.updateMatrix(),r.object3D.updateMatrixWorld()}}};console.log(" three.js: load publishARProjs proj_list =",window.publishARProjs.proj_list,userPublishProjs),(new THREE.TextureLoader).load("https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg",(function(e){let i;i=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let l=t.GLRenderer,c=i.fromEquirectangularTexture(l,e);t.cubeTex=c;for(let e in window.publishARProjs.proj_list){let t=window.publishARProjs.proj_list[e].target_gcss_url;if(window.publishARProjs.proj_list[e].proj_descr.indexOf("_coloring")>0&&(window.sceneResult[e].module="coloring",Array.isArray(window.sceneResult[e].data.module_type)&&window.sceneResult[e].data.module_type.push("coloring")),window.publishARProjs.proj_list[e].module_type){let i=window.publishARProjs.proj_list[e].module_type.find((function(e){let t;return"point_card"!=e&&"quiz"!=e||(t=e),t}));if("point_card"==i||"quiz"==i)for(let i=0;i<window.publishARProjs.proj_list[e].targets_gcss_urls.length;i++)a[n]={projIndex:e,target_id:window.publishARProjs.proj_list[e].target_ids[i]},t=window.publishARProjs.proj_list[e].targets_gcss_urls[i],o.loadNFTMarker(t.substring(0,t.length-5),n,r,s),n++;else a[n]={projIndex:e,target_id:window.publishARProjs.proj_list[e].target_id},o.loadNFTMarker(t.substring(0,t.length-5),n,r,s),n++}else a[n]={projIndex:e,target_id:window.publishARProjs.proj_list[e].target_id},o.loadNFTMarker(t.substring(0,t.length-5),n,r,s),n++}console.log("three.js: _load: , sceneTargetList = ",a)}))}})),document.body.className=t.orientation,"portrait"===t.orientation){let e,r;window.innerWidth/window.innerHeight>t.videoWidth/t.videoHeight?(e=window.innerWidth,r=window.innerWidth/t.videoWidth*t.videoHeight):(e=window.innerHeight/t.videoHeight*t.videoWidth,r=window.innerHeight),s.setSize(e,r),console.log("3 three.js:portrait GLRenderer.setSize=",e,r),a.style.left=(innerWidth-e)/2+"px",a.style.top=(innerHeight-r)/2+"px"}else if(/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)){let e,r;console.log("4 three.js:GLRenderer.setSize=",window.innerWidth,window.innerWidth/t.videoWidth*t.videoHeight),window.innerWidth/window.innerHeight>t.videoWidth/t.videoHeight?(e=window.innerWidth,r=window.innerWidth/t.videoWidth*t.videoHeight):(e=window.innerHeight/t.videoHeight*t.videoWidth,r=window.innerHeight),s.setSize(e,r),a.style.left=(innerWidth-e)/2+"px",a.style.top=(innerHeight-r)/2+"px"}else{let e,r;window.innerWidth/window.innerHeight>t.videoWidth/t.videoHeight?(e=window.innerWidth,r=window.innerWidth/t.videoWidth*t.videoHeight):(e=window.innerHeight/t.videoHeight*t.videoWidth,r=window.innerHeight),s.setSize(e,r),a.style.left=(innerWidth-e)/2+"px",a.style.top=(innerHeight-r)/2+"px",document.body.className+=" desktop",console.log("5 three.js: landscape GLRenderer.setSize=",t.videoWidth,t.videoHeight)}s.domElement.addEventListener("touchend",f,!1),s.domElement.addEventListener("mouseup",f,!1),s.domElement.addEventListener("touchmove",b,!1),s.domElement.addEventListener("mousemove",b,!1),s.domElement.addEventListener("touchstart",g,!1),s.domElement.addEventListener("mousedown",g,!1);var l=new THREE.ObjectControls(s.domElement,new THREE.Object3D);l.enableVerticalRotation(),l.setRotationSpeed(.1),l.setRotationSpeedTouchDevices(.05);var c=function(e){null!=t.controlObject&&0!=t.controlObject?(this.setObjectToMove(t.controlObject),this.setCurrentControllObject(t.currentControllObject)):this.setObjectToMove(null)};l.addEventListener("mouseDown",c),l.addEventListener("onTouchStart",c),t.objectControls=l;var h=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Raycaster;function f(r){if(2==t.objectControlState)return;r.preventDefault();let o=s.domElement.getBoundingClientRect();switch(r.type){case"mouseup":p.x=(r.clientX-o.left)/s.domElement.clientWidth*2-1,p.y=-(r.clientY-o.top)/s.domElement.clientHeight*2+1;break;case"touchend":p.x=(r.changedTouches[0].clientX-o.left)/s.domElement.clientWidth*2-1,p.y=-(r.changedTouches[0].clientY-o.top)/s.domElement.clientHeight*2+1;break;default:return void console.log(" endEvent: event.type=",r.type," not mouseup/touchend, return ")}let i={};if(m.setFromCamera(p,e.camera2D),null!=t.currentProjectIndex){let e=t.threeNFTMarkers2D[t.currentProjectIndex],r=m.intersectObject(e,!0);if(0!=r.length){console.log(" intersects2D =",r);let e=0;for(var n=0;n<r.length;n++)r[n].object.defaultTexture&&(e=n);let o=t.getMakarObject(r[e].object);if(console.log("three.js: endEvent: 2D intersects touchObject2D =",o),o.behav){let e=!1;for(let t=0;t<o.behav.length;t++)"CloseAndResetChildren"==o.behav[t].simple_behav&&(e=!0);let r=t.sceneTargetList[t.currentProjectIndex].projIndex;t.dealAllGroupHide(o,r);for(let r=0;r<o.behav.length;r++){let i;if(o.behav[r].obj_id&&(i=t.getObjectTypeByObj_id(o.behav[r].obj_id)),"ShowImage"==o.behav[r].simple_behav)if("2d"==i.obj_type){var a=Object.assign({},o.behav[r]);a.simple_behav="ShowImage2D",t.triggerEvent(a,o,e)}else"3d"==i.obj_type&&t.triggerEvent(o.behav[r],o,e);else if("ShowText"==o.behav[r].simple_behav){let n=Object.assign({},o.behav[r]);if(n.simple_behav="ShowText2D",t.triggerEvent(n,o,e),"2d"==i.obj_type){let i=Object.assign({},o.behav[r]);i.simple_behav="ShowText2D",t.triggerEvent(i,o,e)}else"3d"==i.obj_type&&t.triggerEvent(o.behav[r],o,e)}else o.behav[r].simple_behav,t.triggerEvent(o.behav[r],o,e)}}return void("button"==o.main_type&&(console.log("three.js: button click ",o),t.clickQuiz2DButton(o)))}m.setFromCamera(p,t.camera);let o=[];for(let e=0;e<t.makarObjects.length;e++){let r=t.makarObjects[e];r.object3D&&o.push(r.object3D)}let s=t.aframeNFTMarkers[t.currentProjectIndex],l=m.intersectObject(s.object3D,!0);if(0!=l.length){let e=t.getMakarObject(l[0].object),r=e.el;if(console.log("three.js: _setupFunction: endEvent, intersectObject3D=",r.object3D),r&&r.onclickBlock)for(let e=0;e<r.onclickBlock.length;e++)r.onclickBlockState[e]&&(r.onclickBlockState[e]=!1,t.logicList[t.currentProjectIndex].parseBlock(r.onclickBlock[e],(function(){r.onclickBlockState[e]=!0})),i["3d_logic"]=r.onclickBlock[e]);if(e.behav){i["3d_behav"]=e.behav;let r=t.sceneTargetList[t.currentProjectIndex].projIndex;t.dealAllGroupHide(e,r);let o=!1;for(let t=0;t<e.behav.length;t++)"CloseAndResetChildren"==e.behav[t].simple_behav&&(o=!0);for(let r=0;r<e.behav.length;r++)if("CloseAndResetChildren"!=e.behav[r].simple_behav){let i;if(e.behav[r].obj_id&&(i=t.getObjectTypeByObj_id(e.behav[r].obj_id)),"ShowImage"==e.behav[r].simple_behav)if("2d"==i.obj_type){let i=Object.assign({},e.behav[r]);i.simple_behav="ShowImage2D",t.triggerEvent(i,e,o)}else"3d"==i.obj_type&&t.triggerEvent(e.behav[r],e,o);else if("ShowText"==e.behav[r].simple_behav)if("2d"==i.obj_type){let i=Object.assign({},e.behav[r]);i.simple_behav="ShowText2D",t.triggerEvent(i,e,o)}else"3d"==i.obj_type&&t.triggerEvent(e.behav[r],e,o);else t.triggerEvent(e.behav[r],e,o)}}console.log("three.js: touchObject",e),"button"==e.main_type&&(console.log("three.js: button click ",e),t.pushButton(e))}}0==Object.keys(i).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",i)}function g(e){t.objectControlState=1,e.preventDefault();let r=s.domElement.getBoundingClientRect();switch(e.type){case"mousedown":h.x=e.clientX,h.y=e.clientY,p.x=(e.clientX-r.left)/s.domElement.clientWidth*2-1,p.y=-(e.clientY-r.top)/s.domElement.clientHeight*2+1;break;case"touchstart":h.x=e.changedTouches[0].clientX,h.y=e.changedTouches[0].clientY,p.x=(e.changedTouches[0].clientX-r.left)/s.domElement.clientWidth*2-1,p.y=-(e.changedTouches[0].clientY-r.top)/s.domElement.clientHeight*2+1;break;default:return void console.log(" startEvent: event.type=",e.type," not mousedown/touchstart, return ")}if(m.setFromCamera(p,t.camera),null!=t.currentProjectIndex){let e=t.aframeNFTMarkers[t.currentProjectIndex],r=m.intersectObjects([e.object3D],!0);if(console.log(" _startEvent: ",m,t.camera,e.object3D),0!=r.length){console.log("startEvent: intersects =",r);let e=t.getMakarObject(r[0].object);if(e.behav){let r=!1,o=!0;e.behav&&e.behav.forEach((e=>{"FingerGesture"==e.simple_behav&&(r=!0,o=1==e.active)})),1==r?1==o?(t.controlObject=e,t.currentControllObject=e):t.controlObject=null:(t.controlObject=e,t.currentControllObject=e)}else t.controlObject=e,t.currentControllObject=e}else console.log("2 startEvent: intersects =",r),t.controlObject=null}}function b(e){switch(e.type){case"mousemove":1==t.objectControlState&&(Math.abs(h.x-e.clientX)>2||Math.abs(h.y-e.clientY)>2)&&(t.objectControlState=2);break;case"touchmove":(Math.abs(h.x-e.changedTouches[0].clientX)>2||Math.abs(h.y-e.changedTouches[0].clientY)>2)&&(t.objectControlState=2);break;default:return void console.log(" startEvent: event.type=",e.type," not mousemove/touchmove, return ")}}var _=function(){let r=(new Date).getTime();1==t.enableTracking&&o.process(e.video);var i=t.clock.getDelta();for(let e=0;e<t.makarObjects.length;e++)1==t.makarObjects[e].playAnimation&&1==t.makarObjects[e].visible&&t.checkAimation(t.makarObjects[e].children[0],i);e.renderOn(s,null);let n=(new Date).getTime(),a=30;a=n-r<30?30-(n-r)+1:1,setTimeout(_,a)}}})})),delete window.ARThreeOnLoad};var i=localStorage.getItem("cameraFacing");null==i&&localStorage.setItem("cameraFacing","environment");var n,a=localStorage.getItem("makarID"),s=localStorage.getItem("doExchangeCamera"),l=function(){if("undefined"!=typeof checkHost){if("yet"==checkHost)setTimeout(l,50);else if("correct"==checkHost)console.log("___ gMI=",a,", doEx=",s,", md=",window.makarID),a?1==s?(console.log("three.js: getMakarID is exist, ",a,", doExchangeCamera is exist =",s,", cameraFacing=",i),"environment"==i?(localStorage.setItem("cameraFacing","user"),console.log("------- set _cameraFacing to user")):(localStorage.setItem("cameraFacing","environment"),console.log("------- set _cameraFacing to environment")),o()):(localStorage.setItem("cameraFacing","environment"),window.makarID?(console.log("three.js: doExchangeCamera != 1, window.makarID is exist:",window.makarID,"save it"),localStorage.setItem("makarID",window.makarID),o()):console.log("three.js: doExchangeCamera != 1, window.makarID isn't exist, wait the Start AR button trigger")):(localStorage.setItem("cameraFacing","environment"),window.makarID?(console.log("three.js: getMakarID isn't exist, makarID is exist =",window.makarID,", doExchangeCamera=",s),localStorage.setItem("makarID",window.makarID),o()):console.log("three.js: getMakarID isn't exist, makarID isn't exist, wait the Start AR button trigger"));else if("fail"==checkHost){for(;document.body.firstChild;)document.body.removeChild(document.body.firstChild);var e=document.createElement("div");e.innerHTML="<br>The host of webAR seems unauthorized,<br> please contact MIFLY ",e.style.fontSize="18px",e.style.margin="5px",e.style.fontWeight="700",document.body.append(e)}}else console.log("three.js: checkHost = undefined, something ERROR.")};window.startARProcess=l,n="undefined"!=typeof window?window:self;var c=function(){n.ARController&&n.THREE?(e(),window.addEventListener("keyup",(function(e){13===e.keyCode&&(e.preventDefault(),console.log("enter keyup"))}))):setTimeout(c,50)};let d;if("undefined"!=typeof window&&c(),parent){let e=parent.location.pathname.indexOf("/",0),t=parent.location.pathname.indexOf("/",e+1);d=window.languageType=parent.location.pathname.substring(1,t)}d="tw";let u=window.worldContent={inputSearch:{tw:"搜尋",en:"Search"},labelSelected:{tw:"精選",en:"Selected"},userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},targetNumberError:{tw:"辨識圖的數量不可超過20 ",en:"the max number of image targets can't larger than 20 "},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"comfire"},timeIsUp:{tw:"時間到",en:"Time is up"}}}(),function(){"use strict";if(!e)var e=(new Date).getTime();if(window.Browser=function(e){void 0===e&&(e=window.navigator.userAgent),e=e.toLowerCase();var t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],r=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(silk)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||/(playbook)/.exec(e)||/(bb)/.exec(e)||/(blackberry)/.exec(e)||[],o={},i={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",versionNumber:t[4]||t[2]||"0",platform:r[0]||""};if(i.browser&&(o[i.browser]=!0,o.version=i.version,o.versionNumber=parseInt(i.versionNumber,10)),i.platform&&(o[i.platform]=!0),(o.android||o.bb||o.blackberry||o.ipad||o.iphone||o.ipod||o.kindle||o.playbook||o.silk||o["windows phone"])&&(o.mobile=!0),(o.cros||o.mac||o.linux||o.win)&&(o.desktop=!0),(o.chrome||o.opr||o.safari)&&(o.webkit=!0),o.rv||o.iemobile){var n="msie";i.browser=n,o[n]=!0}if(o.edge){delete o.edge;var a="msedge";i.browser=a,o.msedge=!0}if(o.safari&&o.blackberry){var s="blackberry";i.browser=s,o.blackberry=!0}if(o.safari&&o.playbook){var l="playbook";i.browser=l,o.playbook=!0}if(o.bb){var c="blackberry";i.browser=c,o[c]=!0}if(o.opr){var d="opera";i.browser=d,o.opera=!0}if(o.safari&&o.android){var u="android";i.browser=u,o.android=!0}if(o.safari&&o.kindle){var h="kindle";i.browser=h,o.kindle=!0}if(o.safari&&o.silk){var p="silk";i.browser=p,o.silk=!0}o.name=i.browser,o.platform=i.platform;var m=/micromessenger/.test(e),f=/line/.test(e),g=/fban/.test(e)||/fbav/.test(e);return m?o.app="weChat":f?o.app="Line":g&&(o.app="FB"),o}(window.navigator.userAgent),!t)var t=(new Date).getTime();t&&e&&console.log("processing time(uaMatch):",t-e)}(),function(){"use strict";window.parseUserData=function(e,t){let r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="json",r.onload=function(e){for(var t in r.response.data?window.file=r.response.data:window.file=r.response,window.file.scene_objs_v2)for(var o in window.file.scene_objs_v2[t].transform){var i=window.file.scene_objs_v2[t].transform[o].split(",");if(3!=i.length)return-1;var n=[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])];window.file.scene_objs_v2[t].transform[o]=n}return window.file},r.send(),r.response},window.getUserPublishProjsByUserID=function(e,t,r,o,i){if(!e)return-1;t||(t="makarvr"),r||(r=""),o||(o="");let n=new XMLHttpRequest,a={user_id:t,web_ar:!0};"3.0.0"==serverVersion&&getResByUserID(e,t,r,o,(function(s){getUsrOnlineRes(e,t,r,o,"",(function(t){let r=e+"get_usr_publish_projs",o={ver:"3.0.0",cid:5,data:a},l=JSON.stringify(o);n.open("POST",r,!0),n.setRequestHeader("Content-Type","application/json"),n.responseType="json",n.onload=function(e){let r;n.response.error?(i&&i(n.response.error),console.log("%cnetworkAgent.js: _getUserPublishProjs: oops something wrong: ","color:red",n.response.error)):n.response.data?(r=n.response.data,window.userPublishProjs,window.userPublishProjs=r,i&&i(r,s,t)):i&&i("networkAgent.js:error: no xhr.response.data")},n.send(l)}))}))},window.getNewestPublishProjs=function(e,t,r){if(!e)return-1;t||(t="ar");let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let r=e+"get_newest_publish_projs",i={ver:"3.0.0",cid:5,data:{proj_type:t}},n=JSON.stringify(i);o.open("POST",r,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent.js: getNewestPublishProjs,  onload xhr.response = ",o.response)},console.log("networkAgent.js: getNewestPublishProjs, jsonReq=",n),o.send(n)}},window.getARSceneByUserID=function(e,t,r){if(!e)return-1;t||(t="makarvr");let o=[];if(o.user_id=t,"3.0.0"==serverVersion){var i=function(i,n,a){if("string"==typeof i)return void(r&&r(i));let s=0;if(i.proj_list.length>0){o.name=i.proj_list[0].name;let l=[];for(let e in i.proj_list)if("ar"==i.proj_list[e].proj_type){if(parent.useEditorWebTag&&!i.proj_list[e].proj_platform.find((e=>"web"==e)))continue;l.push(i.proj_list[e].proj_id)}let c=new XMLHttpRequest,d=e+"get_ar_projs_by_proj_id",u={ver:"3.0.0",cid:5,data:{proj_id_list:l}},h=JSON.stringify(u);c.open("POST",d,!0),c.setRequestHeader("Content-Type","application/json"),c.responseType="json",c.onload=function(i){console.log("networkAgent.js: get_ar_projs_by_proj_id: onload, response=",c.response);let l=c.response.data;0==window.allowedMakarIDUseWeb?r&&r("this ID["+t+"] is free user, not allow to use webAR"):function(){if(l.proj_list=l.result,l.user_id=t,window.publishARProjs=l,l&&l.result&&l.result.length)if(l.result.length<20)for(let t=0;t<l.result.length;t++){let i=new XMLHttpRequest,c={user_id:l.result[t].user_id,proj_id:l.result[t].proj_id},d=e+"get_ar_proj_scene",u={ver:"3.0.0",cid:5,data:c},h=JSON.stringify(u);i.open("POST",d,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){s++,o[t]=i.response;for(let e=0;e<o[t].data.scene_objs_v2.length;e++)if(o[t].data.scene_objs_v2[e].res_id){let r=o[t].data.scene_objs_v2[e].res_id;n[r]&&(n[r].res_url==o[t].data.scene_objs_v2[e].res_url||(console.log("networkAgent.js: _getUserPublishProjs: ARResDict.res_url different as scene.url, replace it"),o[t].data.scene_objs_v2[e].res_url=n[r].res_url),"model"==n[r].main_type&&(n[r].res_url_fbx?o[t].data.scene_objs_v2[e].res_url_fbx=n[r].res_url_fbx:console.log("networkAgent.js: _getUserPublishProjs: ARResDict.res_url_fbx not exit ",n[r])))}else console.log("networkAgent.js: _getUserPublishProjs: prefab or error, res_id not exist ",o[t].data.scene_objs_v2[e]);s==l.result.length&&(console.log("networkAgent.js: _getARSceneByUserID: _getUserPublishProjs: count=",s,"sceneResult=",o),window.sceneResult=o,window.userProjResDict=n,window.userOnlineResDict=a,r&&r(o))},i.send(h)}else console.log("networkAgent.js: _getUserPublishProjs: count > 20 =",s,", too many targets,.. can't afford "),r&&r("There are too many AR projects ["+s+"], cannot affort, please reduce some project")}()},c.send(h)}else r&&r("this ID doesn't publish any projects")};searchUserIDByUserID(e,t,(function(o){for(let e in o.result)t.toLowerCase()===o.result[e].user_id.toLowerCase()&&(console.log("networkAgentVR.js: _searchUserIDByUserID: match, replace from [",t,"] to [",o.result[e].user_id,"]"),t=o.result[e].user_id);getPayInfoByUserID(e,t,(function(o){!function(e,t){var r,o=new XMLHttpRequest;o.open("GET",e,!0),o.onreadystatechange=function(){if(4===o.readyState&&(200===o.status||0==o.status)){let e=o.responseText;r=e,t&&t(r)}},o.send(null)}("https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/webVR_UserID_WhiteList.txt",(function(n){let a=JSON.parse(n).customizedUserID.list,s=[];for(let e=0;e<a.length;e++)s.push(a[e].name.toLowerCase());let l=s.indexOf(t.toLowerCase())>-1;console.log("networkAgent.js: _getPayInfoByUserID: nameList= ",s),o.data?(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: user_type=",o.data),window.allowedMakarIDUseWeb=o.data.web_ar||l,"proA"!=o.data.user_type&&"proB"!=o.data.user_type&&"proC"!=o.data.user_type&&"custom"!=o.data.user_type||(window.allowedMakarIDUseWeb=!0),getUserPublishProjsByUserID(e,t,"","",i)):(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: error, userPayInfo=",o),r&&r("this ID <br> ["+t+"] <br> user data error, please contact MIFLY for more information. "))}))}))}))}},window.getResByUserID=function(t,r,o,i,n){r||(r="fefe"),o||(o=""),i||(i="");let a=t+"get_res",s=new XMLHttpRequest,l={ver:"3.0.0",cid:5,data:{user_id:r,main_type:o,sub_type:i}},c=JSON.stringify(l);s.open("POST",a,!0),s.setRequestHeader("Content-Type","application/json"),s.responseType="json",s.onload=function(t){s.response.error?console.log("networkAgent: _getResByUserID,  onload error ",s.response):s.response.data.list.length>0?e(s.response.data.list,(function(e){n&&n(e)})):n&&(console.log("networkAgent: _getResByUserID,  onload  use res is empty "),n({}))},s.send(c)};var e=function(e,t){if(!e)return console.log("netWorkAgent.js: createProjResDictFromResList: error, userARResList not defined "),-1;let r={};for(let o=0;o<e.length;o++)r[e[o].res_id]=e[o],o==e.length-1&&t(r)};window.getUsrOnlineRes=function(e,r,o,i,n,a){r||(r="fefe"),o||(o=""),i||(i=""),n||(n="");let s=e+"get_usr_online_res",l=new XMLHttpRequest,c={ver:"3.0.0",cid:5,data:{user_id:r,main_type:o,sub_type:i,category:n}},d=JSON.stringify(c);l.open("POST",s,!0),l.setRequestHeader("Content-Type","application/json"),l.responseType="json",l.onload=function(e){console.log("networkAgentVR.js: _getUsrOnlineRes: res = ",l.response),l.response.error?console.log("networkAgent.js: _getUsrOnlineRes,  onload error ",l.response):(console.log("networkAgent.js: _getUsrOnlineRes,  onload save ",l.response),l.response.data.online_res_list.length>0?t(l.response.data.online_res_list,(function(e){a&&a(e)})):a&&(console.log("networkAgent: _getUsrOnlineRes,  onload  use res is empty "),a({})))},l.send(d)};var t=function(e,t){if(!e)return-1;let r={};for(let o=0;o<e.length;o++)r[e[o].res_id]=e[o],o==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",o,e.length),t&&t(r))};function r(e,t,r){let o=new XMLHttpRequest,i={ver:"3.1.1",cid:5,data:t},n=JSON.stringify(i);o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.addEventListener("load",(function(){r&&r(o.response)})),o.send(n)}window.getOneUserInfo=function(e,t,r,o){let i=new XMLHttpRequest,n=e+"get_one_usr_info",a={ver:"3.0.0",cid:5,data:{user_id:t,wanted_info_keys:r}},s=JSON.stringify(a);i.open("POST",n,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){console.log("networkAgent.js: _getOneUserInfo: xhr.r=",i.response),""==i.response.error?o&&o(i.response):o&&o(i.response.error)},i.send(s)},window.getARProjsByProjID=function(e,t){if(null==e)return;if(!Array.isArray(e))return;if(e.length<1)return;let r=new XMLHttpRequest,o={proj_id_list:e},i=window.serverUrl+"get_ar_projs_by_proj_id",n={ver:"3.0.0",cid:5,data:o},a=JSON.stringify(n);r.open("POST",i,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){""==r.response.error?t&&t(r.response):t&&t(r.response.error)},r.send(a)},window.checkMaxScanTimes=function(e,t,r){if(!e)return-1;let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let t=e+"check_max_scan_times",r={ver:"3.0.0",cid:5,data:{user_id:"fefe",target_id:"1545795389.8544426.1988048228"}},i=JSON.stringify(r);o.open("POST",t,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent: checkMaxScanTimes, xhr.response.data = ",o.response.data)},o.send(i)}},window.getScanTimes=function(e,t,r){if(!e)return-1;if(!t)return-1;let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let r=e+"get_scan_times",i={ver:"3.0.0",cid:5,data:{user_id:t,target_id:"1545795389.8544426.1988048228"}},n=JSON.stringify(i);o.open("POST",r,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent: getScanTimes, xhr.response.data = ",o.response.data)},o.send(n)}},window.addScanTimesByTargetID=function(e,t,r,o){if(!e)return-1;if(!t)return-1;if(!r)return-1;let i={user_id:t,target_id:r,device_id:"",location_lan:"",location_long:""};if(navigator.userAgent&&Browser){let e=navigator.userAgent,t=navigator.userAgent.indexOf("(",0),r=navigator.userAgent.indexOf(")",0);if(t>0&&r>0){let o=e.slice(t+1,r);o.toLowerCase();i.os=o,i.brand=Browser.platform+" "+Browser.name+" "+Browser.version}}let n=new XMLHttpRequest;if("3.0.0"==serverVersion){let t=e+"add_scan_times",r={ver:"3.0.0",cid:5,data:i};JSON.stringify(r);n.open("POST",t,!0),n.setRequestHeader("Content-Type","application/json"),n.responseType="json",n.onload=function(e){}}if("2.0.0"==serverVersion){let t=JSON.stringify(i),r=new FormData;r.append("cmd","add_scan_times"),r.append("data",t),n.open("POST",e,!0),n.responseType="json",n.onload=function(e){console.log("networkAgent: uploadDataToServer, xhr = ",n.response.data)},n.send(r)}},window.getPayInfoByUserID=function(e,t,r){if(!e)return-1;if(!t)return-1;let o=e+"get_pay_info",i=new XMLHttpRequest,n={ver:"3.0.0",cid:5,data:{user_id:t}},a=JSON.stringify(n);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){r&&r(i.response)},i.send(a)},window.getELicenseInfo=function(e,t,r){if(!e)return-1;if(!t)return-1;let o=e+"get_e_lice_info",i=new XMLHttpRequest,n={ver:"3.1.1",cid:5,data:{license_key:t}},a=JSON.stringify(n);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){r&&r(i.response)},i.send(a)},window.checkLicenseInProjs=function(e,t){let o=[],i=[],n=[],a=[];for(let e=0,t=userPublishProjs.proj_list.length;e<t;e++)switch(userPublishProjs.proj_list[e].proj_type){case"ar":o.push(userPublishProjs.proj_list[e].proj_id),a.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"vr":i.push(userPublishProjs.proj_list[e].proj_id),a.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"ar_slam":n.push(userPublishProjs.proj_list[e].proj_id),a.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;default:console.error("networkAgentVR.js: _checkLicenseInProjs: project type ERROR",userPublishProjs.proj_list[e].proj_type)}let s=[];function l(r){for(let o=0,i=a.length;o<i;o++)for(let i=0,n=r.data.result.length;i<n;i++)a[o].proj_id==r.data.result[i].proj_id&&(""!=r.data.result[i].editor_license_key?getELicenseInfo(e,r.data.result[i].editor_license_key,(function(e){""!=e.error?s.push({proj_id:a[o].proj_id,isLicense:!1}):s.push({proj_id:a[o].proj_id,isLicense:!0}),s.length==a.length&&t&&t(s)})):s.push({proj_id:a[o].proj_id,isLicense:!1}));s.length==a.length&&t&&t(s)}o.length>0&&r(e+"get_ar_projs_by_proj_id",{proj_id_list:o},l),i.length>0&&r(e+"get_vr_projs_by_proj_id",{proj_id_list:i},l),n.length>0&&r(e+"get_arslam_projs_by_proj_id",{proj_id_list:n},l)},window.getRecordModule=function(e,t,o,i){if(!e)return-1;r(e+"get_record_module",{playing_user_id:t,proj_id:o},(function(e){console.log("networkAgentVR.js: _getRecordModule: ret",e),i&&i(e)}))},window.quizLog=function(e,t,o){r(e+"quiz_log",t,(function(e){console.log("networkAgentVR.js: _quizLog: ret",e),o&&o(e)}))},window.updateRecordModule=function(e,t,o){r(e+"update_record_module",t,(function(e){console.log("networkAgentVR.js: _updateRecordModule: ret",e),o&&o(e)}))},window.getViewerConfig=function(e,t){if(!e)return-1;let r=e+"get_viewer_config",o=new XMLHttpRequest,i=JSON.stringify({ver:"3.1.1",cid:5,data:{}});o.open("POST",r,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent.js: _getViewerConfig: xhr.response",o.response),t&&t(o.response)},o.send(i)},window.pointCardLog=function(e,t,r){if(!e)return-1;if(!webARVersion)return-1;let o=e+"point_card_log",i=new XMLHttpRequest,n={ver:webARVersion,cid:5,data:t},a=JSON.stringify(n);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){console.log("networkAgent.js: _pointCardLog: xhr.response = ",i.response),r&&r(i.response)},i.send(a)},window.scratchCardLog=function(e,t,r){if(!e)return-1;if(!webARVersion)return-1;let o=e+"scratch_card_log",i=new XMLHttpRequest,n={ver:webARVersion,cid:5,data:t},a=JSON.stringify(n);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){console.log("networkAgent.js: _scratchCardLog: xhr.response = ",i.response),r&&r(i.response)},i.send(a)},window.testMakarApi=function(){let e="https://ssl-api-makar-v3-apps.miflyservice.com/Makar/get_viewer_config";e="https://ssl-api-makar-apps.miflyservice.com/Makar/get_viewer_config";let t=new XMLHttpRequest,r=JSON.stringify({ver:"3.1.1",cid:5,data:{}});t.open("POST","https://ssl-api-makar-apps.miflyservice.com/Makar/get_viewer_config",!0),t.setRequestHeader("Content-Type","application/json"),t.responseType="json",t.onload=function(e){console.log("networkAgent.js: testMakarApi: xhr.response",t.response)},t.send(r)},window.searchUserIDByUserID=function(e,t,r){if(!e)return-1;if(!t)return-1;let o=e+"get_many_usr_info_keyword",i=new XMLHttpRequest,n={ver:"3.0.0",cid:5,data:{keyword:t,search_keys:["user_id"]}},a=JSON.stringify(n);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(e){console.log("networkAgent.js: _searchUserIDByUserID: xhr.response",i.response.data),r&&r(i.response.data)},i.send(a)},window.testPOST=function(e,t){let r=new XMLHttpRequest,o={ver:"3.0.0",cid:5,data:{user_id:"fefe"},length:8},i=JSON.stringify(o);console.log(" jsonReq ",i);let n=new FormData;n.append("cmd","add_scan_times"),n.append("data",i),r.open("POST","http://60.250.125.146:8081/Makar/get_usr_publish_projs",!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent: testPOST,  onload xhr = ",r,r.response)},r.send(i)}}(),function(e){var t={};function r(o){if(t[o])return t[o].exports;var i=t[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,r),i.loaded=!0,i.exports}r.m=e,r.c=t,r.p="",r(0)}([function(e,t,r){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=r(1);if("undefined"==typeof AFRAME)throw"Component attempted to register before AFRAME was available.";var n=AFRAME.utils.srcLoader.parseUrl,a=AFRAME.utils.debug;a.enable("shader:gif:warn");var s=a("shader:gif:warn"),l=(a("shader:gif:debug"),{});function c(e,t){return{status:"error",src:t,message:e,timestamp:Date.now()}}AFRAME.registerShader("gif",{schema:{color:{type:"color"},fog:{default:!0},src:{default:null},autoplay:{default:!0}},init:function(e){return this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset(),this.material=new THREE.MeshBasicMaterial({map:this.__texture}),this.el.sceneEl.addBehavior(this),this.__addPublicFunctions(),this.material},update:function(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material},tick:function(e){this.__frames&&!this.paused()&&Date.now()-this.__startTime>=this.__nextFrameTime&&this.nextFrame()},__updateMaterial:function(e){var t=this.material;console.log("testmaterial",t);var r=this.__getMaterialData(e);Object.keys(r).forEach((function(e){t[e]=r[e]}))},__getMaterialData:function(e){return{fog:e.fog,opacity:e.opacity}},__setTexure:function(e){"error"===e.status?(s("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))},__updateTexture:function(e){var t=e.src,r=e.autoplay;"boolean"==typeof r?this.__autoplay=r:void 0===r&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()},__validateSrc:function(e,t){var r=n(e);if(r)this.__getImageSrc(r,t);else{var i=void 0,a=this.__validateAndGetQuerySelector(e);if(a&&"object"===(void 0===a?"undefined":o(a))){if(a.error)i=a.error;else{var s=a.tagName.toLowerCase();if("video"===s)e=a.src,i="For video, please use `aframe-video-shader`";else{if("img"===s)return void this.__getImageSrc(a.src,t);i="For <"+s+"> element, please use `aframe-html-shader`"}}var d,u;i&&(d=l[e],u=c(i,e),d&&d.callbacks?d.callbacks.forEach((function(e){return e(u)})):t(u),l[e]=u)}}},__getImageSrc:function(e,t){var r=this;if(e!==this.__textureSrc){var o=l[e];if(o&&o.callbacks){if(o.src)return void t(o);if(o.callbacks)return void o.callbacks.push(t)}else(o=l[e]={callbacks:[]}).callbacks.push(t);var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(function(t){r.__getUnit8Array(e,(function(t){t?(0,i.parseGIF)(t,(function(t,r,i){var n={status:"success",src:e,times:t,cnt:r,frames:i,timestamp:Date.now()};o.callbacks&&(o.callbacks.forEach((function(e){return e(n)})),l[e]=n)}),(function(e){return a(e)})):a("This is not gif. Please use `shader:flat` instead")}))})),n.addEventListener("error",(function(e){return a("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),n.src=e}function a(t){var r=c(t,e);o.callbacks&&(o.callbacks.forEach((function(e){return e(r)})),l[e]=r)}},__getUnit8Array:function(e,t){if("function"==typeof t){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.addEventListener("load",(function(e){for(var r=new Uint8Array(e.target.response),o=r.subarray(0,4),i="",n=0;n<o.length;n++)i+=o[n].toString(16);"47494638"===i?t(r):t()})),r.addEventListener("error",(function(e){t()})),r.send()}},__validateAndGetQuerySelector:function(e){try{var t=document.querySelector(e);return t||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}},__addPublicFunctions:function(){this.el.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}},pause:function(){this.__paused=!0},play:function(){this.__paused=!1},togglePlayback:function(){this.paused()?this.play():this.pause()},paused:function(){return this.__paused},nextFrame:function(){for(this.__draw();Date.now()-this.__startTime>=this.__nextFrameTime;)this.__nextFrameTime+=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)},__clearCanvas:function(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__draw:function(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__ready:function(e){var t=e.src,r=e.times,o=e.cnt,i=e.frames;this.__textureSrc=t,this.__delayTimes=r,o?this.__loopCnt=o:this.__infinity=!0,this.__frames=i,this.__frameCnt=r.length,this.__startTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(i[0].width),this.__height=THREE.Math.floorPowerOfTwo(i[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause()},__reset:function(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}}),AFRAME.registerShader("gif_RGB",{schema:{color:{type:"color",is:"uniform",default:0},fog:{default:!0},texture:{type:"map",is:"uniform"},opacity:{type:"number",is:"uniform",default:1},_threshold:{type:"number",is:"uniform",default:.8},_slope:{type:"number",is:"uniform",default:.2},src:{default:null},autoplay:{default:!0}},init:function(e){this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset();var t={vertexShader:["varying vec2 vUV;","void main(void) {","  vUV = uv;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","uniform vec3 color;","uniform float opacity;","varying vec2 vUV;","uniform float _threshold;","uniform float _slope;","void main(){"," vec3 tColor = texture2D( texture, vUV ).rgb;"," float a = texture2D( texture, vUV ).a;"," float d1, d2, d3, d4, d;"," d1 = abs(length(abs(color.rgb - tColor.rgb)));"," float c1 = abs(length( tColor.g - tColor.r) - length(color.g - color.r));"," float c2 = abs(length( tColor.r - tColor.b) - length(color.r - color.b));"," float c3 = abs(length( tColor.b - tColor.g) - length(color.b - color.g));"," d4 = c1 + c2 + c3;"," d = (d1*2.0 + d4) / 2.0 ;"," float edge0 = _threshold * (1.0 - _slope);"," float alpha = smoothstep(edge0, _threshold, d);"," if (alpha < opacity){","   gl_FragColor = vec4(tColor, alpha*a);"," }"," else{","   gl_FragColor = vec4(tColor, opacity*a);"," }","}"].join("\n")};return this.material=new THREE.ShaderMaterial({uniforms:{color:{value:new THREE.Color(e.color)},texture:{value:this.__texture},opacity:{value:e.opacity},_threshold:{value:e._threshold},_slope:{value:e._slope}},vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.el.sceneEl.addBehavior(this),this.__addPublicFunctions(),this.material},update:function(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material},tick:function(e){this.__frames&&!this.paused()&&Date.now()-this.__startTime>=this.__nextFrameTime&&this.nextFrame()},__updateMaterial:function(e){var t=this.material;console.log("testmaterial",t);var r=this.__getMaterialData(e);Object.keys(r).forEach((function(e){t[e]=r[e]}))},__getMaterialData:function(e){return{fog:e.fog,opacity:e.opacity}},__setTexure:function(e){"error"===e.status?(s("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))},__updateTexture:function(e){var t=e.src,r=e.autoplay;"boolean"==typeof r?this.__autoplay=r:void 0===r&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()},__validateSrc:function(e,t){var r=n(e);if(r)this.__getImageSrc(r,t);else{var i=void 0,a=this.__validateAndGetQuerySelector(e);if(a&&"object"===(void 0===a?"undefined":o(a))){if(a.error)i=a.error;else{var s=a.tagName.toLowerCase();if("video"===s)e=a.src,i="For video, please use `aframe-video-shader`";else{if("img"===s)return void this.__getImageSrc(a.src,t);i="For <"+s+"> element, please use `aframe-html-shader`"}}var d,u;i&&(d=l[e],u=c(i,e),d&&d.callbacks?d.callbacks.forEach((function(e){return e(u)})):t(u),l[e]=u)}}},__getImageSrc:function(e,t){var r=this;if(e!==this.__textureSrc){var o=l[e];if(o&&o.callbacks){if(o.src)return void t(o);if(o.callbacks)return void o.callbacks.push(t)}else(o=l[e]={callbacks:[]}).callbacks.push(t);var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(function(t){r.__getUnit8Array(e,(function(t){t?(0,i.parseGIF)(t,(function(t,r,i){var n={status:"success",src:e,times:t,cnt:r,frames:i,timestamp:Date.now()};o.callbacks&&(o.callbacks.forEach((function(e){return e(n)})),l[e]=n)}),(function(e){return a(e)})):a("This is not gif. Please use `shader:flat` instead")}))})),n.addEventListener("error",(function(e){return a("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),n.src=e}function a(t){var r=c(t,e);o.callbacks&&(o.callbacks.forEach((function(e){return e(r)})),l[e]=r)}},__getUnit8Array:function(e,t){if("function"==typeof t){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.addEventListener("load",(function(e){for(var r=new Uint8Array(e.target.response),o=r.subarray(0,4),i="",n=0;n<o.length;n++)i+=o[n].toString(16);"47494638"===i?t(r):t()})),r.addEventListener("error",(function(e){t()})),r.send()}},__validateAndGetQuerySelector:function(e){try{var t=document.querySelector(e);return t||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}},__addPublicFunctions:function(){this.el.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}},pause:function(){this.__paused=!0},play:function(){this.__paused=!1},togglePlayback:function(){this.paused()?this.play():this.pause()},paused:function(){return this.__paused},nextFrame:function(){for(this.__draw();Date.now()-this.__startTime>=this.__nextFrameTime;)this.__nextFrameTime+=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)},__clearCanvas:function(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__draw:function(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__ready:function(e){var t=e.src,r=e.times,o=e.cnt,i=e.frames;this.__textureSrc=t,this.__delayTimes=r,o?this.__loopCnt=o:this.__infinity=!0,this.__frames=i,this.__frameCnt=r.length,this.__startTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(i[0].width),this.__height=THREE.Math.floorPowerOfTwo(i[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause()},__reset:function(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}}),AFRAME.registerShader("gif_HSV",{schema:{color:{type:"color"},fog:{default:!0},texture:{type:"map",is:"uniform"},opacity:{type:"number",is:"uniform",default:1},_keyingColorH:{type:"number",is:"uniform",default:.33},_keyingColorS:{type:"number",is:"uniform",default:1},_keyingColorV:{type:"number",is:"uniform",default:.75},_deltaH:{type:"number",is:"uniform",default:.2},_deltaS:{type:"number",is:"uniform",default:.1},_deltaV:{type:"number",is:"uniform",default:.1},src:{default:null},autoplay:{default:!0}},init:function(e){this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset();var t={vertexShader:["varying vec2 vUV;","void main(void) {","  vUV = uv;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","uniform float opacity;","varying vec2 vUV;","uniform float _keyingColorH;","uniform float _keyingColorS;","uniform float _keyingColorV;","uniform float _deltaH;","uniform float _deltaS;","uniform float _deltaV;","vec3 rgb2hsv(vec3 c){"," vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);"," vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));"," vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));"," float d = q.x - min(q.w, q.y);"," float e = 1.0e-10;"," return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","void main(){"," vec3 tColor = texture2D( texture, vUV ).rgb;"," float a = texture2D( texture, vUV ).a;"," vec3 HSV = rgb2hsv(tColor);"," float h = abs(HSV.x - _keyingColorH);"," float s = abs(HSV.y - _keyingColorS);"," float v = abs(HSV.z - _keyingColorV);"," float alpha = opacity;"," if (h <= _deltaH * 0.5 && s <= _deltaS && v <= _deltaV){","   alpha = smoothstep((_deltaH * 0.5) * 0.8, _deltaH* 0.6 ,h);"," }","gl_FragColor = vec4(tColor, alpha*a);","}"].join("\n")};return this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:this.__texture},opacity:{value:e.opacity},_keyingColorH:{value:e._keyingColorH},_keyingColorS:{value:e._keyingColorS},_keyingColorV:{value:e._keyingColorV},_deltaH:{value:e._deltaH},_deltaS:{value:e._deltaS},_deltaV:{value:e._deltaV}},vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.el.sceneEl.addBehavior(this),this.__addPublicFunctions(),this.material},update:function(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material},tick:function(e){this.__frames&&!this.paused()&&Date.now()-this.__startTime>=this.__nextFrameTime&&this.nextFrame()},__updateMaterial:function(e){var t=this.material;console.log("testmaterial",t);var r=this.__getMaterialData(e);Object.keys(r).forEach((function(e){t[e]=r[e]}))},__getMaterialData:function(e){return{fog:e.fog,opacity:e.opacity}},__setTexure:function(e){"error"===e.status?(s("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))},__updateTexture:function(e){var t=e.src,r=e.autoplay;"boolean"==typeof r?this.__autoplay=r:void 0===r&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()},__validateSrc:function(e,t){var r=n(e);if(r)this.__getImageSrc(r,t);else{var i=void 0,a=this.__validateAndGetQuerySelector(e);if(a&&"object"===(void 0===a?"undefined":o(a))){if(a.error)i=a.error;else{var s=a.tagName.toLowerCase();if("video"===s)e=a.src,i="For video, please use `aframe-video-shader`";else{if("img"===s)return void this.__getImageSrc(a.src,t);i="For <"+s+"> element, please use `aframe-html-shader`"}}var d,u;i&&(d=l[e],u=c(i,e),d&&d.callbacks?d.callbacks.forEach((function(e){return e(u)})):t(u),l[e]=u)}}},__getImageSrc:function(e,t){var r=this;if(e!==this.__textureSrc){var o=l[e];if(o&&o.callbacks){if(o.src)return void t(o);if(o.callbacks)return void o.callbacks.push(t)}else(o=l[e]={callbacks:[]}).callbacks.push(t);var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(function(t){r.__getUnit8Array(e,(function(t){t?(0,i.parseGIF)(t,(function(t,r,i){var n={status:"success",src:e,times:t,cnt:r,frames:i,timestamp:Date.now()};o.callbacks&&(o.callbacks.forEach((function(e){return e(n)})),l[e]=n)}),(function(e){return a(e)})):a("This is not gif. Please use `shader:flat` instead")}))})),n.addEventListener("error",(function(e){return a("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),n.src=e}function a(t){var r=c(t,e);o.callbacks&&(o.callbacks.forEach((function(e){return e(r)})),l[e]=r)}},__getUnit8Array:function(e,t){if("function"==typeof t){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.addEventListener("load",(function(e){for(var r=new Uint8Array(e.target.response),o=r.subarray(0,4),i="",n=0;n<o.length;n++)i+=o[n].toString(16);"47494638"===i?t(r):t()})),r.addEventListener("error",(function(e){t()})),r.send()}},__validateAndGetQuerySelector:function(e){try{var t=document.querySelector(e);return t||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}},__addPublicFunctions:function(){this.el.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}},pause:function(){this.__paused=!0},play:function(){this.__paused=!1},togglePlayback:function(){this.paused()?this.play():this.pause()},paused:function(){return this.__paused},nextFrame:function(){for(this.__draw();Date.now()-this.__startTime>=this.__nextFrameTime;)this.__nextFrameTime+=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)},__clearCanvas:function(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__draw:function(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0},__ready:function(e){var t=e.src,r=e.times,o=e.cnt,i=e.frames;this.__textureSrc=t,this.__delayTimes=r,o?this.__loopCnt=o:this.__infinity=!0,this.__frames=i,this.__frameCnt=r.length,this.__startTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(i[0].width),this.__height=THREE.Math.floorPowerOfTwo(i[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause()},__reset:function(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}})},function(e,t){"use strict";t.parseGIF=function(e,t,r){var o=0,i=[],n=0,a=null,s=null,l=[],c=0;if(71!==e[0]||73!==e[1]||70!==e[2]||56!==e[3]||57!==e[4]&&55!==e[4]||97!==e[5])r&&r("parseGIF: no GIF89a");else{o+=13+ +!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3;for(var d=e.subarray(0,o);e[o]&&59!==e[o];){var u=o,h=e[o];if(33===h){var p=e[++o];if(-1===[1,254,249,255].indexOf(p)){r&&r("parseGIF: unknown label");break}for(249===p&&i.push(10*(e[o+3]+(e[o+4]<<8))),255===p&&(c=e[o+15]+(e[o+16]<<8));e[++o];)o+=e[o];249===p&&(a=e.subarray(u,o+1))}else{if(44!==h){r&&r("parseGIF: unknown blockId");break}for(o+=9,o+=1+ +!!(128&e[o])*(3*Math.pow(2,1+(7&e[o])));e[++o];)o+=e[o];s=e.subarray(u,o+1);var m={disposalMethod:a[3],blob:URL.createObjectURL(new Blob([d,a,s]))};l.push(m)}o++}}if(l.length){var f=document.createElement("canvas"),g=function e(r){var o=new Image;o.onload=function(r,o){n++,l[o]=this,n===l.length?(f=null,t&&t(i,c,l)):e(++o)}.bind(o),o.src=f.toDataURL("image/gif")};l.forEach((function(e,t){var r=new Image;r.onload=function(e,t){0===t&&(f.width=r.width,f.height=r.height),n++,l[t]=this,n===l.length&&(n=0,g(1))}.bind(r,null,t),r.src=e.blob,r.disposalMethod=e.disposalMethod}))}}}]),function e(t,r,o){function i(a,s){if(!r[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var d=r[a]={exports:{}};t[a][0].call(d.exports,(function(e){var r=t[a][1][e];return i(r||e)}),d,d.exports,e,t,r,o)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<o.length;a++)i(o[a]);return i}({1:[function(e,t,r){"use strict";e("./")},{"./":2}],2:[function(e,t,r){"use strict";e("./src/controls"),e("./src/loaders"),e("./src/misc"),e("./src/pathfinding"),e("./src/primitives")},{"./src/controls":14,"./src/loaders":23,"./src/misc":28,"./src/pathfinding":34,"./src/primitives":42}],3:[function(e,t,r){"use strict";t.exports=THREE.ColladaLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,r,o){var i=this,n=void 0===i.path?THREE.LoaderUtils.extractUrlBase(e):i.path,a=new THREE.FileLoader(i.manager);a.setPath(i.path),a.load(e,(function(e){t(i.parse(e,n))}),r,o)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function r(e,t){for(var r=[],o=e.childNodes,i=0,n=o.length;i<n;i++){var a=o[i];a.nodeName===t&&r.push(a)}return r}function o(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),o=0,i=t.length;o<i;o++)r[o]=t[o];return r}function i(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),o=0,i=t.length;o<i;o++)r[o]=parseFloat(t[o]);return r}function n(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),o=0,i=t.length;o<i;o++)r[o]=parseInt(t[o]);return r}function a(e){return e.substring(1)}function s(e){return 0===Object.keys(e).length}function l(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function c(e){return void 0!==e?e.textContent:"Y_UP"}function d(e,t,o,i){var n=r(e,t)[0];if(void 0!==n)for(var a=r(n,o),s=0;s<a.length;s++)i(a[s])}function u(e,t){for(var r in e){e[r].build=t(e[r])}}function h(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function p(e){for(var t={inputs:{}},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"input":var n=a(i.getAttribute("source")),s=i.getAttribute("semantic");t.inputs[s]=n}}return t}function m(e){var t={},r=e.getAttribute("target").split("/"),o=r.shift(),i=r.shift(),n=-1!==i.indexOf("("),s=-1!==i.indexOf(".");if(s)r=i.split("."),i=r.shift(),t.member=r.shift();else if(n){var l=i.split("(");i=l.shift();for(var c=0;c<l.length;c++)l[c]=parseInt(l[c].replace(/\)/,""));t.indices=l}return t.id=o,t.sid=i,t.arraySyntax=n,t.memberSyntax=s,t.sampler=a(e.getAttribute("source")),t}function f(e){var t=[],r=e.channels,o=e.samplers,i=e.sources;for(var n in r)if(r.hasOwnProperty(n)){var a=r[n],s=o[a.sampler],l=s.inputs.INPUT,c=s.inputs.OUTPUT;w(b(a,i[l],i[c]),t)}return t}function g(e){return h(We.animations[e],f)}function b(e,t,r){var o,i,n,a,s,l,c=We.nodes[e.id],d=He(c.id),u=c.transforms[e.sid],h=c.matrix.clone().transpose(),p={};switch(u){case"matrix":for(n=0,a=t.array.length;n<a;n++)if(o=t.array[n],i=n*r.stride,void 0===p[o]&&(p[o]={}),!0===e.arraySyntax){var m=r.array[i],f=e.indices[0]+4*e.indices[1];p[o][f]=m}else for(s=0,l=r.stride;s<l;s++)p[o][s]=r.array[i+s];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u)}var g=function(e,t){var r=[];for(var o in e)r.push({time:parseFloat(o),value:e[o]});r.sort(n);for(var i=0;i<16;i++)E(r,i,t.elements[i]);return r;function n(e,t){return e.time-t.time}}(p,h);return{name:d.uuid,keyframes:g}}var _=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Quaternion;function w(e,t){for(var r=e.keyframes,o=e.name,i=[],n=[],a=[],s=[],l=0,c=r.length;l<c;l++){var d=r[l],u=d.time,h=d.value;Te.fromArray(h).transpose(),Te.decompose(_,y,v),i.push(u),n.push(_.x,_.y,_.z),a.push(y.x,y.y,y.z,y.w),s.push(v.x,v.y,v.z)}return n.length>0&&t.push(new THREE.VectorKeyframeTrack(o+".position",i,n)),a.length>0&&t.push(new THREE.QuaternionKeyframeTrack(o+".quaternion",i,a)),s.length>0&&t.push(new THREE.VectorKeyframeTrack(o+".scale",i,s)),t}function E(e,t,r){var o,i,n,a=!0;for(i=0,n=e.length;i<n;i++)void 0===(o=e[i]).value[t]?o.value[t]=null:a=!1;if(!0===a)for(i=0,n=e.length;i<n;i++)(o=e[i]).value[t]=r;else!function(e,t){for(var r,o,i=0,n=e.length;i<n;i++){var a=e[i];if(null===a.value[t]){if(r=j(e,i,t),o=T(e,i,t),null===r){a.value[t]=o.value[t];continue}if(null===o){a.value[t]=r.value[t];continue}x(a,r,o,t)}}}(e,t)}function j(e,t,r){for(;t>=0;){var o=e[t];if(null!==o.value[r])return o;t--}return null}function T(e,t,r){for(;t<e.length;){var o=e[t];if(null!==o.value[r])return o;t++}return null}function x(e,t,r,o){r.time-t.time!=0?e.value[o]=(e.time-t.time)*(r.value[o]-t.value[o])/(r.time-t.time)+t.value[o]:e.value[o]=t.value[o]}function k(e){for(var t=[],r=e.name,o=e.end-e.start||-1,i=e.animations,n=0,a=i.length;n<a;n++)for(var s=g(i[n]),l=0,c=s.length;l<c;l++)t.push(s[l]);return new THREE.AnimationClip(r,o,t)}function A(e){return h(We.clips[e],k)}function S(e){for(var t={sources:{}},r=0,o=e.childNodes.length;r<o;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=i(n.textContent);break;case"source":var a=n.getAttribute("id");t.sources[a]=ie(n);break;case"joints":t.joints=D(n);break;case"vertex_weights":t.vertexWeights=R(n)}}return t}function D(e){for(var t={inputs:{}},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"input":var n=i.getAttribute("semantic"),s=a(i.getAttribute("source"));t.inputs[n]=s}}return t}function R(e){for(var t={inputs:{}},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"input":var s=i.getAttribute("semantic"),l=a(i.getAttribute("source")),c=parseInt(i.getAttribute("offset"));t.inputs[s]={id:l,offset:c};break;case"vcount":t.vcount=n(i.textContent);break;case"v":t.v=n(i.textContent)}}return t}function C(e){var t={id:e.id},r=We.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){var t,r,o,i=4,n={joints:[],indices:{array:[],stride:i},weights:{array:[],stride:i}},a=e.sources,s=e.vertexWeights,l=s.vcount,c=s.v,d=s.inputs.JOINT.offset,u=s.inputs.WEIGHT.offset,h=e.sources[e.joints.inputs.JOINT],p=e.sources[e.joints.inputs.INV_BIND_MATRIX],m=a[s.inputs.WEIGHT.id].array,f=0;for(t=0,o=l.length;t<o;t++){var g=l[t],b=[];for(r=0;r<g;r++){var _=c[f+d],v=m[c[f+u]];b.push({index:_,weight:v}),f+=2}for(b.sort(j),r=0;r<i;r++){var y=b[r];void 0!==y?(n.indices.array.push(y.index),n.weights.array.push(y.weight)):(n.indices.array.push(0),n.weights.array.push(0))}}e.bindShapeMatrix?n.bindMatrix=(new THREE.Matrix4).fromArray(e.bindShapeMatrix).transpose():n.bindMatrix=(new THREE.Matrix4).identity();for(t=0,o=h.array.length;t<o;t++){var w=h.array[t],E=(new THREE.Matrix4).fromArray(p.array,t*p.stride).transpose();n.joints.push({name:w,boneInverse:E})}return n;function j(e,t){return t.weight-e.weight}}(e.skin),r.sources.skinIndices=t.skin.indices,r.sources.skinWeights=t.skin.weights),t}function M(e){return void 0!==e.build?e.build:e.init_from}function I(e){var t=We.images[e];return void 0!==t?h(t,M):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function P(e){for(var t={surfaces:{},samplers:{}},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"newparam":H(i,t);break;case"technique":t.technique=N(i);break;case"extra":t.extra=G(i)}}return t}function H(e,t){for(var r=e.getAttribute("sid"),o=0,i=e.childNodes.length;o<i;o++){var n=e.childNodes[o];if(1===n.nodeType)switch(n.nodeName){case"surface":t.surfaces[r]=O(n);break;case"sampler2D":t.samplers[r]=L(n)}}}function O(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"init_from":t.init_from=i.textContent}}return t}function L(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"source":t.source=i.textContent}}return t}function N(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=i.nodeName,t.parameters=F(i)}}return t}function F(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[i.nodeName]=B(i);break;case"transparent":t[i.nodeName]={opaque:i.getAttribute("opaque"),data:B(i)}}}return t}function B(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":t[n.nodeName]=i(n.textContent);break;case"float":t[n.nodeName]=parseFloat(n.textContent);break;case"texture":t[n.nodeName]={id:n.getAttribute("texture"),extra:V(n)}}}return t}function V(e){for(var t={technique:{}},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"extra":z(i,t)}}return t}function z(e,t){for(var r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"technique":U(i,t)}}}function U(e,t){for(var r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?t.technique[i.nodeName]=1:"FALSE"===i.textContent.toUpperCase()?t.technique[i.nodeName]=0:t.technique[i.nodeName]=parseInt(i.textContent)}}}function G(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"technique":t.technique=q(i)}}return t}function q(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"double_sided":t[i.nodeName]=parseInt(i.textContent)}}return t}function W(e){return e}function K(e){var t,r,o=(t=e.url,h(We.effects[t],W)),i=o.profile.technique,n=o.profile.extra;switch(i.type){case"phong":case"blinn":r=new THREE.MeshPhongMaterial;break;case"lambert":r=new THREE.MeshLambertMaterial;break;default:r=new THREE.MeshBasicMaterial}function a(e){var t=o.profile.samplers[e.id],r=null;void 0!==t?r=I(o.profile.surfaces[t.source].init_from):(console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),r=I(e.id));if(null!==r){var i=function(e){var t,r=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(r=r.toLowerCase()){case"tga":t=Be;break;default:t=ze}return t}(r);if(void 0!==i){var n=i.load(r),a=e.extra;if(void 0!==a&&void 0!==a.technique&&!1===s(a.technique)){var l=a.technique;n.wrapS=l.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.wrapT=l.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.offset.set(l.offsetU||0,l.offsetV||0),n.repeat.set(l.repeatU||1,l.repeatV||1)}else n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping;return n}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",r),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",e.id),null}r.name=e.name;var l=i.parameters;for(var c in l){var d=l[c];switch(c){case"diffuse":d.color&&r.color.fromArray(d.color),d.texture&&(r.map=a(d.texture));break;case"specular":d.color&&r.specular&&r.specular.fromArray(d.color),d.texture&&(r.specularMap=a(d.texture));break;case"bump":d.texture&&(r.normalMap=a(d.texture));break;case"ambient":d.texture&&(r.lightMap=a(d.texture));break;case"shininess":d.float&&r.shininess&&(r.shininess=d.float);break;case"emission":d.color&&r.emissive&&r.emissive.fromArray(d.color),d.texture&&(r.emissiveMap=a(d.texture))}}var u=l.transparent,p=l.transparency;if(void 0===p&&u&&(p={float:1}),void 0===u&&p&&(u={opaque:"A_ONE",data:{color:[1,1,1,1]}}),u&&p)if(u.data.texture)r.transparent=!0;else{var m=u.data.color;switch(u.opaque){case"A_ONE":r.opacity=m[3]*p.float;break;case"RGB_ZERO":r.opacity=1-m[0]*p.float;break;case"A_ZERO":r.opacity=1-m[3]*p.float;break;case"RGB_ONE":r.opacity=m[0]*p.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',u.opaque)}r.opacity<1&&(r.transparent=!0)}return void 0!==n&&void 0!==n.technique&&1===n.technique.double_sided&&(r.side=THREE.DoubleSide),r}function Q(e){return h(We.materials[e],K)}function X(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"technique_common":return J(r)}}return{}}function J(e){for(var t={},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];switch(o.nodeName){case"perspective":case"orthographic":t.technique=o.nodeName,t.parameters=Y(o)}}return t}function Y(e){for(var t={},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];switch(o.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[o.nodeName]=parseFloat(o.textContent)}}return t}function Z(e){var t;switch(e.optics.technique){case"perspective":t=new THREE.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":var r=e.optics.parameters.ymag,o=e.optics.parameters.xmag,i=e.optics.parameters.aspect_ratio;o=void 0===o?r*i:o,r=void 0===r?o/i:r,o*=.5,r*=.5,t=new THREE.OrthographicCamera(-o,o,r,-r,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new THREE.PerspectiveCamera}return t.name=e.name,t}function $(e){var t=We.cameras[e];return void 0!==t?h(t,Z):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function ee(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=i.nodeName,t.parameters=te(i)}}return t}function te(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":var a=i(n.textContent);t.color=(new THREE.Color).fromArray(a);break;case"falloff_angle":t.falloffAngle=parseFloat(n.textContent);break;case"quadratic_attenuation":var s=parseFloat(n.textContent);t.distance=s?Math.sqrt(1/s):0}}return t}function re(e){var t;switch(e.technique){case"directional":t=new THREE.DirectionalLight;break;case"point":t=new THREE.PointLight;break;case"spot":t=new THREE.SpotLight;break;case"ambient":t=new THREE.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function oe(e){var t=We.lights[e];return void 0!==t?h(t,re):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function ie(e){for(var t={array:[],stride:3},n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=i(a.textContent);break;case"Name_array":t.array=o(a.textContent);break;case"technique_common":var s=r(a,"accessor")[0];void 0!==s&&(t.stride=parseInt(s.getAttribute("stride")))}}return t}function ne(e){for(var t={},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];1===o.nodeType&&(t[o.getAttribute("semantic")]=a(o.getAttribute("source")))}return t}function ae(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"input":var s=a(i.getAttribute("source")),l=i.getAttribute("semantic"),c=parseInt(i.getAttribute("offset")),d=parseInt(i.getAttribute("set")),u=d>0?l+d:l;t.inputs[u]={id:s,offset:c},t.stride=Math.max(t.stride,c+1),"TEXCOORD"===l&&(t.hasUV=!0);break;case"vcount":t.vcount=n(i.textContent);break;case"p":t.p=n(i.textContent)}}return t}function se(e){for(var t=0,r=0,o=e.length;r<o;r++){!0===e[r].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function le(e){var t={},r=e.sources,o=e.vertices,i=e.primitives;if(0===i.length)return{};var n=function(e){for(var t={},r=0;r<e.length;r++){var o=e[r];void 0===t[o.type]&&(t[o.type]=[]),t[o.type].push(o)}return t}(i);for(var a in n){var s=n[a];se(s),t[a]=ce(s,r,o)}return t}function ce(e,t,r){for(var o={},i={array:[],stride:0},n={array:[],stride:0},a={array:[],stride:0},s={array:[],stride:0},l={array:[],stride:0},c=[],d=4,u=[],h=4,p=new THREE.BufferGeometry,m=[],f=0,g=0;g<e.length;g++){var b=e[g],_=b.inputs,v=0;switch(b.type){case"lines":case"linestrips":v=2*b.count;break;case"triangles":v=3*b.count;break;case"polylist":for(var y=0;y<b.count;y++){var w=b.vcount[y];switch(w){case 3:v+=3;break;case 4:v+=6;break;default:v+=3*(w-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",b.type)}for(var E in p.addGroup(f,v,g),f+=v,b.material&&m.push(b.material),_){var j=_[E];switch(E){case"VERTEX":for(var T in r){var x=r[T];switch(T){case"POSITION":var k=i.array.length;if(de(b,t[x],j.offset,i.array),i.stride=t[x].stride,t.skinWeights&&t.skinIndices&&(de(b,t.skinIndices,j.offset,c),de(b,t.skinWeights,j.offset,u)),!1===b.hasUV&&!0===e.uvsNeedsFix){v=(i.array.length-k)/i.stride;for(var A=0;A<v;A++)a.array.push(0,0)}break;case"NORMAL":de(b,t[x],j.offset,n.array),n.stride=t[x].stride;break;case"COLOR":de(b,t[x],j.offset,l.array),l.stride=t[x].stride;break;case"TEXCOORD":de(b,t[x],j.offset,a.array),a.stride=t[x].stride;break;case"TEXCOORD1":de(b,t[x],j.offset,s.array),a.stride=t[x].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',T)}}break;case"NORMAL":de(b,t[j.id],j.offset,n.array),n.stride=t[j.id].stride;break;case"COLOR":de(b,t[j.id],j.offset,l.array),l.stride=t[j.id].stride;break;case"TEXCOORD":de(b,t[j.id],j.offset,a.array),a.stride=t[j.id].stride;break;case"TEXCOORD1":de(b,t[j.id],j.offset,s.array),s.stride=t[j.id].stride}}}return i.array.length>0&&p.addAttribute("position",new THREE.Float32BufferAttribute(i.array,i.stride)),n.array.length>0&&p.addAttribute("normal",new THREE.Float32BufferAttribute(n.array,n.stride)),l.array.length>0&&p.addAttribute("color",new THREE.Float32BufferAttribute(l.array,l.stride)),a.array.length>0&&p.addAttribute("uv",new THREE.Float32BufferAttribute(a.array,a.stride)),s.array.length>0&&p.addAttribute("uv2",new THREE.Float32BufferAttribute(s.array,s.stride)),c.length>0&&p.addAttribute("skinIndex",new THREE.Float32BufferAttribute(c,d)),u.length>0&&p.addAttribute("skinWeight",new THREE.Float32BufferAttribute(u,h)),o.data=p,o.type=e[0].type,o.materialKeys=m,o}function de(e,t,r,o){var i=e.p,n=e.stride,a=e.vcount;function s(e){for(var t=i[e+r]*c,n=t+c;t<n;t++)o.push(l[t])}var l=t.array,c=t.stride;if(void 0!==e.vcount)for(var d=0,u=0,h=a.length;u<h;u++){var p=a[u];if(4===p){var m=d+1*n,f=d+2*n,g=d+3*n;s(d+0*n),s(m),s(g),s(m),s(f),s(g)}else if(3===p){m=d+1*n,f=d+2*n;s(d+0*n),s(m),s(f)}else if(p>4)for(var b=1,_=p-2;b<=_;b++){m=d+n*b,f=d+n*(b+1);s(d+0*n),s(m),s(f)}d+=n*p}else for(u=0,h=i.length;u<h;u+=n)s(u)}function ue(e){return h(We.geometries[e],le)}function he(e){return void 0!==e.build?e.build:e}function pe(e,t){for(var r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"joint":t.joints[o.getAttribute("sid")]=me(o);break;case"link":t.links.push(ge(o))}}}function me(e){for(var t,r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"prismatic":case"revolute":t=fe(o)}}return t}function fe(e,t){t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(var r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"axis":var n=i(o.textContent);t.axis.fromArray(n);break;case"limits":var a=o.getElementsByTagName("max")[0],s=o.getElementsByTagName("min")[0];t.limits.max=parseFloat(a.textContent),t.limits.min=parseFloat(s.textContent)}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function ge(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"attachment_full":t.attachments.push(be(o));break;case"matrix":case"translate":case"rotate":t.transforms.push(_e(o))}}return t}function be(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"link":t.links.push(ge(o));break;case"matrix":case"translate":case"rotate":t.transforms.push(_e(o))}}return t}function _e(e){var t={type:e.nodeName},r=i(e.textContent);switch(t.type){case"matrix":t.obj=new THREE.Matrix4,t.obj.fromArray(r).transpose();break;case"translate":t.obj=new THREE.Vector3,t.obj.fromArray(r);break;case"rotate":t.obj=new THREE.Vector3,t.obj.fromArray(r),t.angle=THREE.Math.degToRad(r[3])}return t}function ve(e,t){for(var r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"technique_common":ye(o,t)}}}function ye(e,t){for(var r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"inertia":t.inertia=i(o.textContent);break;case"mass":t.mass=i(o.textContent)[0]}}}function we(e){for(var t={target:e.getAttribute("target").split("/").pop()},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"axis":var i=o.getElementsByTagName("param")[0];t.axis=i.textContent;var n=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=n.substr(0,n.length-1)}}return t}function Ee(e){return void 0!==e.build?e.build:e}function je(e){for(var t=[],r=Ne.querySelector('[id="'+e.id+'"]'),o=0;o<r.childNodes.length;o++){var n=r.childNodes[o];if(1===n.nodeType)switch(n.nodeName){case"matrix":var a=i(n.textContent),s=(new THREE.Matrix4).fromArray(a).transpose();t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:s});break;case"translate":case"scale":a=i(n.textContent);var l=(new THREE.Vector3).fromArray(a);t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:l});break;case"rotate":a=i(n.textContent),l=(new THREE.Vector3).fromArray(a);var c=THREE.Math.degToRad(a[3]);t.push({sid:n.getAttribute("sid"),type:n.nodeName,obj:l,angle:c})}}return t}var Te=new THREE.Matrix4,xe=new THREE.Vector3;function ke(e){for(var t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"node":t.nodes.push(o.getAttribute("id")),ke(o);break;case"instance_camera":t.instanceCameras.push(a(o.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(Ae(o));break;case"instance_light":t.instanceLights.push(a(o.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(Ae(o));break;case"instance_node":t.instanceNodes.push(a(o.getAttribute("url")));break;case"matrix":var n=i(o.textContent);t.matrix.multiply(Te.fromArray(n).transpose()),t.transforms[o.getAttribute("sid")]=o.nodeName;break;case"translate":n=i(o.textContent);xe.fromArray(n),t.matrix.multiply(Te.makeTranslation(xe.x,xe.y,xe.z)),t.transforms[o.getAttribute("sid")]=o.nodeName;break;case"rotate":n=i(o.textContent);var s=THREE.Math.degToRad(n[3]);t.matrix.multiply(Te.makeRotationAxis(xe.fromArray(n),s)),t.transforms[o.getAttribute("sid")]=o.nodeName;break;case"scale":n=i(o.textContent);t.matrix.scale(xe.fromArray(n)),t.transforms[o.getAttribute("sid")]=o.nodeName;break;case"extra":break;default:console.log(o)}}return Pe(t.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",t.id):We.nodes[t.id]=t,t}function Ae(e){for(var t={id:a(e.getAttribute("url")),materials:{},skeletons:[]},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];switch(o.nodeName){case"bind_material":for(var i=o.getElementsByTagName("instance_material"),n=0;n<i.length;n++){var s=i[n],l=s.getAttribute("symbol"),c=s.getAttribute("target");t.materials[l]=a(c)}break;case"skeleton":t.skeletons.push(a(o.textContent))}}return t}function Se(e,t){var r,o,i,n=[],a=[];for(r=0;r<e.length;r++){var s=e[r];if(Pe(s))De(He(s),t,n);else if(i=s,void 0!==We.visualScenes[i])for(var l=We.visualScenes[s].children,c=0;c<l.length;c++){var d=l[c];if("JOINT"===d.type)De(He(d.id),t,n)}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",s)}for(r=0;r<t.length;r++)for(c=0;c<n.length;c++)if((o=n[c]).bone.name===t[r].name){a[r]=o,o.processed=!0;break}for(r=0;r<n.length;r++)!1===(o=n[r]).processed&&(a.push(o),o.processed=!0);var u=[],h=[];for(r=0;r<a.length;r++)o=a[r],u.push(o.bone),h.push(o.boneInverse);return new THREE.Skeleton(u,h)}function De(e,t,r){e.traverse((function(e){if(!0===e.isBone){for(var o,i=0;i<t.length;i++){var n=t[i];if(n.name===e.name){o=n.boneInverse;break}}void 0===o&&(o=new THREE.Matrix4),r.push({bone:e,boneInverse:o,processed:!1})}}))}function Re(e){for(var t,r=[],o=e.matrix,i=e.nodes,n=e.type,a=e.instanceCameras,s=e.instanceControllers,l=e.instanceLights,c=e.instanceGeometries,d=e.instanceNodes,u=0,p=i.length;u<p;u++)r.push(He(i[u]));for(u=0,p=a.length;u<p;u++){var m=$(a[u]);null!==m&&r.push(m.clone())}for(u=0,p=s.length;u<p;u++)for(var f=s[u],g=(t=f.id,h(We.controllers[t],C)),b=Ie(ue(g.id),f.materials),_=Se(f.skeletons,g.skin.joints),v=0,y=b.length;v<y;v++){var w;(w=b[v]).isSkinnedMesh&&(w.bind(_,g.skin.bindMatrix),w.normalizeSkinWeights()),r.push(w)}for(u=0,p=l.length;u<p;u++){var E=oe(l[u]);null!==E&&r.push(E.clone())}for(u=0,p=c.length;u<p;u++)for(v=0,y=(b=Ie(ue((f=c[u]).id),f.materials)).length;v<y;v++)r.push(b[v]);for(u=0,p=d.length;u<p;u++)r.push(He(d[u]).clone());if(0===i.length&&1===r.length)w=r[0];else{w="JOINT"===n?new THREE.Bone:new THREE.Group;for(u=0;u<r.length;u++)w.add(r[u])}return""===w.name&&(w.name="JOINT"===n?e.sid:e.name),w.matrix.copy(o),w.matrix.decompose(w.position,w.quaternion,w.scale),w}var Ce=new THREE.MeshBasicMaterial({color:16711935});function Me(e,t){for(var r=[],o=0,i=e.length;o<i;o++){var n=t[e[o]];void 0===n?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[o]),r.push(Ce)):r.push(Q(n))}return r}function Ie(e,t){var r=[];for(var o in e){var i=e[o],n=Me(i.materialKeys,t);0===n.length&&("lines"===o||"linestrips"===o?n.push(new THREE.LineBasicMaterial):n.push(new THREE.MeshPhongMaterial));var a=void 0!==i.data.attributes.skinIndex;if(a)for(var s=0,l=n.length;s<l;s++)n[s].skinning=!0;var c,d=1===n.length?n[0]:n;switch(o){case"lines":c=new THREE.LineSegments(i.data,d);break;case"linestrips":c=new THREE.Line(i.data,d);break;case"triangles":case"polylist":c=a?new THREE.SkinnedMesh(i.data,d):new THREE.Mesh(i.data,d)}r.push(c)}return r}function Pe(e){return void 0!==We.nodes[e]}function He(e){return h(We.nodes[e],Re)}function Oe(e){var t=new THREE.Group;t.name=e.name;for(var r=e.children,o=0;o<r.length;o++){var i=r[o];t.add(He(i.id))}return t}function Le(e){return h(We.visualScenes[e],Oe)}if(0===e.length)return{scene:new THREE.Scene};var Ne=r((new DOMParser).parseFromString(e,"application/xml"),"COLLADA")[0],Fe=Ne.getAttribute("version");console.log("THREE.ColladaLoader: File version",Fe);var Be,Ve=function(e){return{unit:l(r(e,"unit")[0]),upAxis:c(r(e,"up_axis")[0])}}(r(Ne,"asset")[0]),ze=new THREE.TextureLoader(this.manager);ze.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin),THREE.TGALoader&&(Be=new THREE.TGALoader(this.manager)).setPath(this.resourcePath||t);var Ue=[],Ge={},qe=0,We={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};d(Ne,"library_animations","animation",(function(e){for(var t={sources:{},samplers:{},channels:{}},r=0,o=e.childNodes.length;r<o;r++){var i,n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"source":i=n.getAttribute("id"),t.sources[i]=ie(n);break;case"sampler":i=n.getAttribute("id"),t.samplers[i]=p(n);break;case"channel":i=n.getAttribute("target"),t.channels[i]=m(n);break;default:console.log(n)}}We.animations[e.getAttribute("id")]=t})),d(Ne,"library_animation_clips","animation_clip",(function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"instance_animation":t.animations.push(a(i.getAttribute("url")))}}We.clips[e.getAttribute("id")]=t})),d(Ne,"library_controllers","controller",(function(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"skin":t.id=a(i.getAttribute("source")),t.skin=S(i);break;case"morph":t.id=a(i.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}We.controllers[e.getAttribute("id")]=t})),d(Ne,"library_images","image",(function(e){var t={init_from:r(e,"init_from")[0].textContent};We.images[e.getAttribute("id")]=t})),d(Ne,"library_effects","effect",(function(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"profile_COMMON":t.profile=P(i)}}We.effects[e.getAttribute("id")]=t})),d(Ne,"library_materials","material",(function(e){for(var t={name:e.getAttribute("name")},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"instance_effect":t.url=a(i.getAttribute("url"))}}We.materials[e.getAttribute("id")]=t})),d(Ne,"library_cameras","camera",(function(e){for(var t={name:e.getAttribute("name")},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"optics":t.optics=X(i)}}We.cameras[e.getAttribute("id")]=t})),d(Ne,"library_lights","light",(function(e){for(var t={},r=0,o=e.childNodes.length;r<o;r++){var i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"technique_common":t=ee(i)}}We.lights[e.getAttribute("id")]=t})),d(Ne,"library_geometries","geometry",(function(e){var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},o=r(e,"mesh")[0];if(void 0!==o){for(var i=0;i<o.childNodes.length;i++){var n=o.childNodes[i];if(1===n.nodeType){var a=n.getAttribute("id");switch(n.nodeName){case"source":t.sources[a]=ie(n);break;case"vertices":t.vertices=ne(n);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",n.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ae(n));break;default:console.log(n)}}}We.geometries[e.getAttribute("id")]=t}})),d(Ne,"library_nodes","node",ke),d(Ne,"library_visual_scenes","visual_scene",(function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),r=0;r<t.length;r++){var o=t[r];!1===o.hasAttribute("id")&&o.setAttribute("id","three_default_"+qe++)}}(e);for(var o=r(e,"node"),i=0;i<o.length;i++)t.children.push(ke(o[i]));We.visualScenes[e.getAttribute("id")]=t})),d(Ne,"library_kinematics_models","kinematics_model",(function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"technique_common":pe(o,t)}}We.kinematicsModels[e.getAttribute("id")]=t})),d(Ne,"library_physics_models","physics_model",(function(e){for(var t={name:e.getAttribute("name")||"",rigidBodies:{}},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"rigid_body":t.rigidBodies[o.getAttribute("name")]={},ve(o,t.rigidBodies[o.getAttribute("name")])}}We.physicsModels[e.getAttribute("id")]=t})),d(Ne,"scene","instance_kinematics_scene",(function(e){for(var t={bindJointAxis:[]},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"bind_joint_axis":t.bindJointAxis.push(we(o))}}We.kinematicsScenes[a(e.getAttribute("url"))]=t})),u(We.animations,f),u(We.clips,k),u(We.controllers,C),u(We.images,M),u(We.effects,W),u(We.materials,K),u(We.cameras,Z),u(We.lights,re),u(We.geometries,le),u(We.visualScenes,Oe),function(){var e=We.clips;if(!0===s(e)){if(!1===s(We.animations)){var t=[];for(var r in We.animations)for(var o=g(r),i=0,n=o.length;i<n;i++)t.push(o[i]);Ue.push(new THREE.AnimationClip("default",-1,t))}}else for(var r in e)Ue.push(A(r))}(),function(){var e=Object.keys(We.kinematicsModels)[0],t=Object.keys(We.kinematicsScenes)[0],r=Object.keys(We.visualScenes)[0];if(void 0!==e&&void 0!==t){for(var o,i=(o=e,h(We.kinematicsModels[o],he)),n=function(e){return h(We.kinematicsScenes[e],Ee)}(t),a=Le(r),s=n.bindJointAxis,l={},c=0,d=s.length;c<d;c++){var u=s[c],p=Ne.querySelector('[sid="'+u.target+'"]');if(p){var m=p.parentElement;g(u.jointIndex,m)}}var f=new THREE.Matrix4;Ge={joints:i&&i.joints,getJointValue:function(e){var t=l[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){var r=l[e];if(r){var o=r.joint;if(t>o.limits.max||t<o.limits.min)console.warn("THREE.ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+o.limits.min+", max: "+o.limits.max+").");else if(o.static)console.warn("THREE.ColladaLoader: Joint "+e+" is static.");else{var i=r.object,n=o.axis,a=r.transforms;Te.identity();for(var s=0;s<a.length;s++){var c=a[s];if(c.sid&&-1!==c.sid.indexOf(e))switch(o.type){case"revolute":Te.multiply(f.makeRotationAxis(n,THREE.Math.degToRad(t)));break;case"prismatic":Te.multiply(f.makeTranslation(n.x*t,n.y*t,n.z*t));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+o.type)}else switch(c.type){case"matrix":Te.multiply(c.obj);break;case"translate":Te.multiply(f.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"scale":Te.scale(c.obj);break;case"rotate":Te.multiply(f.makeRotationAxis(c.obj,c.angle))}}i.matrix.copy(Te),i.matrix.decompose(i.position,i.quaternion,i.scale),l[e].position=t}}else console.log("THREE.ColladaLoader: "+e+" does not exist.")}}}function g(e,t){var r=t.getAttribute("name"),o=i.joints[e];a.traverse((function(i){i.name===r&&(l[e]={object:i,transforms:je(t),joint:o,position:o.zeroPosition})}))}}();var Ke=function(e){return Le(a(r(e,"instance_visual_scene")[0].getAttribute("url")))}(r(Ne,"scene")[0]);return"Z_UP"===Ve.upAxis&&Ke.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0)),Ke.scale.multiplyScalar(Ve.unit),{animations:Ue,kinematics:Ge,library:We,scene:Ke}}}},{}],4:[function(e,t,r){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};"function"==typeof Symbol&&o(Symbol.iterator);t.exports=THREE.FBXLoader=function(){var e,t,r;function o(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function i(e){this.textureLoader=e}function n(){}function a(){}function s(){}function l(){}function c(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function d(){}function u(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function h(e){return e/46186158e3}o.prototype={constructor:o,crossOrigin:"anonymous",load:function(e,t,r,o){var i=this,n=void 0===i.path?THREE.LoaderUtils.extractUrlBase(e):i.path,a=new THREE.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.load(e,(function(r){try{t(i.parse(r,n))}catch(t){setTimeout((function(){o&&o(t),i.manager.itemError(e)}),0)}}),r,o)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(t,r){if(a="Kaydara FBX Binary  \0",(n=t).byteLength>=a.length&&a===y(n,0,a.length))e=(new l).parse(t);else{var o=y(t);if(!function(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],r=0;function o(t){var o=e[t-1];return e=e.slice(r+t),r++,o}for(var i=0;i<t.length;++i){if(o(1)===t[i])return!1}return!0}(o))throw new Error("THREE.FBXLoader: Unknown format.");if(u(o)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+u(o));e=(new s).parse(o)}var n,a;return new i(new THREE.TextureLoader(this.manager).setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin)).parse(e)}},i.prototype={constructor:i,parse:function(){t=this.parseConnections();var o=this.parseImages(),i=this.parseTextures(o),a=this.parseMaterials(i),s=this.parseDeformers(),l=(new n).parse(s);return this.parseScene(s,l,a),e&&e.FBXHeaderExtension&&e.FBXHeaderExtension.SceneInfo&&e.FBXHeaderExtension.SceneInfo["LastSaved|ApplicationName"]&&(r["LastSaved|ApplicationName"]||(r["LastSaved|ApplicationName"]=e.FBXHeaderExtension.SceneInfo["LastSaved|ApplicationName"])),e&&e.GlobalSettings&&e.GlobalSettings.OriginalUnitScaleFactor&&e.GlobalSettings.OriginalUnitScaleFactor.value&&(r.OriginalUnitScaleFactor||(r.OriginalUnitScaleFactor=e.GlobalSettings.OriginalUnitScaleFactor.value)),r},parseConnections:function(){var t=new Map;"Connections"in e&&e.Connections.connections.forEach((function(e){var r=e[0],o=e[1],i=e[2];t.has(r)||t.set(r,{parents:[],children:[]});var n={ID:o,relationship:i};t.get(r).parents.push(n),t.has(o)||t.set(o,{parents:[],children:[]});var a={ID:r,relationship:i};t.get(o).children.push(a)}));return t},parseImages:function(){var t={},r={};if("Video"in e.Objects){var o=e.Objects.Video;for(var i in o){var n=o[i];if(t[c=parseInt(i)]=n.RelativeFilename||n.Filename,"Content"in n){var a=n.Content instanceof ArrayBuffer&&n.Content.byteLength>0,s="string"==typeof n.Content&&""!==n.Content;if(a||s){var l=this.parseImage(o[i]);r[n.RelativeFilename||n.Filename]=l}}}}for(var c in t){var d=t[c];void 0!==r[d]?t[c]=r[d]:t[c]=t[c].split("\\").pop()}return t},parseImage:function(e){var t,r=e.Content,o=e.RelativeFilename||e.Filename,i=o.slice(o.lastIndexOf(".")+1).toLowerCase();switch(i){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if("function"!=typeof THREE.TGALoader)return void console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");if(null===THREE.Loader.Handlers.get(".tga")){var n=new THREE.TGALoader;n.setPath(this.textureLoader.path),THREE.Loader.Handlers.add(/\.tga$/i,n)}t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"==typeof r)return"data:"+t+";base64,"+r;var a=new Uint8Array(r);return window.URL.createObjectURL(new Blob([a],{type:t}))},parseTextures:function(t){var r=new Map;if("Texture"in e.Objects){var o=e.Objects.Texture;for(var i in o){var n=this.parseTexture(o[i],t);r.set(parseInt(i),n)}}return r},parseTexture:function(e,t){var r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;var o=e.WrapModeU,i=e.WrapModeV,n=void 0!==o?o.value:0,a=void 0!==i?i.value:0;if(r.wrapS=0===n?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,r.wrapT=0===a?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in e){var s=e.Scaling.value;r.repeat.x=s[0],r.repeat.y=s[1]}return r},loadTexture:function(e,r){var o,i,n=this.textureLoader.path,a=t.get(e.id).children;void 0!==a&&a.length>0&&void 0!==r[a[0].ID]&&(0!==(o=r[a[0].ID]).indexOf("blob:")&&0!==o.indexOf("data:")||this.textureLoader.setPath(void 0));var s=e.FileName.slice(-3).toLowerCase();if("tga"===s){var l=THREE.Loader.Handlers.get(".tga");null===l?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",o),i=new THREE.Texture):i=l.load(o)}else"psd"===s?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",o),i=new THREE.Texture):i=this.textureLoader.load(o);return this.textureLoader.setPath(n),i},parseMaterials:function(t){var r=new Map;if("Material"in e.Objects){var o=e.Objects.Material;for(var i in o){var n=this.parseMaterial(o[i],t);null!==n&&r.set(parseInt(i),n)}}return r},parseMaterial:function(e,r){var o=e.id,i=e.attrName,n=e.ShadingModel;if("object"==typeof n&&(n=n.value),!t.has(o))return null;var a,s=this.parseParameters(e,r,o);switch(n.toLowerCase()){case"phong":a=new THREE.MeshPhongMaterial;break;case"lambert":a=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',n),a=new THREE.MeshPhongMaterial({color:3342591})}return a.setValues(s),a.name=i,a},parseParameters:function(e,r,o){var i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new THREE.Color).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(i.color=(new THREE.Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new THREE.Color).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(i.emissive=(new THREE.Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new THREE.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new THREE.Color).fromArray(e.SpecularColor.value));var n=this;return t.get(o).children.forEach((function(e){var t=e.relationship;switch(t){case"Bump":i.bumpMap=n.getTexture(r,e.ID);break;case"DiffuseColor":i.map=n.getTexture(r,e.ID);break;case"DisplacementColor":i.displacementMap=n.getTexture(r,e.ID);break;case"EmissiveColor":i.emissiveMap=n.getTexture(r,e.ID);break;case"NormalMap":i.normalMap=n.getTexture(r,e.ID);break;case"ReflectionColor":i.envMap=n.getTexture(r,e.ID),i.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":i.specularMap=n.getTexture(r,e.ID);break;case"TransparentColor":i.alphaMap=n.getTexture(r,e.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",t)}})),i},getTexture:function(r,o){return"LayeredTexture"in e.Objects&&o in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),o=t.get(o).children[0].ID),r.get(o)},parseDeformers:function(){var r={},o={};if("Deformer"in e.Objects){var i=e.Objects.Deformer;for(var n in i){var a=i[n],s=t.get(parseInt(n));if("Skin"===a.attrType){var l=this.parseSkeleton(s,i);l.ID=n,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=s.parents[0].ID,r[n]=l}else if("BlendShape"===a.attrType){var c={id:n};c.rawTargets=this.parseMorphTargets(s,i),c.id=n,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),o[n]=c}}}return{skeletons:r,morphTargets:o}},parseSkeleton:function(e,t){var r=[];return e.children.forEach((function(e){var o=t[e.ID];if("Cluster"===o.attrType){var i={ID:e.ID,indices:[],weights:[],transformLink:(new THREE.Matrix4).fromArray(o.TransformLink.a)};"Indexes"in o&&(i.indices=o.Indexes.a,i.weights=o.Weights.a),r.push(i)}})),{rawBones:r,bones:[]}},parseMorphTargets:function(e,r){for(var o=[],i=0;i<e.children.length;i++){var n=e.children[i],a=r[n.ID],s={name:a.attrName,initialWeight:a.DeformPercent,id:a.id,fullWeights:a.FullWeights.a};if("BlendShapeChannel"!==a.attrType)return;t.get(parseInt(n.ID)).children.forEach((function(e){void 0===e.relationship&&(s.geoID=e.ID)})),o.push(s)}return o},parseScene:function(o,i,n){r=new THREE.Group;var s=this.parseModels(o.skeletons,i,n),l=e.Objects.Model,c=this;s.forEach((function(e){var o=l[e.ID];c.setLookAtProperties(e,o),t.get(e.ID).parents.forEach((function(t){var r=s.get(t.ID);void 0!==r&&r.add(e)})),null===e.parent&&r.add(e)})),this.bindSkeleton(o.skeletons,i,s),this.createAmbientLight(),this.setupMorphMaterials(),r.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=b(e.userData.transformData);e.applyMatrix(t)}}));var d=(new a).parse();1===r.children.length&&r.children[0].isGroup&&(r.children[0].animations=d,r=r.children[0]),r.animations=d},parseModels:function(r,o,i){var n=new Map,a=e.Objects.Model;for(var s in a){var l=parseInt(s),c=a[s],d=t.get(l),u=this.buildSkeleton(d,r,l,c.attrName);if(!u){switch(c.attrType){case"Camera":u=this.createCamera(d);break;case"Light":u=this.createLight(d);break;case"Mesh":u=this.createMesh(d,o,i);break;case"NurbsCurve":u=this.createCurve(d,o);break;case"LimbNode":case"Root":u=new THREE.Bone;break;case"Null":default:u=new THREE.Group}u.name=THREE.PropertyBinding.sanitizeNodeName(c.attrName),u.ID=l}this.getTransformData(u,c),n.set(l,u)}return n},buildSkeleton:function(e,t,r,o){var i=null;return e.parents.forEach((function(e){for(var n in t){var a=t[n];a.rawBones.forEach((function(t,n){if(t.ID===e.ID){var s=i;(i=new THREE.Bone).matrixWorld.copy(t.transformLink),i.name=THREE.PropertyBinding.sanitizeNodeName(o),i.ID=r,a.bones[n]=i,null!==s&&i.add(s)}}))}})),i},createCamera:function(t){var r,o;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(o=r)})),void 0===o)r=new THREE.Object3D;else{var i=0;void 0!==o.CameraProjectionType&&1===o.CameraProjectionType.value&&(i=1);var n=1;void 0!==o.NearPlane&&(n=o.NearPlane.value/1e3);var a=1e3;void 0!==o.FarPlane&&(a=o.FarPlane.value/1e3);var s=window.innerWidth,l=window.innerHeight;void 0!==o.AspectWidth&&void 0!==o.AspectHeight&&(s=o.AspectWidth.value,l=o.AspectHeight.value);var c=s/l,d=45;void 0!==o.FieldOfView&&(d=o.FieldOfView.value);var u=o.FocalLength?o.FocalLength.value:null;switch(i){case 0:r=new THREE.PerspectiveCamera(d,c,n,a),null!==u&&r.setFocalLength(u);break;case 1:r=new THREE.OrthographicCamera(-s/2,s/2,l/2,-l/2,n,a);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),r=new THREE.Object3D}}return r},createLight:function(t){var r,o;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(o=r)})),void 0===o)r=new THREE.Object3D;else{var i;i=void 0===o.LightType?0:o.LightType.value;var n=16777215;void 0!==o.Color&&(n=(new THREE.Color).fromArray(o.Color.value));var a=void 0===o.Intensity?1:o.Intensity.value/100;void 0!==o.CastLightOnObject&&0===o.CastLightOnObject.value&&(a=0);var s=0;void 0!==o.FarAttenuationEnd&&(s=void 0!==o.EnableFarAttenuation&&0===o.EnableFarAttenuation.value?0:o.FarAttenuationEnd.value);switch(i){case 0:r=new THREE.PointLight(n,a,s,1);break;case 1:r=new THREE.DirectionalLight(n,a);break;case 2:var l=Math.PI/3;void 0!==o.InnerAngle&&(l=THREE.Math.degToRad(o.InnerAngle.value));var c=0;void 0!==o.OuterAngle&&(c=THREE.Math.degToRad(o.OuterAngle.value),c=Math.max(c,1)),r=new THREE.SpotLight(n,a,s,l,c,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+o.LightType.value+", defaulting to a THREE.PointLight."),r=new THREE.PointLight(n,a)}void 0!==o.CastShadows&&1===o.CastShadows.value&&(r.castShadow=!0)}return r},createMesh:function(e,t,r){var o,i=null,n=null,a=[];return e.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),r.has(e.ID)&&a.push(r.get(e.ID))})),a.length>1?n=a:a.length>0?n=a[0]:(n=new THREE.MeshPhongMaterial({color:13421772}),a.push(n)),"color"in i.attributes&&a.forEach((function(e){e.vertexColors=THREE.VertexColors})),i.FBX_Deformer?(a.forEach((function(e){e.skinning=!0})),o=new THREE.SkinnedMesh(i,n)):o=new THREE.Mesh(i,n),o},createCurve:function(e,t){var r=e.children.reduce((function(e,r){return t.has(r.ID)&&(e=t.get(r.ID)),e}),null),o=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(r,o)},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?_(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(o,i){"LookAtProperty"in i&&t.get(o.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var i=e.Objects.Model[t.ID];if("Lcl_Translation"in i){var n=i.Lcl_Translation.value;void 0!==o.target?(o.target.position.fromArray(n),r.add(o.target)):o.lookAt((new THREE.Vector3).fromArray(n))}}}))},bindSkeleton:function(e,r,o){var i=this.parsePoseNodes();for(var n in e){var a=e[n];t.get(parseInt(a.ID)).parents.forEach((function(e){if(r.has(e.ID)){var n=e.ID;t.get(n).parents.forEach((function(e){o.has(e.ID)&&o.get(e.ID).bind(new THREE.Skeleton(a.bones),i[e.ID])}))}}))}},parsePoseNodes:function(){var t={};if("Pose"in e.Objects){var r=e.Objects.Pose;for(var o in r)if("BindPose"===r[o].attrType){var i=r[o].PoseNode;Array.isArray(i)?i.forEach((function(e){t[e.Node]=(new THREE.Matrix4).fromArray(e.Matrix.a)})):t[i.Node]=(new THREE.Matrix4).fromArray(i.Matrix.a)}}return t},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var t=e.GlobalSettings.AmbientColor.value,r=t[0],o=t[1],i=t[2];if(0!==r||0!==o||0!==i)new THREE.Color(r,o,i)}},setupMorphMaterials:function(){var e=this;r.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(r,o){e.setupMorphMaterial(t,r,o)})):e.setupMorphMaterial(t,t.material))}))},setupMorphMaterial:function(e,t,o){var i=e.uuid,n=t.uuid,a=!1;if(r.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===n&&e.uuid!==i&&(a=!0)})):e.material.uuid===n&&e.uuid!==i&&(a=!0))})),!0===a){var s=t.clone();s.morphTargets=!0,void 0===o?e.material=s:e.material[o]=s}else t.morphTargets=!0}},n.prototype={constructor:n,parse:function(r){var o=new Map;if("Geometry"in e.Objects){var i=e.Objects.Geometry;for(var n in i){var a=t.get(parseInt(n)),s=this.parseGeometry(a,i[n],r);o.set(parseInt(n),s)}}return o},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(t,r,o){var i=o.skeletons,n=o.morphTargets,a=t.parents.map((function(t){return e.Objects.Model[t.ID]}));if(0!==a.length){var s=t.children.reduce((function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e}),null),l=t.children.reduce((function(e,t){return void 0!==n[t.ID]&&(e=n[t.ID]),e}),null),c=a[0],d={};"RotationOrder"in c&&(d.eulerOrder=_(c.RotationOrder.value)),"InheritType"in c&&(d.inheritType=parseInt(c.InheritType.value)),"GeometricTranslation"in c&&(d.translation=c.GeometricTranslation.value),"GeometricRotation"in c&&(d.rotation=c.GeometricRotation.value),"GeometricScaling"in c&&(d.scale=c.GeometricScaling.value);var u=b(d);return this.genGeometry(r,s,l,u)}},genGeometry:function(e,t,r,o){var i=new THREE.BufferGeometry;e.attrName&&(i.name=e.attrName);var n=this.parseGeoNode(e,t),a=this.genBuffers(n),s=new THREE.Float32BufferAttribute(a.vertex,3);if(o.applyToBufferAttribute(s),i.addAttribute("position",s),a.colors.length>0&&i.addAttribute("color",new THREE.Float32BufferAttribute(a.colors,3)),t&&(i.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(a.weightsIndices,4)),i.addAttribute("skinWeight",new THREE.Float32BufferAttribute(a.vertexWeights,4)),i.FBX_Deformer=t),a.normal.length>0){var l=new THREE.Float32BufferAttribute(a.normal,3);(new THREE.Matrix3).getNormalMatrix(o).applyToBufferAttribute(l),i.addAttribute("normal",l)}if(a.uvs.forEach((function(e,t){var r="uv"+(t+1).toString();0===t&&(r="uv"),i.addAttribute(r,new THREE.Float32BufferAttribute(a.uvs[t],2))})),n.material&&"AllSame"!==n.material.mappingType){var c=a.materialIndex[0],d=0;if(a.materialIndex.forEach((function(e,t){e!==c&&(i.addGroup(d,t-d,c),c=e,d=t)})),i.groups.length>0){var u=i.groups[i.groups.length-1],h=u.start+u.count;h!==a.materialIndex.length&&i.addGroup(h,a.materialIndex.length-h,c)}0===i.groups.length&&i.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(i,e,r,o),i},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var o=0;e.LayerElementUV[o];)r.uv.push(this.parseUVs(e.LayerElementUV[o])),o++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(o,i){void 0===r.weightTable[o]&&(r.weightTable[o]=[]),r.weightTable[o].push({id:t,weight:e.weights[i]})}))}))),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,o=0,i=!1,n=[],a=[],s=[],l=[],c=[],d=[],u=this;return e.vertexIndices.forEach((function(h,p){var f=!1;h<0&&(h^=-1,f=!0);var g=[],b=[];if(n.push(3*h,3*h+1,3*h+2),e.color){var _=m(p,r,h,e.color);s.push(_[0],_[1],_[2])}if(e.skeleton){if(void 0!==e.weightTable[h]&&e.weightTable[h].forEach((function(e){b.push(e.weight),g.push(e.id)})),b.length>4){i||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),i=!0);var v=[0,0,0,0],y=[0,0,0,0];b.forEach((function(e,t){var r=e,o=g[t];y.forEach((function(e,t,i){if(r>e){i[t]=r,r=e;var n=v[t];v[t]=o,o=n}}))})),g=v,b=y}for(;b.length<4;)b.push(0),g.push(0);for(var w=0;w<4;++w)c.push(b[w]),d.push(g[w])}if(e.normal){_=m(p,r,h,e.normal);a.push(_[0],_[1],_[2])}if(e.material&&"AllSame"!==e.material.mappingType)var E=m(p,r,h,e.material)[0];e.uv&&e.uv.forEach((function(e,t){var o=m(p,r,h,e);void 0===l[t]&&(l[t]=[]),l[t].push(o[0]),l[t].push(o[1])})),o++,f&&(u.genFace(t,e,n,E,a,s,l,c,d,o),r++,o=0,n=[],a=[],s=[],l=[],c=[],d=[])})),t},genFace:function(e,t,r,o,i,n,a,s,l,c){for(var d=2;d<c;d++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(d-1)]]),e.vertex.push(t.vertexPositions[r[3*(d-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(d-1)+2]]),e.vertex.push(t.vertexPositions[r[3*d]]),e.vertex.push(t.vertexPositions[r[3*d+1]]),e.vertex.push(t.vertexPositions[r[3*d+2]]),t.skeleton&&(e.vertexWeights.push(s[0]),e.vertexWeights.push(s[1]),e.vertexWeights.push(s[2]),e.vertexWeights.push(s[3]),e.vertexWeights.push(s[4*(d-1)]),e.vertexWeights.push(s[4*(d-1)+1]),e.vertexWeights.push(s[4*(d-1)+2]),e.vertexWeights.push(s[4*(d-1)+3]),e.vertexWeights.push(s[4*d]),e.vertexWeights.push(s[4*d+1]),e.vertexWeights.push(s[4*d+2]),e.vertexWeights.push(s[4*d+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(d-1)]),e.weightsIndices.push(l[4*(d-1)+1]),e.weightsIndices.push(l[4*(d-1)+2]),e.weightsIndices.push(l[4*(d-1)+3]),e.weightsIndices.push(l[4*d]),e.weightsIndices.push(l[4*d+1]),e.weightsIndices.push(l[4*d+2]),e.weightsIndices.push(l[4*d+3])),t.color&&(e.colors.push(n[0]),e.colors.push(n[1]),e.colors.push(n[2]),e.colors.push(n[3*(d-1)]),e.colors.push(n[3*(d-1)+1]),e.colors.push(n[3*(d-1)+2]),e.colors.push(n[3*d]),e.colors.push(n[3*d+1]),e.colors.push(n[3*d+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(o),e.materialIndex.push(o),e.materialIndex.push(o)),t.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[3*(d-1)]),e.normal.push(i[3*(d-1)+1]),e.normal.push(i[3*(d-1)+2]),e.normal.push(i[3*d]),e.normal.push(i[3*d+1]),e.normal.push(i[3*d+2])),t.uv&&t.uv.forEach((function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(a[r][0]),e.uvs[r].push(a[r][1]),e.uvs[r].push(a[r][2*(d-1)]),e.uvs[r].push(a[r][2*(d-1)+1]),e.uvs[r].push(a[r][2*d]),e.uvs[r].push(a[r][2*d+1])}))},addMorphTargets:function(t,r,o,i){if(null!==o){t.morphAttributes.position=[];var n=this;o.rawTargets.forEach((function(o){var a=e.Objects.Geometry[o.geoID];void 0!==a&&n.genMorphGeometry(t,r,a,i,o.name)}))}},genMorphGeometry:function(e,t,r,o,i){var n=new THREE.BufferGeometry;r.attrName&&(n.name=r.attrName);for(var a=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],s=void 0!==t.Vertices?t.Vertices.a.slice():[],l=void 0!==r.Vertices?r.Vertices.a:[],c=void 0!==r.Indexes?r.Indexes.a:[],d=0;d<c.length;d++){var u=3*c[d];s[u]+=l[3*d],s[u+1]+=l[3*d+1],s[u+2]+=l[3*d+2]}var h={vertexIndices:a,vertexPositions:s},p=this.genBuffers(h),m=new THREE.Float32BufferAttribute(p.vertex,3);m.name=i||r.attrName,o.applyToBufferAttribute(m),e.morphAttributes.position.push(m)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,o=e.Normals.a,i=[];return"IndexToDirect"===r&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:o,indices:i,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,o=e.UV.a,i=[];return"IndexToDirect"===r&&(i=e.UVIndex.a),{dataSize:2,buffer:o,indices:i,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,o=e.Colors.a,i=[];return"IndexToDirect"===r&&(i=e.ColorIndex.a),{dataSize:4,buffer:o,indices:i,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var o=e.Materials.a,i=[],n=0;n<o.length;++n)i.push(n);return{dataSize:1,buffer:o,indices:i,mappingType:t,referenceType:r}},parseNurbsGeometry:function(e){if(void 0===THREE.NURBSCurve)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new THREE.BufferGeometry;for(var r,o,i=t-1,n=e.KnotVector.a,a=[],s=e.Points.a,l=0,c=s.length;l<c;l+=4)a.push((new THREE.Vector4).fromArray(s,l));if("Closed"===e.Form)a.push(a[0]);else if("Periodic"===e.Form){r=i,o=n.length-1-r;for(l=0;l<i;++l)a.push(a[l])}var d=new THREE.NURBSCurve(i,n,a,r,o).getPoints(7*a.length),u=new Float32Array(3*d.length);d.forEach((function(e,t){e.toArray(u,3*t)}));var h=new THREE.BufferGeometry;return h.addAttribute("position",new THREE.BufferAttribute(u,3)),h}},a.prototype={constructor:a,parse:function(){var e=[],t=this.parseClips();if(void 0!==t){for(var r in t){var o=t[r],i=this.addClip(o);e.push(i)}return e}},parseClips:function(){if(void 0!==e.Objects.AnimationCurve){var t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);var r=this.parseAnimationLayers(t);return this.parseAnimStacks(r)}},parseAnimationCurveNodes:function(){var t=e.Objects.AnimationCurveNode,r=new Map;for(var o in t){var i=t[o];if(null!==i.attrName.match(/S|R|T|DeformPercent/)){var n={id:i.id,attr:i.attrName,curves:{}};r.set(n.id,n)}}return r},parseAnimationCurves:function(r){var o=e.Objects.AnimationCurve;for(var i in o){var n={id:o[i].id,times:o[i].KeyTime.a.map(h),values:o[i].KeyValueFloat.a},a=t.get(n.id);if(void 0!==a){var s=a.parents[0].ID,l=a.parents[0].relationship;l.match(/X/)?r.get(s).curves.x=n:l.match(/Y/)?r.get(s).curves.y=n:l.match(/Z/)?r.get(s).curves.z=n:l.match(/d|DeformPercent/)&&r.has(s)&&(r.get(s).curves.morph=n)}}},parseAnimationLayers:function(o){var i=e.Objects.AnimationLayer,n=new Map;for(var a in i){var s=[],l=t.get(parseInt(a));if(void 0!==l)l.children.forEach((function(i,n){if(o.has(i.ID)){var a=o.get(i.ID);if(void 0!==a.curves.x||void 0!==a.curves.y||void 0!==a.curves.z){if(void 0===s[n]){t.get(i.ID).parents.forEach((function(e){void 0!==e.relationship&&(p=e.ID)}));var l=e.Objects.Model[p.toString()],c={modelName:THREE.PropertyBinding.sanitizeNodeName(l.attrName),ID:l.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};r.traverse((function(e){(e.ID=l.id)&&(c.transform=e.matrix,e.userData.transformData&&(c.eulerOrder=e.userData.transformData.eulerOrder))})),c.transform||(c.transform=new THREE.Matrix4),"PreRotation"in l&&(c.preRotation=l.PreRotation.value),"PostRotation"in l&&(c.postRotation=l.PostRotation.value),s[n]=c}s[n][a.attr]=a}else if(void 0!==a.curves.morph){if(void 0===s[n]){var d;t.get(i.ID).parents.forEach((function(e){void 0!==e.relationship&&(d=e.ID)}));var u=t.get(d).parents[0].ID,h=t.get(u).parents[0].ID,p=t.get(h).parents[0].ID;l=e.Objects.Model[p],c={modelName:THREE.PropertyBinding.sanitizeNodeName(l.attrName),morphName:e.Objects.Deformer[d].attrName};s[n]=c}s[n][a.attr]=a}}})),n.set(parseInt(a),s)}return n},parseAnimStacks:function(r){var o=e.Objects.AnimationStack,i={};for(var n in o){var a=t.get(parseInt(n)).children;a.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var s=r.get(a[0].ID);i[n]={name:o[n].attrName,layer:s}}return i},addClip:function(e){var t=[],r=this;return e.layer.forEach((function(e){t=t.concat(r.generateTracks(e))})),new THREE.AnimationClip(e.name,-1,t)},generateTracks:function(e){var t=[],r=new THREE.Vector3,o=new THREE.Quaternion,i=new THREE.Vector3;if(e.transform&&e.transform.decompose(r,o,i),r=r.toArray(),o=(new THREE.Euler).setFromQuaternion(o,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var n=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");void 0!==n&&t.push(n)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var a=this.generateRotationTrack(e.modelName,e.R.curves,o,e.preRotation,e.postRotation,e.eulerOrder);void 0!==a&&t.push(a)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var s=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==s&&t.push(s)}if(void 0!==e.DeformPercent){var l=this.generateMorphTrack(e);void 0!==l&&t.push(l)}return t},generateVectorTrack:function(e,t,r,o){var i=this.getTimesForAllAxes(t),n=this.getKeyframeTrackValues(i,t,r);return new THREE.VectorKeyframeTrack(e+"."+o,i,n)},generateRotationTrack:function(e,t,r,o,i,n){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(THREE.Math.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(THREE.Math.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(THREE.Math.degToRad));var a=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(a,t,r);void 0!==o&&((o=o.map(THREE.Math.degToRad)).push(n),o=(new THREE.Euler).fromArray(o),o=(new THREE.Quaternion).setFromEuler(o)),void 0!==i&&((i=i.map(THREE.Math.degToRad)).push(n),i=(new THREE.Euler).fromArray(i),i=(new THREE.Quaternion).setFromEuler(i).inverse());for(var l=new THREE.Quaternion,c=new THREE.Euler,d=[],u=0;u<s.length;u+=3)c.set(s[u],s[u+1],s[u+2],n),l.setFromEuler(c),void 0!==o&&l.premultiply(o),void 0!==i&&l.multiply(i),l.toArray(d,u/3*4);return new THREE.QuaternionKeyframeTrack(e+".quaternion",a,d)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,o=t.values.map((function(e){return e/100})),i=r.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new THREE.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+i+"]",t.times,o)},getTimesForAllAxes:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})).filter((function(e,t,r){return r.indexOf(e)==t}))},getKeyframeTrackValues:function(e,t,r){var o=r,i=[],n=-1,a=-1,s=-1;return e.forEach((function(e){if(t.x&&(n=t.x.times.indexOf(e)),t.y&&(a=t.y.times.indexOf(e)),t.z&&(s=t.z.times.indexOf(e)),-1!==n){var r=t.x.values[n];i.push(r),o[0]=r}else i.push(o[0]);if(-1!==a){var l=t.y.values[a];i.push(l),o[1]=l}else i.push(o[1]);if(-1!==s){var c=t.z.values[s];i.push(c),o[2]=c}else i.push(o[2])})),i},interpolateRotations:function(e){for(var t=1;t<e.values.length;t++){var r=e.values[t-1],o=e.values[t]-r,i=Math.abs(o);if(i>=180){for(var n=i/180,a=o/n,s=r+a,l=e.times[t-1],c=(e.times[t]-l)/n,d=l+c,u=[],h=[];d<e.times[t];)u.push(d),d+=c,h.push(s),s+=a;e.times=w(e.times,t,u),e.values=w(e.values,t,h)}}}},s.prototype={constructor:s,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new d,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=this,r=e.split(/[\r\n]+/);return r.forEach((function(e,o){var i=e.match(/^[\s\t]*;/),n=e.match(/^[\s\t]*$/);if(!i&&!n){var a=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),s=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");a?t.parseNodeBegin(e,a):s?t.parseNodeProperty(e,s,r[++o]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}})),this.allNodes},parseNodeBegin:function(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),o=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),i={name:r},n=this.parseNodeAttr(o),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,i):r in a?("PoseNode"===r?a.PoseNode.push(i):void 0!==a[r].id&&(a[r]={},a[r][a[r].id]=a[r]),""!==n.id&&(a[r][n.id]=i)):"number"==typeof n.id?(a[r]={},a[r][n.id]=i):"Properties70"!==r&&(a[r]="PoseNode"===r?[i]:i),"number"==typeof n.id&&(i.id=n.id),""!==n.name&&(i.attrName=n.name),""!==n.type&&(i.attrType=n.type),this.pushStack(i)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",o="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),o=e[2]),{id:t,name:r,type:o}},parseNodeProperty:function(e,t,r){var o=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===o&&","===i&&(i=r.replace(/"/g,"").replace(/,$/,"").trim());var n=this.getCurrentNode();if("Properties70"!==n.name){if("C"===o){var a=i.split(",").slice(1),s=parseInt(a[0]),l=parseInt(a[1]),c=i.split(",").slice(3);o="connections",function(e,t){for(var r=0,o=e.length,i=t.length;r<i;r++,o++)e[o]=t[r]}(i=[s,l],c=c.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===n[o]&&(n[o]=[])}"Node"===o&&(n.id=i),o in n&&Array.isArray(n[o])?n[o].push(i):"a"!==o?n[o]=i:n.a=i,this.setCurrentProp(n,o),"a"===o&&","!==i.slice(-1)&&(n.a=v(i))}else this.parseNodeSpecialProperty(e,o,i)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=v(t.a))},parseNodeSpecialProperty:function(e,t,r){var o=r.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),i=o[0],n=o[1],a=o[2],s=o[3],l=o[4];switch(n){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=v(l)}this.getPrevNode()[i]={type:n,type2:a,flag:s,value:l},this.setCurrentProp(this.getPrevNode(),i)}},l.prototype={constructor:l,parse:function(e){var t=new c(e);t.skip(23);for(var r=t.getUint32(),o=new d;!this.endOfContent(t);){var i=this.parseNode(t,r);null!==i&&o.add(i.name,i)}return o},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},o=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32(),n=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),a=e.getString(n);if(0===o)return null;for(var s=[],l=0;l<i;l++)s.push(this.parseProperty(e));var c=s.length>0?s[0]:"",d=s.length>1?s[1]:"",u=s.length>2?s[2]:"";for(r.singleProperty=1===i&&e.getOffset()===o;o>e.getOffset();){var h=this.parseNode(e,t);null!==h&&this.parseSubNode(a,r,h)}return r.propertyList=s,"number"==typeof c&&(r.id=c),""!==d&&(r.attrName=d),""!==u&&(r.attrType=u),""!==a&&(r.name=a),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var o=r.propertyList[0];Array.isArray(o)?(t[r.name]=r,r.a=o):t[r.name]=o}else if("Connections"===e&&"C"===r.name){var i=[];r.propertyList.forEach((function(e,t){0!==t&&i.push(e)})),void 0===t.connections&&(t.connections=[]),t.connections.push(i)}else if("Properties70"===r.name){Object.keys(r).forEach((function(e){t[e]=r[e]}))}else if("Properties70"===e&&"P"===r.name){var n,a=r.propertyList[0],s=r.propertyList[1],l=r.propertyList[2],c=r.propertyList[3];0===a.indexOf("Lcl ")&&(a=a.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),n="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[a]={type:s,type2:l,flag:c,value:n}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var o=e.getUint32(),i=e.getUint32(),n=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(o);case"d":return e.getFloat64Array(o);case"f":return e.getFloat32Array(o);case"i":return e.getInt32Array(o);case"l":return e.getInt64Array(o)}"undefined"==typeof Zlib&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var a=new c(new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(n))).decompress().buffer);switch(t){case"b":case"c":return a.getBooleanArray(o);case"d":return a.getFloat64Array(o);case"f":return a.getFloat32Array(o);case"i":return a.getInt32Array(o);case"l":return a.getInt64Array(o)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}},c.prototype={constructor:c,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var t=[],r=0;r<e;r++)t[r]=this.getUint8();var o=t.indexOf(0);return o>=0&&(t=t.slice(0,o)),THREE.LoaderUtils.decodeText(new Uint8Array(t))}},d.prototype={constructor:d,add:function(e,t){this[e]=t}};var p=[];function m(e,t,r,o){var i;switch(o.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=r;break;case"AllSame":i=o.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+o.mappingType)}"IndexToDirect"===o.referenceType&&(i=o.indices[i]);var n=i*o.dataSize,a=n+o.dataSize;return function(e,t,r,o){for(var i=r,n=0;i<o;i++,n++)e[n]=t[i];return e}(p,o.buffer,n,a)}var f=new THREE.Euler,g=new THREE.Vector3;function b(e){var t,r=new THREE.Matrix4,o=new THREE.Matrix4,i=new THREE.Matrix4,n=new THREE.Matrix4,a=new THREE.Matrix4,s=new THREE.Matrix4,l=new THREE.Matrix4,c=new THREE.Matrix4,d=new THREE.Matrix4,u=new THREE.Matrix4,h=new THREE.Matrix4,p=new THREE.Matrix4,m=new THREE.Matrix4,b=e.inheritType?e.inheritType:0;(e.translation&&r.setPosition(g.fromArray(e.translation)),e.preRotation)&&((t=e.preRotation.map(THREE.Math.degToRad)).push(e.eulerOrder),o.makeRotationFromEuler(f.fromArray(t)));e.rotation&&((t=e.rotation.map(THREE.Math.degToRad)).push(e.eulerOrder),i.makeRotationFromEuler(f.fromArray(t)));e.postRotation&&((t=e.postRotation.map(THREE.Math.degToRad)).push(e.eulerOrder),n.makeRotationFromEuler(f.fromArray(t)));e.scale&&s.scale(g.fromArray(e.scale)),e.scalingOffset&&c.setPosition(g.fromArray(e.scalingOffset)),e.scalingPivot&&l.setPosition(g.fromArray(e.scalingPivot)),e.rotationOffset&&d.setPosition(g.fromArray(e.rotationOffset)),e.rotationPivot&&u.setPosition(g.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h=e.parentMatrixWorld);var _=o.multiply(i).multiply(n),v=new THREE.Matrix4;h.extractRotation(v);var y=new THREE.Matrix4,w=new THREE.Matrix4,E=new THREE.Matrix4,j=new THREE.Matrix4;if(j.copyPosition(h),E=j.getInverse(j).multiply(h),w=v.getInverse(v).multiply(E),y=s,0===b)m=v.multiply(_).multiply(w).multiply(y);else if(1===b)m=v.multiply(w).multiply(_).multiply(y);else{var T=(new THREE.Matrix4).copy(s),x=w.multiply(T.getInverse(T));m=v.multiply(_).multiply(x).multiply(y)}a=r.multiply(d).multiply(u).multiply(o).multiply(i).multiply(n).multiply(u.getInverse(u)).multiply(c).multiply(l).multiply(s).multiply(l.getInverse(l));var k=(new THREE.Matrix4).copyPosition(a),A=h.multiply(k);return p.copyPosition(A),a=p.multiply(m)}function _(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function v(e){return e.split(",").map((function(e){return parseFloat(e)}))}function y(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(e,t,r))}function w(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return o}()},{}],5:[function(e,t,r){"use strict";t.exports=Object.assign((function(){}),{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16})},{}],6:[function(e,t,r){"use strict";t.exports=function(e,t,r){this.type=e,this.index=t,this.pressed=r.pressed,this.value=r.value}},{}],7:[function(e,t,r){"use strict";t.exports={size:5,cellSize:10,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5},autogenerated:!0,cells:[{q:-1,r:0,s:1,h:1,walkable:!0,userData:{}},{q:0,r:-1,s:1,h:1,walkable:!0,userData:{}},{q:0,r:0,s:0,h:1,walkable:!0,userData:{}},{q:1,r:-1,s:0,h:1,walkable:!0,userData:{}},{q:-1,r:1,s:0,h:0,walkable:!0,userData:{}},{q:0,r:1,s:-1,h:0,walkable:!0,userData:{}},{q:1,r:0,s:-1,h:0,walkable:!0,userData:{}}]}},{}],8:[function(e,t,r){"use strict";function o(e){var t=document.getElementById(e),r=t.parentNode;try{r&&r.removeChild(t)}catch(e){}}function i(e,t,r){return new r((function(r,i){var n=t.timeout||5e3,a="script_"+Date.now()+"_"+Math.ceil(1e5*Math.random()),s=function(e,t){var r=document.createElement("script");return r.type="text/javascript",r.async=!0,r.id=t,r.src=e,r}(e,a),l=setTimeout((function(){i(new Error("Script request to "+e+" timed out")),o(a)}),n),c=function(e){clearTimeout(e)};s.addEventListener("load",(function(e){r({ok:!0}),c(l),o(a)})),s.addEventListener("error",(function(t){i(new Error("Script request to "+e+" failed "+t)),c(l),o(a)})),function(e){var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(s)}))}t.exports=function(e){return e=e||{},function(t,r){return i(t,r=r||{},e.Promise||Promise)}}},{}],9:[function(e,t,r){"use strict";var o,i,n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a="function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?function(e){return void 0===e?"undefined":n(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":n(e)},s=t.exports={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};s.Board=function(e,t){if(!e)throw new Error("You must pass in a grid system for the board to use.");this.tiles=[],this.tileGroup=null,this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new s.AStarFinder(t),s.Loader.init(),this.setGrid(e)},s.Board.prototype={setEntityOnTile:function(e,t){var r=this.grid.cellToPixel(t.cell);e.position.copy(r),e.position.y+=e.heightOffset||0,e.tile&&(e.tile.entity=null),e.tile=t,t.entity=e},addTile:function(e){-1===this.tiles.indexOf(e)&&(this.tiles.push(e),this.snapTileToGrid(e),e.position.y=0,this.tileGroup.add(e.mesh),this.grid.add(e.cell),e.cell.tile=e)},removeTile:function(e){if(e){var t=this.tiles.indexOf(e);this.grid.remove(e.cell),-1!==t&&this.tiles.splice(t,1),e.dispose()}},removeAllTiles:function(){if(this.tileGroup)for(var e=this.tileGroup.children,t=0;t<e.length;t++)this.tileGroup.remove(e[t])},getTileAtCell:function(e){var t=this.grid.cellToHash(e);return e.tile||(void 0!==this.grid.cells[t]?this.grid.cells[t].tile:null)},snapToGrid:function(e){var t=this.grid.pixelToCell(e);e.copy(this.grid.cellToPixel(t))},snapTileToGrid:function(e){if(e.cell)e.position.copy(this.grid.cellToPixel(e.cell));else{var t=this.grid.pixelToCell(e.position);e.position.copy(this.grid.cellToPixel(t))}return e},getRandomTile:function(){var e=s.Tools.randomInt(0,this.tiles.length-1);return this.tiles[e]},findPath:function(e,t,r){return this.finder.findPath(e.cell,t.cell,r,this.grid)},setGrid:function(e){this.group.remove(this.tileGroup),this.grid&&e!==this.grid&&(this.removeAllTiles(),this.tiles.forEach((function(e){this.grid.remove(e.cell),e.dispose()})),this.grid.dispose()),this.grid=e,this.tiles=[],this.tileGroup=new THREE.Object3D,this.group.add(this.tileGroup)},generateOverlay:function(e){var t=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.grid.generateOverlay(e,this.overlay,t),this.group.add(this.overlay)},generateTilemap:function(e){this.reset();var t=this.grid.generateTiles(e);this.tiles=t,this.tileGroup=new THREE.Object3D;for(var r=0;r<t.length;r++)this.tileGroup.add(t[r].mesh);this.group.add(this.tileGroup)},reset:function(){this.removeAllTiles(),this.tileGroup&&this.group.remove(this.tileGroup)}},s.Board.prototype.constructor=s.Board,s.Cell=function(e,t,r,o){this.q=e||0,this.r=t||0,this.s=r||0,this.h=o||1,this.tile=null,this.userData={},this.walkable=!0,this._calcCost=0,this._priority=0,this._visited=!1,this._parent=null,this.uniqueID=s.LinkedList.generateID()},s.Cell.prototype={set:function(e,t,r){return this.q=e,this.r=t,this.s=r,this},copy:function(e){return this.q=e.q,this.r=e.r,this.s=e.s,this.h=e.h,this.tile=e.tile||null,this.userData=e.userData||{},this.walkable=e.walkable,this},add:function(e){return this.q+=e.q,this.r+=e.r,this.s+=e.s,this},equals:function(e){return this.q===e.q&&this.r===e.r&&this.s===e.s}},s.Cell.prototype.constructor=s.Cell,s.HexGrid=function(e){e=e||{},this.type=s.HEX,this.size=5,this.cellSize=void 0===e.cellSize?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t,r=[];for(t=0;6>t;t++)r.push(this._createVertex(t));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(r[0].x,r[0].y),t=1;6>t;t++)this.cellShape.lineTo(r[t].x,r[t].y);this.cellShape.lineTo(r[0].x,r[0].y),this.cellShape.autoClose=!0,this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=r,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._cellWidth=2*this.cellSize,this._cellLength=.5*s.SQRT3*this._cellWidth,this._hashDelimeter=".",this._directions=[new s.Cell(1,-1,0),new s.Cell(1,0,-1),new s.Cell(0,1,-1),new s.Cell(-1,1,0),new s.Cell(-1,0,1),new s.Cell(0,-1,1)],this._diagonals=[new s.Cell(2,-1,-1),new s.Cell(1,1,-2),new s.Cell(-1,2,-1),new s.Cell(-2,1,1),new s.Cell(-1,-1,2),new s.Cell(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new s.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},s.HexGrid.TWO_THIRDS=2/3,s.HexGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-(e.s-e.r)*this._cellLength*.5,this._vec3},pixelToCell:function(e){var t=e.x*(s.HexGrid.TWO_THIRDS/this.cellSize),r=(-e.x/3+s.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,r,-t-r),this._cubeRound(this._cel)},getCellAt:function(e){var t=e.x*(s.HexGrid.TWO_THIRDS/this.cellSize),r=(-e.x/3+s.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,r,-t-r),this._cubeRound(this._cel),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,r){var o,i,n=this._directions.length;for(this._list.length=0,o=0;n>o;o++)this._cel.copy(e),this._cel.add(this._directions[o]),!(i=this.cells[this.cellToHash(this._cel)])||r&&!r(e,i)||this._list.push(i);if(t)for(o=0;n>o;o++)this._cel.copy(e),this._cel.add(this._diagonals[o]),!(i=this.cells[this.cellToHash(this._cel)])||r&&!r(e,i)||this._list.push(i);return this._list},getRandomCell:function(){var e,t=0,r=s.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===r)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r+this._hashDelimeter+e.s},distance:function(e,t){return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(e.s-t.s))+(t.h-e.h)},clearPath:function(){var e,t;for(e in this.cells)(t=this.cells[e])._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,r){var o=Math.abs(e.h);1>o&&(o=1);var i=this._geoCache[o];i||(this.extrudeSettings.amount=o,i=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[o]=i);var n=new s.Tile({size:this.cellSize,scale:t,cell:e,geometry:i,material:r});return e.tile=n,n},generateTiles:function(e){e=e||{};var t,r,o,i=[],n={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};for(t in n=s.Tools.merge(n,e),this.cellSize=n.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*s.SQRT3*this._cellWidth,this.autogenerated=!0,this.extrudeSettings=n.extrudeSettings,this.cells)o=this.cells[t],(r=this.generateTile(o,n.tileScale,n.material)).position.copy(this.cellToPixel(o)),r.position.y=0,i.push(r);return i},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,s.PI/2),t},generate:function(e){var t,r,o,i;for(e=e||{},this.size=void 0===e.size?this.size:e.size,t=-this.size;t<this.size+1;t++)for(r=-this.size;r<this.size+1;r++)o=-t-r,Math.abs(t)<=this.size&&Math.abs(r)<=this.size&&Math.abs(o)<=this.size&&(i=new s.Cell(t,r,o),this.add(i))},generateOverlay:function(e,t,r){var o,i,n,a=this.cellShape.createPointsGeometry();for(o=-e;e+1>o;o++)for(i=-e;e+1>i;i++)if(n=-o-i,Math.abs(o)<=e&&Math.abs(i)<=e&&Math.abs(n)<=e){this._cel.set(o,i,n);var l=new THREE.Line(a,r);l.position.copy(this.cellToPixel(this._cel)),l.rotation.x=90*s.DEG_TO_RAD,t.add(l)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,r){var o=this;s.Tools.getJSON({url:e,callback:function(e){o.fromJSON(e),t.call(r||null,e)},cache:!1,scope:o})},fromJSON:function(e){var t,r,o=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*s.SQRT3*this._cellWidth,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<o.length;t++)(r=new s.Cell).copy(o[t]),this.add(r)},toJSON:function(){var e,t,r={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},o=[];for(t in this.cells)e=this.cells[t],o.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return r.cells=o,r},_createVertex:function(e){var t=s.TAU/6*e;return new THREE.Vector3(this.cellSize*Math.cos(t),this.cellSize*Math.sin(t),0)},_cubeRound:function(e){var t=Math.round(e.q),r=Math.round(e.r),o=Math.round(e.s),i=Math.abs(t-e.q),n=Math.abs(r-e.r),a=Math.abs(o-e.s);return i>n&&i>a?t=-r-o:n>a?r=-t-o:o=-t-r,this._cel.set(t,r,o)}},s.HexGrid.prototype.constructor=s.HexGrid,s.SqrGrid=function(e){e=e||{},this.type=s.SQR,this.size=5,this.cellSize=void 0===e.cellSize?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t=[];t.push(new THREE.Vector3),t.push(new THREE.Vector3(-this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,-this.cellSize)),this.cellShape=new THREE.Shape,this.cellShape.moveTo(-this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,-this.cellSize),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=t,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._fullCellSize=2*this.cellSize,this._hashDelimeter=".",this._directions=[new s.Cell(1,0,0),new s.Cell(0,-1,0),new s.Cell(-1,0,0),new s.Cell(0,1,0)],this._diagonals=[new s.Cell(-1,-1,0),new s.Cell(-1,1,0),new s.Cell(1,1,0),new s.Cell(1,-1,0)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new s.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},s.SqrGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3},pixelToCell:function(e){var t=Math.round(e.x/this._fullCellSize),r=Math.round(e.z/this._fullCellSize);return this._cel.set(t,r,0)},getCellAt:function(e){var t=Math.round(e.x/this._fullCellSize),r=Math.round(e.z/this._fullCellSize);return this._cel.set(t,r),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,r){var o,i,n=this._directions.length;for(this._list.length=0,o=0;n>o;o++)this._cel.copy(e),this._cel.add(this._directions[o]),!(i=this.cells[this.cellToHash(this._cel)])||r&&!r(e,i)||this._list.push(i);if(t)for(o=0;n>o;o++)this._cel.copy(e),this._cel.add(this._diagonals[o]),!(i=this.cells[this.cellToHash(this._cel)])||r&&!r(e,i)||this._list.push(i);return this._list},getRandomCell:function(){var e,t=0,r=s.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===r)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r},distance:function(e,t){return Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r))+(t.h-e.h)},clearPath:function(){var e,t;for(e in this.cells)(t=this.cells[e])._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,r){var o=Math.abs(e.h);1>o&&(o=1);var i=this._geoCache[o];i||(this.extrudeSettings.amount=o,i=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[o]=i);var n=new s.Tile({size:this.cellSize,scale:t,cell:e,geometry:i,material:r});return e.tile=n,n},generateTiles:function(e){e=e||{};var t,r,o,i=[],n={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};for(t in n=s.Tools.merge(n,e),this.cellSize=n.cellSize,this._fullCellSize=2*this.cellSize,this.autogenerated=!0,this.extrudeSettings=n.extrudeSettings,this.cells)o=this.cells[t],(r=this.generateTile(o,n.tileScale,n.material)).position.copy(this.cellToPixel(o)),r.position.y=0,i.push(r);return i},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,s.PI/2),t},generate:function(e){e=e||{},this.size=void 0===e.size?this.size:e.size;var t,r,o,i=Math.ceil(this.size/2);for(t=-i;i>t;t++)for(r=-i;i>r;r++)o=new s.Cell(t,r+1),this.add(o)},generateOverlay:function(e,t,r){var o,i,n=Math.ceil(e/2);for(o=-n;n>o;o++)for(i=-n;n>i;i++){this._cel.set(o,i);var a=new THREE.Line(this.cellGeo,r);a.position.copy(this.cellToPixel(this._cel)),a.rotation.x=90*s.DEG_TO_RAD,t.add(a)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,r){s.Tools.getJSON({url:e,callback:function(e){this.fromJSON(e),t.call(r||null,e)},cache:!1,scope:this})},fromJSON:function(e){var t,r,o=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._fullCellSize=2*this.cellSize,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<o.length;t++)(r=new s.Cell).copy(o[t]),this.add(r)},toJSON:function(){var e,t,r={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},o=[];for(t in this.cells)e=this.cells[t],o.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return r.cells=o,r}},s.SqrGrid.prototype.constructor=s.SqrGrid,s.Tile=function(e){e=e||{};var t={cell:null,geometry:null,material:null};if(!(t=s.Tools.merge(t,e)).cell||!t.geometry)throw new Error("Missing vg.Tile configuration");this.cell=t.cell,this.cell.tile&&this.cell.tile!==this&&this.cell.tile.dispose(),this.cell.tile=this,this.uniqueID=s.Tools.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:s.Tools.randomizeRGB("30, 30, 30",13)})),this.objectType=s.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*s.DEG_TO_RAD,this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},s.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return null!==this._emissive&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},s.Tile.prototype.constructor=s.Tile,o=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},(i=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]}).generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},(i.prototype={getNode:function(e){return this.objToNodeMap[e.uniqueID]},addNode:function(e){var t=new o;if(!e.uniqueID)try{e.uniqueID=i.generateID()}catch(e){return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return t.obj=e,t.free=!1,this.objToNodeMap[e.uniqueID]=t,t},swapObjects:function(e,t){this.objToNodeMap[e.obj.uniqueID]=null,this.objToNodeMap[t.uniqueID]=e,e.obj=t},add:function(e){var t=this.objToNodeMap[e.uniqueID];if(t){if(!1===t.free)return;t.obj=e,t.free=!1,t.next=null,t.prev=null}else t=this.addNode(e);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=t,t.prev=this.last,this.last=t,t.next=null}else this.first=t,this.last=t,t.next=null,t.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(e){return!!this.objToNodeMap[e.uniqueID]},moveUp:function(e){this.dump("before move up");var t=this.getNode(e);if(!t)throw"Oops, trying to move an object that isn't in the list";if(t.prev){var r=t.prev,o=r.prev;t==this.last&&(this.last=r);var i=t.next;o&&(o.next=t),t.next=r,t.prev=r.prev,r.next=i,r.prev=t,this.first==r&&(this.first=t)}},moveDown:function(e){var t=this.getNode(e);if(!t)throw"Oops, trying to move an object that isn't in the list";if(t.next){var r=t.next;this.moveUp(r.obj),this.last==r&&(this.last=t)}},sort:function(e){var t,r,o=this.sortArray,i=this.first;for(o.length=0;i;)o.push(i.obj),i=i.next;for(this.clear(),o.sort(e),r=o.length,t=0;r>t;t++)this.add(o[t])},remove:function(e){var t=this.getNode(e);return!(!t||t.free||(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.prev||(this.first=t.next),t.next||(this.last=t.prev),t.free=!0,t.prev=null,t.next=null,this.length--,0))},shift:function(){var e=this.first;return 0===this.length?null:(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),this.first=e.next,e.next||(this.last=null),e.free=!0,e.prev=null,e.next=null,this.length--,e.obj)},pop:function(){var e=this.last;return 0===this.length?null:(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),this.last=e.prev,e.prev||(this.first=null),e.free=!0,e.prev=null,e.next=null,this.length--,e.obj)},concat:function(e){for(var t=e.first;t;)this.add(t.obj),t=t.next},clear:function(){for(var e=this.first;e;)e.free=!0,e=e.next;this.first=null,this.length=0},dispose:function(){for(var e=this.first;e;)e.obj=null,e=e.next;this.first=null,this.objToNodeMap=null},dump:function(e){console.log("===================="+e+"=====================");for(var t=this.first;t;)console.log("{"+t.obj.toString()+"} previous="+(t.prev?t.prev.obj:"NULL")),t=t.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}}).constructor=i,s.LinkedList=i,function(){var e=function(e,t,r,o,i){this._listener=t,this.isOnce=r,this.context=o,this.signal=e,this._priority=i||0};(e.prototype={active:!0,params:null,execute:function(e){var t,r;return this.active&&this._listener&&(r=this.params?this.params.concat(e):e,t=this._listener.apply(this.context,r),this.isOnce&&this.detach()),t},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}}).constructor=e;var t=function e(){this._bindings=[],this._prevParams=null;var t=this;this.dispatch=function(){e.prototype.dispatch.apply(t,arguments)}};(t.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(e,t){if("function"!=typeof e)throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",t))},_registerListener:function(t,r,o,i){var n,a=this._indexOfListener(t,o);if(-1!==a){if((n=this._bindings[a]).isOnce!==r)throw new Error("You cannot add"+(r?"":"Once")+"() then add"+(r?"Once":"")+"() the same listener without removing the relationship first.")}else n=new e(this,t,r,o,i),this._addBinding(n);return this.memorize&&this._prevParams&&n.execute(this._prevParams),n},_addBinding:function(e){var t=this._bindings.length;do{t--}while(this._bindings[t]&&e._priority<=this._bindings[t]._priority);this._bindings.splice(t+1,0,e)},_indexOfListener:function(e,t){for(var r,o=this._bindings.length;o--;)if((r=this._bindings[o])._listener===e&&r.context===t)return o;return-1},has:function(e,t){return-1!==this._indexOfListener(e,t)},add:function(e,t,r){return this.validateListener(e,"add"),this._registerListener(e,!1,t,r)},addOnce:function(e,t,r){return this.validateListener(e,"addOnce"),this._registerListener(e,!0,t,r)},remove:function(e,t){this.validateListener(e,"remove");var r=this._indexOfListener(e,t);return-1!==r&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)),e},removeAll:function(e){void 0===e&&(e=null);for(var t=this._bindings.length;t--;)e?this._bindings[t].context===e&&(this._bindings[t]._destroy(),this._bindings.splice(t,1)):this._bindings[t]._destroy();e||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var e,t=Array.prototype.slice.call(arguments),r=this._bindings.length;if(this.memorize&&(this._prevParams=t),r){e=this._bindings.slice(),this._shouldPropagate=!0;do{r--}while(e[r]&&this._shouldPropagate&&!1!==e[r].execute(t))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}}).constructor=t,s.Signal=t}(),s.AStarFinder=function(e){e=e||{};var t={allowDiagonal:!1,heuristicFilter:null};t=s.Tools.merge(t,e),this.allowDiagonal=t.allowDiagonal,this.heuristicFilter=t.heuristicFilter,this.list=new s.LinkedList},s.AStarFinder.prototype={findPath:function(e,t,r,o){var i,n,a,l,c,d;for(r=r||this.heuristicFilter,o.clearPath(),this.list.clear(),this.list.add(e);this.list.length>0;){if(this.list.sort(this.compare),(i=this.list.shift())._visited=!0,i===t)return s.PathUtil.backtrace(t);for(c=0,d=(a=o.getNeighbors(i,this.allowDiagonal,r)).length;d>c;c++)if((l=a[c]).walkable&&(n=i._calcCost+o.distance(i,l),!l._visited||n<l._calcCost)){if(l._visited=!0,l._parent=i,l._calcCost=n,l._priority=n+o.distance(t,l),l===t)return s.PathUtil.backtrace(t);this.list.add(l)}}return null},compare:function(e,t){return e._priority-t._priority}},s.AStarFinder.prototype.constructor=s.AStarFinder,s.PathUtil={backtrace:function(e){for(var t=[e];e._parent;)e=e._parent,t.push(e);return t.reverse()},biBacktrace:function(e,t){var r=this.backtrace(e),o=this.backtrace(t);return r.concat(o.reverse())},pathLength:function(e){var t,r,o,i,n,a=0;for(t=1;t<e.length;++t)r=e[t-1],o=e[t],i=r[0]-o[0],n=r[1]-o[1],a+=Math.sqrt(i*i+n*n);return a},interpolate:function(e,t,r,o){var i,n,a,s,l,c,d=Math.abs,u=[];for(i=r>e?1:-1,n=o>t?1:-1,l=(a=d(r-e))-(s=d(o-t));e!==r||t!==o;)u.push([e,t]),(c=2*l)>-s&&(l-=s,e+=i),a>c&&(l+=a,t+=n);return u},expandPath:function(e){var t,r,o,i,n,a,s=[],l=e.length;if(2>l)return s;for(n=0;l-1>n;++n)for(t=e[n],r=e[n+1],i=(o=this.interpolate(t[0],t[1],r[0],r[1])).length,a=0;i-1>a;++a)s.push(o[a]);return s.push(e[l-1]),s},smoothenPath:function(e,t){var r,o,i,n,a,s,l,c,d,u,h,p,m=t.length,f=t[0][0],g=t[0][1],b=t[m-1][0],_=t[m-1][1];for(a=[[r=f,o=g]],l=2;m>l;++l){for(i=(d=t[l])[0],n=d[1],u=this.interpolate(r,o,i,n),p=!1,c=1;c<u.length;++c)if(h=u[c],!e.isWalkableAt(h[0],h[1])){p=!0;break}p&&(s=t[l-1],a.push(s),r=s[0],o=s[1])}return a.push([b,_]),a},compressPath:function(e){if(e.length<3)return e;var t,r,o,i,n,a,s=[],l=e[0][0],c=e[0][1],d=e[1][0],u=e[1][1],h=d-l,p=u-c;for(h/=n=Math.sqrt(h*h+p*p),p/=n,s.push([l,c]),a=2;a<e.length;a++)t=d,r=u,o=h,i=p,h=(d=e[a][0])-t,p=(u=e[a][1])-r,p/=n=Math.sqrt(h*h+p*p),((h/=n)!==o||p!==i)&&s.push([t,r]);return s.push([d,u]),s}},s.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(e){this.crossOrigin=e||!1,this.manager=new THREE.LoadingManager((function(){}),(function(){}),(function(){console.warn("Error loading images")})),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=e},loadTexture:function(e,t,r,o){var i=new THREE.Texture(null,t);return this.imageLoader.load(e,(function(e){i.image=e,i.needsUpdate=!0,r&&r(i)}),null,(function(e){o&&o(e)})),i.sourceFile=e,i}},s.MouseCaster=function(e,t,r){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new s.Signal,this.group=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,(r=r||document).addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),r.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),r.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),r.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),r.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},s.MouseCaster.OVER="over",s.MouseCaster.OUT="out",s.MouseCaster.DOWN="down",s.MouseCaster.UP="up",s.MouseCaster.CLICK="click",s.MouseCaster.WHEEL="wheel",s.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var e,t,r=this._raycaster.intersectObject(this.group,!0);r.length>0?(t=(e=r[0]).object.userData.structure,this.pickedObject!=t&&(this.pickedObject&&this.signal.dispatch(s.MouseCaster.OUT,this.pickedObject),this.pickedObject=t,this.selectedObject=null,this.signal.dispatch(s.MouseCaster.OVER,this.pickedObject)),this.position.copy(e.point),this.screenPosition.z=e.distance):(this.pickedObject&&this.signal.dispatch(s.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=r}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(e){return(e=e||window.event).preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.down=1===e.which,this.rightDown=3===e.which,void this.signal.dispatch(s.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(e){return e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.signal.dispatch(s.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(s.MouseCaster.CLICK,this.pickedObject),this.down=1!==e.which&&this.down,void(this.rightDown=3!==e.which&&this.rightDown))},_onDocumentMouseMove:function(e){e.preventDefault(),this.screenPosition.x=e.clientX/window.innerWidth*2-1,this.screenPosition.y=-e.clientY/window.innerHeight*2+1},_onMouseWheel:function(e){if(this.active){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?this.wheel++:this.wheel--,this.signal.dispatch(s.MouseCaster.WHEEL,this.wheel)}}},s.MouseCaster.prototype.constructor=s.MouseCaster,s.Scene=function(e,t){var r={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},o={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(r=s.Tools.merge(r,e),"boolean"!=typeof t&&(o=s.Tools.merge(o,t)),this.renderer=new THREE.WebGLRenderer({alpha:r.alpha,antialias:r.antialias}),this.renderer.setClearColor(r.clearColor,0),this.renderer.sortObjects=r.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=r.orthoZoom,this.container=new THREE.Scene,this.container.fog=r.fog,this.container.add(new THREE.AmbientLight(14540253)),r.lightPosition||r.light.position.set(-1,1,-1).normalize(),this.container.add(r.light),"OrthographicCamera"===r.cameraType){var i=window.innerWidth/this.orthoZoom,n=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(i/-2,i/2,n/2,n/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=o.minDistance,this.controls.maxDistance=o.maxDistance,this.controls.zoomSpeed=o.zoomSpeed,this.controls.noZoom=o.noZoom),r.cameraPosition&&this.camera.position.copy(r.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,"OrthographicCamera"===this.camera.type){var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(r.element)},s.Scene.prototype={attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)this.orthoZoom=0;else{var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()}},focusOn:function(e){this.camera.lookAt(e.position)}},s.Scene.prototype.constructor=s.Scene,s.SelectionManager=function(e){this.mouse=e,this.onSelect=new s.Signal,this.onDeselect=new s.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},s.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case s.MouseCaster.DOWN:t||this.clearSelection();break;case s.MouseCaster.CLICK:this.select(t)}}},s.SelectionManager.prototype.constructor=s.SelectionManager,s.Tools={clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},sign:function(e){return e&&e/Math.abs(e)},random:function(e,t){return 1===arguments.length?Math.random()*e-.5*e:Math.random()*(t-e)+e},randomInt:function(e,t){return 1===arguments.length?Math.random()*e-.5*e|0:Math.random()*(t-e+1)+e|0},normalize:function(e,t,r){return(e-t)/(r-t)},getShortRotation:function(e){return(e%=this.TAU)>this.PI?e-=this.TAU:e<-this.PI&&(e+=this.TAU),e},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(e){if("object"!=(void 0===e?"undefined":a(e))||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!Object.prototype.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0},merge:function(e,t){var r=this,o=Array.isArray(t),i=o&&[]||{};return o?(e=e||[],i=i.concat(e),t.forEach((function(t,o){void 0===i[o]?i[o]=t:r.isPlainObject(t)?i[o]=r.merge(e[o],t):-1===e.indexOf(t)&&i.push(t)})),i):(e&&r.isPlainObject(e)&&Object.keys(e).forEach((function(t){i[t]=e[t]})),Object.keys(t).forEach((function(o){t[o]&&r.isPlainObject(t[o])&&e[o]?i[o]=r.merge(e[o],t[o]):i[o]=t[o]})),i)},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},radixSort:function(e,t,r,o){if(o=o||31,!((t=t||0)>=(r=r||e.length)-1||0>o)){for(var i=t,n=r,a=1<<o;n>i;)if(e[i]&a){--n;var s=e[i];e[i]=e[n],e[n]=s}else++i;this.radixSort(e,t,n,o-1),this.radixSort(e,n,r,o-1)}},randomizeRGB:function(e,t){var r,o,i=e.split(","),n="rgb(";for(t=this.randomInt(t),r=0;3>r;r++)0>(o=parseInt(i[r])+t)?o=0:o>255&&(o=255),n+=o+",";return(n=n.substring(0,n.length-1))+")"},getJSON:function(e){var t=new XMLHttpRequest,r=void 0!==e.cache&&e.cache?e.url:e.url+"?t="+Math.floor(1e4*Math.random())+Date.now();t.onreadystatechange=function(){if(200!==this.status)0!==this.status&&console.warn("[Tools.getJSON] Error: "+this.status+" ("+this.statusText+") :: "+e.url);else{var t=null;try{t=JSON.parse(this.responseText)}catch(e){return}e.callback.call(e.scope||null,t)}},t.open("GET",r,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send("")}}},{}],10:[function(e,t,r){"use strict";!function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var r=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,o=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,i=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,n=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function a(e,t){return-1!==String(e).indexOf(t)}var s=a(navigator.platform,"Win")?"win":a(navigator.platform,"Mac")?"mac":a(navigator.platform,"CrOS")?"cros":a(navigator.platform,"Linux")?"linux":a(navigator.userAgent,"iPad")||a(navigator.platform,"iPod")||a(navigator.platform,"iPhone")?"ios":"",l=a(navigator.userAgent,"Chrome/")?"chrome":a(navigator.vendor,"Apple")?"safari":a(navigator.userAgent,"MSIE")?"ie":a(navigator.userAgent,"Gecko/")?"moz":a(navigator.userAgent,"Opera/")?"opera":"",c=l+"-"+s;function d(e,t,r){c!==t&&l!==t&&s!==t||Object.keys(r).forEach((function(t){e[t]=r[t]}))}var u={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:o},92:{code:"OSRight",location:i},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:n},97:{code:"Numpad1",keyCap:"1",location:n},98:{code:"Numpad2",keyCap:"2",location:n},99:{code:"Numpad3",keyCap:"3",location:n},100:{code:"Numpad4",keyCap:"4",location:n},101:{code:"Numpad5",keyCap:"5",location:n},102:{code:"Numpad6",keyCap:"6",location:n},103:{code:"Numpad7",keyCap:"7",location:n},104:{code:"Numpad8",keyCap:"8",location:n},105:{code:"Numpad9",keyCap:"9",location:n},106:{code:"NumpadMultiply",keyCap:"*",location:n},107:{code:"NumpadAdd",keyCap:"+",location:n},108:{code:"NumpadComma",keyCap:",",location:n},109:{code:"NumpadSubtract",keyCap:"-",location:n},110:{code:"NumpadDecimal",keyCap:".",location:n},111:{code:"NumpadDivide",keyCap:"/",location:n},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:n},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:o},161:{code:"ShiftRight",location:i},162:{code:"ControlLeft",location:o},163:{code:"ControlRight",location:i},164:{code:"AltLeft",location:o},165:{code:"AltRight",location:i},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};d(u,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:n},189:{code:"NumpadSubtract",keyCap:"-",location:n}}),d(u,"moz-mac",{12:{code:"NumLock",location:n},173:{code:"Minus",keyCap:"-"}}),d(u,"moz-win",{173:{code:"Minus",keyCap:"-"}}),d(u,"chrome-mac",{93:{code:"OSRight",location:i}}),d(u,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),d(u,"ios",{10:{code:"Enter",location:r}}),d(u,"safari-mac",{91:{code:"OSLeft",location:o},93:{code:"OSRight",location:i},229:{code:"KeyQ",keyCap:"Q"}});var h={};"cros"===s&&(h["U+00A0"]={code:"ShiftLeft",location:o},h["U+00A1"]={code:"ShiftRight",location:i},h["U+00A2"]={code:"ControlLeft",location:o},h["U+00A3"]={code:"ControlRight",location:i},h["U+00A4"]={code:"AltLeft",location:o},h["U+00A5"]={code:"AltRight",location:i}),"chrome-mac"===c&&(h["U+0010"]={code:"ContextMenu"}),"safari-mac"===c&&(h["U+0010"]={code:"ContextMenu"}),"ios"===s&&(h["U+0010"]={code:"Function"},h["U+001C"]={code:"ArrowLeft"},h["U+001D"]={code:"ArrowRight"},h["U+001E"]={code:"ArrowUp"},h["U+001F"]={code:"ArrowDown"},h["U+0001"]={code:"Home"},h["U+0004"]={code:"End"},h["U+000B"]={code:"PageUp"},h["U+000C"]={code:"PageDown"});var p=[];p[o]={16:{code:"ShiftLeft",location:o},17:{code:"ControlLeft",location:o},18:{code:"AltLeft",location:o}},p[i]={16:{code:"ShiftRight",location:i},17:{code:"ControlRight",location:i},18:{code:"AltRight",location:i}},p[n]={13:{code:"NumpadEnter",location:n}},d(p[n],"moz",{109:{code:"NumpadSubtract",location:n},107:{code:"NumpadAdd",location:n}}),d(p[o],"moz-mac",{224:{code:"OSLeft",location:o}}),d(p[i],"moz-mac",{224:{code:"OSRight",location:i}}),d(p[i],"moz-win",{91:{code:"OSRight",location:i}}),d(p[i],"mac",{93:{code:"OSRight",location:i}}),d(p[n],"chrome-mac",{12:{code:"NumLock",location:n}}),d(p[n],"safari-mac",{12:{code:"NumLock",location:n},187:{code:"NumpadAdd",location:n},189:{code:"NumpadSubtract",location:n},190:{code:"NumpadDecimal",location:n},191:{code:"NumpadDivide",location:n}});var m={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};d(m,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var f,g,b,_={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},v=(f=u,g="code",b={},Object.keys(f).forEach((function(e){var t=f[e];g in t&&(b[t[g]]=t)})),b);try{var y=t&&"location"in new KeyboardEvent("")}catch(e){}function w(e){var t="keyCode"in e?e.keyCode:"which"in e?e.which:0,r=function(){if(y||"keyLocation"in e){var r=y?e.location:e.keyLocation;if(r&&t in p[r])return p[r][t]}return"keyIdentifier"in e&&e.keyIdentifier in h?h[e.keyIdentifier]:t in u?u[t]:null}();if(!r)return null;var o,i=(o=m[r.code])?e.shiftKey&&"shiftKey"in o?o.shiftKey:o.key:r.code;return{code:r.code,key:i,location:r.location,keyCap:r.keyCap}}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function e(e,t,r){t in e||Object.defineProperty(e,t,r)}if(e(KeyboardEvent.prototype,"code",{get:function(){var e=w(this);return e?e.code:""}}),"key"in KeyboardEvent.prototype){var t=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var e=t.get.call(this);return _.hasOwnProperty(e)?_[e]:e}})}e(KeyboardEvent.prototype,"key",{get:function(){var e=w(this);return e&&"key"in e?e.key:"Unidentified"}}),e(KeyboardEvent.prototype,"location",{get:function(){var e=w(this);return e&&"location"in e?e.location:r}}),e(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=function(e,t){if(e=String(e),!v.hasOwnProperty(e))return"Undefined";if(t&&"en-us"!==String(t).toLowerCase())throw Error("Unsupported locale");var r=v[e];return r.keyCap||r.code||"Undefined"}),e.identifyKey=function(e){if(!("code"in e)){var t=w(e);e.code=t?t.code:"",e.key=t&&"key"in t?t.key:"Unidentified",e.location="location"in e?e.location:"keyLocation"in e?e.keyLocation:t&&"location"in t?t.location:r,e.locale=""}}}(window)},{}],11:[function(e,t,r){var o=function(){};o.computeCentroids=function(e){var t,r,o;for(t=0,r=e.faces.length;t<r;t++)(o=e.faces[t]).centroid=new THREE.Vector3(0,0,0),o.centroid.add(e.vertices[o.a]),o.centroid.add(e.vertices[o.b]),o.centroid.add(e.vertices[o.c]),o.centroid.divideScalar(3)},o.roundNumber=function(e,t){return Number(e.toFixed(t))},o.sample=function(e){return e[Math.floor(Math.random()*e.length)]},o.mergeVertexIds=function(e,t){var r=[];if(e.forEach((function(e){t.indexOf(e)>=0&&r.push(e)})),r.length<2)return[];r.includes(e[0])&&r.includes(e[e.length-1])&&e.push(e.shift()),r.includes(t[0])&&r.includes(t[t.length-1])&&t.push(t.shift()),r=[],e.forEach((function(e){t.includes(e)&&r.push(e)}));for(var o=r[1],i=r[0],n=e.slice();n[0]!==o;)n.push(n.shift());for(var a=0,s=t.slice();s[0]!==i;)if(s.push(s.shift()),a++>10)throw new Error("Unexpected state");return s.shift(),s.pop(),n.concat(s)},o.setPolygonCentroid=function(e,t){var r=new THREE.Vector3,o=t.vertices;e.vertexIds.forEach((function(e){r.add(o[e])})),r.divideScalar(e.vertexIds.length),e.centroid.copy(r)},o.cleanPolygon=function(e,t){for(var r=[],o=t.vertices,i=0;i<e.vertexIds.length;i++){var n,a,s,l=o[e.vertexIds[i]];0===i?(n=e.vertexIds[1],a=e.vertexIds[e.vertexIds.length-1]):i===e.vertexIds.length-1?(n=e.vertexIds[0],a=e.vertexIds[e.vertexIds.length-2]):(n=e.vertexIds[i+1],a=e.vertexIds[i-1]),s=o[a];var c=o[n].clone().sub(l),d=s.clone().sub(l),u=c.angleTo(d);if(u>Math.PI-.01&&u<Math.PI+.01){var h=[];e.neighbours.forEach((function(t){t.vertexIds.includes(e.vertexIds[i])||h.push(t)})),e.neighbours=h}else r.push(e.vertexIds[i])}e.vertexIds=r,this.setPolygonCentroid(e,t)},o.isConvex=function(e,t){var r=t.vertices;if(e.vertexIds.length<3)return!1;for(var o=!0,i=[],n=0;n<e.vertexIds.length;n++){var a,s,l=r[e.vertexIds[n]];0===n?(a=r[e.vertexIds[1]],s=r[e.vertexIds[e.vertexIds.length-1]]):n===e.vertexIds.length-1?(a=r[e.vertexIds[0]],s=r[e.vertexIds[e.vertexIds.length-2]]):(a=r[e.vertexIds[n+1]],s=r[e.vertexIds[n-1]]);var c=a.clone().sub(l),d=s.clone().sub(l),u=c.angleTo(d);if(u===Math.PI||0===u)return!1;var h=c.cross(d).y;i.push(h)}return i.forEach((function(e){0===e&&(o=!1)})),i.forEach(i[0]>0?function(e){e<0&&(o=!1)}:function(e){e>0&&(o=!1)}),o},o.distanceToSquared=function(e,t){var r=e.x-t.x,o=e.y-t.y,i=e.z-t.z;return r*r+o*o+i*i},o.isPointInPoly=function(e,t){for(var r=!1,o=-1,i=e.length,n=i-1;++o<i;n=o)(e[o].z<=t.z&&t.z<e[n].z||e[n].z<=t.z&&t.z<e[o].z)&&t.x<(e[n].x-e[o].x)*(t.z-e[o].z)/(e[n].z-e[o].z)+e[o].x&&(r=!r);return r},o.isVectorInPolygon=function(e,t,r){var o=1e5,i=-1e5,n=[];return t.vertexIds.forEach((function(e){o=Math.min(r[e].y,o),i=Math.max(r[e].y,i),n.push(r[e])})),!!(e.y<i+.5&&e.y>o-.5&&this.isPointInPoly(n,e))},o.triarea2=function(e,t,r){return(r.x-e.x)*(t.z-e.z)-(t.x-e.x)*(r.z-e.z)},o.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5};var i=function(e){this.content=[],this.scoreFunction=e};i.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},i.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},i.prototype.remove=function(e){var t=this.content.indexOf(e),r=this.content.pop();t!==this.content.length-1&&(this.content[t]=r,this.scoreFunction(r)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},i.prototype.size=function(){return this.content.length},i.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},i.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var r=(e+1>>1)-1,o=this.content[r];if(!(this.scoreFunction(t)<this.scoreFunction(o)))break;this.content[r]=t,this.content[e]=o,e=r}},i.prototype.bubbleUp=function(e){for(var t=this.content.length,r=this.content[e],o=this.scoreFunction(r);;){var i=e+1<<1,n=i-1,a=null,s=void 0;if(n<t&&(s=this.scoreFunction(this.content[n]))<o&&(a=n),i<t&&this.scoreFunction(this.content[i])<(null===a?o:s)&&(a=i),null===a)break;this.content[e]=this.content[a],this.content[a]=r,e=a}};var n=function(){};n.init=function(e){for(var t=0;t<e.length;t++){var r=e[t];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}},n.cleanUp=function(e){for(var t=0;t<e.length;t++){var r=e[t];delete r.f,delete r.g,delete r.h,delete r.cost,delete r.visited,delete r.closed,delete r.parent}},n.heap=function(){return new i((function(e){return e.f}))},n.search=function(e,t,r){this.init(e);var o=this.heap();for(o.push(t);o.size()>0;){var i=o.pop();if(i===r){for(var n=i,a=[];n.parent;)a.push(n),n=n.parent;return this.cleanUp(a),a.reverse()}i.closed=!0;for(var s=this.neighbours(e,i),l=0,c=s.length;l<c;l++){var d=s[l];if(!d.closed){var u=i.g+d.cost,h=d.visited;if(!h||u<d.g){if(d.visited=!0,d.parent=i,!d.centroid||!r.centroid)throw new Error("Unexpected state");d.h=d.h||this.heuristic(d.centroid,r.centroid),d.g=u,d.f=d.g+d.h,h?o.rescoreElement(d):o.push(d)}}}}return[]},n.heuristic=function(e,t){return o.distanceToSquared(e,t)},n.neighbours=function(e,t){for(var r=[],o=0;o<t.neighbours.length;o++)r.push(e[t.neighbours[o]]);return r};var a=1,s=function(){};s.buildZone=function(e){var t=this,r=this._buildNavigationMesh(e),i={};r.vertices.forEach((function(e){e.x=o.roundNumber(e.x,2),e.y=o.roundNumber(e.y,2),e.z=o.roundNumber(e.z,2)})),i.vertices=r.vertices;var n=this._buildPolygonGroups(r);i.groups=[];var a=function(e,t){for(var r=0;r<e.length;r++)if(t===e[r])return r};return n.forEach((function(e){var r=[];e.forEach((function(i){var n=i.neighbours.map((function(t){return a(e,t)})),s=i.neighbours.map((function(e){return t._getSharedVerticesInOrder(i,e)}));i.centroid.x=o.roundNumber(i.centroid.x,2),i.centroid.y=o.roundNumber(i.centroid.y,2),i.centroid.z=o.roundNumber(i.centroid.z,2),r.push({id:a(e,i),neighbours:n,vertexIds:i.vertexIds,centroid:i.centroid,portals:s})})),i.groups.push(r)})),i},s._buildNavigationMesh=function(e){return o.computeCentroids(e),e.mergeVertices(),this._buildPolygonsFromGeometry(e)},s._buildPolygonGroups=function(e){var t=[],r=0,o=function(e){e.neighbours.forEach((function(t){void 0===t.group&&(t.group=e.group,o(t))}))};return e.polygons.forEach((function(e){void 0===e.group&&(e.group=r++,o(e)),t[e.group]||(t[e.group]=[]),t[e.group].push(e)})),t},s._buildPolygonNeighbours=function(e,t,r){var o=new Set,i=r.get(e.vertexIds[0]),n=r.get(e.vertexIds[1]),a=r.get(e.vertexIds[2]);i.forEach((function(e){(n.has(e)||a.has(e))&&o.add(t.polygons[e])})),n.forEach((function(e){a.has(e)&&o.add(t.polygons[e])})),e.neighbours=Array.from(o)},s._buildPolygonsFromGeometry=function(e){for(var t=this,r=[],o=e.vertices,i=e.faceVertexUvs,n=new Map,s=0;s<o.length;s++)n.set(s,new Set);e.faces.forEach((function(e){r.push({id:a++,vertexIds:[e.a,e.b,e.c],centroid:e.centroid,normal:e.normal,neighbours:[]}),n.get(e.a).add(r.length-1),n.get(e.b).add(r.length-1),n.get(e.c).add(r.length-1)}));var l={polygons:r,vertices:o,faceVertexUvs:i};return r.forEach((function(e){t._buildPolygonNeighbours(e,l,n)})),l},s._getSharedVerticesInOrder=function(e,t){var r=e.vertexIds,o=t.vertexIds,i=new Set;if(r.forEach((function(e){o.includes(e)&&i.add(e)})),i.size<2)return[];i.has(r[0])&&i.has(r[r.length-1])&&r.push(r.shift()),i.has(o[0])&&i.has(o[o.length-1])&&o.push(o.shift());var n=[];return r.forEach((function(e){o.includes(e)&&n.push(e)})),n};var l=function(){this.portals=[]};l.prototype.push=function(e,t){void 0===t&&(t=e),this.portals.push({left:e,right:t})},l.prototype.stringPull=function(){var e,t,r,i=this.portals,n=[],a=0,s=0,l=0;t=i[0].left,r=i[0].right,n.push(e=i[0].left);for(var c=1;c<i.length;c++){var d=i[c].left,u=i[c].right;if(o.triarea2(e,r,u)<=0){if(!(o.vequal(e,r)||o.triarea2(e,t,u)>0)){n.push(t),t=e=t,r=e,s=a=s,l=a,c=a;continue}r=u,l=c}if(o.triarea2(e,t,d)>=0){if(!(o.vequal(e,t)||o.triarea2(e,r,d)<0)){n.push(r),t=e=r,r=e,s=a=l,l=a,c=a;continue}t=d,s=c}}return 0!==n.length&&o.vequal(n[n.length-1],i[i.length-1].left)||n.push(i[i.length-1].left),this.path=n,n};var c,d,u,h,p,m,f=function(){this.zones={}};f.createZone=function(e){return s.buildZone(e)},f.prototype.setZoneData=function(e,t){this.zones[e]=t},f.prototype.getGroup=function(e,t){if(!this.zones[e])return null;var r=null,i=Math.pow(50,2);return this.zones[e].groups.forEach((function(e,n){e.forEach((function(e){var a=o.distanceToSquared(e.centroid,t);a<i&&(r=n,i=a)}))})),r},f.prototype.getRandomNode=function(e,t,r,i){if(!this.zones[e])return new THREE.Vector3;r=r||null,i=i||0;var n=[];return this.zones[e].groups[t].forEach((function(e){r&&i?o.distanceToSquared(r,e.centroid)<i*i&&n.push(e.centroid):n.push(e.centroid)})),o.sample(n)||new THREE.Vector3},f.prototype.getClosestNode=function(e,t,r,i){void 0===i&&(i=!1);var n=this.zones[t].vertices,a=null,s=1/0;return this.zones[t].groups[r].forEach((function(t){var r=o.distanceToSquared(t.centroid,e);r<s&&(!i||o.isVectorInPolygon(e,t,n))&&(a=t,s=r)})),a},f.prototype.findPath=function(e,t,r,o){var i=this.zones[r].groups[o],a=this.zones[r].vertices,s=this.getClosestNode(e,r,o),c=this.getClosestNode(t,r,o,!0);if(!s||!c)return null;var d=n.search(i,s,c),u=function(e,t){for(var r=0;r<e.neighbours.length;r++)if(e.neighbours[r]===t.id)return e.portals[r]},h=new l;h.push(e);for(var p=0;p<d.length;p++){var m=d[p+1];if(m){var f=u(d[p],m);h.push(a[f[0]],a[f[1]])}}h.push(t),h.stringPull();var g=h.path.map((function(e){return new THREE.Vector3(e.x,e.y,e.z)}));return g.shift(),g},f.prototype.clampStep=(u=new THREE.Vector3,h=new THREE.Plane,p=new THREE.Triangle,m=new THREE.Vector3,function(e,t,r,o,i,n){var a=this.zones[o].vertices,s=this.zones[o].groups[i],l=[r],f={};f[r.id]=0,c=void 0,m.set(0,0,0),d=1/0,h.setFromCoplanarPoints(a[r.vertexIds[0]],a[r.vertexIds[1]],a[r.vertexIds[2]]),h.projectPoint(t,u),t.copy(u);for(var g=l.pop();g;g=l.pop()){p.set(a[g.vertexIds[0]],a[g.vertexIds[1]],a[g.vertexIds[2]]),p.closestPointToPoint(t,u),u.distanceToSquared(t)<d&&(c=g,m.copy(u),d=u.distanceToSquared(t));var b=f[g];if(!(b>2))for(var _=0;_<g.neighbours.length;_++){var v=s[g.neighbours[_]];v.id in f||(l.push(v),f[v.id]=b+1)}}return n.copy(m),c}),r.Pathfinding=f},{}],12:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){var t=this.el;this.active&&this.checkpoint!==e&&(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<.1?this.checkpoint=null:(t.emit("navigation-start",{checkpoint:e}),"teleport"===this.data.mode&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())))},isVelocityActive:function(){return!(!this.active||!this.checkpoint)},getVelocity:function(){if(this.active){var e=this.data,t=this.offset,r=this.position,o=this.targetPosition,i=this.checkpoint;return this.sync(),r.distanceTo(o)<.1?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:i}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)}},sync:function(){var e=this.offset,t=this.position,r=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(r),r.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(r).sub(t)}})},{}],13:[function(e,t,r){"use strict";var o=e("../../lib/GamepadButton"),i=e("../../lib/GamepadButtonEvent"),n=.2;t.exports=AFRAME.registerComponent("gamepad-controls",{GamepadButton:o,schema:{controller:{default:0,oneOf:[0,1,2,3]},enabled:{default:!0},debug:{default:!1},camera:{default:"[camera]",type:"selector"},rotationSensitivity:{default:2}},init:function(){var e=this.el.sceneEl;this.prevTime=window.performance.now(),this.buttons={};var t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=THREE.Math.degToRad(t.x),this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=THREE.Math.degToRad(t.y),this.yaw.add(this.pitch),e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;var e=this.getDpad(),t=this.getJoystick(0),r=e.x||t.x,o=e.y||t.y;return Math.abs(r)>n||Math.abs(o)>n},getVelocityDelta:function(){var e=this.getDpad(),t=this.getJoystick(0),r=e.x||t.x,o=e.y||t.y,i=new THREE.Vector3;return Math.abs(r)>n&&(i.x+=r),Math.abs(o)>n&&(i.z+=o),i},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;var e=this.getJoystick(1);return Math.abs(e.x)>n||Math.abs(e.y)>n},updateRotation:function(e){if(this.isRotationActive()){var t=this.data,r=this.yaw,o=this.pitch,i=t.camera.components["look-controls"],a=i&&i.pitchObject&&i.yawObject;a&&(o.rotation.copy(i.pitchObject.rotation),r.rotation.copy(i.yawObject.rotation));var s=this.getJoystick(1);Math.abs(s.x)<=n&&(s.x=0),Math.abs(s.y)<=n&&(s.y=0),s.multiplyScalar(t.rotationSensitivity*e/1e3),r.rotation.y-=s.x,o.rotation.x-=s.y,o.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,o.rotation.x)),t.camera.object3D.rotation.set(o.rotation.x,r.rotation.y,0),a&&(i.pitchObject.rotation.copy(o.rotation),i.yawObject.rotation.copy(r.rotation))}},updateButtonState:function(){var e=this.getGamepad();if(this.data.enabled&&e)for(var t=0;t<e.buttons.length;t++)e.buttons[t].pressed&&!this.buttons[t]?this.emit(new i("gamepadbuttondown",t,e.buttons[t])):!e.buttons[t].pressed&&this.buttons[t]&&this.emit(new i("gamepadbuttonup",t,e.buttons[t])),this.buttons[t]=e.buttons[t].pressed;else Object.keys(this.buttons)&&(this.buttons={})},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new i(e.type,e.index,e))},getGamepad:function(){var e=navigator.getGamepads&&navigator.getGamepads()[this.data.controller],t=this.el.sceneEl.components["proxy-controls"];return t&&t.isConnected()&&t.getGamepad(this.data.controller)||e},getButton:function(e){return this.getGamepad().buttons[e]},getAxis:function(e){return this.getGamepad().axes[e]},getJoystick:function(e){var t=this.getGamepad();switch(e){case 0:return new THREE.Vector2(t.axes[0],t.axes[1]);case 1:return new THREE.Vector2(t.axes[2],t.axes[3]);default:throw new Error('Unexpected joystick index "%d".',e)}},getDpad:function(){var e=this.getGamepad();return e.buttons[o.DPAD_RIGHT]?new THREE.Vector2((e.buttons[o.DPAD_RIGHT].pressed?1:0)+(e.buttons[o.DPAD_LEFT].pressed?-1:0),(e.buttons[o.DPAD_UP].pressed?-1:0)+(e.buttons[o.DPAD_DOWN].pressed?1:0)):new THREE.Vector2},isConnected:function(){var e=this.getGamepad();return!(!e||!e.connected)},getID:function(){return this.getGamepad().id}})},{"../../lib/GamepadButton":5,"../../lib/GamepadButtonEvent":6}],14:[function(e,t,r){"use strict";e("./checkpoint-controls"),e("./gamepad-controls"),e("./keyboard-controls"),e("./touch-controls"),e("./movement-controls"),e("./trackpad-controls")},{"./checkpoint-controls":12,"./gamepad-controls":13,"./keyboard-controls":15,"./movement-controls":16,"./touch-controls":17,"./trackpad-controls":18}],15:[function(e,t,r){"use strict";e("../../lib/keyboard.polyfill");var o=window.KeyboardEvent;t.exports=AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this)},this.attachEventListeners()},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){var e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1)),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.pause()},attachEventListeners:function(){window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(var e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(e){"__keyboard-controls-proxy"in e&&this.el.emit(e.type,e),this.el.emit(e.type+":"+e.code,new o(e.type,e)),this.data.debug&&console.log(e.type+":"+e.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){var e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}})},{"../../lib/keyboard.polyfill":10}],16:[function(e,t,r){"use strict";var o,i,n,a,s,l="-controls";t.exports=AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){var e=this.el;this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(e){var t=this.el,r=this.data,o=t.sceneEl.systems.nav;t.sceneEl.hasLoaded&&this.injectControls(),o&&r.constrainToNavMesh!==e.constrainToNavMesh&&(r.constrainToNavMesh?o.addAgent(this):o.removeAgent(this))},injectControls:function(){for(var e,t=this.data,r=0;r<t.controls.length;r++)e=t.controls[r]+l,this.el.components[e]||this.el.setAttribute(e,"")},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:(n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,function(e,t){if(t){var r=this.el,o=this.data;if(o.enabled){this.updateVelocityCtrl();var i=this.velocityCtrl,l=this.velocity;if(i)if(t/1e3>.2?l.set(0,0,0):this.updateVelocity(t),o.constrainToNavMesh&&!1!==i.isNavMeshConstrained){if(l.lengthSq()<1e-5)return;n.copy(r.object3D.position),a.copy(l).multiplyScalar(t/1e3).add(n);var c=r.sceneEl.systems.nav;this.navGroup=null===this.navGroup?c.getGroup(n):this.navGroup,this.navNode=this.navNode||c.getNode(n,this.navGroup),this.navNode=c.clampStep(n,a,this.navGroup,this.navNode,s),r.object3D.position.copy(s)}else r.hasAttribute("velocity")?r.setAttribute("velocity",l):(r.object3D.position.x+=l.x*t/1e3,r.object3D.position.y+=l.y*t/1e3,r.object3D.position.z+=l.z*t/1e3)}}}),updateVelocityCtrl:function(){var e=this.data;if(e.enabled){for(var t=0,r=e.controls.length;t<r;t++){var o=this.el.components[e.controls[t]+l];if(o&&o.isVelocityActive())return void(this.velocityCtrl=o)}this.velocityCtrl=null}},updateVelocity:(o=new THREE.Vector2,i=new THREE.Quaternion,function(e){var t=void 0,r=this.el,n=this.velocityCtrl,a=this.velocity,s=this.data;if(n){if(!n.getVelocityDelta){if(n.getVelocity)return void a.copy(n.getVelocity());if(n.getPositionDelta)return void a.copy(n.getPositionDelta(e).multiplyScalar(1e3/e));throw new Error("Incompatible movement controls: ",n)}t=n.getVelocityDelta(e)}if(r.hasAttribute("velocity")&&!s.constrainToNavMesh&&a.copy(this.el.getAttribute("velocity")),t&&s.enabled){var l=s.camera;i.copy(l.object3D.quaternion),i.premultiply(r.object3D.quaternion),t.applyQuaternion(i);var c=t.length();s.fly?(a.copy(t),a.multiplyScalar(16.66667*this.data.speed)):(o.set(t.x,t.z),o.setLength(c*this.data.speed*16.66667),a.x=o.x,a.z=o.y)}})})},{}],17:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){var e=this.el.sceneEl,t=e.canvas;t?(t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchend",this.onTouchEnd)):e.addEventListener("render-target-loaded",this.addEventListeners.bind(this))},removeEventListeners:function(){var e=this.el.sceneEl&&this.el.sceneEl.canvas;e&&(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&2===e.touches.length&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()}})},{}],18:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){var e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd)}},removeEventListeners:function(){var e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":case"press":this.isMoving=!0}e.preventDefault()},onTouchEnd:function(e){"swipe"==this.data.mode&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){var t=this.data,r=e.detail.axis;if(0===this.startingAxisData.length&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=r[0],this.startingAxisData[1]=r[1]),this.startingAxisData.length>0){var o=0,i=0;t.enableNegX&&r[0]<this.startingAxisData[0]&&(o=-1),t.enablePosX&&r[0]>this.startingAxisData[0]&&(o=1),t.enablePosZ&&r[1]>this.startingAxisData[1]&&(i=-1),t.enableNegZ&&r[1]<this.startingAxisData[1]&&(i=1);var n=Math.abs(this.startingAxisData[1]-r[1]);Math.abs(this.startingAxisData[0]-r[0])>n?(this.zVel=0,this.xVel=o,this.isMoving=!0):(this.xVel=0,this.zVel=i,this.isMoving=!0)}},handleTouchAxis:function(e){var t=this.data,r=e.detail.axis,o=0,i=0;t.enableNegX&&r[0]<0&&(o=-1),t.enablePosX&&r[0]>0&&(o=1),t.enablePosZ&&r[1]>0&&(i=-1),t.enableNegZ&&r[1]<0&&(i=1),Math.abs(r[0])>Math.abs(r[1])?(this.zVel=0,this.xVel=o):(this.xVel=0,this.zVel=i)}})},{}],19:[function(e,t,r){"use strict";var o={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};function i(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}t.exports=AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(o)},repetitions:{default:1/0,min:0},timeScale:{default:1}},init:function(){var e=this;this.model=null,this.mixer=null,this.activeActions=[];var t=this.el.getObject3D("mesh");t?this.load(t):this.el.addEventListener("model-loaded",(function(t){e.load(t.detail.model)}))},load:function(e){if(this.el==e.el){var t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",(function(e){t.emit("animation-loop",{action:e.action,loopDelta:e.loopDelta})})),this.mixer.addEventListener("finished",(function(e){t.emit("animation-finished",{action:e.action,direction:e.direction})})),this.data.clip&&this.update({})}},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(e){if(e){var t=this.data,r=AFRAME.utils.diff(t,e);if("clip"in r)return this.stopAction(),void(t.clip&&this.playAction());this.activeActions.forEach((function(e){"duration"in r&&t.duration&&e.setDuration(t.duration),"clampWhenFinished"in r&&(e.clampWhenFinished=t.clampWhenFinished),("loop"in r||"repetitions"in r)&&e.setLoop(o[t.loop],t.repetitions),"timeScale"in r&&e.setEffectiveTimeScale(t.timeScale)}))}},stopAction:function(){for(var e=this.data,t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(this.mixer){var e=this.model,t=this.data,r=e.animations||(e.geometry||{}).animations||[];if(r.length)for(var n,a,s=(n=t.clip,new RegExp("^"+n.split(/\*+/).map(i).join(".*")+"$")),l=0;a=r[l];l++)if(a.name.match(s)){var c=this.mixer.clipAction(a,e);c.enabled=!0,c.clampWhenFinished=t.clampWhenFinished,t.duration&&c.setDuration(t.duration),1!==t.timeScale&&c.setEffectiveTimeScale(t.timeScale),c.setLoop(o[t.loop],t.repetitions).fadeIn(t.crossFadeDuration).play(),this.activeActions.push(c)}}},tick:function(e,t){if(this.mixer&&!isNaN(t)){if(this.mixer.update(t/1e3),!this.mixer._actions[0])return;if(this.model.animationSlices&&this.model.animationSlices[0].uid){for(let e=1;e<this.model.animationSlices.length;e++)if(this.model.animationSlices[0].uid==this.model.animationSlices[e].uid)var r=e;if(this.model.animationSlices[r]&&(this.model.animationSlices[0].changed&&(this.mixer._actions[0].time=this.model.animationSlices[r].startTime,this.model.animationSlices[0].changed=!1,this.model.animationSlices[0].count=0),this.model.animationSlices[0].reset||1!=this.model.animationSlices[0].count||(this.mixer._actions[0].time=this.model.animationSlices[r].endTime),this.mixer._actions[0].time<this.model.animationSlices[r].startTime&&(this.mixer._actions[0].time=this.model.animationSlices[r].startTime),this.mixer._actions[0].time>this.model.animationSlices[r].endTime)){if(this.model.animationSlices[0].uid==this.model.animationSlices[0].loop)this.mixer._actions[0].time=this.model.animationSlices[r].startTime;else if(this.model.animationSlices[0].reset){this.model.animationSlices[0].uid=this.model.animationSlices[0].idle,this.model.animationSlices[0].loop=this.model.animationSlices[0].idle;for(let e=1;e<this.model.animationSlices.length;e++)this.model.animationSlices[0].uid==this.model.animationSlices[e].uid&&(r=e,this.model.el.setAttribute("animation-mixer","clip: "+this.model.animationSlices[e].animationName));this.mixer._actions[0].time=this.model.animationSlices[r].startTime}this.model.animationSlices[0].count=1}}}}})},{}],20:[function(e,t,r){"use strict";THREE.ColladaLoader=e("../../lib/ColladaLoader"),t.exports.Component=AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,r=this.data,o=this.el.sceneEl.systems.renderer;r&&(this.remove(),this.loader.load(r,(function(r){e.model=r.scene,e.model.traverse((function(e){if(e.isMesh){var t=e.material;t.color&&o.applyColorCorrection(t.color),t.map&&o.applyColorCorrection(t.map),t.emissive&&o.applyColorCorrection(t.emissive),t.emissiveMap&&o.applyColorCorrection(t.emissiveMap)}})),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})})))},remove:function(){this.model&&this.el.removeObject3D("mesh")}})},{"../../lib/ColladaLoader":3}],21:[function(e,t,r){"use strict";THREE.FBXLoader=e("../../lib/FBXLoader"),t.exports=AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){var e=this.data;if(e.src){this.remove();var t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))}},load:function(e){let t=new THREE.Vector3(1,1,1);!function(e,t){if(e["LastSaved|ApplicationName"])switch(e["LastSaved|ApplicationName"].value){case"3ds Max":e.OriginalUnitScaleFactor?t.multiplyScalar(e.OriginalUnitScaleFactor):t.multiplyScalar(100);break;case"Maya":e.OriginalUnitScaleFactor&&t.multiplyScalar(e.OriginalUnitScaleFactor)}}(e,t),e.scale.copy(t.multiplyScalar(.01)),this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}})},{"../../lib/FBXLoader":4}],22:[function(e,t,r){"use strict";var o,i=e("../../lib/fetch-script")(),n=(o=void 0,function(){return o=o||i("https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js")});t.exports=AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){var e=this;this.model=null,this.loader=null,this.loaderPromise=n().then((function(){e.loader=new THREE.GLTFLoader,e.loader.setCrossOrigin("Anonymous")}))},update:function(){var e=this,t=this,r=this.el,o=this.data;o&&(this.remove(),this.loaderPromise.then((function(){e.loader.load(o,(function(e){t.model=e.scene,t.model.animations=e.animations,r.setObject3D("mesh",t.model),r.emit("model-loaded",{format:"gltf",model:t.model})}))})))},remove:function(){this.model&&this.el.removeObject3D("mesh")}})},{"../../lib/fetch-script":8}],23:[function(e,t,r){"use strict";e("./animation-mixer"),e("./collada-model-legacy"),e("./fbx-model"),e("./gltf-model-legacy"),e("./object-model")},{"./animation-mixer":19,"./collada-model-legacy":20,"./fbx-model":21,"./gltf-model-legacy":22,"./object-model":24}],24:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){var e=this,t=void 0,r=this.data;r.src&&(this.remove(),t=new THREE.ObjectLoader,r.crossorigin&&t.setCrossOrigin(r.crossorigin),t.load(r.src,(function(t){t.traverse((function(e){e instanceof THREE.SkinnedMesh&&e.material&&(e.material.skinning=!!(e.geometry&&e.geometry.bones||[]).length)})),e.load(t)})))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}})},{}],25:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){var e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}})},{}],26:[function(e,t,r){"use strict";function o(e,t,r,o){e&&(t=t||[],e.traverse((function(e){var i;e.isMesh&&((i=e.material)?Array.isArray(i)?i:i.materials?i.materials:[i]:[]).forEach((function(e){e&&!("envMap"in e)||t.length&&-1===t.indexOf(e.name)||(e.envMap=r,e.reflectivity=o,e.needsUpdate=!0)}))})))}t.exports=AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},format:{default:"RGBFormat",oneOf:["RGBFormat","RGBAFormat"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){var e=this,t=this.data;this.texture=(new THREE.CubeTextureLoader).load([t.path+"posx."+t.extension,t.path+"negx."+t.extension,t.path+"posy."+t.extension,t.path+"negy."+t.extension,t.path+"posz."+t.extension,t.path+"negz."+t.extension]),this.texture.format=THREE[t.format],this.object3dsetHandler=function(){var t=e.el.getObject3D("mesh"),r=e.data;o(t,r.materials,e.texture,r.reflectivity)},this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(e){var t=this.data,r=this.el.getObject3D("mesh"),i=[],n=[];if(t.materials.length&&(e.materials?(i=t.materials.filter((function(t){return!e.materials.includes(t)})),n=e.materials.filter((function(e){return!t.materials.includes(e)}))):i=t.materials),i.length&&o(r,i,this.texture,t.reflectivity),n.length&&o(r,n,null,1),e.materials&&t.reflectivity!==e.reflectivity){var a=t.materials.filter((function(t){return e.materials.includes(t)}));a.length&&o(r,a,this.texture,t.reflectivity)}this.data.enableBackground&&!e.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&e.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);var e=this.el.getObject3D("mesh"),t=this.data;o(e,t.materials,null,1),t.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}})},{}],27:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){var e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){var e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){var e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){var t=e.detail.el;t&&!t.is(this.GRABBED_STATE)&&this.grabbing&&!this.hitEl&&(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}})},{}],28:[function(e,t,r){"use strict";e("./checkpoint"),e("./cube-env-map"),e("./grab"),e("./jump-ability"),e("./kinematic-body"),e("./mesh-smooth"),e("./normal-material"),e("./sphere-collider")},{"./checkpoint":25,"./cube-env-map":26,"./grab":27,"./jump-ability":29,"./kinematic-body":30,"./mesh-smooth":31,"./normal-material":32,"./sphere-collider":33}],29:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("jump-ability",{dependencies:["velocity"],schema:{on:{default:"keydown:Space gamepadbuttondown:0"},playerHeight:{default:1.764},maxJumps:{default:1},distance:{default:5},debug:{default:!1}},init:function(){this.velocity=0,this.numJumps=0;var e=this.beginJump.bind(this),t=this.data.on.split(" ");this.bindings={};for(var r=0;r<t.length;r++)this.bindings[t[r]]=e,this.el.addEventListener(t[r],e);this.bindings.collide=this.onCollide.bind(this),this.el.addEventListener("collide",this.bindings.collide)},remove:function(){for(var e in this.bindings)this.bindings.hasOwnProperty(e)&&(this.el.removeEventListener(e,this.bindings[e]),delete this.bindings[e]);this.el.removeEventListener("collide",this.bindings.collide),delete this.bindings.collide},beginJump:function(){if(this.numJumps<this.data.maxJumps){var e=this.data,t=Math.sqrt(-2*e.distance*-24.8),r=this.el.getAttribute("velocity");this.el.setAttribute("velocity",{x:r.x,y:t,z:r.z}),this.numJumps++,this.el.emit("jumpstart")}},onCollide:function(){this.numJumps>0&&this.el.emit("jumpend"),this.numJumps=0}})},{}],30:[function(e,t,r){"use strict";var o,i,n,a,s=1e-6;t.exports=AFRAME.registerComponent("kinematic-body",{dependencies:["velocity"],schema:{mass:{default:5},radius:{default:1.3},linearDamping:{default:.05},enableSlopes:{default:!0},enableJumps:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this);var e=this.el,t=this.data,r=(new CANNON.Vec3).copy(e.object3D.getWorldPosition(new THREE.Vector3));this.body=new CANNON.Body({material:this.system.getMaterial("staticMaterial"),position:r,mass:t.mass,linearDamping:t.linearDamping,fixedRotation:!0}),this.body.addShape(new CANNON.Sphere(t.radius),new CANNON.Vec3(0,t.radius,0)),this.body.el=this.el,this.el.body=this.body,this.system.addBody(this.body),e.hasAttribute("wasd-controls")&&console.warn("[kinematic-body] Not compatible with wasd-controls, use movement-controls.")},remove:function(){this.system.removeBody(this.body),this.system.removeComponent(this),delete this.el.body},beforeStep:function(e,t){if(t){var r=this.el,o=this.data,i=this.body;o.enableJumps||i.velocity.set(0,0,0),i.position.copy(r.getAttribute("position"))}},step:(o=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3,function(e,t){if(t){var r=this.body,l=this.data,c=void 0,d=-1/0,u=void 0,h=this.system.getContacts();t=Math.min(t,1e3*this.system.data.maxInterval),a.set(0,0,0),o.copy(this.el.getAttribute("velocity")),r.velocity.copy(o);for(var p,m=0;p=h[m];m++)if(p.enabled){if(r.id===p.bi.id)p.ni.negate(n);else{if(r.id!==p.bj.id)continue;n.copy(p.ni)}r.velocity.dot(n)<-s&&n.y<=.5?o.projectOnPlane(n):n.y>.5&&(c=r.id===p.bi.id?Math.abs(p.rj.y+p.bj.position.y):Math.abs(p.ri.y+p.bi.position.y))>d&&(d=c,a.copy(n),u=r.id===p.bi.id?p.bj:p.bi)}i.copy(o).normalize(),u&&(!l.enableJumps||i.y<.5)?(l.enableSlopes?a.y<1-s&&a.copy(this.raycastToGround(u,a)):a.set(0,1,0),o.projectOnPlane(a)):this.system.driver.world&&o.add(this.system.driver.world.gravity.scale(4*t/1e3)),r.velocity.copy(o),this.el.setAttribute("velocity",r.velocity),this.el.setAttribute("position",r.position)}}),raycastToGround:function(e,t){var r,o=void 0,i=this.body.position,n=this.body.position.clone();return(o=new CANNON.Ray(i,n))._updateDirection(),o.intersectBody(e),o.hasHit?(r=o.result.hitNormalWorld,Math.abs(r.y)>Math.abs(t.y)?r:t):t}})},{}],31:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("mesh-smooth",{init:function(){this.el.addEventListener("model-loaded",(function(e){e.detail.model.traverse((function(e){e.isMesh&&e.geometry.computeVertexNormals()}))}))}})},{}],32:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial)},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){var e=this;this.el.object3D.traverse((function(t){t.isMesh&&(t.material=e.material)}))}})},{}],33:[function(e,t,r){"use strict";var o,i,n,a,s,l;t.exports=AFRAME.registerComponent("sphere-collider",{schema:{objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},remove:function(){this.pause()},play:function(){var e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){var e=this.data,t=void 0;t=e.objects?this.el.sceneEl.querySelectorAll(e.objects):this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:(o=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Box3,l=new Map,function(){var e,t,r=this.el,c=this.data,d=r.getObject3D("mesh"),u=[];d&&(l.clear(),r.object3D.getWorldPosition(o),r.object3D.getWorldScale(n),e=c.radius*(t=n,Math.max.apply(null,t.toArray())),this.els.forEach((function(t){var r,n,c,d;t.isEntity&&(n=t.getObject3D("mesh"))&&(s.setFromObject(n).getSize(a),d=Math.max(a.x,a.y,a.z)/2,r=Math.sqrt(2*d*d),s.getCenter(i),r&&(c=o.distanceTo(i))<r+e&&(u.push(t),l.set(t,c)))})),u.sort((function(e,t){return l.get(e)>l.get(t)?1:-1})).forEach(this.handleHit),0===u.length&&r.emit("hit",{el:null}),this.collisions.filter((function(e){return!l.has(e)})).forEach(this.handleHitEnd),this.collisions=u)}),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.el.emit("hit",{el:e})},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.el.emit("hitend",{el:e})}})},{}],34:[function(e,t,r){"use strict";e("./nav-mesh"),e("./nav-agent"),e("./system")},{"./nav-agent":35,"./nav-mesh":36,"./system":37}],35:[function(e,t,r){"use strict";var o,i,n;t.exports=AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:(o=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,function(e,t){var r=this.el,a=this.data,s=this.raycaster,l=a.speed*t/1e3;if(a.active){if(!this.path.length){var c=this.el.object3D.position;this.group=this.group||this.system.getGroup(c),this.path=this.system.getPath(c,o.copy(a.destination),this.group)||[],r.emit("navigation-start")}if(!this.path.length)return console.warn("[nav] Unable to find path to %o.",a.destination),this.el.setAttribute("nav-agent",{active:!1}),void r.emit("navigation-end");var d=r.object3D.position,u=this.path[0];i.subVectors(u,d);var h=void 0;if(i.length()<l){if(this.path.shift(),!this.path.length)return this.el.setAttribute("nav-agent",{active:!1}),void r.emit("navigation-end");n.copy(d),h=this.path[0]}else n.copy(i.setLength(l)).add(d),h=u;h.y=d.y,r.object3D.lookAt(h),s.ray.origin.copy(n),s.ray.origin.y+=1.5,s.ray.direction.y=-1;var p=s.intersectObject(this.system.getNavMesh());p.length?(i.subVectors(p[0].point,d),d.add(i.setLength(l))):d.copy(n)}})})},{}],36:[function(e,t,r){"use strict";t.exports=AFRAME.registerComponent("nav-mesh",{init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){var e=this.el.getObject3D("mesh"),t=this.el.sceneEl.object3D;if(e){var r=void 0;if(e.traverse((function(e){e.isMesh&&(r=e)})),r){var o=r.geometry.isBufferGeometry?(new THREE.Geometry).fromBufferGeometry(r.geometry):r.geometry.clone();t.updateMatrixWorld(),o.applyMatrix(r.matrixWorld),this.system.setNavMeshGeometry(o),this.hasLoadedNavMesh=!0}}}})},{}],37:[function(e,t,r){"use strict";var o=e("three-pathfinding").Pathfinding,i=new o,n="level";t.exports=AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(e){this.navMesh=new THREE.Mesh(e),i.setZoneData(n,o.createZone(e)),Array.from(this.agents).forEach((function(e){return e.updateNavLocation()}))},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,t,r){return this.navMesh?i.findPath(e,t,n,r):null},getGroup:function(e){return this.navMesh?i.getGroup(n,e):null},getNode:function(e,t){return this.navMesh?i.getClosestNode(e,n,t,!0):null},clampStep:function(e,t,r,o,a){return this.navMesh?o?i.clampStep(e,t,o,n,r,a):(a.copy(t),this.getNode(t,r)):(a.copy(t),null)}})},{"three-pathfinding":11}],38:[function(e,t,r){"use strict";t.exports=AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}})},{}],39:[function(e,t,r){"use strict";var o=e("../../lib/hex-grid.min.js"),i=e("../../lib/default-hex-grid");t.exports.Primitive=AFRAME.registerPrimitive("a-hexgrid",{defaultComponents:{hexgrid:{}},mappings:{src:"hexgrid.src"}}),t.exports.Component=AFRAME.registerComponent("hexgrid",{dependencies:["material"],schema:{src:{type:"asset"}},init:function(){var e=this,t=this.data;t.src?fetch(t.src).then((function(e){return e.json()})).then((function(t){return e.addMesh(t)})):this.addMesh(i)},addMesh:function(e){var t=new o.HexGrid;t.fromJSON(e);var r=new o.Board(t);r.generateTilemap(),this.el.setObject3D("mesh",r.group),this.addMaterial()},addMaterial:function(){var e=(this.el.components.material||{}).material;e&&this.el.object3D.traverse((function(t){t.isMesh&&(t.material=e)}))},remove:function(){this.el.removeObject3D("mesh")}})},{"../../lib/default-hex-grid":7,"../../lib/hex-grid.min.js":9}],40:[function(e,t,r){"use strict";t.exports.Primitive=AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}}),t.exports.Component=AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){var e=this.el,t=this.data,r=e.components.material,o=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);o.mergeVertices(),this.waves=[];for(var i,n=0,a=o.vertices.length;n<a;n++)i=o.vertices[n],this.waves.push({z:i.z,ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});r||((r={}).material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,shading:THREE.FlatShading})),this.mesh=new THREE.Mesh(o,r.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(t){for(var r,o,i=this.mesh.geometry.vertices,n=0;r=i[n];n++)o=this.waves[n],r.z=o.z+Math.sin(o.ang)*o.amp,o.ang+=o.speed*t;this.mesh.geometry.verticesNeedUpdate=!0}}})},{}],41:[function(e,t,r){"use strict";t.exports.Primitive=AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}}),t.exports.Component=AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){var e=this.el,t=this.data,r=e.components.material;if(t.path.length){var o=new THREE.CatmullRomCurve3(t.path.map((function(e){return e=e.split(" "),new THREE.Vector3(Number(e[0]),Number(e[1]),Number(e[2]))}))),i=new THREE.TubeGeometry(o,t.segments,t.radius,t.radialSegments,t.closed);r||((r={}).material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(i,r.material),this.el.setObject3D("mesh",this.mesh)}else console.error("[a-tube] `path` property expected but not found.")},update:function(e){Object.keys(e).length&&(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}})},{}],42:[function(e,t,r){"use strict";e("./a-grid"),e("./a-hexgrid"),e("./a-ocean"),e("./a-tube")},{"./a-grid":38,"./a-hexgrid":39,"./a-ocean":40,"./a-tube":41}]},{},[1]),function(){ARProxy=function(e,t,r){var o;this.listeners={},this.allEventListeners=[],this.id=null,this.arController=e,this.worker=((o=new Worker("../lib/makarWebAR.worker.min.js")).callID=0,o.callbacks={},o.listeners={},o.allEventListeners=[],o.call=function(e,t,arguments,r,o){var i=this.callID++;"function"==typeof r&&(o=r,r=void 0),this.callbacks[i]=o,this.postMessage({method:t,id:e,callID:i,arguments:arguments},r)},o.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},o.removeEventListener=function(e,t){if(this.listeners[e]){var r=this.listeners[e].indexOf(t);r>-1&&this.listeners[e].splice(r,1)}},o.dispatchEvent=function(e){var t=this;this.allEventListeners.forEach((function(r){r.call(t,e)}));var r=this.listeners[e.name];if(r)for(var o=0;o<r.length;o++)r[o].call(this,e)},o.listenForAllEvents=function(e){this.allEventListeners.push(e)},o.onmessage=function(e){if(e.data.event)this.dispatchEvent(e.data.event);else{var t=this.callbacks[e.data.callID];t&&t(e.data),delete this.callbacks[e.data.callID]}},o),this.processingDone=!1,this.canvas=document.createElement("canvas"),this.canvas.width=e.videoWidth,this.canvas.height=e.videoHeight,this.ctx=this.canvas.getContext("2d"),this.addEventListener=this.worker.addEventListener,this.removeEventListener=this.worker.removeEventListener,this.dispatchEvent=this.worker.dispatchEvent,this.listenForAllEvents=this.worker.listenForAllEvents;var i=this;this.worker.call(null,"new",[e.videoWidth,e.videoHeight,t],[],(function(e){i.id=e.id,r&&r(i)})),this.worker.listenForAllEvents((function(e){e.target===i.id&&i.dispatchEvent(e)})),this.addEventListener("getNFTMarkerDraw",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("getFrameTarget",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("loadNFTDone",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("getMarker",(function(e){e.data.type===artoolkit.BARCODE_MARKER?this.arController.threeBarcodeMarkers[e.data.index]&&(this.arController.threeBarcodeMarkers[e.data.index].keepVisible=!0):this.arController.threePatternMarkers[e.data.index]&&(this.arController.threePatternMarkers[e.data.index].keepVisible=!0),this.arController.dispatchEvent(e)})),this.addEventListener("markerNum",(function(e){}))},ARProxy.callbackMethods={loadNFTMarker:1,loadMarker:1,loadMultiMarker:1},ARProxy.isCallbackMethod=function(e){return!!ARProxy.callbackMethods[e]},ARProxy.getTransferables=function(e,arguments){return"process"===e||"detectMarkers"===e?[arguments[0].data.buffer]:[]},ARProxy.methods=["dispose","process","trackPatternMarkerId","trackBarcodeMarkerId","trackNFTMarkerId","getMultiMarkerCount","getMultiMarkerPatternCount","addEventListener","removeEventListener","dispatchEvent","debugSetup","loadMarker","loadNFTMarker","loadMultiMarker","getTransMatSquare","getTransMatSquareCont","getTransMatMultiSquare","getTransMatMultiSquareRobust","transMatToGLMat","detectMarker","getMarkerNum","getMarker","getNFTMarker","setMarkerInfoVertex","cloneMarkerInfo","getMultiEachMarker","getTransformationMatrix","getCameraMatrix","getMarkerTransformationMatrix","setDebugMode","getDebugMode","getProcessingImage","setLogLevel","getLogLevel","setMarkerInfoDir","setProjectionNearPlane","getProjectionNearPlane","setProjectionFarPlane","getProjectionFarPlane","setThresholdMode","getThresholdMode","setThreshold","getThreshold","setPatternDetectionMode","getPatternDetectionMode","setMatrixCodeType","getMatrixCodeType","setLabelingMode","getLabelingMode","setPattRatio","getPattRatio","setImageProcMode","getImageProcMode","debugDraw","_initialize","_initNFT","_copyImageToHeap","_debugMarker","createThreeScene","createThreeMarker","createThreeNFTMarker","createThreeMultiMarker","createThreeBarcodeMarker","setupThree"],ARProxy.callbackIndices={dispose:0,process:1,trackPatternMarkerId:2,trackBarcodeMarkerId:2,trackNFTMarkerId:2,getMultiMarkerCount:0,getMultiMarkerPatternCount:1,addEventListener:2,removeEventListener:2,dispatchEvent:1,debugSetup:0,loadMarker:1,loadNFTMarker:3,loadMultiMarker:1,getTransMatSquare:3,getTransMatSquareCont:4,getTransMatMultiSquare:2,getTransMatMultiSquareRobust:2,transMatToGLMat:3,detectMarker:1,getMarkerNum:0,getMarker:1,getNFTMarker:1,setMarkerInfoVertex:2,cloneMarkerInfo:1,getMultiEachMarker:2,getTransformationMatrix:0,getCameraMatrix:0,getMarkerTransformationMatrix:0,setDebugMode:1,getDebugMode:0,getProcessingImage:0,setLogLevel:1,getLogLevel:0,setMarkerInfoDir:2,setProjectionNearPlane:1,getProjectionNearPlane:0,setProjectionFarPlane:1,getProjectionFarPlane:0,setThresholdMode:1,getThresholdMode:0,setThreshold:1,getThreshold:0,setPatternDetectionMode:1,getPatternDetectionMode:0,setMatrixCodeType:1,getMatrixCodeType:0,setLabelingMode:1,getLabelingMode:0,setPattRatio:1,getPattRatio:0,setImageProcMode:1,getImageProcMode:0,debugDraw:0,_initialize:0,_initNFT:0,_copyImageToHeap:1,_debugMarker:1,createThreeScene:1,createThreeMarker:2,createThreeNFTMarker:2,createThreeMultiMarker:1,createThreeBarcodeMarker:2,setupThree:0};for(var e=0;e<ARProxy.methods.length;e++){var t=ARProxy.methods[e];ARProxy.prototype[t]=function(e){var t=ARProxy.callbackIndices[e];return function(){var r=arguments[t],o=ARProxy.getTransferables(e,arguments);this.worker.call(this.id,e,[].slice.call(arguments,0,t),o,r.bind(this))}}(t)}ARProxy.prototype.getFrameTarget=function(){this.worker.call(this.id,"getFrameTarget",[],[],(function(e){}))},ARProxy.prototype.process=function(e){if(this.processingDone){this.processingDone=!1,this.ctx.drawImage(e,0,0,this.canvas.width,this.canvas.height);var t=this,r=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this.worker.call(this.id,"process",[r],[r.data.buffer],(function(e){t.processingDone=!0}))}}}();var scope,integrate=function(){var e={};"function"==typeof Symbol&&Symbol.iterator;THREE.gifAnimator=class{constructor(){this.data={src:null,autoplay:!0,transparent:!0,opacity:1,side:THREE.DoubleSide}}init(e){let t=this;if(console.log("gif-animator.js: init: ",e,this),Object.keys(e).forEach((function(r){t.data[r]=e[r]})),this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset(),e.chroma){let t;if(console.log(" gif-animator.js: ***************************************** chroma= ",e.chroma),"RGB"==e.chroma.mode)t=new THREE.ChromaKeyMaterial({map:this.__texture,keyColor:e.chroma.chromakey.split(","),side:THREE.FrontSide,slope:e.chroma.slope,threshold:e.chroma.threshold});else if("HSV"==e.chroma.mode){let r=e.chroma.HSV.split(","),o=parseFloat(r[0]),i=parseFloat(r[1]),n=parseFloat(r[2]);t=new THREE.HSVMattingMaterial({map:this.__texture,side:THREE.FrontSide,_keyingColorH:o,_keyingColorS:i,_keyingColorV:n,_deltaH:e.chroma.hue,_deltaS:e.chroma.saturation,_deltaV:e.chroma.brightness})}this.material=t}else this.material=new THREE.MeshBasicMaterial({map:this.__texture});return this.__addPublicFunctions(),this.update(this.data),this.material}update(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material}tick(e){setTimeout(function(){!this.__frames||this.paused()||(this.__curTime=Date.now(),this.__curTime-this.__preTime>=this.__nextFrameTime&&(this.nextFrame(),this.__preTime=this.__curTime)),this.tick()}.bind(this),20)}__updateMaterial(e){var t=this.material,r=this.__getMaterialData(e);Object.keys(r).forEach((function(e){t[e]=r[e]}))}__getMaterialData(e){return{opacity:e.opacity,transparent:e.transparent,side:e.side,autoplay:e.autoplay}}__setTexure(e){"error"===e.status?(console.warn("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))}__updateTexture(e){var t=e.src,r=e.autoplay;"boolean"==typeof r?this.__autoplay=r:void 0===r&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()}__validateSrc(e,t){var r=function(e){return 0==e.indexOf("http")&&e.indexOf("gif")==e.length-3?e:void 0}(e);r&&this.__getImageSrc(r,t)}__getImageSrc(t,r){var o=this;if(t!==this.__textureSrc){var i=e[t];if(i&&i.callbacks){if(i.src)return void r(i);if(i.callbacks)return void i.callbacks.push(r)}else(i=e[t]={callbacks:[]}).callbacks.push(r);var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(function(r){o.__getUnit8Array(t,(function(r){r?(0,o.parseGIF)(r,(function(r,o,n){var a={status:"success",src:t,times:r,cnt:o,frames:n,timestamp:Date.now()};i.callbacks&&(i.callbacks.forEach((function(e){return e(a)})),e[t]=a)}),(function(e){return a(e)})):a("This is not gif. Please use `shader:flat` instead")}))})),n.addEventListener("error",(function(e){return a("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),n.src=t}function a(r){var o=function(e,t){return{status:"error",src:t,message:e,timestamp:Date.now()}}(r,t);i.callbacks&&(i.callbacks.forEach((function(e){return e(o)})),e[t]=o)}}__getUnit8Array(e,t){if("function"==typeof t){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.addEventListener("load",(function(e){for(var r=new Uint8Array(e.target.response),o=r.subarray(0,4),i="",n=0;n<o.length;n++)i+=o[n].toString(16);"47494638"===i?t(r):t()})),r.addEventListener("error",(function(e){console.error(e),t()})),r.send()}}__validateAndGetQuerySelector(e){try{var t=document.querySelector(e);return t||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}}__addPublicFunctions(){this.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}}pause(){this.__paused=!0}play(){this.__paused=!1}togglePlayback(){this.paused()?this.play():this.pause()}paused(){return this.__paused}nextFrame(){this.__draw(),this.__nextFrameTime=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)}__clearCanvas(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__draw(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__ready(e){var t=e.src,r=e.times,o=e.cnt,i=e.frames;console.log("gif-animator.js: __ready: times=",r,", cnt=",o),this.__textureSrc=t,this.__delayTimes=r,o?this.__loopCnt=o:this.__infinity=!0,this.__frames=i,this.__frameCnt=r.length,this.__startTime=Date.now(),this.__curTime=Date.now(),this.__preTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(i[0].width),this.__height=THREE.Math.floorPowerOfTwo(i[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause(),this.tick()}__reset(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__curTime=0,this.__preTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}parseGIF(e,t,r){var o=0,i=[],n=0,a=null,s=null,l=[],c=0;if(71!==e[0]||73!==e[1]||70!==e[2]||56!==e[3]||57!==e[4]&&55!==e[4]||97!==e[5])r&&r("parseGIF: no GIF89a");else{o+=13+ +!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3;for(var d=e.subarray(0,o);e[o]&&59!==e[o];){var u=o,h=e[o];if(33===h){var p=e[++o];if(-1===[1,254,249,255].indexOf(p)){r&&r("parseGIF: unknown label");break}for(249===p&&i.push(10*(e[o+3]+(e[o+4]<<8))),255===p&&(c=e[o+15]+(e[o+16]<<8));e[++o];)o+=e[o];249===p&&(a=e.subarray(u,o+1))}else{if(44!==h){r&&r("parseGIF: unknown blockId");break}for(o+=9,o+=1+ +!!(128&e[o])*(3*Math.pow(2,1+(7&e[o])));e[++o];)o+=e[o];s=e.subarray(u,o+1);var m={disposalMethod:a[3],blob:URL.createObjectURL(new Blob([d,a,s]))};l.push(m)}o++}}if(l.length){var f=document.createElement("canvas"),g=function e(r){var o=new Image;o.onload=function(r,o){n++,l[o]=this,n===l.length?(f=null,t&&t(i,c,l)):e(++o)}.bind(o),o.src=f.toDataURL("image/gif")};l.forEach((function(e,t){var r=new Image;r.onload=function(e,t){0===t&&(f.width=r.width,f.height=r.height),n++,l[t]=this,n===l.length&&(n=0,g(1))}.bind(r,null,t),r.src=e.blob,r.disposalMethod=e.disposalMethod}))}}},THREE.gifAnimator.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.gifAnimator.prototype.constructor=THREE.gifAnimator};"undefined"!=typeof window?scope=window:console.error("gif-animator.js: window error",window);var integrateTick=function(){scope.THREE?integrate():setTimeout(integrateTick,50)};integrateTick();