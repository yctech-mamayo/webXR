(()=>{"use strict";const e=class{getProjectIdx(){}addTextToScene(){}addTextureToScene(){}addGLTFModelToScene(){}addAudioToScene(){}addVideoToScene(){}pushObjectToMakarObjects(){}setTransform(){}appendToVrScene(){}initTest(){console.log("AddObjectToVrController.initTest: ",window.vrController)}};function t(e){return"object"==typeof e&&"function"==typeof e.then}const o=class extends e{module={placeholder:"quiz test."};constructor(e){super(),this.module=e.module}getProjectIdx(){return window.vrController.projectIdx}addTextToScene(e,t,o,n){return window.vrController.loadText(e,t,o,n)}addTextureToScene(e,t,o,n){return window.vrController.loadTexture(e,t,o,n)}addGLTFModelToScene(e,t,o,n){return window.vrController.loadGLTFModel(e,t,o,n,vrController.cubeTex)}addAudioToScene(e,t,o,n){return window.vrController.loadAudio(e,t,o,n)}addVideoToScene(e,t,o,n){return window.vrController.loadVideo(e,t,o,n)}pushToMakarObjects(e){window.vrController.makarObjects.push(e)}setTransform(e,t,o,n){window.vrController.setTransform(e,t,o,n)}appendToVrScene(e){window.vrController.vrScene.appendChild(e)}clearObject(e){for(let t=0;t<window.vrController.makarObjects.length;t++)if(window.vrController.makarObjects[t].id==e.id){let e=window.vrController.makarObjects[t];if(e.getAttribute("src")){let t=e.getAttribute("src").split("#")[1];document.getElementById(t)&&document.getElementById(t).remove()}e.remove(),window.vrController.makarObjects.splice(t,1)}}adjustCursorEntity(e,t,o=""){switch(e=e.toLowerCase()){case"set":window.vrController.cursorEntity.setAttribute(t,o);break;case"remove":window.vrController.cursorEntity.removeAttribute(t);break;default:console.log("Quiz.js adjustCursorEntity: error")}}load(e,o,n,r){window.quiz=this;let i=this,l=document.createElement("a-entity");l.setAttribute("id",e.obj_id),this.pushToMakarObjects(l),console.log("Quiz.js: _load: quizEntity=",l.object3D),l.addEventListener("loaded",(function(){let e=new THREE.Object3D;l.object3D.add(e)}));let a=[];for(let t=0;t<e.module[0].question_list.length;t++)e.module[0].question_list[t].allowRandom&&a.push(t);if(!e.module[0].display_order_list)return void console.log("Quiz.js _load: ERROR - user has not set display_order_list. obj.module[0]=",e.module[0]);let s=0;for(let t=0;t<e.module[0].display_order_list.length;t++){let o=e.module[0].display_order_list[t].index;if(-1==o){let n=(c=a.length,Math.floor(Math.random()*Math.floor(c))),r=a[n];e.module[0].display_order_list[t].index=r,o=r,a.splice(n,1)}e.module[0].question_list[o].active_score&&(s+=1)}var c;let u=e.module[0].display_order_list[0].index,d=e.module[0].question_list[u],m=document.getElementById("timerContent"),b=-1;if("Total"==e.module[0].timer_type){b=e.module[0].total_time,document.getElementById("timerDiv").style.display="block";let t=Math.floor(b/3600),o=Math.floor((b-3600*t)/60),n=b-3600*t-60*o;m.textContent=t.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")}else if("Custom"==e.module[0].timer_type){b=d.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(b/3600),t=Math.floor((b-3600*e)/60),o=b-3600*e-60*t;m.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}let p=document.getElementById("tipButtonDiv");d.show_tips?(p.style.display="block",p.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),o=document.getElementById("tipContent");e.style.display="block",o.textContent=d.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):p.style.display="none",this.module={json:e.module[0],quizEntity:l,currentIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:s,record:new Array(e.module[0].question_list.length),timer:{currentTimer:null,counter:b},record_time:0,qClock:Date.now()};let h=document.getElementById("scoreDiv");if(h.addEventListener("click",(function(){h.style.display="none",i.nextQuestion()})),console.log("Quiz.js: _load: _first_question=",d),d.questions_json&&Array.isArray(d.questions_json))for(let e=0;e<d.questions_json.length;e++){let t=(new THREE.Vector3).fromArray(d.questions_json[e].transform[0].split(",").map((function(e){return Number(e)}))),o=(new THREE.Vector3).fromArray(d.questions_json[e].transform[1].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(d.questions_json[e].transform[2].split(",").map((function(e){return Number(e)})));switch(d.questions_json[e].main_type){case"text":this.addTextToScene(d.questions_json[e],t,o,n);break;case"image":this.addTextureToScene(d.questions_json[e],t,o,n);break;case"video":this.addVideoToScene(d.questions_json[e],t,o,n);break;case"model":this.addGLTFModelToScene(d.questions_json[e],t,o,n);break;case"audio":this.addAudioToScene(d.questions_json[e],t,o,n)}}if(d.options_json)for(let e=0;e<d.options_json.length;e++){let o,n,r=(new THREE.Vector3).fromArray(d.options_json[e].transform[0].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(d.options_json[e].transform[1].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(d.options_json[e].transform[2].split(",").map((function(e){return Number(e)}))),s=d.options_json[e].sub_type;switch(console.log("Quiz.js: _load: _loadOption: ",e,s,d.options_json[e]),s){case"txt":n=this.addTextToScene(d.options_json[e],r,l,a);break;case"gif":case"jpg":case"jpeg":case"png":n=this.addTextureToScene(d.options_json[e],r,l,a);break;case"button":d.options_json[e].res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",n=this.addTextureToScene(d.options_json[e],r,l,a)}if("button"!=s&&("MutiOption_Text"==d.option_type||"MutiOption_Image"==d.option_type)){if(0==t(n))continue;n.then((function(e){if(o=e,"MutiOption_Text"==d.option_type){console.log(" *** loaded: ",o.object3D);let e=new THREE.Vector3(0,0,0),t=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1)),n=document.createElement("a-plane");n.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),n.setAttribute("id","circle_base"),n.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),o.appendChild(n);let r=document.createElement("a-plane");r.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),r.setAttribute("id","circle_out"),r.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),o.appendChild(r);let i=document.createElement("a-plane");i.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),i.setAttribute("id","circle_in"),i.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),i.setAttribute("visible",!1),o.appendChild(i);let l=2*Math.abs(o.getObject3D("mesh").geometry.attributes.position.array[0]);e.x=e.x+.5*l+.3/o.object3D.parent.el.getAttribute("scale").x,e.z=e.z-.01,n.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),r.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),i.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),t.multiply(new THREE.Vector3(.2,.2,.2)),t.divide(o.object3D.parent.el.getAttribute("scale")),n.setAttribute("scale",t),r.setAttribute("scale",t),i.setAttribute("scale",t.clone().multiply(new THREE.Vector3(.7,.7,.7)));let a=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};n.addEventListener("loaded",a),r.addEventListener("loaded",a),i.addEventListener("loaded",a)}else{let e=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1),r=setInterval((function(){if(i.module.currentIndex>=i.module.json.display_order_list.length&&window.clearInterval(i.module.timer.currentTimer),o.getAttribute("heightForQuiz")){let l=o.getAttribute("heightForQuiz");n.multiply(new THREE.Vector3(.4,.4,.4)),n.divide(o.getAttribute("scale")),e.y=e.y-l/2-.3/o.getAttribute("scale").y;let a=document.createElement("a-plane");a.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),a.setAttribute("id","circle_base"),a.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),i.setTransform(a,e,t,n),o.appendChild(a);let s=document.createElement("a-plane");s.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),s.setAttribute("id","circle_out"),s.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),i.setTransform(s,e,t,n),o.appendChild(s);let c=document.createElement("a-plane");c.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),c.setAttribute("id","circle_in"),c.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),c.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),i.setTransform(c,e,t,n),o.appendChild(c);let u=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};a.addEventListener("loaded",u),s.addEventListener("loaded",u),c.addEventListener("loaded",u),window.clearInterval(r)}}),1)}}))}}if(this.module.timer.counter>=0){this.module.qClock=Date.now();let t=setInterval((function(){i.module.timer.currentTimer=t,i.module.timer.counter-=1,i.module.currentIndex>=i.module.json.display_order_list.length&&window.clearInterval(i.module.timer.currentTimer);let o=Math.floor(i.module.timer.counter/3600),n=Math.floor((i.module.timer.counter-3600*o)/60),r=i.module.timer.counter-3600*o-60*n;if(m.textContent=o.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0"),0==i.module.timer.counter)if(window.clearInterval(i.module.timer.currentTimer),"Custom"==e.module[0].timer_type)if(d.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=i.module.score}else i.nextQuestion();else{let e=[],t=i.module.quizEntity;for(let o of t.children)e.push(o);e.forEach((e=>{i.clearObject(e)}));let o=document.getElementById("tipButtonDiv"),n=document.getElementById("tipDiv");o.style.display="none",n.style.display="none";let r=document.getElementById("startQuiz"),l=document.getElementById("QuizStartButton"),a=document.getElementById("QuizStartContent");r.style.display="block",a.textContent="時間到";let s={question:u,get_score:0,answer_time:i.module.json.question_list[u].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};i.module.record[u]=s,i.module.record_time+=i.module.json.question_list[u].time_limit,i.module.qClock=Date.now(),l.addEventListener("click",(function(){r.style.display="none",i.saveQuizStatus()}))}}),1e3)}i.setTransform(l,o,n,r),i.appendToVrScene(l)}pushButton(e){let t=this,o=[],n=!1,r=0,i=this.module.json.display_order_list[this.module.currentIndex].index,l=this.module.json.question_list[i],a=this.module.json.score_type,s=document.getElementById("makarDragon"),c=document.getElementById("imgRight"),u=document.getElementById("imgWrong");if("Option_Text"==l.option_type||"Option_Image"==l.option_type){null==l.answer_list&&(l.answer_list=[]);let d,m=l.answer_list[0],b=l.options_json[m-1];d="a-text"==e.localName?e.parentNode.id:e.id;for(let e=0,t=l.options_json.length;e<t;e++)l.options_json[e].obj_id==d&&o.push(e);if(b&&b.obj_id==d){if(l.active_score)if("Custom"==a)t.module.score+=l.score,r=l.score;else if("Total"==a){let e=t.module.json.total_score;t.module.correctAnswer+=1,t.module.score=Math.round(e*t.module.correctAnswer/t.module.totalActiveScoreQuestion),r=Math.round(e/t.module.totalActiveScoreQuestion)}n=!0,s.style.display="block",c.style.display="block",u.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else n=!1,s.style.display="block",c.style.display="none",u.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(t.module.timer.currentTimer),t.adjustCursorEntity("remove","cursor"),t.module.timer.counter,setTimeout((function(){s.style.display="none";let e={question:i,get_score:r,answer_time:Math.round((Date.now()-t.module.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:n};if(t.module.record[i]=e,t.module.record_time+=Math.round((Date.now()-t.module.qClock)/1e3),t.module.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",o.textContent=t.module.score}else t.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",t.module.score,l)}else if(e.object3D.traverse((function(o){if("Group"==o.type&&o.el&&"circle_in"==o.el.getAttribute("id")){let n,r=o.el;if(r.setAttribute("visible",!r.getAttribute("visible")),n="a-text"==e.localName?e.parentNode.id:e.id,t.module.choices.includes(n)){let e=t.module.choices.indexOf(n);t.module.choices.splice(e,1)}else t.module.choices.push(n);console.log("Quiz.js: _pushButton: choices = ",t.module.choices)}else if("Group"==o.type&&o.el&&"circle_out"==o.el.getAttribute("id")){let e=o.el;"#7B7B7B"==e.getAttribute("material").color?e.setAttribute("material","color:#00d1c1;"):"#00d1c1"==e.getAttribute("material").color&&e.setAttribute("material","color:#7B7B7B;")}})),"button"==e.object3D.sub_type){let e=0;null==l.answer_list&&(l.answer_list=[]);for(let o of l.answer_list){let n=l.options_json[o];if(n)for(let o of t.module.choices)o==n.obj_id&&(e+=1)}for(let e=0,n=l.options_json.length;e<n;e++)for(let n=0,r=t.module.choices.length;n<r;n++)l.options_json[e].obj_id==t.module.choices[n]&&o.push(e-1);if(e==l.answer_list.length&&l.answer_list.length==t.module.choices.length){if(l.active_score)if("Custom"==a)t.module.score+=l.score,r=l.score;else if("Total"==a){let e=t.module.json.total_score;t.module.correctAnswer+=1,t.module.score=Math.round(e*t.module.correctAnswer/t.module.totalActiveScoreQuestion),r=Math.round(e/t.module.totalActiveScoreQuestion)}n=!0,s.style.display="block",c.style.display="block",u.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else n=!1,s.style.display="block",c.style.display="none",u.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(t.module.timer.currentTimer);let d=t.module.timer.counter;setTimeout((function(){t.adjustCursorEntity("set","geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 0; thetaStart: 0;"),s.style.display="none",console.log("Quiz.js: _pushButton: ",t.module.json.question_list[i].time_limit,d,Math.round((Date.now()-t.module.qClock)/1e3));let e={question:i,get_score:r,answer_time:Math.round((Date.now()-t.module.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:n};if(t.module.record[i]=e,t.module.record_time+=Math.round((Date.now()-t.module.qClock)/1e3),t.module.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",o.textContent=t.module.score}else t.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",t.module.score,l)}}nextQuestion(){this.module.choices=[];let e=[];window.clearInterval(this.module.timer.currentTimer);let o=this,n=this.module.quizEntity;for(let t of n.children)e.push(t);if(e.forEach((e=>{o.clearObject(e)})),this.module.currentIndex+=1,this.module.currentIndex<this.module.json.display_order_list.length){let e=this.module.json.display_order_list[this.module.currentIndex].index,n=this.module.json.question_list[e];"Custom"==this.module.json.timer_type&&(this.module.timer.counter=n.time_limit);let r=document.getElementById("tipButtonDiv");if(n.show_tips?(r.style.display="block",r.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),o=document.getElementById("tipContent");e.style.display="block",o.textContent=n.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):r.style.display="none",n.questions_json&&Array.isArray(n.questions_json))for(let e=0;e<n.questions_json.length;e++){let t=(new THREE.Vector3).fromArray(n.questions_json[e].transform[0].split(",").map((function(e){return Number(e)}))),o=(new THREE.Vector3).fromArray(n.questions_json[e].transform[1].split(",").map((function(e){return Number(e)}))),r=(new THREE.Vector3).fromArray(n.questions_json[e].transform[2].split(",").map((function(e){return Number(e)})));switch(n.questions_json[e].main_type){case"text":this.addTextToScene(n.questions_json[e],t,o,r);break;case"image":this.addTextureToScene(n.questions_json[e],t,o,r);break;case"video":this.addVideoToScene(n.questions_json[e],t,o,r);break;case"model":this.addGLTFModelToScene(n.questions_json[e],t,o,r)}}if(n.options_json&&Array.isArray(n.options_json))for(let e=0;e<n.options_json.length;e++){let r,i,l=(new THREE.Vector3).fromArray(n.options_json[e].transform[0].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(n.options_json[e].transform[1].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(n.options_json[e].transform[2].split(",").map((function(e){return Number(e)}))),c=n.options_json[e].sub_type;switch(c){case"txt":i=this.addTextToScene(n.options_json[e],l,a,s);break;case"gif":case"jpg":case"jpeg":case"png":i=this.addTextureToScene(n.options_json[e],l,a,s);break;case"button":n.options_json[e].res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",i=this.addTextureToScene(n.options_json[e],l,a,s)}if("button"!=c&&("MutiOption_Text"==n.option_type||"MutiOption_Image"==n.option_type)){if(0==t(i))continue;i.then((function(e){if(r=e,"MutiOption_Text"==n.option_type){let e=new THREE.Vector3(0,0,0),t=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1)),o=document.createElement("a-plane");o.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),o.setAttribute("id","circle_base"),o.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),r.appendChild(o);let n=document.createElement("a-plane");n.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),n.setAttribute("id","circle_out"),n.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),r.appendChild(n);let i=document.createElement("a-plane");i.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),i.setAttribute("id","circle_in"),i.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),i.setAttribute("visible",!1),r.appendChild(i);let l=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};o.addEventListener("loaded",l),n.addEventListener("loaded",l),i.addEventListener("loaded",l);let a=2*Math.abs(r.getObject3D("mesh").geometry.attributes.position.array[0]);e.x=e.x+.5*a+.3/r.object3D.parent.el.getAttribute("scale").x,e.z=e.z-.01,o.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),n.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),i.setAttribute("position",e.clone().multiply(new THREE.Vector3(-1,1,1))),t.multiply(new THREE.Vector3(.4,.4,.4)),t.divide(r.object3D.parent.el.getAttribute("scale")),o.setAttribute("scale",t),n.setAttribute("scale",t),i.setAttribute("scale",t.clone().multiply(new THREE.Vector3(.7,.7,.7)))}else{let e=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1),i=setInterval((function(){if(o.module.currentIndex>=o.module.json.display_order_list.length&&window.clearInterval(o.module.timer.currentTimer),r.getAttribute("heightForQuiz")){let l=r.getAttribute("heightForQuiz");n.multiply(new THREE.Vector3(.4,.4,.4)),n.divide(r.getAttribute("scale")),e.y=e.y-l/2-.3/r.getAttribute("scale").y;let a=document.createElement("a-plane");a.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),a.setAttribute("id","circle_base"),a.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),o.setTransform(a,e,t,n),r.appendChild(a);let s=document.createElement("a-plane");s.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),s.setAttribute("id","circle_out"),s.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),o.setTransform(s,e,t,n),r.appendChild(s);let c=document.createElement("a-plane");c.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),c.setAttribute("id","circle_in"),c.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),c.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),o.setTransform(c,e,t,n),r.appendChild(c);let u=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};a.addEventListener("loaded",u),s.addEventListener("loaded",u),c.addEventListener("loaded",u),window.clearInterval(i)}}),1)}}))}}let i=document.getElementById("timerContent");if("Custom"==o.module.json.timer_type&&o.module.timer.counter>=0){let e=Math.floor(o.module.timer.counter/3600),t=Math.floor((o.module.timer.counter-3600*e)/60),n=o.module.timer.counter-3600*e-60*t;i.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")}setTimeout((function(){if(o.module.timer.counter>=0){o.module.qClock=Date.now(),window.clearInterval(o.module.timer.currentTimer);let t=setInterval((function(){o.module.timer.currentTimer=t,o.module.timer.counter-=1,o.module.currentIndex>=o.module.json.display_order_list.length&&window.clearInterval(o.module.timer.currentTimer);let r=Math.floor(o.module.timer.counter/3600),l=Math.floor((o.module.timer.counter-3600*r)/60),a=o.module.timer.counter-3600*r-60*l;if(i.textContent=r.toString().padStart(2,"0")+":"+l.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0"),o.module.timer.counter<=0)if(window.clearInterval(o.module.timer.currentTimer),"Custom"==o.module.json.timer_type)if(n.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=o.module.score}else o.nextQuestion();else{let t=[],n=o.module.quizEntity;for(let e of n.children)t.push(e);t.forEach((e=>{o.clearObject(e)}));let r=document.getElementById("tipButtonDiv"),i=document.getElementById("tipDiv");r.style.display="none",i.style.display="none";let l=document.getElementById("startQuiz"),a=document.getElementById("QuizStartButton");document.getElementById("QuizStartContent").textContent="時間到",0==o.module.timer.counter&&(l.style.display="block");let s={question:e,get_score:0,answer_time:o.module.json.question_list[e].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};o.module.record[e]=s,o.module.record_time+=o.module.json.question_list[e].time_limit,o.module.qClock=Date.now(),a.addEventListener("click",(function(){l.style.display="none",o.saveQuizStatus()}))}}),1e3)}}),3e3)}else{window.clearInterval(o.module.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let n=document.getElementById("quizEndDiv");n.style.display="block",n.addEventListener("click",(function(){n.style.display="none"}));let r=o.getProjectIdx();console.log("Quiz.js: quiz end , this.module.record = ",o.module.record);let i="",l="";localStorage.getItem("login_shared_id")&&(i=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(l=localStorage.getItem("device_id"));let a={user_id:publishVRProjs.result[r].user_id,playing_user:i,proj_id:publishVRProjs.result[r].proj_id,proj_type:"vr",device_id:l,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[o.module.json],record_time:o.module.record_time,record_score:o.module.score,record:o.module.record};quizLog(window.serverUrl,a);for(let e=0,t=userPublishProjs.proj_list.length;e<t;e++)if(userPublishProjs.proj_list[e].proj_id==publishVRProjs.result[r].proj_id){let t={head_pic:userPublishProjs.proj_list[e].head_pic,loc:userPublishProjs.proj_list[e].loc,module_type:userPublishProjs.proj_list[e].module_type,name:userPublishProjs.proj_list[e].name,playing_user_id:i,proj_cover_urls:userPublishProjs.proj_list[e].proj_cover_urls,proj_id:userPublishProjs.proj_list[e].proj_id,proj_name:userPublishProjs.proj_list[e].proj_name,proj_type:"vr",shared_id:userPublishProjs.proj_list[e].shared_id,snapshot_url:userPublishProjs.proj_list[e].snapshot_url,user_id:userPublishProjs.proj_list[e].user_id};updateRecordModule(window.serverUrl,t),console.log("Quiz.js: quiz end, ",e,userPublishProjs.proj_list[e],t)}console.log("Quiz.js: quiz end , quizVRLogData = ",a)}}saveQuizStatus(){console.log("find timer 1400",this.module.timer),window.clearInterval(this.module.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let o=document.getElementById("quizEndDiv");o.style.display="block",o.addEventListener("click",(function(){o.style.display="none"}));const n=this.getProjectIdx();console.log("VRFunc.js: quiz end , this.module.record = ",this.module.record);let r="",i="";localStorage.getItem("login_shared_id")&&(r=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(i=localStorage.getItem("device_id"));let l={user_id:publishVRProjs.result[n].user_id,playing_user:r,proj_id:publishVRProjs.result[n].proj_id,proj_type:"vr",device_id:i,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[this.module.json],record_time:this.module.record_time,record_score:this.module.score,record:this.module.record};quizLog(window.serverUrl,l);for(let e=0,t=userPublishProjs.proj_list.length;e<t;e++)if(userPublishProjs.proj_list[e].proj_id==publishVRProjs.result[n].proj_id){let t={head_pic:userPublishProjs.proj_list[e].head_pic,loc:userPublishProjs.proj_list[e].loc,module_type:userPublishProjs.proj_list[e].module_type,name:userPublishProjs.proj_list[e].name,playing_user_id:r,proj_cover_urls:userPublishProjs.proj_list[e].proj_cover_urls,proj_id:userPublishProjs.proj_list[e].proj_id,proj_name:userPublishProjs.proj_list[e].proj_name,proj_type:"vr",shared_id:userPublishProjs.proj_list[e].shared_id,snapshot_url:userPublishProjs.proj_list[e].snapshot_url,user_id:userPublishProjs.proj_list[e].user_id};updateRecordModule(window.serverUrl,t),console.log("VRFunc.js: quiz end, ",e,userPublishProjs.proj_list[e],t)}console.log("VRFunc.js: quiz end , quizVRLogData = ",l)}};!function(){var e,t=window.leavedSendLog=function(e){if(!window.publishVRProjs)return;if(!publishVRProjs.result)return;if(!publishVRProjs.result[0].user_id)return;let t;localStorage.getItem("device_id")&&localStorage.getItem("device_id")>=24?t=localStorage.getItem("device_id"):(t=(new Date).getTime()+"_"+function(e){for(var t="",o=0;o<e;o++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}(10),localStorage.setItem("device_id",t));let o=(new Date).getTime(),n={brand:Browser.name+Browser.version,os:navigator.userAgent,device_id:t,client:"viewer",user_id:publishVRProjs.result[0].user_id,proj_id:"",proj_type:"vr",duration_time:0,explore_time:0,play_time:0,location_long:0,location_lan:0};n.proj_id=publishVRProjs.result[vrController.projectIdx].proj_id,n.duration_time=(o-vrController.userStartTime)/1e3,n.play_time=(o-vrController.userStartTime)/1e3,console.log("VRFunc.js: project["+vrController.projectIdx+"] playing time = ",n.duration_time,n.play_time,n.explore_time);let r=[n];localStorage.setItem("savedProjLogs",JSON.stringify(r))};window.onbeforeunload=t,e="undefined"!=typeof window?window:self;let n=0;var r=function(){n++,n>3?console.log("VRFunc.js: integrateTick, integrateCount=",n,", too many times"):e.AFRAME&&e.THREE?(console.log("VRFunc.js: integrateTick, scope=",e,n),function(){console.log("window.Module",window.Module),AFRAME.registerComponent("initvrscene",{init:function(){this.el}}),AFRAME.registerComponent("cursor-listener",{init:function(){}});var e=function(){this.GLRenderer=null,this.scene2D=null,this.camera2D=null,this.light=null,this.vrScene=null,this.publishVRProjs=null,this.VRSceneResult=null,this.makarVRscenes={},this.makarObjects=[],this.currentSceneMakarObjects=[],this.loadSceneCount=0,this.module=null,this.cursorEntity=null,this.projectIdx=null,this.intervalList=[],this.FUNCTION_ENABLED=!1,this.clock=new THREE.Clock,this.delta=this.time=0,this.triggerEnable=!1,this.touchMouseState=-1,this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.lookAtObjectList=[],this.lookAtTimelineDict={}};function t(e,t){let o=new XMLHttpRequest;o.open("HEAD",e,!0),o.onload=function(e){console.log(" VRFunc.js: _UrlExists: httpRequest status= ",o.status),t("200"==o.status)},o.onerror=function(e){console.log("onerror e=",e),t("200"==o.status)},o.onabort=function(e){console.log("onabort e=",e),t("200"==o.status)},o.send()}e.prototype.UrlExistsFetch=async function(e){let t=await fetch(e,{method:"HEAD"});return console.log("_VRController: _UrlExists2: ret ",t),!!t.status&&"200"==t.status},e.prototype.setupFunction=function(){if(this.FUNCTION_ENABLED)return;this.FUNCTION_ENABLED=!0;var e=this;this.loadAssets=function(t){let o=document.createElement("a-assets");o.setAttribute("id","makarAssets"),o.setAttribute("timeout","1000"),o.setAttribute("crossorigin","anonymous"),e.vrScene.appendChild(o)},this.loadScene=function(o,n){if(null==e.VRSceneResult[o].scenes[n])console.log("VRFunc.js: VRController: _loadScene: error, [valid sceneIndex]=",e.VRSceneResult[o].scenes.length,n);else{this.sceneIndex=n;let i=document.getElementsByTagName("video");if(i.length>0)for(let e=0;e<i.length;e++)i[e].pause(),i[e].removeAttribute("src"),i[e].load();let l=document.getElementsByTagName("audio");if(l.length>0)for(let e=0;e<l.length;e++)l[e].pause(),l[e].removeAttribute("src"),l[e].load();if(e.makarObjects){for(let t=0;t<e.makarObjects.length;t++){let o=e.makarObjects[t];o.object3D&&o.object3D.traverse((e=>{e.isMesh&&(e.material&&(e.material.map&&e.material.map.dispose&&e.material.map.dispose(),e.material.dispose()),e.geometry&&e.geometry.dispose())})),o.remove()}e.makarObjects.length=0}Array.isArray(e.currentSceneMakarObjects)&&(e.currentSceneMakarObjects.length=0),e.cubeTex&&(e.cubeTex.texture&&e.cubeTex.texture.dispose(),e.cubeTex.dispose()),e.needsRenderTarget=!1;var r;if("string"!=typeof e.VRSceneResult[o].editor_ver)return console.log("VRFunc.js: _loadSceneObjects: the editor_ver is not string, error and return "),-1;let a;r=e.VRSceneResult[o].editor_ver.split("."),e.editor_version=r;let s=e.editorVerionControllSky(r,o,n);a="spherical_video"==s.scene_skybox_main_type?"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg":"spherical_image"==s.scene_skybox_main_type?"DefaultResource/Spherical_Image/SphericalImage.png"==s.scene_skybox_url?"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png":s.scene_skybox_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png",t(a,(function(t){let r;0==t&&(a="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg"),r=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let i=e.vrScene.renderer;THREE.GammaEncoding&&(i.outputEncoding=THREE.GammaEncoding,i.gammaFactor=1),e.checkVRSceneResultBehav(),e.clearBehavs();let l=(new THREE.TextureLoader).load(a,(function(){let t=r.fromEquirectangularTexture(i,l);e.cubeTex=t,e.loadSceneCount++,e.loadAssets();let a=e.loadSceneObjects(o,n),c=e.loadSky(o,n,s);if(c.then((function(e){console.log("VRFunc.js: _loadScene: pSky then ret = ",e)})),publishVRProjs.result[o].xml_urls&&publishVRProjs.result[o].xml_urls[n]){let t=e.parseLogicXML(o,n);a.push(t)}Promise.all(a.concat(c)).then((function(t){console.log("VRFunc.js: _loadScene: pAll then ret = ",t),e.onlySkyScene.add(document.getElementById("sky").object3D.clone(!0)),loadPage.style.display="none",homePage.style.display="none",homeTickOn&&(homeTickOn=!1),null!=typeof e.loadingTickOn&&(e.loadingTickOn=!1),e.triggerEnable=!0,publishVRProjs.result[o].xml_urls&&publishVRProjs.result[o].xml_urls[n]&&null!=e.logic.xmlDoc&&e.logic.parseXML(),e.setupSceneBehav(),setTimeout((function(){e.calcSceneArea()}),1),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()}))}))}))}},this.editorVerionControllSky=function(t,o,n){let r={scene_skybox_url:"",scene_skybox_main_type:""};if(console.log("VRFunc.js: _editorVerionControllSky: ",t,VRSceneResult[o].scenes[n]),3==t.length){let i=t[0],l=t[1],a=t[2];switch(i){case"3":l<3?(r.scene_skybox_url=VRSceneResult[o].scenes[n].scene_skybox_url,r.scene_skybox_main_type=VRSceneResult[o].scenes[n].scene_skybox_main_type,r.scene_snapshot_url=VRSceneResult[o].scenes[n].scene_snapshot_url,console.log("VRFunc.js: _editorVerionControllSky: below 3.3.2 ",VRSceneResult[o].scenes[n])):l>=3&&a>=2?(r.scene_skybox_url=VRSceneResult[o].scenes[n].environment.scene_skybox_url,r.scene_skybox_main_type=VRSceneResult[o].scenes[n].environment.scene_skybox_main_type,r.scene_snapshot_url=VRSceneResult[o].scenes[n].environment.scene_snapshot_url,console.log("VRFunc.js: _editorVerionControllSky: after 3.3.2 ",VRSceneResult[o].scenes[n])):l>=4?(r.scene_skybox_url=VRSceneResult[o].scenes[n].environment.scene_skybox_url,r.scene_skybox_main_type=VRSceneResult[o].scenes[n].environment.scene_skybox_main_type,r.scene_snapshot_url=VRSceneResult[o].scenes[n].environment.scene_snapshot_url,console.log("VRFunc.js: _editorVerionControllSky: after 3.4.0 ",VRSceneResult[o].scenes[n])):console.log("VRFunc.js: _editorVerionControllSky: large version error ",VRSceneResult[o].scenes[n]);break;case"2":case"1":console.log("VRFunc.js: _editorVerionControllSky: largeVersion below 3",e.VRSceneResult[o]),r.scene_skybox_url=VRSceneResult[o].scenes[n].scene_skybox_url,r.scene_skybox_main_type=VRSceneResult[o].scenes[n].scene_skybox_main_type,r.scene_snapshot_url=VRSceneResult[o].scenes[n].scene_snapshot_url;break;default:console.log("VRFunc.js: _editorVerionControllSky: missing large version ",e.VRSceneResult[o])}}else if(""==e.VRSceneResult[o].editor_ver){if(!Array.isArray(e.VRSceneResult[o].scenes[n].scene_skybox_url))return console.log("VRFunc.js: _editorVerionControllSky the scene_skybox_url is not exist, error",e.VRSceneResult[o]),-1;console.log("VRFunc.js: _editorVerionControllSky: the editor version empty",e.VRSceneResult[o]),r.scene_skybox_url=VRSceneResult[o].scenes[n].scene_skybox_url,r.scene_skybox_main_type=VRSceneResult[o].scenes[n].scene_skybox_main_type,r.scene_snapshot_url=VRSceneResult[o].scenes[n].scene_snapshot_url}return r},this.editorVersionControllObjs=function(t,o,n){let r;if(3==t.length){let i=t[0],l=t[1],a=t[2];switch(i){case"3":if(0==l&&a<=6){if(!Array.isArray(e.VRSceneResult[o].scenes[n].scene_objs))return console.log("VRFunc.js: _editorVerionControll the scenes[sceneIndex] is not Array, error",e.VRSceneResult[o]),-1;console.log("VRFunc.js: _editorVerionControll: the editor version before 3.0.6",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].scene_objs}else if(1==l||0==l&&a>=7)console.log("VRFunc.js: _editorVerionControll: the editor version after 3.0.7",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].objs;else if(2==l||l>=3){if(console.log("VRFunc.js: _editorVerionControll: the editor version is 3.2.n or 3.3.n",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].objs,e.VRSceneResult[o].scenes[n].camera_rotation&&e.VRSceneResult[o].scenes[n].fov){let s=(new THREE.Vector3).fromArray(e.VRSceneResult[o].scenes[n].camera_rotation.split(",").map((function(e){return Number(e)})));s.multiply(new THREE.Vector3(-1,-1,0)).add(new THREE.Vector3(0,180,0));let c=document.getElementById("aCamera"),u=document.getElementById("oCamera");function d(){console.log("VRFunc.js: _editorVerionControll: aCamera set fov = ",VRSceneResult[o].scenes[n].fov);let t=document.getElementById("vrscene");t.camera.fov=VRSceneResult[o].scenes[n].fov,c.setAttribute("camera",{fov:VRSceneResult[o].scenes[n].fov}),u.setAttribute("camera",{fov:VRSceneResult[o].scenes[n].fov}),parent.selectedProject?"XR"==parent.selectedProject.viewMode?e.setViewMode("VR"):"model"==parent.selectedProject.viewMode?e.setViewMode("model"):e.setViewMode("VR"):e.setViewMode("VR"),t.camera.updateProjectionMatrix(),console.log("VRFunc.js: _editorVerionControll: aCamera loaded rotation=",s),c.components["look-controls"].yawObject.rotation.y=s.y/180*Math.PI,c.components["look-controls"].pitchObject.rotation.x=s.x/180*Math.PI,console.log("VRFunc.js: _loadSceneObjects aCamera: yawr=",c.components["look-controls"].yawObject.rotation,", pitchr=",c.components["look-controls"].pitchObject.rotation),c.removeEventListener("look-controls-loaded",d)}c&&(c.components["look-controls"].yawObject&&c.components["look-controls"].pitchObject?(console.log("VRFunc.js: _editorVerionControll: aCamera look-controls already set"),d()):(console.log("VRFunc.js: _editorVerionControll: aCamera look-controls not set yet"),c.addEventListener("look-controls-loaded",d)))}}else console.error("VRFunc.js: _editorVerionControll: the editor version after 3.2 , error ",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].objs;break;case"2":case"1":console.log("VRFunc.js: _editorVerionControll: largeVersion below 3",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].scene_objs;break;default:console.log("VRFunc.js: _editorVerionControll: missing large version ",e.VRSceneResult[o])}}else if(""==e.VRSceneResult[o].editor_ver){if(!Array.isArray(e.VRSceneResult[o].scenes[n].scene_objs))return console.log("VRFunc.js: _loadSceneObjects the scene_objs_v2 is not Array, error",e.VRSceneResult[o]),-1;console.log("VRFunc.js: _loadSceneObjects: the editor version empty",e.VRSceneResult[o]),r=e.VRSceneResult[o].scenes[n].scene_objs}return r},this.loadSky=function(o,n,r){return new Promise((function(i){t(r.scene_skybox_url,(function(t){let l;if(console.log(" ******  retStatus = ",t,r.scene_skybox_url),0==t){if(document.getElementById("sky")?(l=document.getElementById("sky"),"a-sky"==l.localName||"a-videosphere"==l.localName&&(l.remove(),l=document.createElement("a-sky"),l.setAttribute("id","sky"),e.vrScene.appendChild(l))):(l=document.createElement("a-sky"),l.setAttribute("id","sky"),e.vrScene.appendChild(l)),"DefaultResource/Spherical_Image/SphericalImage.png"==r.scene_skybox_url);else{let e=document.createElement("div");e.style.position="absolute",e.style.top="30%",e.style.left="0%",e.style.width="100%",e.style.height="40%",e.style.color="black",e.style.backgroundColor="rgba(128,128,128,0.5)",e.style.pointerEvents="none",e.style.fontSize="24px",e.style.zIndex=3,document.body.appendChild(e);let t=document.createElement("div");t.className="centerText",t.style.whiteSpace="pre-wrap",t.textContent="此專案的環景影片/圖片無法於瀏覽器支援，改為預設場景",e.appendChild(t),setTimeout((function(){e.remove()}),8e3)}let t=!1;if(l.getAttribute("material")&&l.getAttribute("material").src==r.scene_skybox_url&&(t=!0),1==t)console.log("VRFunc.js: _loadSky: spherical_image same as previous(404)"),i(l);else{l.setAttribute("material",{src:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png"}),l.setAttribute("radius",2e3);var a=function(){console.log("VRFunc.js: _loadSky: spherical_image materialtextureloaded, remove loading page "),l.removeEventListener("materialtextureloaded",a)};l.addEventListener("materialtextureloaded",a),i(l)}}else{switch(r.scene_skybox_main_type){case"spherical_image":case"image":document.getElementById("sky")?(l=document.getElementById("sky"),"a-sky"==l.localName||"a-videosphere"==l.localName&&(l.remove(),l=document.createElement("a-sky"),l.setAttribute("id","sky"),e.vrScene.appendChild(l))):(l=document.createElement("a-sky"),l.setAttribute("id","sky"),e.vrScene.appendChild(l)),"DefaultResource/Spherical_Image/SphericalImage.png"==r.scene_skybox_url&&(r.scene_skybox_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png");let t=!1;l.getAttribute("material")&&l.getAttribute("material").src==r.scene_skybox_url&&(t=!0),0==t?(l.setAttribute("material",{src:r.scene_skybox_url}),a=function(){console.log("VRFunc.js: _loadSky: spherical_image materialtextureloaded, remove loading page "),l.removeEventListener("materialtextureloaded",a),i(l)},l.addEventListener("materialtextureloaded",a)):(console.log("VRFunc.js: _loadSky: spherical_image same as previous  "),i(l)),l.setAttribute("radius",2e3);break;case"spherical_video":let s=document.getElementById("makarAssets");document.getElementById("sky")?(l=document.getElementById("sky"),"a-sky"==l.localName?(l.remove(),l=document.createElement("a-videosphere"),l.setAttribute("id","sky"),e.vrScene.appendChild(l)):l.localName):(l=document.createElement("a-videosphere"),l.setAttribute("id","sky"),e.vrScene.appendChild(l));let c=document.createElement("video");c.src=r.scene_skybox_url,c.playsInline=!0,c.autoplay=!0,c.muted=!0,c.setAttribute("loop","true"),c.setAttribute("type","video/mp4"),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(c.muted=!0)),c.onloadedmetadata=function(){console.log("VRFunc.js: _loadSky: spherical_video onloadedmetadata"),c.play()},c.setAttribute("crossorigin","anonymous"),c.setAttribute("id",e.VRSceneResult[o].scenes[n].scene_id+"_"+e.loadSceneCount),c.setAttribute("autoplay","true"),s.appendChild(c),l.setAttribute("src","#"+e.VRSceneResult[o].scenes[n].scene_id+"_"+e.loadSceneCount),l.setAttribute("radius",2e3),a=function(){console.log("VRFunc.js: _loadSky: spherical_video materialtextureloaded, remove loading page "),l.removeEventListener("materialtextureloaded",a),i(l)},l.addEventListener("materialtextureloaded",a)}console.log("VRFunc.js: _loadSky: aSky=",l)}}))}))},this.loadSceneObjects=function(t,n){if(!userProjResDict)return console.log("%cVRFunc.js: _loadSceneObjects: error userProjResDict not exist, return -1","color:red"),[];let r=[];var a=[];if("string"!=typeof e.VRSceneResult[t].editor_ver)return console.log("VRFunc.js: _loadSceneObjects: the editor_ver is not string, error and return "),[];if(a=e.VRSceneResult[t].editor_ver.split("."),r=e.editorVersionControllObjs(a,t,n),!Array.isArray(r))return[];let s=[];for(let n=0;n<r.length;n++){let u=(new THREE.Vector3).fromArray(r[n].transform[0].split(",").map((function(e){return Number(e)}))),d=(new THREE.Vector3).fromArray(r[n].transform[1].split(",").map((function(e){return Number(e)}))),m=(new THREE.Vector3).fromArray(r[n].transform[2].split(",").map((function(e){return Number(e)})));switch(r[n].main_type){case"camera":if(e.VRSceneResult[t].editor_ver&&"string"==typeof e.VRSceneResult[t].editor_ver&&3==(a=e.VRSceneResult[t].editor_ver.split(".")).length&&3==a[0]&&2==a[1]){console.log("VRFunc.js: _loadSceneObjects: camera: editor vesion is 3.2.n , dont set");break}let b=document.getElementById("camera_cursor");var c=function(){b.hasLoaded?(d.multiply(new THREE.Vector3(-1,-1,0)).add(new THREE.Vector3(0,180,0)),b.setAttribute("position",u),aCamera.components["look-controls"].yawObject&&aCamera.components["look-controls"].pitchObject&&(aCamera.components["look-controls"].yawObject.rotation.y=d.y/180*Math.PI,aCamera.components["look-controls"].pitchObject.rotation.x=d.x/180*Math.PI,aCamera.object3D.position.set(0,0,0),console.log("VRFunc.js: _loadSceneObjects aCamera: yawr=",aCamera.components["look-controls"].yawObject.rotation,", pitchr=",aCamera.components["look-controls"].pitchObject.rotation)),console.log("VRFunc.js: _loadSceneObjects: camera: ",n,r[n],u,d,b,e.vrScene)):(setTimeout(c,100),console.log("VRFunc.js: _loadSceneObjects: camera: not loaded, wait"))};setTimeout(c,10);break;case"image":let p=r[n];if(console.log("VRFunc.js: _loadSceneObjects: image: ",n,r[n]),userProjResDict[p.res_id])if(p.res_url==userProjResDict[p.res_id].res_url){let t=e.loadTexture(p,u,d,m);s.push(t)}else console.log("%cVRFunc.js: _loadSceneObjects: image res_url is different from userProjResDict!","color:red",n,p,userProjResDict[p.res_id]);else{switch(p.res_id){case"MakAR_Call":p.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"MakAR_Room":p.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"MakAR_Mail":p.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"Line_icon":p.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"FB_icon":p.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;default:console.log("%c VRFunc.js: _loadSceneObjects: image res_id not exist!","color:red",p)}let t=e.loadTexture(p,u,d,m);s.push(t)}break;case"text":console.log("VRFunc.js: _loadText: text: ",n,r[n]);let h=e.loadText(r[n],u,d,m);s.push(h);break;case"audio":if(("mp3"==r[n].sub_type||"wav"==r[n].sub_type||"ogg"==r[n].sub_type)&&r[n].res_url){let t=e.loadAudio(r[n],u,d,m);s.push(t)}break;case"video":if("mp4"==r[n].sub_type&&r[n].res_url){let t=e.loadVideo(r[n],u,d,m);s.push(t)}break;case"model":if(console.log("VRFunc.js: _loadSceneObjects: model",n,r[n]),userProjResDict[r[n].res_id])r[n].res_url=userProjResDict[r[n].res_id].res_url;else if(userOnlineResDict[r[n].res_id])r[n].res_url=userOnlineResDict[r[n].res_id].res_url;else switch(r[n].res_id){case"Cube":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb";break;case"Capsule":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb";break;case"Sphere":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb";break;case"ch_Bojue":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb";break;case"ch_Fei":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb";break;case"ch_Lina":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb";break;case"ch_Poyuan":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb";break;case"ch_Roger":r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb";break;default:if(r[n].res_gltf_resource)break;r[n].material=[],r[n].res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb"}let g=e.loadGLTFModel(r[n],u,d,m,e.cubeTex);s.push(g);break;case"light":console.log("VRFunc.js: _loadSceneObjects: light",n,r[n]),e.loadLight(r[n],u,d,m);break;case"empty":if("quiz"===r[n].sub_type){if(r[n].module[0].trigger){let e=setInterval((function(){let t=document.getElementById(r[n].module[0].trigger);t&&(window.clearInterval(e),t.object3D.behav?t.object3D.behav.push({obj_id:r[n].obj_id,played:!1,simple_behav:"ShowQuiz"}):t.object3D.behav=[{obj_id:r[n].obj_id,played:!1,simple_behav:"ShowQuiz"}],t.object3D.triggerQuiz={obj_id:r[n].obj_id,played:!1})}),1)}let t=document.getElementById("startQuiz");r[n].module[0].trigger?t.style.display="none":t.style.display="block";let a=document.getElementById("QuizStartButton"),s=function(){new o(r[n]).load(r[n],u,d,m),t.style.display="none",a.removeEventListener("click",s)},c=function(){t.style.display="none",a.removeEventListener("click",c)},b=window.serverUrl,p=localStorage.getItem("login_shared_id"),h=publishVRProjs.result[e.projectIdx].proj_id;1==r[n].module[0].force_login?p?0==r[n].module[0].allow_retry?(console.log("VRFunc.js: _getRecordModule: get remote: ",p,h),getRecordModule(b,p,h,(function(e){console.log("VRFunc.js: _getRecordModule: ret= ",e),e.data.record_module_list?(QuizStartContent.textContent=l.userAlreadyPlayed[i],a.addEventListener("click",c)):(QuizStartContent.textContent=l.clickToPlay[i],a.addEventListener("click",s))}))):(QuizStartContent.textContent=l.clickToPlay[i],a.addEventListener("click",s)):(QuizStartContent.textContent=l.userNotLoginInfo[i],a.addEventListener("click",c)):(QuizStartContent.textContent=l.clickToPlay[i],a.addEventListener("click",s)),console.log("VRFunc.js: _loadSceneObjects: empty, quiz ",n,r[n])}else console.log("VRFunc.js: _loadSceneObjects: empty object default, ",n,r[n]);break;default:console.log("VRFunc.js: _loadSceneObjects: default",n,r[n])}}return s},this.checkDefaultImage=function(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;default:console.log("image: default, obj=",e)}},this.loadTexture=function(o,n,r,i){return e.checkDefaultImage(o),new Promise((function(l){t(o.res_url,(function(t){if(1==t){var a=(new THREE.TextureLoader).load(o.res_url);let t,s=o.res_url.split(".").length,c=o.res_url.split(".")[s-1].toLowerCase();if(o.sub_type=o.sub_type.toLowerCase(),"png"==o.sub_type||"jpg"==o.sub_type||"jpeg"==o.sub_type||"bmp"==o.sub_type)c=o.sub_type,t=document.createElement("a-plane"),t.setAttribute("src",o.res_url);else if("gif"==o.sub_type)c=o.sub_type,t=document.createElement("a-entity");else{if("button"!=o.sub_type)return console.log("VRFunc.js: _loadTexture: sub_type empty, create empty plane "),t=document.createElement("a-plane"),void l(t);"png"!=c&&"jpg"!=c&&"jpeg"!=c&&(c="png"),t=document.createElement("a-plane"),t.setAttribute("src",o.res_url)}t.setAttribute("id",o.obj_id),t.setAttribute("crossorigin","anonymous");let u,d,m,b,p=!1;if(o.behav)for(let e=0;e<o.behav.length;e++)"TransparentVideo"!=o.behav[e].simple_behav&&"TransparentImage"!=o.behav[e].simple_behav||(p=!0,u=o.behav[e].chromakey,d=o.behav[e].slope,m=o.behav[e].threshold,b=o.behav[e]);if(p){let e=u.split(","),n=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),r=b.HSV.split(","),i=parseFloat(r[0]),l=parseFloat(r[1]),a=parseFloat(r[2]);"jpg"==c||"jpeg"==c||"png"==c?"RGB"==b.mode?t.setAttribute("material","shader: chromaKey; color: #"+n.getHexString()+";transparent: true; side:double; depthWrite:false; _slope: "+parseFloat(d)+"; _threshold: "+parseFloat(m)+";"):"HSV"==b.mode&&t.setAttribute("material","shader: HSVMatting; transparent: true; side:double; depthWrite:false; _keyingColorH:"+i+"; _keyingColorS:"+l+"; _keyingColorV:"+a+"; _deltaH:"+parseFloat(b.hue)+"; _deltaS:"+parseFloat(b.saturation)+"; _deltaV:"+parseFloat(b.brightness)+";"):"gif"==c&&("RGB"==b.mode?(t.setAttribute("geometry","primitive: plane"),t.setAttribute("material","shader:gif_RGB;  src: url("+o.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; color: #"+n.getHexString()+"; _slope: "+parseFloat(d)+"; _threshold: "+parseFloat(m)+";")):"HSV"==b.mode&&(t.setAttribute("geometry","primitive: plane"),t.setAttribute("material","shader:gif_HSV;  src: url("+o.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; _keyingColorH:"+i+"; _keyingColorS:"+l+"; _keyingColorV:"+a+"; _deltaH:"+parseFloat(b.hue)+"; _deltaS:"+parseFloat(b.saturation)+"; _deltaV:"+parseFloat(b.brightness)+";")))}else"jpg"==c||"jpeg"==c||"png"==c?(t.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; depthWrite:false"),t.setAttribute("geometry","primitive: plane")):"gif"==c&&(t.setAttribute("geometry","primitive: plane"),t.setAttribute("material","side:double; shader:gif;  src: url("+o.res_url+"); opacity: 1; transparent: true; depthWrite:false"));o.behav?1==o.behav.length&&p?t.setAttribute("class","unclickable"):t.setAttribute("class","clickable"):t.setAttribute("class","unclickable"),e.setTransform(t,n,r,i),e.makarObjects.push(t);let h=e.vrScene.renderer.capabilities.getMaxAnisotropy();if(t.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=h,e.detail.texture.needsUpdate=!0})),t.addEventListener("loaded",(function(n){if(n.target==n.currentTarget){let n=setInterval((function(){a.image&&(t.object3D.children[0].scale.set(.01*a.image.width,.01*a.image.height,1),t.setAttribute("heightForQuiz",.01*a.image.height),window.clearInterval(n))}),1),r=new THREE.Vector3;r.set(0,Math.PI,0),t.object3D.children[0].rotation.setFromVector3(r),t.object3D.children[0].renderOrder=1,t.object3D.makarObject=!0,o.behav&&(t.object3D.behav&&0!=t.object3D.behav.length?o.behav.forEach((e=>{t.object3D.behav.push(e)})):t.object3D.behav=o.behav,e.setObjectBehavAll(o)),o.behav_reference&&(t.object3D.behav_reference=o.behav_reference),"button"==o.main_type&&(t.object3D.main_type=o.main_type,t.object3D.sub_type=o.sub_type,t.setAttribute("class","clickable"),console.log("VRFunc.js: _loadTexture: button ",t),Array.isArray(t.object3D.behav)?t.object3D.behav.push({simple_behav:"PushButton"}):t.object3D.behav=[{simple_behav:"PushButton"}]),l(t)}else console.log("VRFunc.js: _loadTexture: loaded target different")})),0==o.active&&(t.setAttribute("visible",!1),t.setAttribute("class","unclickable")),o.behav_reference)for(let e=0;e<o.behav_reference.length;e++)if("ShowImage"==o.behav_reference[e].behav_name){t.setAttribute("visible",!1),t.setAttribute("class","unclickable");break}if(o.obj_parent_id){let e=setInterval((function(){let n=document.getElementById(o.obj_parent_id);n&&n.object3D.children.length>0&&(n.appendChild(t),window.clearInterval(e))}),1)}else e.vrScene.appendChild(t)}else console.log("VRFunc.js: _loadTexture , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",e.loadGLTFModel(o,n,r,i,e.cubeTex),l(1)}))}))},this.loadText=function(t,o,n,r){return new Promise((function(i){let l=document.createElement("a-entity");e.setTransform(l,o,n,r),l.setAttribute("id",t.obj_id),e.makarObjects.push(l),t.behav||"button"==t.main_type?l.setAttribute("class","clickable"):l.setAttribute("class","unclickable");let a=document.createElement("a-text");a.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),a.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let s=t.content.split("\n"),c=0;const u=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,d=e=>u.test(e);for(let e=0;e<s.length;e++){let t=0;for(let o=0;o<s[e].length;o++)d(s[e][o])?t+=1.6:s[e][o]==s[e][o].toUpperCase()&&s[e][o]!=s[e][o].toLowerCase()||s[e][o]==s[e][o].toLowerCase()&&s[e][o]!=s[e][o].toUpperCase()?t+=1:isNaN(1*s[e][o])?t+=1.25:t+=1;t>c&&(c=t)}a.setAttribute("value",t.content),a.setAttribute("anchor","center"),a.setAttribute("align","left"),a.setAttribute("backcolor",t.back_color),a.setAttribute("textcolor",t.color),a.setAttribute("side","double");var m="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/";let b=[m+"1-msdf.json",m+"2-msdf.json",m+"3-msdf.json",m+"4-msdf.json",m+"5-msdf.json",m+"6-msdf.json",m+"7-msdf.json",m+"8-msdf.json",m+"9-msdf.json",m+"10-msdf.json",m+"11-msdf.json",m+"12-msdf.json"];a.setAttribute("font",b),a.setAttribute("negate","false"),a.setAttribute("crossorigin","anonymous");let p=t.color.split(","),h=new THREE.Color(parseFloat(p[0]),parseFloat(p[1]),parseFloat(p[2]));a.setAttribute("color","#"+h.getHexString());let g=0;if(a.addEventListener("geometry-set",(function e(t){console.log("VRFunc.js: _loadText: textEntity geometry-set: evt=",t),0==g?g=1:1==g&&i(a),a.removeEventListener("geometry-set",e)})),a.addEventListener("loaded",(function(o){if(o.target==o.currentTarget){console.log("VRFunc.js: _loadText loaded textEntity=",a.object3D,a.object3D.parent.scale.x);let o=new THREE.Vector3;o.set(0,Math.PI,0),a.object3D.rotation.setFromVector3(o),l.object3D.makarObject=!0,t.behav&&(l.object3D.behav&&0!=l.object3D.behav.length?t.behav.forEach((e=>{l.object3D.behav.push(e)})):l.object3D.behav=t.behav,e.setObjectBehavAll(t)),t.behav_reference&&(l.object3D.behav_reference=t.behav_reference),"button"==t.main_type&&(l.object3D.main_type=t.main_type,Array.isArray(l.object3D.behav)?l.object3D.behav.push({simple_behav:"PushButton"}):l.object3D.behav=[{simple_behav:"PushButton"}]),0==g?g=1:1==g&&i(a)}})),l.appendChild(a),0==t.active&&(l.setAttribute("visible",!1),l.setAttribute("class","unclickable")),t.behav_reference)for(let e=0;e<t.behav_reference.length;e++)if("ShowText"==t.behav_reference[e].behav_name){l.setAttribute("visible",!1),l.setAttribute("class","unclickable");break}if(console.log(" VRFunc.js: _loadText: anchor= ",l.object3D,", obj=",t),t.obj_parent_id){let e=setInterval((function(){let o=document.getElementById(t.obj_parent_id);o&&o.object3D.children.length>0&&(o.appendChild(l),window.clearInterval(e))}),100)}else e.vrScene.appendChild(l)}))},this.checkGLTFMaterialIndex=function(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("VRFunc.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("VRFunc.js: _checkGLTFMaterialIndex: material error",t);let o=t.rendererIndex,n=t.materialIndex,r=-1,i=-1,l=e.object3D.children[0].ModelJson.nodes,a=-1;for(let e=0;e<l.length;e++)if("number"==typeof l[e].mesh&&a++,o==a){r=l[e].mesh;break}if(r>=0){let t=e.object3D.children[0].ModelJson.meshes[r];if(t&&t.primitives){let e=t.primitives[n];e&&e.material>=0&&(i=e.material,console.log("VRFunc.js: _checkGLTFMaterialIndex: materialIndex=",i))}}return i},this.loadGLTFModel=function(o,n,r,i,l){return new Promise((function(l){t(o.res_url,(function(t){if(1==t){if(""==o.res_url||"glb"!=o.sub_type&&"gltf"!=o.sub_type&&"gltf_sketchFab"!=o.sub_type&&"gltf_sketchfab"!=o.sub_type&&"gltf_poly"!=o.sub_type)return console.log("VRFunc.js: _loadGFLTFModel: obj not support ",o),void l(-1);let t=document.getElementById("makarAssets"),c=document.createElement("a-asset-item");c.setAttribute("id",o.obj_id+"_"+o.res_id),c.setAttribute("src",o.res_url),c.setAttribute("response-type","arraybuffer"),c.setAttribute("crossorigin","anonymous"),t.appendChild(c);var a,s=null;if(o.animation)if(s=[],Array.isArray(e.editor_version)&&3==e.editor_version.length){let t=Number(e.editor_version[0]),n=Number(e.editor_version[1]),r=Number(e.editor_version[2]);if(t>3||3==t&&n>3||3==t&&3==n&&r>8){for(let e=0;e<o.animation.length;e++)(o.animation[e].is_default||o.animation[e].is_active)&&(s.push({idle:o.animation[e].uid,loop:o.animation[e].uid,uid:o.animation[e].uid,changed:!1,reset:!0,count:0}),a=o.animation[e].animation_name);for(let e=0;e<o.animation.length;e++)s.push({name:o.animation[e].name,animationName:o.animation[e].animation_name,startTime:o.animation[e].start_time,endTime:o.animation[e].end_time,uid:o.animation[e].uid})}else{for(let e=0;e<o.animation.length;e++)(o.animation[e].defaultAnimation||o.animation[e].isActive)&&(s.push({idle:o.animation[e].uid,loop:o.animation[e].uid,uid:o.animation[e].uid,changed:!1,reset:!0,count:0}),a=o.animation[e].animationName);for(let e=0;e<o.animation.length;e++)s.push({name:o.animation[e].name,animationName:o.animation[e].animationName,startTime:o.animation[e].startTime,endTime:o.animation[e].endTime,uid:o.animation[e].uid})}}else{for(let e=0;e<o.animation.length;e++)(o.animation[e].is_default||o.animation[e].is_active)&&(s.push({idle:o.animation[e].uid,loop:o.animation[e].uid,uid:o.animation[e].uid,changed:!1,reset:!0,count:0}),a=o.animation[e].animation_name);for(let e=0;e<o.animation.length;e++)s.push({name:o.animation[e].name,animationName:o.animation[e].animation_name,startTime:o.animation[e].start_time,endTime:o.animation[e].end_time,uid:o.animation[e].uid})}let u=document.createElement("a-entity");if(!o.res_url)return;if(u.setAttribute("gltf-model","#"+o.obj_id+"_"+o.res_id),o.animation&&u.setAttribute("animation-mixer","clip: "+a),o.behav?u.setAttribute("class","clickable"):u.setAttribute("class","unclickable"),u.setAttribute("id",o.obj_id),u.setAttribute("crossorigin","anonymous"),u.setAttribute("shadow",""),o.model_shift){let e=(new THREE.Vector3).fromArray(o.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(i),n.add(e)}if(e.setTransform(u,n,r,i),e.makarObjects.push(u),u.addEventListener("model-loaded",(function(t){if(t.target==t.currentTarget){let r=e.vrScene.renderer.capabilities.getMaxAnisotropy();if(t.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=r,e.material.map.needsUpdate=!0)})),u.object3D){u.object3D.makarObject=!0,o.behav&&(u.object3D.behav&&0!=u.object3D.behav.length?o.behav.forEach((e=>{u.object3D.behav.push(e)})):u.object3D.behav=o.behav,e.setObjectBehavAll(o)),o.behav_reference&&(u.object3D.behav_reference=o.behav_reference);let r=u.getObject3D("mesh"),i=-1;if(o.material)for(let t=0;t<o.material.length;t++){r.ModelJson&&(i=e.checkGLTFMaterialIndex(u,o.material[t]));let l=o.material[t].color.split(","),a=new THREE.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]));switch(r.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),o.material[t].shader){case"Unlit/Color":r.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:a,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":var n=u.sceneEl.renderer;r.traverse((r=>{if(r.material){let s=r.material.name.split("_");s[s.length-1]==i&&(r.material=new THREE.MeshStandardMaterial({name:r.material.name,skinning:r.material.skinning,map:r.material.map,emissive:r.material.emissive,emissiveMap:r.material.emissiveMap,normalMap:r.material.normalMap}),r.material.color=a,r.material.metalness=o.material[t].metallic,r.material.roughness=1-o.material[t].smoothness,r.material.envMap=e.cubeTex.texture,r.material.envMapIntensity=1,r.material.needsUpdate=!0,r.material.reflectivity=0,r.material.side=THREE.DoubleSide,r.material.transparent=!0,r.material.map&&(THREE.GammaEncoding&&(r.material.map.encoding=THREE.GammaEncoding),r.material.map.needsUpdate=!0),0==o.material[t].mode?(r.material.opacity=1,n.setClearAlpha(1),r.material.blending=THREE.CustomBlending,r.material.blendEquation=THREE.AddEquation,r.material.blendSrc=THREE.OneFactor,r.material.blendDst=THREE.ZeroFactor,r.material.blendSrcAlpha=THREE.ZeroFactor,r.material.blendDstAlpha=THREE.OneFactor):1==o.material[t].mode?(r.material.opacity=1,r.material.alphaTest=o.material[t].cut_off,n.setClearAlpha(1),r.material.blending=THREE.CustomBlending,r.material.blendEquation=THREE.AddEquation,r.material.blendSrc=THREE.OneFactor,r.material.blendDst=THREE.ZeroFactor,r.material.blendSrcAlpha=THREE.ZeroFactor,r.material.blendDstAlpha=THREE.OneFactor,r.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:r.material.map,alphaTest:o.material[t].cut_off})):2==o.material[t].mode?(r.material.opacity=parseFloat(l[3]),r.material.depthWrite=!1,r.renderOrder=1,r.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:r.material.map,alphaTest:o.material[t].cut_off})):3==o.material[t].mode&&(r.material.opacity=Math.max(parseFloat(l[3]),o.material[t].metallic),r.material.depthWrite=!1,r.material.blending=THREE.CustomBlending,r.material.blendEquation=THREE.AddEquation,r.material.blendSrc=THREE.OneFactor,r.material.blendDst=THREE.OneMinusSrcAlphaFactor,r.material.blendSrcAlpha=THREE.OneFactor,r.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,r.renderOrder=1,r.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:r.material.map,alphaTest:o.material[t].cut_off})))}}));break;case"Unlit/Transparent":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Unlit/Transparent Cutout":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":r.traverse((t=>{if(t.material){let o=t.material.name.split("_");o[o.length-1]==i&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.skyRenderTarget.texture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Blocks/BlocksGlass":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;default:console.log(`The shader of no. ${t} material is not supported currently.`)}}Array.isArray(t.detail.model.animations)&&t.detail.model.animations.length>0&&!u.getAttribute("animation-mixer")&&(console.log("VRFunc.js: loadGFLTFModel: the model with animation but no animation-mixer, probabily older version of editor ",t.detail.model),u.setAttribute("animation-mixer","clip: "+t.detail.model.animations[0].name),(s=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),s.push({animationName:t.detail.model.animations[0].name,name:t.detail.model.animations[0].name,endTime:t.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),t.detail.model.animationSlices=s,l(u)}}})),0==o.active&&(u.setAttribute("visible",!1),u.setAttribute("class","unclickable")),o.behav_reference)for(let e=0;e<o.behav_reference.length;e++)if("ShowModel"==o.behav_reference[e].behav_name){u.setAttribute("visible",!1),u.setAttribute("class","unclickable");break}if(o.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(o.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(u),window.clearInterval(e))}),1)}else e.vrScene.appendChild(u)}else console.log("VRFunc.js: _loadGLTFModel , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",e.loadGLTFModel(o,n,r,i,e.cubeTex),l(1)}))}))},this.loadFBXModel=function(t,o,n,r){let i=document.createElement("a-entity");if(t.res_url_fbx){if(i.setAttribute("fbx-model","src:"+t.res_url_fbx),i.setAttribute("animation-mixer",""),t.behav?i.setAttribute("class","clickable"):i.setAttribute("class","unclickable"),i.setAttribute("id",t.obj_id),e.setTransform(i,o,n,r),e.makarObjects.push(i),t.behav_reference)for(let e=0;e<t.behav_reference.length;e++)if("PlayAnimation"!=t.behav_reference[e].behav_name){i.setAttribute("visible",!1),i.setAttribute("class","unclickable");break}if(t.obj_parent_id){let e=setInterval((function(){let o=document.getElementById(t.obj_parent_id);o&&o.object3D.children.length>0&&(o.appendChild(i),window.clearInterval(e))}),1)}else e.vrScene.appendChild(i);i.addEventListener("model-loaded",(function(e){e.target==e.currentTarget&&(i.object3D.makarObject=!0,t.behav&&(i.object3D.behav&&0!=i.object3D.behav.length?t.behav.forEach((e=>{i.object3D.behav.push(e)})):i.object3D.behav=t.behav))}))}},this.loadAudio=function(o,n,r,i){return console.log("VRFunc.js: _loadAudio , obj=",o),new Promise((function(l){t(o.res_url,(function(t){if(1==t){let t=document.getElementById("makarAssets"),n=document.createElement("audio");n.setAttribute("id",o.obj_id+"_"+o.res_id),n.setAttribute("src",o.res_url),n.setAttribute("crossorigin","anonymous"),n.setAttribute("loop",!0),n.setAttribute("preload","auto"),t.appendChild(n),n.onloadedmetadata=function(){let t=document.createElement("a-sound");t.setAttribute("sound","src: #"+o.obj_id+"_"+o.res_id+"; autoplay: true; loop: true; volume: 1; positional: false"),t.setAttribute("id",o.obj_id),t.setAttribute("sound","autoplay: false"),e.makarObjects.push(t),0==o.active&&(t.setAttribute("sound","loop: false"),t.setAttribute("visible",!1),t.setAttribute("class","unclickable"));let n=!1;if(o.behav_reference){for(let i=0;i<o.behav_reference.length;i++)if("PlayMusic"==o.behav_reference[i].behav_name){n=!0,t.setAttribute("sound","loop: false"),t.setAttribute("visible",!1),t.setAttribute("class","unclickable");break}}else t.setAttribute("visible",!0);if(o.obj_parent_id){let a=setInterval((function(){let e=document.getElementById(o.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(t),window.clearInterval(a),e.addEventListener("child-attached",(function(e){if(console.log("VRFunc.js: VRController: _loadAudio,: parent child-attached, el=",e),o.blockly)t.blockly=o.blockly,t.setAttribute("sound","autoplay: false");else{let e=!0;t.object3D.traverseAncestors((function(i){if("Scene"!=i.type)console.log("VRFunc.js: VRController: _loadAudio,: traverseAncestors: not Scene parent=",i),0==i.visible&&(e=!1);else if(1==e&&1==t.object3D.visible&&0==n)if(console.log("VRFunc.js: VRController: _loadAudio,: traverseAncestors: all parent visible true=",t.object3D),1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==i.location){t.setAttribute("sound","autoplay: false");let l=document.getElementById("clickToPlayAudio");function a(){t.components.sound.playSound(),l.style.display="none",l.removeEventListener("click",a),window.allowAudioClicked=!0}l.style.display="block",l.addEventListener("click",a)}else t.setAttribute("sound","autoplay: true"),r(o,t,n);else console.log("2 VRFunc.js: VRController: _loadAudio,: traverseAncestors: not all parent visible true=",t.object3D.children[0]),t.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(console.log("VRFunc.js: _loadAudio: no parent set autoplay true",t.object3D,location),o.blockly)t.blockly=o.blockly,t.setAttribute("sound","autoplay: false");else if(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location){t.setAttribute("sound","autoplay: false");let s=document.getElementById("clickToPlayAudio");function c(){t.components.sound.playSound(),s.style.display="none",s.removeEventListener("click",c),window.allowAudioClicked=!0}s.style.display="block",s.addEventListener("click",c)}else 1==n?(t.setAttribute("sound","autoplay: false"),t.setAttribute("visible",!1)):(t.setAttribute("sound","autoplay: true"),r(o,t,n));e.vrScene.appendChild(t)}function r(e,t,o){console.log("checkAudioTypeAttr obj",e),(0==e.active||o)&&t.setAttribute("sound","autoplay: false"),e&&(null!=e.is_loop&&t.setAttribute("sound",`loop: ${e.is_loop}`),null!=e.volume&&t.setAttribute("sound",`volume: ${e.volume}`))}t.addEventListener("loaded",(function(n){n.target==n.currentTarget&&(console.log("3 VRFunc.js: VRController: _loadAudio,: loaded, soundEntity.object3D.children[0]=",t.object3D.children[0]),t.object3D.makarObject=!0,o.behav&&(t.object3D.behav&&0!=t.object3D.behav.length?o.behav.forEach((e=>{t.object3D.behav.push(e)})):t.object3D.behav=o.behav,e.setObjectBehavAll(o)),o.behav_reference&&(t.object3D.behav_reference=o.behav_reference),l(t))}))}}else console.log("VRFunc.js: _loadAudio , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",e.loadGLTFModel(o,n,r,i,e.cubeTex),l(1)}))}))},this.loadVideo=function(o,n,r,i){return new Promise((function(l){t(o.res_url,(function(t){if(1==t){let t=document.getElementById("makarAssets");var a;(a=document.createElement("video")).src=o.res_url,a.playsInline=!0,a.autoplay=!1,a.loop=!0,a.setAttribute("crossorigin","anonymous"),a.setAttribute("id",o.obj_id+"_"+o.res_id+"_"+e.loadSceneCount),t.appendChild(a),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(a.muted=!0),a.onloadedmetadata=function(){var t,s;a.videoWidth>=a.videoHeight?(t=1,s=1*a.videoHeight/a.videoWidth):(t=1*a.videoWidth/a.videoHeight,s=1);let c=document.createElement("a-video"),u=!1;if(o.behav)for(let e=0;e<o.behav.length;e++)"TransparentVideo"==o.behav[e].simple_behav&&(u=!0,chromaKey=o.behav[e].chromakey,slope=o.behav[e].slope,threshold=o.behav[e].threshold,transparentBehav=o.behav[e]);if(u){let e=chromaKey.split(",");var d=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));if("RGB"!=transparentBehav.mode&&transparentBehav.mode){if("HSV"==transparentBehav.mode){let e=transparentBehav.HSV.split(","),t=parseFloat(e[0]),o=parseFloat(e[1]),n=parseFloat(e[2]);c.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+t+"; _keyingColorS:"+o+"; _keyingColorV:"+n+"; _deltaH:"+transparentBehav.hue+"; _deltaS:"+transparentBehav.saturation+"; _deltaV:"+transparentBehav.brightness+";")}}else c.setAttribute("material","shader: chromaKey; color: #"+d.getHexString()+";transparent: true; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";")}else c.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");o.behav?1==o.behav.length&&u?c.setAttribute("class","unclickable"):c.setAttribute("class","clickable"):c.setAttribute("class","unclickable"),c.setAttribute("id",o.obj_id),c.setAttribute("src","#"+o.obj_id+"_"+o.res_id+"_"+e.loadSceneCount),c.mp4Video=a;let m=e.vrScene.renderer.capabilities.getMaxAnisotropy();c.addEventListener("materialtextureloaded",(function(e){console.log("VRFunc.js: _loadVideo: _materialtextureloaded: videoPlane = ",c.object3D,e),e.detail.texture.anisotropy=m,e.detail.texture.needsUpdate=!0})),e.setTransform(c,n,r,i),c.addEventListener("loaded",(function(n){if(n.target==n.currentTarget){c.object3D.children[0].scale.set(t,s,1);let n=new THREE.Vector3;n.set(0,Math.PI,0),c.object3D.children[0].rotation.setFromVector3(n),c.object3D.makarObject=!0,o.behav&&(c.object3D.behav&&0!=c.object3D.behav.length?o.behav.forEach((e=>{c.object3D.behav.push(e)})):c.object3D.behav=o.behav,e.setObjectBehavAll(o)),o.behav_reference&&(c.object3D.behav_reference=o.behav_reference),l(c)}})),e.makarObjects.push(c),0==o.active&&(c.setAttribute("visible",!1),c.setAttribute("class","unclickable"));let b=!1;if(o.behav_reference)for(let e=0;e<o.behav_reference.length;e++)if("ShowVideo"==o.behav_reference[e].behav_name){b=!0,c.setAttribute("visible",!1),c.setAttribute("class","unclickable");break}if(o.obj_parent_id){a.autoplay=!1;let t=setInterval((function(){let n=document.getElementById(o.obj_parent_id);n&&n.object3D.children.length>0&&(n.appendChild(c),window.clearInterval(t),n.addEventListener("child-attached",(function(t){if(console.log("VRFunc.js: VRController: _loadVideo,: parent child-attached, el=",t),o.blockly)c.blockly=o.blockly,a.pause(),a.currentTime=0;else{let t=!0;c.object3D.traverseAncestors((function(o){"Scene"!=o.type?0==o.visible&&(t=!1):1==t&&1==c.object3D.visible&&0==b?(console.log("VRFunc.js: VRController: _loadVideo,: traverseAncestors: all parent visible true=",c.object3D,b),a.autoplay=!0,a.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==o.location)&&e.dealVideoMuted(a)):(console.log("VRFunc.js: VRController: _loadVideo,: traverseAncestors: not all parent visible true=",t,c.object3D.visible,b),a.muted=!1,a.autoplay=!1,a.pause(),a.currentTime=0)}))}})))}),1)}else o.blockly?(c.blockly=o.blockly,a.pause(),a.currentTime=0):(a.autoplay=!0,a.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&e.dealVideoMuted(a)),e.vrScene.appendChild(c)}}else console.log("VRFunc.js: _loadVideo , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",e.loadGLTFModel(o,n,r,i,e.cubeTex),l(1)}))}))},this.loadLight=function(t,o,n,r){return new Promise((function(i){let l=document.createElement("a-entity");l.setAttribute("id",t.obj_id);let a="type:"+t.light.light_type,s=t.light.color.split(",");if(a+="; color:#"+new THREE.Color(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])).getHexString(),a+=";intensity:"+t.light.intensity,"point"!=t.light.light_type&&"spot"!=t.light.light_type||(a+=";distance:"+t.light.range,a+=";decay: 4"),"spot"==t.light.light_type&&(a+=";angle:"+(parseFloat(t.light.spotAngle)/2).toString(),a+=";penumbra: 0.2"),"None"!=t.light.shadow&&(l.setAttribute("castShadow",!0),a+=";castShadow: true ;shadowCameraVisible: false; shadowBias:-0.0005; shadowCameraTop:10; shadowCameraBottom:-10; shadowCameraRight:10; shadowCameraLeft:-10; shadowMapHeight:1024; shadowMapWidth:1024; shadowCameraFar: 500; shadowCameraNear: 0.5"),l.setAttribute("light",a),"directional"==t.light.light_type){let i=new THREE.Vector3(0,0,-100),a=new THREE.Euler,s=t.quaternionRotation.split(","),c=new THREE.Quaternion(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]),parseFloat(s[0]));a.setFromQuaternion(c),a.y=-a.y,a.z=-a.z,i.applyEuler(a),e.setTransform(l,o,n,r),l.addEventListener("loaded",(function(e){if(l.object3D&&l.object3D.children&&l.object3D.children[0]&&"DirectionalLight"==l.object3D.children[0].type){let e=new THREE.Vector3(0,0,1),t=l.object3D.children[0].target;t.position.copy(e),l.object3D.children[0].add(t)}})),l.setAttribute("castShadow",!1),l.setAttribute("light","castShadow: false; ")}else"spot"==t.light.light_type?(e.setTransform(l,o,n,r),l.addEventListener("loaded",(function(e){if(l.object3D&&l.object3D.children&&l.object3D.children[0]&&"SpotLight"==l.object3D.children[0].type){let e=new THREE.Vector3(0,0,1),t=l.object3D.children[0].target;t.position.copy(e),l.object3D.children[0].add(t)}}))):"point"==t.light.light_type?e.setTransform(l,o,n,r):(e.setTransform(l,o,n,r),console.log("VRFunc.js: _loadLight: Unexpected light type!!  obj.light.light_type=",t.light.light_type));if(0==t.active&&l.setAttribute("visible",!1),console.log("VRFunc.js: _loadLight: Light=",l),e.makarObjects.push(l),t.obj_parent_id){let e=setInterval((function(){let o=document.getElementById(t.obj_parent_id);o&&o.object3D.children.length>0&&(o.appendChild(l),window.clearInterval(e))}),1)}else e.vrScene.appendChild(l);i(l)}))},this.setTransform=function(e,t,o,n){let r=t.clone();r.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",r);let i=o.clone();i.multiply(new THREE.Vector3(1,-1,-1)),e.setAttribute("rotation",i),e.setAttribute("scale",n)},this.checkAnimation=function(e,t){e.mixer&&e.mixer.update(t),e.animationSlices&&e.animationSlices[0].index&&e.animationSlices[e.animationSlices[0].index]&&(e.mixer._actions[0].time>e.animationSlices[e.animationSlices[0].index].timeEnd||e.mixer._actions[0].time<e.animationSlices[e.animationSlices[0].index].timeStart)&&(e.mixer._actions[0].time=e.animationSlices[e.animationSlices[0].index].timeStart)},this.showObjectEvent=function(t,o){if(t)if(t.getAttribute("visible")){if(t.setAttribute("visible",!1),t.setAttribute("class","unclickable"),"a-video"==t.localName){let e=t.getAttribute("src");if(null!=e){e=e.split("#").pop();let t=document.getElementById(e);t instanceof HTMLElement&&t.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||e.UnMutedAndPlayAllVisibleVideo()),t.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound"))if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})),o&&t.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}else{window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||e.UnMutedAndPlayAllVisibleVideo(t)),t.setAttribute("visible",!0);let o=t.getAttribute("src");if(null!=o){o=o.split("#").pop();let e=document.getElementById(o);e instanceof HTMLElement&&e.play()}t.object3D.behav&&t.setAttribute("class","clickable"),t.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&(e.el.blockly?console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}else console.log("VRFunc.js: _showObjectEvent: target not exist",t)},this.hideGroupObjectEvent=function(e){e?e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}}))):console.log("VRFunc.js: _hideGroupObjectEvent: target not exist ",e)},this.clearBehavs=function(){let e=this;for(let t in e.groupDict)Array.isArray(e.groupDict[t].objs)&&(e.groupDict[t].objs.length=0);e.lookAtObjectList.length=0,e.lookAtObjectList=[];for(let t in e.lookAtTimelineDict)"function"==typeof e.lookAtTimelineDict[t].pause&&"function"==typeof e.lookAtTimelineDict[t].kill&&(e.lookAtTimelineDict[t].pause(),e.lookAtTimelineDict[t].kill());e.lookAtTimelineDict={}},this.checkVRSceneResultBehav=function(){let e=this;if(!Number.isFinite(Number(e.projectIdx)))return void console.error(" _checkVRSceneResultBehav: projectIdx error ",e.projectIdx);if(!Array.isArray(VRSceneResult)||!VRSceneResult[e.projectIdx]||!Number.isInteger(Number(e.sceneIndex)))return void console.error(" _checkVRSceneResultBehav: _VRSceneResult error ",e.projectIdx,e.sceneIndex,VRSceneResult);if(!e.VRSceneResult[e.projectIdx].editor_ver||"string"!=typeof e.VRSceneResult[e.projectIdx].editor_ver)return void console.error(" _checkVRSceneResultBehav: editor_ver error ",e.VRSceneResult[e.projectIdx]);let t=e.VRSceneResult[e.projectIdx].editor_ver.split("."),o=e.editorVersionControllObjs(t,e.projectIdx,e.sceneIndex);if(console.log("_checkVRSceneResultBehav: _scene_objs ",o),!Array.isArray(o))return;let n={},r={};for(let e=0,t=o.length;e<t;e++){let t=o[e];t.behav&&(n[t.obj_id]=t.behav),t.behav_reference&&delete t.behav_reference,t.obj_id&&(r[t.obj_id]=t)}for(let e in n){let t=n[e];for(let e=0,o=t.length;e<o;e++){let o=t[e];if(o.simple_behav,o.obj_id){let e=r[o.obj_id];e&&Array.isArray(e.behav_reference)?e.behav_reference.push({behav_name:o.simple_behav,target_id:o.obj_id}):e?e.behav_reference=[{behav_name:o.simple_behav,target_id:o.obj_id}]:console.error("_checkVRSceneResultBehav: cant get _behavObj ",o)}}}},this.calcSceneArea=function(){let e=this,t={},o=0,n=0,r=0,i=0;for(let l=0,a=e.makarObjects.length;l<a;l++){let a=e.makarObjects[l].object3D;if(a&&a.el&&a.el.id){let e=[];a.traverse((function(t){if(t.isMesh&&t.geometry){let l=new THREE.Box3;t.geometry.computeBoundingBox(),l.copy(t.geometry.boundingBox).applyMatrix4(t.matrixWorld),l.max.z==l.min.z&&(l.max.z+=.01),l.max.x>o&&(o=l.max.x),l.min.x<n&&(n=l.min.x),l.max.z>r&&(r=l.max.z),l.min.z<i&&(i=l.min.z);let a=new THREE.Box3Helper(l,5678547);e.push(a)}})),t[a.el.id]=e}}e.objList=t;let l=new THREE.Vector2(o,r),a=new THREE.Vector2(n,i);if(e.areaMax=l,e.areaMin=a,publishVRProjs&&Array.isArray(publishVRProjs.result)&&Number.isFinite(e.projectIdx))if("string"==typeof publishVRProjs.result[e.projectIdx].proj_descr&&1==publishVRProjs.result[e.projectIdx].proj_descr.includes("_walking")){console.log(" _calcSceneArea: walking project ",e.projectIdx,publishVRProjs.result[e.projectIdx]);let t=document.getElementById("__ground");if(t){let e=2*(o-n),l=2*(r-i),a=new THREE.Vector2((o+n)/2,(r+i)/2);t.setAttribute("geometry","width:"+e+"; height:"+l+";"),t.setAttribute("position",{x:a.x,y:.1,z:a.y}),console.log(" _calcSceneArea: gwdc ",e,l,a)}}else console.log(" _calcSceneArea: not walking project ",e.projectIdx,publishVRProjs.result[e.projectIdx]);else console.log(" _calcSceneArea: _publishVRProjs error ",e.projectIdx,publishVRProjs)},this.setupSceneBehav=function(){let e=this;for(let t=0,o=e.makarObjects.length;t<o;t++){let o=e.makarObjects[t].object3D;o?(o.behav,o.behav_reference):console.error(" _setupSceneBehav: 3d obj error",t,e.makarObjects[t])}for(let t=0,o=e.lookAtObjectList.length;t<o;t++){let o=e.lookAtObjectList[t],n=o.lookObjId,r=document.getElementById(n),i=o.lookBehav,l=i.obj_id,a=(i.reverse,document.getElementById(l));r&&r.object3D&&a&&a.object3D?e.addLookAtTimeLine(r,a,o):console.log("_setupSceneBehav: _lookAt error, obj not exist",r,a)}},this.addLookAtTimeLine=function(e,t,o){console.log(" _addLookAtTimeLine: ",o);let n=new THREE.Vector3;t.object3D.getWorldPosition(n);let r=gsap.timeline();this.lookAtTimelineDict[o.lookObjId]=r,r.to(e.object3D,{duration:1100,delay:0,ease:"none",repeat:-1,onUpdate:function(){t.object3D.getWorldPosition(n),e.object3D.lookAt(n),o.lookBehav&&0==o.lookBehav.reverse&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}})},this.setObjectBehavAll=function(e){let t=this;for(let o=0,n=e.behav.length;o<n;o++)if(""!=e.behav[o].group&&t.groupDict[e.behav[o].group]&&t.groupDict[e.behav[o].group].objs.push({behav:e.behav[o]}),"LookAt"==e.behav[o].simple_behav&&e.behav[o].obj_id){let n={lookBehav:e.behav[o],lookObjId:e.obj_id};t.lookAtObjectList.push(n)}},this.dealAllGroupHide=function(e){let t=this;if(!t.groupDict)return void console.log("_dealAllGroup: missing groupDict");let o=["ShowImage2D","ShowImage","ShowText2D","ShowText","ShowModel","PlayMusic","ShowVideo"];for(let n=0;n<e.behav.length;n++){let r=e.behav[n];if(""!=r.group&&t.groupDict[r.group]){let e=r.group;t.groupDict[e].objs.forEach(((e,n)=>{let i=e.behav.obj_id,l=t.getObjectTypeByObj_id(i);if("2d"==l.obj_type){let e=l.obj;if(r.obj_id!=i&&e.behav_reference)for(let t=0;t<e.behav_reference.length;t++)if(o.filter((o=>o==e.behav_reference[t].behav_name)).length>0){e.visible=!1;break}}else if("3d"==l.obj_type){let e=l.obj;if(e.object3D.behav_reference&&Array.isArray(e.object3D.behav_reference)&&r.obj_id!=i)for(let n=0;n<e.object3D.behav_reference.length;n++)if(o.filter((t=>t==e.object3D.behav_reference[n].behav_name)).length>0){t.hideGroupObjectEvent(e);break}}}))}}},this.speechTextObj=function(e){if(console.log(" _speechTextObj: _textObj: ",e),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){1==speechSynthesis.speaking&&(speechSynthesis.pause(),speechSynthesis.cancel());let t=e.speed,o=e.language,n=e.content,r=new SpeechSynthesisUtterance(n);r.rate=t**3*.1837+t**2*-.9948+2.3352*t-.5196,r.pitch=1;let i="en",l="en-US";switch(o){case 0:default:i="en",l="en-US";break;case 1:i="zh-TW",l="zh-TW";break;case 2:i="zh-CN",l="zh-CN";break;case 3:i="ja",l="ja-JP";break;case 4:i="ko",l="ko-KR"}let a=setInterval((function(){let e=!1,t=speechSynthesis.getVoices();t.length>0&&(clearInterval(a),window.Browser&&"safari"!=window.Browser.name&&t.forEach((t=>{t.lang==l&&(e=!0,r.voice=t)})),0==e&&(r.lang=i),speechSynthesis.speak(r))}),1)}},this.parseLogicXML=function(e,t){let o;if(vrController.logic&&"function"==typeof vrController.logic.stopLogic&&vrController.logic.stopLogic(),publishVRProjs.result[e].xml_urls&&publishVRProjs.result[e].xml_urls[t]){let n=publishVRProjs.result[e].xml_urls[t];console.log("VRFunc.js: _parseLogicXML: xmlURL = ",n);let r=new Logic;o=r.loadXMLtoDoc(n),vrController.logic=r}return o},this.dealVideoMuted=function(t){let o=document.getElementById("clickToPlayAudio");o.style.display="block",o.onclick=function(){e.UnMutedAndPlayAllVisibleVideo(),o.style.display="none",o.onclick=null,window.allowAudioClicked=!0}},this.UnMutedAndPlayAllVisibleVideo=function(e){let t;e&&"a-video"==e.localName&&(t=e);let o=document.getElementsByTagName("a-video");if(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: aVideos.length=",o.length),t)for(let e=0;e<o.length;e++){let n=o[e],r=o[e].mp4Video;if(n==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play();else{let o=!0;n.object3D.traverseAncestors((function(i){"Scene"!=i.type?0==i.visible&&(o=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",e,o,n.object3D.visible,n),1==o&&1==n.object3D.visible&&(r.muted=!0,r.autoplay=!0,r.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else{let e=!1;for(let t=0;t<o.length;t++){let n=o[t],r=o[t].mp4Video,i=!0;n.object3D.traverseAncestors((function(o){"Scene"!=o.type?0==o.visible&&(i=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",t,i,n.object3D.visible,n),1!=i||1!=n.object3D.visible||n.blockly||(0==e?(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",n.object3D),r.muted=!1,r.autoplay=!0,r.play(),e=!0):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",n.object3D),r.muted=!0,r.autoplay=!0,r.play())))}))}}},this.setViewMode=function(e=""){let t=this;return new Promise((function(o){let n=document.getElementById("aCamera"),r=document.getElementById("oCamera"),i=n.getObject3D("camera"),l=r.getObject3D("camera");if(n&&r&&i&&l)if("VR"==e){if(r.setAttribute("camera","active",!1),n.setAttribute("camera","active",!0),t.vrScene.camera=i,t.viewMode="VR",Number.isFinite(t.walkingStatus)&&-1!=t.walkingStatus){let e=document.getElementById("__ground");e&&e.setAttribute("visible",!0)}o("VR")}else if("model"==e)r.setAttribute("camera","active",!0),n.setAttribute("camera","active",!1),t.vrScene.camera=l,t.viewMode="model",t.setWalkingObjVisible(!1),o("model");else if(0==r.getAttribute("camera").active)r.setAttribute("camera","active",!0),n.setAttribute("camera","active",!1),t.vrScene.camera=l,t.viewMode="model",t.setWalkingObjVisible(!1),o("model");else if(0==n.getAttribute("camera").active){if(r.setAttribute("camera","active",!1),n.setAttribute("camera","active",!0),t.vrScene.camera=i,t.viewMode="VR",Number.isFinite(t.walkingStatus)&&-1!=t.walkingStatus){let e=document.getElementById("__ground");e&&e.setAttribute("visible",!0)}o("VR")}else o(-1);else o(-1)}))},this.getMakarObject=function(t){return 1!=t.makarObject?t.parent?e.getMakarObject(t.parent):0:t},this.getObjectTypeByObj_id=function(e){let t=null,o=null,n={obj_type:"",obj_index:null,obj:null};return e&&(this.makarObjects.forEach(((n,r)=>{n.id==e&&(t=n,o=r)})),null!=t&&null!=o&&(null!=t&&null!=o?(console.log("_getObjectTypeByObj_id: 3d: ",o,t),n.obj_type="3d",n.obj_index=o,n.obj=t):console.log("_getObjectTypeByObj_id: fucking logic trouble.",null,null))),n},this.cameraMoveToPoint=function(t){let o=document.getElementById("pointerSphere"),n=document.getElementById("currentPosSphere");if(o&&n)return new Promise((function(r,i){let l=t.position,a=Math.round(1e3*l.x)/1e3,s=Math.round(1e3*l.y)/1e3,c=Math.round(1e3*l.z)/1e3;o.setAttribute("visible",!1),n.setAttribute("visible",!0),n.object3D.position.set(a,s,c);let u=e.vrScene.camera.el.object3D.position.x,d=e.vrScene.camera.el.object3D.position.y,m=e.vrScene.camera.el.object3D.position.z,b=new THREE.Vector3(a-u,s-d,c-m),p=new THREE.Vector3(a-u,0,c-m).normalize(),h=.2*Math.round(b.length());h=h>1?1:h;let g=new THREE.Raycaster(e.vrScene.camera.el.object3D.position,p);if(1==t.dealBoundary){let t=g.intersectObjects(boundaries,!0);if(t.length>0&&(console.log("_cameraMoveToPoint: initial position hit boundary, distance ",t[0].distance),t[0].distance<1))return console.log("_cameraMoveToPoint: initial position hit boundary, dont run  "),n.object3D.position.copy(e.vrScene.camera.el.object3D.position),void r(1)}let _=gsap.timeline();_.to(gsapEmpty,{duration:h,delay:0,onStart:function(){},onUpdate:function(){let o=new THREE.Vector3(u+b.x*this.ratio,d,m+b.z*this.ratio);if(1==t.dealBoundary){let t=g.intersectObjects(boundaries,!0);if(t.length>0&&t[0].distance<o.distanceTo(e.vrScene.camera.el.object3D.position))return n.object3D.position.copy(o),_.pause(),_.kill(),_=null,void r(1)}e.vrScene.camera.el.object3D.position.set(o.x,o.y,o.z)},onComplete:function(){r(h)}})}))},this.setWalkingStatus=function(e){let t=this;if(Number.isFinite(t.walkingStatus)){console.log(" _setWalkingStatus: set from [",t.walkingStatus,"]"," to [",e,"]");let o=document.getElementById("__ground"),n=document.getElementById("pointerSphere"),r=document.getElementById("currentPosSphere");0!=t.walkingStatus&&-1!=t.walkingStatus||(t.walkingStatus=e),-1==t.walkingStatus&&n&&r&&o&&t.setWalkingObjVisible(!1),0==t.walkingStatus&&o&&o.setAttribute("visible",!0)}else console.log(" _setWalkingStatus: status not exist ",t.walkingStatus)},this.setWalkingObjVisible=function(e){let t=document.getElementById("__ground"),o=document.getElementById("pointerSphere"),n=document.getElementById("currentPosSphere");t&&o&&n&&(1==e?(t.setAttribute("visible",!0),o.setAttribute("visible",!0),n.setAttribute("visible",!0)):(t.setAttribute("visible",!1),o.setAttribute("visible",!1),n.setAttribute("visible",!1)))},e.vrScene.canvas.addEventListener("touchstart",c,!1),e.vrScene.canvas.addEventListener("mousedown",c,!1),e.vrScene.canvas.addEventListener("touchmove",u,!1),e.vrScene.canvas.addEventListener("mousemove",u,!1),e.vrScene.canvas.addEventListener("touchend",d,!1),e.vrScene.canvas.addEventListener("mouseup",d,!1);let n=new THREE.Vector2;var r=new THREE.Vector2,a=new THREE.Raycaster;function s(t){let o=e.GLRenderer.domElement.getBoundingClientRect();switch(t.type){case"mouseup":case"mousemove":case"mousedown":r.x=(t.clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,r.y=-(t.clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;case"touchend":case"touchstart":case"touchmove":r.x=(t.changedTouches[0].clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,r.y=-(t.changedTouches[0].clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",t.type," not mouseup/touchend, return ")}return r.clone()}function c(t){n=s(t),e.touchMouseState=0}function u(t){let o=s(t);0==e.touchMouseState?o.sub(n).length()>.01&&(e.touchMouseState=1):e.touchMouseState=1;let r=document.getElementById("__ground"),i=document.getElementById("pointerSphere");if(i&&r)if(0==e.touchMouseState||1==e.touchMouseState){if(!e.triggerEnable)return;if("VR"==e.viewMode&&Number.isInteger(e.walkingStatus)&&e.walkingStatus>=0){if(Array.isArray(e.currentSceneMakarObjects)&&e.currentSceneMakarObjects.length>0);else{for(let t=0;t<e.makarObjects.length;t++){let o=e.makarObjects[t];if(o.object3D&&"clickable"==o.className){let t=!0;o.object3D.traverseAncestors((function(e){"Scene"!=e.type&&0==e.visible&&(t=!1)})),t&&e.currentSceneMakarObjects.push(o.object3D)}}e.currentSceneMakarObjects.push(r.object3D)}let t=e.currentSceneMakarObjects,n=!1;a.setFromCamera(o,e.vrScene.camera);let l=a.intersectObjects(t,!0);l.length>0&&(1==n||l[0].object&&l[0].object.el&&l[0].object.el!=r?i.setAttribute("visible",!1):(i.setAttribute("visible",!0),i.object3D.position.copy(l[0].point)))}}else i.setAttribute("visible",!1)}function d(t){if(!e.triggerEnable)return;if(1==e.touchMouseState){if("touchend"==t.type){let e=document.getElementById("pointerSphere");e&&e.setAttribute("visible",!1)}return}e.touchMouseState=2,t.preventDefault();let o=e.GLRenderer.domElement.getBoundingClientRect();switch(t.type){case"mouseup":r.x=(t.clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,r.y=-(t.clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;case"touchend":r.x=(t.changedTouches[0].clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,r.y=-(t.changedTouches[0].clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",t.type," not mouseup/touchend, return ")}let n={},i=[];for(let t=0;t<e.makarObjects.length;t++){let o=e.makarObjects[t];if(o.object3D&&"clickable"==o.className){let e=!0;o.object3D.traverseAncestors((function(t){"Scene"!=t.type&&0==t.visible&&(e=!1)})),e&&i.push(o.object3D)}}a.setFromCamera(r,e.vrScene.camera);let l=a.intersectObjects(i,!0),s=!1,c=!1;if(0!=l.length){console.log("VRFunc.js: _setupFunction: 1 endEvent, intersects=",l);let t=e.getMakarObject(l[0].object),o=t.el;if(o&&o.onclickBlock){s=!0;for(let e=0;e<o.onclickBlock.length;e++)o.onclickBlockState[e]&&(o.onclickBlockState[e]=!1,vrController.logic&&(vrController.logic.parseBlock(o.onclickBlock[e],(function(){o.onclickBlockState[e]=!0})),n["3d_logic"]=o.onclickBlock[e]))}if(t.traverse((function(e){e.isMesh})),t.behav){e.dealAllGroupHide(t);let o=!1;for(let e=0;e<t.behav.length;e++)"CloseAndResetChildren"==t.behav[e].simple_behav&&(o=!0);for(let r=0;r<t.behav.length;r++)"CloseAndResetChildren"!=t.behav[r].simple_behav&&("ShowQuiz"==t.behav[r].simple_behav?0==t.behav[r].played?(t.behav[r].played=!0,e.triggerEvent(t.behav[r],o,t)):console.log("VRFunc.js: _setupFunction: endEvent:  Quiz had been played.",t.behav[r].played):(console.log("behav=",t.behav[r]),e.triggerEvent(t.behav[r],o,e.GLRenderer,null,t))),"FingerGesture"!=t.behav[r].simple_behav&&"LookAt"!=t.behav[r].simple_behav&&(c=!0,n["3d_behav"]=t.behav),"PushButton"==t.behav[r].simple_behav&&(n["3d_quizButton"]=t)}}if(console.log(" event logic check: ",s,c),0==s&&0==c&&Number.isInteger(e.walkingStatus)&&"VR"==e.viewMode)if(0==e.walkingStatus){let t=document.getElementById("__ground"),o=a.intersectObjects([t.object3D],!0);if(o.length>0){let t=o[0].object;console.log(" selectedObject ",t),t.el?"__ground"==t.el.getAttribute("id")?(console.log(" _endEvent: object is ground "),e.walkingStatus=1,e.cameraMoveToPoint({position:o[0].point,dealBoundary:!1}).then((function(){e.walkingStatus=0})),n.ground_move=t):console.log(" _endEvent: object is not ground "):console.log(" _endEvent: object without el ")}}else-1==e.walkingStatus?console.log(" _endEvent: _walkingStatus =-1"):1==e.walkingStatus&&console.log(" _endEvent: _walkingStatus = 1");0==Object.keys(n).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",n)}},e.prototype.triggerEvent=function(e,t,o,n,r){if(!this.FUNCTION_ENABLED)return;var i=this;let l,a;switch(e.simple_behav){case"PhoneCall":console.log("VRFunc.js: triggerEvent: PhoneCall: event=",e);let o=window.document.getElementById("phoneCall");o.href="tel:"+e.phone,o.click();break;case"SendEmail":console.log("VRFunc.js: triggerEvent: SendEmail: event=",e);let n=window.document.getElementById("sendEmail");n.href="mailto:"+e.mail_to,n.click();break;case"OpenWebPage":console.log("VRFunc.js: triggerEvent: OpenWebPage: event=",e,e.url);let c=window.document.getElementById("openWebBrowser");c.href=e.url,c.click(),console.log("VRFunc.js: triggerEvent: OpenWebPage: webTag=",c);break;case"SceneChange":console.log("VRFunc.js: triggerEvent: SceneChange: event=",e);let u=e.scene_id,d=i.projectIdx;for(let e=0;e<VRSceneResult[d].scenes.length;e++)VRSceneResult[d].scenes[e].scene_id==u&&(i.triggerEnable=!1,loadPage.style.display="block",null!=typeof i.loadingTickOn&&(i.loadingTickOn=!0),i.loadScene(d,e));break;case"ShowImage":console.log("VRFunc.js: triggerEvent: ShowImage: event=",e),l=e.obj_id,a=document.getElementById(l),i.showObjectEvent(a,t);break;case"ShowText":console.log("VRFunc.js: triggerEvent: ShowText: event=",e),l=e.obj_id,a=document.getElementById(l),i.showObjectEvent(a,t);break;case"ShowModel":console.log("VRFunc.js: triggerEvent: ShowModel: event=",e),l=e.obj_id,a=document.getElementById(l),i.showObjectEvent(a,t);break;case"PlayMusic":if(console.log(),console.log("checkAudioTypeAttr obj"),l=e.obj_id,a=document.getElementById(l),!a){console.log("VRFunc.js: _PlayMusic: target not exist",a);break}console.log("VRFunc.js: triggerEvent: PlayMusic: event=",e),a.getAttribute("visible")?(a.setAttribute("visible",!1),a.setAttribute("class","unclickable"),a.components.sound.stopSound()):(a.setAttribute("visible",!0),a.object3D.behav&&a.setAttribute("class","clickable"),a.components.sound.playSound());break;case"ShowVideo":console.log("VRFunc.js: triggerEvent: ShowVideo: event=",e),l=e.obj_id,a=document.getElementById(l),i.showObjectEvent(a,t);break;case"PlayAnimation":if(console.log("VRFunc.js: triggerEvent: _PlayAnimation: event=",e),l=e.obj_id,a=document.getElementById(l),!a){console.log("VRFunc.js: _PlayAnimation: target not exist",a);break}var s;for(let t=1;t<a.object3D.children[0].animationSlices.length;t++)a.object3D.children[0].animationSlices[t].uid==e.uid&&(s=a.object3D.children[0].animationSlices[t].animationName);a.setAttribute("animation-mixer","clip: "+s),e.loop?(a.object3D.children[0].animationSlices[0].loop=e.uid,a.object3D.children[0].animationSlices[0].uid=e.uid,a.object3D.children[0].animationSlices[0].changed=!0,a.object3D.children[0].animationSlices[0].reset=!0):(a.object3D.children[0].animationSlices[0].uid=e.uid,a.object3D.children[0].animationSlices[0].changed=!0,a.object3D.children[0].animationSlices[0].reset=e.reset);break;case"ReadText":if(console.log("VRFunc.js: _ReadText: ",e),e.obj_id){let t=e.obj_id,o=i.projectIdx;VRSceneResult&&VRSceneResult[o]&&VRSceneResult[o].scenes[i.sceneIndex]&&Array.isArray(VRSceneResult[o].scenes[i.sceneIndex].objs)&&VRSceneResult[o].scenes[i.sceneIndex].objs.forEach((e=>{e.obj_id==t&&i.speechTextObj(e)}))}break;case"ShowQuiz":document.getElementById("startQuiz").style.display="block";break;case"PushButton":quiz.pushButton(r.el);break;default:console.log("VRFunc.js: triggerEvent: default: event=",e)}},e.prototype.getSnapShot=function(){let e=this;return new Promise((function(t){if(e.FUNCTION_ENABLED)return e&&e.GLRenderer&&e.vrScene&&e.GLRenderer.domElement&&e.vrScene.object3D&&e.GLRenderer.domElement.clientWidth&&e.GLRenderer.domElement.clientHeight&&e.GLRenderer.domElement.width&&e.GLRenderer.domElement.height?(e.GLRenderer.clearDepth(),e.GLRenderer.render(e.vrScene.object3D,e.vrScene.camera),void t(e.GLRenderer.domElement.toDataURL("image/png",1))):(console.log(" _VRController: _getSnapShot: something error ",e),void t(-1));t(-1)}))};var n=function(){if("undefined"!=typeof checkHost){if("yet"==checkHost)setTimeout(n,50);else if("correct"==checkHost)console.log("VRFunc.js: _checkHost_tick correct");else if("fail"==checkHost){for(;document.body.firstChild;)document.body.removeChild(document.body.firstChild);var e=document.createElement("div");e.innerHTML="<br>The host of webVR seems unauthorized,<br> please contact MIFLY ",e.style.fontSize="18px",e.style.margin="5px",e.style.fontWeight="700",document.body.append(e)}}else console.log("VRFunc.js: checkHost = undefined, something ERROR.")};n(),Module.checkMifly(),window.showVRProjList=function(){console.log("VRFunc.js: version: 2022-07-28 1650 ");let e,t=window.serverUrl;window.top,window.self,e=parent.selectedProject.user_id,console.log("VRFunc.js: _showVRProjList: : makarID=",e),getVRSceneByUserID(t,e,(function(t){if(console.log("VRFunc.js: _showVRProjList: _getVRSceneByUserID: VRSceneResult=",VRSceneResult,publishVRProjs,userPublishProjs),"string"==typeof t)str=t,document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="block",document.getElementById("pUserInfo").textContent=str,leaveIframe.onclick=function(){event.preventDefault(),parent.aUI});else{document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="none");for(let t=0;t<publishVRProjs.result.length;t++)if(publishVRProjs.result[t].proj_id==parent.selectedProject.proj_id)if(console.log("VRFunc.js: _showVRProjList: _getVRSceneByUserID: i=",t,publishVRProjs.result[t],VRSceneResult[t]),0==window.allowedMakarIDUseWeb){for(let n=0;n<userPublishProjs.proj_list.length;n++)if(publishVRProjs.result[t].proj_name.toLowerCase()==userPublishProjs.proj_list[n].proj_name.toLowerCase()){1==userPublishProjs.proj_list[n].web_ar?(console.log("VRFunc.js: _showVRProjList: _getVRSceneByUserID( allow by license ): i=",t),activeVRScenes(t)):(o="this ID <br> ["+e+"] <br> is free user, not allow to use webVR",document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="block",document.getElementById("pUserInfo").textContent=o,leaveIframe.onclick=function(e){e.preventDefault(),parent.aUI}));break}}else console.log("VRFunc.js: _showVRProjList: _getVRSceneByUserID( allow by user ): i=",t),activeVRScenes(t)}var o}))},window.activeVRScenes=function(t,o=0){let r,i=document.getElementsByTagName("video");if(i.length>0)for(let e=0;e<i.length;e++)i[e].pause(),i[e].removeAttribute("src"),i[e].load();document.getElementById("vrDiv")&&document.getElementById("vrDiv").remove();let l=document.createElement("a-scene");l.setAttribute("id","vrscene"),l.setAttribute("crossorigin","anonymous"),l.setAttribute("embedded",""),l.setAttribute("vr-mode-ui","enabled: false"),l.setAttribute("debug","true"),r=document.createElement("div"),r.style.position="relative",r.setAttribute("id","vrDiv"),r.setAttribute("crossorigin","anonymous"),r.style.width=document.documentElement.clientWidth+"px",r.style.height=Math.round(document.documentElement.clientHeight-0)+"px",r.style.top="0px",window.onresize=function(){r.style.width=document.documentElement.clientWidth+"px",r.style.height=Math.round(document.documentElement.clientHeight-0)+"px"},document.body.appendChild(r),r.appendChild(l),l.hasLoaded?s():l.addEventListener("loaded",s),l.addEventListener("enter-vr",(function(){})),l.addEventListener("renderstart",(function(){}));let a=new e;if(a.VRSceneResult=VRSceneResult,a.publishVRProjs=publishVRProjs,window.vrController=a,a.projectIdx=t,"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();a.voices=e}function s(){l.children[2].attributes,l.setAttribute("shadow","type: pcfsoft");let e=new THREE.Vector2;l.renderer.getSize(e),l.renderer.sortObjects=!0,console.log(" **************** vrScene ",l.object3D),a.vrScene=l,a.GLRenderer=l.renderer,a.setupFunction(),setTimeout((function(){i.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 0; thetaStart: 0;"),i.setAttribute("cursor","fuse: true; fuseTimeout: 5"),i.setAttribute("animation__mouseenter","property: geometry.thetaLength; delay: 5; startEvents: mouseenter; dur: 5; from: 0.5; to: 360"),i.setAttribute("animation__mouseleave","property: geometry.thetaLength; startEvents: mouseleave; dur: 100; from: 360; to: 0.5"),a.cursorEntity=i}),1);let i=document.createElement("a-entity");i.setAttribute("id","cursor_main"),i.setAttribute("raycaster","objects: .clickable"),i.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 0; thetaStart: 0;"),i.setAttribute("position","0 0 -0.1"),i.setAttribute("material","color: red; shader: flat; ");let s=document.createElement("a-entity");s.setAttribute("id","cursor_default"),s.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 360; thetaStart: 0;"),s.setAttribute("position","0 0 -0.1001"),s.setAttribute("material","color: #2ADD2A; shader: flat; ");let u=document.createElement("a-entity");u.setAttribute("camera",{active:!0,fov:80}),u.setAttribute("look-controls",""),u.setAttribute("wasd-controls",""),u.setAttribute("id","aCamera"),u.setAttribute("position",{x:0,y:0,z:0}),u.setAttribute("camera","fov",60),u.setAttribute("camera","near",.3),u.setAttribute("camera","far",2e4),console.log("VRFunc.js: aCamera=",u);let d=document.createElement("a-entity");d.setAttribute("id","oCamera"),d.setAttribute("camera",{active:!0,fov:80}),d.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\t\tmaxPolarAngle: 180; \n\t\t\t\tminDistance: 0.1; \n\t\t\t\tmaxDistance: 1000; \n\t\t\t\tinitialPosition: -5 5 13;");let m=document.createElement("a-entity");m.setAttribute("id","camera_cursor"),m.setAttribute("position",{x:0,y:1.7,z:0}),m.setAttribute("rotation","0 0 0"),m.appendChild(u),m.appendChild(d),l.appendChild(m);let b=document.createElement("a-light");if(b.setAttribute("id","ambientLight"),b.setAttribute("type","ambient"),b.setAttribute("color","#808080"),b.setAttribute("ground-color","#fff"),b.setAttribute("intensity",1),l.appendChild(b),1==publishVRProjs.result[t].proj_descr.includes("_walking")){let e=a;e.walkingStatus=-1;let t=document.createElement("a-entity");t.setAttribute("id","pointerSphere"),t.setAttribute("geometry","primitive: ring; radiusInner: 0.35; radiusOuter: 0.5"),t.setAttribute("material","shader: flat; color: white; side: double; opacity: 0.3; "),t.setAttribute("position",{x:0,y:0,z:0}),t.setAttribute("rotation",{x:90,y:0,z:0}),t.setAttribute("visible",!1),e.vrScene.appendChild(t);let o=document.createElement("a-entity");o.setAttribute("id","currentPosSphere"),o.setAttribute("geometry","primitive: ring; radiusInner: 0.35; radiusOuter: 0.5"),o.setAttribute("material","shader: flat; color: #0AC4B6; side: double; opacity: 0.3; "),o.setAttribute("position",{x:0,y:0,z:0}),o.setAttribute("rotation",{x:90,y:0,z:0}),o.setAttribute("visible",!1),e.vrScene.appendChild(o);let n=document.createElement("a-entity");n.setAttribute("id","__ground"),n.setAttribute("geometry","primitive: plane; height: 1000; width: 1000; "),n.setAttribute("material","shader: flat; color: blue; side: back; opacity: 0.05; visible: true "),n.setAttribute("visible",!1),n.setAttribute("position",{x:0,y:.1,z:0}),n.setAttribute("rotation",{x:90,y:0,z:0}),n.addEventListener("loaded",(function(){n.object3D.renderOrder=9999})),e.vrScene.appendChild(n)}let p=function(e){r=document.getElementById("vrDiv"),console.log("VRFunc.js: activeVRScenes: initvrscene: vrScene.camera active = ",l.camera.aspect,r.clientWidth,r.clientHeight),l.camera.aspect=r.clientWidth/r.clientHeight,l.camera.fov=60,l.camera.updateProjectionMatrix(),a.triggerEnable=!1,a.loadScene(t,o),a.userStartTime=(new Date).getTime(),n(),Module.checkMifly(),l.removeEventListener("camera-set-active",p)};l.addEventListener("camera-set-active",p);let h=new THREE.WebGLRenderTarget(1024,1024);a.skyRenderTarget=h,a.needsRenderTarget=!1,a.onlySkyScene=new THREE.Scene,c()}var c=function(){a.GLRenderer.clearDepth(),a.needsRenderTarget&&(a.GLRenderer.setRenderTarget(a.skyRenderTarget),a.GLRenderer.render(a.onlySkyScene,a.vrScene.camera),a.GLRenderer.setRenderTarget(null)),a.GLRenderer.render(a.vrScene.object3D,a.vrScene.camera),requestAnimationFrame(c)}}}(),window.addEventListener("keyup",(function(e){13===e.keyCode&&e.preventDefault()}))):setTimeout((function(){r(n)}),500)};"undefined"!=typeof window&&r(n),console.log("VRFunc done, window innerWH",window.innerWidth,window.innerHeight);let i=window.languageType="tw";if(parent){let e=parent.location.pathname.indexOf("/",0),t=parent.location.pathname.indexOf("/",e+1),o=parent.location.pathname.substring(1,t);"tw"!=o&&"en"!=o||(i=window.languageType=o)}let l=window.worldContent={userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"Please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"Comfire"}}}()})();