(()=>{"use strict";const e={data:{list:[{res_id:"Cone",res_name:"Cone",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cone/Cone.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cone/Cone.png",default_shader_name:"",size:"30096",create_date:"",show:!0},{res_id:"Cylinder",res_name:"Cylinder",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cylinder/Cylinder.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cylinder/Cylinder.png",default_shader_name:"",size:"28416",create_date:"",show:!0},{res_id:"Circle",res_name:"Circle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Circle/Circle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Circle/Circle.png",default_shader_name:"",size:"41392",create_date:"",show:!0},{res_id:"Rectangle",res_name:"Rectangle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Rectangle/Rectangle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Rectangle/Rectangle.png",default_shader_name:"",size:"23584",create_date:"",show:!0},{res_id:"Torus",res_name:"Torus",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Torus/Torus.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Torus/Torus.png",default_shader_name:"",size:"34192",create_date:"",show:!0},{res_id:"Square",res_name:"Square",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Square/Square.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Square/Square.png",default_shader_name:"",size:"23568",create_date:"",show:!0},{res_id:"Triangle",res_name:"Triangle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Triangle/Triangle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Triangle/Triangle.png",default_shader_name:"",size:"22816",create_date:"",show:!0},{res_name:"Cube",sub_type:"glb",show:!1,res_id:"Cube",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Cube.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Cube.png",create_date:"",main_type:"model",size:"2772 bytes"},{res_name:"Capsule",sub_type:"glb",show:!1,res_id:"Capsule",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Capsule.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Capsule.png",create_date:"",main_type:"model",size:"37380 bytes"},{res_name:"Sphere",sub_type:"glb",show:!1,res_id:"Sphere",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Sphere.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Sphere.png",create_date:"",main_type:"model",size:"35016 bytes"},{res_id:"img_fb_1",sub_type:"png",show:!0,res_name:"FB icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_fb_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_fb_1.png",create_date:"",main_type:"image",size:"133759 bytes"},{res_id:"img_ig_1",sub_type:"png",show:!0,res_name:"IG icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_ig_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_ig_1.png",create_date:"",main_type:"image",size:"194879 bytes"},{res_id:"img_line_1",sub_type:"png",show:!0,res_name:"Line icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_line_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_line_1.png",create_date:"",main_type:"image",size:"163576 bytes"},{res_id:"img_web_1",sub_type:"png",show:!0,res_name:"Web icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_1.png",create_date:"",main_type:"image",size:"112540 bytes"},{res_id:"img_map_1",sub_type:"png",show:!0,res_name:"GPS icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_1.png",create_date:"",main_type:"image",size:"99764 bytes"},{res_id:"img_phone_1",sub_type:"png",show:!0,res_name:"Phone icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_1.png",create_date:"",main_type:"image",size:"75327 bytes"},{res_id:"img_mail_1",sub_type:"png",show:!0,res_name:"Mail icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_1.png",create_date:"",main_type:"image",size:"113394 bytes"},{res_id:"img_home_1",sub_type:"png",show:!0,res_name:"Home icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_1.png",create_date:"",main_type:"image",size:"103003 bytes"},{res_id:"img_arrow_1",sub_type:"png",show:!0,res_name:"Arrow icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_1.png",create_date:"",main_type:"image",size:"80170 bytes"},{res_id:"img_button_back_1",sub_type:"png",show:!0,res_name:"Back button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_1.png",create_date:"",main_type:"image",size:"91617 bytes"},{res_id:"img_button_next_1",sub_type:"png",show:!0,res_name:"Next button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_1.png",create_date:"",main_type:"image",size:"89832 bytes"},{res_id:"img_button_play_1",sub_type:"png",show:!0,res_name:"Play button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_1.png",create_date:"",main_type:"image",size:"89261 bytes"},{res_id:"img_button_start_1",sub_type:"png",show:!0,res_name:"Start button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_1.png",create_date:"",main_type:"image",size:"92002 bytes"},{res_id:"img_dialog_1",sub_type:"png",show:!0,res_name:"Msg bubble_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_1.png",create_date:"",main_type:"image",size:"147377 bytes"},{res_id:"img_web_2",sub_type:"png",show:!0,res_name:"Web icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_2.png",create_date:"",main_type:"image",size:"17544 bytes"},{res_id:"img_map_2",sub_type:"png",show:!0,res_name:"GPS icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_2.png",create_date:"",main_type:"image",size:"17371 bytes"},{res_id:"img_phone_2",sub_type:"png",show:!0,res_name:"Phone icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_2.png",create_date:"",main_type:"image",size:"11311 bytes"},{res_id:"img_mail_2",sub_type:"png",show:!0,res_name:"Mail icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_2.png",create_date:"",main_type:"image",size:"10518 bytes"},{res_id:"img_home_2",sub_type:"png",show:!0,res_name:"Home icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_2.png",create_date:"",main_type:"image",size:"13172 bytes"},{res_id:"img_arrow_2",sub_type:"png",show:!0,res_name:"Arrow icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_2.png",create_date:"",main_type:"image",size:"8860 bytes"},{res_id:"img_button_back_2",sub_type:"png",show:!0,res_name:"Back button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_2.png",create_date:"",main_type:"image",size:"7059 bytes"},{res_id:"img_button_next_2",sub_type:"png",show:!0,res_name:"Next button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_2.png",create_date:"",main_type:"image",size:"5536 bytes"},{res_id:"img_button_play_2",sub_type:"png",show:!0,res_name:"Play button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_2.png",create_date:"",main_type:"image",size:"5919 bytes"},{res_id:"img_button_start_2",sub_type:"png",show:!0,res_name:"Start button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_2.png",create_date:"",main_type:"image",size:"7060 bytes"},{res_id:"img_dialog_2",sub_type:"png",show:!0,res_name:"Msg bubble_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_2.png",create_date:"",main_type:"image",size:"3788 bytes"},{res_name:"Text",sub_type:"txt",show:!1,res_id:"Text",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Text.png",create_date:"",main_type:"text",size:"2772 bytes"},{res_name:"Light",sub_type:"light",show:!1,res_id:"Light",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Light.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Light.png",create_date:"",main_type:"light",size:"0 bytes"},{res_name:"Curve",sub_type:"curve",show:!1,res_id:"Curve",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Light.glb",default_shader_name:"",snapshot_url:"",create_date:"",main_type:"curve",size:"0 bytes"},{res_name:"ch_Bojue",sub_type:"glb",show:!1,res_id:"ch_Bojue",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Bojue.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Bojue.png",create_date:"",main_type:"model",size:"360240 bytes"},{res_name:"ch_Fei",sub_type:"glb",show:!1,res_id:"ch_Fei",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Fei.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Fei.png",create_date:"",main_type:"model",size:"348876 bytes"},{res_name:"ch_Lina",sub_type:"glb",show:!1,res_id:"ch_Lina",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Lina.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Lina.png",create_date:"",main_type:"model",size:"384992 bytes"},{res_name:"ch_Poyuan",sub_type:"glb",show:!1,res_id:"ch_Poyuan",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Poyuan.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Poyuan.png",create_date:"",main_type:"model",size:"369416 bytes"},{res_name:"ch_Roger",sub_type:"glb",show:!1,res_id:"ch_Roger",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Roger.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Roger.png",create_date:"",main_type:"model",size:"371072 bytes"},{res_name:"FB_icon",sub_type:"png",show:!1,res_id:"FB_icon",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/FB_icon.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/FB_icon.png",create_date:"",main_type:"image",size:"4235 bytes"},{res_name:"Line_icon",sub_type:"png",show:!1,res_id:"Line_icon",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/Line_icon.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Line_icon.png",create_date:"",main_type:"image",size:"8855 bytes"},{res_name:"MakAR_Room",sub_type:"png",show:!1,res_id:"MakAR_Room",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Room.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Room.png",create_date:"",main_type:"image",size:"22787 bytes"},{res_name:"MakAR_Call",sub_type:"png",show:!1,res_id:"MakAR_Call",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Call.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Call.png",create_date:"",main_type:"image",size:"22432 bytes"},{res_name:"MakAR_Mail",sub_type:"png",show:!1,res_id:"MakAR_Mail",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Mail.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Mail.png",create_date:"",main_type:"image",size:"21586 bytes"},{res_name:"SphericalImage",sub_type:"png",show:!1,res_id:"SphericalImage",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/SphericalImage.png",create_date:"",main_type:"spherical_image",size:"4258816 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_name:"InputField",sub_type:"inputfield",show:!1,res_id:"InputField",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/inputField/inputfield.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/inputField/inputfield.png",create_date:"",main_type:"inputfield",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_name:"Button",sub_type:"button",show:!1,res_id:"Button",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",create_date:"",main_type:"button",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Background",res_name:"PointCard_Background",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Point_Before",res_name:"PointCard_Point_Before",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_Before.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_Before.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Point_After",res_name:"PointCard_Point_After",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_After.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_After.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"camera",res_name:"Camera",main_type:"camera",sub_type:"camera",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/Camera/Camera.glb",default_shader_name:"",snapshot_url:"",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"ScratchCard_Background",res_name:"ScratchCard_Background",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"ScratchCard_Default",res_name:"ScratchCard_Default",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"AcratchCard_Default",res_name:"AcratchCard_Default",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/AcratchCard_Default.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/AcratchCard_Default.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"Curve_Cell",res_name:"Cell",main_type:"curve_cell",sub_type:"curve_cell",show:!1,res_url:"",default_shader_name:"",snapshot_url:"",create_date:"",size:"0 bytes"}]}};function t(e,t){let a=new XMLHttpRequest;a.open("HEAD",e,!0),a.onload=function(e){console.log(" VRFunc.js: _UrlExists: httpRequest status= ",a.status),t("200"==a.status)},a.onerror=function(e){console.log("onerror e=",e),t("200"==a.status)},a.onabort=function(e){console.log("onabort e=",e),t("200"==a.status)},a.send()}function a(e){return"object"==typeof e&&"function"==typeof e.then}function r(){if("undefined"!=typeof checkHost){if("yet"==checkHost)setTimeout(r,50);else if("correct"==checkHost)console.log("VRFunc.js: _checkHost_tick correct");else if("fail"==checkHost){for(;document.body.firstChild;)document.body.removeChild(document.body.firstChild);var e=document.createElement("div");e.innerHTML="<br>The host of webVR seems unauthorized,<br> please contact MIFLY ",e.style.fontSize="18px",e.style.margin="5px",e.style.fontWeight="700",document.body.append(e)}}else console.log("VRFunc.js: checkHost = undefined, something ERROR.")}function o(e){return e.replace(/\\u[\dA-F]{4}/gi,(function(e){return String.fromCharCode(parseInt(e.replace(/\\u/g,""),16))}))}function n(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image",e.sub_type="png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image",e.sub_type="png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image",e.sub_type="png";break;default:console.log("vrUtility.js: _checkDefaultImage, obj=",e)}}function s(t){let a=!1;if(e&&e.data&&Array.isArray(e.data.list)&&e.data.list.forEach((e=>{e.res_id==t.res_id&&(t.main_type=e.main_type,t.sub_type=e.sub_type,t.res_url=e.res_url,a=!0)})),console.log("  .getRes ",a,t),!a)switch(t.res_id){case"quiz":t.main_type="empty",t.sub_type="quiz";break;case"Curve":t.main_type="curve";break;default:if(t.res_gltf_resource)break;t.generalAttr?t.generalAttr.obj_type||(t.generalAttr.obj_type="3d"):t.generalAttr={obj_type:"3d"},t.transformAttr?t.transformAttr.transform||(t.transformAttr.transform=["0,0,0","0,0,0,1","1,1,1"]):t.transformAttr={transform:["0,0,0","0,0,0,1","1,1,1"]},t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb"}}const i=new class{constructor(){this.url="https://test1.makar.app/Makar/","object"==typeof parent&&parent.serverUrl&&(this.url=parent.serverUrl),this.webVersion="3.5.0.0",this.url_v340="https://ssl-api-makar-v3-apps.miflyservice.com/Makar/",this.webVersion_v340="3.0.0"}sendPost(e,t){let a=this;return new Promise((function(r,o){let n={ver:a.webVersion,cid:5,data:t};fetch(e,{body:JSON.stringify(n),headers:{"content-type":"application/json"},method:"POST",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((e=>e.json())).then((function(e){setTimeout((function(){r(e)}),1)}))}))}async getTest(e,t=[]){let a=this.url+"get_test",r={user_id:e,wanted_info_keys:t},o=this.sendPost(a,r);return await o}async getProjectInfoList(e,t){if(!Array.isArray(e))return console.warn("_getProjectInfoList_: error",e),!1;let a=this.url+"WebXR/GetProjects",r={login_user_id:t,project_ids:e},o=this.sendPost(a,r);return await o}async getProjectInfoList_v340(e){if(!Array.isArray(e))return console.warn("_getProjectInfoList_v340_: error",e),!1;let t=this.url+"get_vr_projs_by_proj_id",a={proj_id_list:e},r=this.sendPost(t,a);return await r}async getUserPublishProjects_v340(e){let t=this.url+"get_usr_publish_projs",a=e,r=this.sendPost(t,a);return await r}async getProjectSceneList(e){if(!Array.isArray(e))return console.warn("_getProjectSceneList_: error",e),!1;let t=this.url+"WebXR/GetProjectSceneList",a={project_ids:e},r=this.sendPost(t,a);return await r}async getProjectSceneList_v340(e){if(!Array.isArray(e))return console.warn("_getProjectSceneList_: error",e),!1;let t=this.url+"get_vr_proj_scene",a={proj_id:e[0]},r=this.sendPost(t,a);return await r}async getTargetList(e){if(!Array.isArray(e))return console.warn("_getTargetList_: error",e),!1;let t=this.url+"WebXR/GetTargetList",a={target_ids:e},r=this.sendPost(t,a);return await r}async getUserInfo(e){if(!e||"string"!=typeof e)return console.warn("_getUserInfo_: error",e),!1;let t=this.url+"WebXR/GetUserInfo",a={user_id:e},r=this.sendPost(t,a);return await r}async getUserOnlineResources(e){if(!e||"string"!=typeof e)return console.warn("_getUserOnlineResources_: error",e),!1;let t=this.url+"WebXR/GetUserOnlineResources",a={user_id:e,language:""},r=this.sendPost(t,a);return await r}async getUserPublishedProjects(e,t){if(!e||"string"!=typeof e)return console.warn("_getUserPublishedProjects_: error",e),!1;let a=[];Array.isArray(t)&&(a=t);let r=this.url+"WebXR/GetUserPublishedProjects",o={user_id:e,proj_type:a},n=this.sendPost(r,o);return await n}async getUserResources(e){if(!e||"string"!=typeof e)return console.warn("_getUserResources_: error",e),!1;let t=this.url+"WebXR/GetUserResources",a={user_id:e},r=this.sendPost(t,a);return await r}async getUserTargetList(e){if(!e||"string"!=typeof e)return console.warn("_getUserTargetList_: error",e),!1;let t=this.url+"WebXR/GetUserTargetList",a={user_id:e},r=this.sendPost(t,a);return await r}async GetUserMaterials(e){if(!e||"string"!=typeof e)return console.warn("_getUserMaterials_: error",e),!1;let t=this.url+"Editor/GetUserMaterials",a={user_id:e},r=this.sendPost(t,a);return await r}async GetUserMaterialsbyID(e,t){if(!e||"string"!=typeof e)return console.warn("_getUserMaterials_: error",e),!1;let a=[];Array.isArray(t)&&(a=t);let r=this.url+"WebXR/GetUserMaterials",o={user_id:e,ids:a},n=this.sendPost(r,o);return await n}async getRecordModule(e,t){let a=this.url+"get_record_module",r={playing_user_id:e,proj_id:t},o=this.sendPost(a,r);return await o}async updateRecordModule(e){let t=this.url+"update_record_module",a=this.sendPost(t,e);return await a}async pointCardLog(e){let t=this.url+"point_card_log";return this.sendPost(t,e)}async quizLog(e){let t=this.url+"quiz_log";return this.sendPost(t,e)}sendPost_v340(e,t,a=r.webVersion_v340){let r=this;return new Promise((function(r,o){let n={ver:a,cid:5,data:t};fetch(e,{body:JSON.stringify(n),headers:{"content-type":"application/json"},method:"POST",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((e=>e.json())).then((function(e){setTimeout((function(){r(e)}),1)}))}))}async getUserInfo_v340(e,t=[]){let a=this.url_v340+"get_one_usr_info",r={user_id:e,wanted_info_keys:t},o=this.sendPost_v340(a,r);return await o}async getUserOnlineResources_v340(e,t,a,r){e&&"string"==typeof e||(console.warn("_getUserOnlineResources_v340_: error, user_id=",e),e="fefe"),t&&"string"==typeof t||(console.warn("_getUserOnlineResources_v340_: error, main_type=",t),t=""),a&&"string"==typeof a||(console.warn("_getUserOnlineResources_v340_: error, sub_type=",a),a=""),r&&"string"==typeof r||(console.warn("_getUserOnlineResources_v340_: error, category=",r),r="");let o=this,n=this.url_v340+"get_usr_online_res",s={user_id:e,main_type:t,sub_type:a,category:r},i=o.sendPost_v340(n,s).then((e=>o._createOnlineResDictFromResList(e.data.online_res_list)));return await i}_createOnlineResDictFromResList=e=>new Promise(((t,a)=>{e||t(-1);let r={};for(let a=0;a<e.length;a++)r[e[a].res_id]=e[a],a==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",a,e.length),t(r));0===Object.keys(e).length&&(console.log("reject"),a("userOnlineResList.length is 0"))}));async getUserResources_v340(e,t,a){e&&"string"==typeof e||(console.warn("_getUserResources_v340_: error, user_id=",e),e="makarvr"),t&&"string"==typeof t||(console.warn("_getUserResources_v340_: error, main_type=",t),t=""),a&&"string"==typeof a||(console.warn("_getUserResources_v340_: error, sub_type=",a),a="");let r=this,o=this.url_v340+"get_res",n={user_id:e,main_type:t,sub_type:a},s=r.sendPost_v340(o,n).then((e=>(console.log(353,e.data.list),r._createProjResDictFromResList(e.data.list))));return await s}_createProjResDictFromResList=e=>new Promise(((t,a)=>{e||t(-1);let r={};for(let a=0;a<e.length;a++)r[e[a].res_id]=e[a],a==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",a,e.length),t(r))}));async getVRProjsByProjId_v340(e){let t=this.url_v340+"get_vr_projs_by_proj_id",a={proj_id_list:e},r=this.sendPost_v340(t,a);return await r}async getVRProjScene_v340(e,t){let a=this.url_v340+"get_vr_proj_scene",r={user_id:e,proj_id:t},o=this.sendPost_v340(a,r);return await o}async getUserPublishProjsByUserID_v340(e,t,a){if(e&&"string"==typeof e||(console.warn("_getUserPublishProjsByUserID_v340_: error, user_id=",e),e="makarvr"),t&&"string"==typeof t||(console.warn("_getUserPublishProjsByUserID_v340_: error, main_type=",t),t=""),a&&"string"==typeof a||(console.warn("_getUserPublishProjsByUserID_v340_: error, sub_type=",a),a=""),"3.0.0"==window.serverVersion){let t=this.getUserResources_v340(e),a=this.getUserOnlineResources_v340(e),r=this.getUsrPublishProjs_v340(e).then((e=>(window.userPublishProjs=e.data,e.data)));return await Promise.all([r,t,a])}return Promise.reject(new Error(`_getUserPublishProjsByUserID_v340_:\n serverVersion= ${serverVersion}`))}async getUsrPublishProjs_v340(e){let t=this.url_v340+"get_usr_publish_projs",a={user_id:e,web_ar:!0},r=this.sendPost_v340(t,a);return await r}async getNewestPublishProjs_v340(e){e&&"string"==typeof e||(console.warn("_getNewestPublishProjs_v340_: error, proj_type=",e),e="vr");let t=this.url_v340+"get_newest_publish_projs",a={proj_type:e},r=this.sendPost_v340(t,a);return await r}async readTextFile_v340(e){return new Promise((function(t,a){fetch(e,{method:"GET",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((e=>e.json())).then((function(e){setTimeout((function(){t(e)}),1)}))}))}async getViewerConfig_v340(){let e=this.url_v340+"get_viewer_config",t=this.sendPost_v340(e,{},"3.1.1");return await t}async getARProjsByProjID_v340(e){if(!e||!Array.isArray(e))return console.warn("_getARProjsByProjID_v340_: error, projIDList=",e),!1;if(e.length<1)return console.warn("_getARProjsByProjID_v340_: error, projIDList=",e),!1;let t=this.url_v340+"get_ar_projs_by_proj_id",a={proj_id_list:e},r=this.sendPost_v340(t,a);return await r}async getVRSceneByUserID_v340(e){e&&"object"==typeof e||(console.warn("_getVRSceneByUserID_v340_: error, user_id=",e),e="makarvr");let t,a=this,r=[];return r.user_id=e,"3.0.0"==serverVersion&&a.searchUserIDByUserID_v340(e).then((t=>{for(let a in t.data.result)e.toLowerCase()===t.data.result[a].user_id.toLowerCase()&&(console.log("networkAgentVR.js: _searchUserIDByUserID: match, replace from [",e,"] to [",t.data.result[a].user_id,"]"),e=t.data.result[a].user_id);return a.getPayInfoByUserID_v340(e)})).then((e=>Promise.all([e,a.readTextFile_v340("https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/webVR_UserID_WhiteList.txt")]))).then((([o,n])=>{let s=n.customizedUserID.list,i=[];for(let e=0;e<s.length;e++)i.push(s[e].name);let l=i.indexOf(e.toLowerCase())>-1;o.data?(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: userPayInfo =",o.data),window.allowedMakarIDUseWeb=o.data.web_ar||l,"proA"!=o.data.user_type&&"proB"!=o.data.user_type&&"proC"!=o.data.user_type&&"custom"!=o.data.user_type||(window.allowedMakarIDUseWeb=!0),a.getUserPublishProjsByUserID_v340(e,"","").then((([e,o,n])=>{t=function(e,t,o){if(console.log("networkAgent.js: getVRSceneByUserID_v340: _getUserPublishProjsByUserID: userPublishProjs=",e),"string"!=typeof e){let n=[];for(let t in e.proj_list)if("vr"==e.proj_list[t].proj_type){if(parent.useEditorWebTag&&!e.proj_list[t].proj_platform.find((e=>"web"==e)))continue;n.push(e.proj_list[t].proj_id)}a.getVRProjsByProjId_v340(n).then((e=>{let n=e.data;window.publishVRProjs=n;let s=0;if(n.result&&n.result.length)for(let e=0;e<n.result.length;e++)a.getVRProjScene_v340(n.result[e].user_id,n.result[e].proj_id).then((a=>{if(s++,r[e]=a.data,s==n.result.length)return window.VRSceneResult=r,window.userProjResDict=t,window.userOnlineResDict=o,r}))}))}}(e,o,n)}))):(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: error, userPayInfo=",o),reject("this ID <br> ["+e+"] <br> user data error, please contact MIFLY for more information. "))})),await t}async getPayInfoByUserID_v340(e){if(!e||"string"!=typeof e)return console.warn("_getPayInfoByUserID_v340_: error, user_id=",e),!1;let t=this.url_v340+"get_pay_info",a={user_id:e},r=this.sendPost_v340(t,a);return await r}async getELicenseInfo_v340(e){if(!e||"string"!=typeof e)return console.warn("_getELicenseInfo_v340_: error, license_key=",e),!1;let t=this.url_v340+"get_e_lice_info",a={license_key:e},r=this.sendPost_v340(t,a,"3.1.1");return await r}async getRecordModule_v340(e,t){let a=this.url_v340+"get_record_module",r={playing_user_id:e,proj_id:t},o=this.sendPost_v340(a,r,"3.1.1");return console.log("networkAgentVR.js: _getRecordModule: ret",ret),await o}async quizLog_v340(e){let t=this.url_v340+"quiz_log",a=this.sendPost_v340(t,e,"3.1.1");return await a}async updateRecordModule_v340(e){let t=this.url_v340+"update_record_module",a=this.sendPost_v340(t,e,"3.1.1");return await a}async searchUserIDByUserID_v340(e){if(!e||"string"!=typeof e)return console.warn("_searchUserIDByUserID_v340_: error, user_id=",e),!1;let t=this.url_v340+"get_many_usr_info_keyword",a={keyword:e,search_keys:["user_id"]},r=this.sendPost_v340(t,a);return await r}};function l(e,t,a,r){let o=t.clone();o.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",o);let n=a.clone();n.multiply(new THREE.Vector3(1,-1,-1).multiplyScalar(180/Math.PI)),e.setAttribute("rotation",n),e.setAttribute("scale",r)}function c(e,a,r,o){return new Promise((function(n){t(r.res_url,(function(t){let s;if(console.log(" ******  retStatus = ",t,r.res_url),0==t){if(document.getElementById("sky")?(s=document.getElementById("sky"),"a-sky"==s.localName||"a-videosphere"==s.localName&&(s.remove(),s=document.createElement("a-sky"),s.setAttribute("id","sky"),e.appendChild(s))):(s=document.createElement("a-sky"),s.setAttribute("id","sky"),e.appendChild(s)),"DefaultResource/Spherical_Image/SphericalImage.png"==r.res_url);else{let e=document.createElement("div");e.style.position="absolute",e.style.top="30%",e.style.left="0%",e.style.width="100%",e.style.height="40%",e.style.color="black",e.style.backgroundColor="rgba(128,128,128,0.5)",e.style.pointerEvents="none",e.style.fontSize="24px",e.style.zIndex=3,document.body.appendChild(e);let t=document.createElement("div");t.className="centerText",t.style.whiteSpace="pre-wrap",t.textContent="此專案的環景影片/圖片無法於瀏覽器支援，改為預設場景",e.appendChild(t),setTimeout((function(){e.remove()}),8e3)}let t=!1;if(s.getAttribute("material")&&s.getAttribute("material").src==r.res_url&&(t=!0),1==t)console.log("VRFunc.js: _loadSky: spherical_image same as previous(404)"),n(s);else{s.setAttribute("material",{src:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png"}),s.setAttribute("radius",2e3);var i=function(){console.log("VRFunc.js: _loadSky: spherical_image materialtextureloaded, remove loading page "),s.removeEventListener("materialtextureloaded",i)};s.addEventListener("materialtextureloaded",i),n(s)}}else{switch(r.main_type){case"spherical_image":case"image":document.getElementById("sky")?(s=document.getElementById("sky"),"a-sky"==s.localName||"a-videosphere"==s.localName&&(s.remove(),s=document.createElement("a-sky"),s.setAttribute("id","sky"),e.appendChild(s))):(s=document.createElement("a-sky"),s.setAttribute("id","sky"),e.appendChild(s)),"DefaultResource/Spherical_Image/SphericalImage.png"==r.res_url&&(r.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png");let t=!1;s.getAttribute("material")&&s.getAttribute("material").src==r.res_url&&(t=!0),0==t?(s.setAttribute("material",{src:r.res_url}),i=function(){console.log("VRFunc.js: _loadSky: spherical_image materialtextureloaded, remove loading page "),s.removeEventListener("materialtextureloaded",i),n(s)},s.addEventListener("materialtextureloaded",i)):(console.log("VRFunc.js: _loadSky: spherical_image same as previous  "),n(s)),s.setAttribute("radius",2e3);break;case"spherical_video":let l=document.getElementById("makarAssets");document.getElementById("sky")?(s=document.getElementById("sky"),"a-sky"==s.localName?(s.remove(),s=document.createElement("a-videosphere"),s.setAttribute("id","sky"),e.appendChild(s)):s.localName):(s=document.createElement("a-videosphere"),s.setAttribute("id","sky"),e.appendChild(s));let c=document.createElement("video");c.src=r.res_url,c.playsInline=!0,c.autoplay=!0,c.muted=!0,c.setAttribute("loop","true"),c.setAttribute("type","video/mp4"),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(c.muted=!0)),c.onloadedmetadata=function(){console.log("VRFunc.js: _loadSky: spherical_video onloadedmetadata"),c.play()},c.setAttribute("crossorigin","anonymous"),c.setAttribute("id",a+"_"+o),c.setAttribute("autoplay","true"),l.appendChild(c),s.setAttribute("src","#"+a+"_"+o),s.setAttribute("radius",2e3),i=function(){console.log("VRFunc.js: _loadSky: spherical_video materialtextureloaded, remove loading page "),s.removeEventListener("materialtextureloaded",i),n(s)},s.addEventListener("materialtextureloaded",i)}console.log("VRFunc.js: _loadSky: aSky=",s)}}))}))}function d(e){if(!e)return console.warn(" _projDataBasicCheck : _projData not exist "),-1;let t=e.editor_ver;if(!t||"string"!=typeof t)return console.warn(" _projDataBasicCheck_: editor_ver error ",t),-1;let a=t.split(".");return 3!=a.length&&4!=a.length?(console.warn(" _projDataBasicCheck_: vArr error ",a),-1):void 0}function u(e){if(!e)return console.warn(" _sceneBasicCheck_ : _sceneData not exist "),-1;let t=e.editor_ver;if(!t||"string"!=typeof t)return console.warn(" _sceneBasicCheck_: editor_ver error ",t),-1;let a=t.split(".");return 3!=a.length&&4!=a.length?(console.warn(" _sceneBasicCheck_: vArr error ",a),-1):void 0}function m(e){let t=e.split("."),a={},r=!0;return t.forEach((e=>{Number.isInteger(Number(e))||(r=!1)})),r&&(a.v0=Number(t[0]),a.v1=Number(t[1]),a.v2=Number(t[2]),3==t.length||4==t.length&&(a.v3=Number(t[3]))),a}const p=new class{getOneProj(e){let t={};if(e){if(d(e)<0)return{};t=e}return t}getSceneLogicXML(e,t){let a="";if(e){if(u(e)<0)return a;let r=m(e.editor_ver),o=r.v0,n=r.v1;if(r.v2,r.v3,3==o&&n>=5){let r=e.scenes;r[t]&&(a=r[t].xml_url)}}return a}getProjDataEditorVer(e){return d(e)<0?{}:m(e.editor_ver)}getScenes(e){if(u(e)<0)return[];let t=m(e.editor_ver),a=t.v0,r=t.v1,o=(t.v2,t.v3,[]);return 3==a&&r>=5?e&&Array.isArray(e.scenes)&&(o=e.scenes,console.log(" _getScenes_: success ",t,o)):console.warn(" _getScenes_: vo error ",t),o}checkSceneIncludeAR(e){if(u(e)<0)return!1;let t=m(e.editor_ver),a=t.v0,r=t.v1,o=(t.v2,t.v3,!1);if(3==a&&r>=5&&e&&Array.isArray(e.scenes)){let t=e.scenes;for(let e=0;e<t.length;e++){let a=t[e];a&&a.info&&"ar"==a.info.type&&(o=!0)}}return o}checkSceneIncludeVR(e){if(u(e)<0)return!1;let t=m(e.editor_ver),a=t.v0,r=t.v1,o=(t.v2,t.v3,!1);if(3==a&&r>=5&&e&&Array.isArray(e.scenes)){let t=e.scenes;for(let e=0;e<t.length;e++){let a=t[e];a&&a.info&&"vr"==a.info.type&&(o=!0)}}return o}checkSceneIncludeXR(e){if(u(e)<0)return!1;let t=m(e.editor_ver),a=t.v0,r=t.v1,o=(t.v2,t.v3,!1);if(3==a&&r>=5&&e&&Array.isArray(e.scenes)){let t=e.scenes;for(let e=0;e<t.length;e++){let a=t[e];a&&a.info&&"ar_slam"==a.info.type&&(o=!0)}}return o}getSceneType(e,t){if(u(e)<0)return"";let a=m(e.editor_ver),r=a.v0,o=a.v1,n=(a.v2,a.v3,"");if(3==r&&o>=5){if(e&&Array.isArray(e.scenes)){let a=e.scenes;a[t]&&a[t].info&&a[t].info.type&&(n=a[t].info.type),console.log(" _getSceneType_ : success ",n)}}else console.warn(" _getSceneType_ : error ",t,e);return n}getSceneObjs(e,t){if(u(e)<0)return[];let a=m(e.editor_ver),r=a.v0,o=a.v1,n=(a.v2,a.v3,[]);if(3==r&&o>=5){if(e&&Array.isArray(e.scenes)){let r=e.scenes;r[t]&&Array.isArray(r[t].objs)&&(n=r[t].objs),console.log(" _getSceneObjs_ : success ",a,r)}}else console.warn(" _getSceneObjs_ : vo error ",a);return n}getSceneBehav(e,t){if(u(e)<0)return[];let a=m(e.editor_ver),r=a.v0,o=a.v1,n=(a.v2,a.v3,[]);if(3==r&&o>=5){if(e&&Array.isArray(e.scenes)){let a=e.scenes;a[t]&&Array.isArray(a[t].behav)&&(n=a[t].behav),console.log(" _getSceneBehav_ : success ",n)}}else console.warn(" _getSceneBehav_ : error ",t,e);return n}setBehavIntoObj(e,t,a){if(u(e)<0)return[];let r=m(e.editor_ver),o=r.v0,n=r.v1,s=(r.v2,r.v3,[]);if(3==o&&n>=5){if(e&&Array.isArray(e.scenes)){let r=e.scenes;r[t]&&Array.isArray(r[t].behav)&&(s=r[t].behav),s.forEach((e=>{e.trigger_obj_id&&e.trigger_obj_id==a.generalAttr.obj_id&&(a.behav&&Array.isArray(a.behav)&&a.behav.length>0?a.behav.push(e):a.behav=[e])}))}}else console.warn(" _setBehavIntoObj_ : version error ",t,e)}getObjTransform(e,t){if(u(e)<0)return{};let a=m(e.editor_ver),r=a.v0,o=a.v1,n=(a.v2,a.v3,{position:null,rotation:null,scale:null,quaternion:null});if(3==r&&o>=5){if(t.generalAttr&&"2d"==t.generalAttr.obj_type)t.transformAttr&&t.transformAttr.rect_transform&&t.transformAttr.rect_transform[0]?(n.position=(new THREE.Vector3).fromArray(t.transformAttr.rect_transform[0].position.split(",").map((e=>Number(e)))),n.rotation=(new THREE.Vector3).fromArray(t.transformAttr.rect_transform[0].rotation.split(",").map((e=>Number(e)))),n.scale=(new THREE.Vector3).fromArray(t.transformAttr.rect_transform[0].scale.split(",").map((e=>Number(e))))):console.warn(" _getObjTransform_ : v3.5.0 type 2d error ",t);else if(t.generalAttr&&"3d"==t.generalAttr.obj_type)if(t.transformAttr&&t.transformAttr.transform){n.position=(new THREE.Vector3).fromArray(t.transformAttr.transform[0].split(",").map((e=>Number(e))));let e=t.transformAttr.transform[1].split(",").map((e=>Number(e)));n.quaternion=new THREE.Quaternion(e[0],e[1],e[2],e[3]);let a=(new THREE.Euler).setFromQuaternion(n.quaternion,"YXZ");n.rotation=new THREE.Vector3(a.x,1*a.y,1*a.z),n.scale=(new THREE.Vector3).fromArray(t.transformAttr.transform[2].split(",").map((function(e){return Number(e)})))}else console.warn(" _getObjTransform_ : v3.5.0 type 3d error ",t)}else console.warn(" _getObjTransform_ :  error ",t);return n}getObjObjType(e,t){if(u(e)<0)return"";let a=m(e.editor_ver),r=a.v0,o=a.v1,n=(a.v2,a.v3,"");return 3==r&&o>=5?t.generalAttr&&t.generalAttr.obj_type&&(n=t.generalAttr.obj_type):console.warn(" _getObjObjType_ :  error ",t),n}getObj2DTransform(e,t){if(4==Object.keys(e).length){let r;return Number(e.v0),Number(e.v1),Number(e.v2),r=a(),r.rectP&&r.rectSizeDelta&&r.rectScale?r:(console.warn(" _getObj2DInfo_ :  error ",t),!1)}{let e=a();return!!(e.rectP&&e.rectSizeDelta&&e.rectScale)&&e}function a(){let e,a,r,o,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(self.selectedResolutionIndex)||(console.log(" _getObj2DInfo350: error, missing _selectedResolutionIndex"),self.selectedResolutionIndex=0);let s=t.transformAttr.rect_transform[self.selectedResolutionIndex];if(s.position&&s.size_delta&&s.rotation&&s.scale){e=s.position.split(",").map((function(e){return Number(e)})),a=s.size_delta.split(",").map((function(e){return Number(e)})),r=s.scale.split(",").map((function(e){return Number(e)})),o=s.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),i=(new THREE.Euler).setFromQuaternion(t,"YXZ"),l=new THREE.Vector3(i.x,i.y,i.z);l.z=-1*l.z,n={rectP:e,rectSizeDelta:a,rectScale:r,rectR:l}}}return n}}};function _(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("VRFunc.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("VRFunc.js: _checkGLTFMaterialIndex: material error",t);let a=t.mesh_idx,r=t.primitive_idx,o=-1,n=-1,s=e.object3D.children[0].ModelJson.nodes,i=-1;for(let e=0;e<s.length;e++)if("number"==typeof s[e].mesh&&i++,a==i){o=s[e].mesh;break}if(o>=0){let t=e.object3D.children[0].ModelJson.meshes[o];if(t&&t.primitives){let e=t.primitives[r];e&&e.material>=0&&(n=e.material,console.log("VRFunc.js: _checkGLTFMaterialIndex: materialIndex=",n))}}return[n,o]}function h(e,a,r,n,s){let i=this;return new Promise((function(s){t(e.res_url,(function(t){if(1==t){let t=[];if(""==e.res_url||"glb"!=e.sub_type&&"gltf"!=e.sub_type&&"gltf_sketchFab"!=e.sub_type&&"gltf_sketchfab"!=e.sub_type&&"gltf_poly"!=e.sub_type)return console.log("VRFunc.js: _loadGFLTFModel: obj not support ",e),void s(-1);let u=document.getElementById("makarAssets"),m=document.createElement("a-asset-item");m.setAttribute("id",e.generalAttr.obj_id+"_"+e.res_id),m.setAttribute("src",e.res_url),m.setAttribute("response-type","arraybuffer"),m.setAttribute("crossorigin","anonymous"),u.appendChild(m);var c,d=null;if(e.animationAttr&&(d=[],"object"==typeof i.editor_version&&4==Object.keys(i.editor_version).length)){let t=Number(i.editor_version.v0),a=Number(i.editor_version.v1);if(Number(i.editor_version.v2),t>3||3==t&&a>=5){for(let t=0;t<e.animationAttr.length;t++)(e.animationAttr[t].is_default||e.animationAttr[t].is_active)&&(d.push({idle:e.animationAttr[t].uid,loop:e.animationAttr[t].uid,uid:e.animationAttr[t].uid,changed:!1,reset:!0,count:0}),c=o(e.animationAttr[t].animation_name));for(let t=0;t<e.animationAttr.length;t++)d.push({name:e.animationAttr[t].name,animationName:o(e.animationAttr[t].animation_name),startTime:e.animationAttr[t].start_time,endTime:e.animationAttr[t].end_time,uid:e.animationAttr[t].uid})}}let p=document.createElement("a-entity");if(!e.res_url)return;if(p.setAttribute("gltf-model","#"+e.generalAttr.obj_id+"_"+e.res_id),e.animationAttr&&p.setAttribute("animation-mixer","clip: "+c),e.behav||e.generalAttr.logic?p.setAttribute("class","clickable"):p.setAttribute("class","unclickable"),p.setAttribute("id",e.generalAttr.obj_id),p.setAttribute("crossorigin","anonymous"),p.setAttribute("shadow",""),e.model_shift){let t=(new THREE.Vector3).fromArray(e.model_shift.split(",").map((function(e){return Number(e)})));t.multiply(n),a.add(t)}if(l(p,a,r,n),i.makarObjects.push(p),p.addEventListener("model-loaded",(function(a){if(a.target==a.currentTarget){let r=i.vrScene.renderer.capabilities.getMaxAnisotropy();if(a.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=r,e.material.map.needsUpdate=!0)})),p.object3D){p.object3D.makarObject=!0,p.object3D.makarType="model",e.behav&&(p.object3D.behav=e.behav,i.setObjectBehavAll(e)),e.behav_reference&&(p.object3D.behav_reference=e.behav_reference);let r=p.getObject3D("mesh");if(r.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(console.log("loadGLTFModel: _取消所有「模型自帶光」 node=",e),e.visible=!1)})),e.materialAttr.materials&&e.materialAttr.materials.length>0){for(let a=0;a<e.materialAttr.materials.length;a++)if(r.ModelJson){let o=_(p,e.materialAttr.materials[a]);if(!e.materialAttr.materials[a].material_idx){y(i,p,e,r,a);continue}let n=b(i,e);t.push(n),n.then((t=>{g(i,p,e.materialAttr.materials[a].material_idx,o)}))}}else if(e.default_shader_name)switch(console.log("run default_shader_name: ",e.default_shader_name),e.default_shader_name){case"standard":break;case"Unlit/Transparent":r.ModelJson&&r.traverse((e=>{e.material&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.opacity=1,e.material.alphaTest=.5)}));break;case"Unlit/Transparent Cutout":r.ModelJson&&r.traverse((e=>{e.material&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.opacity=.5,e.material.depthWrite=!1,e.renderOrder=1)}));break;case"Unlit/Color":r.ModelJson&&r.traverse((e=>{e.material&&(e.material=new THREE.MeshBasicMaterial({color:e.material.color,name:e.material.name,skinning:e.material.skinning}))}));break;case"Unlit/Texture":r.traverse((e=>{e.material&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}))}else if(r.ModelJson&&r.ModelJson.materials){console.log("run alphaMode: ",r.ModelJson.materials);let e=p.sceneEl.renderer;for(let t=0;t<r.ModelJson.materials.length;t++)if(r.ModelJson.materials[t].alphaMode)switch(r.ModelJson.materials[t].alphaMode){case"OPAQUE":r.traverse((a=>{if(a.material){let r=a.material.name.split("_");r[r.length-1]==t&&(a.material.opacity=1,e.setClearAlpha(1),a.material.blending=THREE.CustomBlending,a.material.blendEquation=THREE.AddEquation,a.material.blendSrc=THREE.OneFactor,a.material.blendDst=THREE.ZeroFactor,a.material.blendSrcAlpha=THREE.ZeroFactor,a.material.blendDstAlpha=THREE.OneFactor)}}));break;case"MASK":r.traverse((a=>{if(a.material){let r=a.material.name.split("_");r[r.length-1]==t&&(a.material.opacity=1,a.material.alphaTest=.5,e.setClearAlpha(1),a.material.blending=THREE.CustomBlending,a.material.blendEquation=THREE.AddEquation,a.material.blendSrc=THREE.OneFactor,a.material.blendDst=THREE.ZeroFactor,a.material.blendSrcAlpha=THREE.ZeroFactor,a.material.blendDstAlpha=THREE.OneFactor,a.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:a.material.map,alphaTest:.5}))}}));break;case"BLEND":r.traverse((e=>{if(e.material){let a=e.material.name.split("_");a[a.length-1]==t&&(e.material.opacity=.5,e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.renderOrder=1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:.5}))}}))}}Array.isArray(a.detail.model.animations)&&a.detail.model.animations.length>0&&!p.getAttribute("animation-mixer")&&(console.log("VRFunc.js: loadGFLTFModel: the model with animation but no animation-mixer, probabily older version of editor ",a.detail.model),p.setAttribute("animation-mixer","clip: "+a.detail.model.animations[0].name),(d=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),d.push({animationName:a.detail.model.animations[0].name,name:a.detail.model.animations[0].name,endTime:a.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),a.detail.model.animationSlices=d,Promise.all(t).then((function(){s(p)}))}}})),0==e.generalAttr.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable")),e.generalAttr.obj_parent_id){let t=setInterval((function(){let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(p),window.clearInterval(t))}),1)}else i.vrScene.appendChild(p)}else console.log("VRFunc.js: _loadGLTFModel , obj url not exist ",e),e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",i.loadGLTFModel(e,a,r,n,i.cubeTex),s(1)}))}))}function g(e,t,a,r){let o=t.getObject3D("mesh"),n=e.userMaterialDict[a],s={};console.log("material_idx",n);let i=r[0],l=r[1];s.name=n.res_name,s.shader=n.shader;for(let t=0;t<n.properties.length;t++)switch(n.properties[t].key){case"alphaMode":break;case"doubleSided":s.doubleSided=n.properties[t].value;break;case"_Color":let r=n.properties[t].value.split(",");s.color=new THREE.Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),s.alpha=parseFloat(r[3]);break;case"_MainTex":s.map=e.materials_texture_dict[a].mainTex;break;case"_Cutoff":s.cutoff=n.properties[t].value;break;case"_Glossiness":s.smoothness=n.properties[t].value;break;case"_SpecGlossMap":s.specGlossMap=e.materials_texture_dict[a].specGlossMap;case"_Metallic":s.metallic=n.properties[t].value;break;case"_MetallicGlossMap":s.metalnessMap=e.materials_texture_dict[a].metalnessMap;break;case"_SpecularHighlights":s.specularHighlights=n.properties[t].value;break;case"_GlossyReflections":s.glossyReflections=n.properties[t].value;break;case"_BumpScale":s.bumpscale=n.properties[t].value;break;case"_BumpMap":s.bumpMap=e.materials_texture_dict[a].bumpMap;break;case"_Parallax":s.parallax=n.properties[t].value;break;case"_ParallaxMap":s.parallaxMap=e.materials_texture_dict[a].parallaxMap;break;case"_OcclusionStrength":s.aoMapIntensity=n.properties[t].value;break;case"_OcclusionMap":s.aoMap=e.materials_texture_dict[a].aoMap;break;case"_EmissionColor":let o=n.properties[t].value.split(",");s.emissionColor=new THREE.Color(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]));break;case"_EmissionMap":s.emissionMap=e.materials_texture_dict[a].emissionMap;break;case"_Mode":s.mode=n.properties[t].value;break;case"_ToonShade":s.toonShade=e.materials_texture_dict[a].toonShade;break;case"_TintColor":1==n.properties[t].value?s.tintColor=!0:s.tintColor=!1;break;case"_Brightness":s.brightness=n.properties[t].value;break;case"_OutlineColor":let i=n.properties[t].value.split(",");s.outlineColor=new THREE.Color(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]));break;case"_Outline":s.outlineWidth=n.properties[t].value}switch(s.shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==i&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:s.color,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":case"Autodesk Interactive":var c=t.sceneEl.renderer;o.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==i&&t.meshIdx==l&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:s.map?s.map:null,emissive:s.emissionColor?s.emissionColor:t.material.emissive,emissiveMap:s.emissionMap?s.emissionMap:null,normalMap:t.material.normalMap,bumpMap:s.bumpMap?s.bumpMap:null,flatShading:t.material.flatShading}),t.material.color=s.color,s.metalnessMap?t.material.metalnessMap=s.metalnessMap:(t.material.metalness=s.metallic,t.material.roughness=1-s.smoothness),t.material.bumpscale=s.bumpscale,t.material.displacementMap=s.displacementMap?s.displacementMap:null,s.aoMap&&(t.geometry.attributes.uv2=t.geometry.attributes.uv.clone(),t.material.aoMap=s.aoMap,t.material.aoMapIntensity=s.aoMapIntensity),t.material.envMap=e.cubeTex.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=s.doubleSided?THREE.DoubleSide:THREE.FrontSide,t.material.transparent=!0,t.material.map&&(THREE.GammaEncoding&&(t.material.map.encoding=THREE.GammaEncoding),t.material.map.needsUpdate=!0),0==s.mode?(t.material.opacity=1,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==s.mode?(t.material.opacity=1,t.material.alphaTest=s.cutoff,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:s.map,alphaTest:s.cutoff})):2==s.mode?(t.material.opacity=s.alpha,t.material.depthWrite=!1,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:s.map,alphaTest:s.cutoff})):3==s.mode&&(t.material.opacity=Math.max(s.alpha,s.metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:s.map,alphaTest:s.cutoff})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&e.meshIdx==l&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:s.map}),e.material.opacity=1,e.material.alphaTest=s.cutoff)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:s.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/Vertex":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==i&&e.meshIdx==l&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning}),e.material.vertexColors=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==i&&t.meshIdx==l&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.skyRenderTarget.texture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"TSF/BaseOutline1":e.needsCullFaceBack=!0;let r=t.object3D.clone(!0);r.obj_id=t.getAttribute("id"),e.cullFaceBackScene.add(r),o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==i&&e.meshIdx==l){let t=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning});t.onBeforeCompile=function(e){e.uniforms.toonShade={value:s.toonShade},e.uniforms.tintColor={value:s.tintColor},e.uniforms.color={value:s.color},e.uniforms.brightness={value:s.brightness},e.vertexShader="varying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",["#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <begin_vertex>"].join("\n")),e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","vProjection = normalize( transformedNormal );","vProjection.y = -vProjection.y;","vProjection.z = -vProjection.z;"].join("\n")),e.fragmentShader="uniform sampler2D toonShade;\nuniform bool tintColor;\nuniform vec3 color;\nuniform float brightness;\nvarying vec3 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <fog_fragment>",["#include <fog_fragment>","\tvec2 sampleUV;","   vec4 tmp;","\tsampleUV.x = vProjection.x*0.5 + 0.5;","\tsampleUV.y = vProjection.y*0.5 + 0.5;","   tmp = texture2D(toonShade, sampleUV);","   if(tintColor){","       tmp.x = tmp.x * color.x * brightness;","       tmp.y = tmp.y * color.y * brightness;","       tmp.z = tmp.z * color.z * brightness;","   }","   else{","       tmp.x = tmp.x * brightness;","       tmp.y = tmp.y * brightness;","       tmp.z = tmp.z * brightness;","   }","\tgl_FragColor.x *= tmp.x;","\tgl_FragColor.y *= tmp.y;","\tgl_FragColor.z *= tmp.z;"].join("\n"))},t.map=s.map,e.material=t}}})),r.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==i&&e.meshIdx==l){let t=e.material.clone();t.onBeforeCompile=function(e){e.uniforms.boarderColor={value:s.outlineColor},e.uniforms.boarderWidth={value:s.outlineWidth},e.vertexShader="uniform float boarderWidth;\nvarying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","mvPosition.xyz += vNormal * boarderWidth * 0.01;","gl_Position = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform vec3 boarderColor;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","gl_FragColor = vec4(boarderColor, 1.0);"].join("\n"))},e.material=t}}}));break;case"Blocks/Basic":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==i&&e.meshIdx==l){let t=e.material.clone();t.color=s.color,e.material=t}}}));break;case"Blocks/BlocksGlass":case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==i&&e.meshIdx==l){let t=e.material.clone();t.color=s.color,e.material=t,e.material.depthWrite=!1,e.renderOrder=1}}}));break;default:console.log(`The shader of id ${a} material is not supported currently.`)}}function b(e,a){return new Promise((function(r){if(0!=a.materialAttr.materials.length){let o=[];for(let r=0;r<a.materialAttr.materials.length;r++){let n=a.materialAttr.materials[r].material_idx;if(!n||"string"!=typeof n)continue;e.materials_texture_dict[n]={};let s=e.userMaterialDict[n];for(let a=0;a<s.properties.length;a++){let r,i=null;"_MainTex"!=s.properties[a].key&&"_MetallicGlossMap"!=s.properties[a].key&&"_SpecGlossMap"!=s.properties[a].key&&"_BumpMap"!=s.properties[a].key&&"_ParallaxMap"!=s.properties[a].key&&"_OcclusionMap"!=s.properties[a].key&&"_EmissionMap"!=s.properties[a].key&&"_ToonShade"!=s.properties[a].key||(i=s.properties[a].value,r=s.properties[a].scale.split(",").map((e=>Number(e))));let l=new Promise((function(o){i?t(i,(function(t){if(1==t){let t=(new THREE.TextureLoader).load(i,(function(){t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.flipY=!1,t.repeat.x=r[0],t.repeat.y=r[1],t.format=THREE.RGBAFormat,t.needsUpdate=!0,o(t)}));"_MainTex"==s.properties[a].key?e.materials_texture_dict[n].mainTex=t:"_MetallicGlossMap"==s.properties[a].key?e.materials_texture_dict[n].metalnessMap=t:"_SpecGlossMap"==s.properties[a].key?e.materials_texture_dict[n].specGlossMap=t:"_BumpMap"==s.properties[a].key?e.materials_texture_dict[n].bumpMap=t:"_ParallaxMap"==s.properties[a].key?e.materials_texture_dict[n].parallaxMap=t:"_OcclusionMap"==s.properties[a].key?e.materials_texture_dict[n].aoMap=t:"_EmissionMap"==s.properties[a].key?e.materials_texture_dict[n].emissionMap=t:"_ToonShade"==s.properties[a].key&&(e.materials_texture_dict[n].toonShade=t)}else console.log("_loadMaterialTexture: texture url not exists."),o(1)})):o(1)}));o.push(l)}}Promise.all(o).then((function(e){console.log("GLTFModleModule.js: _loadMaterials: textures then ret = ",e),r(o)}))}else console.log("_loadMaterialTexture: obj no material texture"),r(1)}))}function y(e,t,a,r,o){console.log("____loadGLTFModel obj.materialAttr=",a.materialAttr);let n=a.materialAttr.materials[o].materialIndex;if(Number.isInteger(n)){console.log("_loadMaterial_v340 materialIndex=",n);let i=a.materialAttr.materials[o].color,l=[1,1,1,1];("string"==typeof i||i instanceof String)&&i.split(",").length>=3&&(l=i.split(","));let c=new THREE.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]));switch(a.materialAttr.materials[o].shader){case"Unlit/Color":r.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:c,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":console.log("obj.materialAttr.materials[i]",a.materialAttr.materials[o]);var s=t.sceneEl.renderer;r.traverse((t=>{if(t.material){let r=t.material.name.split("_");r[r.length-1]==n&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:t.material.map,emissive:t.material.emissive,emissiveMap:t.material.emissiveMap,normalMap:t.material.normalMap}),t.material.color=c,t.material.metalness=a.materialAttr.materials[o].metallic,t.material.roughness=1-a.materialAttr.materials[o].smoothness,t.material.envMap=e.cubeTex.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=THREE.DoubleSide,t.material.transparent=!0,t.material.map&&(THREE.GammaEncoding&&(t.material.map.encoding=THREE.GammaEncoding),t.material.map.needsUpdate=!0),0==a.materialAttr.materials[o].mode?(t.material.opacity=1,s.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==a.materialAttr.materials[o].mode?(t.material.opacity=1,t.material.alphaTest=a.materialAttr.materials[o].cut_off,s.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})):2==a.materialAttr.materials[o].mode?(t.material.opacity=parseFloat(l[3]),console.log("node.material.opacity",t.material.opacity),t.material.depthWrite=!1,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})):3==a.materialAttr.materials[o].mode&&(t.material.opacity=Math.max(parseFloat(l[3]),a.materialAttr.materials[o].metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})))}}));break;case"Unlit/Transparent":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Unlit/Transparent Cutout":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":r.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==n&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.skyRenderTarget.texture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Blocks/BlocksGlass":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;default:console.log(`The shader of no. ${o} material is not supported currently.`)}}}function f(e,t,a,r,o,n,s){const i=this;console.log("loadWebViewNotSupport",e,t,a,r,o,n);let c=document.createElement("a-entity");if(e.behav||e.generalAttr.logic?c.setAttribute("class","clickable"):c.setAttribute("class","unclickable"),c.setAttribute("id",e.generalAttr.obj_id),c.setAttribute("crossorigin","anonymous"),c.setAttribute("shadow",""),0==e.generalAttr.active&&(c.setAttribute("visible",!1),c.setAttribute("class","unclickable")),l(c,r,o,n.multiplyScalar(.9)),i.makarObjects.push(c),c.addEventListener("loaded",(a=>{let r,o,n,s;c.object3D.makarObject=!0,c.object3D.makarType="webview",e.behav&&(c.object3D.behav=e.behav),o=1.1,n=1.2,r=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,1.2,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),e.behav_reference&&(r.behav_reference=e.behav_reference),c.object3D.add(r),r.position.set(0,.05,0),s=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,1.2,0),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.1})),c.object3D.add(s),s.position.set(0,.05,0),s.rotation.set(0,0,0),s.scale.set(.95,.95,.95);let l={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"webview is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj_${i.currentSceneIndex}_${t}`,obj_name:e.generalAttr.obj_name+"_tempTexObj",obj_type:"3d",interactable:!1,obj_parent_id:e.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:["0,0,0","0,0,0,1","1,1,1"],rect_transform:[],simulated_rotation:"0,0,0"},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};i.loadText(l,new THREE.Vector3(0,.05,0),new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),!0).then((e=>{const t=e.object3D.clone();c.object3D.add(t),t.position.set(0,0,.005)}))})),e.generalAttr.obj_parent_id){let t=setInterval((()=>{let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(c),window.clearInterval(t))}),1)}else i.vrScene.appendChild(c)}function v(e,t,a,r,o,n,s){const i=this;console.log("loadWebViewNotSupport2D",e,t,a,r,o,n);const l=p.getObj2DTransform(i.editor_version,e,t,a,r,o,n);let c,d,u,m,_,h;if(!l)return!1;c=l.rectP,d=l.rectSizeDelta,u=l.rectScale,m=l.rectR,n.x=l.rectScale[0],n.y=l.rectScale[1];let g=i.scaleRatioXY;_=d[0]*g,h=d[1]*g;let b,y,f=new THREE.Object3D;f.makarObject=!0,f.makarType="youtube2D",f.obj_id=e.generalAttr.obj_id,e.behav&&(f.behav=e.behav),0==e.generalAttr.active&&(f.visible=!1),b=new THREE.Mesh(new THREE.PlaneBufferGeometry(_,h,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),y=new THREE.Mesh(new THREE.PlaneBufferGeometry(_,h,0),new THREE.MeshBasicMaterial({color:11184810,side:THREE.DoubleSide,transparent:!0,opacity:.1})),y.position.set(0,0,0),y.rotation.set(0,0,0),y.scale.set(.9,.9,.9),f.add(b),f.add(y);let v={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"WebView is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj2D_${i.currentSceneIndex}_${t}`,obj_name:e.generalAttr.obj_name+"_tempTextObj2D",obj_type:"2d",interactable:!1,obj_parent_id:e.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:[],rect_transform:[{scale:"1,1,1",position:"0,0,0",rotation:"0,0,0,1",size_delta:e.transformAttr.rect_transform[i.selectedResolutionIndex].size_delta,simulated_rotation:"0,0,0"}],simulated_rotation:""},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};if(i.loadText2D(v,t,a,null,null,null,!0).then((e=>{console.log("YT後文字 result",e),e.position.z=.01,e.position.z=.05})),e.generalAttr.obj_parent_id){let r=()=>{let o=!1;for(let t=0;t<i.makarObjects2D.length;t++)i.makarObjects2D[t].obj_id==e.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(r,200);else for(let r=0;r<i.makarObjects2D.length;r++)if(i.makarObjects2D[r].obj_id==e.generalAttr.obj_parent_id){f.translateX(c[0]*g),f.translateY(-c[1]*g),f.translateZ(t/a-1),f.rotateZ(m.z),f.scale.set(u[0],u[1],1),f.makarObject=!0,f.obj_id=e.generalAttr.obj_id,f.obj_parent_id=e.generalAttr.obj_parent_id,i.makarObjects2D[r].add(f),i.makarObjects2D.push(f);break}};r()}else f.scale.set(n.x,n.y,1),f.translateX(c[0]*g),f.translateY(-c[1]*g),f.translateZ(t/a-1),f.rotateZ(m.z),i.scene2D.add(f),i.makarObjects2D.push(f)}function w(e,a,r,o){console.log("VRFunc.js: _loadAudio , obj=",e);let n=this;return new Promise((function(s){t(e.res_url,(function(t){if(1==t){let i=document.getElementById("makarAssets");console.log("_loadAudio: checkFileExtension",e);let l=e.res_url.substring(e.res_url.lastIndexOf(".")+1);console.log("_loadAudio: checkFileExtension getTail",l);let c=document.createElement("audio"),d=!1;switch(l){case"mp3":case"wav":case"ogg":u(c,e.res_url),c.onloadedmetadata=function(){m()};break;default:fetch(e.res_url,{method:"GET",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((function(e){return e.blob()})).then((function(e){let t=URL.createObjectURL(e);console.log("__AudioModules.js: before _onloadedmetadata ",t),c.onloadedmetadata=function(){console.log(" 7777777777777777777 AudioModules.js: _onloadedmetadata ",t),d||m()},c.addEventListener("loadstart",(function(e){console.log("__AudioModules.js: loadstart  \n\n",t),d||m()})),u(c,t)}))}function u(t,a=e.res_url){t.setAttribute("id",e.generalAttr.obj_id+"_"+e.res_id),t.setAttribute("src",a),t.setAttribute("crossorigin","anonymous"),t.setAttribute("loop",!0),t.setAttribute("preload","auto"),i.appendChild(t)}function m(){let t=document.createElement("a-sound");t.setAttribute("sound","src: #"+e.generalAttr.obj_id+"_"+e.res_id+"; positional: false"),t.setAttribute("id",e.generalAttr.obj_id),t.setAttribute("sound","autoplay: false"),n.setTransform(t,a,r,o),n.makarObjects.push(t);let i=!0;0==e.generalAttr.active&&(i=!1,t.setAttribute("sound","loop: false"),t.setAttribute("visible",!1),t.setAttribute("class","unclickable"));let l=!1;if(e.behav_reference){for(let c=0;c<e.behav_reference.length;c++)if("Display"==e.behav_reference[c].behav_type&&("Show"==e.behav_reference[c].switch_type||"Switch"==e.behav_reference[c].switch_type)){i=!1,l=!0,t.setAttribute("sound","loop: false"),t.setAttribute("visible",!1);break}}else t.setAttribute("visible",!0);if(e.generalAttr.obj_parent_id){let u=setInterval((function(){let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(t),window.clearInterval(u),a.addEventListener("child-attached",(function(a){if(console.log("VRFunc.js: VRController: _loadAudio,: parent child-attached, el=",a),e.generalAttr.logic)t.blockly=e.generalAttr.logic,t.setAttribute("sound","autoplay: false");else{let a=!0;t.object3D.traverseAncestors((function(r){if("Scene"!=r.type)console.log("VRFunc.js: VRController: _loadAudio,: traverseAncestors: not Scene parent=",r),0==r.visible&&(a=!1);else if(1==a&&1==t.object3D.visible&&0==l&&1==i&&e.generalAttr.active)if(console.log("VRFunc.js: VRController: _loadAudio,: traverseAncestors: all parent visible true=",t.object3D),1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==r.location){t.setAttribute("sound","autoplay: false");let o=document.getElementById("clickToPlayAudio");function n(){t.components.sound.playSound(),o.style.display="none",o.removeEventListener("click",n),window.allowAudioClicked=!0}o.style.display="block",o.addEventListener("click",n)}else t.setAttribute("sound","autoplay: true"),j(e,t,l);else console.log("2 VRFunc.js: VRController: _loadAudio,: traverseAncestors: not all parent visible true=",t.object3D.children[0]),t.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(console.log("VRFunc.js: _loadAudio: no parent set autoplay true",t.object3D,location),e.generalAttr.logic)t.blockly=e.generalAttr.logic,t.setAttribute("sound","autoplay: false");else if(e.generalAttr.active)if(1==i&&0==l)if(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location){t.setAttribute("sound","autoplay: false");let m=document.getElementById("clickToPlayAudio");function p(){t.components.sound.playSound(),m.style.display="none",m.removeEventListener("click",p),window.allowAudioClicked=!0}m.style.display="block",m.addEventListener("click",p)}else t.setAttribute("sound","autoplay: true"),j(e,t,l);else t.setAttribute("sound","autoplay: false"),t.setAttribute("visible",!1);else t.setAttribute("sound","autoplay: false");n.vrScene.appendChild(t)}t.addEventListener("loaded",(function(a){a.target==a.currentTarget&&(console.log("3 VRFunc.js: VRController: _loadAudio,: loaded, soundEntity.object3D.children[0]=",t.object3D.children[0]),t.object3D.makarObject=!0,t.object3D.makarType="audio",e.behav&&(t.object3D.behav=e.behav,n.setObjectBehavAll(e)),e.behav_reference&&(t.object3D.behav_reference=e.behav_reference),s(t))})),d=!0}}else console.log("VRFunc.js: _loadAudio , obj url not exist ",e),e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",h(e,a,r,o,n.cubeTex),s(1)}))}))}function j(e,t,a){0==e.generalAttr.active||a?t.setAttribute("sound","autoplay: false"):e.typeAttr&&(null!=e.typeAttr.is_play&&t.setAttribute("sound",`autoplay: ${e.typeAttr.is_play}`),null!=e.typeAttr.is_loop&&t.setAttribute("sound",`loop: ${e.typeAttr.is_loop}`),null!=e.typeAttr.volume&&t.setAttribute("sound",`volume: ${e.typeAttr.volume}`))}function D(e,a,r,o){let s=this;return n(e),new Promise((function(n){t(e.res_url,(function(t){if(1==t){var i=(new THREE.TextureLoader).load(e.res_url);let c,d,u,m,p,_=e.res_url.split(".").length,h=e.res_url.split(".")[_-1].toLowerCase();if("png"==e.sub_type||"jpg"==e.sub_type||"jpeg"==e.sub_type||"bmp"==e.sub_type)h=e.sub_type,c=document.createElement("a-plane"),c.setAttribute("src",e.res_url);else if("gif"==e.sub_type)h=e.sub_type,c=document.createElement("a-entity");else{if("button"!=e.sub_type)return console.log("VRFunc.js: _loadTexture: sub_type empty, create empty plane "),c=document.createElement("a-plane"),void n(c);"png"!=h&&"jpg"!=h&&"jpeg"!=h&&(h="png"),c=document.createElement("a-plane"),c.setAttribute("src",e.res_url)}c.setAttribute("id",e.generalAttr.obj_id),c.setAttribute("crossorigin","anonymous");let g=!1;if(makarUserData.scenesData.scenes[s.sceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[s.sceneIndex].behav)&&(p=makarUserData.scenesData.scenes[s.sceneIndex].behav.find((t=>t.obj_id==e.generalAttr.obj_id&&"Transparent"==t.behav_type)),p&&(console.log("%c ImageModule.js _loadImage: transparentBehav=","color:BlanchedAlmond;",p),g=!0,[d,u,m]=[p.color,p.slope,p.threshold])),g&&p){let y=d.split(","),f=new THREE.Color(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));function v(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let w=v(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));w[0]/=360,console.log(`rgb: ${y} ,\n _hsv: (${w})`),"jpg"==h||"jpeg"==h||"png"==h?"RGB"==p.mode?c.setAttribute("material","shader: chromaKey; color: #"+f.getHexString()+";transparent: true; side:double; depthWrite:false; _slope: "+parseFloat(u)+"; _threshold: "+parseFloat(m)+";"):"HSV"==p.mode&&c.setAttribute("material","shader: HSVMatting; transparent: true; side:double; depthWrite:false; _keyingColorH:"+w[0]+"; _keyingColorS:"+w[1]+"; _keyingColorV:"+w[2]+"; _deltaH:"+parseFloat(p.hue)+"; _deltaS:"+parseFloat(p.saturation)+"; _deltaV:"+parseFloat(p.brightness)+";"):"gif"==h&&("RGB"==p.mode?(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","shader:gif_RGB;  src: url("+e.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; color: #"+f.getHexString()+"; _slope: "+parseFloat(u)+"; _threshold: "+parseFloat(m)+";")):"HSV"==p.mode&&(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","shader:gif_HSV;  src: url("+e.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; _keyingColorH:"+w[0]+"; _keyingColorS:"+w[1]+"; _keyingColorV:"+w[2]+"; _deltaH:"+parseFloat(p.hue)+"; _deltaS:"+parseFloat(p.saturation)+"; _deltaV:"+parseFloat(p.brightness)+";")))}else"jpg"==h||"jpeg"==h||"png"==h?(c.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; depthWrite:false"),c.setAttribute("geometry","primitive: plane")):"gif"==h&&(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","side:double; shader:gif;  src: url("+e.res_url+"); opacity: 1; transparent: true; depthWrite:false"));e.behav?0==e.behav.length&&g?c.setAttribute("class","unclickable"):c.setAttribute("class","clickable"):e.generalAttr.logic?c.setAttribute("class","clickable"):c.setAttribute("class","unclickable"),l(c,a,r,o),s.makarObjects.push(c);let b=s.vrScene.renderer.capabilities.getMaxAnisotropy();if(c.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=b,e.detail.texture.needsUpdate=!0})),c.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){let t=setInterval((function(){i.image&&(c.object3D.children[0].scale.set(.01*i.image.width,.01*i.image.height,1),c.setAttribute("heightForQuiz",.01*i.image.height),window.clearInterval(t))}),1);c.object3D.children[0].material.reflectivity=0;let a=new THREE.Vector3;a.set(0,Math.PI,0),c.object3D.children[0].rotation.setFromVector3(a),c.object3D.children[0].renderOrder=1,c.object3D.makarObject=!0,c.object3D.makarType="image",e.behav&&(c.object3D.behav=e.behav,s.setObjectBehavAll(e)),e.behav_reference&&(c.object3D.behav_reference=e.behav_reference),"button"==e.main_type&&(c.object3D.main_type=e.main_type,c.object3D.sub_type=e.sub_type,c.setAttribute("class","clickable")),n(c)}else console.log("VRFunc.js: _loadTexture: loaded target different")})),0==e.generalAttr.active&&(c.setAttribute("visible",!1),c.setAttribute("class","unclickable")),console.log("VRFunc.js: _loadTexture: image behav_reference: ",e.behav_reference),e.generalAttr.obj_parent_id){let j=setInterval((function(){let t=document.getElementById(e.generalAttr.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(c),window.clearInterval(j))}),1)}else s.vrScene.appendChild(c)}else console.log("VRFunc.js: _loadTexture , obj url not exist ",e),e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",s.loadGLTFModel(e,a,r,o,s.cubeTex),n(1)}))}))}function E(e,t,a,r=null,o=null,n=null){let s=this;return new Promise((function(r){(new THREE.TextureLoader).load(e.res_url,(function(o){let n,i,l,c,d,u;if(console.log("VRFunc.js: _loadTexture2D: texture WH=",o.image.width,o.image.height),4==Object.keys(s.editor_version).length){let j;if(Number(s.editor_version.v0),Number(s.editor_version.v1),Number(s.editor_version.v2),j=m(),!(j.rectP&&j.rectSizeDelta&&j.rectScale))return void r(!1);n=j.rectP,i=j.rectSizeDelta,l=j.rectScale,c=j.rectR}else{let D=m();if(!(D.rectP&&D.rectSizeDelta&&D.rectScale))return void r(!1);n=D.rectP,i=D.rectSizeDelta,l=D.rectScale,c=D.rectR}function m(){let t,a,r,o,n={};if(e.transformAttr.rect_transform&&Array.isArray(e.transformAttr.rect_transform)&&e.transformAttr.rect_transform.length>0){Number.isFinite(s.selectedResolutionIndex)||(console.warn(" _getObj2DInfo350: error, missing _selectedResolutionIndex",s.selectedResolutionIndex),s.selectedResolutionIndex=0);let i=e.transformAttr.rect_transform[s.selectedResolutionIndex];if(i.position&&i.size_delta&&i.rotation&&i.scale){t=i.position.split(",").map((function(e){return Number(e)})),a=i.size_delta.split(",").map((function(e){return Number(e)})),r=i.scale.split(",").map((function(e){return Number(e)})),o=i.rotation.split(",").map((function(e){return Number(e)}));let e=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),s=(new THREE.Euler).setFromQuaternion(e,"YXZ"),l=new THREE.Vector3(s.x,s.y,s.z);l.z=-1*l.z,r.x=r[0],r.y=r[1],n={rectP:t,rectSizeDelta:a,rectScale:r,rectR:l}}}return n}o.flipY=!1,console.log("VRFunc.js: _loadTexture2D: innerWH , camera2D ",innerWidth,innerHeight,s.vrScene.clientWidth,s.vrScene.clientHeight);let p=s.scaleRatioXY;d=i[0]*p,u=i[1]*p,e.res_url;let _=e.sub_type,h=new THREE.Object3D;h.makarType="image2D";let g,b,y,f,v,w=!1;if(makarUserData.scenesData.scenes[s.sceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[s.sceneIndex].behav)&&(f=makarUserData.scenesData.scenes[s.sceneIndex].behav.find((t=>t.obj_id==e.generalAttr.obj_id&&"Transparent"==t.behav_type)),f)){console.log("%c  ImageModule.js _loadImage: transparentBehav=","color:BlanchedAlmond;",f),w=!0;let E=f.color.split(",");g=[parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2])],b=f.slope,y=f.threshold}if(w&&f){function A(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let k,R=A(g[0],g[1],g[2]);if(R[0]/=360,console.log(`rgb: ${g} ,\n _hsv: (${R})`),"jpg"==_||"jpeg"==_||"png"==_||"button"==_)"RGB"==f.mode?k=new THREE.ChromaKeyMaterial({map:o,keyColor:g,side:THREE.DoubleSide,slope:b,threshold:y}):"HSV"==f.mode&&(k=new THREE.HSVMattingMaterial({map:o,side:THREE.DoubleSide,_keyingColorH:R[0],_keyingColorS:R[1],_keyingColorV:R[2],_deltaH:f.hue,_deltaS:f.saturation,_deltaV:f.brightness})),v=new THREE.Mesh(new THREE.PlaneBufferGeometry(d,u,0),k);else if("gif"==_){v=document.createElement("a-entity"),v.setAttribute("material","side:double; shader:gif;  src: url("+e.res_url+"); opacity: 1; transparent: true; depthWrite:false; visible: false; ");let T=new THREE.Color(parseFloat(g[0]),parseFloat(g[1]),parseFloat(g[2]));console.log("three color",T),"RGB"==f.mode?(v.setAttribute("geometry","primitive: plane; width:"+d+"; height:"+u+";"),v.setAttribute("material","shader:gif_RGB;  src: url("+e.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; color: #"+T.getHexString()+"; _slope: "+parseFloat(b)+"; _threshold: "+parseFloat(y)+";")):"HSV"==f.mode&&(v.setAttribute("geometry","primitive: plane; width:"+d+"; height:"+u+";"),v.setAttribute("material","shader:gif_HSV;  src: url("+e.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; _keyingColorH:"+R[0]+"; _keyingColorS:"+R[1]+"; _keyingColorV:"+R[2]+"; _deltaH:"+parseFloat(f.hue)+"; _deltaS:"+parseFloat(f.saturation)+"; _deltaV:"+parseFloat(f.brightness)+";"))}}else"jpg"==_||"jpeg"==_||"png"==_||"button"==_?v=new THREE.Mesh(new THREE.PlaneBufferGeometry(d,u,0),new THREE.MeshBasicMaterial({map:o,side:THREE.DoubleSide,transparent:!0})):"gif"==_&&(v=document.createElement("a-entity"),v.setAttribute("geometry","primitive: plane; width:"+d+"; height:"+u+";"),v.setAttribute("material","side:double; shader:gif;  src: url("+e.res_url+"); opacity: 1; transparent: true; depthWrite:false; visible: false; "));if(e.behav&&(h.behav=e.behav,s.setObjectBehavAll(e)),0==e.generalAttr.active&&(h.visible=!1),h.makarObject=!0,h.obj_id=e.generalAttr.obj_id,"button"==e.main_type&&(h.sub_type=e.sub_type),e.generalAttr.obj_parent_id){let S=function(){let o=!1;for(let t=0;t<s.makarObjects2D.length;t++)s.makarObjects2D[t].obj_id==e.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(S,500),console.log("______VRFunc.js: _loadTexture2D: isParentSet   ",e,s.makarObjects2D);else for(let o=0;o<s.makarObjects2D.length;o++)s.makarObjects2D[o].obj_id==e.generalAttr.obj_parent_id&&(h.scale.set(l.x,l.y,1),h.translateX(n[0]*p),h.translateY(-n[1]*p),h.translateZ(t/a-1),h.rotateZ(c.z),"gif"==_?(v.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){if(v&&v.object3D&&v.object3D.children&&1==v.object3D.children.length&&v.object3D.children[0]&&v.object3D.children[0].material){let t=v.object3D.children[0].material;if(t&&t.map&&t.map.image&&t.map.image.width>2&&t.map.image.height>2&&(t.map.flipY=!1),v&&v.gif&&v.gif.self&&v.gif.self.__texture){v.gif.self.__texture.flipY=!1;let e=s.vrScene.renderer.capabilities.getMaxAnisotropy();e&&(v.gif.self.__texture.anisotropy=e,v.gif.self.__texture.needsUpdate=!0)}t.visible=!0,h.add(v.object3D),s.makarObjects2D[o].add(h),s.makarObjects2D.push(h),h.makarObject=!0,h.obj_id=e.generalAttr.obj_id,v.removeFromParent(),v.remove(),r(h)}}else console.log("_loadTexture2D: loaded target different")})),s.vrScene.appendChild(v)):(h.add(v),s.makarObjects2D[o].add(h),s.makarObjects2D.push(h),r(h),console.log("______VRFunc.js: _loadTexture2D: parent exit, set obj(parent) ",e,v,s.makarObjects2D.slice(),performance.now())))};S()}else console.log("VRFunc.js: VRController: _loadTexture2D: obj() ",e),h.scale.set(l.x,l.y,1),h.translateX(n[0]*p),h.translateY(-n[1]*p),h.translateZ(t/a-1),h.rotateZ(c.z),s.makarObjects2D.push(h),s.scene2D.add(h),"gif"==_?(v.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){if(console.log("_loadTexture2D: gif loaded target same"),v&&v.object3D&&v.object3D.children&&1==v.object3D.children.length&&v.object3D.children[0]&&v.object3D.children[0].material){let t=v.object3D.children[0].material;if(t&&t.map&&t.map.image&&t.map.image.width>2&&t.map.image.height>2&&(t.map.flipY=!1),v&&v.gif&&v.gif.self&&v.gif.self.__texture){v.gif.self.__texture.flipY=!1;let e=s.vrScene.renderer.capabilities.getMaxAnisotropy();e&&(v.gif.self.__texture.anisotropy=e,v.gif.self.__texture.needsUpdate=!0)}t.visible=!0,h.add(v.object3D),h.makarObject=!0,h.obj_id=e.generalAttr.obj_id,v.removeFromParent(),v.remove(),r(h),console.log("______VRFunc.js: _loadTexture2D: self.makarObjects2D.slice()=",s.makarObjects2D.slice(),performance.now())}}else console.log("_loadTexture2D: loaded target different")})),s.vrScene.appendChild(v)):(h.add(v),h.makarObject=!0,h.obj_id=e.generalAttr.obj_id,r(h),console.log("______VRFunc.js: _loadTexture2D: self.makarObjects2D.slice()=",s.makarObjects2D.slice(),performance.now()))}),void 0,(function(e){console.error("An error happened. _loadTexture2D , err=",e)}))}))}function A(e,t,a,r){let o=this;return new Promise((function(n){console.log("VRFunc.js: _loadLight: obj=",e);let s=document.createElement("a-entity");s.setAttribute("id",e.generalAttr.obj_id);let i="type:"+e.typeAttr.light_type,c=e.typeAttr.color.split(",");if(i+="; color:#"+new THREE.Color(parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])).getHexString(),i+=";intensity:"+e.typeAttr.intensity,"point"!=e.typeAttr.light_type&&"spot"!=e.typeAttr.light_type||(i+=";distance:"+e.typeAttr.range,i+=";decay: 4"),"spot"==e.typeAttr.light_type&&(i+=";angle:"+(parseFloat(e.typeAttr.spotAngle)/2).toString(),i+=";penumbra: 0.2"),"None"!=e.typeAttr.shadow&&(s.setAttribute("castShadow",!0),i+=";castShadow: true ;shadowCameraVisible: false; shadowBias:-0.0005; shadowCameraTop:10; shadowCameraBottom:-10; shadowCameraRight:10; shadowCameraLeft:-10; shadowMapHeight:1024; shadowMapWidth:1024; shadowCameraFar: 500; shadowCameraNear: 0.5"),s.setAttribute("light",i),"directional"==e.typeAttr.light_type?(l(s,t,a,r),s.addEventListener("loaded",(function(e){if(s.object3D&&s.object3D.children&&s.object3D.children[0]&&"DirectionalLight"==s.object3D.children[0].type){s.object3D.makarObject=!0,s.object3D.makarType="light";let e=new THREE.Vector3(0,0,1),t=s.object3D.children[0].target;t.position.copy(e),s.object3D.children[0].add(t)}})),s.setAttribute("castShadow",!1),s.setAttribute("light","castShadow: false; ")):"spot"==e.typeAttr.light_type?(l(s,t,a,r),console.log("3.5 rotation in loadLight spotLight",a),s.addEventListener("loaded",(function(e){if(s.object3D&&s.object3D.children&&s.object3D.children[0]&&"SpotLight"==s.object3D.children[0].type){let e=new THREE.Vector3(0,0,1),t=s.object3D.children[0].target;t.position.copy(e),s.object3D.children[0].add(t)}}))):"point"==e.typeAttr.light_type?l(s,t,a,r):(l(s,t,a,r),console.log("VRFunc.js: _loadLight: Unexpected light type!!  obj.typeAttr.light_type=",e.typeAttr.light_type)),0==e.generalAttr.active&&s.setAttribute("visible",!1),console.log("VRFunc.js: _loadLight: Light=",s),o.makarObjects.push(s),e.generalAttr.obj_parent_id){let t=setInterval((function(){let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(s),window.clearInterval(t))}),1)}else o.vrScene.appendChild(s);n(s)}))}function k(e,t,a,r,o=!1){return new Promise((n=>{let s=document.createElement("a-entity");l(s,t,a,r),s.setAttribute("id",e.generalAttr.obj_id),console.log("scaleRatioXY=",this.scaleRatioXY),o||this.makarObjects.push(s),e.behav||"button"==e.main_type||e.generalAttr.logic?s.setAttribute("class","clickable"):s.setAttribute("class","unclickable");let i=document.createElement("a-text");i.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),i.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let c=e.typeAttr.content.split("\n"),d=0;const u=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<c.length;e++){let t=0;for(let a=0;a<c[e].length;a++)m=c[e][a],u.test(m)?t+=1.6:c[e][a]==c[e][a].toUpperCase()&&c[e][a]!=c[e][a].toLowerCase()||c[e][a]==c[e][a].toLowerCase()&&c[e][a]!=c[e][a].toUpperCase()?t+=1:isNaN(1*c[e][a])?t+=1.25:t+=1;t>d&&(d=t)}var m;i.setAttribute("value",e.typeAttr.content),i.setAttribute("anchor","center"),i.setAttribute("align","left"),i.setAttribute("backcolor",e.typeAttr.back_color),i.setAttribute("textcolor",e.typeAttr.color),i.setAttribute("side","double");var p="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/";let _=[p+"1-msdf.json",p+"2-msdf.json",p+"3-msdf.json",p+"4-msdf.json",p+"5-msdf.json",p+"6-msdf.json",p+"7-msdf.json",p+"8-msdf.json",p+"9-msdf.json",p+"10-msdf.json",p+"11-msdf.json",p+"12-msdf.json"];i.setAttribute("font",_),i.setAttribute("negate","false"),i.setAttribute("crossorigin","anonymous");let h=e.typeAttr.color.split(","),g=new THREE.Color(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2]));i.setAttribute("color","#"+g.getHexString());let b=0;if(i.addEventListener("geometry-set",(function e(t){console.log("VRFunc.js: _loadText: textEntity geometry-set: evt=",t),0==b?b=1:1==b&&n(i),i.removeEventListener("geometry-set",e)})),i.addEventListener("loaded",(t=>{if(t.target==t.currentTarget){let t=new THREE.Vector3;t.set(0,Math.PI,0),i.object3D.rotation.setFromVector3(t),o?i.object3D.isTempTextObj=!0:s.object3D.makarObject=!0,e.behav&&(s.object3D.behav=e.behav,this.setObjectBehavAll(e)),e.behav_reference&&(s.object3D.behav_reference=e.behav_reference),"button"==e.main_type&&(s.object3D.main_type=e.main_type),0==b?b=1:1==b&&n(i)}})),s.appendChild(i),0==e.generalAttr.active&&(s.setAttribute("visible",!1),s.setAttribute("class","unclickable")),console.log(" VRFunc.js: _loadText: anchor= ",s.object3D,", obj=",e),e.generalAttr.obj_parent_id){let t=setInterval((function(){let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(s),window.clearInterval(t))}),100)}else this.vrScene.appendChild(s)}))}function R(e,t,a,r=null,o=null,n=null,s=!1){return new Promise(((r,o)=>{let n,i,l,c,d,u,m=()=>{let t,a,r,o,n={};if(e.transformAttr.rect_transform&&Array.isArray(e.transformAttr.rect_transform)&&e.transformAttr.rect_transform.length>0){Number.isFinite(this.selectedResolutionIndex)||(console.log(" _loadText2D: _getObj2DInfo350: error, missing _selectedResolutionIndex",this.selectedResolutionIndex),this.selectedResolutionIndex=0);let s=e.transformAttr.rect_transform[this.selectedResolutionIndex];if(s.position&&s.size_delta&&s.rotation&&s.scale){t=s.position.split(",").map((e=>Number(e))),a=s.size_delta.split(",").map((e=>Number(e))),r=s.scale.split(",").map((e=>Number(e))),o=s.rotation.split(",").map((e=>Number(e)));let e=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),i=(new THREE.Euler).setFromQuaternion(e,"YXZ"),l=new THREE.Vector3(i.x,i.y,i.z);l.z=-1*l.z,r.x=r[0],r.y=r[1],n={rectP:t,rectSizeDelta:a,rectScale:r,rectR:l}}}return n};if(4==Object.keys(this.editor_version).length){let e;if(Number(this.editor_version.v0),Number(this.editor_version.v1),Number(this.editor_version.v2),e=m(),!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void r(!1);n=e.rectP,i=e.rectSizeDelta,l=e.rectScale,c=e.rectR}else{let e=m();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void r(!1);n=e.rectP,i=e.rectSizeDelta,l=e.rectScale,c=e.rectR}console.log("_loadText2D: info: _rectAll= ",e.typeAttr.content,n,i,l,c);let p=this.scaleRatioXY;d=i[0]*p,u=i[1]*p,console.log("_loadText2D: info: wh = ",d,u,p);let _=0,h=e.typeAttr.content.split("\n");for(let e=0;e<h.length;e++)h[e].length>_&&(_=h[e].length);let g=d/_*1,b=u/h.length*.9,y=175*p,f=Math.min(g,b,y);console.log(" ******** ",e.typeAttr.content,f,_,"[",g,",",d,"]",", [",b,",",u,"], ",y);let v=new THREE.Object3D;v.makarType="text2D",e.behav&&(v.behav=e.behav,this.setObjectBehavAll(e)),0==e.generalAttr.active&&(v.visible=!1);let w=document.createElement("a-text");w.object3D.renderOrder=t,w.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),w.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let j=e.typeAttr.content.split("\n"),D=0;const E=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<j.length;e++){let t=0;for(let a=0;a<j[e].length;a++)A=j[e][a],E.test(A)?t+=1.6:j[e][a]==j[e][a].toUpperCase()&&j[e][a]!=j[e][a].toLowerCase()||j[e][a]==j[e][a].toLowerCase()&&j[e][a]!=j[e][a].toUpperCase()?t+=1:isNaN(1*j[e][a])?t+=1.25:t+=1;t>D&&(D=t)}var A;w.setAttribute("id",e.generalAttr.obj_id),w.setAttribute("value",e.typeAttr.content),w.setAttribute("width",.08*D),w.setAttribute("width",d),w.setAttribute("height",u),w.setAttribute("fontsize",f),w.setAttribute("wrap-count",D),w.setAttribute("anchor","center"),w.setAttribute("align","left"),w.setAttribute("baseline","center"),w.setAttribute("backcolor",e.typeAttr.back_color),w.setAttribute("textcolor",e.typeAttr.color),w.setAttribute("side","double");let k="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",R=[k+"1-msdf.json",k+"2-msdf.json",k+"3-msdf.json",k+"4-msdf.json",k+"5-msdf.json",k+"6-msdf.json",k+"7-msdf.json",k+"8-msdf.json",k+"9-msdf.json",k+"10-msdf.json",k+"11-msdf.json",k+"12-msdf.json"];w.setAttribute("font",R),w.setAttribute("negate","false"),w.setAttribute("crossorigin","anonymous");let T,S,x=e.typeAttr.color.split(","),C=new THREE.Color(parseFloat(x[0]),parseFloat(x[1]),parseFloat(x[2]));w.setAttribute("color","#"+C.getHexString()),document.getElementById("aTempScene")&&document.getElementById("aTempDiv")?S=document.getElementById("aTempScene"):(T=document.createElement("div"),T.style.display="none",S=document.createElement("a-scene"),S.setAttribute("id","aTempScene"),S.setAttribute("embedded",""),document.body.appendChild(T),T.appendChild(S)),S.appendChild(w),w.addEventListener("geometry-set",(function(e){let t=w.object3D;t&&(t.children[2]&&t.children[2],console.log("_loadText2D: textEntity geometry-set: textObject=",t,e)),r(v)})),w.addEventListener("loaded",(r=>{let o=w.object3D;if(v.add(o),o.rotation.x=Math.PI,o.scale.set(190,190,1),e.generalAttr.obj_parent_id){o.obj_parent_id=e.generalAttr.obj_parent_id;let r=()=>{let i=!1;for(let t=0;t<this.makarObjects2D.length;t++)this.makarObjects2D[t].obj_id==e.generalAttr.obj_parent_id&&(i=!0);if(0==i)setTimeout(r,200);else for(let r=0;r<this.makarObjects2D.length;r++)if(this.makarObjects2D[r].obj_id==e.generalAttr.obj_parent_id){v.add(o),v.translateX(n[0]*p),v.translateY(-n[1]*p),v.translateZ(t/a-1),v.rotateZ(c.z),v.scale.set(l.x,l.y,1),v.makarObject=!0,v.obj_id=e.generalAttr.obj_id,v.obj_parent_id=e.generalAttr.obj_parent_id,this.makarObjects2D[r].add(v),s||this.makarObjects2D.push(v);break}};r()}else v.add(o),v.translateX(n[0]*p),v.translateY(-n[1]*p),v.translateZ(t/a-1),v.rotateZ(c.z),v.scale.set(l.x,l.y,1),v.makarObject=!0,v.obj_id=e.generalAttr.obj_id,s||this.makarObjects2D.push(v),this.scene2D.add(v)}))}))}function T(e,a,r,o){let n=this;return new Promise((function(s){t(e.res_url,(function(t){if(1==t){let t=document.getElementById("makarAssets");var i;(i=document.createElement("video")).src=e.res_url,i.playsInline=!0,i.autoplay=!0,i.loop=!0,i.setAttribute("crossorigin","anonymous"),i.setAttribute("id",e.generalAttr.obj_id+"_"+e.res_id+"_"+n.loadSceneCount),t.appendChild(i),i.name4debug=e.generalAttr.obj_name,i.setAttribute("preload","auto"),window.Browser&&((null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(i.muted=!0),1==window.Browser.mobile&&(i.muted=!0,i.play())),i.onloadedmetadata=function(){var t,c;i.videoWidth>=i.videoHeight?(t=1,c=1*i.videoHeight/i.videoWidth):(t=1*i.videoWidth/i.videoHeight,c=1);let d,u,m,p,_=document.createElement("a-video"),h=!1;if(makarUserData.scenesData.scenes[n.sceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[n.sceneIndex].behav)&&(p=makarUserData.scenesData.scenes[n.sceneIndex].behav.find((t=>t.obj_id==e.generalAttr.obj_id&&"Transparent"==t.behav_type)),p&&(console.log("%c VideoModule.js _loadVideo: transparentBehav=","color:BlanchedAlmond;",p),h=!0,[d,u,m]=[p.color,p.slope,p.threshold])),h&&p){let y=d.split(",");var g=new THREE.Color(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));if("RGB"!=p.mode&&p.mode){if("HSV"==p.mode){function f(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let v=f(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));v[0]/=360,console.log(`rgb: ${y} ,\n _hsv: (${v})`),_.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+v[0]+"; _keyingColorS:"+v[1]+"; _keyingColorV:"+v[2]+"; _deltaH:"+p.hue+"; _deltaS:"+p.saturation+"; _deltaV:"+p.brightness+";")}}else _.setAttribute("material","shader: chromaKey; color: #"+g.getHexString()+";transparent: true; _slope: "+parseFloat(u)+"; _threshold: "+parseFloat(m)+";")}else _.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");e.behav?0==e.behav.length&&h?_.setAttribute("class","unclickable"):_.setAttribute("class","clickable"):e.generalAttr.logic?_.setAttribute("class","clickable"):_.setAttribute("class","unclickable"),_.setAttribute("id",e.generalAttr.obj_id),_.setAttribute("src","#"+e.generalAttr.obj_id+"_"+e.res_id+"_"+n.loadSceneCount),_.mp4Video=i;let b=n.vrScene.renderer.capabilities.getMaxAnisotropy();if(_.addEventListener("materialtextureloaded",(function(e){console.log("VRFunc.js: _loadVideo: _materialtextureloaded: videoPlane = ",_.object3D,e),e.detail.texture.anisotropy=b,e.detail.texture.needsUpdate=!0})),l(_,a,r,o),_.addEventListener("loaded",(function(a){if(a.target==a.currentTarget){_.object3D.children[0].scale.set(t,c,1);let a=new THREE.Vector3;a.set(0,-1*Math.PI,0),_.object3D.children[0].rotation.setFromVector3(a),_.object3D.makarObject=!0,_.object3D.makarType="video";const r={behav_type:"videoTogglePlayPause",obj_id:e.generalAttr.obj_id};e.behav?(_.object3D.behav=e.behav,_.object3D.behav.push(r),n.setObjectBehavAll(e)):_.object3D.behav=[r],_.setAttribute("class","clickable"),e.behav_reference&&(_.object3D.behav_reference=e.behav_reference),s(_)}})),n.makarObjects.push(_),0==e.generalAttr.active&&(_.setAttribute("visible",!1),_.setAttribute("class","unclickable")),e.generalAttr.obj_parent_id){i.autoplay=!1;let w=setInterval((function(){let t=document.getElementById(e.generalAttr.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(_),window.clearInterval(w),t.addEventListener("child-attached",(function(t){if(console.log("VRFunc.js: VRController: _loadVideo,: parent child-attached, el=",t),e.generalAttr.logic)_.blockly=e.generalAttr.logic,i.pause(),i.currentTime=0;else{let t=!0;_.object3D.traverseAncestors((function(a){"Scene"!=a.type?0==a.visible&&(t=!1):1==t&&1==_.object3D.visible?(console.log("VRFunc.js: VRController: _loadVideo,: traverseAncestors: all parent visible true=",_.object3D),i.autoplay=!0,i.play(),S(e,i),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==a.location?x(0,!0):1==window.Browser.mobile&&x(0,!1))):(console.log("VRFunc.js: VRController: _loadVideo,: traverseAncestors: not all parent visible true=",t,_.object3D.visible),i.muted=!1,i.autoplay=!1,i.pause(),i.currentTime=0)}))}})))}),1)}else e.generalAttr.logic?(_.blockly=e.generalAttr.logic,i.pause(),i.currentTime=0):(i.autoplay=!0,i.play(),S(e,i),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?x(0,!0):1==window.Browser.mobile&&x(0,!1))),n.vrScene.appendChild(_)}}else console.log("VRFunc.js: _loadVideo , obj url not exist ",e),e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",h(e,a,r,o,n.cubeTex),s(1)}))}))}function S(e,t,a=!1){0==e.generalAttr.active||a?(t.autoplay=!1,t.pause(),t.currentTime=0):e.typeAttr&&(null!=e.typeAttr.is_loop&&(t.loop=e.typeAttr.is_loop,window.Browser&&1==window.Browser.mobile&&"safari"!=window.Browser.name&&e.typeAttr.is_loop&&(t.loop=!1,t.addEventListener("ended",(function(){document.getElementsByTagName("a-video").length+window.vrController.makarObjects2D.filter((e=>"video2D"==e.makarType)).length==1?(t.muted=!1,t.currentTime=.1,t.play()):(t.muted=!0,t.currentTime=.1,t.play(),C())}),!1))),null!=e.typeAttr.volume&&(t.volume=e.typeAttr.volume))}function x(e,t=!1){console.log("dealVideoMuted");let a=document.getElementById("clickToPlayAudio");a.onclick=function(){a.setAttribute("didUserClick",!0),a.style.display="none",a.onclick=null,window.allowAudioClicked=!0,t?(z(!0),I(!0),C()):(console.log("isSafari=",t),function(e=!1,t=!1){let a=document.getElementsByTagName("a-video");Array.from(a).forEach((a=>{let r=a.mp4Video,o=!0;a.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(o=!1):1!=o||1!=a.object3D.visible||a.blockly||(console.log("解除靜音 3D影片",r.name4debug,r.currentTime),t&&(r.currentTime=.1),e&&(r.autoplay=!0,r.play()),r.muted=!1)}))}))}(!0),function(e=!1,t=!1){window.vrController.makarObjects2D.forEach((a=>{if("video2D"==a.makarType&&0!=a.children.length&&a.children[0].material&&a.children[0].material.map&&a.children[0].material.map.image&&"VIDEO"==a.children[0].material.map.image.tagName){const r=a.children[0].material.map.image;if(r){let o=!0;a.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(o=!1):1==o&&1==a.visible&&(console.log("解除靜音 2D影片",r.name4debug,r.currentTime),t&&(r.currentTime=.1),e&&(r.autoplay=!0,r.play()),r.muted=!1)}))}}}))}(!0))},a.getAttribute("didUserClick")?(console.log("user已允許聲音播放 (跳轉場景)"),z(!0),I(!0),C()):a.style.display="block"}function C(e){let t,a;e&&("a-video"==e.localName?t=e:"video2D"==e.makarType&&(a=e));let r=document.getElementsByTagName("a-video");console.log("VRFunc.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length);let o=window.vrController.makarObjects2D;if(t)for(let e=0;e<r.length;e++){let a=r[e],o=r[e].mp4Video;if(a==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play(),self.safariUnMutedVideo=t;else{let r=!0;a.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,a.object3D.visible,a),1==r&&1==a.object3D.visible&&0!=o.volume&&(o.muted=!0,o.autoplay=!0,o.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else if(!t&&a){z();let e=!0;a.traverseAncestors((function(t){if("Scene"!=t.type)0==t.visible&&(e=!1);else if(1==e&&1==a.visible){if("targetVideo2D"!=a.makarType)return;if(0==a.children.length)return;if(!a.children[0].material)return;if(!a.children[0].material.map)return;if(!a.children[0].material.map.image)return;if("VIDEO"==a.children[0].material.map.image.tagName){const e=a.children[0].material.map.image;e&&0!=e.volume&&(e.muted=!1,e.autoplay=!0,self.safariUnMutedVideo=a)}}}))}else if(!t&&!a){let e=!1;for(let t=0;t<r.length;t++){let a=r[t],o=r[t].mp4Video;const n=e=>!!(e.currentTime>=0&&!e.paused&&!e.ended&&e.readyState>2);if(!n(o)){console.log("mp4Video",n(o));continue}let s=!0;a.object3D.traverseAncestors((function(r){if("Scene"!=r.type)0==r.visible&&(s=!1);else if(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",t,s,a.object3D.visible,a),1==s&&1==a.object3D.visible&&!a.blockly&&0!=o.volume)if(0==e){console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",a.object3D.name4debug),o.muted=!1,o.autoplay=!0;const t=e=>!!(e.currentTime>=0&&!e.paused&&!e.ended&&e.readyState>=1);o&&(!!((n=o).currentTime>0&&!n.paused&&!n.ended&&n.readyState>2)||t(o))&&0!=o.volume&&o.play(),e=!0,self.safariUnMutedVideo=a}else console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",a.object3D),0!=o.volume&&(o.muted=!0,o.autoplay=!0,(e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2))(o)&&o.play());var n}))}0!=r.length&&0!=e||o.forEach((t=>{let a=!0;t.traverseAncestors((function(r){if("Scene"!=r.type)0==r.visible&&(a=!1);else if(1==a&&1==t.visible&&0==e){if("video2D"!=t.makarType)return;if(0==t.children.length)return;if(!t.children[0].material)return;if(!t.children[0].material.map)return;if(!t.children[0].material.map.image)return;if("VIDEO"==t.children[0].material.map.image.tagName){const a=t.children[0].material.map.image,r=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2),o=e=>!!(e.currentTime>=0&&!e.paused&&!e.ended&&e.readyState>=1);a&&(r(a)||o(a))&&0!=a.volume?(a.muted=!1,a.autoplay=!0,a.play(),e=!0,self.safariUnMutedVideo=t):(a.muted=!0,a.autoplay=!0,a.play())}}}))}))}}function I(e=!1){window.vrController.makarObjects2D.forEach((t=>{if("video2D"==t.makarType&&0!=t.children.length&&t.children[0].material&&t.children[0].material.map&&t.children[0].material.map.image&&"VIDEO"==t.children[0].material.map.image.tagName){const a=t.children[0].material.map.image;a&&(a.muted=!0,e&&a.play())}}))}function z(e=!1){let t=document.getElementsByTagName("a-video");Array.from(t).forEach((t=>{let a=t.mp4Video,r=!0;t.object3D.traverseAncestors((function(o){"Scene"!=o.type?0==o.visible&&(r=!1):1!=r||1!=t.object3D.visible||t.blockly||(a.muted=!0,e&&(console.log("拜託播阿",a.name4debug),a.play(),a.muted=!1))}))}))}function M(){window.vrController.makarObjects2D.forEach((e=>{if("video2D"==e.makarType&&0!=e.children.length&&e.children[0].material&&e.children[0].material.map&&e.children[0].material.map.image&&"VIDEO"==e.children[0].material.map.image.tagName){const a=e.children[0].material.map.image;if(a&&(t=a).currentTime>0&&!t.paused&&!t.ended&&t.readyState>2)try{a.pause()}catch(e){console.log("VideoModule.js, video pause error=",e)}}var t}))}function O(){let e=document.getElementsByTagName("a-video");Array.from(e).forEach((e=>{let t=e.mp4Video;if((a=t).currentTime>0&&!a.paused&&!a.ended&&a.readyState>2)try{t.pause()}catch(e){console.log("VideoModule.js, video pause error=",e)}var a}))}function B(e,t,a,r,o,n){let s=this;return new Promise((r=>{let o,i,l,c,d,u;if(4==Object.keys(s.editor_version).length){let e;if(Number(s.editor_version.v0),Number(s.editor_version.v1),Number(s.editor_version.v2),e=m(),!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void r(!1);o=e.rectP,i=e.rectSizeDelta,l=e.rectScale,c=e.rectR}else{let e=m();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void r(!1);o=e.rectP,i=e.rectSizeDelta,l=e.rectScale,c=e.rectR}function m(){let t,a,r,o,i={};if(e.transformAttr.rect_transform&&Array.isArray(e.transformAttr.rect_transform)&&e.transformAttr.rect_transform.length>0){Number.isFinite(s.selectedResolutionIndex)||(console.log(" _getObj2DInfo350: error, missing _selectedResolutionIndex"),s.selectedResolutionIndex=0);let l=e.transformAttr.rect_transform[s.selectedResolutionIndex];if(l.position&&l.size_delta&&l.rotation&&l.scale){t=l.position.split(",").map((function(e){return Number(e)})),a=l.size_delta.split(",").map((function(e){return Number(e)})),r=l.scale.split(",").map((function(e){return Number(e)})),o=l.rotation.split(",").map((function(e){return Number(e)}));let e=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),s=(new THREE.Euler).setFromQuaternion(e,"YXZ"),c=new THREE.Vector3(s.x,s.y,s.z);c.z=-1*c.z,n.x=r[0],n.y=r[1],i={rectP:t,rectSizeDelta:a,rectScale:r,rectR:c}}}return i}d=document.createElement("video"),d.src=e.res_url,d.playsInline=!0,d.autoplay=!0,d.loop=!0,d.setAttribute("crossorigin","anonymous"),d.setAttribute("id",e.generalAttr.obj_id+"_"+e.res_id+"_"+s.loadSceneCount),d.name4debug=e.generalAttr.obj_name,d.setAttribute("preload","auto"),window.Browser&&((null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(d.muted=!0),1==window.Browser.mobile&&(d.muted=!0,d.play())),u=new THREE.VideoTexture(d),u.colorSpace=THREE.SRGBColorSpace,u.flipY=!1,console.log("_loadVideo2D: mp4Texture",u),d.onloadedmetadata=function(){let l,m,p=s.scaleRatioXY;l=i[0]*p,m=i[1]*p;let _,h,g,b,y=new THREE.Object3D;y.makarType="video2D";let f,v=!1;if(makarUserData.scenesData.scenes[s.sceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[s.sceneIndex].behav)&&(b=makarUserData.scenesData.scenes[s.sceneIndex].behav.find((t=>t.obj_id==e.generalAttr.obj_id&&"Transparent"==t.behav_type)),b)){console.log("%c VideoModule.js _loadVideo: transparentBehav=","color:BlanchedAlmond;",b),v=!0;let j=b.color.split(",");_=[parseFloat(j[0]),parseFloat(j[1]),parseFloat(j[2])],h=b.slope,g=b.threshold}if(v&&b){let D;if("RGB"==b.mode)D=new THREE.ChromaKeyMaterial({map:u,keyColor:_,side:THREE.DoubleSide,slope:h,threshold:g});else if("HSV"==b.mode){function E(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let A=E(_[0],_[1],_[2]);A[0]/=360,console.log(`rgb: ${_} ,\n _hsv: (${A})`),D=new THREE.HSVMattingMaterial({map:u,side:THREE.DoubleSide,_keyingColorH:A[0],_keyingColorS:A[1],_keyingColorV:A[2],_deltaH:b.hue,_deltaS:b.saturation,_deltaV:b.brightness})}f=new THREE.Mesh(new THREE.PlaneBufferGeometry(l,m,0),D)}else f=new THREE.Mesh(new THREE.PlaneBufferGeometry(l,m,0),new THREE.MeshBasicMaterial({map:u,side:THREE.DoubleSide,transparent:!0}));const w={behav_type:"videoTogglePlayPause",obj_id:e.generalAttr.obj_id};if(e.behav?(y.behav=e.behav,y.behav.push(w),s.setObjectBehavAll(e)):y.behav=[w],0==e.generalAttr.active&&(y.visible=!1),y.makarObject=!0,y.obj_id=e.generalAttr.obj_id,e.generalAttr.obj_parent_id){d.autoplay=!1;let k=function(){let i=!1;for(let t=0;t<s.makarObjects2D.length;t++)s.makarObjects2D[t].obj_id==e.generalAttr.obj_parent_id&&(i=!0);if(0==i)setTimeout(k,500);else for(let i=0;i<s.makarObjects2D.length;i++)if(s.makarObjects2D[i].obj_id==e.generalAttr.obj_parent_id){y.scale.set(n.x,n.y,1),y.translateX(o[0]*p),y.translateY(-o[1]*p),y.translateZ(t/a-1),y.rotateZ(c.z),y.add(f),s.makarObjects2D[i].add(y),s.makarObjects2D.push(y);let l=!0;y.traverseAncestors((function(t){0==t.visible&&(l=!1),1==l&&1==y.visible?(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: all parent visible true=",y),d.autoplay=!0,d.play(),S(e,d),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==t.location?x(0,!0):1==window.Browser.mobile&&x(0,!1))):(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: not all parent visible true=",l),d.muted=!1,d.autoplay=!1,d.pause(),d.currentTime=0)})),r(y)}};k()}else console.log("______VRFunc.js: _loadTexture2D: obj() ",e),y.scale.set(n.x,n.y,1),y.translateX(o[0]*p),y.translateY(-o[1]*p),y.translateZ(t/a-1),y.rotateZ(c.z),d.autoplay=!0,S(e,d),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?x(0,!0):1==window.Browser.mobile&&x(0,!1)),s.makarObjects2D.push(y),s.scene2D.add(y),y.add(f),y.makarObject=!0,y.obj_id=e.generalAttr.obj_id,r(y)}}))}function P(e,t,a,r,o,n){const s=this;console.log("loadYoutubeNotSupport",e,t,a,r,o,n);let i=document.createElement("a-entity");if(e.behav||e.generalAttr.logic?i.setAttribute("class","clickable"):i.setAttribute("class","unclickable"),i.setAttribute("id",e.generalAttr.obj_id),i.setAttribute("crossorigin","anonymous"),i.setAttribute("shadow",""),0==e.generalAttr.active&&(i.setAttribute("visible",!1),i.setAttribute("class","unclickable")),l(i,r,o,n.multiplyScalar(.9)),s.makarObjects.push(i),i.addEventListener("loaded",(a=>{let r,o,n,l;i.object3D.makarObject=!0,i.object3D.makarType="youtube",e.behav&&(i.object3D.behav=e.behav),o=1.1,n=.65,r=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,.65,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),e.behav_reference&&(r.behav_reference=e.behav_reference),i.object3D.add(r),l=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,.65,0),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.1})),i.object3D.add(l),l.position.set(0,0,0),l.rotation.set(0,0,0),l.scale.set(.95,.95,.95);let c={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"youtube is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj_${s.currentSceneIndex}_${t}`,obj_name:e.generalAttr.obj_name+"_tempTexObj",obj_type:"3d",interactable:!1,obj_parent_id:e.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:["0,0,0","0,0,0,1","1,1,1"],rect_transform:[],simulated_rotation:"0,0,0"},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};s.loadText(c,new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),!0).then((e=>{const t=e.object3D.clone();i.object3D.add(t),t.position.set(0,0,.005)}))})),e.generalAttr.obj_parent_id){let t=setInterval((()=>{let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(i),window.clearInterval(t))}),1)}else s.vrScene.appendChild(i)}function V(e,t,a,r,o,n){const s=this;console.log("loadYoutubeNotSupport",e,t,a,r,o,n),console.log("呼叫 getObj2DTransform VC=",p);const i=p.getObj2DTransform(s.editor_version,e,t,a,r,o,n);let l,c,d,u,m,_;if(console.log("呼叫 getObj2DTransform trans=",i),!i)return!1;l=i.rectP,c=i.rectSizeDelta,d=i.rectScale,u=i.rectR,n.x=i.rectScale[0],n.y=i.rectScale[1];let h=s.scaleRatioXY;m=c[0]*h,_=c[1]*h;let g,b,y=new THREE.Object3D;y.makarObject=!0,y.makarType="youtube2D",y.obj_id=e.generalAttr.obj_id,e.behav&&(y.behav=e.behav),0==e.generalAttr.active&&(y.visible=!1),g=new THREE.Mesh(new THREE.PlaneBufferGeometry(m,_,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),b=new THREE.Mesh(new THREE.PlaneBufferGeometry(m,_,0),new THREE.MeshBasicMaterial({color:11184810,side:THREE.DoubleSide,transparent:!0,opacity:.1})),b.position.set(0,0,0),b.rotation.set(0,0,0),b.scale.set(.9,.9,.9),y.add(g),y.add(b);let f={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"youtube is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj2D_${s.currentSceneIndex}_${t}`,obj_name:e.generalAttr.obj_name+"_tempTextObj2D",obj_type:"2d",interactable:!1,obj_parent_id:e.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:[],rect_transform:[{scale:"1,1,1",position:"0,0,0",rotation:"0,0,0,1",size_delta:e.transformAttr.rect_transform[s.selectedResolutionIndex].size_delta,simulated_rotation:"0,0,0"}],simulated_rotation:""},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};if(s.loadText2D(f,t,a,null,null,null,!0).then((e=>{console.log("YT後文字 result",e),e.position.z=.01})),e.generalAttr.obj_parent_id){let r=()=>{let o=!1;for(let t=0;t<s.makarObjects2D.length;t++)s.makarObjects2D[t].obj_id==e.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(r,200);else for(let r=0;r<s.makarObjects2D.length;r++)if(s.makarObjects2D[r].obj_id==e.generalAttr.obj_parent_id){y.translateX(l[0]*h),y.translateY(-l[1]*h),y.translateZ(t/a-1),y.rotateZ(u.z),y.scale.set(d[0],d[1],1),y.makarObject=!0,y.obj_id=e.generalAttr.obj_id,y.obj_parent_id=e.generalAttr.obj_parent_id,s.makarObjects2D[r].add(y),s.makarObjects2D.push(y);break}};r()}else y.scale.set(n.x,n.y,1),y.translateX(l[0]*h),y.translateY(-l[1]*h),y.translateZ(t/a-1),y.rotateZ(u.z),s.scene2D.add(y),s.makarObjects2D.push(y)}function H(e,t,a,r){console.log("VRFunc.js: VRController: _loadCurve, obj=",e,t,a,r);let o=this;return n(e),new Promise((function(n){let s=document.createElement("a-entity"),i=document.createElement("a-entity");if(i.setAttribute("id",e.generalAttr.obj_id),i.setAttribute("crossorigin","anonymous"),l(i,t,a,r),o.makarObjects.push(s),o.makarObjects.push(i),s.appendChild(i),s.addEventListener("loaded",(function(t){for(let t=0;t<e.typeAttr.nodes.length-1;t++){let a,r;a=new THREE.CubicBezierCurve3((new THREE.Vector3).fromArray(e.typeAttr.nodes[t][1].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[t][2].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[t+1][0].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[t+1][1].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)));let o=new THREE.Color(16777215);o.setHex(16777215*Math.random()),r=new THREE.LineBasicMaterial({color:o});let n=new THREE.TubeGeometry(a,20,.1,2,!1),i=new THREE.MeshBasicMaterial({color:o,side:THREE.DoubleSide}),l=new THREE.Mesh(n,i);l.visible=!1,s.object3D.add(l)}if(e.typeAttr.is_cycle){let t,a;t=new THREE.CubicBezierCurve3((new THREE.Vector3).fromArray(e.typeAttr.nodes[e.typeAttr.nodes.length-1][1].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[e.typeAttr.nodes.length-1][2].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[0][0].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)),(new THREE.Vector3).fromArray(e.typeAttr.nodes[0][1].split(",").map((e=>Number(e)))).multiply(new THREE.Vector3(-1,1,1)));let r=new THREE.Color(16777215);r.setHex(16777215*Math.random()),a=new THREE.LineBasicMaterial({color:r});let o=new THREE.TubeGeometry(t,20,.1,2,!1),n=new THREE.MeshBasicMaterial({color:r,side:THREE.DoubleSide}),i=new THREE.Mesh(o,n);i.visible=!1,s.object3D.add(i)}n(s)})),i.addEventListener("loaded",(function(){let e=new THREE.Object3D;i.object3D.add(e)})),e.generalAttr.obj_parent_id){let t=setInterval((function(){let a=document.getElementById(e.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(s),window.clearInterval(t))}),100)}else o.vrScene.appendChild(s)}))}function F(e,t){let a=this,r=document.getElementById(e.bezier_id).parentNode.object3D,o=e.period;if(o<=0)return;let n=e.shift_position.split(",").map((e=>Number(e))),s=e.shift_rotation.split(",").map((e=>Number(e))),i=new THREE.Quaternion(s[0],s[1],s[2],s[3]),l=(new THREE.Euler).setFromQuaternion(i,"XYZ");i.setFromEuler(new THREE.Euler(l.x,-l.y,-l.z));let c=[],d=[],u=[],m=0;for(let e=0;e<r.children.length;e++)"Mesh"==r.children[e].type&&(u.push(r.children[e]),m+=r.children[e].geometry.parameters.path.getLength());let p,_,h=a.scenesData.scenes[t].objs,g=!1;for(let t=0;t<h.length;t++)h[t].generalAttr.obj_id==e.bezier_id&&(p=h[t]),h[t].generalAttr.obj_id==e.obj_id&&"camera"==h[t].res_id&&(g=!0);g&&(e.obj_id="camera_cursor"),_=document.getElementById(e.obj_id);for(let e=0;e<p.typeAttr.nodes.length;e++){let t=p.typeAttr.nodes[e][1].split(",").map((e=>Number(e))),a=p.typeAttr.nodes[e][3].split(",").map((e=>Number(e)));c.push(new THREE.Vector3(-a[0],a[1],a[2]).sub(new THREE.Vector3(-t[0],t[1],t[2])));let r=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),c[e].normalize());d.push(r)}p.typeAttr.is_cycle&&(c.push(c[0]),d.push(d[0]));let b,y,f,v=1e3*m/o,w=new THREE.Vector3,j=(new THREE.Vector3,new THREE.Vector3),D=new THREE.Vector3,E=new THREE.Vector3,A=new THREE.Matrix4,k=new THREE.Quaternion,R=function(e){let t,a=new Array(e),r=new Array(e),o=0,n=0,s=0,i=u[n].geometry.parameters.path.getLengths(u[n].geometry.parameters.path.getLength()/m*e);for(let l=0;l<e;l++){l>(s+u[n].geometry.parameters.path.getLength())/m*e&&(s+=u[n].geometry.parameters.path.getLength(),n+=1,i=u[n].geometry.parameters.path.getLengths(u[n].geometry.parameters.path.getLength()/m*e)),t=u[n].geometry,o=(l-s/m*e)/(u[n].geometry.parameters.path.getLength()/m*e),t.parameters.path.getPoint(o,D),w=t.parameters.path.getTangent(o),w.multiply(new THREE.Vector3(-1,-1,-1));let c=d[n].clone();c.slerp(d[n+1],i[Math.floor(o*(u[n].geometry.parameters.path.getLength()/m*e))]/t.parameters.path.getLength()),j.set(0,1,0),j.applyQuaternion(c),a[l]=D.clone(),E.copy(D).add(w),A.lookAt(D,E,j),k.setFromRotationMatrix(A),r[l]=k.clone()}return[a,r]}(3e3),T=!1;if("Direct"==e.trigger_type)T=!0;else{let t=document.getElementById(e.trigger_id);t.setAttribute("class","clickable"),null==t.object3D.behav&&(t.object3D.behav=[]),t.object3D.behav.push({trigger_type:"Click",trigger_obj_id:e.trigger_id,behav_type:"MoveAlongPath",switch_type:"On",obj_id:e.obj_id,group:"",reset:!1})}let S=new THREE.Quaternion;_.parentNode.object3D.getWorldQuaternion(S);var x={ratio:0};let C=anime({targets:x,ratio:3e3,loop:e.loop,easing:"linear",round:1,duration:v,autoplay:T,begin:function(){if(y=_.object3D.position.clone(),f=_.object3D.quaternion.clone(),g){let e=document.getElementById("aCamera");b=e.object3D.position.clone(),e.object3D.position.set(0,0,0),"model"==a.viewMode&&(document.getElementById("oCamera").setAttribute("camera","active",!1),e.setAttribute("camera","active",!0))}},update:function(){let e=R[0][x.ratio-1].clone();_.parentNode.object3D.worldToLocal(e),e.add(new THREE.Vector3(-n[0],n[1],n[2]));let t=R[1][x.ratio-1].clone();t.premultiply(S.clone().inverse()),t.multiply(i),_.object3D.position.copy(e),g||_.object3D.quaternion.copy(t)},complete:function(){if(_.object3D.position.copy(y),_.object3D.quaternion.copy(f),g&&(document.getElementById("aCamera").object3D.position.copy(b),"model"==a.viewMode)){let e=document.getElementById("aCamera");document.getElementById("oCamera").setAttribute("camera","active",!0),e.setAttribute("camera","active",!1)}}});_.object3D.bezier=C}const L=class{getProjectIdx(){}addTextToScene(){}addTextureToScene(){}addGLTFModelToScene(){}addAudioToScene(){}addVideoToScene(){}pushObjectToMakarObjects(){}setTransform(){}appendToVrScene(){}initTest(){console.log("AddObjectToVrController.initTest: ",window.vrController)}};class U extends L{type="Quiz";obj_id;obj_type;isButtonPushed=!1;isPlaying=!0;isPlayed=!1;module={};currentProjData={};record=[];constructor(e){super(),this.obj_id=e.generalAttr.obj_id,this.obj_type=e.generalAttr.obj_type,window.vrController&&(this.currentProjData.user_id=window.vrController.currentProjData.user_id,this.currentProjData.proj_id=window.vrController.currentProjData.proj_id,this.currentProjData.head_pic=window.vrController.currentProjData.head_pic,this.currentProjData.loc=window.vrController.currentProjData.loc,this.currentProjData.module_type=window.vrController.currentProjData.module_type,this.currentProjData.name=window.vrController.currentProjData.name,this.currentProjData.proj_cover_urls=window.vrController.currentProjData.proj_cover_urls,this.currentProjData.proj_name=window.vrController.currentProjData.proj_name,this.currentProjData.shared_id=window.vrController.currentProjData.shared_id,this.currentProjData.snapshot_url=window.vrController.currentProjData.snapshot_url),this.module=e.typeAttr.module}addTextToScene(e,t,a,r,o=0,n=1){return"3d"==e.generalAttr.obj_type?window.vrController.loadText(e,t,a,r):window.vrController.loadText2D(e,o,n,t,a,r)}addTextureToScene(e,t,a,r,o=0,n=1){return"3d"==e.generalAttr.obj_type?window.vrController.loadTexture(e,t,a,r):window.vrController.loadTexture2D(e,o,n,t,a,r)}addGLTFModelToScene(e,t,a,r){if("3d"==e.generalAttr.obj_type)return window.vrController.loadGLTFModel(e,t,a,r,vrController.cubeTex);console.log("%c quiz loadGLTFModel: quiz currently does not support GLTFModel in 2D scene.","color:tomato;")}addAudioToScene(e,t,a,r){if("3d"==e.generalAttr.obj_type)return window.vrController.loadAudio(e,t,a,r);console.log("%c quiz loadAudio: quiz currently does not support Audio in 2D scene.","color:tomato;")}addVideoToScene(e,t,a,r,o=0,n=1){return"3d"==e.generalAttr.obj_type?window.vrController.loadVideo(e,t,a,r):window.vrController.loadVideo2D(e,o,n,t,a,r)}pushToMakarObjects(e){window.vrController.makarObjects.push(e)}pushToMakarObjects2d(e){window.vrController.makarObjects2D.push(e)}setTransform(e,t,a,r){window.vrController.setTransform(e,t,a,r)}appendToVrScene(e,t){if(t.generalAttr.obj_parent_id){let a=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(e),window.clearInterval(a))}),1)}else window.vrController.vrScene.appendChild(e)}appendToVrScene2d(e,t){if(t.generalAttr.obj_parent_id){let a=setInterval((function(){let r=null;for(let e=0;e<window.vrController.makarObjects2D.length;e++)window.vrController.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(r=window.vrController.makarObjects2D[e]);r&&r.children.length>0&&(r.add(e.object3D),window.clearInterval(a))}),10)}else window.vrController.scene2D.add(e.object3D)}clearObject(){if("3d"==this.obj_type){let e=[],t=this.module.quizEntity;for(let a of t.children)e.push(a);e.forEach((e=>{for(let t=0;t<window.vrController.makarObjects.length;t++)if(window.vrController.makarObjects[t].id==e.id){let e=window.vrController.makarObjects[t];if(e.getAttribute("src")){let t=e.getAttribute("src").split("#")[1];document.getElementById(t)&&document.getElementById(t).remove()}e.remove(),window.vrController.makarObjects.splice(t,1)}}))}else if("2d"==this.obj_type){let e=this.module.quizEntity.object3D.children;e.forEach((e=>{vrController.makarObjects2D=vrController.makarObjects2D.filter((t=>t!==e))})),e.length=0}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}setTypesFromUserRes(e){if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[e.res_id])makarUserData.userProjResDict[e.res_id].res_url&&(e.res_url=makarUserData.userProjResDict[e.res_id].res_url),makarUserData.userProjResDict[e.res_id].main_type&&(e.main_type=makarUserData.userProjResDict[e.res_id].main_type),makarUserData.userProjResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userProjResDict[e.res_id].sub_type);else if(makarUserData.userOnlineResDict[e.res_id])makarUserData.userOnlineResDict[e.res_id].res_url&&(e.res_url=makarUserData.userOnlineResDict[e.res_id].res_url),makarUserData.userOnlineResDict[e.res_id].main_type&&(e.main_type=makarUserData.userOnlineResDict[e.res_id].main_type),makarUserData.userOnlineResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userOnlineResDict[e.res_id].sub_type);else{switch(s(e),e.res_id){case"Text":e.main_type=e.res_id.toLowerCase(),e.sub_type="txt";break;case"Button":e.main_type=e.res_id.toLowerCase(),e.main_type="button",e.sub_type="button";break;default:["Cube","Capsule","Sphere","ch_Bojue","ch_Fei","ch_Lina","ch_Poyuan","ch_Roger"].find((t=>t==e.res_id))?e.main_type="model":console.warn("Quiz.js: setTypesFromUserRes: main_type does not exist. obj=",e)}console.log("Quiz.js: setTypesFromUserRes: obj=",e)}else console.warn("Quiz.js: setTypesFromUserRes: userProjResDict or userOnlineResDict does not exist. obj=",e);return e}load(e,t,r,o){let n=document.createElement("a-entity");n.setAttribute("id",e.generalAttr.obj_id);let s=new THREE.Object3D;if("3d"==e.generalAttr.obj_type)this.pushToMakarObjects(n),n.addEventListener("loaded",(function(){s.obj_id=e.generalAttr.obj_id,s.makarType="quiz",s.makarObject=!0,n.object3D.add(s)}));else if("2d"==e.generalAttr.obj_type){let t=window.vrController.scaleRatioXY,a=window.vrController.selectedResolutionIndex;a||(a=0);let r=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[a].position.split(",").map((e=>Number(e)))),o=(new THREE.Vector4).fromArray(e.transformAttr.rect_transform[a].rotation.split(",").map((e=>Number(e)))),i=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[a].scale.split(",").map((e=>Number(e)))),l=new THREE.Quaternion(o.x,o.y,o.z,o.w),c=(new THREE.Euler).setFromQuaternion(l,"YXZ"),d=new THREE.Vector3(c.x,c.y,c.z);d.z=-1*d.z,s.obj_id=e.generalAttr.obj_id,s.makarType="quiz2D",s.makarObject=!0,n.object3D=s,s.translateX(r.x*t),s.translateY(-r.y*t),s.translateZ(1),s.rotateZ(d.z),s.scale.set(i.x,i.y,1),this.pushToMakarObjects2d(s)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");e.behav&&(s.behav=e.behav,self.setObjectBehavAll(e)),s.visible=!0,0==e.generalAttr.active&&(s.visible=!1);let i=[];for(let t=0;t<e.typeAttr.module.question_list.length;t++)e.typeAttr.module.question_list[t].allowRandom&&i.push(t);if(!e.typeAttr.module.display_order_list||0==e.typeAttr.module.display_order_list.length)return void console.warn("Quiz.js _load: ERROR - user has not set display_order_list. obj.typeAttr.module=",e.typeAttr.module);let l=0;for(let t=0;t<e.typeAttr.module.display_order_list.length;t++){let a=e.typeAttr.module.display_order_list[t].index;if(-1==a){let r=(c=i.length,Math.floor(Math.random()*Math.floor(c))),o=i[r];e.typeAttr.module.display_order_list[t].index=o,a=o,i.splice(r,1)}e.typeAttr.module.question_list[a].active_score&&(l+=1)}var c;let d=e.typeAttr.module.display_order_list[0].index,u=e.typeAttr.module.question_list[d],m=document.getElementById("timerContent"),p=-1;if("Total"==e.typeAttr.module.timer_type){p=e.typeAttr.module.total_time,document.getElementById("timerDiv").style.display="block";let t=Math.floor(p/3600),a=Math.floor((p-3600*t)/60),r=p-3600*t-60*a;m.textContent=t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==e.typeAttr.module.timer_type){p=u.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(p/3600),t=Math.floor((p-3600*e)/60),a=p-3600*e-60*t;m.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")}let _=document.getElementById("tipButtonDiv");u.show_tips?(_.style.display="block",_.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),a=document.getElementById("tipContent");e.style.display="block",a.textContent=u.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):_.style.display="none",this.module={json:e.typeAttr.module,quizEntity:n,currentIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:l,record:new Array(e.typeAttr.module.question_list.length),timer:{currentTimer:null,counter:p},record_time:0,qClock:Date.now()};let h=document.getElementById("scoreDiv");if(h.addEventListener("click",(()=>{h.style.display="none",this.nextQuestion()})),u.questions_json&&Array.isArray(u.questions_json))for(let e=0;e<u.questions_json.length;e++)this.loadQuestion(u.questions_json[e]);if(u.options_json&&Array.isArray(u.options_json)){for(let e=0;e<u.options_json.length;e++){let{pOption:t,sub_type:r}=this.loadOption(u.options_json[e]);if("button"!=r&&("MutiOption_Text"==u.option_type||"MutiOption_Image"==u.option_type)){if(0==a(t))continue;t.then((e=>{let t=e,a=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,0,0),o=new THREE.Vector3(1,1,1);if(new THREE.Quaternion,"MutiOption_Text"==u.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(t,a,r,o);break;case"2d":this.multiOptionTextCircle2d(t,a,r,o);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==u.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),t.getAttribute("heightForQuiz")&&(t.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(t,a,r,o),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(t,a,r,o);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}if(this.module.timer.counter>=0){this.module.qClock=Date.now();let t=setInterval((()=>{this.module.timer.currentTimer=t,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let a=Math.floor(this.module.timer.counter/3600),r=Math.floor((this.module.timer.counter-3600*a)/60),o=this.module.timer.counter-3600*a-60*r;if(m.textContent=a.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0"),0==this.module.timer.counter)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==e.typeAttr.module.timer_type)if(u.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let a=window.aQuizVR.UIs.startQuiz,r=document.getElementById("QuizStartButton"),o=document.getElementById("QuizStartContent");a.style.display="block",o.textContent="時間到";let n={question:d,get_score:0,answer_time:this.module.json.question_list[d].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[d]=n,this.record[d]=n,this.module.record_time+=this.module.json.question_list[d].time_limit,this.module.qClock=Date.now(),r.addEventListener("click",(()=>{a.style.display="none",this.saveQuizStatus()}))}}),1e3)}"3d"==e.generalAttr.obj_type?(this.setTransform(n,t,r,o),this.appendToVrScene(n,e)):(this.setTransform(n,t,r,o),this.appendToVrScene2d(n,e))}else console.warn("_quiz _load: data might be incorrect, first_question.options_json=",u.options_json)}loadQuestion(e){let t=p.getObjTransform(window.vrController.scenesData,e),a=t.position,r=t.rotation,o=t.scale;if(t.quaternion,"3d"==e.generalAttr.obj_type)console.log("Quiz _loadQuestion VC objTranform",a,r,o);else if("2d"==e.generalAttr.obj_type){let e=window.vrController.selectedResolutionIndex;window.vrController.selectedResolutionIndex||(e=0)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let n,s=this.setTypesFromUserRes(e);switch(s.main_type){case"text":n=this.addTextToScene(s,a,r,o);break;case"image":n=this.addTextureToScene(s,a,r,o,0,1);break;case"video":n=this.addVideoToScene(s,a,r,o);break;case"model":n=this.addGLTFModelToScene(s,a,r,o);break;case"audio":n=this.addAudioToScene(s,a,r,o)}return n}loadOption(e){let t=p.getObjTransform(window.vrController.scenesData,e),a=t.position,r=t.rotation,o=t.scale;if(t.quaternion,"3d"==e.generalAttr.obj_type)console.log("Quiz loadOption VC objTranform",a,r,o);else if("2d"==e.generalAttr.obj_type){let e=window.vrController.selectedResolutionIndex;window.vrController.selectedResolutionIndex||(e=0)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let n=e;if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[n.res_id])makarUserData.userProjResDict[n.res_id].res_url&&(n.res_url=makarUserData.userProjResDict[n.res_id].res_url),makarUserData.userProjResDict[n.res_id].sub_type&&(n.sub_type=makarUserData.userProjResDict[n.res_id].sub_type);else if(makarUserData.userOnlineResDict[n.res_id])makarUserData.userOnlineResDict[n.res_id].res_url&&(n.res_url=makarUserData.userOnlineResDict[n.res_id].res_url),makarUserData.userOnlineResDict[n.res_id].sub_type&&(n.sub_type=makarUserData.userOnlineResDict[n.res_id].sub_type);else{switch(s(n),n.main_type="button",n.res_id){case"Text":n.main_type=n.res_id.toLowerCase(),n.sub_type="txt";break;case"Button":n.main_type=n.res_id.toLowerCase(),n.sub_type="button"}console.log("Quiz.js: loadOption: obj=",n)}else console.warn("Quiz.js: loadOption: userProjResDict or userOnlineResDict does not exist. obj=",n);if(n.behav){let e=!1;n.behav.forEach((t=>{"QuizOption"==t.behav_type&&(e=!0)})),e||n.behav.push({behav_type:"QuizOption"})}else n.behav=[{behav_type:"QuizOption"}];n.main_type="button";let i,l=n.sub_type;switch(l){case"txt":console.log("Quiz.js:  sub_type=",l),i=this.addTextToScene(n,a,r,o);break;case"gif":case"jpg":case"jpeg":case"png":i=this.addTextureToScene(n,a,r,o);break;case"button":n.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",i=this.addTextureToScene(n,a,r,o)}return{pOption:i,sub_type:l}}multiOptionTextCircle3d(e,t,a,r,o=25){let n=document.createElement("a-plane");n.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),n.setAttribute("id","circle_base"),n.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#2a2c31; depthWrite:false"),e.appendChild(n);let s=document.createElement("a-plane");s.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),s.setAttribute("id","circle_out"),s.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.appendChild(s);let i=document.createElement("a-plane");i.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),i.setAttribute("id","circle_in"),i.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),i.setAttribute("visible",!1),e.appendChild(i);let l=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};n.addEventListener("loaded",l),s.addEventListener("loaded",l),i.addEventListener("loaded",l);let c=2*Math.abs(e.getObject3D("mesh").geometry.attributes.position.array[0]);t.x=t.x+.5*c+.1/e.object3D.parent.el.getAttribute("scale").x,t.z=t.z-.01,n.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),s.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),i.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),e.object3D.parent.el.addEventListener("loaded",(()=>{let t=new THREE.Vector3(1,1,1).multiply(e.object3D.scale).multiply(e.object3D.parent.scale).multiply(e.object3D.parent.parent.scale),a=e.object3D.children[1].scale.clone().multiply(t),l=Math.max(a.x,a.y);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(l)),r.divide(e.object3D.parent.el.getAttribute("scale")),n.setAttribute("scale",r),s.setAttribute("scale",r),i.setAttribute("scale",r.multiplyScalar(.7))}))}multiOptionTextCircle2d(e,t,a,r,o=.5){let n=e.children[0].children[1],s=n.scale.clone(),i=e.children[0].getWorldScale(new THREE.Vector3),l=Math.max(s.x*n.geometry.parameters.width,s.y*n.geometry.parameters.height);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(l)),r.divide(i);let c=n.geometry.parameters.width*s.x,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(a){t.x=.5*-c-64*r.x;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));o.name="circle_base",o.position.copy(t.clone()),o.scale.copy(r.clone()),e.children[0].add(o);let n=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(r.clone().multiplyScalar(.7)),e.children[0].add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(a){t.x=.5*-c-64*r.x;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));o.name="circle_out",o.renderOrder=1,o.position.copy(t.clone()),o.scale.copy(r.clone().multiplyScalar(.9)),e.children[0].add(o)}))}multiOptionImageCircle3d(e,t,a,r,o=1){let n=e.object3D.getWorldScale(new THREE.Vector3),s=e.object3D.scale.clone(),i=Math.max(s.x,s.y);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(i)),r.divide(n);let l=e.object3D.children[0].scale.clone();t.y=.5*-r.y-.6*l.y;let c=document.createElement("a-plane");c.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),c.setAttribute("id","circle_base"),c.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#2a2c31; depthWrite:false"),this.setTransform(c,t,a,r),e.appendChild(c);let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),d.setAttribute("id","circle_out"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),this.setTransform(d,t,a,r),e.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id","circle_in"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),u.setAttribute("visible",!1),r.multiply(new THREE.Vector3(.7,.7,.7)),this.setTransform(u,t,a,r),e.appendChild(u);let m=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};c.addEventListener("loaded",m),d.addEventListener("loaded",m),u.addEventListener("loaded",m)}multiOptionImageCircle2d(e,t,a,r,o=.0025){let n=e.getWorldScale(new THREE.Vector3),s=e.scale.clone(),i=Math.max(s.x*e.children[0].geometry.parameters.width,s.y*e.children[0].geometry.parameters.height);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(i)),r.divide(n);let l=e.children[0].scale.clone(),c=e.children[0].geometry.parameters.height,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(a){t.y=l.y*c*.5+48*r.y;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));o.name="circle_base",o.position.copy(t.clone()),o.scale.copy(r.clone()),e.add(o);let n=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(r.clone().multiplyScalar(.7)),e.add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(a){t.y=l.y*c*.5+48*r.y;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));o.name="circle_out",o.renderOrder=1,o.position.copy(t.clone()),o.scale.copy(r.clone().multiplyScalar(.9)),e.add(o)}))}quizOption(e){if(window.aQuizVR.checkIs2DPictureShowing())return;if(this.isButtonPushed)return;let t,a=[],r=!1,o=0,n=this.module.json.display_order_list[this.module.currentIndex].index,s=this.module.json.question_list[n],i=this.module.json.score_type,l=document.getElementById("makarDragon"),c=document.getElementById("imgRight"),d=document.getElementById("imgWrong");if("3d"==this.obj_type?t="a-text"==e.localName?e.parentNode.id:e.id:"2d"==this.obj_type?t=e.obj_id:console.log("%c _quiz _quizOption: target=","color:tomato;",e),"Option_Text"==s.option_type||"Option_Image"==s.option_type){this.isButtonPushed=!0,null==s.answer_list&&(s.answer_list=[]);let e=s.answer_list[0],u=s.options_json[e-1];for(let e=0,r=s.options_json.length;e<r;e++)s.options_json[e].generalAttr.obj_id==t&&a.push(e);if(u&&u.generalAttr.obj_id==t){if(s.active_score)if("Custom"==i)this.module.score+=s.score,o=s.score;else if("Total"==i){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),o=Math.round(e/this.module.totalActiveScoreQuestion)}r=!0,l.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else r=!1,l.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer),setTimeout((()=>{l.style.display="none";let e={question:n,get_score:o,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:a,answer_cloze:"",answer_is_enable:!0,answer_is:r};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),s.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,s)}else{if("MutiOption_Text"!=s.option_type&&"MutiOption_Image"!=s.option_type)return;{console.log(" MutiOption_Text target",e);let u="3d"==this.obj_type?e.object3D:e;if(console.log(" MutiOption_Text targetObject",u),u.traverse((a=>{if("3d"==this.obj_type){if("Group"==a.type&&a.el&&"circle_in"==a.el.getAttribute("id")){let t,r=a.el;if(r.setAttribute("visible",!r.getAttribute("visible")),t="a-text"==e.localName?e.parentNode.id:e.id,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);console.log("Quiz.js: _pushButton: choices = ",this.module.choices)}else if("Group"==a.type&&a.el&&"circle_out"==a.el.getAttribute("id")){let e=a.el;"#7B7B7B"==e.getAttribute("material").color?e.setAttribute("material","color:#00d1c1;"):"#00d1c1"==e.getAttribute("material").color&&e.setAttribute("material","color:#7B7B7B;")}}else if("2d"!=this.obj_type||"text2D"!=e.makarType&&"image2D"!=e.makarType)console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");else if(a.isMesh){if("circle_in"==a.name)if(a.visible=!a.visible,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);"circle_out"==a.name&&("7b7b7b"==a.material.color.getHexString()?a.material.color.setStyle("#00d1c1"):"00d1c1"==a.material.color.getHexString()&&a.material.color.setStyle("#7b7b7b"))}})),"button"==u.sub_type){this.isButtonPushed=!0;let e=0;null==s.answer_list&&(s.answer_list=[]);for(let t of s.answer_list){let a=s.options_json[t];if(a)for(let t of this.module.choices)t==a.generalAttr.obj_id&&(e+=1)}for(let e=0,t=s.options_json.length;e<t;e++)for(let t=0,r=this.module.choices.length;t<r;t++)s.options_json[e].generalAttr.obj_id==this.module.choices[t]&&a.push(e-1);if(e==s.answer_list.length&&s.answer_list.length==this.module.choices.length){if(s.active_score)if("Custom"==i)this.module.score+=s.score,o=s.score;else if("Total"==i){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),o=Math.round(e/this.module.totalActiveScoreQuestion)}r=!0,l.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else r=!1,l.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer);let t=this.module.timer.counter;setTimeout((()=>{l.style.display="none",console.log("Quiz.js: _pushButton: ",this.module.json.question_list[n].time_limit,t,Math.round((Date.now()-this.module.qClock)/1e3));let e={question:n,get_score:o,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:a,answer_cloze:"",answer_is_enable:!0,answer_is:r};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),s.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,s)}}}}nextQuestion(){if(this.isButtonPushed=!1,this.module.choices=[],window.clearInterval(this.module.timer.currentTimer),this.clearObject(),this.module.currentIndex+=1,this.module.currentIndex<this.module.json.display_order_list.length){let e=this.module.json.display_order_list[this.module.currentIndex].index,t=this.module.json.question_list[e];"Custom"==this.module.json.timer_type&&(this.module.timer.counter=t.time_limit);let r=document.getElementById("tipButtonDiv");if(t.show_tips?(r.style.display="block",r.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),a=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=t.tips_content,a.addEventListener("click",(function(){e.style.display="none"}))}))):r.style.display="none",t.questions_json&&Array.isArray(t.questions_json))for(let e=0;e<t.questions_json.length;e++)this.loadQuestion(t.questions_json[e]);if(!t.options_json||!Array.isArray(t.options_json))return void console.warn("_quiz _load: data might be incorrect, first_question.options_json=",first_question.options_json);for(let e=0;e<t.options_json.length;e++){let{pOption:r,sub_type:o}=this.loadOption(t.options_json[e]);if("button"!=o&&("MutiOption_Text"==t.option_type||"MutiOption_Image"==t.option_type)){if(0==a(r))continue;r.then((e=>{let a=e,r=new THREE.Vector3(0,0,0),o=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1);if("MutiOption_Text"==t.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(a,r,o,n);break;case"2d":this.multiOptionTextCircle2d(a,r,o,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==t.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),a.getAttribute("heightForQuiz")&&(a.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(a,r,o,n),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(a,r,o,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}let o=document.getElementById("timerContent");if("Custom"==this.module.json.timer_type&&this.module.timer.counter>=0){let e=Math.floor(this.module.timer.counter/3600),t=Math.floor((this.module.timer.counter-3600*e)/60),a=this.module.timer.counter-3600*e-60*t;o.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")}setTimeout((()=>{if(this.module.timer.counter>=0){this.module.qClock=Date.now(),window.clearInterval(this.module.timer.currentTimer);let a=setInterval((()=>{this.module.timer.currentTimer=a,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let r=Math.floor(this.module.timer.counter/3600),n=Math.floor((this.module.timer.counter-3600*r)/60),s=this.module.timer.counter-3600*r-60*n;if(o.textContent=r.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0"),this.module.timer.counter<=0)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==this.module.json.timer_type)if(t.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let t=document.getElementById("tipButtonDiv"),a=document.getElementById("tipDiv");t.style.display="none",a.style.display="none";let r=window.aQuizVR.UIs.startQuiz,o=document.getElementById("QuizStartButton");document.getElementById("QuizStartContent").textContent="時間到",0==this.module.timer.counter&&(r.style.display="block");let n={question:e,get_score:0,answer_time:this.module.json.question_list[e].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[e]=n,this.record[e]=n,this.module.record_time+=this.module.json.question_list[e].time_limit,this.module.qClock=Date.now(),o.addEventListener("click",(()=>{r.style.display="none",this.saveQuizStatus()}))}}),1e3)}}),3e3)}else this.saveQuizStatus()}saveQuizStatus(){this.isPlayed=!0,window.clearInterval(this.module.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let a=document.getElementById("quizEndDiv");a.style.display="block",a.addEventListener("click",(function(){a.style.display="none"})),console.log("VRFunc.js: quiz end , this.module.record = ",this.module.record);let r="",o="";localStorage.getItem("MakarUserID")&&(r=localStorage.getItem("MakarUserID")),localStorage.getItem("device_id")&&(o=localStorage.getItem("device_id"));let n,s={user_id:this.currentProjData.user_id,playing_user:r,proj_id:this.currentProjData.proj_id,proj_type:"vr",device_id:o,module_id:"",brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0,module:[this.module.json],record_time:this.module.record_time,record_score:this.module.score,record:this.module.record};i.quizLog(s).then((e=>{console.log("_quizLog post to api: result=",e,"\n\n quizLogData=",s)})),i.getRecordModule(r,this.currentProjData.proj_id).then((e=>{e.data.record_module_list&&Array.isArray(e.data.record_module_list)&&e.data.record_module_list.length>0&&e.data.record_module_list[0].project_module&&(n=e.data.record_module_list[0].project_module);let t={head_pic:this.currentProjData.head_pic,loc:this.currentProjData.loc,module_type:this.currentProjData.module_type,name:this.currentProjData.name,playing_user_id:r,proj_cover_urls:this.currentProjData.proj_cover_urls,proj_id:this.currentProjData.proj_id,proj_name:this.currentProjData.proj_name,proj_type:"vr",snapshot_url:this.currentProjData.snapshot_url,user_id:this.currentProjData.user_id,project_module:n};n?n.playedQuizzes&&Array.isArray(n.playedQuizzes)?n.playedQuizzes.find((e=>e.obj_id==this.obj_id))||t.project_module.playedQuizzes.push({obj_id:this.obj_id,record:this.module.record}):t.project_module.playedQuizzes=[{obj_id:this.obj_id,record:this.module.record}]:(t.project_module={},t.project_module.playedQuizzes=[{obj_id:this.obj_id,record:this.module.record}]),i.updateRecordModule(t).then((e=>{console.log("_updateRecordModule post to api: result=",e,"\n\n quizRecord=",t)}))})),this.isPlaying=!1,console.log("Quiz.js: quiz end, quiz=",this)}}class G{quizData=[];loadedQuizzes=[];triggers=[];quizIdOpenDirectly=[];quizIdWithTriggers=[];currentlyTriggeredQuizId="";alreadyTriggeredQuizId="";constructor(){return G.exists?G.instance:(G.instance=this,G.exists=!0,this)}createQuiz(e){const t=e.generalAttr.obj_id;let a=this.getQuiz(t);if(a)return a;{const t=new U(e);return this.loadedQuizzes.push(t),t}}getQuiz(e){return this.loadedQuizzes.find((t=>t.obj_id===e))}getQuizProjectFromMDB=function(e){return parent.mdb.getQuizProject(e)};putQuizProjectToMDB=function(e){return parent.mdb.putQuizProject(e)};checkIs2DPictureShowing(){return this.loadedQuizzes.some((e=>e.isButtonPushed))}checkIsAnyQuizPlaying(){return this.loadedQuizzes.some((e=>1==e.isPlaying))}clear(){this.quizData=[],this.loadedQuizzes=[],this.triggers=[],this.quizIdOpenDirectly=[],this.quizIdWithTriggers=[],this.currentlyTriggeredQuizId="",this.alreadyTriggeredQuizId=""}saveQuizDataToMDB(e,t,a,r){let o={user_id:t,proj_id:a,device_id:r,obj_id:e,is_played:!0,type:"quiz",login_id:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"not logged in",date_time:(new Date).toString()};this.getQuizProjectFromMDB(a).then((t=>{if(0==Object.keys(t).length){let t={proj_id:a,quizzes:{}};t.quizzes[e]=o,this.putQuizProjectToMDB(t)}else{let a=t;t.quizzes||(a.quizzes={}),a.quizzes[e]=o,this.putQuizProjectToMDB(a)}})).catch((e=>{console.warn("Quiz.js _saveQuizDataToMDB: saveQuizDataToMDB but error:",e)}))}loadQuiz(e,t,a,r,o,n,s){let l=[];const c=t.position,d=t.rotation,u=t.scale;this.quizData.push(e);let m=o.startQuiz;if(0!=e.typeAttr.module.trigger.length){const t=e.typeAttr.module.trigger;this.triggers.push(t),this.quizIdWithTriggers.push({quiz_id:e.generalAttr.obj_id,trigger_id:t,force_login:e.typeAttr.module.force_login,allow_retry:e.typeAttr.module.allow_retry})}let p=o.QuizStartButton,_=o.QuizStartContent,h=()=>{if(0==e.typeAttr.module.trigger.length){let t=this.createQuiz(e);t.load(e,c,d,u),m.style.display="none",p.removeEventListener("click",h);const r=makarUserData.oneProjData.user_id,o=a,n=localStorage.getItem("device_id");this.saveQuizDataToMDB(t.obj_id,r,o,n)}else if(this.currentlyTriggeredQuizId&&this.currentlyTriggeredQuizId==e.generalAttr.obj_id)if(this.alreadyTriggeredQuizId==this.currentlyTriggeredQuizId);else{this.alreadyTriggeredQuizId=this.currentlyTriggeredQuizId;let t=this.createQuiz(e);t.load(e,c,d,u),m.style.display="none",p.removeEventListener("click",h);const r=makarUserData.oneProjData.user_id,o=a,n=localStorage.getItem("device_id");this.saveQuizDataToMDB(t.obj_id,r,o,n)}},g=function(){m.style.display="none"};window.serverUrl;const b=e.typeAttr.module.force_login,y=e.typeAttr.module.allow_retry,f=0==e.typeAttr.module.trigger.length;if(b&&y&&f&&r)_.textContent=n.clickToPlay[s],p.addEventListener("click",h),this.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent});else if(b&&y&&!f&&r)_.textContent=n.clickToPlay[s],p.addEventListener("click",h);else if(b&&!y&&f&&r){let e=w(r,a,f);l.push(e)}else if(b&&!y&&!f&&r){let e=w(r,a,f);l.push(e)}else if(b&&y&&f&&!r)v();else if(b&&y&&!f&&!r)v();else if(b&&!y&&f&&!r)v();else if(!b||y||f||r)if(!b&&y&&f)_.textContent=n.clickToPlay[s],p.addEventListener("click",h),this.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent});else if(b||!y||f)if(b||y||!f){if(!b&&!y&&!f){let e=j(a,f);l.push(e.pQuizGetMdbRecord)}}else{let e=j(a,f);l.push(e)}else _.textContent=n.clickToPlay[s],p.addEventListener("click",h);else v();function v(){_.textContent=n.userNotLoginInfo[s],p.addEventListener("click",g),window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent})}function w(t,a,r){return i.getRecordModule(t,a).then((t=>{if(0!=t.data.record_module_list.length){let a;t.data.record_module_list&&Array.isArray(t.data.record_module_list)&&t.data.record_module_list[0].project_module&&(a=t.data.record_module_list[0].project_module);let r=!1;a&&a.playedQuizzes&&Array.isArray(a.playedQuizzes)&&(r=a.playedQuizzes.find((t=>t.obj_id==e.generalAttr.obj_id))),r?(_.textContent=n.userAlreadyPlayed[s],p.addEventListener("click",g)):(_.textContent=n.clickToPlay[s],p.addEventListener("click",h))}else _.textContent=n.clickToPlay[s],p.addEventListener("click",h);r&&window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent})}))}function j(t,a){return parent.mdb.getProject(t,(t=>{if("done"==t.target.readyState&&t.target.result){if(t.target.result.quizzes){const r=e.generalAttr.obj_id;return t.target.result.quizzes[r]?(console.log("VRController.js: indexedDB.js _getProject: already have the project with same proj_id and the quiz have been played.",t.target.result,t.target.result.getAwardIndex),_.textContent=n.userAlreadyPlayed[s],p.addEventListener("click",g),a&&window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent}),t):(_.textContent=n.clickToPlay[s],p.addEventListener("click",h),a&&window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent}),t)}return _.textContent=n.clickToPlay[s],p.addEventListener("click",h),a&&window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent}),t}return _.textContent=n.clickToPlay[s],p.addEventListener("click",h),a&&window.aQuizVR.quizIdOpenDirectly.push({quiz_obj_id:e.generalAttr.obj_id,quizUiTextContext:_.textContent}),t}))}return l}}window.aQuizVR=new G;const Q=class{currentController;eventDispatchTarget;constructor(e,t){this.currentController=e,this.eventDispatchTarget=t}dispatchEvent(e,t=this.eventDispatchTarget){let a=this.genenrateCustomEvent(e);t.dispatchEvent(a)}genenrateCustomEvent(e){let t=new CustomEvent("MakarEvent",{detail:{behavType:e.behav_type,sourceID:e.trigger_obj_id,delay:e.delay,triggerType:e.trigger_type,typeAttr:{},_originalData:e}});const a={URL:{url:e.url,background:e.background},Dialing:{phone:e.phone},Email:{body:e.body,mailTo:e.mail_to,subject:e.subject},Animation:{uid:e.uid,loop:e.loop,reset:e.reset,towardID:e.obj_id},TTS:{pitch:e.pitch,speed:e.speed,language:e.language,towardID:e.obj_id},Scenes:{sceneID:e.scene_id,previousID:e.previousID},Skybox:{skyboxID:e.skybox_id,previousID:e.previousID},Display:{group:e.group,towardID:e.obj_id,switchType:e.switch_type,reset:e.reset},Facing:{isFront:e.is_front,towarID:e.toward_id}};return t.detail.typeAttr=a[e.behav_type],t}},N=class{GLRenderer=null;scene2D=null;camera2D=null;light=null;videoScene=null;videoCamera=null;scaleRatioXY=null;vrScene=null;makarVRscenes={};makarObjects=[];makarObjects2D=[];currentSceneMakarObjects=[];loadSceneCount=0;module=null;cursorEntity=null;projectIdx=null;intervalList=[];materials_texture_dict={};init_gyro=null;FUNCTION_ENABLED=!1;clock=new THREE.Clock;delta=this.time=0;triggerEnable=!1;touchMouseState=-1;groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}};lookAtTimelineDict={};loadingTickOn;editor_version=[];sceneIndex=0;type;currentProjData;scenesData;userOnlineResDict;userProjResDict;currentSceneIndex;safariUnMutedVideo;languageType;worldContent;domElement={loadPage:document.getElementById("loadPage"),homePage:document.getElementById("homePage"),startQuiz:document.getElementById("startQuiz"),gsapEmpty:document.getElementById("gsapEmpty")};makarEvents=new Q(self,vrDiv);constructor(e){if(this.type="VRController",e.oneProjData&&(this.currentProjData=e.oneProjData),e.scenesData&&(this.scenesData=e.scenesData),e.userOnlineResDict&&(this.userOnlineResDict=e.userOnlineResDict),e.userProjResDict&&(this.userProjResDict=e.userProjResDict),e.userMaterialDict&&(this.userMaterialDict=e.userMaterialDict),this.setTransform=l,this.loadSky=c,this.loadAudio=w,this.loadGLTFModel=h,this.loadWebViewNotSupport=f,this.loadWebViewNotSupport2D=v,this.loadText=k,this.loadText2D=R,this.loadTexture2D=E,this.loadTexture=D,this.loadLight=A,this.loadVideo=T,this.loadVideo2D=B,this.loadCurve=H,this.bezierPathAnime=F,this.UnMutedAndPlayAllVisibleVideo=C,this.mute2dVideos=I,this.mute3dVideos=z,this.pause2dVideos=M,this.pause3dVideos=O,this.loadYouTubeNotSupport=P,this.loadYouTubeNotSupport2D=V,this.languageType=window.languageType="tw",this.worldContent={userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"Please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"Confirm"}},window.makarSDK&&window.makarSDK.vrDiv){console.log("window.makarSDK.vrDiv",window.makarSDK.vrDiv);const e=new CustomEvent("vrControllerCreated",{detail:{name:"(for webSDK) vrController is created.",vrController:this,currentActiveController:this}});window.makarSDK.vrDiv.dispatchEvent(e)}}get2DScaleRatio(){let e,t,a,r=this,o="";if(4==Object.keys(this.editor_version).length){let e=Number(this.editor_version.v0),t=Number(this.editor_version.v1);Number(this.editor_version.v2),(e>3||3==e&&t>4)&&(o=n())}else o=n();function n(){let e="",t=r.vrScene.clientWidth,a=r.vrScene.clientHeight;if(makarUserData.oneProjData&&Array.isArray(makarUserData.oneProjData.orientation)){let o=makarUserData.oneProjData.orientation,n=1e3,s=0;o.forEach(((e,r)=>{let o=e.width/e.height/(t/a),i=e.width/t,l=e.height/a,c=o>1?o:1/o,d=i>1?i:1/i,u=l>1?l:1/l;e.nrdScore=c*(d+u),e.nrdScore<n&&(n=e.nrdScore,s=r)}));let i=o[s];r.selectedResolutionIndex=s,e=String(i.width)+","+String(i.height),console.log("VRController.js _get2DScaleRatio _getResolution350: ",n,s,i,e)}return e}if(""==o&&(console.log(" _get2DScaleRatio: fucking lose resolutionString "),o="720,1280"),""!=o){let n=o.split(","),s=Number(n[0]),i=Number(n[1]),l=r.vrScene.clientWidth,c=r.vrScene.clientHeight;if(t=Math.abs(r.camera2D.right-r.camera2D.left),a=Math.abs(r.camera2D.bottom-r.camera2D.top),t/a>=l/c)if(l/c>=s/i){e=c*(s/i)/s,console.log(" _loadTexture2D: 1 ",s,i,l,c,e)}else e=l/s,console.log(" _loadTexture2D: 2 ",s,i,l,c,e);else if(l/c>=s/i){let r=c*(s/i),o=c/(l*(a/t)),n=r/l,d=r/s;e=d,console.log(" _loadTexture2D: 3 ",s,i,l,c,e,o,n,d)}else{let r=c/(l*(a/t)),o=l*(i/s)/c,n=l/s;e=n,console.log(" _loadTexture2D: 4 ",s,i,l,c,e,r,o,n)}}else console.log(" fucking lose resolutionString ");return console.log(" _get2DScaleRatio: srxy=",e),e}set2DScaleRatio(e){this.scaleRatioXY=e}loadAssets(){let e=document.createElement("a-assets");e.setAttribute("id","makarAssets"),e.setAttribute("timeout","1000"),e.setAttribute("crossorigin","anonymous"),this.vrScene.appendChild(e)}clearAllSceneObjs(){let e=this;e.logic&&e.logic.stopLogic();let t=document.getElementsByTagName("video");if(t.length>0)for(let e=0;e<t.length;e++)t[e].pause(),t[e].removeAttribute("src"),t[e].load();let a=document.getElementsByTagName("audio");if(a.length>0)for(let e=0;e<a.length;e++)a[e].pause(),a[e].remove();if(e.makarObjects){for(let t=0;t<e.makarObjects.length;t++){let a=e.makarObjects[t];a.object3D&&(a.object3D.bezier&&a.object3D.bezier.pause(),a.object3D.traverse((e=>{e.isMesh&&(e.material&&(e.material.map&&e.material.map.dispose&&e.material.map.dispose(),e.material.dispose()),e.geometry&&e.geometry.dispose())}))),a.remove()}e.makarObjects.length=0}if(e.makarObjects2D){for(let t=0;t<e.makarObjects2D.length;t++){let a=e.makarObjects2D[t];a.isObject3D&&a.traverse((e=>{if(e.isMesh){if(e.material){if(e.material.map){if("VIDEO"==e.material.map.image.tagName){let t=e.material.map.image,a=0,r=0;a=setInterval((function(){r>=19?(t.volume=0,t.pause(),window.clearInterval(a)):t.volume-.05>=0&&(t.volume-=.05),r++}),20)}e.material.map.dispose&&e.material.map.dispose()}e.material.dispose()}e.geometry&&e.geometry.dispose()}})),e.scene2D.remove(a)}e.makarObjects2D.length=0}Array.isArray(e.currentSceneMakarObjects)&&(e.currentSceneMakarObjects.length=0),e.cubeTex&&(e.cubeTex.texture&&e.cubeTex.texture.dispose(),e.cubeTex.dispose());let r=document.getElementById("vrSky");r&&("a-sky"==r.localName||"a-videosphere"==r.localName)&&r.remove();for(let t=0;t<e.intervalList.length;t++)window.clearInterval(e.intervalList[t]);e.init_gyro=null,e.onlySkyScene=new THREE.Scene,e.cullFaceBackScene=new THREE.Scene,e.needsRenderTarget=!1,e.needsCullFaceBack=!1}loadScene(e){let a=this;a.currentSceneIndex=e;let r=[];if(r=p.getScenes(a.scenesData),console.log("3.5 merge loadscene",e),this.sceneIndex=e,null==r[e])console.log("VRFunc.js: VRController: _loadScene: error, [valid sceneIndex]=",a.scenesData,e);else{a.clearAllSceneObjs(),window.aQuizVR.clear();let o,n=p.getProjDataEditorVer(a.currentProjData);a.editor_version=n;let s={};if(3==n.v0&&n.v1>=5){let t="";if(r[e].environment&&r[e].environment.scene_skybox_res_id)if(t=r[e].environment.scene_skybox_res_id,a.userProjResDict[t]){let e=a.userProjResDict[t];"spherical_image"!=e.main_type&&"spherical_video"!=e.main_type||(s=e)}else s.main_type="spherical_image",s.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png"}o="spherical_video"==s.main_type?"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg":"spherical_image"==s.main_type?"DefaultResource/Spherical_Image/SphericalImage.png"==s.res_url?"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png":s.res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png",t(o,(function(t){let n;0==t&&(o="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg"),n=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let i=a.vrScene.renderer;THREE.GammaEncoding&&(i.outputEncoding=THREE.GammaEncoding,i.gammaFactor=1),a.clearBehavs();let l=(new THREE.TextureLoader).load(o,(function(){window.makarSDK&&(console.log("實在找不到哪裡改的 style.cursor 總之改回來 但是改不回來 @_@"),document.body.style.cursor="default");let t=n.fromEquirectangularTexture(i,l);a.cubeTex=t,a.loadSceneCount++,a.loadAssets();let o=a.loadSceneObjects(e),c=r[e].info.id;if(console.log(" 555555 ",c,s,a.loadSceneCount),"camera"!=r[e].environment.scene_skybox_res_id){let e=a.loadSky(a.vrScene,c,s,a.loadSceneCount);e.then((function(e){console.log("VRFunc.js: _loadScene: pSky then ret = ",e)})),o.push(e)}else document.getElementById("sky")&&document.getElementById("sky").remove();if("string"==typeof r[e].xml_url){let t=a.parseLogicXMLBySceneIndex(e);o.push(t)}Promise.all(o).then((function(t){if(console.log("VRFunc.js: _loadScene: pAll then ret = ",t),null==a.init_gyro){let o=document.getElementById("cameraForGyro");a.init_gyro=o.components["look-controls"].magicWindowAbsoluteEuler.clone()}if(document.getElementById("sky")&&a.onlySkyScene.add(document.getElementById("sky").object3D.clone(!0)),a.domElement.loadPage.style.display="none",a.domElement.homePage.style.display="none",window.homeTickOn?homeTickOn=!1:window.makarSDK&&window.makarSDK.homeTickOn&&(window.makarSDK.homeTickOn=!1),a.loadingTickOn=!1,a.triggerEnable=!0,r[e].bezier.length>0)for(let n=0;n<r[e].bezier.length;n++)a.bezierPathAnime(r[e].bezier[n],e);if(r[e].behav.length>0){for(let i=0;i<r[e].behav.length;i++){let l=r[e].behav[i];if("Time"==l.trigger_type){let c=(new Date).toTimeString().split(":")[0];l.trigger_end_time-l.trigger_start_time>=0?c>=l.trigger_start_time&&c<l.trigger_end_time&&s(l):(c>=l.trigger_start_time||c<l.trigger_end_time)&&s(l)}else if("Gyro"==l.trigger_type){let d=!1,u=setInterval((function(){let e;e=-(document.getElementById("cameraForGyro").components["look-controls"].magicWindowAbsoluteEuler.y-a.init_gyro.y)/Math.PI*180%360,e<0&&(e+=360);let t=l.trigger_start_vec.split(",").map((e=>Number(e)))[1],r=l.trigger_end_vec.split(",").map((e=>Number(e)))[1];t%=360,t<0&&(t+=360),r%=360,r<0&&(r+=360),r-t>0?e>=t&&e<=r?d||(d=!0,s(l)):d=!1:e>=t||e<=r?d||(d=!0,s(l)):d=!1}),0);a.intervalList.push(u)}}function s(e){let t;if(e.obj_id&&(t=a.getObjectTypeByObj_id(e.obj_id),"Display"==e.behav_type)){console.log("gObj",t);const r={behav:[e]};a.dealAllGroupHide(r),"2d"==t.obj_type&&(e.behav_type="Display2D")}a.triggerEvent(e,!1,null)}}a.logic&&a.scenesData.scenes[e].xml_url&&(window.gsapEmpty=a.domElement.gsapEmpty,a.logic.parseXML()),setTimeout((function(){a.calcSceneArea()}),1),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()})).then((()=>{window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(a.mute3dVideos(!0),a.mute2dVideos(!0),a.UnMutedAndPlayAllVisibleVideo())),a.addBehavToQuizTriggerObj(),a.checkIfQuizOpenDirectly();let e=document.getElementById("vrDiv");console.log("for_makarSDK vrDiv",e),window.makarSDK&&window.makarSDK.vrDiv&&(console.log("for_makarSDK vrDiv",e),e=window.makarSDK.vrDiv),console.log("%c vrScene=","color: pink",e);const t=new CustomEvent("vrSceneObjsLoaded",{detail:{name:"vrSceneObjsLoaded",sceneId:a.scenesData.scenes[a.currentSceneIndex].info.id,scene:a.vrScene,clock:a.clock}});e.dispatchEvent(t)})).catch((e=>{console.warn("VRController.js _loadScene: loadScene Error, or quiz error:",e)}))}))}));let i=a.get2DScaleRatio();a.set2DScaleRatio(i)}}setBehavsGroup(e){let t=this;e.forEach((e=>{""!=e.group&&Number.isFinite(Number(e.group))&&t.groupDict[e.group]&&t.groupDict[e.group].objs.push(e)}))}setObjBehav(e,t){e.behav&&Array.isArray(e.behav)&&e.behav.length>0||t.forEach((t=>{t.trigger_obj_id&&t.trigger_obj_id==e.generalAttr.obj_id&&(e.behav&&Array.isArray(e.behav)&&e.behav.length>0?e.behav.push(t):e.behav=[t])})),e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0||t.forEach((t=>{t.obj_id&&t.obj_id==e.generalAttr.obj_id&&("Display"!=t.behav_type&&"Media"!=t.behav_type||(e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0?e.behav_reference.push({behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}):e.behav_reference=[{behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}]))}))}addBehavToQuizTriggerObj(){const e=window.aQuizVR.triggers;Array.isArray(e)&&0!=e.length&&window.aQuizVR.quizIdWithTriggers.forEach((e=>{let t=document.getElementById(e.trigger_id),a=this.makarObjects2D.find((t=>t.obj_id==e.trigger_id));const r={obj_id:e.quiz_id,played:!1,behav_type:"ShowQuiz",force_login:e.force_login,allow_retry:e.allow_retry};if(t){t.className="clickable";let a=t.object3D;a.behav&&Array.isArray(a.behav)?a.behav.find((t=>t.obj_id==e.quiz_id))||a.behav.push(r):a.behav=[r]}else a?a.behav?a.behav.push(r):a.behav=[r]:console.log("VRController.js _loadScene: can not find quiz's trigger",e.trigger_id," performance.now()=",performance.now(),self.makarObjects2D.slice())}))}checkIfQuizOpenDirectly(){const e=this.domElement.startQuiz;window.aQuizVR.quizIdOpenDirectly.length>=1?(QuizStartContent.textContent=window.aQuizVR.quizIdOpenDirectly[0].quizUiTextContext,e.style.display="block"):e.style.display="none"}editorVersionControllObjs(e,t){let a;return 3==e.v0&&e.v1>=5?a=this.scenesData.scenes[t].objs:console.log("VRController.js: version error ",e),a}loadSceneObjects(e){let t=this,a=t.userProjResDict,r=t.userOnlineResDict;if("object"==typeof a&&!a)return console.log("%cVRFunc.js: _loadSceneObjects: error userProjResDict not exist, return -1","color:red"),[];let o=[],n=p.getProjDataEditorVer(t.currentProjData);if(o=t.editorVersionControllObjs(n,e),!Array.isArray(o))return[];let i=t.scenesData.scenes[e].behav;t.setBehavsGroup(i);let l=[];for(let e=0;e<o.length;e++){let n=p.getObjTransform(t.scenesData,o[e]),d=n.position,u=n.rotation,m=n.scale,_=(n.quaternion,o[e]);t.setObjBehav(_,i),a||"object"==typeof r?(a[o[e].res_id]&&a[o[e].res_id].main_type?o[e].main_type=a[o[e].res_id].main_type:r[o[e].res_id]&&r[o[e].res_id].res_url?o[e].main_type=r[o[e].res_id].main_type:(console.log(" before _checkDefaultObj: ",e,o[e].main_type,o[e].res_id),s(o[e]),console.log(" after _checkDefaultObj: ",e,o[e].main_type,o[e].res_id)),a[o[e].res_id]&&a[o[e].res_id].sub_type?o[e].sub_type=a[o[e].res_id].sub_type:r[o[e].res_id]&&r[o[e].res_id].res_url&&(o[e].sub_type=r[o[e].res_id].sub_type),a[o[e].res_id]&&a[o[e].res_id].res_url?o[e].res_url=a[o[e].res_id].res_url:r[o[e].res_id]&&r[o[e].res_id].res_url?o[e].res_url=r[o[e].res_id].res_url:console.log("VRFunc.js: _loadSceneObjects: res_url does not exist. scene_obj=",o[e]),a[_.res_id]&&a[_.res_id].default_shader_name?_.default_shader_name=a[_.res_id].default_shader_name:r[_.res_id]&&r[_.res_id].default_shader_name?_.default_shader_name=r[_.res_id].default_shader_name:console.log("VRFunc.js: default_shader_name does not exist. obj=",_)):console.log("VRFunc.js: _loadSceneObjects: userProjResDict or userOnlineResDict does not exist. scene_obj=",o[e]);let h=p.getObjObjType(t.scenesData,_);switch(o[e].main_type){case"camera":let a=document.getElementById("camera_cursor");var c=function(){if(a.hasLoaded){console.log("VRFunc.js: _loadSceneObjects: camera: _objTranform ",n),u.multiply(new THREE.Vector3(-1,-1,0)).add(new THREE.Vector3(0,Math.PI,0));let e=80;_&&_.typeAttr&&_.typeAttr.fov&&(e=_.typeAttr.fov);let t=document.getElementById("aCamera"),r=document.getElementById("oCamera");function o(){let a=setInterval((function(){let o=t.getObject3D("camera"),n=r.getObject3D("camera");o&&"PerspectiveCamera"==o.type&&n&&"PerspectiveCamera"==n.type&&(d.multiply(new THREE.Vector3(-1,1,1)),t.object3D.position.copy(d),t.setAttribute("camera","fov",e),o.fov=e,n.fov=e,o.updateProjectionMatrix(),n.updateProjectionMatrix(),clearInterval(a))}),100);t.components["look-controls"].yawObject.rotation.y=u.y,t.components["look-controls"].pitchObject.rotation.x=u.x,t.removeEventListener("look-controls-loaded",o)}t&&t.components&&t.components["look-controls"]&&t.components["look-controls"].yawObject&&t.components["look-controls"].pitchObject?o():t.addEventListener("look-controls-loaded",o)}else setTimeout(c,100),console.log("VRFunc.js: _loadSceneObjects: camera: not loaded, wait")};setTimeout(c,10);break;case"image":let r;console.log("VRController.js: _loadSceneObjects: image: ",e,o[e]),"3d"==h?r=t.loadTexture(_,d,u,m):"2d"==h?r=t.loadTexture2D(_,e,o.length,d,u,m):console.log("VRController.js: _loadSceneObjects: image obj_type=",h),l.push(r);break;case"text":let s;console.log("VRController.js: _loadText: text: ",e,o[e]),"3d"==h?s=t.loadText(o[e],d,u,m):"2d"==h?s=t.loadText2D(_,e,o.length,d,u,m):console.log("VRController.js: _loadSceneObjects: text obj_type=",h),l.push(s);break;case"audio":if(null==o[e].sub_type){let t=o[e].res_url.split("."),a=t[t.length-1];o[e].sub_type=a.toLowerCase()}if(("mp3"==o[e].sub_type||"wav"==o[e].sub_type||"ogg"==o[e].sub_type)&&o[e].res_url){let a=t.loadAudio(o[e],d,u,m);l.push(a)}break;case"video":if(null==o[e].sub_type){let t=o[e].res_url.split("."),a=t[t.length-1];o[e].sub_type=a.toLowerCase()}if("mp4"==o[e].sub_type){let a;"3d"==h?a=t.loadVideo(o[e],d,u,m):"2d"==h?a=t.loadVideo2D(_,e,o.length,d,u,m):console.log("VRController.js: _loadSceneObjects: video obj_type=",h),l.push(a)}else"youtube"==o[e].sub_type&&(console.log("makar webXR currently does not support yt video, please wait until next update"),"3d"==h?t.loadYouTubeNotSupport(_,e,o.length,d,u,m):"2d"==h?t.loadYouTubeNotSupport2D(_,e,o.length,d,u,m):console.log("VRController.js: _loadSceneObjects: yt video obj_type=",h));break;case"model":if("WebView"==_.res_id)console.log("webview obj",_),"3d"==h?t.loadWebViewNotSupport(_,e,o.length,d,u,m,t.cubeTex):"2d"==h&&t.loadWebViewNotSupport2D(_,e,o.length,d,u,m,t.cubeTex);else if("3d"==h){let a=t.loadGLTFModel(o[e],d,u,m,t.cubeTex);l.push(a)}break;case"curve":if("3d"==h){let e=t.loadCurve(_,d,u,m);l.push(e)}break;case"light":console.log("VRController.js: _loadSceneObjects: light",e,o[e]),t.loadLight(o[e],d,u,m);break;case"empty":switch(o[e].sub_type){case"quiz":if(!o[e].typeAttr.module.display_order_list){console.log("%c _vrController _loadMakarARScene: user has not set display_order_list. obj.typeAttr.module=","color:Salmon",o[e].typeAttr.module);break}o[e].typeAttr.module.question_list.forEach((t=>{let a=t.options_json.find((e=>"Button"==e.res_id));a&&(a.generalAttr.obj_parent_id||(a.generalAttr.obj_parent_id=o[e].generalAttr.obj_id))}));const a={position:d,rotation:u,scale:m},r=t.currentProjData.proj_id,n=localStorage.getItem("MakarUserID"),s={startQuiz:t.domElement.startQuiz,QuizStartButton:document.getElementById("QuizStartButton"),QuizStartContent:document.getElementById("QuizStartContent")},i=window.aQuizVR.loadQuiz(o[e],a,r,n,s,t.worldContent,t.languageType);l.concat(i),console.log("VRController.js: _loadSceneObjects: empty, quiz ",e,o[e]);break;default:console.log("VRController.js: _loadSceneObjects: empty object default, ",e,o[e])}break;default:console.log("VRController.js: _loadSceneObjects: default",e,o[e])}}return l}checkAnimation(e,t){e.mixer&&e.mixer.update(t),e.animationSlices&&e.animationSlices[0].index&&e.animationSlices[e.animationSlices[0].index]&&(e.mixer._actions[0].time>e.animationSlices[e.animationSlices[0].index].timeEnd||e.mixer._actions[0].time<e.animationSlices[e.animationSlices[0].index].timeStart)&&(e.mixer._actions[0].time=e.animationSlices[e.animationSlices[0].index].timeStart)}showObjectEvent(e,t,a){let r=this;function o(){if(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),"a-video"==e.localName){let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo(r.safariUnMutedVideo)),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound"))if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)if("Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying){e.el.components.sound.stopSound();let t=new Event("sound-ended");e.el.dispatchEvent(t)}}}})),t&&e.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}function n(){window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo(e)),console.log("target 檢查是否有2D 2D影片是否靜音"),e.setAttribute("visible",!0);let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}e.object3D.behav&&e.setAttribute("class","clickable"),e.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("VRFunc.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&(e.el.blockly?console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}e?"Switch"==a?e.getAttribute("visible")?o():n():"Show"==a?n():"Hide"==a&&o():console.log("VRFunc.js: _showObjectEvent: target not exist",e)}hideGroupObjectEvent(e,t=!1){e?e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){(e.behav_reference||t)&&e.el.setAttribute("visible",!1);for(let t in e.children)if("Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying){e.el.components.sound.stopSound();let t=new Event("sound-ended");e.el.dispatchEvent(t)}}}}))):console.log("VRFunc.js: _hideGroupObjectEvent: target not exist ",e)}clearBehavs(){let e=this;for(let t in e.groupDict)Array.isArray(e.groupDict[t].objs)&&(e.groupDict[t].objs.length=0);for(let t in e.lookAtTimelineDict)"function"==typeof e.lookAtTimelineDict[t].pause&&"function"==typeof e.lookAtTimelineDict[t].kill&&(e.lookAtTimelineDict[t].pause(),e.lookAtTimelineDict[t].kill());e.lookAtTimelineDict={}}checkVRSceneResultBehav(){let e=this;if(!Number.isFinite(Number(e.projectIdx)))return void console.error(" _checkVRSceneResultBehav: projectIdx error ",e.projectIdx);if(!Array.isArray(e.VRSceneResult)||!e.VRSceneResult[e.projectIdx]||!Number.isInteger(Number(e.sceneIndex)))return void console.error(" _checkVRSceneResultBehav: _VRSceneResult error ",e.projectIdx,e.sceneIndex,e.VRSceneResult);if(!e.VRSceneResult[e.projectIdx].editor_ver||"string"!=typeof e.VRSceneResult[e.projectIdx].editor_ver)return void console.error(" _checkVRSceneResultBehav: editor_ver error ",e.VRSceneResult[e.projectIdx]);let t=e.VRSceneResult[e.projectIdx].editor_ver.split("."),a=e.editorVersionControllObjs(t,e.projectIdx,e.sceneIndex);if(console.log("_checkVRSceneResultBehav: _scene_objs ",a),!Array.isArray(a))return;let r={},o={};e.VRSceneResult[e.projectIdx].scenes[e.sceneIndex].behav.forEach((e=>{r[e.trigger_obj_id]&&Array.isArray(r[e.trigger_obj_id])?r[e.trigger_obj_id].push([e]):r?r[e.trigger_obj_id]=[e]:console.error("_checkVRSceneResultBehav: cant get behavAll ",r)}));for(let e=0,t=a.length;e<t;e++){let t=a[e];t.behav_reference&&delete t.behav_reference,t.generalAttr.obj_id&&(o[t.generalAttr.obj_id]=t)}for(let e in r){let t=r[e];console.log(" _checkVRSceneResultBehav: _behavAll: ",e,t);for(let e=0,a=t.length;e<a;e++){let a=t[e];if(a.behav_type,a.obj_id){let e=o[a.obj_id];e&&Array.isArray(e.behav_reference)?e.behav_reference.push({behav_name:a.behav_type,target_id:a.obj_id}):e?e.behav_reference=[{behav_name:a.behav_type,target_id:a.obj_id}]:console.error("_checkVRSceneResultBehav: cant get _behavObj ",a)}}}}calcSceneArea(){let e=this,t={},a=0,r=0,o=0,n=0;for(let s=0,i=e.makarObjects.length;s<i;s++){let i=e.makarObjects[s].object3D;if(i&&i.el&&i.el.id){let e=[];i.traverse((function(t){if(t.isMesh&&t.geometry){if(t.el&&"A-TEXT"==t.el.tagName&&t.el.object3D&&t.el.object3D.isTempTextObj)return;let s=new THREE.Box3;t.geometry.computeBoundingBox(),s.copy(t.geometry.boundingBox).applyMatrix4(t.matrixWorld),s.max.z==s.min.z&&(s.max.z+=.01),s.max.x>a&&(a=s.max.x),s.min.x<r&&(r=s.min.x),s.max.z>o&&(o=s.max.z),s.min.z<n&&(n=s.min.z);let i=new THREE.Box3Helper(s,5678547);e.push(i)}})),t[i.el.id]=e}}e.objList=t;let s=new THREE.Vector2(a,o),i=new THREE.Vector2(r,n);if(e.areaMax=s,e.areaMin=i,e.currentProjData&&e.currentProjData.proj_descr.includes("_walking")){let e=document.getElementById("__ground");if(e){let t=2*(a-r),s=2*(o-n),i=new THREE.Vector2((a+r)/2,(o+n)/2);e.setAttribute("geometry","width:"+t+"; height:"+s+";"),e.setAttribute("position",{x:i.x,y:.1,z:i.y}),console.log(" _calcSceneArea: gwdc ",t,s,i)}}}setupSceneBehav(){let e=this;for(let t=0,a=e.makarObjects.length;t<a;t++){let a=e.makarObjects[t].object3D;a?(a.behav,a.behav_reference):console.error(" _setupSceneBehav: 3d obj error",t,e.makarObjects[t])}}addLookAtTimeLine(e,t,a){console.log(" _addLookAtTimeLine: _facingEvent=",a);let r=new THREE.Vector3;t.object3D.getWorldPosition(r);let o=gsap.timeline();if(this.lookAtTimelineDict[a.lookObjId]=o,e==document.getElementById("aCamera")){if("VR"==this.viewMode){e.setAttribute("look-controls",{enabled:!1}),t.object3D.getWorldPosition(r),e.object3D.lookAt(r),e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI),a&&0==a.is_front&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI);const o=e.object3D.rotation.clone();aCamera.components["look-controls"].yawObject.rotation.y=o.y,aCamera.components["look-controls"].pitchObject.rotation.x=o.x,e.setAttribute("look-controls",{enabled:!0})}}else t.object3D.getWorldPosition(r),e.object3D.lookAt(r),a&&0==a.is_front&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}setObjectBehavAll(e){}dealAllGroupHide(e){let t=this;if(t.groupDict){console.log(" _dealAllGroupHide_:  ",e);for(let a=0;a<e.behav.length;a++){let r=e.behav[a];if(""!=r.group&&t.groupDict[r.group]){let a=r.group;console.log(" _dealAllGroupHide:  ",a,t.groupDict[a].objs),t.groupDict[a].objs.forEach(((a,o)=>{if(!e.behav.find((e=>e.obj_id==a.obj_id))){let e=a.obj_id,o=!1;t.scenesData.scenes[t.currentSceneIndex].behav.forEach((t=>{t.obj_id!=e||"Display"!=t.behav_type||"Switch"!=t.switch_type&&"Show"!=t.switch_type||(o=!0)}));let n=t.getObjectTypeByObj_id(e);if("2d"==n.obj_type){let t=n.obj;r.obj_id!=e&&o&&(t.visible=!1)}else if("3d"==n.obj_type){let a=n.obj;r.obj_id!=e&&o&&t.hideGroupObjectEvent(a,o)}}}))}}}else console.log("_dealAllGroup: missing groupDict")}speechTextObj(e,t,a){if(console.log(" _speechTextObj: _textObj: ",e),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){1==speechSynthesis.speaking&&(speechSynthesis.pause(),speechSynthesis.cancel());let r=1;Number.isFinite(t)&&t>0&&(r=t);let o=e.typeAttr.content,n=new SpeechSynthesisUtterance(o);n.rate=r**3*.1837+r**2*-.9948+2.3352*r-.5196,n.pitch=1;let s="en",i="en-US";switch(a){case 0:default:s="en",i="en-US";break;case 1:s="zh-TW",i="zh-TW";break;case 2:s="zh-CN",i="zh-CN";break;case 3:s="ja",i="ja-JP";break;case 4:s="ko",i="ko-KR"}let l=setInterval((function(){let e=!1,t=speechSynthesis.getVoices();t.length>0&&(clearInterval(l),window.Browser&&"safari"!=window.Browser.name&&t.forEach((t=>{t.lang==i&&(e=!0,n.voice=t)})),0==e&&(n.lang=s),speechSynthesis.speak(n))}),1)}}parseLogicXMLBySceneIndex=function(e){let t,a=p.getSceneLogicXML(this.scenesData,e);if(""!=a){let e=new Logic;t=e.loadXMLtoDoc(a),vrController.logic=e}return t};setViewMode(e=""){let t=this;return new Promise((function(a){let r=document.getElementById("aCamera"),o=document.getElementById("oCamera"),n=document.getElementById("cameraForGyro"),s=r.getObject3D("camera"),i=o.getObject3D("camera");if(r&&o&&s&&i)if("VR"==e){if(o.setAttribute("camera","active",!1),r.setAttribute("camera","active",!0),n.play(),t.vrScene.camera=s,t.viewMode="VR",Number.isFinite(t.walkingStatus)&&-1!=t.walkingStatus){let e=document.getElementById("__ground");e&&e.setAttribute("visible",!0)}a("VR")}else if("model"==e)o.setAttribute("camera","active",!0),r.setAttribute("camera","active",!1),n.play(),t.vrScene.camera=i,t.viewMode="model",t.setWalkingObjVisible(!1),a("model");else if(0==o.getAttribute("camera").active)o.setAttribute("camera","active",!0),r.setAttribute("camera","active",!1),n.play(),t.vrScene.camera=i,t.viewMode="model",t.setWalkingObjVisible(!1),a("model");else if(0==r.getAttribute("camera").active){if(o.setAttribute("camera","active",!1),r.setAttribute("camera","active",!0),t.vrScene.camera=s,t.viewMode="VR",Number.isFinite(t.walkingStatus)&&-1!=t.walkingStatus){let e=document.getElementById("__ground");e&&e.setAttribute("visible",!0)}a("VR")}else a(-1);else a(-1)}))}getMakarObject(e){return 1!=e.makarObject?e.parent?this.getMakarObject(e.parent):0:e}getObjectTypeByObj_id(e){let t=this,a=null,r=null,o=null,n=null,s={obj_type:"",obj_index:null,obj:null};return e&&(t.makarObjects.forEach(((t,o)=>{t.id==e&&(a=t,r=o)})),t.makarObjects2D&&t.makarObjects2D.forEach(((t,a)=>{t.obj_id==e&&(o=t,n=a)})),null!=a&&null!=r||null!=o&&null!=n?null!=a&&null!=r?(s.obj_type="3d",s.obj_index=r,s.obj=a):null!=o&&null!=n?(s.obj_type="2d",s.obj_index=n,s.obj=o):console.log("_getObjectTypeByObj_id: fucking logic trouble.",n,o):null!=a&&null!=r&&null!=o&&null!=n&&(console.log("_getObjectTypeByObj_id: warning, both 2D/3D object get",e,", 3d:",r,a,", 2d:",n,o),s.obj_type="3d",s.obj_index=r,s.obj=a)),s}cameraMoveToPoint(e){let t=this,a=document.getElementById("pointerSphere"),r=document.getElementById("currentPosSphere");if(a&&r)return new Promise((function(o,n){let s=e.position,i=Math.round(1e3*s.x)/1e3,l=Math.round(1e3*s.y)/1e3,c=Math.round(1e3*s.z)/1e3;a.setAttribute("visible",!1),r.setAttribute("visible",!0),r.object3D.position.set(i,l,c);const d=t.vrScene.camera.el.object3D;let u=d.position.x,m=d.position.y,p=d.position.z,_=new THREE.Vector3(i-u,l-m,c-p),h=new THREE.Vector3(i-u,0,c-p).normalize(),g=.2*Math.round(_.length());g=g>1?1:g;let b=new THREE.Raycaster(d.position,h);if(1==e.dealBoundary){let e=b.intersectObjects(boundaries,!0);if(e.length>0&&(console.log("_cameraMoveToPoint: initial position hit boundary, distance ",e[0].distance),e[0].distance<1))return console.log("_cameraMoveToPoint: initial position hit boundary, dont run  "),r.object3D.position.copy(d.position),void o(1)}let y=gsap.timeline();y.to(t.domElement.gsapEmpty,{duration:g,delay:0,onStart:function(){},onUpdate:function(){let t=new THREE.Vector3(u+_.x*this.ratio,m,p+_.z*this.ratio);if(1==e.dealBoundary){let e=b.intersectObjects(boundaries,!0);if(e.length>0&&e[0].distance<t.distanceTo(d.position))return r.object3D.position.copy(t),y.pause(),y.kill(),y=null,void o(1)}d.position.set(t.x,t.y,t.z)},onComplete:function(){o(g)}})}))}setWalkingStatus(e){let t=this;if(Number.isFinite(t.walkingStatus)){console.log(" _setWalkingStatus: set from [",t.walkingStatus,"]"," to [",e,"]");let a=document.getElementById("__ground"),r=document.getElementById("pointerSphere"),o=document.getElementById("currentPosSphere");0!=t.walkingStatus&&-1!=t.walkingStatus||(t.walkingStatus=e),-1==t.walkingStatus&&r&&o&&a&&t.setWalkingObjVisible(!1),0==t.walkingStatus&&a&&a.setAttribute("visible",!0)}else console.log(" _setWalkingStatus: status not exist ",t.walkingStatus)}setWalkingObjVisible(e){let t=document.getElementById("__ground"),a=document.getElementById("pointerSphere"),r=document.getElementById("currentPosSphere");t&&a&&r&&(1==e?(t.setAttribute("visible",!0),a.setAttribute("visible",!0),r.setAttribute("visible",!0)):(t.setAttribute("visible",!1),a.setAttribute("visible",!1),r.setAttribute("visible",!1)))}async UrlExistsFetch(e){let t=await fetch(e,{method:"HEAD"});return console.log("_VRController: _UrlExists2: ret ",t),!!t.status&&"200"==t.status}setupFunction(){if(this.FUNCTION_ENABLED)return;this.FUNCTION_ENABLED=!0;var e=this;e.vrScene.canvas.addEventListener("touchstart",n,!1),e.vrScene.canvas.addEventListener("mousedown",n,!1),e.vrScene.canvas.addEventListener("touchmove",s,!1),e.vrScene.canvas.addEventListener("mousemove",s,!1),e.vrScene.canvas.addEventListener("touchend",i,!1),e.vrScene.canvas.addEventListener("mouseup",i,!1);let t=new THREE.Vector2;var a=new THREE.Vector2,r=new THREE.Raycaster;function o(t){let r=e.GLRenderer.domElement.getBoundingClientRect();switch(t.type){case"mouseup":case"mousemove":case"mousedown":a.x=(t.clientX-r.left)/e.GLRenderer.domElement.clientWidth*2-1,a.y=-(t.clientY-r.top)/e.GLRenderer.domElement.clientHeight*2+1;break;case"touchend":case"touchstart":case"touchmove":a.x=(t.changedTouches[0].clientX-r.left)/e.GLRenderer.domElement.clientWidth*2-1,a.y=-(t.changedTouches[0].clientY-r.top)/e.GLRenderer.domElement.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",t.type," not mouseup/touchend, return ")}return a.clone()}function n(a){t=o(a),e.touchMouseState=0}function s(a){let n=o(a);0==e.touchMouseState?n.sub(t).length()>.01&&(e.touchMouseState=1):e.touchMouseState=1;let s=document.getElementById("__ground"),i=document.getElementById("pointerSphere");if(i&&s)if(0==e.touchMouseState||1==e.touchMouseState){if(!e.triggerEnable)return;if("VR"==e.viewMode&&Number.isInteger(e.walkingStatus)&&e.walkingStatus>=0){if(Array.isArray(e.currentSceneMakarObjects)&&e.currentSceneMakarObjects.length>0);else{for(let t=0;t<e.makarObjects.length;t++){let a=e.makarObjects[t];if(a.object3D&&"clickable"==a.className){let t=!0;a.object3D.traverseAncestors((function(e){"Scene"!=e.type&&0==e.visible&&(t=!1)})),t&&e.currentSceneMakarObjects.push(a.object3D)}}e.currentSceneMakarObjects.push(s.object3D)}let t=e.currentSceneMakarObjects,a=!1;r.setFromCamera(n,e.vrScene.camera);let o=r.intersectObjects(t,!0);o.length>0&&(1==a||o[0].object&&o[0].object.el&&o[0].object.el!=s?i.setAttribute("visible",!1):(i.setAttribute("visible",!0),i.object3D.position.copy(o[0].point)))}}else i.setAttribute("visible",!1)}function i(t){if(!e.triggerEnable)return;if(1==e.touchMouseState){if("touchend"==t.type){let e=document.getElementById("pointerSphere");e&&e.setAttribute("visible",!1)}return}e.touchMouseState=2,t.preventDefault();let o=e.GLRenderer.domElement.getBoundingClientRect();switch(t.type){case"mouseup":a.x=(t.clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,a.y=-(t.clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;case"touchend":a.x=(t.changedTouches[0].clientX-o.left)/e.GLRenderer.domElement.clientWidth*2-1,a.y=-(t.changedTouches[0].clientY-o.top)/e.GLRenderer.domElement.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",t.type," not mouseup/touchend, return ")}let n={},s=[];for(let t=0;t<e.makarObjects2D.length;t++){let a=e.makarObjects2D[t];1==a.makarObject&&s.push(a)}r.setFromCamera(a,e.camera2D);let i=r.intersectObjects(s,!0);if(0!=i.length){let t=e.getMakarObject(i[0].object);if(t.behav){n["2d_behav"]=t.behav,e.dealAllGroupHide(t);let a=!1;for(let e=0;e<t.behav.length;e++)"CloseAndResetChildren"==t.behav[e].behav_type&&(a=!0);for(let r=0;r<t.behav.length;r++){let o;if(t.behav[r].obj_id&&(o=e.getObjectTypeByObj_id(t.behav[r].obj_id)),"Display"==t.behav[r].behav_type)if("2d"==o.obj_type){let o=Object.assign({},t.behav[r]);o.behav_type="Display2D",e.triggerEvent(o,a,t)}else"3d"==o.obj_type&&e.triggerEvent(t.behav[r],a,t);else e.triggerEvent(t.behav[r],a,t)}}}let l=[];for(let t=0;t<e.makarObjects.length;t++){let a=e.makarObjects[t];if(a.object3D&&"clickable"==a.className){let e=!0;a.object3D.traverseAncestors((function(t){"Scene"!=t.type&&0==t.visible&&(e=!1)})),e&&l.push(a.object3D)}}r.setFromCamera(a,e.vrScene.camera);let c=r.intersectObjects(l,!0),d=!1,u=!1;if(0!=c.length){console.log("VRFunc.js: _setupFunction: 1 endEvent, intersects=",c);let t=e.getMakarObject(c[0].object),a=t.el;if(a&&a.onclickBlock){d=!0;for(let e=0;e<a.onclickBlock.length;e++)a.onclickBlockState[e]&&(a.onclickBlockState[e]=!1,vrController.logic&&(vrController.logic.parseBlock(a.onclickBlock[e],(function(){a.onclickBlockState[e]=!0})),n["3d_logic"]=a.onclickBlock[e]))}if(t.traverse((function(e){e.isMesh})),t.behav){e.dealAllGroupHide(t);let a=!1;for(let e=0;e<t.behav.length;e++)"CloseAndResetChildren"==t.behav[e].behav_type&&(a=!0);for(let r=0;r<t.behav.length;r++){if("CloseAndResetChildren"!=t.behav[r].behav_type){let o;if(t.behav[r].obj_id&&(o=e.getObjectTypeByObj_id(t.behav[r].obj_id)),"ShowQuiz"==t.behav[r].behav_type)0==t.behav[r].played?e.triggerEvent(t.behav[r],a,t):console.log("VRFunc.js: _setupFunction: endEvent:  Quiz had been played.",t.behav[r].played);else if("Display"==t.behav[r].behav_type)if("2d"==o.obj_type){let o=Object.assign({},t.behav[r]);o.behav_type="Display2D",e.triggerEvent(o,a,t)}else"3d"==o.obj_type&&e.triggerEvent(t.behav[r],a,t);else e.triggerEvent(t.behav[r],a,t)}"FingerGesture"!=t.behav[r].behav_type&&"LookAt"!=t.behav[r].behav_type&&(u=!0,n["3d_behav"]=t.behav)}}}if(console.log(" event logic check: ",d,u),0==d&&0==u&&Number.isInteger(e.walkingStatus)&&"VR"==e.viewMode)if(0==e.walkingStatus){let t=document.getElementById("__ground"),a=r.intersectObjects([t.object3D],!0);if(a.length>0){let t=a[0].object;console.log(" selectedObject ",t),t.el?"__ground"==t.el.getAttribute("id")?(console.log(" _endEvent: object is ground "),e.walkingStatus=1,e.cameraMoveToPoint({position:a[0].point,dealBoundary:!1}).then((function(){e.walkingStatus=0})),n.ground_move=t):console.log(" _endEvent: object is not ground "):console.log(" _endEvent: object without el ")}}else-1==e.walkingStatus?console.log(" _endEvent: _walkingStatus =-1"):1==e.walkingStatus&&console.log(" _endEvent: _walkingStatus = 1");0==Object.keys(n).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",n)}}triggerEvent(e,a,r){if(!this.FUNCTION_ENABLED)return;var o=this;let n;void 0===a&&(a=!1);let s=e.obj_id;switch(this.makarEvents.dispatchEvent(e),e.behav_type){case"Dialing":console.log("VRFunc.js: triggerEvent: Dialing: event=",e);let c=window.document.getElementById("phoneCall");c.href="tel:"+e.phone,c.click();break;case"Email":console.log("VRFunc.js: triggerEvent: SendEmail: event=",e);let d=window.document.getElementById("sendEmail");d.href="mailto:"+e.mail_to,d.click();break;case"URL":console.log("VRFunc.js: triggerEvent: URL: event=",e,e.url);let u=window.document.getElementById("openWebBrowser");u.href=e.url,u.click(),console.log("VRFunc.js: triggerEvent: URL: webTag=",u);break;case"Scenes":if(console.log("VRFunc.js: triggerEvent: SceneChange: event=",e),1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let v=setTimeout((()=>{m()}),3e3);e.previousID=v}else m();function m(){let t=e.scene_id;o.projectIdx;for(let e=0;e<o.scenesData.scenes.length;e++)o.scenesData.scenes[e].info.id==t&&(o.triggerEnable=!1,o.domElement.loadPage.style.display="block",o.loadingTickOn=!0,o.pause2dVideos(),o.pause3dVideos(),o.loadScene(e))}break;case"Display":if(console.log("VRFunc.js: triggerEvent: Display: event=",e),n=document.getElementById(s),!n){console.warn("VRFunc.js: Media: target not exist",n);break}if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let w=setTimeout((()=>{_()}),3e3);e.previousID=w}else _();function _(){if("a-sound"==n.nodeName.toLowerCase()){if("Switch"==e.switch_type)if(n.getAttribute("visible")){n.setAttribute("visible",!1),n.setAttribute("class","unclickable"),n.components.sound.stopSound();let e=new Event("sound-ended");n.dispatchEvent(e)}else n.setAttribute("visible",!0),n.object3D.behav&&n.setAttribute("class","clickable"),n.blockly?(n.needReplay=!0,console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",n)):n.components.sound.playSound();else if("Show"==e.switch_type)n.setAttribute("visible",!0),n.object3D.behav&&n.setAttribute("class","clickable"),n.blockly?console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",n):n.components.sound.playSound();else if("Hide"==e.switch_type){n.setAttribute("visible",!1),n.setAttribute("class","unclickable"),n.components.sound.stopSound();let e=new Event("sound-ended");n.dispatchEvent(e)}}else o.showObjectEvent(n,a,e.switch_type)}break;case"Display2D":if(console.log("VRFunc.js: _triggerEvent: Display2D: event=",e),1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let j=setTimeout((()=>{h()}),3e3);e.previousID=j}else h();function h(){let t=o.makarObjects2D.find((t=>t.obj_id==e.obj_id));switch(e.switch_type){case"Switch":t&&(t.visible=!t.visible);break;case"Show":t.visible=!0;break;case"Hide":t.visible=!1}t.traverse((function(a){if(0==a.children.length)return;if(!a.children[0].material)return;if(!a.children[0].material.map)return;let r=a.children[0].material.map.image;if(a.children[0].material.map.image&&"video"==r.tagName.toLowerCase())switch(e.switch_type){case"Switch":t.visible?(window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(o.mute3dVideos(),o.mute2dVideos())),r.play(),r.muted=!1,o.safariUnMutedVideo=t):(r.pause(),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||o.UnMutedAndPlayAllVisibleVideo()));break;case"Show":r.play(),r.muted=!1,o.safariUnMutedVideo=t;break;case"Hide":r.pause(),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||o.UnMutedAndPlayAllVisibleVideo())}}))}break;case"Animation":if(console.log("VRFunc.js: triggerEvent: Animation: event=",e),n=document.getElementById(s),!n){console.log("VRFunc.js: Animation: target not exist",n);break}let g;for(let D=1;D<n.object3D.children[0].animationSlices.length;D++)n.object3D.children[0].animationSlices[D].uid==e.uid&&(g=n.object3D.children[0].animationSlices[D].animationName);n.setAttribute("animation-mixer","clip: "+g),e.loop?(n.object3D.children[0].animationSlices[0].loop=e.uid,n.object3D.children[0].animationSlices[0].uid=e.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=!0):(n.object3D.children[0].animationSlices[0].uid=e.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=e.reset);break;case"TTS":if(console.log("VRFunc.js: _ReadText: ",e),e.obj_id){let E=e.obj_id;o.projectIdx,o.scenesData&&o.scenesData.scenes[o.sceneIndex]&&Array.isArray(o.scenesData.scenes[o.sceneIndex].objs)&&o.scenesData.scenes[o.sceneIndex].objs.forEach((t=>{t.generalAttr.obj_id==E&&o.speechTextObj(t,e.speed,e.language)}))}break;case"ShowQuiz":if(window.aQuizVR.checkIsAnyQuizPlaying())console.log("%cVRController.js _triggerEvent: ShowQuiz triggered, but user hasn't finnish previous quiz yet.","color: orange");else{const A=localStorage.getItem("MakarUserID"),k=o.currentProjData.proj_id;function R(t){window.aQuizVR.currentlyTriggeredQuizId=e.obj_id;const a=window.aQuizVR.loadedQuizzes.find((t=>t.obj_id==e.obj_id));a&&1==a.isPlayed||(document.getElementById("QuizStartContent").textContent=t,o.domElement.startQuiz.style.display="block",r.behav.forEach((e=>{"ShowQuiz"==e.behav_type&&(e.played=!0)})))}function T(){i.getRecordModule(A,k).then((t=>{if(0!=t.data.record_module_list.length){let a;t.data.record_module_list&&Array.isArray(t.data.record_module_list)&&t.data.record_module_list[0].project_module&&(a=t.data.record_module_list[0].project_module);let r=!1;if(a&&a.playedQuizzes&&Array.isArray(a.playedQuizzes)&&(r=a.playedQuizzes.find((t=>t.obj_id==e.obj_id))),r){R(o.worldContent.userAlreadyPlayed[o.languageType]);let e=function(){o.domElement.startQuiz.style.display="none",QuizStartButton.removeEventListener("click",e)};QuizStartButton.addEventListener("click",e)}else R(o.worldContent.clickToPlay[o.languageType])}else R(o.worldContent.clickToPlay[o.languageType])}))}function S(){let t=!1;aQuizVR.getQuizProjectFromMDB(o.scenesData.project_id).then((a=>{if(a&&a.quizzes&&a.quizzes[e.obj_id]&&(t=!0),t){R(o.worldContent.userAlreadyPlayed[o.languageType]);let e=function(){o.domElement.startQuiz.style.display="none",QuizStartButton.removeEventListener("click",e)};QuizStartButton.addEventListener("click",e),console.log("%c VRcontroller.js: _triggerEvent ShowQuiz: user has played this quiz already","color:orange")}else R(o.worldContent.clickToPlay[o.languageType])}))}e.force_login?A?e.allow_retry?R(o.worldContent.clickToPlay[o.languageType]):T():console.log("%c VRcontroller.js: _triggerEvent ShowQuiz: user is not logged in.","color: orange;"):!e.force_login&&e.allow_retry?R(o.worldContent.clickToPlay[o.languageType]):e.force_login||e.allow_retry?console.warn("VRControoller _triggerEvent: ShowQuiz error"):S()}break;case"QuizOption":aQuizVR.loadedQuizzes.forEach((e=>{e.module.json.question_list.forEach((t=>{t.options_json.forEach((t=>{r.el?r.el.id==t.generalAttr.obj_id&&e.quizOption(r.el):r.obj_id==t.generalAttr.obj_id&&e.quizOption(r)}))}))}));break;case"MoveAlongPath":document.getElementById(e.obj_id).object3D.bezier.play();break;case"Skybox":if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let x=setTimeout((()=>{b()}),3e3);e.previousID=x}else b();function b(){let a=e.skybox_id,r={};if(o.userProjResDict[a]){let e=o.userProjResDict[a];"spherical_image"!=e.main_type&&"spherical_video"!=e.main_type||(r=e)}let n,s=r.res_url;n=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024),t(s,(function(e){0==e&&(s="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg");let t=(new THREE.TextureLoader).load(s,(function(){let e=n.fromEquirectangularTexture(o.vrScene.renderer,t);o.cubeTex=e;let a=[];a=p.getScenes(o.scenesData);let s=a[o.currentSceneIndex].info.id;o.loadSky(o.vrScene,s,r,o.loadSceneCount).then((function(e){console.log("VRFunc.js: _loadScene: pSky then ret = ",e);for(let e=0;e<o.makarObjects.length;e++){let t=o.makarObjects[e].getObject3D("mesh");t&&t.traverse((e=>{e.material&&(e.material.envMap=o.cubeTex.texture)}))}}))}))}))}break;case"Facing":if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let C=setTimeout((()=>{y()}),3e3);e.previousID=C}else y();function y(){console.log("_triggerEvent: _Facing event=",e);let t=e.source_id,a=document.getElementById(t),r=e.toward_id,n=document.getElementById(r);if(!a){const r=o.scenesData.scenes[o.sceneIndex].objs.find((e=>e.generalAttr.obj_id==t));r&&"camera"==r.main_type&&(console.log("_triggerEvent: Facing event, lookObj is camera",e),a=document.getElementById("aCamera"))}if(!n){const t=o.scenesData.scenes[o.sceneIndex].objs.find((e=>e.generalAttr.obj_id==r));t&&"camera"==t.main_type&&(n={VR:aCamera,model:oCamera}[o.viewMode],console.log("_triggerEvent: Facing event, targetObj is camera",n,e))}a&&a.object3D&&n&&n.object3D?o.addLookAtTimeLine(a,n,e):console.log("_triggerEvent: _Facing error, obj not exist",a,n)}break;case"videoTogglePlayPause":console.log("_videoTogglePlayPause",e),n=document.getElementById(s);let f=o.makarObjects2D.find((t=>t.obj_id==e.obj_id));if(window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(o.mute3dVideos(),o.mute2dVideos()),n){if("a-video"==n.localName){let I=n.getAttribute("src");if(null!=I){I=I.split("#").pop();let z=document.getElementById(I);z instanceof HTMLElement&&((l=z).currentTime>0&&!l.paused&&!l.ended&&l.readyState>2?(z.pause(),z.muted=!0,window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(console.log("這裡應該讓其他的影片發出聲音"),o.UnMutedAndPlayAllVisibleVideo())):(z.play(),z.muted=!1,o.safariUnMutedVideo=n))}}}else{if(!f){console.warn("VRFunc.js: _videoTogglePlayPause: target not exist. obj_id=",s," target=",n);break}if("video2D"!=f.makarType)return;if(0==f.children.length)return;if(!f.children[0].material)return;if(!f.children[0].material.map)return;if(!f.children[0].material.map.image)return;if("VIDEO"==f.children[0].material.map.image.tagName){const M=f.children[0].material.map.image;if(M){console.log("video.volume",M.volume),0!=M.volume&&window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?o.UnMutedAndPlayAllVisibleVideo(f):1==window.Browser.mobile&&(console.log("明明沒有對chrome做處理 但chrome也會自動只播放它然後停止別人  因此在點擊事件也要像ios一樣嗎"),o.UnMutedAndPlayAllVisibleVideo(f)));const O=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2);console.log("_videoTogglePlayPause obj2D isVideoPlaying",O),O(M)?(M.pause(),M.muted=!0,0!=M.volume&&window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?o.UnMutedAndPlayAllVisibleVideo():1==window.Browser.mobile&&(console.log("chrome mobile ios 為何chrome自動播放會只剩一個然後停止別人??  所以在點擊事件也要像ios一樣嗎"),o.UnMutedAndPlayAllVisibleVideo()))):(M.play(),M.muted=!1,o.safariUnMutedVideo=f)}}}break;default:console.log("VRFunc.js: triggerEvent: default: event=",e)}var l}getSnapShot(){let e=this;return new Promise((function(t){if(e.FUNCTION_ENABLED)return e&&e.GLRenderer&&e.vrScene&&e.GLRenderer.domElement&&e.vrScene.object3D&&e.GLRenderer.domElement.clientWidth&&e.GLRenderer.domElement.clientHeight&&e.GLRenderer.domElement.width&&e.GLRenderer.domElement.height?(e.GLRenderer.clearDepth(),e.GLRenderer.render(e.vrScene.object3D,e.vrScene.camera),e.GLRenderer.render(e.scene2D,e.camera2D),void t(e.GLRenderer.domElement.toDataURL("image/png",1))):(console.log(" _VRController: _getSnapShot: something error ",e),void t(-1));t(-1)}))}startWebCam(e){let t=this,a=function(a){console.error("VRController: _startWebCam error:",a),t.video={videoWidth:innerWidth,videoHeight:innerHeight};let r=innerWidth,o=innerHeight,n=new THREE.OrthographicCamera(-r/2,r/2,-o/2,o/2,-100,2e4);t.camera2D=n;let s=new THREE.PerspectiveCamera(60,r/o,.3,1e4);t.camera3D=s;let i=document.getElementById("aCamera");i.setObject3D("camera",s);let l={aspect:r/o,near:.3,far:1e4,fov:60};i.setAttribute("camera",l),t.vrScene.camera=s;let c=new THREE.Vector3;c.multiply(new THREE.Vector3(-1,-1,0)).add(new THREE.Vector3(0,180,0)),i.components["look-controls"].yawObject.rotation.y=c.y/180*Math.PI,i.components["look-controls"].pitchObject.rotation.x=c.x/180*Math.PI;let d=document.getElementById("oCamera"),u=new THREE.PerspectiveCamera(60,r/o,.3,1e4),m=d.getObject3D("camera").position.clone();u.position.copy(m),t.oCamera3D=u,d.setObject3D("camera",u),d.setAttribute("camera",l),d.components.camera.camera=u,d.components["orbit-controls"].controls.object=u,parent.selectedProject?"VR"==parent.selectedProject.viewMode?t.setViewMode("VR"):"model"==parent.selectedProject.viewMode?t.setViewMode("model"):t.setViewMode("VR"):t.setViewMode("VR"),e(!1)};var r=localStorage.getItem("cameraFacing");1==localStorage.getItem("doExchangeCamera")?"environment"==r?(localStorage.setItem("cameraFacing","user"),console.log("------- set _cameraFacing to user")):(localStorage.setItem("cameraFacing","environment"),console.log("------- set _cameraFacing to environment")):(localStorage.setItem("cameraFacing","environment"),window.makarID?localStorage.setItem("makarID",window.makarID):console.log("three.js: doExchangeCamera != 1, window.makarID isn't exist, wait the Start AR button trigger"));var o=localStorage.getItem("cameraFacing");localStorage.setItem("doExchangeCamera",0);let n=document.createElement("video"),s={facing:o},i=new THREE.VideoTexture(n);i.minFilter=THREE.LinearFilter,i.flipY=!1,i.format=THREE.RGBAFormat,t.cameraTexture=i;let l=new THREE.Vector2;if(t.vrScene.renderer.getSize(l),navigator.mediaDevices){let r=function(a){console.log("VRFunc.js: _startWebCam: _videoSuccess: stream=",a),window.videoStream=a,n.srcObject=a,n.playsInline=!0,n.onloadedmetadata=function(){t.videoCamera?console.log("VRFunc.js: _startWebCam: videoCamera exist, donothing "):(console.log("VRFunc.js: _startWebCam: videoCamera not exist, start video "),function a(){if(n.videoWidth>200||n.videoHeight>200){let a,r,o,s;if(console.log("VRFunc.js: tick_video play video[w, h]=",n.videoWidth,n.videoHeight),t.video=n,document.getElementById("vrDiv"),l.x/l.y>n.videoWidth/n.videoHeight?(o=window.innerWidth,s=window.innerWidth/n.videoWidth*n.videoHeight,console.log(" 1 VRFunc.js: set div size = ",innerWidth,innerHeight,o,s,a,r)):(o=window.innerHeight/n.videoHeight*n.videoWidth,s=window.innerHeight,console.log(" 2 VRFunc.js: set div size = ",innerWidth,innerHeight,o,s,a,r)),t.GLRenderer.setSize(o,s),t.vrScene.canvas.style.left=(innerWidth-o)/2+"px",t.vrScene.canvas.style.top=(innerHeight-s)/2+"px",t.vrScene.resize(),Browser){let e,a;if(1==Browser.desktop){let r=l.x,n=l.y;o>2560||s>2560?(o>s?(e=2560,a=2560*s/o):(e=2560*o/s,a=2560),t.GLRenderer.setSize(e,a,!1)):(r<1280||n<1280)&&(o>s?(e=1280*o/s,a=1280):(e=1280,a=1280*s/o),t.GLRenderer.setSize(e,a,!1))}else 1==Browser.mobile&&(o<720||s<720)&&(o>s?(e=720,a=720/o*s):(e=720/s*o,a=720),t.GLRenderer.setSize(e,a,!1))}a=i.image.videoWidth,r=i.image.videoHeight;let c=new THREE.OrthographicCamera(-o/2,o/2,-s/2,s/2,-100,2e4);t.camera2D=c;let d=new THREE.PerspectiveCamera(60,o/s,.3,1e4);t.camera3D=d;let u=document.getElementById("aCamera");u.setObject3D("camera",d);let m={aspect:o/s,near:.3,far:1e4,fov:60};u.setAttribute("camera",m),u.components.camera.camera=d,t.vrScene.camera=d;let p=new THREE.Vector3;p.multiply(new THREE.Vector3(-1,-1,0)).add(new THREE.Vector3(0,180,0)),u.components["look-controls"].yawObject.rotation.y=p.y/180*Math.PI,u.components["look-controls"].pitchObject.rotation.x=p.x/180*Math.PI;let _=document.getElementById("oCamera"),h=new THREE.PerspectiveCamera(60,o/s,.3,1e4),g=_.getObject3D("camera").position.clone();h.position.copy(g),t.oCamera3D=h,_.setObject3D("camera",h),_.setAttribute("camera",m),_.components.camera.camera=h,_.components["orbit-controls"].controls.object=h,parent.selectedProject?"VR"==parent.selectedProject.viewMode?t.setViewMode("vR"):"model"==parent.selectedProject.viewMode?t.setViewMode("model"):t.setViewMode("VR"):t.setViewMode("VR");let b=new THREE.OrthographicCamera(-a/2,a/2,-r/2,r/2,-10,2e4);t.videoCamera=b;let y=new THREE.Mesh(new THREE.PlaneGeometry(a,r),new THREE.MeshBasicMaterial({map:i,side:THREE.DoubleSide}));y.position.set(0,0,-1),t.videoScene.add(y),t.videoPlane=y,e&&e(!0)}else console.log("tick_video else video[w, h]=",n.videoWidth,n.videoHeight),setTimeout(a,100)}())}};navigator.mediaDevices.enumerateDevices().then((function(e){let t,o,n,i=!1;e=e.filter((function(e){return"videoinput"===e.kind})),o="environment"==s.facing?"back":"user"==s.facing?"front":"back";for(let a in e)-1!=e[a].label.toLowerCase().search(o)&&(t=e[a].deviceId,i=!0);if(i)console.log("VRFunc.js: useDeviceID true, cameraID=",t),n={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},deviceId:{exact:t}}};else{let e;s.facing?(e=s.facing,console.log("VRFunc.js: configuration.facing do exist: set facing = ",e),n={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:e}}):(console.log("api.js: configuration.facing dosent exist: set facing = environment"),n={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:"environment"}})}navigator.mediaDevices.getUserMedia(n).then(r,a)}))}else navigator.getUserMedia?navigator.getUserMedia(hdConstraints,success,a):a("navigator.getUserMedia is not supported on your browser")}switchCamera(e){let t=this,a=e||{facing:"environment"},r=localStorage.getItem("cameraFacing");null==r?localStorage.setItem("cameraFacing","environment"):"environment"==r?(a.facing="user",localStorage.setItem("cameraFacing","user")):"user"==r&&(a.facing="environment",localStorage.setItem("cameraFacing","environment")),t.video.srcObject.getTracks().forEach((e=>{e.stop()}));let o=function(e){if(console.log("three.js: _startWebCam: videoSuccess: stream=",e),window.videoStream=e,t.videoPlane.material.map.image){let a=t.videoPlane.material.map.image;a.srcObject=e,a.playsInline=!0,a.onloadedmetadata=function(){t.videoCamera?console.log("three.js: _startWebCam: videoCamera exist, donothing "):console.log("three.js: _startWebCam: videoCamera not exist, start video "),function e(){a.videoWidth>200||a.videoHeight>200?(a.play(),console.log("three.js: _switchCamera: video play  ")):setTimeout(e,100)}()},t.streamVideo=a}},n=function(e){console.log("three.js: _switchCamera: onError e = ",e)};navigator.mediaDevices.enumerateDevices().then((function(e){let t,r,s,i=!1;e=e.filter((function(e){return"videoinput"===e.kind})),r="environment"==a.facing?"back":"user"==a.facing?"front":"back";for(let a in e)-1!=e[a].label.toLowerCase().search(r)&&(t=e[a].deviceId,i=!0);if(i)console.log("three.js: _useDeviceID true, cameraID=",t),s={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},deviceId:{exact:t}}};else{let e;a.facing?(e=a.facing,console.log("three.js: _configuration.facing do exist: set facing = ",e),s={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:e}}):(console.log("api.js: _configuration.facing dosent exist: set facing = environment"),s={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:"environment"}})}navigator.mediaDevices.getUserMedia(s).then(o,n)}))}};!function(){const e=()=>{AFRAME.registerComponent("initvrscene",{init:function(){this.el}}),AFRAME.registerComponent("cursor-listener",{init:function(){}}),r(),Module.checkMifly(),window.showVRProjList=function(t){if(console.log("VRFunc.js: version: 2022-07-28 1650 "),t&&"string"==typeof t.user_id&&"string"==typeof t.proj_id){let a=t.user_id,r=[t.proj_id];if(window.makarSDK){let e=window.makarSDK.config.proj_id,o=window.makarSDK.config.user_id;if(!window.makarSDK||!window.makarSDK.config.proj_id||"string"!=typeof e||"string"!=typeof o)return void console.error("MakarSDK is initiated, but lack of config.",MakarSDK.config);if(e!=t.proj_id)return void console.error("MakarSDK is initiated, but config is conflict with oneProjData. makarSDK.config=",makarSDK.config);o&&o!=t.user_id&&console.warn("MakarSDK is initiated, but config is conflict with oneProjData. Using oneProjData instead of makarSDK.config."),r=[e],a=o}let o={};window.makarUserData=o,o.oneProjData=t;let n=[],s=i.getProjectSceneList(r),l=i.getUserOnlineResources(a),c=i.getUserResources(a),d=i.GetUserMaterials(a);n.push(s),n.push(l),n.push(c),n.push(d),s.then((function(e){console.log(" _pScenes_: ",e),e.data&&Array.isArray(e.data.projectSceneList)&&1==e.data.projectSceneList.length&&(o.scenesData=e.data.projectSceneList[0])})),l.then((function(e){if(e.data&&Array.isArray(e.data.onlineResourcesList)){let t=e.data.onlineResourcesList;o.onlineResourcesList=t;let a={};for(let e=0;e<t.length;e++)a[t[e].res_id]=t[e];o.userOnlineResDict=a}})),c.then((function(e){if(e.data&&Array.isArray(e.data.resourcesList)){let t=e.data.resourcesList;o.resourcesList=t;let a={};for(let e=0;e<t.length;e++)a[t[e].res_id]=t[e];o.userProjResDict=a}})),d.then((function(e){if(console.log(" _pUM_: ",e),e.data&&Array.isArray(e.data.materials)){let t=e.data.materials;o.materials=t;let a={};for(let e=0;e<t.length;e++)a[t[e].id]=t[e];o.userMaterialDict=a}})),Promise.all(n).then((function(t){console.log(" _pScenesAll_ ",t),window.showVRProjList=void 0,e(0)}))}};const e=function(e=0){let t,a=document.getElementsByTagName("video");if(a.length>0)for(let e=0;e<a.length;e++)a[e].pause(),a[e].removeAttribute("src"),a[e].load();document.getElementById("vrDiv")&&document.getElementById("vrDiv").remove();let o,n=document.createElement("a-scene");if(n.setAttribute("id","vrscene"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("embedded",""),n.setAttribute("vr-mode-ui","enabled: false"),n.setAttribute("debug","true"),t=document.createElement("div"),window.makarSDK&&window.makarSDK.config&&window.makarSDK.container?(t=window.makarSDK.vrDiv,o=window.makarSDK.container):o=document.documentElement,t.style.position="relative",t.setAttribute("id","vrDiv"),t.setAttribute("crossorigin","anonymous"),t.style.width=o.clientWidth+"px",t.style.height=Math.round(o.clientHeight-0)+"px",t.style.top="0px",window.onresize=function(){t.style.width=o.clientWidth+"px",t.style.height=Math.round(o.clientHeight-0)+"px",window.vrController&&s.vrScene&&s.GLRenderer&&(console.log("window _resize: _clearTimeout and _setTimeout "),clearTimeout(s.sizeTimeOutID),s.sizeTimeOutID=setTimeout((function(){let e=window.vrController,t=new THREE.Vector2;e.vrScene.renderer.getSize(t);let a=window.makarSDK?window.makarSDK.container.clientWidth:window.innerWidth,r=window.makarSDK?window.makarSDK.container.clientHeight:window.innerHeight;e.GLRenderer.setSize(a,r),window.makarSDK||(e.vrScene.canvas.style.left=(innerWidth-a)/2+"px",e.vrScene.canvas.style.top=(innerHeight-r)/2+"px");let o=s.scaleRatioXY,n=s.get2DScaleRatio();if(e.camera2D.left=-a/2*o/n,e.camera2D.right=a/2*o/n,e.camera2D.top=-r/2*o/n,e.camera2D.bottom=r/2*o/n,e.camera2D.updateProjectionMatrix(),e.vrScene.resize(),Browser){let o,n;if(1==Browser.desktop){let s=t.x,i=t.y;a>2560||r>2560?(a>r?(o=2560,n=2560*r/a):(o=2560*a/r,n=2560),e.GLRenderer.setSize(o,n,!1)):(s<1280||i<1280)&&(a>r?(o=1280*a/r,n=1280):(o=1280,n=1280*r/a),e.GLRenderer.setSize(o,n,!1))}else 1==Browser.mobile&&(a<720||r<720)&&(a>r?(o=720,n=720/a*r):(o=720/r*a,n=720),e.GLRenderer.setSize(o,n,!1))}let i=e.vrScene.camera;i.aspect=a/r,i.updateProjectionMatrix();let l=document.getElementById("oCamera").components.camera.camera;l.aspect=a/r,l.updateProjectionMatrix(),console.log("2 window _resize: ",a,r,e.GLRenderer.getSize(t))}),50))},window.makarSDK){const e=new CustomEvent("vrDivReady",{detail:{name:"(for webSDK) vrDiv is ready.",vrDiv:t}});window.makarSDK.container.dispatchEvent(e)}else document.body.appendChild(t);t.appendChild(n),n.hasLoaded?i():n.addEventListener("loaded",(()=>{i()})),n.addEventListener("enter-vr",(function(){})),n.addEventListener("renderstart",(function(){}));let s=new N(makarUserData);if(window.vrController=s,window.makarSDK&&(window.makarSDK.currentActiveController=s),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();s.voices=e}function i(){n.children[2].attributes,n.setAttribute("shadow","type: pcfsoft");let a=new THREE.Vector2;n.renderer.getSize(a),n.renderer.sortObjects=!0,console.log(" **************** vrScene ",n.object3D),n.renderer.autoClear=!1;let o=new THREE.Scene;s.scene2D=o;let i=t.clientWidth,c=t.clientHeight,d=new THREE.OrthographicCamera(-i/2,i/2,-c/2,c/2,-100,2e4);s.camera2D=d,s.vrScene=n,s.GLRenderer=n.renderer;let u=new THREE.Scene;s.videoScene=u,s.setupFunction(),setTimeout((function(){m.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 0; thetaStart: 0;"),m.setAttribute("cursor","fuse: true; fuseTimeout: 5"),m.setAttribute("animation__mouseenter","property: geometry.thetaLength; delay: 5; startEvents: mouseenter; dur: 5; from: 0.5; to: 360"),m.setAttribute("animation__mouseleave","property: geometry.thetaLength; startEvents: mouseleave; dur: 100; from: 360; to: 0.5"),s.cursorEntity=m}),1);let m=document.createElement("a-entity");m.setAttribute("id","cursor_main"),m.setAttribute("raycaster","objects: .clickable"),m.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 0; thetaStart: 0;"),m.setAttribute("position","0 0 -0.1"),m.setAttribute("material","color: red; shader: flat; ");let p=document.createElement("a-entity");p.setAttribute("id","cursor_default"),p.setAttribute("geometry","primitive: ring; radiusOuter: 0.002; radiusInner: 0.0014; thetaLength: 360; thetaStart: 0;"),p.setAttribute("position","0 0 -0.1001"),p.setAttribute("material","color: #2ADD2A; shader: flat; ");let _="VR",h=!!window.makarSDK,g=!1;parent.selectedProject&&("XR"==parent.selectedProject.viewMode?(_="VR",h=!0):"model"==parent.selectedProject.viewMode?(_="model",g=!0):(_="VR",h=!0)),s.viewMode=_;let b=document.createElement("a-entity");b.setAttribute("camera",{active:!0,fov:80}),b.setAttribute("look-controls",""),b.setAttribute("wasd-controls",""),b.setAttribute("camera","active",h),b.setAttribute("id","aCamera"),b.setAttribute("position",{x:0,y:0,z:0}),b.setAttribute("camera","fov",60),b.setAttribute("camera","near",.3),b.setAttribute("camera","far",2e4),console.log("VRFunc.js: aCamera=",b);let y=document.createElement("a-entity");y.setAttribute("id","oCamera");let f={active:g,fov:80,near:.3,far:1e4,aspect:a.x/a.y};y.setAttribute("camera",f),y.setAttribute("orbit-controls","minPolarAngle: 0; \n                maxPolarAngle: 180; \n                minDistance: 0.1; \n                maxDistance: 1000; \n                initialPosition: -5 5 13;");let v=document.createElement("a-entity");v.setAttribute("id","cameraForGyro"),v.setAttribute("crossorigin","anonymous"),v.setAttribute("camera",{active:!1}),v.setAttribute("look-controls",{enabled:!0,touchEnabled:!1});let w=document.createElement("a-entity");w.setAttribute("id","camera_cursor"),w.setAttribute("position",{x:0,y:0,z:0}),w.setAttribute("rotation","0 0 0"),w.appendChild(b),w.appendChild(y),w.appendChild(v),n.appendChild(w);let j=document.createElement("a-light");if(j.setAttribute("id","ambientLight"),j.setAttribute("type","ambient"),j.setAttribute("color","#808080"),j.setAttribute("ground-color","#fff"),j.setAttribute("intensity",1),n.appendChild(j),b.getObject3D("camera"),y.getObject3D("camera"),makarUserData.oneProjData.proj_descr+="_walking",makarUserData.oneProjData.proj_descr.includes("_walking")){let e=s;e.walkingStatus=-1;let t=document.createElement("a-entity");t.setAttribute("id","pointerSphere"),t.setAttribute("geometry","primitive: ring; radiusInner: 0.35; radiusOuter: 0.5"),t.setAttribute("material","shader: flat; color: white; side: double; opacity: 0.3; "),t.setAttribute("position",{x:0,y:0,z:0}),t.setAttribute("rotation",{x:90,y:0,z:0}),t.setAttribute("visible",!1),e.vrScene.appendChild(t);let a=document.createElement("a-entity");a.setAttribute("id","currentPosSphere"),a.setAttribute("geometry","primitive: ring; radiusInner: 0.35; radiusOuter: 0.5"),a.setAttribute("material","shader: flat; color: #0AC4B6; side: double; opacity: 0.3; "),a.setAttribute("position",{x:0,y:0,z:0}),a.setAttribute("rotation",{x:90,y:0,z:0}),a.setAttribute("visible",!1),e.vrScene.appendChild(a);let r=document.createElement("a-entity");r.setAttribute("id","__ground"),r.setAttribute("geometry","primitive: plane; height: 1000; width: 1000; "),r.setAttribute("material","shader: flat; color: blue; side: back; opacity: 0.05; visible: true "),r.setAttribute("visible",!1),r.setAttribute("position",{x:0,y:.1,z:0}),r.setAttribute("rotation",{x:90,y:0,z:0}),r.addEventListener("loaded",(function(){r.object3D.renderOrder=9999})),e.vrScene.appendChild(r)}let D=function(a){t=document.getElementById("vrDiv"),console.log("VRFunc.js: activeVRScenes: initvrscene: vrScene.camera active = ",n.camera.aspect,t.clientWidth,t.clientHeight),n.camera.aspect=t.clientWidth/t.clientHeight,n.camera.fov=60,n.camera.updateProjectionMatrix();let o=!1;for(let e=0;e<s.scenesData.scenes.length;e++)"camera"==s.scenesData.scenes[e].environment.scene_skybox_res_id&&(o=!0);o?(window.makarSDK||parent.projMenuMobileSwitchCam&&(parent.projMenuMobileSwitchCam.style.display="inline-block"),s.startWebCam((function(t){if(0==t){console.log(" _XRFunc.js: _startWebCam: error ");let e=document.createElement("a-sky");e.setAttribute("id","sky"),e.setAttribute("material",{src:"https://s3-ap-northeast-1.amazonaws.com/mifly0makar0assets/Users/76ad6ef7-e89e-4f35-9c8d-0f40617f64a1/VRProjectMipmap/740c26126aab4eeca6adf5dc268814b3_4096.jpg"}),s.vrScene.appendChild(e);let t=setInterval((function(){document.getElementById("sky").object3D&&(s.onlySkyScene.add(document.getElementById("sky").object3D.clone(!0)),clearInterval(t))}))}let a=s.get2DScaleRatio();s.set2DScaleRatio(a),s.loadScene(e),s.userStartTime=(new Date).getTime(),r(),Module.checkMifly(),l(),setTimeout((function(){s.video.play&&s.video.play()}),1e3)}))):(s.triggerEnable=!1,s.loadScene(e),s.userStartTime=(new Date).getTime(),r(),Module.checkMifly()),n.removeEventListener("camera-set-active",D)};n.addEventListener("camera-set-active",D);let E=new THREE.WebGLRenderTarget(1024,1024);s.skyRenderTarget=E,s.needsRenderTarget=!1,l()}let l=function(){if(s.GLRenderer.clear(),s.videoCamera&&(s.video.paused||s.GLRenderer.render(s.videoScene,s.videoCamera)),s.GLRenderer.clearDepth(),s.needsRenderTarget&&(s.GLRenderer.setRenderTarget(s.skyRenderTarget),s.GLRenderer.clear(),s.GLRenderer.render(s.onlySkyScene,s.vrScene.camera),s.GLRenderer.setRenderTarget(null)),s.GLRenderer.render(s.vrScene.object3D,s.vrScene.camera),s.needsCullFaceBack){for(let e=0;e<s.cullFaceBackScene.children.length;e++){let t=document.getElementById(s.cullFaceBackScene.children[e].obj_id).object3D;s.cullFaceBackScene.children[e].position.setFromMatrixPosition(t.matrixWorld),s.cullFaceBackScene.children[e].setRotationFromMatrix(t.matrixWorld)}s.GLRenderer.state.setCullFace(THREE.CullFaceFront),s.GLRenderer.render(s.cullFaceBackScene,s.vrScene.camera),s.GLRenderer.state.setCullFace(THREE.CullFaceBack)}s.GLRenderer.render(s.scene2D,s.camera2D),window.makarSDK&&window.makarSDK.workWithRenderTick(),requestAnimationFrame(l)}}};let t;t="undefined"!=typeof window?window:self;let a=0,o=function(){a++,a>3?console.log("VRFunc.js: integrateTick, integrateCount=",a,", too many times"):t.AFRAME&&t.THREE?(console.log("VRFunc.js: integrateTick, scope=",t,a),e(),window.addEventListener("keyup",(function(e){"Enter"===e.key&&e.preventDefault()}))):setTimeout((function(){o(a)}),500)};"undefined"!=typeof window&&o(a),console.log("VRFunc done, window innerWH",window.innerWidth,window.innerHeight);let n=window.languageType="tw";if(parent){let e=parent.location.pathname.indexOf("/",0),t=parent.location.pathname.indexOf("/",e+1),a=parent.location.pathname.substring(1,t);"tw"!=a&&"en"!=a||(n=window.languageType=a)}window.worldContent={userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"Please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"Comfire"}}}()})();