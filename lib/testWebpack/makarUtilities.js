!function(){"use strict";if(!e)var e=(new Date).getTime();if(window.Browser=function(e){void 0===e&&(e=window.navigator.userAgent),e=e.toLowerCase();var t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],r=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(silk)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||/(playbook)/.exec(e)||/(bb)/.exec(e)||/(blackberry)/.exec(e)||[],s={},o={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",versionNumber:t[4]||t[2]||"0",platform:r[0]||""};if(o.browser&&(s[o.browser]=!0,s.version=o.version,s.versionNumber=parseInt(o.versionNumber,10)),o.platform&&(s[o.platform]=!0),(s.android||s.bb||s.blackberry||s.ipad||s.iphone||s.ipod||s.kindle||s.playbook||s.silk||s["windows phone"])&&(s.mobile=!0),(s.cros||s.mac||s.linux||s.win)&&(s.desktop=!0),(s.chrome||s.opr||s.safari)&&(s.webkit=!0),s.rv||s.iemobile){var n="msie";o.browser=n,s[n]=!0}if(s.edge){delete s.edge;var i="msedge";o.browser=i,s[i]=!0}if(s.safari&&s.blackberry){var a="blackberry";o.browser=a,s[a]=!0}if(s.safari&&s.playbook){var l="playbook";o.browser=l,s[l]=!0}if(s.bb){var d="blackberry";o.browser=d,s[d]=!0}if(s.opr){var p="opera";o.browser=p,s[p]=!0}if(s.safari&&s.android){var u="android";o.browser=u,s[u]=!0}if(s.safari&&s.kindle){var c="kindle";o.browser=c,s[c]=!0}if(s.safari&&s.silk){var _="silk";o.browser=_,s[_]=!0}s.name=o.browser,s.platform=o.platform;var h=/micromessenger/.test(e),g=/line/.test(e),w=/fban/.test(e)||/fbav/.test(e);return h?s.app="weChat":g?s.app="Line":w&&(s.app="FB"),(["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document)&&(s.iOS=!0),s}(window.navigator.userAgent),!t)var t=(new Date).getTime();t&&e&&console.log("processing time(uaMatch):",t-e)}(),function(){"use strict";function e(e){let t=atob(e).split("").map((function(e){return e.charCodeAt(0)})),r=new Uint8Array(t),s=pako.inflate(r),o=String.fromCharCode.apply(null,new Uint16Array(s));return JSON.parse(o)}window.parseUserData=function(e,t){let r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="json",r.onload=function(e){for(var t in r.response.data?window.file=r.response.data:window.file=r.response,window.file.scene_objs_v2)for(var s in window.file.scene_objs_v2[t].transform){var o=window.file.scene_objs_v2[t].transform[s].split(",");if(3!=o.length)return-1;var n=[parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])];window.file.scene_objs_v2[t].transform[s]=n}return window.file},r.send(),r.response},window.getARProjsByUserID=function(t,r,s){if(!t)return-1;r||(r="makarvr");let o=new XMLHttpRequest,n={user_id:r,cid:"20"};if("3.0.0"==serverVersion&&(console.log("%cnetWorkAgent.js: getARProjsByUserID: you shoudnt see this, Fei abandon this function in server V3","color:red"),getResByUserID(t,r,"","",(function(){console.log("netWorkAgent.js: getARProjsByUserID: getResByUserID: callback");let e=t+"get_ar_projs",r={ver:"3.0.0",cid:5,data:n},i=JSON.stringify(r);o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){let t;console.log("networkAgent.js: getARProjsByUserID,  onload xhr.response = ",o.response),o.response.error?(s&&s(o.response.error),console.log("networkAgent.js: getARProjsByUserID: oops something wrong:",o.response.error)):o.response.data?(t=o.response.data,window.userARData,window.userARData=t,s&&s(t)):s&&s("networkAgent.js:error: no xhr.response.data")},o.send(i)}))),"2.0.0"==serverVersion){let r=JSON.stringify(n),i=new FormData;i.append("cmd","get_ar_projs"),i.append("data",r),o.open("POST",t,!0),o.responseType="json",o.onload=function(t){let r;if(console.log("networkAgent.js:getARProjsByUserID:",o.response),o.response.diaoyurar){let t=e(o.response.diaoyurar);t.error?(s&&s(t.error),console.log("networkAgent.js: getARProjsByUserID: oops something wrong:",t.error)):t.data?(r=t.data,window.userARData?(console.log("networkAgent.js: getARProjsByUserID: window.userARData already exist, replace it.."),window.userARData=r):window.userARData=r,s&&s(r)):s&&s("networkAgent.js:error: no jsonData.data")}else o.response.error?(s&&s(o.response.error),console.log("networkAgent.js: getARProjsByUserID: oops something wrong:",o.response.error)):o.response.data?(r=o.response.data,window.userARData,window.userARData=r,s&&s(r)):s&&s("networkAgent.js:error: no xhr.response.data")},o.send(i)}},window.getUserPublishProjsByUserID=function(e,t,r,s,o){if(!e)return-1;t||(t="makarvr"),r||(r=""),s||(s="");let n=new XMLHttpRequest,i={user_id:t,web_ar:!0};"3.0.0"==serverVersion&&getResByUserID(e,t,r,s,(function(a){getUsrOnlineRes(e,t,r,s,"",(function(t){let r=e+"get_usr_publish_projs",s={ver:"3.0.0",cid:5,data:i},l=JSON.stringify(s);n.open("POST",r,!0),n.setRequestHeader("Content-Type","application/json"),n.responseType="json",n.onload=function(e){let r;n.response.error?(o&&o(n.response.error),console.log("%cnetworkAgent.js: _getUserPublishProjs: oops something wrong: ","color:red",n.response.error)):n.response.data?(r=n.response.data,window.userPublishProjs,window.userPublishProjs=r,o&&o(r,a,t)):o&&o("networkAgent.js:error: no xhr.response.data")},n.send(l)}))}))},window.getNewestPublishProjs=function(e,t,r){if(!e)return-1;t||(t="vr");let s=new XMLHttpRequest;if("3.0.0"==serverVersion){let r=e+"get_newest_publish_projs",o={ver:"3.0.0",cid:5,data:{proj_type:t}},n=JSON.stringify(o);s.open("POST",r,!0),s.setRequestHeader("Content-Type","application/json"),s.responseType="json",s.onload=function(e){console.log("networkAgent.js: getNewestPublishProjs,  onload xhr.response = ",s.response)},console.log("networkAgent.js: getNewestPublishProjs, jsonReq=",n),s.send(n)}},window.getResByUserID=function(e,r,s,o,n){r||(r="makarvr"),s||(s=""),o||(o="");let i=e+"get_res",a=new XMLHttpRequest,l={ver:"3.0.0",cid:5,data:{user_id:r,main_type:s,sub_type:o}},d=JSON.stringify(l);a.open("POST",i,!0),a.setRequestHeader("Content-Type","application/json"),a.responseType="json",a.onload=function(e){a.response.error?console.log("%cnetworkAgent: _getResByUserID,  onload error ","color:red",a.response):(console.log("%cnetworkAgent: _getResByUserID,  onload save ","color:blue",a.response.data.list),a.response.data.list.length>0?t(a.response.data.list,(function(e){n&&n(e)})):n&&(console.log("networkAgent: _getResByUserID,  onload  use res is empty "),n({})))},a.send(d)};var t=function(e,t){if(!e)return-1;let r={};for(let s=0;s<e.length;s++)r[e[s].res_id]=e[s],s==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",s,e.length),t&&t(r))};window.getUsrOnlineRes=function(e,t,s,o,n,i){t||(t="fefe"),s||(s=""),o||(o=""),n||(n="");let a=e+"get_usr_online_res",l=new XMLHttpRequest,d={ver:"3.0.0",cid:5,data:{user_id:t,main_type:s,sub_type:o,category:n}},p=JSON.stringify(d);l.open("POST",a,!0),l.setRequestHeader("Content-Type","application/json"),l.responseType="json",l.onload=function(e){console.log("networkAgentVR.js: _getUsrOnlineRes: res = ",l.response),l.response.error?console.log("networkAgent.js: _getUsrOnlineRes,  onload error ",l.response):(console.log("networkAgent.js: _getUsrOnlineRes,  onload save ",l.response),l.response.data.online_res_list.length>0?r(l.response.data.online_res_list,(function(e){i&&i(e)})):i&&(console.log("networkAgent: _getUsrOnlineRes,  onload  use res is empty "),i({})))},l.send(p)};var r=function(e,t){if(!e)return-1;let r={};for(let s=0;s<e.length;s++)r[e[s].res_id]=e[s],s==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",s,e.length),t&&t(r))};function s(e,t,r){let s=new XMLHttpRequest,o={ver:"3.1.1",cid:5,data:t},n=JSON.stringify(o);s.open("POST",e,!0),s.setRequestHeader("Content-Type","application/json"),s.responseType="json",s.addEventListener("load",(function(){r&&r(s.response)})),s.send(n)}window.getOneUserInfo=function(e,t,r,s){let o=new XMLHttpRequest,n=e+"get_one_usr_info",i={ver:"3.0.0",cid:5,data:{user_id:t,wanted_info_keys:r}},a=JSON.stringify(i);o.open("POST",n,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){""==o.response.error?s&&s(o.response):s&&s(o.response.error)},o.send(a)},window.getViewerConfig=function(e,t){if(!e)return-1;let r=e+"get_viewer_config",s=new XMLHttpRequest,o=JSON.stringify({ver:"3.1.1",cid:5,data:{}});s.open("POST",r,!0),s.setRequestHeader("Content-Type","application/json"),s.responseType="json",s.onload=function(e){console.log("networkAgent.js: _getViewerConfig: xhr.response",s.response),t&&t(s.response)},s.send(o)},window.getARProjsByProjID=function(e,t){if(null==e)return;if(!Array.isArray(e))return;if(e.length<1)return;let r=new XMLHttpRequest,s={proj_id_list:e},o=window.serverUrl+"get_ar_projs_by_proj_id",n={ver:"3.0.0",cid:5,data:s},i=JSON.stringify(n);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){""==r.response.error?t&&t(r.response):t&&t(r.response.error)},r.send(i)},window.getVRSceneByUserID=function(e,t,r){if(!e)return-1;t||(t="makarvr");let s=[];if(s.user_id=t,"3.0.0"==serverVersion){var o=function(t,o,n){if(console.log("networkAgent.js: getVRSceneByUserID: _getUserPublishProjsByUserID: userPublishProjs=",t),"string"!=typeof t){let i=[];for(let e in t.proj_list)if("vr"==t.proj_list[e].proj_type){if(parent.useEditorWebTag&&!t.proj_list[e].proj_platform.find((e=>"web"==e)))continue;i.push(t.proj_list[e].proj_id)}let a=new XMLHttpRequest,l=e+"get_vr_projs_by_proj_id",d={ver:"3.0.0",cid:5,data:{proj_id_list:i}},p=JSON.stringify(d);a.open("POST",l,!0),a.setRequestHeader("Content-Type","application/json"),a.responseType="json",a.onload=function(t){let i=a.response.data;window.publishVRProjs=i;let l=0;if(i.result&&i.result.length)for(let t=0;t<i.result.length;t++){let a=new XMLHttpRequest,d={user_id:i.result[t].user_id,proj_id:i.result[t].proj_id},p=e+"get_vr_proj_scene",u={ver:"3.0.0",cid:5,data:d},c=JSON.stringify(u);a.open("POST",p,!0),a.setRequestHeader("Content-Type","application/json"),a.responseType="json",a.onload=function(e){l++,s[t]=a.response.data,l==i.result.length&&(window.VRSceneResult=s,window.userProjResDict=o,window.userOnlineResDict=n,r&&r(s))},a.send(c)}},a.send(p)}};searchUserIDByUserID(e,t,(function(s){for(let e in s.result)t.toLowerCase()===s.result[e].user_id.toLowerCase()&&(console.log("networkAgentVR.js: _searchUserIDByUserID: match, replace from [",t,"] to [",s.result[e].user_id,"]"),t=s.result[e].user_id);getPayInfoByUserID(e,t,(function(s){!function(e,t){var r,s=new XMLHttpRequest;s.open("GET","https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/webVR_UserID_WhiteList.txt",!0),s.onreadystatechange=function(){if(4===s.readyState&&(200===s.status||0==s.status)){let e=s.responseText;r=e,t&&t(r)}},s.send(null)}(0,(function(n){let i=JSON.parse(n).customizedUserID.list,a=[];for(let e=0;e<i.length;e++)a.push(i[e].name);let l=a.indexOf(t.toLowerCase())>-1;s.data?(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: userPayInfo =",s.data),window.allowedMakarIDUseWeb=s.data.web_ar||l,"proA"!=s.data.user_type&&"proB"!=s.data.user_type&&"proC"!=s.data.user_type&&"custom"!=s.data.user_type||(window.allowedMakarIDUseWeb=!0),getUserPublishProjsByUserID(e,t,"","",o)):(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: error, userPayInfo=",s),r&&r("this ID <br> ["+t+"] <br> user data error, please contact MIFLY for more information. "))}))}))}))}},window.getPayInfoByUserID=function(e,t,r){if(!e)return-1;if(!t)return-1;let s=e+"get_pay_info",o=new XMLHttpRequest,n={ver:"3.0.0",cid:5,data:{user_id:t}},i=JSON.stringify(n);o.open("POST",s,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){r&&r(o.response)},o.send(i)},window.getELicenseInfo=function(e,t,r){if(!e)return-1;if(!t)return-1;let s=e+"get_e_lice_info",o=new XMLHttpRequest,n={ver:"3.1.1",cid:5,data:{license_key:t}},i=JSON.stringify(n);o.open("POST",s,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){r&&r(o.response)},o.send(i)},window.checkLicenseInProjs=function(e,t){let r=[],o=[],n=[],i=[];for(let e=0,t=userPublishProjs.proj_list.length;e<t;e++)switch(userPublishProjs.proj_list[e].proj_type){case"ar":r.push(userPublishProjs.proj_list[e].proj_id),i.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"vr":o.push(userPublishProjs.proj_list[e].proj_id),i.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"ar_slam":n.push(userPublishProjs.proj_list[e].proj_id),i.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;default:console.error("networkAgentVR.js: _checkLicenseInProjs: project type ERROR",userPublishProjs.proj_list[e].proj_type)}let a=[];function l(r){for(let s=0,o=i.length;s<o;s++)for(let o=0,n=r.data.result.length;o<n;o++)i[s].proj_id==r.data.result[o].proj_id&&(""!=r.data.result[o].editor_license_key?getELicenseInfo(e,r.data.result[o].editor_license_key,(function(e){""!=e.error?a.push({proj_id:i[s].proj_id,isLicense:!1}):a.push({proj_id:i[s].proj_id,isLicense:!0}),a.length==i.length&&t&&t(a)})):a.push({proj_id:i[s].proj_id,isLicense:!1}));a.length==i.length&&t&&t(a)}r.length>0&&s(e+"get_ar_projs_by_proj_id",{proj_id_list:r},l),o.length>0&&s(e+"get_vr_projs_by_proj_id",{proj_id_list:o},l),n.length>0&&s(e+"get_arslam_projs_by_proj_id",{proj_id_list:n},l)},window.getRecordModule=function(e,t,r,o){if(!e)return-1;s(e+"get_record_module",{playing_user_id:t,proj_id:r},(function(e){console.log("networkAgentVR.js: _getRecordModule: ret",e),o&&o(e)}))},window.quizLog=function(e,t,r){s(e+"quiz_log",t,(function(e){console.log("networkAgentVR.js: _quizLog: ret",e),r&&r(e)}))},window.updateRecordModule=function(e,t,r){s(e+"update_record_module",t,(function(e){console.log("networkAgentVR.js: _updateRecordModule: ret",e),r&&r(e)}))},window.getVRDataByUserID=function(t,r,s){if(!t)return-1;r||(r="makarvr");let o=new XMLHttpRequest,n={user_id:r,cid:"20"},i=JSON.stringify(n),a=new FormData;a.append("cmd","get_vr_projs"),a.append("data",i),o.open("POST",t,!0),o.responseType="json",o.onload=function(t){let r;if(o.response.diaoyurar){let t=e(o.response.diaoyurar);t.error?(s&&s(t.error),console.log("networkAgent.js: getVRDataByUserID: oops something wrong:",t.error)):t.data?(r=t.data,window.userVRData?(console.log("networkAgent.js: getVRDataByUserID: window.userARData already exist, replace it.."),window.userVRData=r):(console.log("networkAgent.js: getVRDataByUserID: save window.userARData "),window.userVRData=r),s&&s(r)):s&&s("networkAgent.js:getVRDataByUserID:error: no jsonData.data")}else o.response.error?(s&&s(o.response.error),console.log("networkAgent.js: getVRDataByUserID: oops something wrong:",o.response.error)):o.response.data?(r=o.response.data,r.proj_list?(window.userVRData?(console.log("networkAgent.js: getVRDataByUserID: window.userARData already exist, replace it.."),window.userVRData=r):(console.log("networkAgent.js: getVRDataByUserID: save window.userARData =",r),window.userVRData=r),s&&s(r)):(console.log("%cnetworkAgent.js:getVRDataByUserID: onload, fail userVRData.proj_list is empty","color:red"),s&&s("the userVRData.proj_list is empty"))):s&&s("networkAgent.js:getVRDataByUserID:error: no xhr.response.data")},o.send(a)},window.uploadDataToServer=function(e,t,r){if(!e)return-1;let s=new XMLHttpRequest,o={user_id:userARData.user_id,target_id:userARData.proj_list[t].target_id};if("3.0.0"==serverVersion){let t=e+"add_scan_times",r={ver:"3.0.0",cid:5,data:o},n=JSON.stringify(r);s.open("POST",t,!0),s.setRequestHeader("Content-Type","application/json"),s.responseType="json",s.onload=function(e){},s.send(n)}if("2.0.0"==serverVersion){let t=JSON.stringify(o),r=new FormData;r.append("cmd","add_scan_times"),r.append("data",t),s.open("POST",e,!0),s.responseType="json",s.onload=function(e){console.log("networkAgent: uploadDataToServer, xhr = ",s.response.data)},s.send(r)}},window.searchUserIDByUserID=function(e,t,r){if(!e)return-1;if(!t)return-1;let s=e+"get_many_usr_info_keyword",o=new XMLHttpRequest,n={ver:"3.0.0",cid:5,data:{keyword:t,search_keys:["user_id"]}},i=JSON.stringify(n);o.open("POST",s,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent.js: _searchUserIDByUserID: xhr.response",o.response.data),r&&r(o.response.data)},o.send(i)},window.testPOST=function(e,t){let r=new XMLHttpRequest,s=JSON.stringify({ver:"3.0.0",cid:5,data:{user_id:"fefe"},length:8});console.log(" jsonReq ",s);let o=new FormData;o.append("cmd","add_scan_times"),o.append("data",s),r.open("POST","http://60.250.125.146:8081/Makar/get_usr_publish_projs",!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent: testPOST,  onload xhr = ",r,r.response)},r.send(s)},window.getVRProjsByProjId=function(e,t){return new Promise(((r,s)=>{let o=new XMLHttpRequest,n=e+"get_vr_projs_by_proj_id",i={ver:"3.0.0",cid:5,data:{proj_id_list:t}},a=JSON.stringify(i);o.open("POST",n,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){o.response.error?(console.log("networkAgent.js: _getUsrOnlineRes,  onload error ",o.response),s(o.response.error)):(console.log("networkAgent.js: _getUsrOnlineRes,  onload ",o.response),r(o.response.data))},o.onerror=function(e){s(e)},o.send(a)}))}}(),(()=>{var e,t=function(){var e={};"function"==typeof Symbol&&Symbol.iterator,THREE.gifAnimator=class{constructor(){this.data={src:null,autoplay:!0,transparent:!0,opacity:1,side:THREE.DoubleSide}}init(e){let t=this;if(Object.keys(e).forEach((function(r){t.data[r]=e[r]})),this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset(),e.chroma){let t;if(console.log(" gif-animator.js: ***************************************** chroma= ",e.chroma),"RGB"==e.chroma.mode)t=new THREE.ChromaKeyMaterial({map:this.__texture,keyColor:e.chroma.chromakey.split(","),side:THREE.FrontSide,slope:e.chroma.slope,threshold:e.chroma.threshold});else if("HSV"==e.chroma.mode){let r=e.chroma.HSV.split(","),s=parseFloat(r[0]),o=parseFloat(r[1]),n=parseFloat(r[2]);t=new THREE.HSVMattingMaterial({map:this.__texture,side:THREE.FrontSide,_keyingColorH:s,_keyingColorS:o,_keyingColorV:n,_deltaH:e.chroma.hue,_deltaS:e.chroma.saturation,_deltaV:e.chroma.brightness})}this.material=t}else this.material=new THREE.MeshBasicMaterial({map:this.__texture});return this.__addPublicFunctions(),this.update(this.data),this.material}update(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material}tick(e){setTimeout(function(){!this.__frames||this.paused()||(this.__curTime=Date.now(),this.__curTime-this.__preTime>=this.__nextFrameTime&&(this.nextFrame(),this.__preTime=this.__curTime)),this.tick()}.bind(this),20)}__updateMaterial(e){var t=this.material,r=this.__getMaterialData(e);Object.keys(r).forEach((function(e){t[e]=r[e]}))}__getMaterialData(e){return{opacity:e.opacity,transparent:e.transparent,side:e.side,autoplay:e.autoplay}}__setTexure(e){"error"===e.status?(console.warn("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))}__updateTexture(e){var t=e.src,r=e.autoplay;"boolean"==typeof r?this.__autoplay=r:void 0===r&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()}__validateSrc(e,t){var r=function(e){return 0==e.indexOf("http")&&e.indexOf("gif")==e.length-3?e:void 0}(e);r&&this.__getImageSrc(r,t)}__getImageSrc(t,r){var s=this;if(t!==this.__textureSrc){var o=e[t];if(o&&o.callbacks){if(o.src)return void r(o);if(o.callbacks)return void o.callbacks.push(r)}else(o=e[t]={callbacks:[]}).callbacks.push(r);var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",(function(r){s.__getUnit8Array(t,(function(r){r?(0,s.parseGIF)(r,(function(r,s,n){var i={status:"success",src:t,times:r,cnt:s,frames:n,timestamp:Date.now()};o.callbacks&&(o.callbacks.forEach((function(e){return e(i)})),e[t]=i)}),(function(e){return i(e)})):i("This is not gif. Please use `shader:flat` instead")}))})),n.addEventListener("error",(function(e){return i("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),n.src=t}function i(r){var s=function(e,t){return{status:"error",src:t,message:e,timestamp:Date.now()}}(r,t);o.callbacks&&(o.callbacks.forEach((function(e){return e(s)})),e[t]=s)}}__getUnit8Array(e,t){if("function"==typeof t){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.addEventListener("load",(function(e){for(var r=new Uint8Array(e.target.response),s=r.subarray(0,4),o="",n=0;n<s.length;n++)o+=s[n].toString(16);"47494638"===o?t(r):t()})),r.addEventListener("error",(function(e){console.error(e),t()})),r.send()}}__validateAndGetQuerySelector(e){try{return document.querySelector(e)||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}}__addPublicFunctions(){this.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}}pause(){this.__paused=!0}play(){this.__paused=!1}togglePlayback(){this.paused()?this.play():this.pause()}paused(){return this.__paused}nextFrame(){this.__draw(),this.__nextFrameTime=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)}__clearCanvas(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__draw(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__ready(e){var t=e.src,r=e.times,s=e.cnt,o=e.frames;this.__textureSrc=t,this.__delayTimes=r,s?this.__loopCnt=s:this.__infinity=!0,this.__frames=o,this.__frameCnt=r.length,this.__startTime=Date.now(),this.__curTime=Date.now(),this.__preTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(o[0].width),this.__height=THREE.Math.floorPowerOfTwo(o[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause(),this.tick()}__reset(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__curTime=0,this.__preTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}parseGIF(e,t,r){var s=0,o=[],n=0,i=null,a=null,l=[],d=0;if(71!==e[0]||73!==e[1]||70!==e[2]||56!==e[3]||57!==e[4]&&55!==e[4]||97!==e[5])r&&r("parseGIF: no GIF89a");else{s+=13+ +!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3;for(var p=e.subarray(0,s);e[s]&&59!==e[s];){var u=s,c=e[s];if(33===c){var _=e[++s];if(-1===[1,254,249,255].indexOf(_)){r&&r("parseGIF: unknown label");break}for(249===_&&o.push(10*(e[s+3]+(e[s+4]<<8))),255===_&&(d=e[s+15]+(e[s+16]<<8));e[++s];)s+=e[s];249===_&&(i=e.subarray(u,s+1))}else{if(44!==c){r&&r("parseGIF: unknown blockId");break}for(s+=9,s+=1+ +!!(128&e[s])*(3*Math.pow(2,1+(7&e[s])));e[++s];)s+=e[s];a=e.subarray(u,s+1);var h={disposalMethod:i[3],blob:URL.createObjectURL(new Blob([p,i,a]))};l.push(h)}s++}}if(l.length){var g=document.createElement("canvas"),w=function e(r){var s=new Image;s.onload=function(r,s){n++,l[s]=this,n===l.length?(g=null,t&&t(o,d,l)):e(++s)}.bind(s),s.src=g.toDataURL("image/gif")};l.forEach((function(e,t){var r=new Image;r.onload=function(e,t){0===t&&(g.width=r.width,g.height=r.height),n++,l[t]=this,n===l.length&&(n=0,w())}.bind(r,null,t),r.src=e.blob,r.disposalMethod=e.disposalMethod}))}}},THREE.gifAnimator.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.gifAnimator.prototype.constructor=THREE.gifAnimator};"undefined"!=typeof window?e=window:console.error("gif-animator.js: window error",window);var r=function(){e.THREE?t():setTimeout(r,50)};r()})();