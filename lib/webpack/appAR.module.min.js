window.aScratchCard=new function(){"use strict";this.moduleLoaded=!1,this.currentMakarObject=null;var e=this;this.createContent=function(){this.scratchCardExchangeDiv=document.createElement("div"),this.scratchCardExchangeDiv.setAttribute("id","scratchCardExchangeDiv"),this.scratchCardExchangeDiv.innerText="尚未完成括括卡",this.scratchCardExchangeDiv.style.width="100%",this.scratchCardExchangeDiv.style.left="0%",this.scratchCardExchangeDiv.style.bottom="60px",this.scratchCardExchangeDiv.addEventListener("click",(function(e){let t=aScratchCard.currentMakarObject;t.scratchedAreaPercentage>30&&-1==t.exchanged?(console.log("-------------------------- can exchange show Div ",t.scratchedAreaPercentage,publishARProjs.proj_list[t.parent.GCSSID]),document.getElementById("inputPasswordDiv").style.display="inline"):console.log("-------------------------- can not exchange ",t.scratchedAreaPercentage,t.exchanged)}),!1),document.body.appendChild(this.scratchCardExchangeDiv),this.inputPasswordDiv=document.createElement("div"),this.inputPasswordDiv.setAttribute("id","inputPasswordDiv"),document.body.appendChild(this.inputPasswordDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.inputPasswordDiv.style.left=(innerWidth-e)/2+"px",this.inputPasswordDiv.style.top=(innerHeight-t)/2+"px",this.inputPasswordDiv.style.width=e+"px",this.inputPasswordDiv.style.height=t+"px",this.inputPasswordDiv.innerHTML="<br> 輸入密碼 <br>";var n=document.createElement("input");n.setAttribute("id","inputPasswordInputText"),n.setAttribute("type","text"),n.setAttribute("placeholder","pwd"),this.inputPasswordDiv.appendChild(n);var o=document.createElement("div");o.setAttribute("id","inputPasswordResultText"),this.inputPasswordDiv.appendChild(o),o.innerText="";var r=document.createElement("div");r.setAttribute("class","bottomLeftCell"),r.setAttribute("id","scratchCardPasswordCancel"),r.innerText="取消",this.inputPasswordDiv.appendChild(r),r.addEventListener("click",(function(){inputPasswordDiv.style.display="none",n.value="",o.innerText=""}));var a=document.createElement("div");a.setAttribute("class","bottomRightCell"),a.setAttribute("id","scratchCardPasswordConfirm"),a.innerText="確認",this.inputPasswordDiv.appendChild(a),a.addEventListener("click",this.passwordConfirm)},this.passwordConfirm=function(){if(inputPasswordInputText.value==e.currentMakarObject.password){inputPasswordResultText.innerText="密碼正確",scratchCardExchangeDiv.innerText="已兌換",e.currentMakarObject.exchanged=1,setTimeout((function(){inputPasswordDiv.style.display="none"}),1e3);let t=e.currentMakarObject,n=3;parent.mdb.setScratchProjectStateFromProjID(publishARProjs.proj_list[t.parent.GCSSID].proj_id,n).then((e=>{e.is_exchanged=!0,delete e.scratch_image_url,delete e.awards_image_url,console.log("scratchCard.js: _passwordConfirm: exchange upload setProjRet= ",e),scratchCardLog(window.serverUrl,e)}))}else inputPasswordResultText.innerText="密碼錯誤"},this.hideScratchCanvas=function(e){for(let t in e.children){let n=e.children[t];"module"==n.main_type&&"scratch_card"==n.sub_type&&(n.canvasDomElement.style.display="none",this.scratchCardExchangeDiv.style.display="none",this.inputPasswordDiv.style.display="none",inputPasswordInputText.value="",inputPasswordResultText.innerText="")}},this.showScratchCanvas=function(e){for(let t in e.children){let n=e.children[t];if("module"==n.main_type&&"scratch_card"==n.sub_type){let e=n.canvasDomElement;console.log("scratchCard.js: _showScratchCanvas: makarObj=",n),n.scratchedAreaPercentage>30?n.exchanged>0?this.scratchCardExchangeDiv.innerText="已兌換":this.scratchCardExchangeDiv.innerText="按此兌換獎項":this.scratchCardExchangeDiv.innerText="尚未完成括括卡",e.style.display="inline",this.scratchCardExchangeDiv.style.display="inline",this.currentMakarObject=n}}},this.clearScratchCanvas=function(e){e.scratchedAreaPercentage=100;let t=e.canvasDomElement.children[0];t&&(t.parentNode.removeChild(t),e.canvasDomElement.parentNode.removeChild(e.canvasDomElement)),e.exchanged>0?this.scratchCardExchangeDiv.innerText="已兌換":this.scratchCardExchangeDiv.innerText="按此兌換獎項"},this.randomChooseAward=function(e){let t=null;if(Array.isArray(e.project_module)&&1==e.project_module.length&&(t=e.project_module[0].award_list),!t)return-1;let n=0,o=[];for(let e in t)n+=t[e].probability,o.push(n);let r=Math.floor(Math.random()*n)+1,a=-1;console.log("scratchCard.js: _chooseAward: awardArray=",o,", getNum=",r);for(let e=0;e<o.length;e++)if(r<=o[e]){a=e;break}return a},this.clearScratchCard=function(){},this.setCanvas=function(t,n,o){this.moduleLoaded||(this.createContent(),this.moduleLoaded=!0),this.scratchCardExchangeDiv.style.display="inline",this.scratchCardExchangeDiv.innerText="尚未完成括括卡",o.scratchedAreaPercentage=-1,o.exchanged=-1,this.currentMakarObject=o;let r=t,a=r.width,s=r.height,i=r.getContext("2d");var l,c;let d=new Image;d.onload=function(){};let u=new XMLHttpRequest;function h(e,t){var n=0,o=0;if(void 0!==t.offsetParent)do{n+=t.offsetLeft,o+=t.offsetTop}while(t=t.offsetParent);return{x:(e.pageX||e.touches[0].clientX)-n,y:(e.pageY||e.touches[0].clientY)-o}}function p(e){l=!0,c=h(e,r)}function f(t){if(l){t.preventDefault();for(var n,u,p,f,g=h(t,r),m=(p=c,f=g,Math.sqrt(Math.pow(f.x-p.x,2)+Math.pow(f.y-p.y,2))),_=function(e,t){return Math.atan2(t.x-e.x,t.y-e.y)}(c,g),b=0;b<m;b++)n=c.x+Math.sin(_)*b-15,u=c.y+Math.cos(_)*b-15,i.globalCompositeOperation="destination-out",i.drawImage(d,n,u,80,40);c=g,function(t){if(t=t||0,o.scratchedAreaPercentage=t,t>30){console.log("scratchCard.js: _handlePercentage: clear scratch canvas ",e.currentMakarObject),e.clearScratchCanvas(e.currentMakarObject);let t=2;parent.mdb.setScratchProjectStateFromProjID(publishARProjs.proj_list[o.parent.GCSSID].proj_id,t).then((e=>{console.log("scratchCard.js: _passwordConfirm: exchange upload setProjRet= ",e),scratchCardLog(window.serverUrl,e)})),o.exchanged>0?scratchCardExchangeDiv.innerText="已兌換":scratchCardExchangeDiv.innerText="按此兌換獎項"}else scratchCardExchangeDiv.innerText="尚未完成括括卡"}(function(e){(!e||e<1)&&(e=1);for(var t=i.getImageData(0,0,a,s).data,n=t.length,o=n/e,r=0,l=r=0;l<n;l+=e)t[l+0]+t[l+1]+t[l+2]===0&&r++;return Math.round(r/o*100)}(32))}}function g(e){l=!1}u.open("GET","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/brush.png"),u.responseType="blob",u.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);d.src=t},u.send(),r.addEventListener("mousedown",p,!1),r.addEventListener("touchstart",p,!1),r.addEventListener("mousemove",f,!1),r.addEventListener("touchmove",f,!1),r.addEventListener("mouseup",g,!1),r.addEventListener("touchend",g,!1)}},function(){"use strict";if(!e)var e=(new Date).getTime();if(window.Browser=function(e){void 0===e&&(e=window.navigator.userAgent),e=e.toLowerCase();var t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],n=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(silk)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||/(playbook)/.exec(e)||/(bb)/.exec(e)||/(blackberry)/.exec(e)||[],o={},r={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",versionNumber:t[4]||t[2]||"0",platform:n[0]||""};if(r.browser&&(o[r.browser]=!0,o.version=r.version,o.versionNumber=parseInt(r.versionNumber,10)),r.platform&&(o[r.platform]=!0),(o.android||o.bb||o.blackberry||o.ipad||o.iphone||o.ipod||o.kindle||o.playbook||o.silk||o["windows phone"])&&(o.mobile=!0),(o.cros||o.mac||o.linux||o.win)&&(o.desktop=!0),(o.chrome||o.opr||o.safari)&&(o.webkit=!0),o.rv||o.iemobile){var a="msie";r.browser=a,o[a]=!0}if(o.edge){delete o.edge;var s="msedge";r.browser=s,o[s]=!0}if(o.safari&&o.blackberry){var i="blackberry";r.browser=i,o[i]=!0}if(o.safari&&o.playbook){var l="playbook";r.browser=l,o[l]=!0}if(o.bb){var c="blackberry";r.browser=c,o[c]=!0}if(o.opr){var d="opera";r.browser=d,o[d]=!0}if(o.safari&&o.android){var u="android";r.browser=u,o[u]=!0}if(o.safari&&o.kindle){var h="kindle";r.browser=h,o[h]=!0}if(o.safari&&o.silk){var p="silk";r.browser=p,o[p]=!0}o.name=r.browser,o.platform=r.platform;var f=/micromessenger/.test(e),g=/line/.test(e),m=/fban/.test(e)||/fbav/.test(e);return f?o.app="weChat":g?o.app="Line":m&&(o.app="FB"),o}(window.navigator.userAgent),!t)var t=(new Date).getTime();t&&e&&console.log("processing time(uaMatch):",t-e)}(),function(){"use strict";window.parseUserData=function(e,t){let n=new XMLHttpRequest;return n.open("GET",e,!0),n.responseType="json",n.onload=function(e){for(var t in n.response.data?window.file=n.response.data:window.file=n.response,window.file.scene_objs_v2)for(var o in window.file.scene_objs_v2[t].transform){var r=window.file.scene_objs_v2[t].transform[o].split(",");if(3!=r.length)return-1;var a=[parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])];window.file.scene_objs_v2[t].transform[o]=a}return window.file},n.send(),n.response},window.getUserPublishProjsByUserID=function(e,t,n,o,r){if(!e)return-1;t||(t="makarvr"),n||(n=""),o||(o="");let a=new XMLHttpRequest,s={user_id:t,web_ar:!0};"3.0.0"==serverVersion&&getResByUserID(e,t,n,o,(function(i){getUsrOnlineRes(e,t,n,o,"",(function(t){let n=e+"get_usr_publish_projs",o={ver:"3.0.0",cid:5,data:s},l=JSON.stringify(o);a.open("POST",n,!0),a.setRequestHeader("Content-Type","application/json"),a.responseType="json",a.onload=function(e){let n;a.response.error?(r&&r(a.response.error),console.log("%cnetworkAgent.js: _getUserPublishProjs: oops something wrong: ","color:red",a.response.error)):a.response.data?(n=a.response.data,window.userPublishProjs,window.userPublishProjs=n,r&&r(n,i,t)):r&&r("networkAgent.js:error: no xhr.response.data")},a.send(l)}))}))},window.getNewestPublishProjs=function(e,t,n){if(!e)return-1;t||(t="ar");let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let n=e+"get_newest_publish_projs",r={ver:"3.0.0",cid:5,data:{proj_type:t}},a=JSON.stringify(r);o.open("POST",n,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent.js: getNewestPublishProjs,  onload xhr.response = ",o.response)},console.log("networkAgent.js: getNewestPublishProjs, jsonReq=",a),o.send(a)}},window.getARSceneByUserID=function(e,t,n){if(!e)return-1;t||(t="makarvr");let o=[];if(o.user_id=t,"3.0.0"==serverVersion){var r=function(r,a,s){if("string"==typeof r)return void(n&&n(r));let i=0;if(r.proj_list.length>0){o.name=r.proj_list[0].name;let l=[];for(let e in r.proj_list)if("ar"==r.proj_list[e].proj_type){if(parent.useEditorWebTag&&!r.proj_list[e].proj_platform.find((e=>"web"==e)))continue;l.push(r.proj_list[e].proj_id)}let c=new XMLHttpRequest,d=e+"get_ar_projs_by_proj_id",u={ver:"3.0.0",cid:5,data:{proj_id_list:l}},h=JSON.stringify(u);c.open("POST",d,!0),c.setRequestHeader("Content-Type","application/json"),c.responseType="json",c.onload=function(r){console.log("networkAgent.js: get_ar_projs_by_proj_id: onload, response=",c.response);let l=c.response.data;0==window.allowedMakarIDUseWeb?n&&n("this ID["+t+"] is free user, not allow to use webAR"):function(){if(l.proj_list=l.result,l.user_id=t,window.publishARProjs=l,l&&Array.isArray(l.result)){let e=[];for(let t=0;t<l.result.length;t++){let n=l.result[t].editor_ver;if("string"==typeof n){let o=n.split(".");3==o.length&&3==o[0]&&o[1]<5&&e.length<20&&e.push(l.result[t])}}l.result=e,l.proj_list=e}if(l&&l.result&&l.result.length)if(l.result.length<20)for(let t=0;t<l.result.length;t++){let r=new XMLHttpRequest,c={user_id:l.result[t].user_id,proj_id:l.result[t].proj_id},d=e+"get_ar_proj_scene",u={ver:"3.0.0",cid:5,data:c},h=JSON.stringify(u);r.open("POST",d,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){i++,o[t]=r.response;for(let e=0;e<o[t].data.scene_objs_v2.length;e++)if(o[t].data.scene_objs_v2[e].res_id){let n=o[t].data.scene_objs_v2[e].res_id;a[n]&&(a[n].res_url==o[t].data.scene_objs_v2[e].res_url||(console.log("networkAgent.js: _getUserPublishProjs: ARResDict.res_url different as scene.url, replace it"),o[t].data.scene_objs_v2[e].res_url=a[n].res_url),"model"==a[n].main_type&&(a[n].res_url_fbx?o[t].data.scene_objs_v2[e].res_url_fbx=a[n].res_url_fbx:console.log("networkAgent.js: _getUserPublishProjs: ARResDict.res_url_fbx not exit ",a[n])))}else console.log("networkAgent.js: _getUserPublishProjs: prefab or error, res_id not exist ",o[t].data.scene_objs_v2[e]);i==l.result.length&&(console.log("networkAgent.js: _getARSceneByUserID: _getUserPublishProjs: count=",i,"sceneResult=",o),window.sceneResult=o,window.userProjResDict=a,window.userOnlineResDict=s,n&&n(o))},r.send(h)}else console.log("networkAgent.js: _getUserPublishProjs: count > 20 =",i,", too many targets,.. can't afford "),n&&n("There are too many AR projects ["+i+"], cannot affort, please reduce some project")}()},c.send(h)}else n&&n("this ID doesn't publish any projects")};searchUserIDByUserID(e,t,(function(o){for(let e in o.result)t.toLowerCase()===o.result[e].user_id.toLowerCase()&&(console.log("networkAgentVR.js: _searchUserIDByUserID: match, replace from [",t,"] to [",o.result[e].user_id,"]"),t=o.result[e].user_id);getPayInfoByUserID(e,t,(function(o){!function(e,t){var n,o=new XMLHttpRequest;o.open("GET","https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/webVR_UserID_WhiteList.txt",!0),o.onreadystatechange=function(){if(4===o.readyState&&(200===o.status||0==o.status)){let e=o.responseText;n=e,t&&t(n)}},o.send(null)}(0,(function(a){let s=JSON.parse(a).customizedUserID.list,i=[];for(let e=0;e<s.length;e++)i.push(s[e].name.toLowerCase());let l=i.indexOf(t.toLowerCase())>-1;console.log("networkAgent.js: _getPayInfoByUserID: nameList= ",i),o.data?(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: user_type=",o.data),window.allowedMakarIDUseWeb=o.data.web_ar||l,"proA"!=o.data.user_type&&"proB"!=o.data.user_type&&"proC"!=o.data.user_type&&"custom"!=o.data.user_type||(window.allowedMakarIDUseWeb=!0),getUserPublishProjsByUserID(e,t,"","",r)):(console.log("networkAgent.js:_getARSceneByUserID:_getPayInfoByUserID: error, userPayInfo=",o),n&&n("this ID <br> ["+t+"] <br> user data error, please contact MIFLY for more information. "))}))}))}))}},window.getGCSSByUserID=function(e,t){if(t||(t="fefe"),!e)return-1;let n=e+"get_img_targets",o={data:{user_id:t}};return new Promise((function(e){let t=new Headers({"user-agent":"Mozilla/4.0 MDN Example","content-type":"application/json"});fetch(n,{body:JSON.stringify(o),headers:t,method:"POST",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((e=>e.json())).then((function(t){console.log("_getGCSSByUserID_: ",t),e(t)})).catch((function(e){}))}))},window.getResByUserID=function(t,n,o,r,a){n||(n="fefe"),o||(o=""),r||(r="");let s=t+"get_res",i=new XMLHttpRequest,l={ver:"3.0.0",cid:5,data:{user_id:n,main_type:o,sub_type:r}},c=JSON.stringify(l);i.open("POST",s,!0),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(t){i.response.error?console.log("networkAgent: _getResByUserID,  onload error ",i.response):i.response.data.list.length>0?e(i.response.data.list,(function(e){a&&a(e)})):a&&(console.log("networkAgent: _getResByUserID,  onload  use res is empty "),a({}))},i.send(c)};var e=function(e,t){if(!e)return console.log("netWorkAgent.js: createProjResDictFromResList: error, userARResList not defined "),-1;let n={};for(let o=0;o<e.length;o++)n[e[o].res_id]=e[o],o==e.length-1&&t(n)};window.getUsrOnlineRes=function(e,n,o,r,a,s){n||(n="fefe"),o||(o=""),r||(r=""),a||(a="");let i=e+"get_usr_online_res",l=new XMLHttpRequest,c={ver:"3.0.0",cid:5,data:{user_id:n,main_type:o,sub_type:r,category:a}},d=JSON.stringify(c);l.open("POST",i,!0),l.setRequestHeader("Content-Type","application/json"),l.responseType="json",l.onload=function(e){console.log("networkAgentVR.js: _getUsrOnlineRes: res = ",l.response),l.response.error?console.log("networkAgent.js: _getUsrOnlineRes,  onload error ",l.response):(console.log("networkAgent.js: _getUsrOnlineRes,  onload save ",l.response),l.response.data.online_res_list.length>0?t(l.response.data.online_res_list,(function(e){s&&s(e)})):s&&(console.log("networkAgent: _getUsrOnlineRes,  onload  use res is empty "),s({})))},l.send(d)};var t=function(e,t){if(!e)return-1;let n={};for(let o=0;o<e.length;o++)n[e[o].res_id]=e[o],o==e.length-1&&(console.log("netWorkAgent.js: createProjResDictFromResList: i == userARResList.length, callback",o,e.length),t&&t(n))};function n(e,t,n){let o=new XMLHttpRequest,r={ver:"3.1.1",cid:5,data:t},a=JSON.stringify(r);o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.addEventListener("load",(function(){n&&n(o.response)})),o.send(a)}window.getOneUserInfo=function(e,t,n,o){let r=new XMLHttpRequest,a=e+"get_one_usr_info",s={ver:"3.0.0",cid:5,data:{user_id:t,wanted_info_keys:n}},i=JSON.stringify(s);r.open("POST",a,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent.js: _getOneUserInfo: xhr.r=",r.response),""==r.response.error?o&&o(r.response):o&&o(r.response.error)},r.send(i)},window.getARProjsByProjID=function(e,t){if(null==e)return;if(!Array.isArray(e))return;if(e.length<1)return;let n=new XMLHttpRequest,o={proj_id_list:e},r=window.serverUrl+"get_ar_projs_by_proj_id",a={ver:"3.0.0",cid:5,data:o},s=JSON.stringify(a);n.open("POST",r,!0),n.setRequestHeader("Content-Type","application/json"),n.responseType="json",n.onload=function(e){""==n.response.error?t&&t(n.response):t&&t(n.response.error)},n.send(s)},window.checkMaxScanTimes=function(e,t,n){if(!e)return-1;let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let t=e+"check_max_scan_times",n={ver:"3.0.0",cid:5,data:{user_id:"fefe",target_id:"1545795389.8544426.1988048228"}},r=JSON.stringify(n);o.open("POST",t,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent: checkMaxScanTimes, xhr.response.data = ",o.response.data)},o.send(r)}},window.getScanTimes=function(e,t,n){if(!e)return-1;if(!t)return-1;let o=new XMLHttpRequest;if("3.0.0"==serverVersion){let n=e+"get_scan_times",r={ver:"3.0.0",cid:5,data:{user_id:t,target_id:"1545795389.8544426.1988048228"}},a=JSON.stringify(r);o.open("POST",n,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent: getScanTimes, xhr.response.data = ",o.response.data)},o.send(a)}},window.addScanTimesByTargetID=function(e,t,n,o){if(!e)return-1;if(!t)return-1;if(!n)return-1;let r={user_id:t,target_id:n,device_id:"",location_lan:"",location_long:""};if(navigator.userAgent&&Browser){let e=navigator.userAgent,t=navigator.userAgent.indexOf("(",0),n=navigator.userAgent.indexOf(")",0);if(t>0&&n>0){let o=e.slice(t+1,n);o.toLowerCase(),r.os=o,r.brand=Browser.platform+" "+Browser.name+" "+Browser.version}}let a=new XMLHttpRequest;if("3.0.0"==serverVersion){let t=e+"add_scan_times",n={ver:"3.0.0",cid:5,data:r};JSON.stringify(n),a.open("POST",t,!0),a.setRequestHeader("Content-Type","application/json"),a.responseType="json",a.onload=function(e){}}if("2.0.0"==serverVersion){let t=JSON.stringify(r),n=new FormData;n.append("cmd","add_scan_times"),n.append("data",t),a.open("POST",e,!0),a.responseType="json",a.onload=function(e){console.log("networkAgent: uploadDataToServer, xhr = ",a.response.data)},a.send(n)}},window.getPayInfoByUserID=function(e,t,n){if(!e)return-1;if(!t)return-1;let o=e+"get_pay_info",r=new XMLHttpRequest,a={ver:"3.0.0",cid:5,data:{user_id:t}},s=JSON.stringify(a);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){n&&n(r.response)},r.send(s)},window.getELicenseInfo=function(e,t,n){if(!e)return-1;if(!t)return-1;let o=e+"get_e_lice_info",r=new XMLHttpRequest,a={ver:"3.1.1",cid:5,data:{license_key:t}},s=JSON.stringify(a);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){n&&n(r.response)},r.send(s)},window.checkLicenseInProjs=function(e,t){let o=[],r=[],a=[],s=[];for(let e=0,t=userPublishProjs.proj_list.length;e<t;e++)switch(userPublishProjs.proj_list[e].proj_type){case"ar":o.push(userPublishProjs.proj_list[e].proj_id),s.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"vr":r.push(userPublishProjs.proj_list[e].proj_id),s.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;case"ar_slam":a.push(userPublishProjs.proj_list[e].proj_id),s.push({proj_id:userPublishProjs.proj_list[e].proj_id});break;default:console.error("networkAgentVR.js: _checkLicenseInProjs: project type ERROR",userPublishProjs.proj_list[e].proj_type)}let i=[];function l(n){for(let o=0,r=s.length;o<r;o++)for(let r=0,a=n.data.result.length;r<a;r++)s[o].proj_id==n.data.result[r].proj_id&&(""!=n.data.result[r].editor_license_key?getELicenseInfo(e,n.data.result[r].editor_license_key,(function(e){""!=e.error?i.push({proj_id:s[o].proj_id,isLicense:!1}):i.push({proj_id:s[o].proj_id,isLicense:!0}),i.length==s.length&&t&&t(i)})):i.push({proj_id:s[o].proj_id,isLicense:!1}));i.length==s.length&&t&&t(i)}o.length>0&&n(e+"get_ar_projs_by_proj_id",{proj_id_list:o},l),r.length>0&&n(e+"get_vr_projs_by_proj_id",{proj_id_list:r},l),a.length>0&&n(e+"get_arslam_projs_by_proj_id",{proj_id_list:a},l)},window.getRecordModule=function(e,t,o,r){if(!e)return-1;n(e+"get_record_module",{playing_user_id:t,proj_id:o},(function(e){console.log("networkAgentVR.js: _getRecordModule: ret",e),r&&r(e)}))},window.quizLog=function(e,t,o){n(e+"quiz_log",t,(function(e){console.log("networkAgentVR.js: _quizLog: ret",e),o&&o(e)}))},window.updateRecordModule=function(e,t,o){n(e+"update_record_module",t,(function(e){console.log("networkAgentVR.js: _updateRecordModule: ret",e),o&&o(e)}))},window.getViewerConfig=function(e,t){if(!e)return-1;let n=e+"get_viewer_config",o=new XMLHttpRequest,r=JSON.stringify({ver:"3.1.1",cid:5,data:{}});o.open("POST",n,!0),o.setRequestHeader("Content-Type","application/json"),o.responseType="json",o.onload=function(e){console.log("networkAgent.js: _getViewerConfig: xhr.response",o.response),t&&t(o.response)},o.send(r)},window.pointCardLog=function(e,t,n){if(!e)return-1;if(!webARVersion)return-1;let o=e+"point_card_log",r=new XMLHttpRequest,a={ver:webARVersion,cid:5,data:t},s=JSON.stringify(a);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent.js: _pointCardLog: xhr.response = ",r.response),n&&n(r.response)},r.send(s)},window.scratchCardLog=function(e,t,n){if(!e)return-1;if(!webARVersion)return-1;let o=e+"scratch_card_log",r=new XMLHttpRequest,a={ver:webARVersion,cid:5,data:t},s=JSON.stringify(a);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent.js: _scratchCardLog: xhr.response = ",r.response),n&&n(r.response)},r.send(s)},window.testMakarApi=function(){let e="https://ssl-api-makar-v3-apps.miflyservice.com/Makar/get_viewer_config";e="https://ssl-api-makar-apps.miflyservice.com/Makar/get_viewer_config";let t=new XMLHttpRequest,n=JSON.stringify({ver:"3.1.1",cid:5,data:{}});t.open("POST","https://ssl-api-makar-apps.miflyservice.com/Makar/get_viewer_config",!0),t.setRequestHeader("Content-Type","application/json"),t.responseType="json",t.onload=function(e){console.log("networkAgent.js: testMakarApi: xhr.response",t.response)},t.send(n)},window.searchUserIDByUserID=function(e,t,n){if(!e)return-1;if(!t)return-1;let o=e+"get_many_usr_info_keyword",r=new XMLHttpRequest,a={ver:"3.0.0",cid:5,data:{keyword:t,search_keys:["user_id"]}},s=JSON.stringify(a);r.open("POST",o,!0),r.setRequestHeader("Content-Type","application/json"),r.responseType="json",r.onload=function(e){console.log("networkAgent.js: _searchUserIDByUserID: xhr.response",r.response.data),n&&n(r.response.data)},r.send(s)},window.testPOST=function(e,t){let n=new XMLHttpRequest,o=JSON.stringify({ver:"3.0.0",cid:5,data:{user_id:"fefe"},length:8});console.log(" jsonReq ",o);let r=new FormData;r.append("cmd","add_scan_times"),r.append("data",o),n.open("POST","http://60.250.125.146:8081/Makar/get_usr_publish_projs",!0),n.setRequestHeader("Content-Type","application/json"),n.responseType="json",n.onload=function(e){console.log("networkAgent: testPOST,  onload xhr = ",n,n.response)},n.send(o)}}(),function(){ARProxy=function(e,t,n){var o;this.listeners={},this.allEventListeners=[],this.id=null,this.arController=e,this.worker=((o=new Worker("../lib/makarWebAR.worker.min.js")).callID=0,o.callbacks={},o.listeners={},o.allEventListeners=[],o.call=function(e,t,arguments,n,o){var r=this.callID++;"function"==typeof n&&(o=n,n=void 0),this.callbacks[r]=o,this.postMessage({method:t,id:e,callID:r,arguments},n)},o.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},o.removeEventListener=function(e,t){if(this.listeners[e]){var n=this.listeners[e].indexOf(t);n>-1&&this.listeners[e].splice(n,1)}},o.dispatchEvent=function(e){var t=this;this.allEventListeners.forEach((function(n){n.call(t,e)}));var n=this.listeners[e.name];if(n)for(var o=0;o<n.length;o++)n[o].call(this,e)},o.listenForAllEvents=function(e){this.allEventListeners.push(e)},o.onmessage=function(e){if(e.data.event)this.dispatchEvent(e.data.event);else{var t=this.callbacks[e.data.callID];t&&t(e.data),delete this.callbacks[e.data.callID]}},o),this.processingDone=!1,this.canvas=document.createElement("canvas"),this.canvas.width=e.videoWidth,this.canvas.height=e.videoHeight,this.ctx=this.canvas.getContext("2d"),this.addEventListener=this.worker.addEventListener,this.removeEventListener=this.worker.removeEventListener,this.dispatchEvent=this.worker.dispatchEvent,this.listenForAllEvents=this.worker.listenForAllEvents;var r=this;this.worker.call(null,"new",[e.videoWidth,e.videoHeight,t],[],(function(e){r.id=e.id,n&&n(r)})),this.worker.listenForAllEvents((function(e){e.target===r.id&&r.dispatchEvent(e)})),this.addEventListener("getNFTMarkerDraw",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("getFrameTarget",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("loadNFTDone",(function(e){this.arController.dispatchEvent(e)})),this.addEventListener("getMarker",(function(e){e.data.type===artoolkit.BARCODE_MARKER?this.arController.threeBarcodeMarkers[e.data.index]&&(this.arController.threeBarcodeMarkers[e.data.index].keepVisible=!0):this.arController.threePatternMarkers[e.data.index]&&(this.arController.threePatternMarkers[e.data.index].keepVisible=!0),this.arController.dispatchEvent(e)})),this.addEventListener("markerNum",(function(e){}))},ARProxy.callbackMethods={loadNFTMarker:1,loadMarker:1,loadMultiMarker:1},ARProxy.isCallbackMethod=function(e){return!!ARProxy.callbackMethods[e]},ARProxy.getTransferables=function(e,arguments){return"process"===e||"detectMarkers"===e?[arguments[0].data.buffer]:[]},ARProxy.methods=["dispose","process","trackPatternMarkerId","trackBarcodeMarkerId","trackNFTMarkerId","getMultiMarkerCount","getMultiMarkerPatternCount","addEventListener","removeEventListener","dispatchEvent","debugSetup","loadMarker","loadNFTMarker","loadMultiMarker","getTransMatSquare","getTransMatSquareCont","getTransMatMultiSquare","getTransMatMultiSquareRobust","transMatToGLMat","detectMarker","getMarkerNum","getMarker","getNFTMarker","setMarkerInfoVertex","cloneMarkerInfo","getMultiEachMarker","getTransformationMatrix","getCameraMatrix","getMarkerTransformationMatrix","setDebugMode","getDebugMode","getProcessingImage","setLogLevel","getLogLevel","setMarkerInfoDir","setProjectionNearPlane","getProjectionNearPlane","setProjectionFarPlane","getProjectionFarPlane","setThresholdMode","getThresholdMode","setThreshold","getThreshold","setPatternDetectionMode","getPatternDetectionMode","setMatrixCodeType","getMatrixCodeType","setLabelingMode","getLabelingMode","setPattRatio","getPattRatio","setImageProcMode","getImageProcMode","debugDraw","_initialize","_initNFT","_copyImageToHeap","_debugMarker","createThreeScene","createThreeMarker","createThreeNFTMarker","createThreeMultiMarker","createThreeBarcodeMarker","setupThree"],ARProxy.callbackIndices={dispose:0,process:1,trackPatternMarkerId:2,trackBarcodeMarkerId:2,trackNFTMarkerId:2,getMultiMarkerCount:0,getMultiMarkerPatternCount:1,addEventListener:2,removeEventListener:2,dispatchEvent:1,debugSetup:0,loadMarker:1,loadNFTMarker:3,loadMultiMarker:1,getTransMatSquare:3,getTransMatSquareCont:4,getTransMatMultiSquare:2,getTransMatMultiSquareRobust:2,transMatToGLMat:3,detectMarker:1,getMarkerNum:0,getMarker:1,getNFTMarker:1,setMarkerInfoVertex:2,cloneMarkerInfo:1,getMultiEachMarker:2,getTransformationMatrix:0,getCameraMatrix:0,getMarkerTransformationMatrix:0,setDebugMode:1,getDebugMode:0,getProcessingImage:0,setLogLevel:1,getLogLevel:0,setMarkerInfoDir:2,setProjectionNearPlane:1,getProjectionNearPlane:0,setProjectionFarPlane:1,getProjectionFarPlane:0,setThresholdMode:1,getThresholdMode:0,setThreshold:1,getThreshold:0,setPatternDetectionMode:1,getPatternDetectionMode:0,setMatrixCodeType:1,getMatrixCodeType:0,setLabelingMode:1,getLabelingMode:0,setPattRatio:1,getPattRatio:0,setImageProcMode:1,getImageProcMode:0,debugDraw:0,_initialize:0,_initNFT:0,_copyImageToHeap:1,_debugMarker:1,createThreeScene:1,createThreeMarker:2,createThreeNFTMarker:2,createThreeMultiMarker:1,createThreeBarcodeMarker:2,setupThree:0};for(var e=0;e<ARProxy.methods.length;e++){var t=ARProxy.methods[e];ARProxy.prototype[t]=function(e){var t=ARProxy.callbackIndices[e];return function(){var n=arguments[t],o=ARProxy.getTransferables(e,arguments);this.worker.call(this.id,e,[].slice.call(arguments,0,t),o,n.bind(this))}}(t)}ARProxy.prototype.getFrameTarget=function(){this.worker.call(this.id,"getFrameTarget",[],[],(function(e){}))},ARProxy.prototype.process=function(e){if(this.processingDone){this.processingDone=!1,this.ctx.drawImage(e,0,0,this.canvas.width,this.canvas.height);var t=this,n=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this.worker.call(this.id,"process",[n],[n.data.buffer],(function(e){t.processingDone=!0}))}}}(),(()=>{var e,t=function(){var e={};"function"==typeof Symbol&&Symbol.iterator,THREE.gifAnimator=class{constructor(){this.data={src:null,autoplay:!0,transparent:!0,opacity:1,side:THREE.DoubleSide}}init(e){let t=this;if(console.log("gif-animator.js: init: ",e,this),Object.keys(e).forEach((function(n){t.data[n]=e[n]})),this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d"),this.__texture=new THREE.Texture(this.__cnv),this.__material={},this.__reset(),e.chroma){let t;if(console.log(" gif-animator.js: ***************************************** chroma= ",e.chroma),"RGB"==e.chroma.mode)t=new THREE.ChromaKeyMaterial({map:this.__texture,keyColor:e.chroma.chromakey.split(","),side:THREE.FrontSide,slope:e.chroma.slope,threshold:e.chroma.threshold});else if("HSV"==e.chroma.mode){let n=e.chroma.HSV.split(","),o=parseFloat(n[0]),r=parseFloat(n[1]),a=parseFloat(n[2]);t=new THREE.HSVMattingMaterial({map:this.__texture,side:THREE.FrontSide,_keyingColorH:o,_keyingColorS:r,_keyingColorV:a,_deltaH:e.chroma.hue,_deltaS:e.chroma.saturation,_deltaV:e.chroma.brightness})}this.material=t}else this.material=new THREE.MeshBasicMaterial({map:this.__texture});return this.__addPublicFunctions(),this.update(this.data),this.material}update(e){return this.__updateMaterial(e),this.__updateTexture(e),this.material}tick(e){setTimeout(function(){!this.__frames||this.paused()||(this.__curTime=Date.now(),this.__curTime-this.__preTime>=this.__nextFrameTime&&(this.nextFrame(),this.__preTime=this.__curTime)),this.tick()}.bind(this),20)}__updateMaterial(e){var t=this.material,n=this.__getMaterialData(e);Object.keys(n).forEach((function(e){t[e]=n[e]}))}__getMaterialData(e){return{opacity:e.opacity,transparent:e.transparent,side:e.side,autoplay:e.autoplay}}__setTexure(e){"error"===e.status?(console.warn("Error: "+e.message+"\nsrc: "+e.src),this.__reset()):"success"===e.status&&e.src!==this.__textureSrc&&(this.__reset(),this.__ready(e))}__updateTexture(e){var t=e.src,n=e.autoplay;"boolean"==typeof n?this.__autoplay=n:void 0===n&&(this.__autoplay=!0),this.__autoplay&&this.__frames&&this.play(),t?this.__validateSrc(t,this.__setTexure.bind(this)):this.__reset()}__validateSrc(e,t){var n=function(e){return 0==e.indexOf("http")&&e.indexOf("gif")==e.length-3?e:void 0}(e);n&&this.__getImageSrc(n,t)}__getImageSrc(t,n){var o=this;if(t!==this.__textureSrc){var r=e[t];if(r&&r.callbacks){if(r.src)return void n(r);if(r.callbacks)return void r.callbacks.push(n)}else(r=e[t]={callbacks:[]}).callbacks.push(n);var a=new Image;a.crossOrigin="Anonymous",a.addEventListener("load",(function(n){o.__getUnit8Array(t,(function(n){n?(0,o.parseGIF)(n,(function(n,o,a){var s={status:"success",src:t,times:n,cnt:o,frames:a,timestamp:Date.now()};r.callbacks&&(r.callbacks.forEach((function(e){return e(s)})),e[t]=s)}),(function(e){return s(e)})):s("This is not gif. Please use `shader:flat` instead")}))})),a.addEventListener("error",(function(e){return s("Could be the following issue\n - Not Image\n - Not Found\n - Server Error\n - Cross-Origin Issue")})),a.src=t}function s(n){var o=function(e,t){return{status:"error",src:t,message:e,timestamp:Date.now()}}(n,t);r.callbacks&&(r.callbacks.forEach((function(e){return e(o)})),e[t]=o)}}__getUnit8Array(e,t){if("function"==typeof t){var n=new XMLHttpRequest;n.open("GET",e),n.responseType="arraybuffer",n.addEventListener("load",(function(e){for(var n=new Uint8Array(e.target.response),o=n.subarray(0,4),r="",a=0;a<o.length;a++)r+=o[a].toString(16);"47494638"===r?t(n):t()})),n.addEventListener("error",(function(e){console.error(e),t()})),n.send()}}__validateAndGetQuerySelector(e){try{return document.querySelector(e)||{error:"No element was found matching the selector"}}catch(e){return{error:"no valid selector"}}}__addPublicFunctions(){this.gif={play:this.play.bind(this),pause:this.pause.bind(this),togglePlayback:this.togglePlayback.bind(this),paused:this.paused.bind(this),nextFrame:this.nextFrame.bind(this)}}pause(){this.__paused=!0}play(){this.__paused=!1}togglePlayback(){this.paused()?this.play():this.pause()}paused(){return this.__paused}nextFrame(){this.__draw(),this.__nextFrameTime=this.__delayTimes[this.__frameIdx++],(this.__infinity||this.__loopCnt)&&this.__frameCnt<=this.__frameIdx&&(this.__frameIdx=0)}__clearCanvas(){this.__ctx.clearRect(0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__draw(){if(0!=this.__frameIdx){var e=this.__frames[this.__frameIdx-1];8!=e.disposalMethod&&9!=e.disposalMethod||this.__clearCanvas()}else this.__clearCanvas();var t=this.__frames[this.__frameIdx];this.__ctx.drawImage(t,0,0,this.__width,this.__height),this.__texture.needsUpdate=!0}__ready(e){var t=e.src,n=e.times,o=e.cnt,r=e.frames;console.log("gif-animator.js: __ready: times=",n,", cnt=",o),this.__textureSrc=t,this.__delayTimes=n,o?this.__loopCnt=o:this.__infinity=!0,this.__frames=r,this.__frameCnt=n.length,this.__startTime=Date.now(),this.__curTime=Date.now(),this.__preTime=Date.now(),this.__width=THREE.Math.floorPowerOfTwo(r[0].width),this.__height=THREE.Math.floorPowerOfTwo(r[0].height),this.__cnv.width=this.__width,this.__cnv.height=this.__height,this.__draw(),this.__autoplay?this.play():this.pause(),this.tick()}__reset(){this.pause(),this.__clearCanvas(),this.__startTime=0,this.__curTime=0,this.__preTime=0,this.__nextFrameTime=0,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__infinity=!1,this.__loopCnt=0,this.__frames=null,this.__textureSrc=null}parseGIF(e,t,n){var o=0,r=[],a=0,s=null,i=null,l=[],c=0;if(71!==e[0]||73!==e[1]||70!==e[2]||56!==e[3]||57!==e[4]&&55!==e[4]||97!==e[5])n&&n("parseGIF: no GIF89a");else{o+=13+ +!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3;for(var d=e.subarray(0,o);e[o]&&59!==e[o];){var u=o,h=e[o];if(33===h){var p=e[++o];if(-1===[1,254,249,255].indexOf(p)){n&&n("parseGIF: unknown label");break}for(249===p&&r.push(10*(e[o+3]+(e[o+4]<<8))),255===p&&(c=e[o+15]+(e[o+16]<<8));e[++o];)o+=e[o];249===p&&(s=e.subarray(u,o+1))}else{if(44!==h){n&&n("parseGIF: unknown blockId");break}for(o+=9,o+=1+ +!!(128&e[o])*(3*Math.pow(2,1+(7&e[o])));e[++o];)o+=e[o];i=e.subarray(u,o+1);var f={disposalMethod:s[3],blob:URL.createObjectURL(new Blob([d,s,i]))};l.push(f)}o++}}if(l.length){var g=document.createElement("canvas"),m=function e(n){var o=new Image;o.onload=function(n,o){a++,l[o]=this,a===l.length?(g=null,t&&t(r,c,l)):e(++o)}.bind(o),o.src=g.toDataURL("image/gif")};l.forEach((function(e,t){var n=new Image;n.onload=function(e,t){0===t&&(g.width=n.width,g.height=n.height),a++,l[t]=this,a===l.length&&(a=0,m())}.bind(n,null,t),n.src=e.blob,n.disposalMethod=e.disposalMethod}))}}},THREE.gifAnimator.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.gifAnimator.prototype.constructor=THREE.gifAnimator};"undefined"!=typeof window?e=window:console.error("gif-animator.js: window error",window);var n=function(){e.THREE?t():setTimeout(n,50)};n()})(),function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){THREE.OrbitControls=function(e,t){this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return c.phi},this.getAzimuthalAngle=function(){return c.theta},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(o),n.update(),i=s.NONE},this.update=function(){var t=new THREE.Vector3,r=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0));let a;a=r.inverse?r.clone().inverse():r.clone().invert();var f=new THREE.Vector3,g=new THREE.Quaternion;return function(){var e=n.object.position;return t.copy(e).sub(n.target),t.applyQuaternion(r),c.setFromVector3(t),n.autoRotate&&i===s.NONE&&R(2*Math.PI/60/60*n.autoRotateSpeed),c.theta+=d.theta,c.phi+=d.phi,c.theta=Math.max(n.minAzimuthAngle,Math.min(n.maxAzimuthAngle,c.theta)),c.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,c.phi)),c.makeSafe(),c.radius*=u,c.radius=Math.max(n.minDistance,Math.min(n.maxDistance,c.radius)),n.target.add(h),t.setFromSpherical(c),t.applyQuaternion(a),e.copy(n.target).add(t),n.object.lookAt(n.target),!0===n.enableDamping?(d.theta*=1-n.dampingFactor,d.phi*=1-n.dampingFactor):d.set(0,0,0),u=1,h.set(0,0,0),!!(p||f.distanceToSquared(n.object.position)>l||8*(1-g.dot(n.object.quaternion))>l)&&(n.dispatchEvent(o),f.copy(n.object.position),g.copy(n.object.quaternion),p=!1,!0)}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",N,!1),n.domElement.removeEventListener("mousedown",O,!1),n.domElement.removeEventListener("wheel",D,!1),n.domElement.removeEventListener("touchstart",I,!1),n.domElement.removeEventListener("touchend",V,!1),n.domElement.removeEventListener("touchmove",U,!1),document.removeEventListener("mousemove",A,!1),document.removeEventListener("mouseup",S,!1),window.removeEventListener("keydown",L,!1)};var n=this,o={type:"change"},r={type:"start"},a={type:"end"},s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},i=s.NONE,l=1e-6,c=new THREE.Spherical,d=new THREE.Spherical,u=1,h=new THREE.Vector3,p=!1,f=new THREE.Vector2,g=new THREE.Vector2,m=new THREE.Vector2,_=new THREE.Vector2,b=new THREE.Vector2,v=new THREE.Vector2,y=new THREE.Vector2,E=new THREE.Vector2,w=new THREE.Vector2;function T(){return Math.pow(.95,n.zoomSpeed)}function R(e){d.theta-=e}function x(e){d.phi-=e}var j,M=(j=new THREE.Vector3,function(e,t){j.setFromMatrixColumn(t,0),j.multiplyScalar(-e),h.add(j)}),k=function(){var e=new THREE.Vector3;return function(t,n){e.setFromMatrixColumn(n,1),e.multiplyScalar(t),h.add(e)}}(),C=function(){var e=new THREE.Vector3;return function(t,o){var r=n.domElement===document?n.domElement.body:n.domElement;if(n.object.isPerspectiveCamera){var a=n.object.position;e.copy(a).sub(n.target);var s=e.length();s*=Math.tan(n.object.fov/2*Math.PI/180),M(2*t*s/r.clientHeight,n.object.matrix),k(2*o*s/r.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(M(t*(n.object.right-n.object.left)/n.object.zoom/r.clientWidth,n.object.matrix),k(o*(n.object.top-n.object.bottom)/n.object.zoom/r.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function P(e){n.object.isPerspectiveCamera?u/=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom*e)),n.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function H(e){n.object.isPerspectiveCamera?u*=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/e)),n.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function O(e){if(!1!==n.enabled){switch(e.preventDefault(),e.button){case n.mouseButtons.ORBIT:if(!1===n.enableRotate)return;!function(e){f.set(e.clientX,e.clientY)}(e),i=s.ROTATE;break;case n.mouseButtons.ZOOM:if(!1===n.enableZoom)return;!function(e){y.set(e.clientX,e.clientY)}(e),i=s.DOLLY;break;case n.mouseButtons.PAN:if(!1===n.enablePan)return;!function(e){_.set(e.clientX,e.clientY)}(e),i=s.PAN}i!==s.NONE&&(document.addEventListener("mousemove",A,!1),document.addEventListener("mouseup",S,!1),n.dispatchEvent(r))}}function A(e){if(!1!==n.enabled)switch(e.preventDefault(),i){case s.ROTATE:if(!1===n.enableRotate)return;!function(e){g.set(e.clientX,e.clientY),m.subVectors(g,f);var t=n.domElement===document?n.domElement.body:n.domElement;R(2*Math.PI*m.x/t.clientWidth*n.rotateSpeed),x(2*Math.PI*m.y/t.clientHeight*n.rotateSpeed),f.copy(g),n.update()}(e);break;case s.DOLLY:if(!1===n.enableZoom)return;!function(e){E.set(e.clientX,e.clientY),w.subVectors(E,y),w.y>0?P(T()):w.y<0&&H(T()),y.copy(E),n.update()}(e);break;case s.PAN:if(!1===n.enablePan)return;!function(e){b.set(e.clientX,e.clientY),v.subVectors(b,_),C(v.x,v.y),_.copy(b),n.update()}(e)}}function S(e){!1!==n.enabled&&(document.removeEventListener("mousemove",A,!1),document.removeEventListener("mouseup",S,!1),n.dispatchEvent(a),i=s.NONE)}function D(e){!1===n.enabled||!1===n.enableZoom||i!==s.NONE&&i!==s.ROTATE||(e.preventDefault(),n.dispatchEvent(r),function(e){e.deltaY<0?H(T()):e.deltaY>0&&P(T()),n.update()}(e),n.dispatchEvent(a))}function L(e){!1!==n.enabled&&!1!==n.enableKeys&&!1!==n.enablePan&&function(e){switch(e.keyCode){case n.keys.UP:C(0,n.keyPanSpeed),n.update();break;case n.keys.BOTTOM:C(0,-n.keyPanSpeed),n.update();break;case n.keys.LEFT:C(n.keyPanSpeed,0),n.update();break;case n.keys.RIGHT:C(-n.keyPanSpeed,0),n.update()}}(e)}function I(e){if(!1!==n.enabled){switch(e.touches.length){case 1:if(!1===n.enableRotate)return;!function(e){f.set(e.touches[0].pageX,e.touches[0].pageY)}(e),i=s.TOUCH_ROTATE;break;case 2:if(!1===n.enableZoom||!1===n.enablePan)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);y.set(0,o)}(e),function(e){_.set(e.touches[0].pageX,e.touches[0].pageY)}(e),i=s.TOUCH_DOLLY;break;case 3:if(!1===n.enablePan)return;i=s.TOUCH_PAN;break;default:i=s.NONE}i!==s.NONE&&n.dispatchEvent(r)}}function U(e){if(!1!==n.enabled)switch(e.preventDefault(),e.touches.length){case 1:if(!1===n.enableRotate)return;if(i!==s.TOUCH_ROTATE)return;!function(e){g.set(e.touches[0].pageX,e.touches[0].pageY),m.subVectors(g,f);var t=n.domElement===document?n.domElement.body:n.domElement;R(2*Math.PI*m.x/t.clientWidth*n.rotateSpeed),x(2*Math.PI*m.y/t.clientHeight*n.rotateSpeed),f.copy(g),n.update()}(e);break;case 2:if(!1===n.enableZoom||!1===n.enablePan)return;if(i!==s.TOUCH_DOLLY)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+o*o);E.set(0,r),w.subVectors(E,y),w.y>0?H(T()):w.y<0&&P(T()),y.copy(E),n.update()}(e),function(e){b.set(e.touches[0].pageX,e.touches[0].pageY),v.subVectors(b,_),C(v.x,v.y),_.copy(b),n.update()}(e);break;case 3:if(!1===n.enablePan)return;if(i!==s.TOUCH_PAN)return;break;default:i=s.NONE}}function V(e){!1!==n.enabled&&(n.dispatchEvent(a),i=s.NONE)}function N(e){!1!==n.enabled&&e.preventDefault()}n.domElement.addEventListener("contextmenu",N,!1),n.domElement.addEventListener("mousedown",O,!1),n.domElement.addEventListener("wheel",D,!1),n.domElement.addEventListener("touchstart",I,!1),n.domElement.addEventListener("touchend",V,!1),n.domElement.addEventListener("touchmove",U,!1),window.addEventListener("keydown",L,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}})},function(e,t,n){n(0);var o=AFRAME.utils.bind;AFRAME.registerComponent("orbit-controls",{dependencies:["camera"],schema:{autoRotate:{type:"boolean"},autoRotateSpeed:{default:2},dampingFactor:{default:.1},enabled:{default:!0},enableDamping:{default:!0},enableKeys:{default:!0},enablePan:{default:!0},enableRotate:{default:!0},enableZoom:{default:!0},initialPosition:{type:"vec3"},keyPanSpeed:{default:7},minAzimuthAngle:{type:"number",default:-1/0},maxAzimuthAngle:{type:"number",default:1/0},maxDistance:{default:1e3},maxPolarAngle:{default:AFRAME.utils.device.isMobile()?90:120},minDistance:{default:1},minPolarAngle:{default:0},minZoom:{default:0},panSpeed:{default:1},rotateSpeed:{default:.05},screenSpacePanning:{default:!1},target:{type:"vec3"},zoomSpeed:{default:.5}},init:function(){var e,t=this.el;e=new THREE.Vector3,this.oldPosition=e,this.bindMethods(),t.sceneEl.addEventListener("enter-vr",this.onEnterVR),t.sceneEl.addEventListener("exit-vr",this.onExitVR),document.body.style.cursor="grab",document.addEventListener("mousedown",(()=>{document.body.style.cursor="grabbing"})),document.addEventListener("mouseup",(()=>{document.body.style.cursor="grab"})),this.target=new THREE.Vector3,t.getObject3D("camera").position.copy(this.data.initialPosition)},pause:function(){this.controls.dispose()},play:function(){const e=this.el;this.controls=new THREE.OrbitControls(e.getObject3D("camera"),e.sceneEl.renderer.domElement),this.update()},onEnterVR:function(){var e=this.el;(AFRAME.utils.device.checkHeadsetConnected()||AFRAME.utils.device.isMobile())&&(this.controls.enabled=!1,e.hasAttribute("look-controls")&&(e.setAttribute("look-controls","enabled",!0),this.oldPosition.copy(e.getObject3D("camera").position),e.getObject3D("camera").position.set(0,0,0)))},onExitVR:function(){var e=this.el;(AFRAME.utils.device.checkHeadsetConnected()||AFRAME.utils.device.isMobile())&&(this.controls.enabled=!0,this.oldPosition&&e.getObject3D("camera").position.copy(this.oldPosition),e.hasAttribute("look-controls")&&e.setAttribute("look-controls","enabled",!1))},bindMethods:function(){this.onEnterVR=o(this.onEnterVR,this),this.onExitVR=o(this.onExitVR,this)},update:function(e){var t=this.controls,n=this.data;t&&(t.target=this.target.copy(n.target),t.autoRotate=n.autoRotate,t.autoRotateSpeed=n.autoRotateSpeed,t.dampingFactor=n.dampingFactor,t.enabled=n.enabled,t.enableDamping=n.enableDamping,t.enableKeys=n.enableKeys,t.enablePan=n.enablePan,t.enableRotate=n.enableRotate,t.enableZoom=n.enableZoom,t.keyPanSpeed=n.keyPanSpeed,THREE.Math?(t.maxPolarAngle=THREE.Math.degToRad(n.maxPolarAngle),t.maxAzimuthAngle=THREE.Math.degToRad(n.maxAzimuthAngle)):(t.maxPolarAngle=THREE.MathUtils.degToRad(n.maxPolarAngle),t.maxAzimuthAngle=THREE.MathUtils.degToRad(n.maxAzimuthAngle)),t.maxDistance=n.maxDistance,t.minDistance=n.minDistance,THREE.Math?(t.minPolarAngle=THREE.Math.degToRad(n.minPolarAngle),t.minAzimuthAngle=THREE.Math.degToRad(n.minAzimuthAngle)):(t.minPolarAngle=THREE.MathUtils.degToRad(n.minPolarAngle),t.minAzimuthAngle=THREE.MathUtils.degToRad(n.minAzimuthAngle)),t.minZoom=n.minZoom,t.panSpeed=n.panSpeed,t.rotateSpeed=n.rotateSpeed,t.screenSpacePanning=n.screenSpacePanning,t.zoomSpeed=n.zoomSpeed)},tick:function(){var e=this.controls;this.data.enabled&&e.enabled&&(e.enableDamping||e.autoRotate)&&this.controls.update()},remove:function(){this.controls.reset(),this.controls.dispose(),this.el.sceneEl.removeEventListener("enter-vr",this.onEnterVR),this.el.sceneEl.removeEventListener("exit-vr",this.onExitVR)}})}]),THREE.TGALoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.TGALoader.prototype={constructor:THREE.TGALoader,load:function(e,t,n,o){var r=this,a=new THREE.Texture,s=new THREE.FileLoader(this.manager);return s.setResponseType("arraybuffer"),s.setPath(this.path),s.load(e,(function(e){a.image=r.parse(e),a.needsUpdate=!0,void 0!==t&&t(a)}),n,o),a},checkHeader:function(e,t){var n=this,o=new THREE.FileLoader(this.manager);o.setResponseType("arraybuffer"),o.setPath(this.path),o.load(e,(function(e){e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var o=new Uint8Array(e),r=0,a={id_length:o[r++],colormap_type:o[r++],image_type:o[r++],colormap_index:o[r++]|o[r++]<<8,colormap_length:o[r++]|o[r++]<<8,colormap_size:o[r++],origin:[o[r++]|o[r++]<<8,o[r++]|o[r++]<<8],width:o[r++]|o[r++]<<8,height:o[r++]|o[r++]<<8,pixel_size:o[r++],flags:o[r++]};let s=n.tgaCheckHeader(a);t(s)}))},checkHeaderByBuffer:function(e){return offset=0,header={id_length:e[offset++],colormap_type:e[offset++],image_type:e[offset++],colormap_index:e[offset++]|e[offset++]<<8,colormap_length:e[offset++]|e[offset++]<<8,colormap_size:e[offset++],origin:[e[offset++]|e[offset++]<<8,e[offset++]|e[offset++]<<8],width:e[offset++]|e[offset++]<<8,height:e[offset++]|e[offset++]<<8,pixel_size:e[offset++],flags:e[offset++]},this.tgaCheckHeader(header)},tgaCheckHeader:function(e){let t=!0;switch(e.image_type){case 1:case 9:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&(t=!1);break;case 2:case 3:case 10:case 11:e.colormap_type&&(t=!1);break;case 0:console.error("THREE.TGALoader: No data."),t=!1;default:t=!1}return(e.width<=0||e.height<=0)&&(t=!1),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&(t=!1),t},parse:function(e){e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var t=new Uint8Array(e),n=0,o={id_length:t[n++],colormap_type:t[n++],image_type:t[n++],colormap_index:t[n++]|t[n++]<<8,colormap_length:t[n++]|t[n++]<<8,colormap_size:t[n++],origin:[t[n++]|t[n++]<<8,t[n++]|t[n++]<<8],width:t[n++]|t[n++]<<8,height:t[n++]|t[n++]<<8,pixel_size:t[n++],flags:t[n++]};!function(e){switch(e.image_type){case 1:case 9:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case 2:case 3:case 10:case 11:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case 0:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(o),o.id_length+n>e.length&&console.error("THREE.TGALoader: No data."),n+=o.id_length;var r=!1,a=!1,s=!1;switch(o.image_type){case 9:r=!0,a=!0;break;case 1:a=!0;break;case 10:r=!0;break;case 2:break;case 11:r=!0,s=!0;break;case 3:s=!0}var i=document.createElement("canvas");i.width=o.width,i.height=o.height;var l=i.getContext("2d"),c=l.createImageData(o.width,o.height),d=function(e,t,n,o,r){var a,s,i,l;if(i=n.width*n.height*(s=n.pixel_size>>3),t&&(l=r.subarray(o,o+=n.colormap_length*(n.colormap_size>>3))),e){var c,d,u;a=new Uint8Array(i);for(var h=0,p=new Uint8Array(s);h<i;)if(d=1+(127&(c=r[o++])),128&c){for(u=0;u<s;++u)p[u]=r[o++];for(u=0;u<d;++u)a.set(p,h+u*s);h+=s*d}else{for(d*=s,u=0;u<d;++u)a[h+u]=r[o++];h+=d}}else a=r.subarray(o,o+=t?n.width*n.height:i);return{pixel_data:a,palettes:l}}(r,a,o,n,t);return function(e,t,n,r,a){var i,l,c,d,u,h;switch((48&o.flags)>>4){default:case 2:i=0,c=1,u=t,l=0,d=1,h=n;break;case 0:i=0,c=1,u=t,l=n-1,d=-1,h=-1;break;case 3:i=t-1,c=-1,u=-1,l=0,d=1,h=n;break;case 1:i=t-1,c=-1,u=-1,l=n-1,d=-1,h=-1}if(s)switch(o.pixel_size){case 8:!function(e,t,n,r,a,s,i,l){var c,d,u,h=0,p=o.width;for(u=t;u!==r;u+=n)for(d=a;d!==i;d+=s,h++)c=l[h],e[4*(d+p*u)+0]=c,e[4*(d+p*u)+1]=c,e[4*(d+p*u)+2]=c,e[4*(d+p*u)+3]=255}(e,l,d,h,i,c,u,r);break;case 16:!function(e,t,n,r,a,s,i,l){var c,d,u=0,h=o.width;for(d=t;d!==r;d+=n)for(c=a;c!==i;c+=s,u+=2)e[4*(c+h*d)+0]=l[u+0],e[4*(c+h*d)+1]=l[u+0],e[4*(c+h*d)+2]=l[u+0],e[4*(c+h*d)+3]=l[u+1]}(e,l,d,h,i,c,u,r);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(o.pixel_size){case 8:!function(e,t,n,r,a,s,i,l,c){var d,u,h,p=c,f=0,g=o.width;for(h=t;h!==r;h+=n)for(u=a;u!==i;u+=s,f++)d=l[f],e[4*(u+g*h)+3]=255,e[4*(u+g*h)+2]=p[3*d+0],e[4*(u+g*h)+1]=p[3*d+1],e[4*(u+g*h)+0]=p[3*d+2]}(e,l,d,h,i,c,u,r,a);break;case 16:!function(e,t,n,r,a,s,i,l){var c,d,u,h=0,p=o.width;for(u=t;u!==r;u+=n)for(d=a;d!==i;d+=s,h+=2)c=l[h+0]+(l[h+1]<<8),e[4*(d+p*u)+0]=(31744&c)>>7,e[4*(d+p*u)+1]=(992&c)>>2,e[4*(d+p*u)+2]=(31&c)>>3,e[4*(d+p*u)+3]=32768&c?0:255}(e,l,d,h,i,c,u,r);break;case 24:!function(e,t,n,r,a,s,i,l){var c,d,u=0,h=o.width;for(d=t;d!==r;d+=n)for(c=a;c!==i;c+=s,u+=3)e[4*(c+h*d)+3]=255,e[4*(c+h*d)+2]=l[u+0],e[4*(c+h*d)+1]=l[u+1],e[4*(c+h*d)+0]=l[u+2]}(e,l,d,h,i,c,u,r);break;case 32:!function(e,t,n,r,a,s,i,l){var c,d,u=0,h=o.width;for(d=t;d!==r;d+=n)for(c=a;c!==i;c+=s,u+=4)e[4*(c+h*d)+2]=l[u+0],e[4*(c+h*d)+1]=l[u+1],e[4*(c+h*d)+0]=l[u+2],e[4*(c+h*d)+3]=l[u+3]}(e,l,d,h,i,c,u,r);break;default:console.error("THREE.TGALoader: Format not supported.")}}(c.data,o.width,o.height,d.pixel_data,d.palettes),l.putImageData(c,0,0),i},setPath:function(e){return this.path=e,this}},THREE.ChromaKeyMaterial=function(e){if(void 0!==e&&void 0!==e.map&&void 0!==e.keyColor){void 0===e.side&&(e.side=THREE.FrontSide),void 0===e.slope&&(e.slope=.3),void 0===e.threshold&&(e.threshold=1);var t,n="\n\tuniform sampler2D texture;\n\tuniform vec3 color;\n\tvarying vec2 vUv;\n\tfloat _threshold = 1.0 ;\n\tfloat _slope = 0.3 ;\n\tfloat opacity = 1.0;\n\tvoid main()\n\t{\n\t\tvec3 tColor = texture2D( texture, vUv ).rgb;\n\t\tfloat a = texture2D( texture, vUv ).a;\n\t\t// float a = (length(tColor - color) - 0.5) * 7.0;\n\n\t\t// if (tColor.g > 0.7 && tColor.r < 0.7 && tColor.b < 0.7  ){\n\t\t// \ttColor = vec3(0.0, 0.0, 0.0);\n\t\t// \ttColor.g = 0.0;\n\t\t// \ta = 0.0 ;\n\t\t// }\n\t\t// gl_FragColor = vec4(tColor, a);\n\n\t\t///////// thonsha method ///////\n\t\tfloat d1, d2, d3, d4, d;\n\t\td1 = abs(length(abs(color.rgb - tColor.rgb)));\n\n\t\tfloat c1 = abs(length( tColor.g - tColor.r) - length(color.g - color.r));\n\t\tfloat c2 = abs(length( tColor.r - tColor.b) - length(color.r - color.b));\n\t\tfloat c3 = abs(length( tColor.b - tColor.g) - length(color.b - color.g));\n\n\t\td4 = c1 + c2 + c3;\n\n\t\td = (d1*2.0 + d4) / 2.0 ;\n\n\t\tfloat edge0 = _threshold * (1.0 - _slope);\n\t\tfloat alpha = smoothstep(edge0, _threshold, d);\n\t\tgl_FragColor = vec4(tColor, alpha );\n\t\tif (alpha < opacity){\n    \t\tgl_FragColor = vec4(tColor, alpha*a);\n    \t} else{\n    \t\tgl_FragColor = vec4(tColor, opacity*a);\n    \t}\n\n\t}\n\t".replace("float _threshold = 1.0","float _threshold = "+e.threshold.toFixed(3));n=n.replace("float _slope = 0.3","float _slope = "+e.slope.toFixed(3)),THREE.ShaderMaterial.call(this),t=Array.isArray(e.keyColor)?new THREE.Color(e.keyColor[0],e.keyColor[1],e.keyColor[2]):new THREE.Color(e.keyColor),this.setValues({uniforms:{texture:{type:"t",value:e.map},color:{type:"c",value:t}},vertexShader:"varying vec2 vUv;\n\tvoid main()\n\t{\n\t\tvUv = uv;\n\t\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\tgl_Position = projectionMatrix * mvPosition;\n\t}",fragmentShader:n,map:e.map,transparent:!0,side:e.side,depthTest:!1,depthWrite:!1})}},THREE.ChromaKeyMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),THREE.ChromaKeyMaterial.prototype.constructor=THREE.ChromaKeyMaterial,THREE.HSVMattingMaterial=function(e){var t;void 0!==e&&void 0!==e.map&&(void 0===e.side&&(e.side=THREE.FrontSide),void 0===e._keyingColorH&&(e._keyingColorH=.33),void 0===e._keyingColorS&&(e._keyingColorS=1),void 0===e._keyingColorV&&(e._keyingColorV=.75),void 0===e._deltaH&&(e._deltaH=.2),void 0===e._deltaS&&(e._deltaS=.1),void 0===e._deltaV&&(e._deltaV=.1),console.log(" ***************************************** parameters = ",e),THREE.ShaderMaterial.call(this),t=Array.isArray(e.keyColor)?new THREE.Color(e.keyColor[0],e.keyColor[1],e.keyColor[2]):new THREE.Color(e.keyColor),this.setValues({uniforms:{src:{type:"t",value:e.map},color:{type:"c",value:t},_keyingColorH:{type:"number",value:e._keyingColorH},_keyingColorS:{type:"number",value:e._keyingColorS},_keyingColorV:{type:"number",value:e._keyingColorV},_deltaH:{type:"number",value:e._deltaH},_deltaS:{type:"number",value:e._deltaS},_deltaV:{type:"number",value:e._deltaV}},vertexShader:"\n\tvarying vec2 vUV;\n\tvoid main(void) {\n\t\tvUV = uv;\n    \tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t}\n\t",fragmentShader:"\n\tuniform sampler2D src;\n\tfloat opacity=1.0;\n\tvarying vec2 vUV;\n\tuniform float _keyingColorH;\n\tuniform float _keyingColorS;\n\tuniform float _keyingColorV;\n\tuniform float _deltaH;\n\tuniform float _deltaS;\n\tuniform float _deltaV;\n\n\tvec3 rgb2hsv(vec3 c){\n\t\tvec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n\t\tvec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n\t\tvec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\t\tfloat d = q.x - min(q.w, q.y);\n\t\tfloat e = 1.0e-10;\n\t\treturn vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n\t}\n\n\tvoid main(){\n\t\tvec3 tColor = texture2D( src, vUV ).rgb;\n\t\tfloat a = texture2D( src, vUV ).a;\n\t\tvec3 HSV = rgb2hsv(tColor);\n\t\tfloat h = abs(HSV.x - _keyingColorH);\n\t\tfloat s = abs(HSV.y - _keyingColorS);\n\t\tfloat v = abs(HSV.z - _keyingColorV);\n\t\tfloat alpha = opacity;\n\t\tif (h <= _deltaH * 0.5 && s <= _deltaS && v <= _deltaV){\n\t\t\talpha = smoothstep((_deltaH * 0.5) * 0.8, _deltaH* 0.6 ,h);\n\t\t}\n\n\t\tgl_FragColor = vec4(tColor, alpha*a);\n\t}\n\n\t",map:e.map,transparent:!0,side:e.side,depthTest:!1,depthWrite:!1}))},THREE.HSVMattingMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),THREE.HSVMattingMaterial.prototype.constructor=THREE.HSVMattingMaterial,THREE.ObjectControls=function(e,t){let n=this;n.enable=!0,n.controlObject=t,n.currentControllObject=new THREE.Object3D,e=void 0!==e?e:document,this.setObjectToMove=function(e){n.controlObject=e},this.setCurrentControllObject=function(e){n.currentControllObject=e},this.setDistance=function(e,t){},this.setZoomSpeed=function(e){},this.setRotationSpeed=function(e){a=e},this.setRotationSpeedTouchDevices=function(e){s=e},this.enableVerticalRotation=function(){i=!0},this.disableVerticalRotation=function(){i=!1},this.enableHorizontalRotation=function(){l=!0},this.disableHorizontalRotation=function(){l=!1},this.setMaxVerticalRotationAngle=function(e,t){r.x.from=e,r.x.to=t,r.x.enabled=!0},this.setMaxHorizontalRotationAngle=function(e,t){r.y.from=e,r.y.to=t,r.y.enabled=!0},this.disableMaxHorizontalAngleRotation=function(){r.y.enabled=!1},this.disableMaxVerticalAngleRotation=function(){r.x.enabled=!1},e.addEventListener("mousedown",(function(e){if(0!=n.enable)switch(v.dispatchEvent({type:"mouseDown"}),event.button){case v.mouseButtons.LEFT:d=!0,o=c.MOUSEDOWN;break;case v.mouseButtons.RIGHT:u=!0,y.set(event.clientX,event.clientY)}}),!1),e.addEventListener("mousemove",(function(e){if(0!=n.enable&&(null!=n.controlObject||null!=n.currentControllObject))if(d){if(null==n.controlObject)return;var t={x:e.offsetX-h.x,y:e.offsetY-h.y};if(h={x:e.offsetX,y:e.offsetY},l&&0!=t.x){if(!_(Math.sign(t.x)*a,"y"))return;n.controlObject.obj_parent_id?n.controlObject.rotateOnWorldAxis(new THREE.Vector3(0,1,0),1*Math.sign(t.x)*a):n.controlObject.rotateOnWorldAxis(new THREE.Vector3(0,0,1),1*Math.sign(t.x)*a),o=c.MOUSEMOVE}if(i&&0!=t.y){if(!_(Math.sign(t.y)*a,"x"))return;n.controlObject.rotateOnWorldAxis(new THREE.Vector3(1,0,0),1*Math.sign(t.y)*a),o=c.MOUSEMOVE}}else if(u){if(null==n.currentControllObject)return;E.set(event.clientX,event.clientY),w.subVectors(E,y).multiplyScalar(v.panSpeed),n.currentControllObject.position.x+=w.x,n.currentControllObject.obj_parent_id?n.currentControllObject.position.y-=w.y:n.currentControllObject.position.z-=w.y,y.copy(E)}}),!1),e.addEventListener("mouseup",(function(e){0!=n.enable&&(d=!1,u=!1,b())}),!1),e.addEventListener("wheel",(function(e){if(0!=n.enable){e.preventDefault();var t=e.wheelDelta?e.wheelDelta:-1*e.deltaY;null==n.controlObject&&null==n.currentControllObject||(t>0?g():t<0&&m())}}),!1),e.addEventListener("touchstart",(function(e){if(v.dispatchEvent({type:"onTouchStart"}),o=c.MOUSEDOWN,2===e.touches.length){f.X=Math.abs(e.touches[0].clientX-e.touches[1].clientX),f.Y=Math.abs(e.touches[0].clientY-e.touches[1].clientY),p=new Array(2);var t=.5*(event.touches[0].pageX+event.touches[1].pageX),n=.5*(event.touches[0].pageY+event.touches[1].pageY);y.set(t,n)}else h={x:e.touches[0].pageX,y:e.touches[0].pageY}}),!1),e.addEventListener("touchmove",(function(e){if(0!=n.enable&&(e.preventDefault(),o=c.MOUSEMOVE,null!=n.controlObject||null!=n.currentControllObject))if(2===e.touches.length){if(null==n.currentControllObject)return;p=new Array(2);var t=Math.abs(e.touches[0].clientX-e.touches[1].clientX),r=Math.abs(e.touches[0].clientY-e.touches[1].clientY),d=Math.sqrt(t*t+r*r);if(f&&f.X>0&&f.Y>0){var u=Math.sqrt(f.X*f.X+f.Y*f.Y);d>u+2?g():d<u-2&&m()}f.X=t,f.Y=r;var b=.5*(event.touches[0].pageX+event.touches[1].pageX),T=.5*(event.touches[0].pageY+event.touches[1].pageY);E.set(b,T),w.subVectors(E,y).multiplyScalar(v.panSpeed),n.currentControllObject.position.x+=w.x,n.currentControllObject.obj_parent_id?n.currentControllObject.position.y-=w.y:n.currentControllObject.position.z-=w.y,y.copy(E)}else if(1===e.touches.length){if(null==n.controlObject)return;f.X=null,f.Y=null;var R={x:e.touches[0].pageX-h.x,y:e.touches[0].pageY-h.y};if(h={x:e.touches[0].pageX,y:e.touches[0].pageY},l&&Math.abs(R.x)>.5){if(!_(Math.sign(R.x)*s,"y"))return;n.controlObject.obj_parent_id?n.controlObject.rotateOnWorldAxis(new THREE.Vector3(0,1,0),1*Math.sign(R.x)*a):n.controlObject.rotateOnWorldAxis(new THREE.Vector3(0,0,1),1*Math.sign(R.x)*a)}if(i&&Math.abs(R.y)>.5){if(!_(Math.sign(R.y)*s,"x"))return;n.controlObject.rotateOnWorldAxis(new THREE.Vector3(1,0,0),1*Math.sign(R.y)*s)}}}),!1),e.addEventListener("touchend",(function(e){0!=n.enable&&(f.X=null,f.Y=null,p.length>0?p.pop():p=[],o===c.MOUSEDOWN||c.MOUSEMOVE,b())}),!1),e.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1);var o,r={x:{enabled:!1,from:Math.PI/8,to:Math.PI/8},y:{enabled:!1,from:Math.PI/4,to:Math.PI/4}},a=.05,s=.05,i=!1,l=!0,c={MOUSEDOWN:0,MOUSEMOVE:1},d=!1,u=!1,h={x:0,y:0},p=[],f={X:null,Y:null};function g(){n.currentControllObject.scale.multiplyScalar(1.1)}function m(){n.currentControllObject.scale.multiplyScalar(.9)}function _(e,t){return!r[t].enabled||!!(-1*r[t].from<n.controlObject.rotation[t]+e&&n.controlObject.rotation[t]+e<r[t].to)}function b(){h={x:0,y:0}}var v=this,y=(new THREE.Spherical,new THREE.Spherical,new THREE.Vector3,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2),E=new THREE.Vector2,w=new THREE.Vector2;this.panSpeed=1,this.mouseButtons={LEFT:THREE.MOUSE.LEFT,MIDDLE:THREE.MOUSE.MIDDLE,RIGHT:THREE.MOUSE.RIGHT}},THREE.ObjectControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.ObjectControls.prototype.constructor=THREE.ObjectControls;