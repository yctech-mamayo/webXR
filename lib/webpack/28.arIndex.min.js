"use strict";(self.webpackChunkmifly_ar=self.webpackChunkmifly_ar||[]).push([[28],{28:(e,t,r)=>{r.r(t);var o=r(634),a=r(406);const n=class{constructor(e){let t=this;t.GLRenderer=e,t.ARC=null,t.VRC=null,t.XRC=null,t.currentSceneController=null,t.currentSceneType="",t.mouse=new THREE.Vector2;let r=e.domElement;r.addEventListener("touchend",t.endEvent.bind(t),!1),r.addEventListener("mouseup",t.endEvent.bind(t),!1),r.addEventListener("touchmove",t.moveEvent.bind(t),!1),r.addEventListener("mousemove",t.moveEvent.bind(t),!1),r.addEventListener("touchstart",t.startEvent.bind(t),!1),r.addEventListener("mousedown",t.startEvent.bind(t),!1)}includeAR(e){this.ARC=e}includeVR(e){this.VRC=e}includeXR(e){this.XRC=e}setControllerType(e){let t=this;switch(t.currentSceneType=e,e){case"AR":t.ARC?t.currentSceneController=t.ARC:console.warn("_setControllerType_: this project do not contain AR.");break;case"VR":t.VRC?t.currentSceneController=t.VRC:console.warn("_setControllerType_: this project do not contain VR.");break;case"XR":t.XRC?t.currentSceneController=t.XRC:console.warn("_setControllerType_: this project do not contain XR.");break;default:console.warn("_setControllerType_: type unknow",e)}}endEvent(e){e.preventDefault();let t=this;switch(t.currentSceneType){case"AR":t.ARC.arController.clickEndEvent&&t.ARC.arController.clickEndEvent(e);break;case"VR":t.VRC.clickEndEvent&&t.VRC.clickEndEvent(e);break;case"XR":t.XRC.clickEndEvent&&t.XRC.clickEndEvent(e)}}moveEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickMoveEvent&&t.ARC.arController.clickMoveEvent(e);break;case"VR":t.VRC.clickMoveEvent&&t.VRC.clickMoveEvent(e);break;case"XR":t.XRC.clickMoveEvent&&t.XRC.clickMoveEvent(e)}}startEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickStartEvent&&t.ARC.arController.clickStartEvent(e);break;case"VR":t.VRC.clickStartEvent&&t.VRC.clickStartEvent(e);break;case"XR":t.XRC.clickStartEvent&&t.XRC.clickStartEvent(e)}}};function i(e){for(var t="",r=0;r<e;r++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}async function l(e){let t=await fetch(e,{method:"HEAD"});return console.log(" _UrlExistsFetch: ret ",t),!!t.status&&"200"==t.status}function s(e){return"object"==typeof e&&"function"==typeof e.then}function c(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image";break;default:console.log("image: default, obj=",e)}}function d(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image",e.sub_type="png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image",e.sub_type="png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image",e.sub_type="png";break;case"Cube":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb",e.main_type="model",e.sub_type="glb";break;case"Capsule":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb",e.main_type="model",e.sub_type="glb";break;case"Sphere":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Bojue":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Fei":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Lina":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Poyuan":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Roger":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb",e.main_type="model",e.sub_type="glb";break;case"Camera":case"camera":e.main_type="camera",e.sub_type="";break;case"Text":e.main_type="text";break;case"Light":e.main_type="light";break;case"quiz":e.main_type="empty",e.sub_type="quiz";break;case"point_card":e.main_type="empty",e.sub_type="point_card";break;case"scratch_card":e.main_type="empty",e.sub_type="scratch_card";break;case"Curve":e.main_type="curve";break;default:if(e.res_gltf_resource)break;e.generalAttr?e.generalAttr.obj_type||(e.generalAttr.obj_type="3d"):e.generalAttr={obj_type:"3d"},e.transformAttr?e.transformAttr.transform||(e.transformAttr.transform=["0,0,0","0,0,0,1","1,1,1"]):e.transformAttr={transform:["0,0,0","0,0,0,1","1,1,1"]},e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb"}}function u(e,t,r,o,a){let n=e.object3D;if(n){e.setAttribute("position",t),e.setAttribute("scale",o);let r=new THREE.Euler;r.setFromQuaternion(a),r.x=-r.x,r.y=-r.y;let i=new THREE.Quaternion;i.setFromEuler(r),n.setRotationFromQuaternion(i)}}function p(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("VRFunc.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("VRFunc.js: _checkGLTFMaterialIndex: material error",t);let r=t.mesh_idx,o=t.primitive_idx,a=-1,n=-1,i=e.object3D.children[0].ModelJson.nodes,l=-1;for(let e=0;e<i.length;e++)if("number"==typeof i[e].mesh&&l++,r==l){a=i[e].mesh;break}if(a>=0){let t=e.object3D.children[0].ModelJson.meshes[a];if(t&&t.primitives){let e=t.primitives[o];e&&e.material>=0&&(n=e.material,console.log("VRFunc.js: _checkGLTFMaterialIndex: materialIndex=",n))}}return self,[n,a]}function m(e,t,r,o,a){let n=t.getObject3D("mesh"),i=null;if(r.materialAttr&&r.materialAttr.materials)for(let o=0;o<r.materialAttr.materials.length;o++)n.ModelJson&&(i=p(t,r.materialAttr.materials[o])),g(e,t,r.materialAttr.materials[o].material_idx,i)}function h(e,t,r,a,n,i){let s=this,c=o.o.getProjDataEditorVer(arController.currentProjData);return arController.cubeTex,arController.cameraTexture,new Promise((function(o){l(t.res_url).then((l=>{if(1==l){if(console.log(" __loadGLTFModel__:  ",t),""==t.res_url||"glb"!=t.sub_type&&"gltf"!=t.sub_type&&"gltf_sketchFab"!=t.sub_type&&"gltf_sketchfab"!=t.sub_type&&"gltf_poly"!=t.sub_type)return console.log(" _loadGLTFModel_: obj not support ",t),void o(-1);let a=s.gcssTargets.dpi[e.GCSSID],l=s.gcssTargets.width[e.GCSSID],d=s.gcssTargets.height[e.GCSSID],p=(s.sceneTargetList[e.GCSSID].sceneIndex,document.createElement("a-entity")),h=document.getElementById("makarAssets"),g=document.createElement("a-asset-item");if(g.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),g.setAttribute("src",t.res_url),g.setAttribute("response-type","arraybuffer"),g.setAttribute("crossorigin","anonymous"),h.appendChild(g),!t.res_url)return;p.setAttribute("gltf-model","#"+t.generalAttr.obj_id+"_"+t.res_id);let b,_=null;if(c&&3==c.v0&&c.v1>=5){if(p.setAttribute("id",t.generalAttr.obj_id),t.animationAttr){_=[];for(let e=0;e<t.animationAttr.length;e++)(t.animationAttr[e].is_default||t.animationAttr[e].is_active)&&(_.push({idle:t.animationAttr[e].uid,loop:t.animationAttr[e].uid,uid:t.animationAttr[e].uid,changed:!1,reset:!0,count:0}),b=t.animationAttr[e].animation_name);for(let e=0;e<t.animationAttr.length;e++)_.push({name:t.animationAttr[e].name,animationName:t.animationAttr[e].animation_name,startTime:t.animationAttr[e].start_time,endTime:t.animationAttr[e].end_time,uid:t.animationAttr[e].uid});p.setAttribute("animation-mixer","clip: "+b)}t.behav||t.generalAttr.logic?p.setAttribute("class","clickable"):p.setAttribute("class","unclickable")}if(p.setAttribute("crossorigin","anonymous"),p.setAttribute("shadow",""),t.model_shift){let e=(new THREE.Vector3).fromArray(t.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(n),r.add(e)}if(s.makarObjects.push(p),p.addEventListener("model-loaded",(function(e){if(e.target==e.currentTarget){let h=s.arfScene.renderer.capabilities.getMaxAnisotropy();p.object3D.children[0].scale.set(2540/a,2540/a,2540/a),p.object3D.children[0].rotation.y=Math.PI;let g=new THREE.Vector3;if(t.generalAttr.obj_parent_id){p.object3D.obj_parent_id=t.generalAttr.obj_parent_id,g.addScaledVector(r,2540/a);let e=g.z;g.z=-e,u(p,g,0,n,i)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),g.addScaledVector(r,2540/a);break;case"3.0.0":n.multiplyScalar(2),g.addScaledVector(r,5080/a);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let e=g.y,t=g.z;g.y=t,g.z=e,u(p,g,0,n,i),p.object3D.position.add(new THREE.Vector3(25.4*l/a/2,25.4*d/a/2,0)),p.object3D.rotation.x+=90*Math.PI/180,console.log("_loadGLTFModel_: loaded: no parent prs=",p.object3D.position,p.object3D.rotation,p.object3D.scale)}let b=p.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone()},p.object3D.makarType="model",p.object3D.makarObject=!0,t.behav&&(p.object3D.behav=t.behav),t.behav_reference&&(p.object3D.behav_reference=t.behav_reference),e.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=h,e.material.map.needsUpdate=!0)})),p.object3D&&(t.materialAttr.materials&&m(s,p,t),c&&3==c.v0&&c.v1>=5&&t.generalAttr&&1==t.generalAttr.logic&&(b.resetProperty=function(){m(s,p,t)}),Array.isArray(e.detail.model.animations)&&e.detail.model.animations.length>0&&!p.getAttribute("animation-mixer")&&(console.log("_loadGLTFModel_: the model with animation but no animation-mixer, probabily older version of editor "),p.setAttribute("animation-mixer","clip: "+e.detail.model.animations[0].name),_=[],_.push({changed:!1,idle:"mifly168",uid:"mifly168"}),_.push({animationName:e.detail.model.animations[0].name,name:e.detail.model.animations[0].name,endTime:e.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),e.detail.model.animationSlices=_,o(p))}})),0==t.generalAttr.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable")),t.generalAttr.obj_parent_id){let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(p),window.clearInterval(e))}),1)}else e.appendChild(p)}else console.log("_loadGLTFModel_: , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",t.material=[],h(e,t,r,a,n,i),o(1)}))}))}function g(e,t,r,o){let a=t.getObject3D("mesh"),n=e.userMaterialDict[r],i={};console.log("material_idx",n);let l=o[0],s=o[1];a.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),i.name=n.res_name,i.shader=n.shader;for(let t=0;t<n.properties.length;t++)switch(n.properties[t].key){case"alphaMode":break;case"doubleSided":i.doubleSided=n.properties[t].value;break;case"_Color":let o=n.properties[t].value.split(",");i.color=new THREE.Color(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),i.alpha=parseFloat(o[3]);break;case"_MainTex":i.map=e.materials_texture_dict[r].mainTex;break;case"_Cutoff":i.cutoff=n.properties[t].value;break;case"_Glossiness":i.smoothness=n.properties[t].value;break;case"_SpecGlossMap":i.specGlossMap=e.materials_texture_dict[r].specGlossMap;case"_Metallic":i.metallic=n.properties[t].value;break;case"_MetallicGlossMap":i.metalnessMap=e.materials_texture_dict[r].metalnessMap;break;case"_SpecularHighlights":i.specularHighlights=n.properties[t].value;break;case"_GlossyReflections":i.glossyReflections=n.properties[t].value;break;case"_BumpScale":i.bumpscale=n.properties[t].value;break;case"_BumpMap":i.bumpMap=e.materials_texture_dict[r].bumpMap;break;case"_Parallax":i.parallax=n.properties[t].value;break;case"_ParallaxMap":i.parallaxMap=e.materials_texture_dict[r].parallaxMap;break;case"_OcclusionStrength":i.aoMapIntensity=n.properties[t].value;break;case"_OcclusionMap":i.aoMap=e.materials_texture_dict[r].aoMap;break;case"_EmissionColor":let a=n.properties[t].value.split(",");i.emissionColor=new THREE.Color(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]));break;case"_EmissionMap":i.emissionMap=e.materials_texture_dict[r].emissionMap;break;case"_Mode":i.mode=n.properties[t].value;break;case"_ToonShade":i.toonShade=e.materials_texture_dict[r].toonShade;break;case"_TintColor":1==n.properties[t].value?i.tintColor=!0:i.tintColor=!1;break;case"_Brightness":i.brightness=n.properties[t].value;break;case"_OutlineColor":let l=n.properties[t].value.split(",");i.outlineColor=new THREE.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]));break;case"_Outline":i.outlineWidth=n.properties[t].value}switch(console.log(i),i.shader){case"Unlit/Color":a.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==l&&e.meshIdx==s&&(e.material=new THREE.MeshBasicMaterial({color:i.color,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":case"Autodesk Interactive":var c=t.sceneEl.renderer;a.traverse((t=>{if(t.material){let r=t.material.name.split("_");r[r.length-1]==l&&t.meshIdx==s&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:i.map?i.map:null,emissive:i.emissionColor?i.emissionColor:t.material.emissive,emissiveMap:i.emissionMap?i.emissionMap:null,normalMap:t.material.normalMap,bumpMap:i.bumpMap?i.bumpMap:null}),t.material.color=i.color,i.metalnessMap?t.material.metalnessMap=i.metalnessMap:(t.material.metalness=i.metallic,t.material.roughness=1-i.smoothness),t.material.bumpscale=i.bumpscale,t.material.displacementMap=i.displacementMap?i.displacementMap:null,i.aoMap&&(t.geometry.attributes.uv2=t.geometry.attributes.uv.clone(),t.material.aoMap=i.aoMap,t.material.aoMapIntensity=i.aoMapIntensity),t.material.envMap=e.cubeTex.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=i.doubleSided?THREE.DoubleSide:THREE.FrontSide,t.material.transparent=!0,t.material.map&&(THREE.GammaEncoding&&(t.material.map.encoding=THREE.GammaEncoding),t.material.map.needsUpdate=!0),0==i.mode?(t.material.opacity=1,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==i.mode?(t.material.opacity=1,t.material.alphaTest=i.cutoff,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})):2==i.mode?(t.material.opacity=i.alpha,t.material.depthWrite=!1,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})):3==i.mode&&(t.material.opacity=Math.max(i.alpha,i.metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})))}}));break;case"Unlit/Transparent":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==l&&e.meshIdx==s&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));case"Unlit/Transparent Cutout":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==l&&e.meshIdx==s&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:i.map}),e.material.opacity=1,e.material.alphaTest=i.cutoff)}}));break;case"Unlit/Texture":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==l&&e.meshIdx==s&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:i.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/Vertex":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==l&&e.meshIdx==s&&(e.material.color=new THREE.Color(1,1,1),e.material.vertexColors=!0)}}));break;case"Unlit/ScreenCutoutShader":a.traverse((t=>{if(t.material){let r=t.material.name.split("_");r[r.length-1]==l&&t.meshIdx==s&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.skyRenderTarget.texture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"TSF/BaseOutline1":e.needsCullFaceBack=!0;let o=t.object3D.clone(!0);a.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==l&&e.meshIdx==s){let t=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning});t.onBeforeCompile=function(e){e.uniforms.toonShade={value:i.toonShade},e.uniforms.tintColor={value:i.tintColor},e.uniforms.color={value:i.color},e.uniforms.brightness={value:i.brightness},e.vertexShader="varying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",["#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <begin_vertex>"].join("\n")),e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","vProjection = normalize( transformedNormal );","vProjection.y = -vProjection.y;","vProjection.z = -vProjection.z;"].join("\n")),e.fragmentShader="uniform sampler2D toonShade;\nuniform bool tintColor;\nuniform vec3 color;\nuniform float brightness;\nvarying vec3 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <fog_fragment>",["#include <fog_fragment>","\tvec2 sampleUV;","   vec4 tmp;","\tsampleUV.x = vProjection.x*0.5 + 0.5;","\tsampleUV.y = vProjection.y*0.5 + 0.5;","   tmp = texture2D(toonShade, sampleUV);","   if(tintColor){","       tmp.x = tmp.x * color.x * brightness;","       tmp.y = tmp.y * color.y * brightness;","       tmp.z = tmp.z * color.z * brightness;","   }","   else{","       tmp.x = tmp.x * brightness;","       tmp.y = tmp.y * brightness;","       tmp.z = tmp.z * brightness;","   }","\tgl_FragColor.x *= tmp.x;","\tgl_FragColor.y *= tmp.y;","\tgl_FragColor.z *= tmp.z;"].join("\n"))},t.map=i.map,e.material=t}}})),o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==l&&e.meshIdx==s){let t=e.material.clone();t.onBeforeCompile=function(e){e.uniforms.boarderColor={value:i.outlineColor},e.uniforms.boarderWidth={value:i.outlineWidth},e.vertexShader="uniform float boarderWidth;\nvarying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","mvPosition.xyz += vNormal * boarderWidth * 0.01;","gl_Position = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform vec3 boarderColor;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","gl_FragColor = vec4(boarderColor, 1.0);"].join("\n"))},e.material=t}}}));break;case"Blocks/Basic":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==l&&e.meshIdx==s){let t=e.material.clone();t.color=i.color,e.material=t}}}));break;case"Blocks/BlocksGlass":case"Blocks/BlocksGem":a.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==l&&e.meshIdx==s){let t=e.material.clone();t.color=i.color,e.material=t,e.material.depthWrite=!1,e.renderOrder=1}}}));break;default:console.log(`The shader of id ${r} material is not supported currently.`)}}function b(e){let t=this;return new Promise((function(r){if(0!=e.materialAttr.materials.length){let o=[];for(let r=0;r<e.materialAttr.materials.length;r++){let a=e.materialAttr.materials[r].material_idx;t.materials_texture_dict[a]={};let n=t.userMaterialDict[a];for(let e=0;e<n.properties.length;e++){let r,i=null;"_MainTex"!=n.properties[e].key&&"_MetallicGlossMap"!=n.properties[e].key&&"_SpecGlossMap"!=n.properties[e].key&&"_BumpMap"!=n.properties[e].key&&"_ParallaxMap"!=n.properties[e].key&&"_OcclusionMap"!=n.properties[e].key&&"_EmissionMap"!=n.properties[e].key&&"_ToonShade"!=n.properties[e].key||(i=n.properties[e].value,r=n.properties[e].scale.split(",").map((e=>Number(e))));let s=new Promise((function(o){i?l(i).then((l=>{if(1==l){let l=(new THREE.TextureLoader).load(i,(function(){l.wrapS=THREE.RepeatWrapping,l.wrapT=THREE.RepeatWrapping,l.flipY=!1,l.repeat.x=r[0],l.repeat.y=r[1],l.format=THREE.RGBAFormat,l.needsUpdate=!0,o(l)}));"_MainTex"==n.properties[e].key?t.materials_texture_dict[a].mainTex=l:"_MetallicGlossMap"==n.properties[e].key?t.materials_texture_dict[a].metalnessMap=l:"_SpecGlossMap"==n.properties[e].key?t.materials_texture_dict[a].specGlossMap=l:"_BumpMap"==n.properties[e].key?t.materials_texture_dict[a].bumpMap=l:"_ParallaxMap"==n.properties[e].key?t.materials_texture_dict[a].parallaxMap=l:"_OcclusionMap"==n.properties[e].key?t.materials_texture_dict[a].aoMap=l:"_EmissionMap"==n.properties[e].key?t.materials_texture_dict[a].emissionMap=l:"_ToonShade"==n.properties[e].key&&(t.materials_texture_dict[a].toonShade=l)}else console.log("_loadMaterialTexture: texture url not exists."),o(1)})):o(1)}));o.push(s)}}Promise.all(o).then((function(e){console.log("GLTFModleModule.js: _loadMaterials: textures then ret = ",e),r(o)}))}else console.log("_loadMaterialTexture: obj no material texture"),r(1)}))}function _(e,t,r,a,n,i){let s=this,c=o.o.getProjDataEditorVer(arController.currentProjData);return new Promise((function(o){l(t.res_url).then((l=>{if(1==l){let a=document.getElementById("makarAssets"),l=document.createElement("audio");l.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),l.setAttribute("src",t.res_url),l.setAttribute("crossorigin","anonymous"),l.setAttribute("loop",!0),l.setAttribute("preload","auto"),a.appendChild(l),c&&3==c.v0&&c.v1>=5&&l.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),a.appendChild(l),l.onloadedmetadata=function(){let a=document.createElement("a-entity");a.setAttribute("sound","src: #"+t.generalAttr.obj_id+"_"+t.res_id+"; positional: false"),a.setAttribute("id",t.generalAttr.obj_id),a.setAttribute("sound","autoplay: false"),u(a,r,0,n,i),s.makarObjects.push(a);let l=!0;0==t.generalAttr.active&&(a.setAttribute("sound","loop: false"),a.setAttribute("visible",!1),l=!1,a.setAttribute("class","unclickable"));let c=!1;if(t.generalAttr.obj_parent_id){a.setAttribute("sound","autoplay: false");let d=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(a),window.clearInterval(d),e.addEventListener("child-attached",(function(e){if(t.generalAttr.logic)a.blockly=t.generalAttr.logic,a.setAttribute("sound","autoplay: false");else{let e=!0;a.object3D.traverseAncestors((function(r){if("Scene"!=r.type)console.log(" _loadAudio_: traverseAncestors: not Scene parent=",r),0==r.visible&&(e=!1);else if(1==e&&1==a.object3D.visible&&1==l)if(console.log("_loadAudio_: traverseAncestors: all parent visible true=",a.components.sound),1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==r.location){a.setAttribute("sound","autoplay: false");let o=document.getElementById("clickToPlayAudio");function n(){a.components.sound.playSound(),o.style.display="none",o.removeEventListener("click",n),window.allowAudioClicked=!0}o.style.display="block",o.addEventListener("click",n)}else a.setAttribute("sound","autoplay: true"),y(t,a,c);else console.log(" _loadAudio_: traverseAncestors: not all parent visible true=",a.components.sound),a.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(t.generalAttr.logic)a.blockly=t.generalAttr.logic,a.setAttribute("sound","autoplay: false");else if(console.log(" _loadAudio_: ",l,c),1==l)if(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location){a.setAttribute("sound","autoplay: false");let p=document.getElementById("clickToPlayAudio");function m(){a.components.sound.playSound(),p.style.display="none",p.removeEventListener("click",m),window.allowAudioClicked=!0}p.style.display="block",p.addEventListener("click",m)}else a.setAttribute("sound","autoplay: true"),y(t,a,c);else a.setAttribute("sound","autoplay: false");e.appendChild(a)}a.addEventListener("loaded",(function(e){e.target==e.currentTarget&&(a.object3D.makarType="audio",a.object3D.makarObject=!0,a.object3D.makarType="audio",t.behav&&(a.object3D.behav=t.behav),t.behav_reference&&(a.object3D.behav_reference=t.behav_reference),o(a))}))}}else console.log(" _loadAudio_ , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",h(e,t,r,a,n,i),o(1)})).catch((function(e){console.log("_loadAudio_: error ",e)}))}))}function y(e,t,r){(0==e.generalAttr.active||r)&&t.setAttribute("sound","autoplay: false"),e.typeAttr&&(null!=e.typeAttr.is_play&&t.setAttribute("sound",`autoplay: ${e.typeAttr.is_play}`),null!=e.typeAttr.is_play&&t.setAttribute("sound",`loop: ${e.typeAttr.is_loop}`),null!=e.typeAttr.volume&&t.setAttribute("sound",`volume: ${e.typeAttr.volume}`))}function j(e,t,r,a,n,i){let s=this,d=o.o.getProjDataEditorVer(arController.currentProjData);return c(t),new Promise((function(o){l(t.res_url).then((l=>{if(1==l){let a,l,c,p,m,h=s.gcssTargets.dpi[e.GCSSID],g=s.gcssTargets.width[e.GCSSID],b=s.gcssTargets.height[e.GCSSID],_=(s.sceneTargetList[e.GCSSID].sceneIndex,(new THREE.TextureLoader).load(t.res_url)),y=t.res_url.split(".").length,j=t.res_url.split(".")[y-1].toLowerCase();if(t.sub_type=t.sub_type.toLowerCase(),"png"==t.sub_type||"jpg"==t.sub_type||"jpeg"==t.sub_type||"bmp"==t.sub_type)j=t.sub_type,a=document.createElement("a-plane"),a.setAttribute("src",t.res_url);else if("gif"==t.sub_type)j=t.sub_type,a=document.createElement("a-entity");else{if("button"!=t.sub_type)return console.log("_loadAframeTexture: sub_type empty, create empty plane "),a=document.createElement("a-plane"),void o(a);"png"!=j&&"jpg"!=j&&"jpeg"!=j&&(j="png"),a=document.createElement("a-plane"),a.setAttribute("src",t.res_url)}let f=!1;if(d&&3==d.v0&&d.v1>=5){if(a.setAttribute("id",t.generalAttr.obj_id),t.typeAttr.matting&&(f=!0,l=t.typeAttr.matting.chromakey,c=t.typeAttr.matting.slope,p=t.typeAttr.matting.threshold,m=t.typeAttr.matting),f){let e=l.split(","),r=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),o=m.HSV.split(","),n=parseFloat(o[0]),i=parseFloat(o[1]),s=parseFloat(o[2]);"jpg"==j||"jpeg"==j||"png"==j?"RGB"==m.mode?a.setAttribute("material","shader: chromaKey; color: #"+r.getHexString()+";transparent: true; _slope: "+parseFloat(c)+"; _threshold: "+parseFloat(p)+";"):"HSV"==m.mode&&a.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+n+"; _keyingColorS:"+i+"; _keyingColorV:"+s+"; _deltaH:"+parseFloat(m.hue)+"; _deltaS:"+parseFloat(m.saturation)+"; _deltaV:"+parseFloat(m.brightness)+";"):"gif"==j&&("RGB"==m.mode?(a.setAttribute("geometry","primitive: plane"),a.setAttribute("material","shader:gif_RGB;  src: url("+t.res_url+"); opacity: 1; transparent: true; depthWrite:false; color: #"+r.getHexString()+"; _slope: "+parseFloat(c)+"; _threshold: "+parseFloat(p)+";")):"HSV"==m.mode&&(a.setAttribute("geometry","primitive: plane"),a.setAttribute("material","shader:gif_HSV;  src: url("+t.res_url+"); opacity: 1; transparent: true; depthWrite:false; _keyingColorH:"+n+"; _keyingColorS:"+i+"; _keyingColorV:"+s+"; _deltaH:"+parseFloat(m.hue)+"; _deltaS:"+parseFloat(m.saturation)+"; _deltaV:"+parseFloat(m.brightness)+";")))}else"jpg"==j||"jpeg"==j||"png"==j?a.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; "):"gif"==j&&(a.setAttribute("geometry","primitive: plane"),a.setAttribute("material","shader:gif;  src: url("+t.res_url+"); opacity: 1; transparent: true;"));0==t.generalAttr.active&&(a.setAttribute("visible",!1),a.setAttribute("class","unclickable"))}a.setAttribute("crossorigin","anonymous"),t.behav?0==t.behav.length&&f?a.setAttribute("class","unclickable"):a.setAttribute("class","clickable"):t.generalAttr.logic?a.setAttribute("class","clickable"):a.setAttribute("class","unclickable"),s.makarObjects.push(a);let w=s.arfScene.renderer.capabilities.getMaxAnisotropy();if(a.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=w,e.detail.texture.needsUpdate=!0})),a.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){let e=setInterval((function(){if(_.image&&a.object3D&&a.object3D.children&&a.object3D.children[0]&&a.object3D.children[0].scale){a.object3D.children[0].scale.set(25.4*_.image.width/h,25.4*_.image.height/h,1);let l=new THREE.Vector3;if(t.generalAttr.obj_parent_id){a.object3D.obj_parent_id=t.generalAttr.obj_parent_id,l.addScaledVector(r,2540/h);let e=l.z;l.z=-e,u(a,l,0,n,i)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),l.addScaledVector(r,2540/h);break;case"3.0.0":l.addScaledVector(r,5080/h),n.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let e=l.y,t=l.z;l.y=t,l.z=e,u(a,l,0,n,i),a.object3D.position.add(new THREE.Vector3(25.4*g/h/2,25.4*b/h/2,0)),a.object3D.rotation.x+=90*Math.PI/180}let s=a.object3D;s.originTransform={position:s.position.clone(),rotation:s.rotation.clone(),scale:s.scale.clone()},t.blockly&&(s.resetProperty=function(){}),a.setAttribute("heightForQuiz",.01*_.image.height),window.clearInterval(e),o(a)}}),1);a.object3D.makarType="image",a.object3D.makarObject=!0,t.behav&&(a.object3D.behav=t.behav),t.behav_reference&&(a.object3D.behav_reference=t.behav_reference),"button"==t.main_type&&(a.object3D.main_type=t.main_type,a.object3D.sub_type=t.sub_type,a.setAttribute("class","clickable"),console.log("three.js: _loadAframeTexture: button ",a))}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(a),window.clearInterval(e))}),1)}else e.appendChild(a)}else console.log("ARFunc.js: _loadAframeTexture , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",h(e,t,r,a,n,i),o(1)}))}))}function f(e,t,r,o,a=null,n=null,i=null){let l=this;return new Promise((function(a){(new THREE.TextureLoader).load(t.res_url,(function(n){let i,s,c,d,u,p;if(console.log("VRFunc.js: _loadTexture2D: texture WH=",n.image.width,n.image.height),4==Object.keys(l.editor_version).length){let e;if(Number(l.editor_version.v0),Number(l.editor_version.v1),Number(l.editor_version.v2),e=m(),!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void a(!1);i=e.rectP,s=e.rectSizeDelta,c=e.rectScale,d=e.rectR}else{let e=m();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void a(!1);i=e.rectP,s=e.rectSizeDelta,c=e.rectScale,d=e.rectR}function m(){let e,r,o,a,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(l.selectedResolutionIndex)||(console.warn(" _getObj2DInfo350: error, missing _selectedResolutionIndex",l.selectedResolutionIndex),l.selectedResolutionIndex=0);let i=t.transformAttr.rect_transform[l.selectedResolutionIndex];if(i.position&&i.rotation&&i.scale&&i.size_delta){e=i.position.split(",").map((function(e){return Number(e)})),r=i.size_delta.split(",").map((function(e){return Number(e)})),o=i.scale.split(",").map((function(e){return Number(e)})),a=i.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])),l=(new THREE.Euler).setFromQuaternion(t,"YXZ"),s=new THREE.Vector3(l.x,l.y,l.z);s.z=-1*s.z,n={rectP:e,rectSizeDelta:r,rectScale:o,rectR:s}}}return n}n.flipY=!1,console.log("VRFunc.js: _loadTexture2D: innerWH , camera2D ",innerWidth,innerHeight,l.arScene.clientWidth,l.arScene.clientHeight);let h=l.scaleRatioXY;u=s[0]*h,p=s[1]*h;let g=t.res_url,b=t.sub_type,_=new THREE.Object3D;_.makarType="image2D";let y,j,f,w,D,v,A=!1;if(t.typeAttr.matting&&(A=!0,y=t.typeAttr.matting.chromakey,j=t.typeAttr.matting.slope,f=t.typeAttr.matting.threshold,w=t.typeAttr.matting),A){let e,t=w.HSV.split(","),r=parseFloat(t[0]),o=parseFloat(t[1]),a=parseFloat(t[2]);"jpg"==b||"jpeg"==b||"png"==b||"button"==b?("RGB"==w.mode?e=new THREE.ChromaKeyMaterial({map:n,keyColor:y,side:THREE.DoubleSide,slope:j,threshold:f}):"HSV"==w.mode&&(e=new THREE.HSVMattingMaterial({map:n,side:THREE.DoubleSide,_keyingColorH:r,_keyingColorS:o,_keyingColorV:a,_deltaH:w.hue,_deltaS:w.saturation,_deltaV:w.brightness})),D=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,p,0),e)):"gif"==b&&(v=new THREE.gifAnimator,v.init({src:g,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0,chroma:w}),_.gifObject=v,v.__texture.flipY&&(v.__texture.flipY=!1),D=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,p,0),v.material))}else"jpg"==b||"jpeg"==b||"png"==b||"button"==b?D=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,p,0),new THREE.MeshBasicMaterial({map:n,side:THREE.DoubleSide,transparent:!0})):"gif"==b&&(v=new THREE.gifAnimator,v.init({src:g,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0}),_.gifObject=v,v.__texture.flipY&&(v.__texture.flipY=!1),D=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,p,0),v.material));if(t.behav&&(_.behav=t.behav,l.setObjectBehavAll(t)),0==t.generalAttr.active&&(_.visible=!1),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,"button"==t.main_type&&(_.sub_type=t.sub_type),t.generalAttr.obj_parent_id){let e=function(){let n=!1;for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(n=!0);if(0==n)setTimeout(e,500);else for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(_.scale.set(c[0],c[1],1),_.translateX(i[0]*h),_.translateY(-i[1]*h),_.translateZ(r/o-1),_.rotateZ(d.z),_.add(D),l.makarObjects2D[e].add(_),l.makarObjects2D.push(_),a(_),console.log("______VRFunc.js: _loadTexture2D: parent exit, set obj(parent) ",t,D,l.makarObjects2D.slice(),performance.now()))};e()}else console.log("VRFunc.js: VRController: _loadTexture2D: obj() ",t),_.scale.set(c[0],c[1],1),_.translateX(i[0]*h),_.translateY(-i[1]*h),_.translateZ(r/o-1),_.rotateZ(d.z),l.makarObjects2D.push(_),e.add(_),_.add(D),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,a(_),console.log("______VRFunc.js: _loadTexture2D: self.makarObjects2D.slice()=",l.makarObjects2D.slice(),performance.now())}),void 0,(function(e){console.error("An error happened. _loadTexture2D , err=",e)}))}))}function w(e,t,r,a,n,i){let l=this,s=o.o.getProjDataEditorVer(arController.currentProjData);return new Promise((function(o){let a=l.gcssTargets.dpi[e.GCSSID],c=l.gcssTargets.width[e.GCSSID],d=l.gcssTargets.height[e.GCSSID],p=document.createElement("a-entity");if(s&&3==s.v0&&s.v1>=5){p.setAttribute("id",t.generalAttr.obj_id);let s="type:"+t.typeAttr.light_type,m=t.typeAttr.color.split(","),h=new THREE.Color(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]));if(s+="; color:#"+h.getHexString(),s+=";intensity:"+t.typeAttr.intensity,"point"!=t.typeAttr.light_type&&"spot"!=t.typeAttr.light_type||(s+=";distance:"+2*t.typeAttr.range*100*25.4/a,s+=";decay: 2"),"spot"==t.typeAttr.light_type&&(s+=";angle:"+(parseFloat(t.typeAttr.spotAngle)/2).toString(),s+=";penumbra: 0.2"),t.typeAttr.shadow,p.setAttribute("light",s),"directional"==t.typeAttr.light_type&&(p.setAttribute("castShadow",!1),p.setAttribute("light","castShadow: false; ")),0==t.generalAttr.active&&p.setAttribute("visible",!1),p.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){if("directional"==t.typeAttr.light_type){p.object3D.children[0].position.set(0,0,0);let e=new THREE.Object3D;e.name="lightTarget",e.position.set(0,0,-1),p.object3D.children[0].target=e,p.object3D.add(e)}else"spot"==t.typeAttr.light_type||t.typeAttr.light_type;let e=new THREE.Vector3;if(t.generalAttr.obj_parent_id){p.object3D.obj_parent_id=t.generalAttr.obj_parent_id,e.addScaledVector(r,2540/a);let o=e.z;e.z=-o,u(p,e,0,n,i)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),e.addScaledVector(r,2540/a);break;case"3.0.0":n.multiplyScalar(2),e.addScaledVector(r,5080/a);break;default:console.log("three.js: _loadAframeLight: serverVersion version wrong",serverVersion)}let t=e.y,o=e.z;e.y=o,e.z=t,u(p,e,0,n,i),p.object3D.position.add(new THREE.Vector3(25.4*c/a/2,25.4*d/a/2,0)),p.object3D.rotation.x+=90*Math.PI/180}let s=p.object3D;s.originTransform={position:s.position.clone(),rotation:s.rotation.clone(),scale:s.scale.clone()},t.generalAttr.logic&&(s.resetProperty=function(){s.children[0].intensity=t.typeAttr.intensity,s.children[0].color.copy(h)}),p.object3D.makarType="light",p.object3D.makarObject=!0,l.makarObjects.push(p),o(p)}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(p),window.clearInterval(e))}),1)}else console.log("three.js: _loadAframeLight: loaded: no parent prs=",p.object3D.position,p.object3D.rotation,p.object3D.scale),e.appendChild(p)}}))}function D(e,t,r,a,n,i){let l=this,s=o.o.getProjDataEditorVer(arController.currentProjData);return new Promise((function(o){let a=l.gcssTargets.dpi[e.GCSSID],c=l.gcssTargets.width[e.GCSSID],d=l.gcssTargets.height[e.GCSSID];t.typeAttr?(t.typeAttr.content||(t.typeAttr.content="dev"),t.typeAttr.color||(t.typeAttr.color="1,1,1"),t.typeAttr.back_color||(t.typeAttr.back_color="0,0,0,0")):t.typeAttr={content:"dev",color:"1,1,1",back_color:"0,0,0,0"};let p,m=document.createElement("a-entity"),h=0;s&&3==s.v0&&s.v1>=5&&m.setAttribute("id",t.generalAttr.obj_id),l.makarObjects.push(m),t.behav||"button"==t.main_type||t.generalAttr.logic?m.setAttribute("class","clickable"):m.setAttribute("class","unclickable");let g=document.createElement("a-text");if(g.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),g.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;"),s&&3==s.v0&&s.v1>=5){let b=t.typeAttr.content.split("\n"),_=0;const y=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,j=e=>y.test(e);for(let A=0;A<b.length;A++){let C=0;for(let E=0;E<b[A].length;E++)j(b[A][E])?C+=1.6:b[A][E]==b[A][E].toUpperCase()&&b[A][E]!=b[A][E].toLowerCase()||b[A][E]==b[A][E].toLowerCase()&&b[A][E]!=b[A][E].toUpperCase()?C+=1:isNaN(1*b[A][E])?C+=1.25:C+=1;C>_&&(_=C)}g.setAttribute("value",t.typeAttr.content),g.setAttribute("width",.08*_),g.setAttribute("wrap-count",_+1),g.setAttribute("anchor","center"),g.setAttribute("align","left"),g.setAttribute("backcolor",t.typeAttr.back_color),g.setAttribute("textcolor",t.typeAttr.color),g.setAttribute("side","double");let f="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",w=[f+"1-msdf.json",f+"2-msdf.json",f+"3-msdf.json",f+"4-msdf.json",f+"5-msdf.json",f+"6-msdf.json",f+"7-msdf.json",f+"8-msdf.json",f+"9-msdf.json",f+"10-msdf.json",f+"11-msdf.json",f+"12-msdf.json"];g.setAttribute("font",w),g.setAttribute("negate","false"),g.setAttribute("crossorigin","anonymous");let D=t.typeAttr.color.split(",");function v(e){console.log("three.js: _loadAframeText: textEntity geometry-set: evt=",e),0==h?h=1:1==h&&o(g),g.removeEventListener("geometry-set",v)}p=new THREE.Color(parseFloat(D[0]),parseFloat(D[1]),parseFloat(D[2])),g.setAttribute("color","#"+p.getHexString()),g.addEventListener("geometry-set",v)}if(m.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: _loadAframeText: anchor loaded: evt=",e),g.object3D.scale.set(2540/a,2540/a,2540/a);let s=new THREE.Vector3;if(t.generalAttr.obj_parent_id){m.object3D.obj_parent_id=t.generalAttr.obj_parent_id,s.addScaledVector(r,2540/a);let e=s.z;s.z=-e,u(m,s,0,n,i)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),s.addScaledVector(r,2540/a);break;case"3.0.0":n.multiplyScalar(2),s.addScaledVector(r,5080/a);break;default:console.log("three.js: _loadAframeText: serverVersion version wrong",serverVersion)}let e=s.y,t=s.z;s.y=t,s.z=e,u(m,s,0,n,i),m.object3D.position.add(new THREE.Vector3(25.4*c/a/2,25.4*d/a/2,0)),m.object3D.rotation.x+=90*Math.PI/180,console.log(" +++++++++ set done",m.object3D.position,m.object3D.rotation,m.object3D.scale)}let b=m.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone(),textContent:t.typeAttr.content,textColor:p,textBackColor:t.typeAttr.back_color},t.generalAttr.logic&&(b.resetProperty=function(){g.getAttribute("value")!=t.typeAttr.content||g.components.text.attrValue.color!="#"+p.getHexString()||g.components.text.attrValue.backcolor!=t.typeAttr.back_color?(console.log("three.js: _loadAframeText: do reset"),g.components.text.textMesh.children.length=0,g.object3D.children.length=1,g.setAttribute("value",t.typeAttr.content),g.setAttribute("color","#"+p.getHexString()),g.setAttribute("backcolor",t.typeAttr.back_color)):console.log("three.js: _loadAframeText: text same, reset do nothing ")}),m.object3D.makarObject=!0,m.object3D.makarType="text",t.behav&&(m.object3D.behav=t.behav,l.setObjectBehavAll(t)),t.behav_reference&&(m.object3D.behav_reference=t.behav_reference),"button"==t.main_type&&(m.object3D.main_type=t.main_type),0==h?h=1:1==h&&o(g)}})),m.appendChild(g),0==t.generalAttr.active&&(m.setAttribute("visible",!1),m.setAttribute("class","unclickable")),t.generalAttr.obj_parent_id){let T=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(m),window.clearInterval(T))}),1)}else e.appendChild(m)}))}function v(e,t,r,o,a,n,i){return new Promise(((l,s)=>{let c,d,u,p,m,h,g=()=>{let e,r,o,a,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(this.selectedResolutionIndex)||(console.log(" _loadText2D: _getObj2DInfo338: error, missing _selectedResolutionIndex"),this.selectedResolutionIndex=0);let l=t.transformAttr.rect_transform[this.selectedResolutionIndex];if(l.position&&l.size_delta&&l.rotation&&l.scale){e=l.position.split(",").map((function(e){return Number(e)})),r=l.size_delta.split(",").map((function(e){return Number(e)})),o=l.scale.split(",").map((function(e){return Number(e)})),a=l.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])),s=(new THREE.Euler).setFromQuaternion(t,"YXZ"),c=new THREE.Vector3(s.x,s.y,s.z);c.z=-1*c.z,i.x=o[0],i.y=o[1],n={rectP:e,rectSizeDelta:r,rectScale:o,rectR:c}}}return n};if("object"==typeof this.editor_version&&4==Object.keys(this.editor_version).length){let e=Number(this.editor_version.v0),t=Number(this.editor_version.v1);if(Number(this.editor_version.v2),e>3||e>=3&&t>=5){let e=g();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void l(!1);c=e.rectP,d=e.rectSizeDelta,u=e.rectScale,p=e.rectR}else trans=g()}else{let e=g();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void l(!1);c=e.rectP,d=e.rectSizeDelta,u=e.rectScale,p=e.rectR}console.log("_loadText2D: info: ",t,a,n,i),console.log("_loadText2D: info: _rectAll= ",c,d,u,p);let b=this.scaleRatioXY;m=d[0]*b,h=d[1]*b,console.log("_loadText2D: info: wh = ",m,h,b);let _=0,y=t.typeAttr.content.split("\n");for(let e=0;e<y.length;e++)y[e].length>_&&(_=y[e].length);let j=m/_*1,f=h/y.length*.9,w=175*b,D=Math.min(j,f,w);console.log(" ******** ",t.typeAttr.content,D,_,"[",j,",",m,"]",", [",f,",",h,"], ",w);let v=new THREE.Object3D;v.makarType="text2D",t.behav&&(v.behav=t.behav,this.setObjectBehavAll(t)),0==t.generalAttr.active&&(v.visible=!1);let A=document.createElement("a-text");A.object3D.renderOrder=r,A.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),A.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let C=t.typeAttr.content.split("\n"),E=0;const T=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<C.length;e++){let t=0;for(let r=0;r<C[e].length;r++)k=C[e][r],T.test(k)?t+=1.6:C[e][r]==C[e][r].toUpperCase()&&C[e][r]!=C[e][r].toLowerCase()||C[e][r]==C[e][r].toLowerCase()&&C[e][r]!=C[e][r].toUpperCase()?t+=1:isNaN(1*C[e][r])?t+=1.25:t+=1;t>E&&(E=t)}var k;A.setAttribute("id",t.generalAttr.obj_id),A.setAttribute("value",t.typeAttr.content),A.setAttribute("width",.08*E),A.setAttribute("width",m),A.setAttribute("height",h),A.setAttribute("fontsize",D),A.setAttribute("wrap-count",E),A.setAttribute("anchor","center"),A.setAttribute("align","left"),A.setAttribute("baseline","center"),A.setAttribute("backcolor",t.typeAttr.back_color),A.setAttribute("textcolor",t.typeAttr.color),A.setAttribute("side","double");let S="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",R=[S+"1-msdf.json",S+"2-msdf.json",S+"3-msdf.json",S+"4-msdf.json",S+"5-msdf.json",S+"6-msdf.json",S+"7-msdf.json",S+"8-msdf.json",S+"9-msdf.json",S+"10-msdf.json",S+"11-msdf.json",S+"12-msdf.json"];A.setAttribute("font",R),A.setAttribute("negate","false"),A.setAttribute("crossorigin","anonymous");let x,M,P=t.typeAttr.color.split(","),I=new THREE.Color(parseFloat(P[0]),parseFloat(P[1]),parseFloat(P[2]));A.setAttribute("color","#"+I.getHexString()),document.getElementById("aTempScene")&&document.getElementById("aTempDiv")?M=document.getElementById("aTempScene"):(x=document.createElement("div"),x.style.display="none",M=document.createElement("a-scene"),M.setAttribute("id","aTempScene"),M.setAttribute("embedded",""),document.body.appendChild(x),x.appendChild(M)),M.appendChild(A),A.addEventListener("geometry-set",(function(e){let t=A.object3D;t&&(t.children[2]&&t.children[2],console.log("_loadText2D: textEntity geometry-set: textObject=",t,e)),l(v)})),A.addEventListener("loaded",(a=>{let n=A.object3D;if(v.add(n),n.rotation.x=Math.PI,n.scale.set(190,190,1),t.generalAttr.obj_parent_id){n.obj_parent_id=t.generalAttr.obj_parent_id;let e=()=>{let a=!1;for(let e=0;e<this.makarObjects2D.length;e++)this.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(a=!0);if(0==a)setTimeout(e,200);else for(let e=0;e<this.makarObjects2D.length;e++)if(this.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id){v.add(n),v.translateX(c[0]*b),v.translateY(-c[1]*b),v.translateZ(r/o-1),v.rotateZ(p.z),v.scale.set(i.x,i.y,1),v.makarObject=!0,v.obj_id=t.generalAttr.obj_id,v.obj_parent_id=t.generalAttr.obj_parent_id,this.makarObjects2D[e].add(v),this.makarObjects2D.push(v);break}};e()}else v.add(n),v.translateX(c[0]*b),v.translateY(-c[1]*b),v.translateZ(r/o-1),v.rotateZ(p.z),v.scale.set(i.x,i.y,1),v.makarObject=!0,v.obj_id=t.generalAttr.obj_id,this.makarObjects2D.push(v),e.add(v)}))}))}function A(e,t,r,a,n,i){let s=this,c=o.o.getProjDataEditorVer(arController.currentProjData);return new Promise((function(o){l(t.res_url).then((l=>{if(1==l){let a=s.gcssTargets.dpi[e.GCSSID],l=s.gcssTargets.width[e.GCSSID],p=s.gcssTargets.height[e.GCSSID],m=(s.sceneTargetList[e.GCSSID].projIndex,document.getElementById("makarAssets"));var d;(d=document.createElement("video")).src=t.res_url,d.playsInline=!0,d.autoplay=!1,d.loop=!0,d.setAttribute("crossorigin","anonymous"),d.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),m.appendChild(d),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(d.muted=!0),d.onloadedmetadata=function(){var m,h;d.videoWidth>=d.videoHeight?(m=1,h=1*d.videoHeight/d.videoWidth):(m=1*d.videoWidth/d.videoHeight,h=1);let g=document.createElement("a-video");if(c&&3==c.v0&&c.v1>=5){let e,r,o,a,n=!1;if(t.typeAttr.matting&&(n=!0,e=t.typeAttr.matting.chromakey,r=t.typeAttr.matting.slope,o=t.typeAttr.matting.threshold,a=t.typeAttr.matting),n){let t=e.split(",");var b=new THREE.Color(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]));let n=a.HSV.split(","),i=parseFloat(n[0]),l=parseFloat(n[1]),s=parseFloat(n[2]);"RGB"==a.mode?g.setAttribute("material","shader: chromaKey; color: #"+b.getHexString()+";transparent: true; _slope: "+parseFloat(r)+"; _threshold: "+parseFloat(o)+";"):"HSV"==a.mode&&g.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+i+"; _keyingColorS:"+l+"; _keyingColorV:"+s+"; _deltaH:"+a.hue+"; _deltaS:"+a.saturation+"; _deltaV:"+a.brightness+";")}else g.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");g.setAttribute("id",t.generalAttr.obj_id),g.setAttribute("src","#"+t.generalAttr.obj_id+"_"+t.res_id),0==t.generalAttr.active&&(g.setAttribute("visible",!1),g.setAttribute("class","unclickable"))}t.behav?0==t.behav.length&&transparentVideo?g.setAttribute("class","unclickable"):g.setAttribute("class","clickable"):t.generalAttr.logic?g.setAttribute("class","clickable"):g.setAttribute("class","unclickable"),g.mp4Video=d;let _=s.arfScene.renderer.capabilities.getMaxAnisotropy();g.addEventListener("materialtextureloaded",(function(e){console.log("three.js: _loadVideo: _materialtextureloaded: videoPlane = ",g.object3D,e),e.detail.texture.anisotropy=_,e.detail.texture.needsUpdate=!0})),g.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: videoPlane.loaded: vw vh = ",m,h,e),g.object3D.children[0].scale.set(100*m*25.4/a,100*h*25.4/a,1);let s=new THREE.Vector3;if(t.generalAttr.obj_parent_id){g.object3D.obj_parent_id=t.generalAttr.obj_parent_id,s.addScaledVector(r,2540/a);let e=s.z;s.z=-e,u(g,s,0,n,i)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),s.addScaledVector(r,2540/a);break;case"3.0.0":n.multiplyScalar(2),s.addScaledVector(r,5080/a);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let e=s.y,t=s.z;s.y=t,s.z=e,u(g,s,0,n,i),g.object3D.position.add(new THREE.Vector3(25.4*l/a/2,25.4*p/a/2,0)),g.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeVideo: loaded: no parent prs=",g.object3D.position,g.object3D.rotation,g.object3D.scale)}let c=g.object3D;c.originTransform={position:c.position.clone(),rotation:c.rotation.clone(),scale:c.scale.clone()},t.generalAttr&&t.generalAttr.logic&&(c.resetProperty=function(){d.pause()}),g.object3D.makarType="video",g.object3D.makarObject=!0,t.behav&&(g.object3D.behav=t.behav),t.behav_reference&&(g.object3D.behav_reference=t.behav_reference),o(g)}})),s.makarObjects.push(g);if(t.generalAttr.obj_parent_id){d.autoplay=!1;let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(g),window.clearInterval(e),r.addEventListener("child-attached",(function(e){if(console.log("three.js: arController: _loadVideo,: parent child-attached, el=",e),c&&3==c.v0&&c.v1>=5)if(t.generalAttr.logic)g.blockly=t.generalAttr.logic,d.pause(),d.currentTime=0;else{let e=!0;g.object3D.traverseAncestors((function(r){"Scene"!=r.type?0==r.visible&&(e=!1):1==e&&1==g.object3D.visible?(d.autoplay=!0,d.play(),C(t,d,false,c),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==r.location)&&E()):(console.log("three.js: arController: _loadVideo,: traverseAncestors: not all parent visible true=",g.object3D),d.muted=!1,d.autoplay=!1,d.pause(),d.currentTime=0)}))}})))}),1)}else c&&3==c.v0&&c.v1>=5&&(t.generalAttr.logic?(g.blockly=t.generalAttr.logic,d.pause(),d.currentTime=0,d.muted=!1):(d.autoplay=!0,d.play(),C(t,d,false,c),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&E())),e.appendChild(g)}}else console.log("ARFunc.js: _loadAframeVideo , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",h(e,t,r,a,n,i),o(1)}))}))}function C(e,t,r,o){o&&3==o.v0&&o.v1>=5&&((0==e.generalAttr.active||r)&&(t.autoplay=!1,t.pause(),t.currentTime=0),e.typeAttr&&(null!=e.typeAttr.is_play&&(t.autoplay=e.typeAttr.is_play,0==e.typeAttr.is_play&&(t.pause(),t.currentTime=0)),null!=e.typeAttr.is_play&&(t.loop=e.typeAttr.is_loop),null!=e.typeAttr.volune&&(t.volume=e.typeAttr.volune)))}function E(e){let t=document.getElementById("clickToPlayAudio");t.style.display="block",t.onclick=function(){T(),t.style.display="none",t.onclick=null,window.allowAudioClicked=!0}}function T(e){let t;e&&"a-video"==e.localName&&(t=e);let r=document.getElementsByTagName("a-video");if(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length),t)for(let e=0;e<r.length;e++){let o=r[e],a=r[e].mp4Video;if(o==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play();else{let r=!0;o.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,o.object3D.visible,o),1==r&&1==o.object3D.visible&&(a.muted=!0,a.autoplay=!0,a.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else{let e=!1;for(let t=0;t<r.length;t++){let o=r[t],a=r[t].mp4Video,n=!0;o.object3D.traverseAncestors((function(r){"Scene"!=r.type?0==r.visible&&(n=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",t,n,o.object3D.visible,o),1!=n||1!=o.object3D.visible||o.blockly||(0==e?(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",o.object3D),a.muted=!1,a.autoplay=!0,a.play(),e=!0):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",o.object3D),a.muted=!0,a.autoplay=!0,a.play())))}))}}}function k(e,t,r,o,a,n,i){let l=this;return new Promise((a=>{let n,s,c,d,u,p;if(4==Object.keys(l.editor_version).length){let e;if(Number(l.editor_version.v0),Number(l.editor_version.v1),Number(l.editor_version.v2),e=m(),!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void texture2DResolve(!1);n=e.rectP,s=e.rectSizeDelta,c=e.rectScale,d=e.rectR}else{let e=m();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void texture2DResolve(!1);n=e.rectP,s=e.rectSizeDelta,c=e.rectScale,d=e.rectR}function m(){let e,r,o,a,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(l.selectedResolutionIndex)||(console.log(" _getObj2DInfo350: error, missing _selectedResolutionIndex"),l.selectedResolutionIndex=0);let s=t.transformAttr.rect_transform[l.selectedResolutionIndex];if(s.position&&s.size_delta&&s.rotation&&s.scale){e=s.position.split(",").map((function(e){return Number(e)})),r=s.size_delta.split(",").map((function(e){return Number(e)})),o=s.scale.split(",").map((function(e){return Number(e)})),a=s.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])),l=(new THREE.Euler).setFromQuaternion(t,"YXZ"),c=new THREE.Vector3(l.x,l.y,l.z);c.z=-1*c.z,i.x=o[0],i.y=o[1],n={rectP:e,rectSizeDelta:r,rectScale:o,rectR:c}}}return n}u=document.createElement("video"),u.src=t.res_url,u.playsInline=!0,u.autoplay=!0,u.loop=!0,u.setAttribute("crossorigin","anonymous"),u.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id+"_"+l.loadSceneCount),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(u.muted=!0),p=new THREE.VideoTexture(u),p.colorSpace=THREE.SRGBColorSpace,p.flipY=!1,console.log("_loadVideo2D: mp4Texture",p),u.onloadedmetadata=function(){let c,m,h=l.scaleRatioXY;c=s[0]*h,m=s[1]*h;let g=new THREE.Object3D;g.makarType="video2D";let b,_,y,j,f,w=!1;if(t.typeAttr.matting&&(w=!0,b=t.typeAttr.matting.chromakey.split(","),_=t.typeAttr.matting.slope,y=t.typeAttr.matting.threshold,j=t.typeAttr.matting),w){let e,t=j.HSV.split(","),r=parseFloat(t[0]),o=parseFloat(t[1]),a=parseFloat(t[2]);"RGB"==j.mode?e=new THREE.ChromaKeyMaterial({map:p,keyColor:b,side:THREE.DoubleSide,slope:_,threshold:y}):"HSV"==j.mode&&(e=new THREE.HSVMattingMaterial({map:p,side:THREE.DoubleSide,_keyingColorH:r,_keyingColorS:o,_keyingColorV:a,_deltaH:j.hue,_deltaS:j.saturation,_deltaV:j.brightness})),f=new THREE.Mesh(new THREE.PlaneBufferGeometry(c,m,0),e)}else f=new THREE.Mesh(new THREE.PlaneBufferGeometry(c,m,0),new THREE.MeshBasicMaterial({map:p,side:THREE.DoubleSide,transparent:!0}));let D=!1;if(t.behav&&(g.behav=t.behav,l.setObjectBehavAll(t)),0==t.generalAttr.active&&(g.visible=!1),g.makarObject=!0,g.obj_id=t.generalAttr.obj_id,t.generalAttr.obj_parent_id){u.autoplay=!1;let e=function(){let s=!1;for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(s=!0);if(0==s)setTimeout(e,500);else for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(g.scale.set(i.x,i.y,1),g.translateX(n[0]*h),g.translateY(-n[1]*h),g.translateZ(r/o-1),g.rotateZ(d.z),g.add(f),l.makarObjects2D[e].add(g),l.makarObjects2D.push(g),g.traverseAncestors((function(e){0==e.visible&&(parentVisible=!1),1==parentVisible&&1==g.visible?(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: all parent visible true=",g,D),u.autoplay=!0,C(t,u,D),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==e.location)&&E()):(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: not all parent visible true=",parentVisible,videoPlane.object3D.visible,D),u.muted=!1,u.autoplay=!1,u.pause(),u.currentTime=0)})),a(g))};e()}else console.log("______VRFunc.js: _loadTexture2D: obj() ",t),g.scale.set(i.x,i.y,1),g.translateX(n[0]*h),g.translateY(-n[1]*h),g.translateZ(r/o-1),g.rotateZ(d.z),u.autoplay=!0,C(t,u,D),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&E(),l.makarObjects2D.push(g),e.add(g),g.add(f),g.makarObject=!0,g.obj_id=t.generalAttr.obj_id,a(g)}}))}function S(e,t,r,o,a,n){console.log("ARFunc.js: ARWrapper: _loadCurve, obj=",t,r,o,a);let i=this;return c(t),new Promise((function(o){let l=document.createElement("a-entity"),s=document.createElement("a-entity"),c=i.gcssTargets.dpi[e.GCSSID],d=i.gcssTargets.width[e.GCSSID],p=i.gcssTargets.height[e.GCSSID];if(l.setAttribute("id",t.generalAttr.obj_id+"_curve"),s.setAttribute("id",t.generalAttr.obj_id),s.setAttribute("crossorigin","anonymous"),i.makarObjects.push(l),i.makarObjects.push(s),l.appendChild(s),l.addEventListener("loaded",(function(e){for(let e=0;e<t.typeAttr.nodes.length-1;e++){let r,o,a,n,i=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e][1].split(",").map((e=>Number(e)))),s=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e][2].split(",").map((e=>Number(e)))),u=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e+1][0].split(",").map((e=>Number(e)))),m=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e+1][1].split(",").map((e=>Number(e))));i.multiplyScalar(5080/c),a=i.y,n=i.z,i.y=n,i.z=a,i.add(new THREE.Vector3(25.4*d/c/2,25.4*p/c/2,0)),s.multiplyScalar(5080/c),a=s.y,n=s.z,s.y=n,s.z=a,s.add(new THREE.Vector3(25.4*d/c/2,25.4*p/c/2,0)),u.multiplyScalar(5080/c),a=u.y,n=u.z,u.y=n,u.z=a,u.add(new THREE.Vector3(25.4*d/c/2,25.4*p/c/2,0)),m.multiplyScalar(5080/c),a=m.y,n=m.z,m.y=n,m.z=a,m.add(new THREE.Vector3(25.4*d/c/2,25.4*p/c/2,0)),r=new THREE.CubicBezierCurve3(i,s,u,m);let h=new THREE.Color(16777215);h.setHex(16777215*Math.random()),o=new THREE.LineBasicMaterial({color:h});let g=new THREE.TubeGeometry(r,20,1,2,!1),b=new THREE.MeshBasicMaterial({color:h,side:THREE.DoubleSide}),_=new THREE.Mesh(g,b);l.object3D.add(_)}if(t.typeAttr.is_cycle){let e,r;e=new THREE.CubicBezierCurve3((new THREE.Vector3).fromArray(t.typeAttr.nodes[t.typeAttr.nodes.length-1][1].split(",").map((e=>Number(e)))),(new THREE.Vector3).fromArray(t.typeAttr.nodes[t.typeAttr.nodes.length-1][2].split(",").map((e=>Number(e)))),(new THREE.Vector3).fromArray(t.typeAttr.nodes[0][0].split(",").map((e=>Number(e)))),(new THREE.Vector3).fromArray(t.typeAttr.nodes[0][1].split(",").map((e=>Number(e)))));let o=new THREE.Color(16777215);o.setHex(16777215*Math.random()),r=new THREE.LineBasicMaterial({color:o});let a=new THREE.TubeGeometry(e,20,10,2,!1),n=new THREE.MeshBasicMaterial({color:o,side:THREE.DoubleSide}),i=new THREE.Mesh(a,n);l.object3D.add(i)}o(l)})),s.addEventListener("loaded",(function(e){let o=new THREE.Object3D;if(s.object3D.add(o),e.target==e.currentTarget){s.object3D.children[0].scale.set(2540/c,2540/c,2540/c),s.object3D.children[0].rotation.y=Math.PI;let e=new THREE.Vector3;if(t.generalAttr.obj_parent_id){s.object3D.obj_parent_id=t.generalAttr.obj_parent_id,e.addScaledVector(r,2540/c);let o=e.z;e.z=-o,u(s,e,0,a,n)}else{switch(window.serverVersion){case"2.0.0":a.multiplyScalar(1),e.addScaledVector(r,2540/c);break;case"3.0.0":a.multiplyScalar(2),e.addScaledVector(r,5080/c);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let t=e.y,o=e.z;e.y=o,e.z=t,u(s,e,0,a,n),s.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*p/c/2,0)),s.object3D.rotation.x+=90*Math.PI/180,console.log("_loadCurveModule_: loaded: no parent prs=",s.object3D.position,s.object3D.rotation,s.object3D.scale)}}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(l),window.clearInterval(e))}),100)}else e.appendChild(l)}))}function R(e,t,r){let o=this,a=document.getElementById(t.bezier_id).parentNode.object3D,n=t.period,i=t.shift_position.split(",").map((e=>Number(e))),l=t.shift_rotation.split(",").map((e=>Number(e))),s=new THREE.Quaternion(l[0],l[1],l[2],l[3]),c=(new THREE.Euler).setFromQuaternion(s,"XYZ");s.setFromEuler(new THREE.Euler(c.x,c.y,c.z));let d=[],u=[],p=[],m=0;for(let e=0;e<a.children.length;e++)"Mesh"==a.children[e].type&&(p.push(a.children[e]),m+=a.children[e].geometry.parameters.path.getLength());let h,g,b=o.scenesData.scenes[r].objs,_=!1;for(let e=0;e<b.length;e++)b[e].generalAttr.obj_id==t.bezier_id&&(h=b[e]),b[e].generalAttr.obj_id==t.obj_id&&"camera"==b[e].res_id&&(_=!0);_&&(t.obj_id="camera_cursor"),g=document.getElementById(t.obj_id);for(let e=0;e<h.typeAttr.nodes.length;e++){let t=h.typeAttr.nodes[e][1].split(",").map((e=>Number(e))),r=h.typeAttr.nodes[e][3].split(",").map((e=>Number(e)));d.push(new THREE.Vector3(-r[0],r[1],r[2]).sub(new THREE.Vector3(-t[0],t[1],t[2])));let o=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),d[e].normalize());u.push(o)}h.typeAttr.is_cycle&&(d.push(d[0]),u.push(u[0]));let y=o.gcssTargets.dpi[e.GCSSID],j=(o.gcssTargets.width[e.GCSSID],o.gcssTargets.height[e.GCSSID],1e3*m/(2*n*100*25.4/y)),f=new THREE.Vector3,w=(new THREE.Vector3,new THREE.Vector3),D=new THREE.Vector3,v=new THREE.Vector3,A=new THREE.Matrix4,C=new THREE.Quaternion,E=function(e){let t,r=new Array(e),o=new Array(e),a=0,n=0,i=0,l=p[n].geometry.parameters.path.getLengths(p[n].geometry.parameters.path.getLength()/m*e);for(let s=0;s<e;s++){s>(i+p[n].geometry.parameters.path.getLength())/m*e&&(i+=p[n].geometry.parameters.path.getLength(),n+=1,l=p[n].geometry.parameters.path.getLengths(p[n].geometry.parameters.path.getLength()/m*e)),t=p[n].geometry,a=(s-i/m*e)/(p[n].geometry.parameters.path.getLength()/m*e),t.parameters.path.getPoint(a,D),f=t.parameters.path.getTangent(a);let c=u[n].clone();c.slerp(u[n+1],l[Math.floor(a*(p[n].geometry.parameters.path.getLength()/m*e))]/t.parameters.path.getLength()),w.set(0,1,0),w.applyAxisAngle(new THREE.Vector3(1,0,0),90*Math.PI/180),w.applyQuaternion(c),r[s]=D.clone(),v.copy(D).add(f),A.lookAt(D,v,w),C.setFromRotationMatrix(A),o[s]=C.clone()}return[r,o]}(3e3);console.log(" -- PR = ",E);let T,k,S=!1;if("Direct"==t.trigger_type)S=!0;else{let e=document.getElementById(t.trigger_id);e.setAttribute("class","clickable"),null==e.object3D.behav&&(e.object3D.behav=[]),e.object3D.behav.push({trigger_type:"Click",trigger_obj_id:t.trigger_id,behav_type:"MoveAlongPath",switch_type:"On",obj_id:t.obj_id,group:"",reset:!1})}let R=new THREE.Quaternion;g.parentNode.object3D.getWorldQuaternion(R);let x=new THREE.Quaternion;e.object3D.getWorldQuaternion(x);var M={ratio:0};let P=anime({targets:M,ratio:3e3,loop:t.loop,easing:"linear",round:1,duration:j,autoplay:S,begin:function(){T=g.object3D.position.clone(),k=g.object3D.quaternion.clone()},update:function(){let t=E[0][M.ratio-1].clone(),r=new THREE.Vector3(i[0],i[1],i[2]);if(g.object3D.obj_parent_id)t.applyMatrix4(e.object3D.matrix),g.parentNode.object3D.worldToLocal(t),r.multiplyScalar(2540/y),r.z=-r.z,t.add(r);else{let e,o;r.multiplyScalar(5080/y),e=r.y,o=r.z,r.y=o,r.z=e,t.add(r)}let o=E[1][M.ratio-1].clone();o.premultiply(x.clone()),o.premultiply(R.clone().inverse()),o.multiply(s),g.object3D.position.copy(t),g.object3D.quaternion.copy(o)},complete:function(){g.object3D.position.copy(T),g.object3D.quaternion.copy(k)}});g.object3D.bezier=P}function x(e,t,r,o,a,n,i){console.log("ARFunc.js: ARWrapper: _loadScratchCard obj=",t,a,n,i);let l=this;return c(t),new Promise((function(s){const c=t.generalAttr.obj_id,d=makarUserData.oneProjData.proj_id;e.module="ScratchCard",e.loadModule="scratchCard",e.project_module=t.typeAttr.module,e.project_module.obj_id=c,e.proj_id=d;let u,p=new THREE.Object3D;p.makarType="scratchCard",p.visible=!0,0==t.generalAttr.active&&(p.visible=!1),p.makarObject=!0,p.obj_id=c,p.scale.set(i.x,i.y,1),console.log(l.scaleRatioXY),p.translateX(a.x*l.scaleRatioXY),p.translateY(-a.y*l.scaleRatioXY),p.translateZ(r/o-1),p.rotateZ(n.z),l.makarObjects2D.push(p),u=t.typeAttr.module.backgroundID?"ScratchCard_Background"==t.typeAttr.module.backgroundID?"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png":makarUserData.userProjResDict[t.typeAttr.module.backgroundID].res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png";let m={res_id:"tempJson_BG_obj"};if(m.transformAttr={rect_transform:t.typeAttr.module.bRectTransform},m.generalAttr={obj_id:"tempJson_BG_obj_"+c,obj_type:"2d",obj_parent_id:c,active:!0,interactable:!0,logic:!1},m.typeAttr={},m.sub_type="jpg",m.res_url=u,l.loadTexture2D(e,m,r,o).then((a=>{let n=localStorage.getItem("MakarUserID");n="",window.aScratchCard.getScratchCardProjectFromMDB(makarUserData.oneProjData.proj_id).then((n=>{console.log("ARController _loadMakarARScene: getScratchCardProjectFromMDB return=",n);const i=window.aScratchCard.createScratchCard(e,t,d);if(n.proj_id){const l=t.generalAttr.obj_id;if(n.scratchCards&&n.scratchCards[l]){let e=n.scratchCards[l];i.update(e,a)}else i.init(a),window.aScratchCard.loadNewCard(e,t,i,r,o)}else i.init(a),window.aScratchCard.loadNewCard(e,t,i,r,o);let l;switch(console.log(i.scratchCardInfo),i.scratchCardInfo.scratchCardState){case 0:l=window.aScratchCard.getScratchRandomAwardandUpdate(i);break;case 1:l=i.scratchCardInfo.getAwardIndex,console.log("scratched, getAwardIndex = ",l);break;case 2:l=i.scratchCardInfo.getAwardIndex,console.log("getAward, getAwardIndex = ",l);break;case 3:l=i.scratchCardInfo.getAwardIndex,console.log("exchanged, getAwardIndex = ",l)}s(p)}))})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.add(p),window.clearInterval(e))}),100)}else e.add(p)}))}const M=class{getProjectIdx(){}addTextToScene(){}addTextureToScene(){}addGLTFModelToScene(){}addAudioToScene(){}addVideoToScene(){}pushObjectToMakarObjects(){}setTransform(){}appendToArScene(){}initTest(){console.log("AddObjectToArController.initTest: ",window.ArController)}};class P extends M{type="Quiz";obj_id;obj_type;isButtonPushed=!1;isPlaying=!0;isPlayed=!1;module={};currentProjData={};scene3DRoot;scene2DRoot;record=[];constructor(e){super(),this.obj_id=e.generalAttr.obj_id,this.obj_type=e.generalAttr.obj_type,window.arController&&(this.currentProjData.user_id=window.arController.currentProjData.user_id,this.currentProjData.proj_id=window.arController.currentProjData.proj_id,this.currentProjData.head_pic=window.arController.currentProjData.head_pic,this.currentProjData.loc=window.arController.currentProjData.loc,this.currentProjData.module_type=window.arController.currentProjData.module_type,this.currentProjData.name=window.arController.currentProjData.name,this.currentProjData.proj_cover_urls=window.arController.currentProjData.proj_cover_urls,this.currentProjData.proj_name=window.arController.currentProjData.proj_name,this.currentProjData.shared_id=window.arController.currentProjData.shared_id,this.currentProjData.snapshot_url=window.arController.currentProjData.snapshot_url),this.module=e.typeAttr.module}addTextToScene(e,t,r,o,a,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadText3D(this.scene3DRoot,e,t,r,o,a):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadText2D(this.scene2DRoot,e,n,i,t,r,o):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}addTextureToScene(e,t,r,o,a,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadTexture3D(this.scene3DRoot,e,t,r,o,a):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadTexture2D(this.scene2DRoot,e,n,i,t,r,o):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}addGLTFModelToScene(e,t,r,o,a){if("3d"==e.generalAttr.obj_type&&this.checkScene3DRoot())return window.arController.loadGLTFModel(this.scene3DRoot,e,t,r,o,a);console.log("%c quiz loadGLTFModel: quiz currently does not support GLTFModel in 2D scene.","color:tomato;")}addAudioToScene(e,t,r,o,a){if("3d"==e.generalAttr.obj_type&&this.checkScene3DRoot())return window.arController.loadAudio(this.scene3DRoot,e,t,r,o,a);console.log("%c quiz loadAudio: quiz currently does not support Audio in 2D scene.","color:tomato;")}addVideoToScene(e,t,r,o,a,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadVideo3D(this.scene3DRoot,e,t,r,o,a):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadVideo2D(this.scene2DRoot,e,n,i,t,r,o):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}pushToMakarObjects(e){window.arController.makarObjects&&Array.isArray(window.arController.makarObjects)?window.arController.makarObjects.push(e):console.warn("window.arController.makarObjects does not exist")}pushToMakarObjects2d(e){window.arController.makarObjects2D&&Array.isArray(window.arController.makarObjects2D)?window.arController.makarObjects2D.push(e):console.warn("window.arController.makarObjects does not exist")}setTransform(e,t,r,o){!function(e,t,r,o){console.log("VRFunc.js: setTransform: obj=",e,"\n position=",t,"\n rotation=",r,"\n scale=",o);let a=t.clone();a.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",a);let n=r.clone();n.multiply(new THREE.Vector3(1,-1,-1)),e.setAttribute("rotation",n),e.setAttribute("scale",o)}(e,t,r,o)}setARTransform(e,t,r,o,a){window.arController.setARTransform(e,t,r,o,a)}appendToArScene(e){this.checkScene3DRoot()&&this.scene3DRoot.appendChild(e)}appendToArScene2d(e){this.checkScene2DRoot()&&this.scene2DRoot.add(e.object3D)}checkScene3DRoot(){return!!this.scene3DRoot||(console.warn("scene3DRoot does not exist, or quiz is not loaded. scene3DRoot=",this.scene3DRoot),!1)}checkScene2DRoot(){return!!this.scene2DRoot||(console.warn("scene2DRoot does not exist, or quiz is not loaded. scene2DRoot=",this.scene2DRoot),!1)}clearObject(){if("3d"==this.obj_type){let e=[],t=this.module.quizEntity;for(let r of t.children)e.push(r);e.forEach((e=>{for(let t=0;t<window.arController.makarObjects.length;t++)if(window.arController.makarObjects[t].id==e.id){let e=window.arController.makarObjects[t];if(e.getAttribute("src")){let t=e.getAttribute("src").split("#")[1];document.getElementById(t)&&document.getElementById(t).remove()}e.remove(),window.arController.makarObjects.splice(t,1)}}))}else if("2d"==this.obj_type){let e=this.module.quizEntity.object3D.children[0].children;e.forEach((e=>{arController.makarObjects2D=arController.makarObjects2D.filter((t=>t!==e))})),e.length=0}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}setTypesFromUserRes(e){if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[e.res_id])makarUserData.userProjResDict[e.res_id].res_url&&(e.res_url=makarUserData.userProjResDict[e.res_id].res_url),makarUserData.userProjResDict[e.res_id].main_type&&(e.main_type=makarUserData.userProjResDict[e.res_id].main_type),makarUserData.userProjResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userProjResDict[e.res_id].sub_type);else if(makarUserData.userOnlineResDict[e.res_id])makarUserData.userOnlineResDict[e.res_id].res_url&&(e.res_url=makarUserData.userOnlineResDict[e.res_id].res_url),makarUserData.userOnlineResDict[e.res_id].main_type&&(e.main_type=makarUserData.userOnlineResDict[e.res_id].main_type),makarUserData.userOnlineResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userOnlineResDict[e.res_id].sub_type);else switch(d(e),e.res_id){case"Text":e.main_type=e.res_id.toLowerCase(),e.sub_type="txt";break;case"Button":e.main_type=e.res_id.toLowerCase(),e.main_type="button",e.sub_type="button";break;default:["Cube","Capsule","Sphere","ch_Bojue","ch_Fei","ch_Lina","ch_Poyuan","ch_Roger"].find((t=>t==e.res_id))&&(e.main_type="model")}else console.warn("Quiz.js: setTypesFromUserRes: userProjResDict or userOnlineResDict does not exist. obj=",e);return e}load(e,t,r,o){this.scene3DRoot=e,this.scene2DRoot=t;const a=o.position,n=o.rotation,i=o.scale,l=o.quaternion,c=o.panByScene3DRoot.dpi,d=o.panByScene3DRoot.GCSSWidth,u=o.panByScene3DRoot.GCSSHeight;let p=document.createElement("a-entity");p.setAttribute("id",r.generalAttr.obj_id),p.object3D.makarType="quiz";let m=new THREE.Vector3;switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),m.addScaledVector(a,2540/c);break;case"3.0.0":i.multiplyScalar(2),m.addScaledVector(a,5080/c);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let h=m.y,g=m.z;if(m.y=g,m.z=h,"3d"==r.generalAttr.obj_type)this.pushToMakarObjects(p),p.addEventListener("loaded",(function(){let e=new THREE.Object3D;e.makarType="quiz",e.makarObject=!0,p.object3D.add(e),p.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),p.object3D.rotation.x+=90*Math.PI/180}));else if("2d"==r.generalAttr.obj_type){let e=new THREE.Object3D;e.obj_id=r.generalAttr.obj_id,e.makarType="quiz2D",e.makarObject=!0,p.object3D.add(e),this.pushToMakarObjects2d(e)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let b=[];for(let e=0;e<r.typeAttr.module.question_list.length;e++)r.typeAttr.module.question_list[e].allowRandom&&b.push(e);if(!r.typeAttr.module.display_order_list)return void console.warn("Quiz.js _load: ERROR - user has not set display_order_list. obj.typeAttr.module=",r.typeAttr.module);let _=0;for(let e=0;e<r.typeAttr.module.display_order_list.length;e++){let t=r.typeAttr.module.display_order_list[e].index;if(-1==t){let o=(y=b.length,Math.floor(Math.random()*Math.floor(y))),a=b[o];r.typeAttr.module.display_order_list[e].index=a,t=a,b.splice(o,1)}r.typeAttr.module.question_list[t].active_score&&(_+=1)}var y;let j=r.typeAttr.module.display_order_list[0].index,f=r.typeAttr.module.question_list[j],w=document.getElementById("timerContent"),D=-1;if("Total"==r.typeAttr.module.timer_type){D=r.typeAttr.module.total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(D/3600),t=Math.floor((D-3600*e)/60),o=D-3600*e-60*t;w.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}else if("Custom"==r.typeAttr.module.timer_type){D=f.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(D/3600),t=Math.floor((D-3600*e)/60),r=D-3600*e-60*t;w.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}let v=document.getElementById("tipButtonDiv");f.show_tips?(v.style.display="block",v.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=f.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):v.style.display="none",this.module={json:r.typeAttr.module,quizEntity:p,currentIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:_,record:new Array(r.typeAttr.module.question_list.length),timer:{currentTimer:null,counter:D},record_time:0,qClock:Date.now()};let A=document.getElementById("scoreDiv");if(A.addEventListener("click",(()=>{A.style.display="none",this.nextQuestion()})),f.questions_json&&Array.isArray(f.questions_json))for(let e=0;e<f.questions_json.length;e++)this.loadQuestion(f.questions_json[e]);if(f.options_json){for(let e=0;e<f.options_json.length;e++){let{pOption:t,sub_type:r}=this.loadOption(f.options_json[e]);if("button"!=r&&("MutiOption_Text"==f.option_type||"MutiOption_Image"==f.option_type)){if(0==s(t))continue;t.then((e=>{let t=e,r=new THREE.Vector3(0,0,0),o=new THREE.Vector3(0,0,0),a=new THREE.Vector3(1,1,1);if(new THREE.Quaternion,"MutiOption_Text"==f.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(t,r,o,a);break;case"2d":this.multiOptionTextCircle2d(t,r,o,a);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==f.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),t.getAttribute("heightForQuiz")&&(t.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(t,r,o,a),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(t,r,o,a);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}if(this.module.timer.counter>=0){this.module.qClock=Date.now();let e=setInterval((()=>{this.module.timer.currentTimer=e,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let t=Math.floor(this.module.timer.counter/3600),o=Math.floor((this.module.timer.counter-3600*t)/60),a=this.module.timer.counter-3600*t-60*o;if(w.textContent=t.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0"),0==this.module.timer.counter)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==r.typeAttr.module.timer_type)if(f.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let r=document.getElementById("startQuiz"),o=document.getElementById("QuizStartButton"),a=document.getElementById("QuizStartContent");r.style.display="block",a.textContent="時間到";let n={question:j,get_score:0,answer_time:this.module.json.question_list[j].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[j]=n,this.record[j]=n,this.module.record_time+=this.module.json.question_list[j].time_limit,this.module.qClock=Date.now(),o.addEventListener("click",(()=>{r.style.display="none",this.saveQuizStatus()}))}}),1e3)}"3d"==r.generalAttr.obj_type?(this.setARTransform(p,m,n,i,l),this.appendToArScene(p)):(this.setTransform(p,a,n,i),this.appendToArScene2d(p))}else console.warn("_quiz _load: data might be incorrect, first_question.options_json=",f.options_json)}loadQuestion(e){let t,r,o;if("3d"==e.generalAttr.obj_type){t=(new THREE.Vector3).fromArray(e.transformAttr.transform[0].split(",").map((e=>Number(e))));let a=e.transformAttr.transform[1].split(",").map((e=>Number(e))),n=new THREE.Quaternion(a[0],a[1],a[2],a[3]),i=(new THREE.Euler).setFromQuaternion(n,"YXZ");r=new THREE.Vector3(i.x,-1*i.y,-1*i.z),o=(new THREE.Vector3).fromArray(e.transformAttr.transform[2].split(",").map((e=>Number(e))))}else if("2d"==e.generalAttr.obj_type){let t=window.arController.selectedResolutionIndex;window.arController.selectedResolutionIndex||(t=0),o=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[t].scale.split(",").map((e=>Number(e))))}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let a,n=this.setTypesFromUserRes(e);switch(n.main_type){case"text":a=this.addTextToScene(n,t,r,o,quaternion);break;case"image":a=this.addTextureToScene(n,t,r,o,quaternion,0,1);break;case"video":a=this.addVideoToScene(n,t,r,o,quaternion);break;case"model":a=this.addGLTFModelToScene(n,t,r,o,quaternion);break;case"audio":a=this.addAudioToScene(n,t,r,o,quaternion)}return a}loadOption(e){let t,r,o,a;if("3d"==e.generalAttr.obj_type){t=(new THREE.Vector3).fromArray(e.transformAttr.transform[0].split(",").map((e=>Number(e))));let n=e.transformAttr.transform[1].split(",").map((e=>Number(e)));a=new THREE.Quaternion(n[0],n[1],n[2],n[3]);let i=(new THREE.Euler).setFromQuaternion(a,"YXZ");r=new THREE.Vector3(i.x,-1*i.y,-1*i.z),o=(new THREE.Vector3).fromArray(e.transformAttr.transform[2].split(",").map((e=>Number(e))))}else if("2d"==e.generalAttr.obj_type){let t=window.arController.selectedResolutionIndex;window.arController.selectedResolutionIndex||(t=0),o=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[t].scale.split(",").map((e=>Number(e))))}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let n=e;if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[n.res_id])makarUserData.userProjResDict[n.res_id].res_url&&(n.res_url=makarUserData.userProjResDict[n.res_id].res_url),makarUserData.userProjResDict[n.res_id].sub_type&&(n.sub_type=makarUserData.userProjResDict[n.res_id].sub_type);else if(makarUserData.userOnlineResDict[n.res_id])makarUserData.userOnlineResDict[n.res_id].res_url&&(n.res_url=makarUserData.userOnlineResDict[n.res_id].res_url),makarUserData.userOnlineResDict[n.res_id].sub_type&&(n.sub_type=makarUserData.userOnlineResDict[n.res_id].sub_type);else switch(d(n),n.main_type="button",n.res_id){case"Text":n.main_type=n.res_id.toLowerCase(),n.sub_type="txt";break;case"Button":n.main_type=n.res_id.toLowerCase(),n.sub_type="button"}else console.warn("Quiz.js: loadOption: userProjResDict or userOnlineResDict does not exist. obj=",n);if(n.behav){let e=!1;n.behav.forEach((t=>{"QuizOption"==t.behav_type&&(e=!0)})),e||n.behav.push({behav_type:"QuizOption"})}else n.behav=[{behav_type:"QuizOption"}];n.main_type="button";let i,l=n.sub_type;switch(l){case"txt":i=this.addTextToScene(n,t,r,o,a);break;case"gif":case"jpg":case"jpeg":case"png":i=this.addTextureToScene(n,t,r,o,a);break;case"button":n.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",i=this.addTextureToScene(n,t,r,o,a)}return{pOption:i,sub_type:l}}multiOptionTextCircle3d(e,t,r,o,a=.7){let n=document.createElement("a-plane");n.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),n.setAttribute("id","circle_base"),n.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.appendChild(n);let i=document.createElement("a-plane");i.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),i.setAttribute("id","circle_out"),i.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.appendChild(i);let l=document.createElement("a-plane");l.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),l.setAttribute("id","circle_in"),l.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),l.setAttribute("visible",!1),e.appendChild(l);let s=2*Math.abs(e.getObject3D("mesh").geometry.attributes.position.array[0]);t.x=t.x+.5*s+.3/e.object3D.parent.el.getAttribute("scale").x,t.z=t.z-.01,n.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),i.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),l.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1)));let c=new THREE.Vector3(1,1,1).multiply(e.object3D.scale).multiply(e.object3D.parent.scale).multiply(e.object3D.parent.parent.scale),d=e.object3D.children[1].scale.clone().multiply(c),u=Math.max(d.x,d.y);o.multiply(new THREE.Vector3(a,a,a).multiplyScalar(u)),o.divide(e.object3D.parent.el.getAttribute("scale")),n.setAttribute("scale",o),i.setAttribute("scale",o),l.setAttribute("scale",o.multiplyScalar(.7));let p=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};n.addEventListener("loaded",p),i.addEventListener("loaded",p),l.addEventListener("loaded",p)}multiOptionTextCircle2d(e,t,r,o,a=.7){let n=e.children[0].children[1],i=n.scale.clone(),l=e.children[0].getWorldScale(new THREE.Vector3),s=Math.max(i.x*n.geometry.parameters.width,i.y*n.geometry.parameters.height);o.multiply(new THREE.Vector3(a,a,a).multiplyScalar(s)),o.divide(l);let c=n.geometry.parameters.width*i.x,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(r){t.x=.5*-c-64*o.x;let a=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(t.clone()),a.scale.copy(o.clone()),e.children[0].add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),e.children[0].add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(r){t.x=.5*-c-64*o.x;let a=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(t.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),e.children[0].add(a)}))}multiOptionImageCircle3d(e,t,r,o,a=50){let n=e.object3D.getWorldScale(new THREE.Vector3),i=e.object3D.scale.clone(),l=Math.max(i.x,i.y);o.multiply(new THREE.Vector3(a,a,a).multiplyScalar(l)),o.divide(n);let s=e.object3D.children[0].scale.clone();t.y=.5*-o.y-.6*s.y;let c=document.createElement("a-plane");c.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),c.setAttribute("id","circle_base"),c.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),this.setTransform(c,t,r,o),e.appendChild(c);let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),d.setAttribute("id","circle_out"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),this.setTransform(d,t,r,o),e.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id","circle_in"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),u.setAttribute("visible",!1),o.multiply(new THREE.Vector3(.7,.7,.7)),this.setTransform(u,t,r,o),e.appendChild(u);let p=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};c.addEventListener("loaded",p),d.addEventListener("loaded",p),u.addEventListener("loaded",p)}multiOptionImageCircle2d(e,t,r,o,a=.0025){let n=e.getWorldScale(new THREE.Vector3),i=e.scale.clone(),l=Math.max(i.x*e.children[0].geometry.parameters.width,i.y*e.children[0].geometry.parameters.height);o.multiply(new THREE.Vector3(a,a,a).multiplyScalar(l)),o.divide(n);let s=e.children[0].scale.clone(),c=e.children[0].geometry.parameters.height,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(r){t.y=s.y*c*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(t.clone()),a.scale.copy(o.clone()),e.add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),e.add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(r){t.y=s.y*c*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(r.image.width,r.image.height),new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(t.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),e.add(a)}))}quizOption(e){if(window.aQuizAR.checkIs2DPictureShowing())return;if(this.isButtonPushed)return;let t,r=[],o=!1,a=0,n=this.module.json.display_order_list[this.module.currentIndex].index,i=this.module.json.question_list[n],l=this.module.json.score_type,s=document.getElementById("makarDragon"),c=document.getElementById("imgRight"),d=document.getElementById("imgWrong");if("3d"==this.obj_type?t="a-text"==e.localName?e.parentNode.id:e.id:"2d"==this.obj_type?t=e.obj_id:console.log("%c _quiz _quizOption: target=","color:tomato;",e),"Option_Text"==i.option_type||"Option_Image"==i.option_type){this.isButtonPushed=!0,null==i.answer_list&&(i.answer_list=[]);let e=i.answer_list[0],u=i.options_json[e-1];for(let e=0,o=i.options_json.length;e<o;e++)i.options_json[e].generalAttr.obj_id==t&&r.push(e);if(u&&u.generalAttr.obj_id==t){if(i.active_score)if("Custom"==l)this.module.score+=i.score,a=i.score;else if("Total"==l){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),a=Math.round(e/this.module.totalActiveScoreQuestion)}o=!0,s.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else o=!1,s.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer),setTimeout((()=>{s.style.display="none";let e={question:n,get_score:a,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:r,answer_cloze:"",answer_is_enable:!0,answer_is:o};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),i.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,i)}else{if("MutiOption_Text"!=i.option_type&&"MutiOption_Image"!=i.option_type)return;{let u="3d"==this.obj_type?e.object3D:e;if(u.traverse((r=>{if("3d"==this.obj_type){if("Group"==r.type&&r.el&&"circle_in"==r.el.getAttribute("id")){let t,o=r.el;if(o.setAttribute("visible",!o.getAttribute("visible")),t="a-text"==e.localName?e.parentNode.id:e.id,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);console.log("Quiz.js: _pushButton: choices = ",this.module.choices)}else if("Group"==r.type&&r.el&&"circle_out"==r.el.getAttribute("id")){let e=r.el;"#7B7B7B"==e.getAttribute("material").color?e.setAttribute("material","color:#00d1c1;"):"#00d1c1"==e.getAttribute("material").color&&e.setAttribute("material","color:#7B7B7B;")}}else if("2d"!=this.obj_type||"text2D"!=e.makarType&&"image2D"!=e.makarType)console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");else if(r.isMesh){if("circle_in"==r.name)if(r.visible=!r.visible,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);"circle_out"==r.name&&("7b7b7b"==r.material.color.getHexString()?r.material.color.setStyle("#00d1c1"):"00d1c1"==r.material.color.getHexString()&&r.material.color.setStyle("#7b7b7b"))}})),"button"==u.sub_type){this.isButtonPushed=!0;let e=0;null==i.answer_list&&(i.answer_list=[]);for(let t of i.answer_list){let r=i.options_json[t];if(r)for(let t of this.module.choices)t==r.generalAttr.obj_id&&(e+=1)}for(let e=0,t=i.options_json.length;e<t;e++)for(let t=0,o=this.module.choices.length;t<o;t++)i.options_json[e].generalAttr.obj_id==this.module.choices[t]&&r.push(e-1);if(e==i.answer_list.length&&i.answer_list.length==this.module.choices.length){if(i.active_score)if("Custom"==l)this.module.score+=i.score,a=i.score;else if("Total"==l){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),a=Math.round(e/this.module.totalActiveScoreQuestion)}o=!0,s.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else o=!1,s.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer),setTimeout((()=>{s.style.display="none";let e={question:n,get_score:a,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:r,answer_cloze:"",answer_is_enable:!0,answer_is:o};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),i.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,i)}}}}nextQuestion(){if(this.isButtonPushed=!1,this.module.choices=[],window.clearInterval(this.module.timer.currentTimer),this.clearObject(),this.module.currentIndex+=1,this.module.currentIndex<this.module.json.display_order_list.length){let e=this.module.json.display_order_list[this.module.currentIndex].index,t=this.module.json.question_list[e];"Custom"==this.module.json.timer_type&&(this.module.timer.counter=t.time_limit);let r=document.getElementById("tipButtonDiv");if(t.show_tips?(r.style.display="block",r.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),r=document.getElementById("tipConfirmButton"),o=document.getElementById("tipContent");e.style.display="block",o.textContent=t.tips_content,r.addEventListener("click",(function(){e.style.display="none"}))}))):r.style.display="none",t.questions_json&&Array.isArray(t.questions_json))for(let e=0;e<t.questions_json.length;e++)this.loadQuestion(t.questions_json[e]);if(!t.options_json||!Array.isArray(t.options_json))return void console.warn("_quiz _load: data might be incorrect, first_question.options_json=",first_question.options_json);for(let e=0;e<t.options_json.length;e++){let{pOption:r,sub_type:o}=this.loadOption(t.options_json[e]);if("button"!=o&&("MutiOption_Text"==t.option_type||"MutiOption_Image"==t.option_type)){if(0==s(r))continue;r.then((e=>{let r=e,o=new THREE.Vector3(0,0,0),a=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1);if("MutiOption_Text"==t.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(r,o,a,n);break;case"2d":this.multiOptionTextCircle2d(r,o,a,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==t.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),r.getAttribute("heightForQuiz")&&(r.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(r,o,a,n),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(r,o,a,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}let o=document.getElementById("timerContent");if("Custom"==this.module.json.timer_type&&this.module.timer.counter>=0){let e=Math.floor(this.module.timer.counter/3600),t=Math.floor((this.module.timer.counter-3600*e)/60),r=this.module.timer.counter-3600*e-60*t;o.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}setTimeout((()=>{if(this.module.timer.counter>=0){this.module.qClock=Date.now(),window.clearInterval(this.module.timer.currentTimer);let r=setInterval((()=>{this.module.timer.currentTimer=r,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let a=Math.floor(this.module.timer.counter/3600),n=Math.floor((this.module.timer.counter-3600*a)/60),i=this.module.timer.counter-3600*a-60*n;if(o.textContent=a.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0"),this.module.timer.counter<=0)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==this.module.json.timer_type)if(t.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let t=document.getElementById("tipButtonDiv"),r=document.getElementById("tipDiv");t.style.display="none",r.style.display="none";let o=document.getElementById("startQuiz"),a=document.getElementById("QuizStartButton");document.getElementById("QuizStartContent").textContent="時間到",0==this.module.timer.counter&&(o.style.display="block");let n={question:e,get_score:0,answer_time:this.module.json.question_list[e].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[e]=n,this.record[e]=n,this.module.record_time+=this.module.json.question_list[e].time_limit,this.module.qClock=Date.now(),a.addEventListener("click",(()=>{o.style.display="none",this.saveQuizStatus()}))}}),1e3)}}),3e3)}else this.saveQuizStatus()}saveQuizStatus(){this.isPlayed=!0,window.clearInterval(this.module.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let r=document.getElementById("quizEndDiv");r.style.display="block",r.addEventListener("click",(function(){r.style.display="none"})),console.log("Quiz.js: quiz end , this.module.record = ",this.module.record);let o="",n="";localStorage.getItem("MakarUserID")&&(o=localStorage.getItem("MakarUserID")),localStorage.getItem("device_id")&&(n=localStorage.getItem("device_id"));let i={user_id:this.currentProjData.user_id,playing_user:o,proj_id:this.currentProjData.proj_id,proj_type:"ar",device_id:n,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[this.module.json],record_time:this.module.record_time,record_score:this.module.score,record:this.module.record},l={head_pic:this.currentProjData.head_pic,loc:this.currentProjData.loc,module_type:this.currentProjData.module_type,name:this.currentProjData.name,playing_user_id:o,proj_cover_urls:this.currentProjData.proj_cover_urls,proj_id:this.currentProjData.proj_id,proj_name:this.currentProjData.proj_name,proj_type:"ar",shared_id:this.currentProjData.shared_id,snapshot_url:this.currentProjData.snapshot_url,user_id:this.currentProjData.user_id,playedQuiz_list:[this.obj_id]};a.Z.updateRecordModule(l),console.log("Quiz.js: quiz end, ",this.currentProjData.proj_id,l),this.isPlaying=!1,console.log("Quiz.js: quiz end , quizARLogData = ",i)}}class I{quizData=[];loadedQuizzes=[];triggers=[];scene3DRoot;scene2DRoot;quizIdOpenDirectly=[];quizIdWithTriggers=[];currentlyTriggeredQuizId="";alreadyTriggeredQuizId="";constructor(){return I.exists?I.instance:(I.instance=this,I.exists=!0,this)}createQuiz(e){const t=e.generalAttr.obj_id;let r=this.getQuiz(t);if(r)return r;{const t=new P(e);return this.loadedQuizzes.push(t),t}}getQuiz(e){return this.loadedQuizzes.find((t=>t.obj_id===e))}getQuizProjectFromMDB=function(e){return parent.mdb.getQuizProject(e)};putQuizProjectToMDB=function(e){return parent.mdb.putQuizProject(e)};checkIs2DPictureShowing(){return this.loadedQuizzes.some((e=>e.isButtonPushed))}checkIsAnyQuizPlaying(){return console.log("checkIsAnyQuizPlaying",this.scene3DRoot),this.loadedQuizzes.some((e=>1==e.isPlaying&&e.scene3DRoot==this.scene3DRoot))}clear(){this.triggers=[],this.currentlyTriggeredQuizId="",this.alreadyTriggeredQuizId="",document.getElementById("QuizStartButton").removeEventListener("click",this.startQuizFunc)}saveQuizDataToMDB(e,t,r,o){let a={user_id:t,proj_id:r,device_id:o,obj_id:e,is_played:!0,type:"quiz",login_id:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"not logged in",date_time:(new Date).toString()};this.getQuizProjectFromMDB(r).then((t=>{if(0==Object.keys(t).length){let t={proj_id:r,quizzes:{}};t.quizzes[e]=a,this.putQuizProjectToMDB(t)}else{let r=t;t.quizzes||(r.quizzes={}),r.quizzes[e]=a,this.putQuizProjectToMDB(r)}})).catch((e=>{console.warn("Quiz.js _saveQuizDataToMDB: saveQuizDataToMDB but error:",e)}))}loadQuiz(e,t,r,o,n,i,l,s,c){this.scene3DRoot=e,this.scene2DRoot=t;let d=[];this.quizData.find((e=>e.generalAttr.obj_id==r.generalAttr.obj_id))||this.quizData.push(r);let u=l.startQuiz;if(0!=r.typeAttr.module.trigger.length){const e=r.typeAttr.module.trigger;this.triggers.find((t=>t==e))||this.triggers.push(e),this.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id))||this.quizIdWithTriggers.push({obj_id:r.generalAttr.obj_id,trigger_id:e,force_login:r.typeAttr.module.force_login,allow_retry:r.typeAttr.module.allow_retry})}let p=l.QuizStartButton,m=l.QuizStartContent,h=()=>{if(e==aQuizAR.scene3DRoot)if(this.startQuizFunc=h,0==r.typeAttr.module.trigger.length){let a=this.createQuiz(r);a.load(e,t,r,o),u.style.display="none",p.removeEventListener("click",h);const i=makarUserData.oneProjData.user_id,l=n,s=localStorage.getItem("device_id");this.saveQuizDataToMDB(a.obj_id,i,l,s)}else if(this.currentlyTriggeredQuizId&&this.currentlyTriggeredQuizId==r.generalAttr.obj_id)if(this.alreadyTriggeredQuizId==this.currentlyTriggeredQuizId);else{this.alreadyTriggeredQuizId=this.currentlyTriggeredQuizId;let a=this.createQuiz(r);a.load(e,t,r,o),u.style.display="none",p.removeEventListener("click",h);const i=makarUserData.oneProjData.user_id,l=n,s=localStorage.getItem("device_id");this.saveQuizDataToMDB(a.obj_id,i,l,s)}},g=function(){u.style.display="none"};window.serverUrl;const b=r.typeAttr.module.force_login,_=r.typeAttr.module.allow_retry,y=0==r.typeAttr.module.trigger.length;if(b&&_&&y&&i)m.textContent=s.clickToPlay[c],p.addEventListener("click",h),this.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!1});else if(b&&_&&!y&&i){m.textContent=s.clickToPlay[c],p.addEventListener("click",h);let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}else if(b&&!_&&y&&i){let e=f(i,n,y);d.push(e)}else if(b&&!_&&!y&&i){let e=f(i,n,y);d.push(e)}else if(b&&_&&y&&!i)j(y);else if(b&&_&&!y&&!i)j(y);else if(b&&!_&&y&&!i)j(y);else if(!b||_||y||i)if(!b&&_&&y)m.textContent=s.clickToPlay[c],p.addEventListener("click",h),this.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!0});else if(b||!_||y)if(b||_||!y){if(!b&&!_&&!y){let e=w(n,y);d.push(e.pQuizGetMdbRecord)}}else{let e=w(n,y);d.push(e)}else{m.textContent=s.clickToPlay[c],p.addEventListener("click",h);let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}else j(y);function j(t){if(m.textContent=s.userNotLoginInfo[c],p.addEventListener("click",g),t)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!1});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!1)}}function f(t,o,n){return a.Z.getRecordModule(t,o).then((a=>{if(console.log("arController.js: _getRecordModule: login_id=",t,"proj_id=",o,"\n  ret= ",a),0!=a.data.record_module_list.length)if(m.textContent=s.userAlreadyPlayed[c],p.addEventListener("click",g),console.log("record_module_list",a.data.record_module_list),n)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!1});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!1)}else if(m.textContent=s.clickToPlay[c],p.addEventListener("click",h),n)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}}))}function w(t,o){return parent.mdb.getProject(t,(t=>{if("done"==t.target.readyState&&t.target.result){if(t.target.result.quizzes){const a=r.generalAttr.obj_id;if(t.target.result.quizzes[a]){if(console.log("arController.js: indexedDB.js _getProject: already have the project with same proj_id and the quiz have been played.",t.target.result,t.target.result.getAwardIndex),m.textContent=s.userAlreadyPlayed[c],p.addEventListener("click",g),o)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!1});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!1)}return t}if(m.textContent=s.clickToPlay[c],p.addEventListener("click",h),o)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}if(m.textContent=s.clickToPlay[c],p.addEventListener("click",h),o)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}if(m.textContent=s.clickToPlay[c],p.addEventListener("click",h),o)window.aQuizAR.quizIdOpenDirectly.push({obj_id:r.generalAttr.obj_id,scene3DRoot:e,textContext:m.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==r.generalAttr.obj_id));t&&(t.textContext=m.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}))}return d}checkIfQuizOpenDirectly(e){if(e||(e=document.getElementById("startQuiz")),!this.checkIsAnyQuizPlaying())if(this.quizIdOpenDirectly.length>=1){const t=this.quizIdOpenDirectly.find((e=>e.scene3DRoot==this.scene3DRoot));if(!t)return;QuizStartContent.textContent=t.textContext;const r=this.getQuiz(t.obj_id);if(r)r.isPlayed?e.style.display="none":e.style.display="block";else if("此登入用戶已經遊玩過"==t.textContext&&0==t.allowPlay){e.style.display="block";let t=function(){e.style.display="none"};QuizStartButton.addEventListener("click",t)}else e.style.display="block"}else e.style.display="none"}checkIfQuizOpenByTrigger(e,t){if(e||(e=document.getElementById("startQuiz")),!this.checkIsAnyQuizPlaying())if(this.quizIdWithTriggers.length>=1){const r=this.quizIdWithTriggers.find((e=>e.obj_id==t));if(!r)return;QuizStartContent.textContent=r.textContext;const o=this.getQuiz(r.obj_id);if(o)o.isPlayed?e.style.display="none":e.style.display="block";else if("此登入用戶已經遊玩過"==r.textContext&&0==r.allowPlay){e.style.display="block";let t=function(){e.style.display="none"};QuizStartButton.addEventListener("click",t)}else e.style.display="block"}else e.style.display="none"}}window.aQuizAR=new I;class O{currentScene2DRoot=null;canExchange=!1;obj_id="";proj_id=window.makarUserData.oneProjData.proj_id;exchanged=-1;pointCardState=0;pointCardEntity=new THREE.Object3D;pointCardObjs=[];pointCardInfo={};constructor(e,t,r){this.obj_id=t.generalAttr.obj_id,this.scene_obj=t,this.proj_id=r,this.module=t.typeAttr.module,this.currentScene2DRoot=e}load(e,t,r){let o=window.arController.scaleRatioXY,a=window.arController.selectedResolutionIndex;a||(a=0);let n=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[a].position.split(",").map((e=>Number(e)))),i=(new THREE.Vector4).fromArray(e.transformAttr.rect_transform[a].rotation.split(",").map((e=>Number(e)))),l=(new THREE.Vector3).fromArray(e.transformAttr.rect_transform[a].scale.split(",").map((e=>Number(e)))),s=new THREE.Quaternion(i.x,i.y,i.z,i.w),c=(new THREE.Euler).setFromQuaternion(s,"YXZ"),d=new THREE.Vector3(c.x,c.y,c.z);d.z=-1*d.z;let u,p=this.pointCardEntity;p.translateX(n.x*o),p.translateY(-n.y*o),p.translateZ(t/r-1),p.rotateZ(d.z),p.scale.set(l.x,l.y,1),window.arController.makarObjects2D.push(p),this.currentScene2DRoot.add(p),e.behav&&(p.behav=e.behav,window.arController.setObjectBehavAll(e)),p.visible=!0,0==e.generalAttr.active&&(p.visible=!1),p.makarObject=!0,p.makarType="pointCard",p.obj_id=e.generalAttr.obj_id,u=e.typeAttr.module.backgroundID?"PointCard_Background"==e.typeAttr.module.backgroundID?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/PointCard_Background.png":makarUserData.userProjResDict[e.typeAttr.module.backgroundID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/PointCard_Background.png";let m={res_id:e.typeAttr.module.backgroundID,transformAttr:{rect_transform:e.typeAttr.module.rectTransform},generalAttr:{obj_id:e.typeAttr.module.backgroundID,obj_type:"2d",obj_parent_id:e.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},typeAttr:{placeholder:"placeholder"},sub_type:"jpg",res_url:u};return window.arController.loadTexture2D(this.currentScene2DRoot,m,t,r,null,null,{x:null,y:null})}init(e,t){this.pointCardObjs.push(t);let r=localStorage.getItem("device_id");r||(r=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",r)),this.pointCardInfo={user_id:window.makarUserData.oneProjData.user_id,proj_id:this.proj_id,device_id:r,card_id:this.scene_obj.typeAttr.module.moduleID,obj_id:this.obj_id,is_exchanged:!1,can_reward_point_count:this.scene_obj.typeAttr.module.canRewardPointCount,collected_points:[e],type:"point_card"},this.currentScene2DRoot.exchanged=-1,this.exchanged=-1}update(e,t=null){null!=t&&this.pointCardObjs.push(t),this.pointCardInfo=e,this.currentScene2DRoot.exchanged=e.is_exchanged?1:-1,this.exchanged=e.is_exchanged?1:-1,1==this.exchanged?this.pointCardState=2:e.collected_points.length>=e.can_reward_point_count&&(this.pointCardState=1)}}class z{mdb=null;loadedPointCards={};currentPointCardObjId="";constructor(){return parent.mdb?this.mdb=parent.mdb:console.warn("pointCard.js: parent.mdb does not exist, error"),z.exists?z.instance:(z.instance=this,z.exists=!0,this)}createPointCard(e,t,r=window.makarUserData.oneProjData.proj_id){this.currentPointCardObjId=t.generalAttr.obj_id;let o=this.getPointCard(this.currentPointCardObjId);return o||(o=new O(e,t,r)),this.loadedPointCards[this.currentPointCardObjId]=o,this.setupExchangeButtonDiv(),this.setupPasswordDiv(),o}getPointCard(e){return this.loadedPointCards[e]}getPointCardProjectFromMDB=function(e){return console.log("pointCard.js: _getPointCardProject"),parent.mdb.getPointCardProject(e)};_setPointCardProjectToMDB=function(e){return console.log("pointCard.js: _setPointCardProject"),parent.mdb.setPointCardProject(e)};setPointCardtoMDB(e){return new Promise(((t,r)=>{this.getPointCardProjectFromMDB(e.proj_id).then((r=>{let o={};0==Object.keys(r).length?o={proj_id:e.proj_id,pointCards:{}}:(o=r,r.pointCards||(o.pointCards={})),o.pointCards[e.obj_id]=e,t(parent.mdb.setPointCardProject(o))}))}))}getHtmlElement(e="tempElement",t="div"){let r=document.getElementById(e);return r||(r=document.createElement(t),r.setAttribute("id",e)),r}setupExchangeButtonDiv(){this.pointCardExchangeDiv=this.getHtmlElement("pointCardExchangeDiv"),this.pointCardExchangeDiv.setAttribute("class","moduleExchangeDiv"),this.pointCardExchangeDiv.style.display="inline",this.pointCardExchangeDiv.style.width="100%",this.pointCardExchangeDiv.style.left="0%",this.pointCardExchangeDiv.style.bottom="60px",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.pointCardExchangeDiv.innerText="loading",this.pointCardExchangeDiv.onclick=e=>{this.getPointCard(this.currentPointCardObjId).canExchange&&(this.pointCardPWDBG.style.display="inline")},document.body.appendChild(this.pointCardExchangeDiv)}setupPasswordDiv(){this.pointCardPWDBG=this.getHtmlElement("pointCardPWDBG"),this.pointCardPWDBG.setAttribute("class","backgroundModal"),document.body.appendChild(this.pointCardPWDBG),this.pointCardPWDiv=this.getHtmlElement("pointCardPWDiv"),this.pointCardPWDiv.setAttribute("class","modulePWDDiv"),this.pointCardPWDiv.style.display="block",this.pointCardPWDBG.appendChild(this.pointCardPWDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.pointCardPWDiv.style.left=(innerWidth-e)/2+"px",this.pointCardPWDiv.style.top=(innerHeight-t)/2+"px",this.pointCardPWDiv.style.width=e+"px",this.pointCardPWDiv.style.height=t+"px",this.pointCardPWDiv.innerHTML="<br> 輸入密碼 <br>";let r=this.getHtmlElement("pointCardPWDInputText","input");r.setAttribute("class","modulePWDInputText"),r.setAttribute("type","text"),r.setAttribute("placeholder","pwd"),this.pointCardPWDiv.appendChild(r);let o=this.getHtmlElement("pointCardPWDRetText");o.setAttribute("class","modulePWDRetText"),this.pointCardPWDiv.appendChild(o),o.innerText="";let a=this.getHtmlElement("pointCardPWDCancel");a.setAttribute("class","bottomLeftCell"),a.innerText="取消",this.pointCardPWDiv.appendChild(a),a.onclick=function(){console.log("pointCard.js: cancel button click "),pointCardPWDBG.style.display="none",r.value="",o.innerText=""};let n=this.getHtmlElement("pointCardPWDConfirm");n.setAttribute("class","bottomRightCell"),n.innerText="確認",this.pointCardPWDiv.appendChild(n),n.onclick=e=>{let t=this.getPointCard(this.currentPointCardObjId);console.log("pointCard.js: _passwordConfirm pointCard = ",t);let a=t.module.rewardPassword;r.value==a?(console.log("pointCard.js: confirm button click password correct ",r.value,t.module.rewardPassword),o.innerText="密碼正確",this.pointCardExchangeDiv.innerText="已兌換",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",t.currentScene2DRoot.exchanged=1,t.exchanged=1,t.canExchange=!1,t.pointCardState=2,parent.mdb.getPointCardProject(t.proj_id).then((e=>{console.log("pointCard.js: _passwordConfirm getProjRet = ",e);let r=e.pointCards[t.obj_id];console.log("pointCard.js: _passwordConfirm pointCardData = ",r),r.is_exchanged=!0,parent.mdb.setPointCardProject(e).then((e=>{let t={user_id:r.user_id,playing_user:"",proj_id:r.proj_id,proj_type:"ar",card_id:r.card_id,obj_id:r.obj_id,device_id:r.device_id,can_reward_point_count:r.can_reward_point_count,is_exchanged:!0,brand:"",os:window.Browser.name+window.Browser.version,location_long:0,location_lan:0};console.log("%c \n v3.5後端API都回我500 UNDEFINED_VALUE\n pointCard.js: _passwordConfirm: collect target upload=","color:tomato",t),window.pointCardLog(window.serverUrl,t)}))})),setTimeout((()=>{window.aPointCard.pointCardPWDBG.style.display="none"}),2e3)):(console.log("pointCard.js: confirm button click password wrong ",r.value),o.innerText="密碼錯誤")}}showPointCardCanvas(e,t,r,o){this.currentPointCardObjId=o;let a=this.getPointCard(this.currentPointCardObjId);a.currentScene2DRoot=e,this.pointCardExchangeDiv.style.display="inline",r?(this.pointCardExchangeDiv.innerText="已兌換",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",a.canExchange=!1):t>=0?(a.canExchange=!0,a.pointCardState=1,this.pointCardExchangeDiv.innerText="按此兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)"):(a.canExchange=!1,this.pointCardExchangeDiv.innerText="還差 "+-t+" 點就可兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )")}hidePointCardCanvas(e){console.log("PointCard.js: aPointCard.hidePointCardCanvas: obj_2D = ",e),(e.loadModule="pointCard")&&(this.pointCardExchangeDiv.style.display="none",this.pointCardPWDBG.style.display="none",pointCardPWDInputText.value="",pointCardPWDRetText.innerText="")}loadNewCard(e,t,r,o,a,n){let l=localStorage.getItem("device_id");l||(l=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",l)),window.aPointCard.setPointCardtoMDB(r.pointCardInfo).then((i=>{for(let i=0;i<t.typeAttr.module.points.length;i++){let s=t.typeAttr.module.points[i],c=window.arController.selectedResolutionIndex;c||(c=0);let d=(new THREE.Vector3).fromArray(s.rectTransform[c].position.split(",").map((e=>Number(e)))),u=(new THREE.Vector4).fromArray(s.rectTransform[c].rotation.split(",").map((e=>Number(e)))),p=(new THREE.Vector3).fromArray(s.rectTransform[c].scale.split(",").map((e=>Number(e))));s.res_id="tempJson_pointObj",s.transformAttr={rect_transform:s.rectTransform},s.generalAttr={obj_id:"tempJson_pointObj_no"+i,obj_type:"2d",obj_parent_id:t.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},s.typeAttr={placeholder:"placeholder"},s.sub_type="jpg";const m=(i+1)/(t.typeAttr.module.points.length+1);if(o.targetID==s.targetID){let c;c=window.makarUserData.userProjResDict[s.collectedPointID]?window.makarUserData.userProjResDict[s.collectedPointID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png",s.res_url=c,window.arController.loadTexture2D(e,s,a+m,n,d,u,p).then((e=>{r.pointCardObjs.push(e);let t={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,t)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),t.typeAttr.module.points[i].collected=!0;let h={user_id:window.makarUserData.oneProjData.user_id,playing_user:"",proj_id:window.makarUserData.oneProjData.proj_id,proj_type:"ar",card_id:t.typeAttr.module.moduleID,device_id:l,can_reward_point_count:t.typeAttr.module.canRewardPointCount,target_id:o.targetID,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==o.targetID)).image_url,brand:window.Browser.name+window.Browser.version,os:window.Browser.platform,location_long:0,location_lan:0};console.log("%c \n v3.5後端API都回我500 UNDEFINED_VALUE\n pointCardLogData=","color:tomato",h,"\n"),window.pointCardLog(window.serverUrl,h)}else{let t;t=window.makarUserData.userProjResDict[s.uncollectedPointID]?window.makarUserData.userProjResDict[s.uncollectedPointID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png",s.res_url=t,window.arController.loadTexture2D(e,s,a+m,n,d,u,p).then((e=>{r.pointCardObjs.push(e)})),s.collected=!1}}const s=r.pointCardInfo.collected_points.length-t.typeAttr.module.canRewardPointCount;this.showPointCardCanvas(e,s,r.pointCardInfo.is_exchanged,r.pointCardInfo.obj_id)}))}addPoint(e,t,r){return new Promise(((o,a)=>{let n=e.pointCards[t];console.log("pointCard.js: _addPoint:  getProjRet: ",n,r);let i=n.collected_points.find((e=>e==r));i?(console.log("pointCard.js _addPoint: point exists, do nothing. \n",i,e),o(e)):(console.log("pointCard.js: _addPoint: the pointCard is already there, but the target is not: ",i,e),n.collected_points.push(r),this._setPointCardProjectToMDB(e).then((t=>{this.getPointCardProjectFromMDB(e.proj_id).then((e=>{o(e)}))})))}))}loadCardWithAddedPoint(e,t,r,o,a,n,l,s){const c=r.generalAttr.obj_id;this.currentPointCardObjId=c;let d=l.pointCards[c],u=localStorage.getItem("device_id");u||(u=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",u));for(let i=0;i<r.typeAttr.module.points.length;i++){let l=r.typeAttr.module.points[i],c=window.arController.selectedResolutionIndex;c||(c=0);let p=(new THREE.Vector3).fromArray(l.rectTransform[c].position.split(",").map((e=>Number(e)))),m=(new THREE.Vector4).fromArray(l.rectTransform[c].rotation.split(",").map((e=>Number(e)))),h=(new THREE.Vector3).fromArray(l.rectTransform[c].scale.split(",").map((e=>Number(e))));l.res_id="tempJson_pointObj",l.transformAttr={rect_transform:l.rectTransform},l.generalAttr={obj_id:"tempJson_pointObj_no"+i,obj_type:"2d",obj_parent_id:r.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},l.typeAttr={placeholder_pointObj:"placeholder_pointObj"},l.sub_type="jpg";const g=(i+1)/(r.typeAttr.module.points.length+1);if(d.collected_points.find((e=>e==l.targetID))){let i;if(i=window.makarUserData.userProjResDict[l.collectedPointID]?window.makarUserData.userProjResDict[l.collectedPointID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png",l.res_url=i,window.arController.loadTexture2D(e,l,a+g,n,p,m,h).then((e=>{t.pointCardObjs.push(e);let r={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,r)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),s&&o.targetID==l.targetID){let e={user_id:window.makarUserData.oneProjData.user_id,playing_user:"",proj_id:window.makarUserData.oneProjData.proj_id,proj_type:"ar",card_id:r.typeAttr.module.moduleID,device_id:u,can_reward_point_count:r.typeAttr.module.canRewardPointCount,target_id:o.targetID,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==o.targetID)).image_url,brand:window.Browser.name+window.Browser.version,os:window.Browser.platform,location_long:0,location_lan:0};console.log("%c \n v3.5後端API都回我500 UNDEFINED_VALUE\n pointCardLogData=","color:tomato",e,"\n"),window.pointCardLog(window.serverUrl,e)}}else{let r;r=window.makarUserData.userProjResDict[l.uncollectedPointID]?window.makarUserData.userProjResDict[l.uncollectedPointID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png",l.res_url=r,window.arController.loadTexture2D(e,l,a+g,n,p,m,h).then((e=>{t.pointCardObjs.push(e)})),l.collected=!1}}const p=d.collected_points.length-r.typeAttr.module.canRewardPointCount;this.showPointCardCanvas(e,p,d.is_exchanged,c)}checkPointThenAdd(e,t,r,o,a){let n=localStorage.getItem("device_id");n||(n=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",n));const l=window.makarUserData.oneProjData.proj_id;this.getPointCardProjectFromMDB(l).then((i=>{if(console.log("PointCard.js: _checkPointThenAdd: getProjRet=",i),0==Object.keys(i).length)return;const s=e.project_module.obj_id;let c=i.pointCards[s];const d=this.getPointCard(s);if(!d)return;let u;if(this.currentPointCardObjId=s,c.collected_points)if(u=c.collected_points.find((e=>e==t)),u){console.log("PointCard.js: _checkPointThenAdd: already collected.");let t=c.collected_points.length-d.module.canRewardPointCount;this.showPointCardCanvas(e,t,c.is_exchanged,s)}else console.log("PointCard.js: _checkPointThenAdd: not collected "),this.addPoint(i,s,t).then((i=>{console.log("PointCard.js: _checkPointThenAdd: setProjRet",i);let c=i.pointCards[s];if(d.update(c),console.log("pointCard updated",d),c.collected_points){for(let i=0;i<d.module.points.length;i++){let c=d.module.points[i];if(c.targetID==t){let u=window.arController.selectedResolutionIndex;u||(u=0);let p,m=(new THREE.Vector3).fromArray(c.rectTransform[u].position.split(",").map((e=>Number(e)))),h=(new THREE.Vector4).fromArray(c.rectTransform[u].rotation.split(",").map((e=>Number(e)))),g=(new THREE.Vector3).fromArray(c.rectTransform[u].scale.split(",").map((e=>Number(e))));c.res_id="tempJson_pointObj",c.transformAttr={rect_transform:c.rectTransform},c.generalAttr={obj_id:"tempJson_pointObj_no"+i,obj_type:"2d",obj_parent_id:s,active:!0,interactable:!0,logic:!1},c.typeAttr={placeholder:"placeholder"},c.sub_type="jpg",p=window.makarUserData.userProjResDict[c.collectedPointID]?window.makarUserData.userProjResDict[c.collectedPointID].res_url:"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png",c.res_url=p;const b=(i+1)/(d.module.points.length+1);window.arController.loadTexture2D(e,c,r+b,o,m,h,g).then((e=>{d.pointCardObjs.push(e),this.loadedPointCards[this.currentPointCardObjId].pointCardObjs.find((e=>e.obj_id==c.generalAttr.obj_id)).visible=!1;let t={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,t)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),c.collected=!0;let _={user_id:window.makarUserData.oneProjData.user_id,playing_user:a,proj_id:l,proj_type:"ar",card_id:d.module.moduleID,device_id:n,can_reward_point_count:d.module.canRewardPointCount,target_id:t,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==t)).image_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};console.log("%c \n v3.5後端API都回我500 UNDEFINED_VALUE \n pointCardLogData=","color:tomato;",_,"\n"),window.pointCardLog(window.serverUrl,_)}}let i=c.collected_points.length-d.module.canRewardPointCount;this.showPointCardCanvas(e,i,c.is_exchanged,s)}else console.error("PointCard.js: _checkPointThenAdd: collected_points not exist, shouldnt happen ",d.module.points)}))}))}}window.aPointCard=new z;class H{currentScene2DRoot=null;canExchange=!1;obj_id="";proj_id=window.makarUserData.oneProjData.proj_id;exchanged=-1;scratchCardState=0;scratchCardObjs=[];scratchCardInfo={};constructor(e,t,r){this.obj_id=t.generalAttr.obj_id,this.scene_obj=t,this.proj_id=r,this.module=t.typeAttr.module,this.currentScene2DRoot=e}init(e){this.scratchCardObjs.push(e);let t=localStorage.getItem("device_id");t||(t=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",t)),this.scratchCardInfo={user_id:window.makarUserData.oneProjData.user_id,proj_id:this.proj_id,device_id:t,card_id:this.scene_obj.typeAttr.module.moduleID,obj_id:this.obj_id,is_exchanged:!1,scratchCardState:this.scratchCardState,type:"scratch_card"},this.currentScene2DRoot.exchanged=-1,this.exchanged=-1}update(e,t=null){null!=t&&this.scratchCardObjs.push(t),this.scratchCardInfo=e,this.currentScene2DRoot.exchanged=e.is_exchanged?1:-1,this.exchanged=e.is_exchanged?1:-1}}class B{mdb=null;loadedScratchCards={};currentScratchCardObjId="";constructor(){return parent.mdb?this.mdb=parent.mdb:console.warn("scratchCard.js: parent.mdb does not exist, error"),B.exists?B.instance:(B.instance=this,B.exists=!0,this)}createScratchCard(e,t,r=window.makarUserData.oneProjData.proj_id){this.currentScratchCardObjId=t.generalAttr.obj_id;let o=this.getScratchCard(this.currentScratchCardObjId);return o||(o=new H(e,t,r)),this.loadedScratchCards[this.currentScratchCardObjId]=o,o}getScratchCard(e){return this.loadedScratchCards[e]}getScratchCardProjectFromMDB=function(e){return console.log("scratchCard.js: _getScratchCardProject"),parent.mdb.getScratchProject(e)};_setScratchCardProjectToMDB=function(e){return console.log("scratchCard.js: _setScratchCardProject"),parent.mdb.setScratchProject(e)};setScratchCardtoMDB(e){return new Promise(((t,r)=>{this.getScratchCardProjectFromMDB(e.proj_id).then((r=>{if(0==Object.keys(r).length){let r={proj_id:e.proj_id,scratchCards:{}};r.scratchCards[e.obj_id]=e,t(parent.mdb.setScratchProject(r))}else{let o=r;o.scratchCards[e.obj_id]=e,t(parent.mdb.setScratchProject(o))}}))}))}restProjInfoMDB(e){let t={proj_id:e,scratchCards:{}};return new Promise(((e,r)=>{e(parent.mdb.setScratchProject(t))}))}getScratchRandomAwardandUpdate(e){console.log(e);let t=null;if(Array.isArray(e.module.cards)&&1==e.module.cards.length&&(t=e.module.cards[0].awards),!t)return-1;let r=0,o=[];for(let e in t)r+=t[e].probability,o.push(r);let a=Math.floor(100*Math.random())+1,n=-1;console.log("scratchCard.js: _chooseAward: awardArray=",o,", getNum=",a);for(let e=0;e<o.length;e++)if(a<=o[e]){n=e;break}return e.scratchCardInfo.getAwardIndex=n,e.scratchCardInfo.scratchCardState=1,e.scratchCardInfo.scratch_image_url=makarUserData.userProjResDict[e.module.cards[0].scratchID].res_url,-1!=n&&(e.scratchCardInfo.awards_image_url=makarUserData.userProjResDict[e.module.cards[0].awards[n].awardID].res_url),console.log("20240227",e.scratchCardInfo),this.setScratchCardtoMDB(e.scratchCardInfo),n}getHtmlElement(e="tempElement",t="div"){let r=document.getElementById(e);return r||(r=document.createElement(t),r.setAttribute("id",e)),r}setupExchangeButtonDiv(){this.scratchCardExchangeDiv=this.getHtmlElement("scratchCardExchangeDiv"),this.scratchCardExchangeDiv.setAttribute("class","moduleExchangeDiv"),this.scratchCardExchangeDiv.style.display="inline",this.scratchCardExchangeDiv.style.width="100%",this.scratchCardExchangeDiv.style.left="0%",this.scratchCardExchangeDiv.style.bottom="60px",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.scratchCardExchangeDiv.innerText="loading",this.scratchCardExchangeDiv.onclick=e=>{this.getScratchCard(this.currentScratchCardObjId).canExchange&&(this.scratchCardPWDBG.style.display="inline")},document.body.appendChild(this.scratchCardExchangeDiv)}setupPasswordDiv(){this.scratchCardPWDBG=this.getHtmlElement("scratchCardPWDBG"),this.scratchCardPWDBG.setAttribute("class","backgroundModal"),document.body.appendChild(this.scratchCardPWDBG),this.scratchCardPWDiv=this.getHtmlElement("scratchCardPWDiv"),this.scratchCardPWDiv.setAttribute("class","modulePWDDiv"),this.scratchCardPWDiv.style.display="block",this.scratchCardPWDBG.appendChild(this.scratchCardPWDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.scratchCardPWDiv.style.left=(innerWidth-e)/2+"px",this.scratchCardPWDiv.style.top=(innerHeight-t)/2+"px",this.scratchCardPWDiv.style.width=e+"px",this.scratchCardPWDiv.style.height=t+"px",this.scratchCardPWDiv.innerHTML="<br> 輸入密碼 <br>";let r=this.getHtmlElement("scratchCardPWDInputText","input");r.setAttribute("class","modulePWDInputText"),r.setAttribute("type","text"),r.setAttribute("placeholder","pwd"),this.scratchCardPWDiv.appendChild(r);let o=this.getHtmlElement("scratchCardPWDRetText");o.setAttribute("class","modulePWDRetText"),this.scratchCardPWDiv.appendChild(o),o.innerText="";let a=this.getHtmlElement("scratchCardPWDCancel");a.setAttribute("class","bottomLeftCell"),a.innerText="取消",this.scratchCardPWDiv.appendChild(a),a.onclick=function(){console.log("scratchCard.js: cancel button click "),scratchCardPWDBG.style.display="none",r.value="",o.innerText=""};let n=this.getHtmlElement("scratchCardPWDConfirm");n.setAttribute("class","bottomRightCell"),n.innerText="確認",this.scratchCardPWDiv.appendChild(n),n.onclick=e=>{let t=this.getScratchCard(this.currentScratchCardObjId);console.log("scratchCard.js: _passwordConfirm scratchCard = ",t);let a=t.module.rewardPassword;r.value==a?(console.log("scratchCard.js: confirm button click password correct ",r.value,t.module.rewardPassword),o.innerText="密碼正確",this.scratchCardExchangeDiv.innerText="已兌換",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",t.currentScene2DRoot.exchanged=1,t.exchanged=1,t.canExchange=!1,t.scratchCardState=2,parent.mdb.getScratchCardProject(t.proj_id).then((e=>{console.log("scratchCard.js: _passwordConfirm getProjRet = ",e);let r=e.scratchCards[t.obj_id];console.log("scratchCard.js: _passwordConfirm scratchCardData = ",r),r.is_exchanged=!0,parent.mdb.setScratchCardProject(e).then((e=>{let t={user_id:r.user_id,playing_user:"",proj_id:r.proj_id,proj_type:"ar",card_id:r.card_id,obj_id:r.obj_id,device_id:r.device_id,can_reward_scratch_count:r.can_reward_scratch_count,is_exchanged:!0,brand:"",os:window.Browser.name+window.Browser.version,location_long:0,location_lan:0};console.log("%c \n v3.5後端API都回我500 UNDEFINED_VALUE\n scratchCard.js: _passwordConfirm: collect target upload=","color:tomato",t),window.scratchCardLog(window.serverUrl,t)}))})),setTimeout((()=>{window.aScratchCard.scratchCardPWDBG.style.display="none"}),2e3)):(console.log("scratchCard.js: confirm button click password wrong ",r.value),o.innerText="密碼錯誤")}}showScratchCardCanvas(e,t,r,o){this.currentScratchCardObjId=o;let a=this.getScratchCard(this.currentScratchCardObjId);a.currentScene2DRoot=e,this.scratchCardExchangeDiv.style.display="inline",r?(this.scratchCardExchangeDiv.innerText="已兌換",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",a.canExchange=!1):t>=0?(a.canExchange=!0,a.scratchCardState=1,this.scratchCardExchangeDiv.innerText="按此兌換獎項",this.scratchCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)"):(a.canExchange=!1,this.scratchCardExchangeDiv.innerText="還差 "+-t+" 點就可兌換獎項",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )")}hideScratchCardCanvas(e){console.log("ScratchCard.js: aScratchCard.hideScratchCardCanvas: obj_2D = ",e),(e.loadModule="scratchCard")&&(this.scratchCardExchangeDiv.style.display="none",this.scratchCardPWDBG.style.display="none",scratchCardPWDInputText.value="",scratchCardPWDRetText.innerText="")}loadNewCard(e,t,r,o,a){let n=localStorage.getItem("device_id");n||(n=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",n)),window.aScratchCard.setScratchCardtoMDB(r.scratchCardInfo).then((e=>{}))}addScratch(e,t,r){return new Promise(((o,a)=>{let n=e.scratchCards[t];console.log("scratchCard.js: _addScratch:  getProjRet: ",n,r);let i=n.collected_scratchs.find((e=>e==r));i?(console.log("scratchCard.js _addScratch: scratch exists, do nothing. \n",i,e),o(e)):(console.log("scratchCard.js: _addScratch: the scratchCard is already there, but the target is not: ",i,e),n.collected_scratchs.push(r),this._setScratchCardProjectToMDB(e).then((t=>{this.getScratchCardProjectFromMDB(e.proj_id).then((e=>{o(e)}))})))}))}}window.aScratchCard=new B;const V=class{constructor(e){this.type="ARWrapper",e.oneProjData&&(this.currentProjData=e.oneProjData),e.scenesData&&(this.scenesData=e.scenesData),e.targetList&&(this.targetList=e.targetList),e.userOnlineResDict&&(this.userOnlineResDict=e.userOnlineResDict),e.userProjResDict&&(this.userProjResDict=e.userProjResDict),e.userMaterialDict&&(this.userMaterialDict=e.userMaterialDict);let t=this;window.ARController&&window.THREE&&(ARController.getUserMediaThreeScene=function(e){let t={};for(let r in e)t[r]=e[r];let r=e.onSuccess;return t.onSuccess=function(e,t){let o=e.createThreeScene();r(o,e,t)},this.getUserMediaARController(t)},ARController.prototype.createThreeScene=function(e){e=e||this.image,this.setupThree();var t=new THREE.VideoTexture(e);t.minFilter=THREE.LinearFilter,t.flipY=!1,this.cameraTexture=t;var r=new THREE.Mesh(new THREE.PlaneGeometry(t.image.videoWidth,t.image.videoHeight),new THREE.MeshBasicMaterial({map:t,side:THREE.BackSide}));r.material.depthTest=!1,r.material.depthWrite=!1,r.position.set(0,0,-1);var o=new THREE.OrthographicCamera(-t.image.videoWidth/2,t.image.videoWidth/2,-t.image.videoHeight/2,t.image.videoHeight/2,-100,2e4);let a,n,i=document.getElementById("arfScene"),l=t.image.videoWidth,s=t.image.videoHeight;window.innerWidth/window.innerHeight>l/s?(a=window.innerWidth,n=window.innerWidth/l*s):(a=window.innerHeight/s*l,n=window.innerHeight);var c=new THREE.OrthographicCamera(-a/2,a/2,-n/2,n/2,-100,2e4),d=new THREE.Scene;d.name="videoScene",d.add(r),d.add(o);var u=new THREE.Scene;u.name="scene2D";var p=new THREE.Scene,m=new THREE.PerspectiveCamera(45,1.33333,1,2e4);if(m.projectionMatrix.fromArray(this.getCameraMatrix()),m.rotation.set(0,180*Math.PI/180,180*Math.PI/180),m.projectionMatrix.elements[5]=-m.projectionMatrix.elements[5],m.projectionMatrix.elements[8]=-m.projectionMatrix.elements[8],m.projectionMatrix.elements[9]=-m.projectionMatrix.elements[9],m.projectionMatrix.elements[10]=-m.projectionMatrix.elements[10],m.projectionMatrix.elements[11]=-m.projectionMatrix.elements[11],m.projectionMatrixInverse.getInverse)m.projectionMatrixInverse.getInverse(m.projectionMatrix);else{let e=m.projectionMatrix.clone();m.projectionMatrixInverse.copy(e.invert())}let h=m.clone(),g=document.getElementById("oCamera"),b=new THREE.PerspectiveCamera(60,a/n,.3,1e4),_=g.getObject3D("camera").position.clone();b.position.copy(_);let y={aspect:a/n,near:.3,far:1e4,fov:60};g.setObject3D("camera",b),g.setAttribute("camera",y),g.components.camera.camera=b,g.components["orbit-controls"].controls.object=b;var j=new THREE.PerspectiveCamera(45,1.33333,1,2e4);j.projectionMatrix.fromArray(this.getCameraMatrix()),this.orientation,this.camera=m,this.aCamera=m,this.oCamera=g,this.oCamera3D=b,this.bkCamera=h,this.CSScamera=j,this.videoCamera=o,this.videoScene=d,this.scene2D=u,this.camera2D=c,this.videoStreamPlane=r,this.enableTracking=!0,this.enableARRendering=!1,this.needsCullFaceBack=!1;var f=new THREE.Clock;this.clock=f,this.cssScene=p;var w=this;return{videoScene:d,scene2D:u,cssScene:p,camera:m,CSScamera:j,videoCamera:o,camera2D:c,arController:this,video:e,clock:f,process:function(){for(var t in w.aframeNFTMarkers)w.aframeNFTMarkers[t].object3D.visible=!1;w.process(e)},renderOn:function(e){t.needsUpdate=!0,e.autoClear=!1,w.arScene.video.paused||e.render(this.videoScene,this.videoCamera),e.clearDepth(),e.render(i.object3D,arController.camera),e.render(this.scene2D,this.camera2D)}}},ARController.prototype.createAframeNFTMarker=function(e){this.setupThree();let t=document.createElement("a-entity"),r=this;if(console.log(" _createAframeNFTMarker_: ",e),r.sceneTargetList&&r.sceneTargetList[e]){let a=r.sceneTargetList[e].target_id;t.setAttribute("id",a),t.GCSSID=e;let n=r.sceneTargetList[e].sceneIndex,i=o.o.getScenes(r.scenesData);if(Array.isArray(i)&&i[n]){let e=i[n];t.makarSceneName=e.info.name,t.makarSceneIndex=n,t.makarSceneID=e.info.id,t.setAttribute("visible",!1),t.loadedObjects=!1,t.showObjects=!0,t.addEventListener("loaded",(function(){t.object3D.matrixAutoUpdate=!1,t.object3D.targetRoot=!0,t.object3D.makarSceneName=e.info.name,t.object3D.makarSceneIndex=n,t.object3D.makarSceneID=e.info.id})),r.aframeNFTMarkers[n]?console.log(" _createAframeNFTMarker_: this scene entity is already loaded ",n,e):(console.log(" _createAframeNFTMarker_: load this scene entity ",n,e),r.arfScene.appendChild(t),r.aframeNFTMarkers[n]=t)}}return t},ARController.prototype.createThreeNFTMarker2D=function(e){this.setupThree();let t=this;var r=new THREE.Object3D;if(r.visible=!1,t.sceneTargetList&&t.sceneTargetList[e]){let a=t.sceneTargetList[e].sceneIndex,n=t.sceneTargetList[e].target_id;r.targetID=n,r.GCSSID=e,r.loadedObjects=!1,r.matrixAutoUpdate=!1;let i=o.o.getScenes(t.scenesData);if(Array.isArray(i)&&i[a]){let e=i[a];r.makarSceneName=e.info.name,r.makarSceneIndex=a,r.makarSceneID=e.info.id,t.threeNFTMarkers2D[a]?console.log(" _createThreeNFTMarker2D_: this scene entity is already loaded ",a,e):(console.log(" _createThreeNFTMarker2D_: load this scene entity ",a,e),t.arScene.scene2D.add(r),t.threeNFTMarkers2D[a]=r)}}return r},ARController.prototype.get2DScaleRatio=function(){let t,r,o,a=this,n="";if(4==Object.keys(this.editor_version).length){let e=Number(this.editor_version.v0),t=Number(this.editor_version.v1);Number(this.editor_version.v2),(e>3||3==e&&t>4)&&(n=i())}else n=i();function i(){let t="",r=a.arScene.clientWidth,o=a.arScene.clientHeight;if(e.oneProjData&&Array.isArray(e.oneProjData.orientation)){let n=e.oneProjData.orientation,i=1e3,l=0;n.forEach(((e,t)=>{let a=e.width/e.height/(r/o),n=e.width/r,s=e.height/o,c=a>1?a:1/a,d=n>1?n:1/n,u=s>1?s:1/s;e.nrdScore=c*(d+u),e.nrdScore<i&&(i=e.nrdScore,l=t)}));let s=n[l];a.selectedResolutionIndex=l,t=String(s.width)+","+String(s.height),console.log(" _getResolution350: ",i,l,s,t)}return t}if(""==n&&(console.log(" _get2DScaleRatio: fucking lose resolutionString "),a.selectedResolutionIndex=0,n="720,1280"),""!=n){let e=n.split(","),i=Number(e[0]),l=Number(e[1]),s=a.arfScene.clientWidth,c=a.arfScene.clientHeight;if(r=Math.abs(a.camera2D.right-a.camera2D.left),o=Math.abs(a.camera2D.bottom-a.camera2D.top),r/o>=s/c)if(s/c>=i/l){t=c*(i/l)/i,console.log(" _loadTexture2D: 1 ",i,l,s,c,t)}else t=s/i,console.log(" _loadTexture2D: 2 ",i,l,s,c,t);else if(s/c>=i/l){let e=c*(i/l),a=c/(s*(o/r)),n=e/s,d=e/i;t=d,console.log(" _loadTexture2D: 3 ",i,l,s,c,t,a,n,d)}else{let e=c/(s*(o/r)),a=s*(l/i)/c,n=s/i;t=n,console.log(" _loadTexture2D: 4 ",i,l,s,c,t,e,a,n)}}else console.log(" fucking lose resolutionString ");return console.log(" _get2DScaleRatio: srxy=",t),t},ARController.prototype.set2DScaleRatio=function(e){this.scaleRatioXY=e},ARController.prototype.loadMakarARScene=function(r,a,n,l){let s=this,c=o.o.getProjDataEditorVer(s.currentProjData);s.editor_version=c,window.aQuizAR.clear(),window.aQuizAR.scene3DRoot=a;let u=this.get2DScaleRatio();this.set2DScaleRatio(u),s.groupEventTargetDict[r]?console.log("_loadMakarARScene_: _groupEventTargetDict: already exist ",r):s.groupEventTargetDict[r]=JSON.parse(JSON.stringify(s.groupDict)),s.lookAtTargetDict[r]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",r):s.lookAtTargetDict[r]=[],s.lookAtTargetTimelineDict[r]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",r):s.lookAtTargetTimelineDict[r]=[];let p=o.o.getSceneObjs(s.scenesData,r),m=s.scenesData.scenes[r].behav;t.setBehavsGroup(m,r);let h=[];for(let c=0;c<p.length;c++){let u=p[c];o.o.setBehavIntoObj(s.scenesData,r,u);let g=o.o.getObjTransform(s.scenesData,u),b=g.position,_=g.rotation,y=g.scale,j=g.quaternion;t.setObjBehav(u,m);let f=s.userProjResDict,w=s.userOnlineResDict;f[u.res_id]&&f[u.res_id].main_type?u.main_type=f[u.res_id].main_type:w[u.res_id]&&w[u.res_id].res_url?u.main_type=w[u.res_id].main_type:d(u),f[u.res_id]&&f[u.res_id].sub_type?u.sub_type=f[u.res_id].sub_type:w[u.res_id]&&w[u.res_id].res_url&&(u.sub_type=w[u.res_id].sub_type),f[u.res_id]&&f[u.res_id].res_url?u.res_url=f[u.res_id].res_url:w[u.res_id]&&w[u.res_id].res_url?u.res_url=w[u.res_id].res_url:console.log("_loadMakarARScene_: res_url does not exist. obj=",u);let D=o.o.getObjObjType(s.scenesData,u);switch(u.main_type){case"camera":break;case"image":let t;console.log(" _ARWrapper: load image ",c,D,u),"3d"==D?t=s.loadTexture3D(a,u,b,_,y,j):"2d"==D?t=s.loadTexture2D(n,u,c,p.length,b,_,y):console.log("VRController.js: _loadSceneObjects: image obj_type=",D),h.push(t);break;case"video":let r;console.log(" _ARWrapper: load video ",c,D,u),"3d"==D?r=s.loadVideo3D(a,u,b,_,y,j):"2d"==D?r=s.loadVideo2D(n,u,c,p.length,b,_,y):console.log("VRFunc.js: _loadSceneObjects: video obj_type=",D),h.push(r);break;case"text":let o;"3d"==D?o=s.loadText3D(a,u,b,_,y,j):"2d"==D?o=s.loadText2D(n,u,c,p.length,b,_,y):console.log("VRFunc.js: _loadSceneObjects: text obj_type=",D),h.push(o);break;case"model":if(console.log(" _ARWrapper: load model ",c,D,u),"3d"==D){let e=s.loadMaterialTexture(u);h.push(e);let t=s.loadGLTFModel(a,u,b,_,y,j);h.push(t)}break;case"curve":if("3d"==D){let e=s.loadCurve(a,u,b,_,y,j);h.push(e)}break;case"audio":if("mp3"==u.sub_type||"wav"==u.sub_type||"ogg"==u.sub_type){let e=s.loadAudio(a,u,b,_,y,j);h.push(e)}break;case"light":console.log(" _ARWrapper: load light ",c,D,u);let d=s.loadLight(a,u,b,_,y,j);h.push(d);break;case"empty":const m=s.currentProjData.proj_id;switch(p[c].sub_type){case"quiz":if(!p[c].typeAttr.module.display_order_list){console.log("%c _arController _loadMakarARScene: user has not set display_order_list. obj.typeAttr.module=","color:Salmon",p[c].typeAttr.module);break}a.module="Quiz",a.loadModule="quiz",p[c].typeAttr.module.question_list.forEach((e=>{let t=e.options_json.find((e=>"Button"==e.res_id));t&&(t.generalAttr.obj_parent_id||(t.generalAttr.obj_parent_id=p[c].generalAttr.obj_id,console.log("%c 多選按鈕 btnJson","color: tomato",t)))}));const t=localStorage.getItem("MakarUserID");let r={position:b,rotation:_,scale:y,quaternion:j};const o={dpi:s.gcssTargets.dpi[a.GCSSID],GCSSWidth:s.gcssTargets.width[a.GCSSID],GCSSHeight:s.gcssTargets.height[a.GCSSID]};r.panByScene3DRoot=o;const d={startQuiz:document.getElementById("startQuiz"),QuizStartButton:document.getElementById("QuizStartButton"),QuizStartContent:document.getElementById("QuizStartContent")},g=window.aQuizAR.loadQuiz(a,n,p[c],r,m,t,d,s.worldContent,s.languageType);h.concat(g),console.log("VRFunc.js: _loadSceneObjects: empty, quiz ",c,p[c]);break;case"point_card":if("point_card"!=u.res_id)break;if(!u.typeAttr.module)break;if(!parent.mdb)break;if(!u.generalAttr.active)break;const f=u.generalAttr.obj_id;n.module="PointCard",n.loadModule="pointCard",n.project_module=u.typeAttr.module,n.project_module.obj_id=f,n.proj_id=m;const w=window.aPointCard.createPointCard(n,u,m);let D;D=u.typeAttr.module.backgroundID?"PointCard_Background"==u.typeAttr.module.backgroundID?"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png":e.userProjResDict[u.typeAttr.module.backgroundID].res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png",w.load(u,c,p.length).then((e=>{let t=localStorage.getItem("MakarUserID");{t="";let r=localStorage.getItem("device_id");r||(r=(new Date).getTime()+"_"+i(10),localStorage.setItem("device_id",r)),l?window.aPointCard.getPointCardProjectFromMDB(m).then((t=>{let r=u.typeAttr.module.points.find((e=>e.targetID==l));t.proj_id&&t.pointCards&&t.pointCards[f]?aPointCard.addPoint(t,f,r.targetID).then((o=>{w.update(o.pointCards[f],e);const a=t!=o;aPointCard.loadCardWithAddedPoint(n,w,u,r,c,p.length,o,a)})):(w.init(r.targetID,e),window.aPointCard.loadNewCard(n,u,w,r,c,p.length))})):window.aPointCard.getPointCardProjectFromMDB(m).then((e=>{window.aPointCard.loadCardWithAddedPoint(n,w,u,null,c,p.length,e,!1)}))}}));break;case"scratch_card":console.log("ARWrapper.js: _loadMakarARScene: scratch_card ",c,u);break;default:console.log("VRFunc.js: _loadSceneObjects: empty object default, ",c,p[c])}break;default:console.log(" _ARWrapper: load default ",c,D,u)}}return h},ARController.prototype.setupThree=function(){if(this.THREE_JS_ENABLED)return;this.THREE_JS_ENABLED=!0;let r=this;this.currentSceneIndex=null,this.currentTargetIndex=null,this.projStartTimeList=[],this.userStartTime=(new Date).getTime(),this.currentViewMode=null,this.aframeNFTMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={},this.threeNFTMarkers2D={},this.threeNFTMarkersCSS={},this.currentProjectIndex=null,this.objectControlState=null,this.quizModule=[],this.logicList=[],this.controlObject=null,this.currentControllObject=null,this.makarObjects=[],this.makarObjects2D=[],this.sceneTargetList=null,this.materials_texture_dict={},this.init_gyro=null,this.intervalList=[],this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.groupEventTargetDict={},this.lookAtTargetDict={},this.lookAtObjectList=[],this.lookAtTargetTimelineDict={},this.gcssTargets={a:123},this.addEventListener("loadNFTDone",(function(e){r.gcssTargets=e.data})),this.addEventListener("getFrameTarget",(function(e){if(console.log("three.js, listened getFrameTarget, ev=",e),e.data.index<0){if(console.log("three.js: listened getFrameTarget index < 0, return ",this.threeNFTMarkers2D[-3]),this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name){this.threeNFTMarkers2D[-3].visible=!0;let e=this;setTimeout((function(){e.threeNFTMarkers2D[-3].visible=!1}),2e3)}}else{this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name&&(this.threeNFTMarkers2D[-3].visible=!1);var o=e.data.uArray,a=new ImageData(o,256,256);this.targetCtx.putImageData(a,0,0);let n=this.aframeNFTMarkers[r.sceneTargetList[e.data.index].sceneIndex],i=this.threeNFTMarkers2D[r.sceneTargetList[e.data.index].sceneIndex];console.log("artk.three.js, listened getFrameTarget, obj=",n,"\nobj2D=",i),console.log(" ************* ",e.data.index,r.sceneTargetList[e.data.index]),n.coloringStatus=1,n.loadModel=!0;let l=r.sceneTargetList[e.data.index].sceneIndex,s=r.sceneTargetList[marker.id].target_id;t.arController.loadMakarARScene(l,n,i,s)}})),this.checkColoring=function(e,t,o,a){if(r.sceneTargetList[e].sceneIndex,r.sceneTargetList[e].modules.includes("coloring")){if(1!=t.loadModel){if(1==a){for(let e in t.object3D.children)"coloredPlane"==t.object3D.children[e].name&&(t.object3D.children[e].material.color.r=0,t.object3D.children[e].material.color.g=1);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=1,o.children[e].behav[0].enable=!0)}else{for(let e in t.object3D.children)"coloredPlane"==t.object3D.children[e].name&&(t.object3D.children[e].material.color.r=1,t.object3D.children[e].material.color.g=0);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=.3,o.children[e].behav[0].enable=!1)}return 0}return 1}return-1},this.addEventListener("getNFTMarkerDraw",(function(e){let a=e.data.marker,n=this.aframeNFTMarkers[r.sceneTargetList[a.id].sceneIndex],i=this.threeNFTMarkers2D[r.sceneTargetList[a.id].sceneIndex],l=[];if(n){if(!n.loadedObjects||!i.loadedObjects){n.loadedObjects=i.loadedObjects=!0;let d=document.getElementById("clickToPlayAudio");if(d.style.display="none",d.onclick=null,Array.isArray(r.currentProjData.loc)&&r.currentProjData.loc.length>0){function u(e,t,r,o,a="M"){if(e==r&&t==o)return 0;{let n=Math.PI*e/180,i=Math.PI*r/180,l=n-i,s=Math.PI*t/180-Math.PI*o/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(l/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2)));return"M"==a&&(c*=6378137),console.log("three.js: _calculateGeosToDistanceHaversine dist=",c),c}}if(warnButtonTitle.textContent=r.worldContent.comfirm[languageType],warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none",n.loadedObjects=i.loadedObjects=!1},navigator.geolocation){function p(e){console.log("three.js: showProjectInfo: get Geolocation geoPosition=.",e.coords.latitude,e.coords.longitude);let o=u(e.coords.latitude,e.coords.longitude,r.currentProjData.loc[0],r.currentProjData.loc[1]);getViewerConfig(serverUrl,(function(e){if(o<e.data.gps_range_distance){let e=r.sceneTargetList[a.id].sceneIndex,o=r.sceneTargetList[a.id].target_id;l=t.arController.loadMakarARScene(e,n,i,o);let c=r.parseLogicXMLBySceneIndex(e);s(c)&&l.push(c)}else console.log("three.js: showProjectInfo: get Geolocation distance not allow",o),warnModal.style.display="block",warnModalInfo.textContent=r.worldContent.GPSDistanceMsg[languageType]+Math.floor(o)+" meter"}))}function m(e){console.log("three.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),warnModal.style.display="block",warnModalInfo.textContent=r.worldContent.GPSErrorMsg[languageType]+"\r\n"+e.message}navigator.geolocation.getCurrentPosition(p,m,{enableHighAccuracy:!1,timeout:5e3,maximumAge:0})}else console.log("three.js: showProjectInfo: Geolocation is not supported by this browser."),warnModal.style.display="block",warnModalInfo.textContent=r.worldContent.GPSnotSupportMsg[languageType]}else{let h=r.sceneTargetList[a.id].sceneIndex,g=r.sceneTargetList[a.id].target_id;l=t.arController.loadMakarARScene(h,n,i,g);let b=r.parseLogicXMLBySceneIndex(h);s(b)&&l.push(b),Array.isArray(l)&&Promise.all(l).then((function(e){console.log("three.js: _getNFTMarkerDraw _loadMakarScene done: ret = ",e);let t=[];if(t=o.o.getScenes(r.scenesData),t[r.currentSceneIndex].bezier.length>0)for(let e=0;e<t[r.currentSceneIndex].bezier.length;e++)r.bezierPathAnime(n,t[r.currentSceneIndex].bezier[e],r.currentSceneIndex);if(t[h].behav.length>0)for(let e=0;e<t[h].behav.length;e++){let o=t[h].behav[e];if("Time"==o.trigger_type){let e=(new Date).toTimeString().split(":")[0];o.trigger_end_time-o.trigger_start_time>=0?e>=o.trigger_start_time&&e<o.trigger_end_time&&r.triggerEvent(o,!1,null):(e>=o.trigger_start_time||e<o.trigger_end_time)&&r.triggerEvent(o,!1,null)}else if("Gyro"==o.trigger_type){let e=!1,t=setInterval((function(){if(null!=r.init_gyro){let t;t=-(document.getElementById("cameraForGyro").components["look-controls"].magicWindowAbsoluteEuler.y-r.init_gyro.y)/Math.PI*180%360,t<0&&(t+=360);let a=o.trigger_start_vec.split(",").map((e=>Number(e)))[1],n=o.trigger_end_vec.split(",").map((e=>Number(e)))[1];a%=360,a<0&&(a+=360),n%=360,n<0&&(n+=360),n-a>0?t>=a&&t<=n?e||(e=!0,r.triggerEvent(o,!1,null)):e=!1:t>=a||t<=n?e||(e=!0,r.triggerEvent(o,!1,null)):e=!1}}),0);r.intervalList.push(t)}}}))}}if(a.found>0){if(r.currentSceneIndex=r.sceneTargetList[a.id].sceneIndex,2==a.found){n.targetState=2,r.logicList[r.currentSceneIndex]&&0==r.logicList[r.currentSceneIndex].logicSystemState&&r.logicList[r.currentSceneIndex].parseXML();var c=this.checkColoring(r.sceneTargetList[a.id].targetIndex,n,i,e.data.marker.allowColor);1==c?parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="block"):0==c&&parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="none")}else if(n.targetState=1,Promise.all(l).then((e=>{if(null==r.init_gyro){let e=document.getElementById("cameraForGyro");r.init_gyro=e.components["look-controls"].magicWindowAbsoluteEuler.clone()}this.activeAndClearScene(this.sceneTargetList[a.id].sceneIndex,this.sceneTargetList[a.id].target_id),this.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly()})).catch((e=>{console.warn("ARController.js  load scene  error:",e)})),n.object3D&&n.object3D.children.length>0&&(n.object3D.traverse((function(e){e.originTransform&&(e.position.copy(e.originTransform.position),e.rotation.copy(e.originTransform.rotation),e.scale.copy(e.originTransform.scale))})),n.object3D.updateMatrix(),n.object3D.matrixAutoUpdate=!1),r.camera.projectionMatrix.elements[8]=r.bkCamera.projectionMatrix.elements[8],r.camera.projectionMatrixInverse.getInverse)r.camera.projectionMatrixInverse.getInverse(r.camera.projectionMatrix);else{let _=r.camera.projectionMatrix.clone();r.camera.projectionMatrixInverse.copy(_.invert())}n.object3D.matrix.fromArray(e.data.matrix)}else if(n.object3D.visible=!1,console.log("three.js: losing: obj= ",n,e.data.marker.id),this.checkColoring(e.data.marker.id,n,i,0),1==n.showObjects){if(n.targetState=0,arController.logicList[arController.currentSceneIndex]&&arController.logicList[arController.currentSceneIndex].stopLogic(),r.camera.projectionMatrix.elements[8]=0,r.camera.projectionMatrixInverse.getInverse)r.camera.projectionMatrixInverse.getInverse(r.camera.projectionMatrix);else{let f=r.camera.projectionMatrix.clone();r.camera.projectionMatrixInverse.copy(f.invert())}let y=e.data.marker.id,j=25.4*r.gcssTargets.width[y]/r.gcssTargets.dpi[y]/2;n.object3D.visible=!0,n.object3D.matrixAutoUpdate=!0,n.object3D.position.set(-j,40,250),n.object3D.rotation.x=90*Math.PI/180,n.object3D.updateMatrix(),n.object3D.updateMatrixWorld(),n.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;if(e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"image"==e.makarType||"video"==e.makarType){let t=e.getWorldQuaternion(new THREE.Quaternion),r=new THREE.Euler;r.setFromQuaternion(t),e.rotateOnAxis(new THREE.Vector3(0,1,0),0-r.y),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI-r.x),e.updateMatrixWorld(),e.updateMatrix()}"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),n.object3D.updateMatrix(),n.object3D.matrixAutoUpdate=!1}}})),this.setViewMode=function(e=""){let t=this,r=t.aCamera,o=document.getElementById("oCamera");return""!=e&&(t.currentViewMode=e),new Promise((function(a){r&&o&&("AR"==e?(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,a("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: AR err=",e)}))):"model"==e?(t.camera=o.object3D.children[0],o.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,a("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _model err=",e)}))):t.camera==r?(t.camera=o.object3D.children[0],o.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,a("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch model err=",e)}))):(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,a("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch AR err=",e)}))))}))},this.setCurrentSceneIndex=function(e){this.currentSceneIndex=e},this.setViewModeSceneObj=function(e){let r=this;return new Promise((function(a,n){let i=-1;if(null==r.currentSceneIndex){let e=o.o.getScenes(r.scenesData);for(let t=0;t<e.length;t++)if("ar"==e[t].info.type){i=t,r.setCurrentSceneIndex(t);break}}else i=r.currentSceneIndex;if(i<0)return void a(!1);let l=!1;for(let e=0,t=r.sceneTargetList.length;e<t;e++)r.sceneTargetList[e].sceneIndex==i&&r.sceneTargetList[e].modules.includes("coloring")&&(l=!0);console.log(" _setViewModeSceneObj: _sceneIndex ",i);let c=r.aframeNFTMarkers[i],d=r.threeNFTMarkers2D[i];for(let e in r.aframeNFTMarkers)r.aframeNFTMarkers[e].object3D.visible=!1,r.aframeNFTMarkers[e].setAttribute("visible",!1);for(let e in r.threeNFTMarkers2D)r.threeNFTMarkers2D[e].visible=!1;if("AR"==e)if(1==c.loadedObjects||1==d.loadedObjects)if(d.visible=!1,c.setAttribute("visible",!1),c.object3D.visible=!1,c.object3D.traverse((function(e){"video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound()})),null!=c.coloringStatus&&1==l)if(-1==c.coloringStatus||0==c.coloringStatus){for(console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),c.loadModel=!1;c.children.length>0;)c.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=t.arController.loadMakarARScene(i,c,d,null),o=r.parseLogicXMLBySceneIndex(i);s(o)&&e.push(o),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),a(!0)}))}else 1==c.coloringStatus&&(console.log(" _setViewModeSceneObj: model: color 1"),a(!0));else console.log(" _setViewModeSceneObj: AR: not _coloring module "),a(!0);else a(!0);else if("model"==e){if(1!=c.loadedObjects||1!=d.loadedObjects){c.loadedObjects=d.loadedObjects=!0,1==l&&(c.loadModel=!0,c.coloringStatus=0,(u=r.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,r.targetCanvas.width,r.targetCanvas.height));let e=t.arController.loadMakarARScene(i,c,d,null),n=r.parseLogicXMLBySceneIndex(i);s(n)&&e.push(n),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e);let t=[];if(t=o.o.getScenes(r.scenesData),t[r.currentSceneIndex].bezier.length>0)for(let e=0;e<t[r.currentSceneIndex].bezier.length;e++)r.bezierPathAnime(c,t[r.currentSceneIndex].bezier[e],r.currentSceneIndex);if(t[i].behav.length>0)for(let e=0;e<t[i].behav.length;e++){let o=t[i].behav[e];if("Time"==o.trigger_type){let e=(new Date).toTimeString().split(":")[0];o.trigger_end_time-o.trigger_start_time>=0?e>=o.trigger_start_time&&e<o.trigger_end_time&&r.triggerEvent(o,!1,null):(e>=o.trigger_start_time||e<o.trigger_end_time)&&r.triggerEvent(o,!1,null)}else if("Gyro"==o.trigger_type){let e=!1,t=setInterval((function(){if(null!=r.init_gyro){let t;t=-(document.getElementById("cameraForGyro").components["look-controls"].magicWindowAbsoluteEuler.y-r.init_gyro.y)/Math.PI*180%360,t<0&&(t+=360);let a=o.trigger_start_vec.split(",").map((e=>Number(e)))[1],n=o.trigger_end_vec.split(",").map((e=>Number(e)))[1];a%=360,a<0&&(a+=360),n%=360,n<0&&(n+=360),n-a>0?t>=a&&t<=n?e||(e=!0,r.triggerEvent(o,!1,null)):e=!1:t>=a||t<=n?e||(e=!0,r.triggerEvent(o,!1,null)):e=!1}}),0);r.intervalList.push(t)}}r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),r.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly(),a(!0)})).catch((e=>{console.warn("ARController.js: _setViewModeSceneObj  load scene  error:",e)}))}else if(r.logicList[i]&&0==r.logicList[i].logicSystemState&&r.logicList[i].parseXML(),c.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),null!=c.coloringStatus&&1==l)if(-1==c.coloringStatus){var u;for(console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),c.loadModel=!0,c.coloringStatus=0,(u=r.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,r.targetCanvas.width,r.targetCanvas.height);c.children.length>0;)c.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=r.sceneTargetList[marker.id].target_id,o=t.arController.loadMakarARScene(i,c,d,e),n=r.parseLogicXMLBySceneIndex(i);s(n)&&o.push(n),Array.isArray(o)&&Promise.all(o).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),a(!0)}))}else console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),a(!0);else console.log(" _setViewModeSceneObj: model: not _coloring module "),a(!0);d.visible=!0;let e=r.gcssTargets.dpi[c.GCSSID],n=r.gcssTargets.width[c.GCSSID],p=r.gcssTargets.height[c.GCSSID];c.setAttribute("visible",!0),c.object3D.visible=!0,c.object3D.matrixAutoUpdate=!0,c.object3D.position.set(0,0,0),c.object3D.position.add(new THREE.Vector3(25.4*-n/e/2,25.4*-p/e/2,0)),c.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&e.el.components.sound.playSound())})),c.object3D.rotation.x=-90*Math.PI/180,c.object3D.updateMatrix(),c.object3D.updateMatrixWorld()}else console.log(" _setViewModeSceneObj: error",e),n(e)}))},this.parseLogicXMLBySceneIndex=function(e){let t,a=o.o.getSceneLogicXML(r.scenesData,e);if(""!=a){let r=new Logic;t=r.loadXMLtoDoc(a),arController.logicList[e]=r}return t},this.activeAndClearScene=function(t,r=-1){let o=this;for(let e in this.aframeNFTMarkers)if(e==t){this.aframeNFTMarkers[e].object3D.visible=!0,this.threeNFTMarkers2D[e].visible=!0;let t=this.aframeNFTMarkers[e];t.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location?o.dealVideoMuted():e.el.mp4Video.play()),"audio"==e.makarType&&e.el.components.sound.playSound())})),window.aQuizAR.scene3DRoot=t}else{if(this.aframeNFTMarkers[e].object3D.traverse((function(e){if("video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound(),e.behav_reference&&e.behav_reference.length>0)for(let t=0;t<e.behav_reference.length;t++)"ShowVideo"!=e.behav_reference[t].behav_name&&"ShowModel"!=e.behav_reference[t].behav_name&&"ShowImage"!=e.behav_reference[t].behav_name&&"PlayMusic"!=e.behav_reference[t].behav_name&&"ShowText"!=e.behav_reference[t].behav_name||e.el.setAttribute("visible",!1)})),this.aframeNFTMarkers[e].loadModule,0==this.aframeNFTMarkers[e].object3D.visible&&0==this.threeNFTMarkers2D[e].visible)continue;this.aframeNFTMarkers[e].object3D.visible=!1,this.threeNFTMarkers2D[e].visible=!1,this.threeNFTMarkers2D[e].loadModule&&("pointCard"===this.threeNFTMarkers2D[e].loadModule?(console.log("three.js: recognize: _clearScene, processing pointCard "),aPointCard.hidePointCardCanvas(this.threeNFTMarkers2D[e])):console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[e].loadModule))}for(let a in this.threeNFTMarkers2D)if(a==t&&this.threeNFTMarkers2D[a].loadModule)if("pointCard"===this.threeNFTMarkers2D[a].loadModule){if(console.log("ARController _activeAndClearScene recognize: _clearScene, pointCard processing",o.threeNFTMarkers2D[a]),!parent.mdb)return[];let t=localStorage.getItem("MakarUserID");{let n,i;t="",o.scenesData.scenes[o.currentSceneIndex].objs.forEach(((e,t)=>{e.typeAttr&&e.typeAttr.module&&e.typeAttr.module.moduleID==o.threeNFTMarkers2D[a].project_module.moduleID&&(n=t,i=e)}));const l=o.scenesData.scenes[o.currentSceneIndex].objs.length;window.aPointCard.getPointCardProjectFromMDB(e.oneProjData.proj_id).then((e=>{const s=i.generalAttr.obj_id;e.pointCards?e.pointCards[s]&&aPointCard.checkPointThenAdd(o.threeNFTMarkers2D[a],r,n,l,t):console.log("理論上不應出現這狀況：並非初次掃到辨識圖(有載過場景) 卻又沒有集點卡 ")}))}}else console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[a].loadModule)},this.dealVideoMuted=function(e){let t=document.getElementById("clickToPlayAudio");t.style.display="block",t.onclick=function(){r.UnMutedAndPlayAllVisibleVideo(),window.allowAudioClicked=!0,t.style.display="none",t.onclick=null,window.alreadyClicked=!0}},this.getMakarObject=function(e){return 1!=e.makarObject?e.parent?r.getMakarObject(e.parent):0:e},this.dealAllGroupHide=function(e,t){let r=this,o=r.groupEventTargetDict[t];if(o)for(let t=0;t<e.behav.length;t++){let a=e.behav[t];""!=a.group&&o[a.group]&&o[a.group].objs.forEach(((e,t)=>{let o=e.obj_id,n=r.getObjectTypeByObj_id(o);if("2d"==n.obj_type){let e=n.obj;if(a.obj_id!=o&&e.behav_reference)for(let t=0;t<e.behav_reference.length;t++)"Display"==e.behav_reference[t].behav_type&&(e.visible=!1),"Media"==e.behav_reference[t].behav_type&&(e.visible=!1,"video2D"==e.makarType&&e.mp4&&"function"==typeof e.mp4.pause&&e.mp4.pause())}else if("3d"==n.obj_type){let e=n.obj;if(e.object3D.behav_reference&&Array.isArray(e.object3D.behav_reference)&&a.obj_id!=o)for(let t=0;t<e.object3D.behav_reference.length;t++){let o=e.object3D.behav_reference[t];if("Display"==o.behav_type&&("Switch"==o.switch_type||"Show"==o.switch_type)){r.hideGroupObjectEvent(e);break}}}}))}else console.log("_dealAllGroup: missing groupDict")},this.hideGroupObjectEvent=function(e){e?e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}}))):console.log("VRFunc.js: _hideGroupObjectEvent: target not exist ",e)},this.setupSceneBehav=function(e){let t=this;for(let e=0,r=t.makarObjects.length;e<r;e++){let r=t.makarObjects[e].object3D;r?(r.behav,r.behav_reference):console.error(" _setupSceneBehav: 3d obj error",e,t.makarObjects[e])}let r=t.lookAtTargetDict[e];if(Array.isArray(r))for(let o=0,a=r.length;o<a;o++){let a=r[o],n=a.lookObjId,i=document.getElementById(n),l=a.lookBehav,s=l.obj_id,c=(l.reverse,document.getElementById(s));i&&i.object3D&&c&&c.object3D?t.addLookAtTimeLine(i,c,a,e):console.log("_setupSceneBehav: _lookAt error, obj not exist",i,c)}},this.addLookAtTimeLine=function(e,t,r,o){console.log(" _addLookAtTimeLine: ",r);let a=this.lookAtTargetTimelineDict[o],n=new THREE.Vector3;t.object3D.getWorldPosition(n);let i=gsap.timeline();a[r.lookObjId]=i,i.to(e.object3D,{duration:1100,delay:0,ease:"none",repeat:-1,onUpdate:function(){t.object3D.getWorldPosition(n),e.object3D.lookAt(n),r.lookBehav&&0==r.lookBehav.reverse&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}})},this.setObjectBehavAll=function(e,t){},this.addBehavToQuizTriggerObj=()=>{const e=window.aQuizAR.triggers;Array.isArray(e)&&0!=e.length&&window.aQuizAR.quizIdWithTriggers.forEach((e=>{let t=document.getElementById(e.trigger_id);t.className="clickable";let o=this.makarObjects2D.find((t=>t.obj_id==e.trigger_id));const a={obj_id:e.obj_id,played:!1,behav_type:"ShowQuiz",force_login:e.force_login,allow_retry:e.allow_retry};if(t){console.log("ARController.js: _addBehavToQuizTriggerObj get quizTrigger=",t);let r=t.object3D;r.behav&&Array.isArray(r.behav)?r.behav.find((t=>t.obj_id==e.obj_id))||(r.behav.push(a),console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj3D=",r)):(r.behav=[a],console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj3D=",r))}else o?(console.log("ARController.js: _addBehavToQuizTriggerObj get quizTriggerObj2D=",o),o.behav?o.behav.find((t=>t.obj_id==e.obj_id))||(o.behav.push(a),console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj2D=",o)):(o.behav=[a],console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj2D=",o))):console.log("VRController.js _loadScene: can not find quiz's trigger",e.trigger_id," performance.now()=",performance.now(),r.makarObjects2D.slice())}))},this.getMakarObject=function(e){return 1!=e.makarObject?e.parent?r.getMakarObject(e.parent):0:e},this.getObjectTypeByObj_id=function(e){let t=this,r=null,o=null,a=null,n=null,i={obj_type:"",obj_index:null,obj:null};return e&&(t.makarObjects.forEach(((t,a)=>{t.id==e&&(r=t,o=a)})),t.makarObjects2D&&t.makarObjects2D.forEach(((t,r)=>{t.obj_id==e&&(a=t,n=r)})),null!=r&&null!=o||null!=a&&null!=n?null!=r&&null!=o?(i.obj_type="3d",i.obj_index=o,i.obj=r):null!=a&&null!=n?(i.obj_type="2d",i.obj_index=n,i.obj=a):console.log("_getObjectTypeByObj_id: fucking logic trouble.",n,a):null!=r&&null!=o&&null!=a&&null!=n&&(i.obj_type="3d",i.obj_index=o,i.obj=r)),i},this.triggerEvent=function(e,t,r){let o=this,a=null;void 0===t&&(t=!1);let n=e.obj_id;switch(e.behav_type){case"Dialing":console.log("ARWrapper.js: _triggerEvent: Dialing: event=",e);let i=window.document.getElementById("phoneCall");i&&(i.href="tel:"+e.phone,i.click());break;case"Email":console.log("ARWrapper.js: _triggerEvent: SendEmail: event=",e);let l=window.document.getElementById("sendEmail");l&&(l.href="mailto:"+e.mail_to,l.click());break;case"URL":console.log("ARWrapper.js: _triggerEvent: URL: event=",e,e.url);let s=window.document.getElementById("openWebBrowser");s&&(s.href=e.url,s.click());break;case"Scenes":console.log("ARWrapper.js: _triggerEvent: _Scenes: event=",e);let c=e.scene_id;if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let p=setTimeout((()=>{o.eventChangeScene(c)}),3e3);e.previousID=p}else o.eventChangeScene(c);break;case"Display":if(console.log("ARWrapper.js: _triggerEvent: _Display: event=",e),a=document.getElementById(n),!a){console.warn("VRFunc.js: Media: target not exist",a);break}if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let m=setTimeout((()=>{d()}),3e3);e.previousID=m}else d();function d(){"a-sound"==a.nodeName.toLowerCase()?"Switch"==e.switch_type?a.getAttribute("visible")?(a.setAttribute("visible",!1),a.setAttribute("class","unclickable"),a.components.sound.stopSound()):(a.setAttribute("visible",!0),a.object3D.behav&&a.setAttribute("class","clickable"),a.components.sound.playSound()):"Show"==e.switch_type?(a.setAttribute("visible",!0),a.object3D.behav&&a.setAttribute("class","clickable"),a.components.sound.playSound()):"Hide"==e.switch_type&&(a.setAttribute("visible",!1),a.setAttribute("class","unclickable"),a.components.sound.stopSound()):o.showObjectEvent(a,t,e.switch_type)}break;case"Display2D":if(console.log("VRFunc.js: _triggerEvent: Display2D: event=",e),1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let h=setTimeout((()=>{u()}),3e3);e.previousID=h}else u();function u(){let t=o.makarObjects2D.find((t=>t.obj_id==e.obj_id));"Switch"==e.switch_type?t&&(t.visible=!t.visible):"Show"==e.switch_type?t.visible=!0:"Hide"==e.switch_type&&(t.visible=!1);let r=t.children[0].material.map.image;if("video"==r.tagName.toLowerCase()){const e=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2);e(r)?r.pause():r.play()}}break;case"Media":console.warn("ARWrapper.js: _triggerEvent: _Media: event=",e);break;case"Animation":if(console.log("ARWrapper.js: _triggerEvent: _Animation: event=",e),a=document.getElementById(n),!(a&&a.object3D&&a.object3D.children[0]&&Array.isArray(a.object3D.children[0].animationSlices))){console.log("ARWrapper.js: _Animation: target not exist",a);break}{let g;for(let b=1;b<a.object3D.children[0].animationSlices.length;b++)a.object3D.children[0].animationSlices[b].uid==e.uid&&(g=a.object3D.children[0].animationSlices[b].animationName);a.setAttribute("animation-mixer","clip: "+g),e.loop?(a.object3D.children[0].animationSlices[0].loop=e.uid,a.object3D.children[0].animationSlices[0].uid=e.uid,a.object3D.children[0].animationSlices[0].changed=!0,a.object3D.children[0].animationSlices[0].reset=!0):(a.object3D.children[0].animationSlices[0].uid=e.uid,a.object3D.children[0].animationSlices[0].changed=!0,a.object3D.children[0].animationSlices[0].reset=e.reset)}break;case"TTS":if(console.log("ARWrapper.js: _triggerEvent: _TTS: event=",e),a=document.getElementById(n),!a||!a.object3D){console.log("ARWrapper.js: _TTS: target not exist",a);break}e.obj_id;break;case"ShowQuiz":if(window.aQuizAR.checkIsAnyQuizPlaying())console.log("%cVRController.js _triggerEvent: ShowQuiz triggered, but user hasn't finnish previous quiz yet.","color: orange");else{const _=document.getElementById("startQuiz");window.aQuizAR.currentlyTriggeredQuizId=e.obj_id,window.aQuizAR.checkIfQuizOpenByTrigger(_,n)}case"QuizOption":aQuizAR.loadedQuizzes.forEach((e=>{e.module.json.question_list.forEach((t=>{t.options_json.forEach((t=>{r.el?r.el.id==t.generalAttr.obj_id&&e.quizOption(r.el):r.obj_id==t.generalAttr.obj_id&&e.quizOption(r)}))}))}));break;case"MoveAlongPath":a=document.getElementById(n),a.object3D.bezier.play();break;default:console.log("ARWrapper.js: _triggerEvent: default: event=",e)}},this.eventChangeScene=function(e){let r=this;return new Promise((function(a){r.scenesData&&Array.isArray(r.scenesData.scenes)?console.log(" _eventChangeScene_: _sceneID: ",e):(console.log("_eventChangeScene_: scenesData error ",r.scenesData),a(!1));for(let n=0;n<r.scenesData.scenes.length;n++)if(r.scenesData.scenes[n].info.id==e){r.init_gyro=null;let e=r.scenesData.scenes[n].info;if("ar"==e.type)console.log(" _Scenes_ , to AR , ",n,e),"model"==r.currentViewMode?(r.setCurrentSceneIndex(n),r.sceneTargetList.forEach((e=>{if(e.sceneIndex==n){let n=e.sceneIndex,i=r.aframeNFTMarkers[n],l=r.threeNFTMarkers2D[n];if(1==i.loadedObjects||1==l.loadedObjects){console.log("three.js: _setViewModeSceneObj: already loaded, call _activeAndClearScene_ "),r.activeAndClearScene(n,e.target_id);let t=r.gcssTargets.dpi[i.GCSSID],o=r.gcssTargets.width[i.GCSSID],l=r.gcssTargets.height[i.GCSSID];i.object3D.position.set(0,0,0),i.object3D.position.add(new THREE.Vector3(25.4*-o/t/2,25.4*-l/t/2,0)),i.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&e.el.components.sound.playSound())})),i.object3D.rotation.x=-90*Math.PI/180,i.object3D.updateMatrix(),i.object3D.updateMatrixWorld(),a(!0)}else{console.log("three.js: _setViewModeSceneObj: not loaded, call _loadMakarARScene_ "),i.loadedObjects=!0,l.loadedObjects=!0;let c=r.sceneTargetList[marker.id].target_id,d=t.arController.loadMakarARScene(n,i,l,c),u=r.parseLogicXMLBySceneIndex(n);s(u)&&d.push(u),Array.isArray(d)&&Promise.all(d).then((function(t){console.log("three.js: _setViewModeSceneObj: done: ret = ",t);let l=[];if(l=o.o.getScenes(r.scenesData),l[n].bezier.length>0)for(let e=0;e<l[n].bezier.length;e++)r.bezierPathAnime(i,l[n].bezier[e],n);if(l[n].behav.length>0)for(let e=0;e<l[n].behav.length;e++){let t=l[n].behav[e];if("Time"==t.trigger_type){let e=(new Date).toTimeString().split(":")[0];t.trigger_end_time-t.trigger_start_time>=0?e>=t.trigger_start_time&&e<t.trigger_end_time&&r.triggerEvent(t,!1,null):(e>=t.trigger_start_time||e<t.trigger_end_time)&&r.triggerEvent(t,!1,null)}else if("Gyro"==t.trigger_type){let e=!1,o=setInterval((function(){if(null!=r.init_gyro){let o;o=-(document.getElementById("cameraForGyro").components["look-controls"].magicWindowAbsoluteEuler.y-r.init_gyro.y)/Math.PI*180%360,o<0&&(o+=360);let a=t.trigger_start_vec.split(",").map((e=>Number(e)))[1],n=t.trigger_end_vec.split(",").map((e=>Number(e)))[1];a%=360,a<0&&(a+=360),n%=360,n<0&&(n+=360),n-a>0?o>=a&&o<=n?e||(e=!0,r.triggerEvent(t,!1,null)):e=!1:o>=a||o<=n?e||(e=!0,r.triggerEvent(t,!1,null)):e=!1}}),0);r.intervalList.push(o)}}r.logicList[n]&&r.logicList[n].parseXML(),r.setupSceneBehav(n),r.activeAndClearScene(n,e.target_id),r.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly(),a(!0)})).catch((e=>{console.warn("ARController.js: _eventChangeScene  load scene  error:",e)}))}}}))):"AR"==r.currentViewMode&&(r.setCurrentSceneIndex(n),r.activeAndClearScene(-1));else if("vr"==e.type){if(console.log(" _Scenes_ , to VR , ",e),window.mixController&&window.vrController&&window.vrController){let e=document.getElementById("loadPage");e&&(e.style.display="block"),arController.activeAndClearScene(-1),arController.enableARRendering=!1,vrController.enableVRRendering=!0,mixController.setActiveType("VR"),vrController.triggerEnable=!1,vrController.loadScene(n),"model"==r.currentViewMode?vrController.setViewMode("model"):"AR"==r.currentViewMode&&vrController.setViewMode("VR")}}else"ar_slam"==e.type&&(console.log(" _Scenes_ , to AR_SLAM , not yet ",e),window.mixController&&window.xrController&&window.xrController&&(arController.activeAndClearScene(-1),arController.enableARRendering=!1,xrController.enableXRRendering=!0,mixController.setActiveType("XR"),xrController.triggerEnable=!1,xrController.loadScene(n),"model"==r.currentViewMode?xrController.setViewMode("model"):"AR"==r.currentViewMode&&xrController.setViewMode("VR")))}}))},this.showObjectEvent=function(e,t,o){function a(){if(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),"a-video"==e.localName){let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo()),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound"))if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})),t&&e.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}function n(){window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo(e)),e.setAttribute("visible",!0);let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}e.object3D.behav&&e.setAttribute("class","clickable"),e.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&(e.el.blockly?console.log("ARWrapper.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}e?"Switch"==o?e.getAttribute("visible")?a():n():"Show"==o?n():"Hide"==o&&a():console.log("ARWrapper.js: _showObjectEvent: target not exist",e)},this.runAnimation2D=function(e,t){if(!e||!t.dt)return console.warn("three.js: _runAnimation2D warning, obj is null "),-1;if(!e.isObject3D)return console.warn("three.js: _runAnimation2D warning, obj is not THREE.Object3D "),-1;if(t.dp&&t.dp.isVector3){var r=t.dp.clone().normalize(),o=t.dp.length(),a=null,n=null,i=null,l=null,s=function(c){a||(a=c),l=i?c-i:0,i=c,(n=c-a)<t.dt&&(e.translateOnAxis(r,o*(l/t.dt)),requestAnimationFrame(s))};requestAnimationFrame(s)}if(t.ds&&t.ds.isVector3){t.ds.x<0||t.ds.y<0||t.ds.z,t.ds.clone().normalize(),t.ds.length();let r=e.scale.clone(),o=t.ds,s=e.scale.clone().multiply(o),d=s.clone().sub(r),u=(new THREE.Vector3(1,1,1).divide(o),s.clone()),p=r.clone().clone().sub(u);a=null,n=null,i=null,l=null;var c=function(o){a||(a=o),l=i?o-i:0,i=o,(n=o-a)<t.dt?(e.scale.copy(r.clone().add(d.clone().multiplyScalar(n/t.dt))),requestAnimationFrame(c)):t.reverse?n<2*t.dt?(e.scale.copy(u.clone().add(p.clone().multiplyScalar((n-t.dt)/t.dt))),requestAnimationFrame(c)):(e.scale.copy(r),console.log("three.js: _runAnimation2D: ds reverse end ",e.scale)):(e.scale.copy(s),console.log("three.js: _runAnimation2D: ds end , not reverse ",e.scale))};requestAnimationFrame(c)}if(t.dopacity&&e.material&&e.material.opacity){console.log("0 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity);var d=e.material.opacity,u=d-t.dopacity,p=(a=null,n=null,function(r){a||(a=r),(n=r-a)<t.dt?(e.material.opacity=d-u*(n/t.dt),requestAnimationFrame(p)):console.log("1 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity)});requestAnimationFrame(p)}}})}initARProcess(e){let t=this;return new Promise((function(e){if(!(window.ARController&&ARController.getUserMediaThreeScene&&window.ARProxy))return void console.warn(" _initARProcess_: not loaded , _return ");console.log(" _initARProcess_: all done ");let r="environment";ARController.getUserMediaThreeScene({maxARVideoSize:640,cameraParam:"../camera_para_640_480_fei.dat",facing:r,onSuccess:function(a,n,i){var l=new ARProxy(n,"../camera_para_640_480_fei.dat",(function(){}));window.proxy=l;let s=document.getElementById("arfScene"),c=s.canvas;n.arfScene=s,n.facing=r;let d=s.renderer;if(c.style.position="relative",d.outputEncoding=THREE.GammaEncoding,d.gammaFactor=1,d.sortObjects=!0,n.GLRenderer=d,n.arScene=a,window.arController=n,t.arController=n,t.arController.setARTransform=u,t.arController.loadAudio=_,t.arController.loadGLTFModel=h,t.arController.loadMaterialTexture=b,t.arController.loadTexture2D=f,t.arController.loadTexture3D=j,t.arController.loadLight=w,t.arController.loadText2D=v,t.arController.loadText3D=D,t.arController.loadVideo2D=k,t.arController.loadVideo3D=A,t.arController.loadCurve=S,t.arController.bezierPathAnime=R,t.arController.loadScratchCard=x,t.arController.UnMutedAndPlayAllVisibleVideo=T,t.arController.languageType=window.languageType="tw",t.arController.worldContent={inputSearch:{tw:"搜尋",en:"Search"},labelSelected:{tw:"精選",en:"Selected"},userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},targetNumberError:{tw:"辨識圖的數量不可超過20 ",en:"the max number of image targets can't larger than 20 "},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"comfire"},timeIsUp:{tw:"時間到",en:"Time is up"}},"object"==typeof t.userProjResDict&&(n.userProjResDict=t.userProjResDict),"object"==typeof t.userOnlineResDict&&(n.userOnlineResDict=t.userOnlineResDict),"object"==typeof t.userMaterialDict&&(n.userMaterialDict=t.userMaterialDict),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();n.voices=e}if(l.addEventListener("load",(function(r){if(this.processingDone=!1,t.currentProjData&&t.scenesData&&t.targetList){let r=t.currentProjData,i=t.scenesData;n.currentProjData=r,n.scenesData=t.scenesData;let s=0,c=0,d=0,u=0,p=[];n.sceneTargetList=p;let m=[];m=o.o.getScenes(i);for(let e=0;e<m.length;e++){Array.isArray(m[e].target_ids)&&(s+=m[e].target_ids.length);let t=m[e];t.info&&"ar"==t.info.type&&(c+=1)}if(console.log("three.js: _load: the total target number = ",s),s>19)return console.log("three.js: _load: languageType = ",languageType),warnModal.style.display="block",warnModalInfo.textContent=t.arController.worldContent.targetNumberError[languageType],void(warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none"});let h=function(t){if(console.log("three.js: _onloadNFTMarker: ev = ",t),n.createAframeNFTMarker(t.result[0]),n.createThreeNFTMarker2D(t.result[0]),u+=1,Object.values(n.aframeNFTMarkers).length==c){let t=n;if(t.aframeNFTMarkers)for(let e in t.aframeNFTMarkers){let r=t.aframeNFTMarkers[e];if(Number.isInteger(Number(r.GCSSID))&&r&&r.object3D&&t.gcssTargets&&t.gcssTargets.dpi&&t.gcssTargets.width&&t.gcssTargets.height){let e=t.gcssTargets.dpi[r.GCSSID],o=t.gcssTargets.width[r.GCSSID],a=t.gcssTargets.height[r.GCSSID];r.object3D.matrixAutoUpdate=!0,r.object3D.position.set(0,0,0),r.object3D.position.add(new THREE.Vector3(25.4*-o/e/2,25.4*-a/e/2,0)),r.object3D.rotation.x=-90*Math.PI/180,r.object3D.updateMatrix(),r.object3D.updateMatrixWorld()}}console.log("three.js: _onloadNFTMarker done, call arScene.video.play() "),l.processingDone=!0,console.log("three.js:arScene.video.play()=>tick()"),e(),C(),setTimeout((function(){a.video.play().then((function(){console.log("three.js:arScene.video.play()=> succes")})).catch((function(e){console.error("three.js:arScene.video.play()=> error",e)}))}),10),n.userStartTime=(new Date).getTime()}};(new THREE.TextureLoader).load("https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg",(function(e){let a;a=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let i=n.GLRenderer,c=a.fromEquirectangularTexture(i,e);n.cubeTex=c;let u=[],g=o.o.getOneProj(r);if(g&&g.proj_descr&&g.proj_descr.includes("_coloring")){let e=g.proj_descr,t=e.indexOf("_coloring"),r=e.slice(t+10).indexOf(" "),o=e.slice(t+10,t+10+r).split("_");for(let e=0;e<o.length;e++)Number.isInteger(Number(o[e]))&&u.push(Number(o[e]))}for(let e=0;e<m.length;e++)if(Array.isArray(m[e].target_ids)&&m[e].info&&"ar"==m[e].info.type){let r=m[e].target_ids;for(let o=0;o<r.length;o++){let a=r[o];if(t.targetList){let r=t.targetList;for(let t=0;t<r.length;t++)if(r[t].target_id==a){let n=r[t].gcss_url;p[d]={sceneIndex:e,targetIndex:o,target_id:a,modules:[]},u.includes(e)&&p[d].modules.push("coloring"),l.loadNFTMarker(n.substring(0,n.length-5),d,s,h),d++}}}}console.log("three.js: _load: , _sceneTargetList = ",p)}))}})),document.body.className=n.orientation,"portrait"===n.orientation){let e,t;window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),console.log("3 three.js:portrait GLRenderer.setSize=",e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else if(/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)){let e,t;console.log("4 three.js:GLRenderer.setSize=",window.innerWidth,window.innerWidth/n.videoWidth*n.videoHeight),window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else{let e,t;window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px",document.body.className+=" desktop",console.log("5 three.js: landscape GLRenderer.setSize=",n.videoWidth,n.videoHeight)}var p=new THREE.ObjectControls(d.domElement,new THREE.Object3D);p.enableVerticalRotation(),p.setRotationSpeed(.1),p.setRotationSpeedTouchDevices(.05);var m=function(e){null!=n.controlObject&&0!=n.controlObject?(this.setObjectToMove(n.controlObject),this.setCurrentControllObject(n.currentControllObject)):this.setObjectToMove(null)};p.addEventListener("mouseDown",m),p.addEventListener("onTouchStart",m),n.objectControls=p;let g=new THREE.Vector2,y=(new THREE.Vector2,new THREE.Raycaster);n.getMouse=function(e){let t=n.GLRenderer.domElement,r=t.getBoundingClientRect(),o=new THREE.Vector2;switch(e.type){case"mouseup":case"mousemove":case"mousedown":o.x=(e.clientX-r.left)/t.clientWidth*2-1,o.y=-(e.clientY-r.top)/t.clientHeight*2+1;break;case"touchend":case"touchstart":case"touchmove":o.x=(e.changedTouches[0].clientX-r.left)/t.clientWidth*2-1,o.y=-(e.changedTouches[0].clientY-r.top)/t.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",e.type," not mouseup/touchend, return ")}return o},n.clickEndEvent=function(e){let t=n;if(2==n.objectControlState)return;let r=t.getMouse(e),o={};if(y.setFromCamera(r,a.camera2D),null!=n.currentSceneIndex){let e=n.threeNFTMarkers2D[n.currentSceneIndex],a=y.intersectObject(e,!0);if(0!=a.length){console.log(" intersects2D =",a);let e=0;for(var i=0;i<a.length;i++)a[i].object.defaultTexture&&(e=i);let t=n.getMakarObject(a[e].object);if(console.log("three.js: endEvent: 2D intersects touchObject2D =",t),t.behav){let e=!1;for(let r=0;r<t.behav.length;r++)"CloseAndResetChildren"==t.behav[r].simple_behav&&(e=!0);n.dealAllGroupHide(t,n.currentSceneIndex);for(let r=0;r<t.behav.length;r++){let o;if(t.behav[r].obj_id&&(o=n.getObjectTypeByObj_id(t.behav[r].obj_id)),"ShowImage"==t.behav[r].simple_behav)if("2d"==o.obj_type){var l=Object.assign({},t.behav[r]);l.simple_behav="ShowImage2D",n.triggerEvent(l,e,t)}else"3d"==o.obj_type&&n.triggerEvent(t.behav[r],e,t);else if("ShowText"==t.behav[r].simple_behav){let a=Object.assign({},t.behav[r]);if(a.simple_behav="ShowText2D",n.triggerEvent(a,e,t),"2d"==o.obj_type){let o=Object.assign({},t.behav[r]);o.simple_behav="ShowText2D",n.triggerEvent(o,e,t)}else"3d"==o.obj_type&&n.triggerEvent(t.behav[r],e,t)}else t.behav[r].simple_behav,n.triggerEvent(t.behav[r],e,t)}}return void("button"==t.main_type&&(console.log("three.js: button click ",t),n.clickQuiz2DButton(t)))}y.setFromCamera(r,n.camera);let s=[];for(let e=0;e<n.makarObjects.length;e++){let t=n.makarObjects[e];t.object3D&&s.push(t.object3D)}let c=n.aframeNFTMarkers[n.currentSceneIndex],d=y.intersectObject(c.object3D,!0);if(0!=d.length){console.log("endEvent: intersects =",d);let e=n.getMakarObject(d[0].object),r=e.el;if(console.log("three.js: _setupFunction: endEvent, intersectObject3D=",r.object3D),r&&r.onclickBlock)for(let e=0;e<r.onclickBlock.length;e++)r.onclickBlockState[e]&&(r.onclickBlockState[e]=!1,n.logicList[n.currentSceneIndex].parseBlock(r.onclickBlock[e],(function(){r.onclickBlockState[e]=!0})),o["3d_logic"]=r.onclickBlock[e]);if(e.behav){o["3d_behav"]=e.behav,n.dealAllGroupHide(e,n.currentSceneIndex);let r=!1;for(let t=0;t<e.behav.length;t++)"CloseAndResetChildren"==e.behav[t].simple_behav&&(r=!0);for(let o=0;o<e.behav.length;o++)if("CloseAndResetChildren"!=e.behav[o].simple_behav){let a;if(e.behav[o].obj_id&&(a=t.getObjectTypeByObj_id(e.behav[o].obj_id)),"ShowQuiz"==e.behav[o].behav_type)e.behav[o].scene3DRoot=c,0==e.behav[o].played?t.triggerEvent(e.behav[o],r,e):console.log("VRFunc.js: _setupFunction: endEvent:  Quiz had been played.",e.behav[o].played);else if("Display"==e.behav[o].behav_type)if("2d"==a.obj_type){let a=Object.assign({},e.behav[o]);a.behav_type="Display2D",t.triggerEvent(a,r,e)}else"3d"==a.obj_type&&t.triggerEvent(e.behav[o],r,e);else if("Media"==e.behav[o].behav_type)if("2d"==a.obj_type){let a=Object.assign({},e.behav[o]);a.behav_type="Media2D",t.triggerEvent(a,r,e)}else"3d"==a.obj_type&&t.triggerEvent(e.behav[o],r,e);else t.triggerEvent(e.behav[o],r,e)}}console.log("three.js: touchObject",e)}}0==Object.keys(o).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",o)},n.clickStartEvent=function(e){let t=n;n.objectControlState=1,e.preventDefault();let r=t.getMouse(e);if(g=t.getMouse(e),y.setFromCamera(r,n.camera),null!=n.currentSceneIndex){let e=n.aframeNFTMarkers[n.currentSceneIndex],t=y.intersectObjects([e.object3D],!0);if(0!=t.length){console.log("startEvent: intersects =",t);let e=n.getMakarObject(t[0].object);if(e.behav){let t=!1,r=!0;e.behav&&e.behav.forEach((e=>{"FingerGesture"==e.simple_behav&&(t=!0,r=1==e.active)})),1==t?1==r?(n.controlObject=e,n.currentControllObject=e):n.controlObject=null:(n.controlObject=e,n.currentControllObject=e)}else n.controlObject=e,n.currentControllObject=e}else n.controlObject=null}},n.clickMoveEvent=function(e){let t=n.getMouse(e);1==n.objectControlState&&t.sub(g).length()>.01&&(n.objectControlState=2)};let C=function(){let e=(new Date).getTime(),t=30;if(1==n.enableARRendering){1==n.enableTracking&&l.process(a.video);let r=n.clock.getDelta();for(let e=0;e<n.makarObjects.length;e++)1==n.makarObjects[e].playAnimation&&1==n.makarObjects[e].visible&&n.checkAimation(n.makarObjects[e].children[0],r);a.renderOn(d,null);let o=(new Date).getTime();t=o-e<30?30-(o-e)+1:1}else t=30;setTimeout(C,t)}}})}))}startAR(){let e=arController;e.enableARRendering=!0;let t=document.getElementById("homePage");parent.selectedProject?"XR"==parent.selectedProject.viewMode?e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):"model"==parent.selectedProject.viewMode?e.setViewMode("model").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()}setBehavsGroup(e,t){let r=arController.groupEventTargetDict[t];e.forEach((e=>{""!=e.group&&Number.isFinite(Number(e.group))&&r[e.group]&&r[e.group].objs.push(e)}))}setObjBehav(e,t){e.behav&&Array.isArray(e.behav)&&e.behav.length>0||t.forEach((t=>{t.trigger_obj_id&&t.trigger_obj_id==e.generalAttr.obj_id&&(e.behav&&Array.isArray(e.behav)&&e.behav.length>0?e.behav.push(t):e.behav=[t])})),e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0||t.forEach((t=>{t.obj_id&&t.obj_id==e.generalAttr.obj_id&&("Display"!=t.behav_type&&"Media"!=t.behav_type||(e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0?e.behav_reference.push({behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}):e.behav_reference=[{behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}]))}))}};window.startARProcess=function(e){!function(e){if(parent&&parent.selectedProject&&"string"==typeof parent.selectedProject.proj_id&&"string"==typeof parent.selectedProject.user_id){let t=parent.selectedProject.user_id,r=[parent.selectedProject.proj_id],n={};window.makarUserData=n,n.oneProjData=e;let i=[],l=o.o.getProjDataEditorVer(e);if(3==l.v0&&l.v1>=5){if(e&&Array.isArray(e.target_ids)){let t=a.Z.getTargetList(e.target_ids);i.push(t),t.then((function(e){e.data&&Array.isArray(e.data.targetList)&&(n.targetList=e.data.targetList)}))}let o=a.Z.getProjectSceneList(r),l=a.Z.getUserOnlineResources(t),s=a.Z.getUserResources(t),c=a.Z.GetUserMaterials(t);i.push(o),i.push(l),i.push(s),i.push(c),o.then((function(e){console.log(" _pScenes_: ",e),e.data&&Array.isArray(e.data.projectSceneList)&&1==e.data.projectSceneList.length&&(n.scenesData=e.data.projectSceneList[0])})),l.then((function(e){if(e.data&&Array.isArray(e.data.onlineResourcesList)){let t=e.data.onlineResourcesList;n.onlineResourcesList=t;let r={};for(let e=0;e<t.length;e++)r[t[e].res_id]=t[e];n.userOnlineResDict=r}})),s.then((function(e){if(e.data&&Array.isArray(e.data.resourcesList)){let t=e.data.resourcesList;n.resourcesList=t;let r={};for(let e=0;e<t.length;e++)r[t[e].res_id]=t[e];n.userProjResDict=r}})),c.then((function(e){if(console.log(" _pUM_: ",e),e.data&&Array.isArray(e.data.materials)){let t=e.data.materials;n.materials=t;let r={};for(let e=0;e<t.length;e++)r[t[e].id]=t[e];n.userMaterialDict=r}})),Promise.all(i).then((function(e){window.startSceneController()}))}else console.warn(" _startInitProjAndScene_: VC error ",e)}}(e)},window.startSceneController=function(){console.log(" _startSceneController_  start"),new Promise((function(e){let t=document.createElement("div");t.style.position="absolute",t.setAttribute("id","arDiv"),t.style.top="0px",t.style.width=document.documentElement.clientWidth+"px",t.style.height=Math.round(document.documentElement.clientHeight-0)+"px",document.body.appendChild(t);let r=document.createElement("a-scene");r.setAttribute("id","arfScene"),r.setAttribute("embedded",""),r.setAttribute("renderer","logarithmicDepthBuffer: true; physicallyCorrectLights: false; "),r.setAttribute("vr-mode-ui","enabled: false"),t.appendChild(r);let o=document.createElement("a-light");o.setAttribute("id","ambientLight"),o.setAttribute("type","ambient"),o.setAttribute("color","#808080"),o.setAttribute("ground-color","#fff"),o.setAttribute("intensity",1),r.appendChild(o);let a=document.createElement("a-entity");a.setAttribute("id","oCamera"),a.setAttribute("crossorigin","anonymous"),a.setAttribute("camera",{active:!0,fov:80}),a.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\tmaxPolarAngle: 180; \n\t\t\tminDistance: 0.1; \n\t\t\tmaxDistance: 1000; \n\t\t\tinitialPosition: 0 60 -300;"),r.appendChild(a);let n=document.createElement("a-entity");n.setAttribute("id","cameraForGyro"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("camera",{active:!1}),n.setAttribute("look-controls",{enabled:!0,touchEnabled:!1}),r.appendChild(n);let i=document.createElement("a-assets");i.setAttribute("id","makarAssets"),i.setAttribute("timeout","1000"),i.setAttribute("crossorigin","anonymous"),r.appendChild(i),r.hasLoaded?e():r.addEventListener("loaded",(function(){e()}))})).then((function(){let e=document.getElementById("arfScene"),t=window.makarUserData,r=[];if(o.o.checkSceneIncludeAR(t.scenesData)){let e=new Promise((function(e){console.log(" _startInitProjAndScene_ with AR: load scripts ");let r=setInterval((function(){if(window.ARController){clearInterval(r),console.log(" _startInitProjAndScene_ with AR: ARController load done");let o=new V(t);window.arWrapper=o,e(o)}else console.log(" _startInitProjAndScene_ with AR: ARController load not done")}),500)}));r.push(e)}Promise.all(r).then((function(r){console.log(" _pControllerLoaded_ ",r);let a,i=!1,l=[],s=new n(e.renderer);for(let e=0;e<r.length;e++){let t=r[e];if(0==i&&"ARWrapper"==t.type){i=!0,a=t,s.includeAR(a);let e=a.initARProcess();l.push(e)}}Promise.all(l).then((function(e){let r=o.o.getScenes(t.scenesData);r[0]&&"ar"==r[0].info.type&&(s.setControllerType("AR"),a.arController.enableARRendering=!0,a.startAR())}))}))})),delete window.startSceneController}}}]);