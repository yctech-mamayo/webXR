"use strict";(self.webpackChunkmifly_ar=self.webpackChunkmifly_ar||[]).push([[449],{449:(e,t,a)=>{a.r(t);const r={data:{list:[{res_id:"Cone",res_name:"Cone",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cone/Cone.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cone/Cone.png",default_shader_name:"",size:"30096",create_date:"",show:!0},{res_id:"Cylinder",res_name:"Cylinder",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cylinder/Cylinder.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Cylinder/Cylinder.png",default_shader_name:"",size:"28416",create_date:"",show:!0},{res_id:"Circle",res_name:"Circle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Circle/Circle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Circle/Circle.png",default_shader_name:"",size:"41392",create_date:"",show:!0},{res_id:"Rectangle",res_name:"Rectangle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Rectangle/Rectangle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Rectangle/Rectangle.png",default_shader_name:"",size:"23584",create_date:"",show:!0},{res_id:"Torus",res_name:"Torus",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Torus/Torus.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Torus/Torus.png",default_shader_name:"",size:"34192",create_date:"",show:!0},{res_id:"Square",res_name:"Square",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Square/Square.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Square/Square.png",default_shader_name:"",size:"23568",create_date:"",show:!0},{res_id:"Triangle",res_name:"Triangle",main_type:"model",sub_type:"glb",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Triangle/Triangle.glb",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/3D/Triangle/Triangle.png",default_shader_name:"",size:"22816",create_date:"",show:!0},{res_name:"Cube",sub_type:"glb",show:!1,res_id:"Cube",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Cube.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Cube.png",create_date:"",main_type:"model",size:"2772 bytes"},{res_name:"Capsule",sub_type:"glb",show:!1,res_id:"Capsule",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Capsule.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Capsule.png",create_date:"",main_type:"model",size:"37380 bytes"},{res_name:"Sphere",sub_type:"glb",show:!1,res_id:"Sphere",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Sphere.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/Sphere.png",create_date:"",main_type:"model",size:"35016 bytes"},{res_id:"img_fb_1",sub_type:"png",show:!0,res_name:"FB icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_fb_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_fb_1.png",create_date:"",main_type:"image",size:"133759 bytes"},{res_id:"img_ig_1",sub_type:"png",show:!0,res_name:"IG icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_ig_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_ig_1.png",create_date:"",main_type:"image",size:"194879 bytes"},{res_id:"img_line_1",sub_type:"png",show:!0,res_name:"Line icon",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_line_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_line_1.png",create_date:"",main_type:"image",size:"163576 bytes"},{res_id:"img_web_1",sub_type:"png",show:!0,res_name:"Web icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_1.png",create_date:"",main_type:"image",size:"112540 bytes"},{res_id:"img_map_1",sub_type:"png",show:!0,res_name:"GPS icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_1.png",create_date:"",main_type:"image",size:"99764 bytes"},{res_id:"img_phone_1",sub_type:"png",show:!0,res_name:"Phone icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_1.png",create_date:"",main_type:"image",size:"75327 bytes"},{res_id:"img_mail_1",sub_type:"png",show:!0,res_name:"Mail icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_1.png",create_date:"",main_type:"image",size:"113394 bytes"},{res_id:"img_home_1",sub_type:"png",show:!0,res_name:"Home icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_1.png",create_date:"",main_type:"image",size:"103003 bytes"},{res_id:"img_arrow_1",sub_type:"png",show:!0,res_name:"Arrow icon_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_1.png",create_date:"",main_type:"image",size:"80170 bytes"},{res_id:"img_button_back_1",sub_type:"png",show:!0,res_name:"Back button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_1.png",create_date:"",main_type:"image",size:"91617 bytes"},{res_id:"img_button_next_1",sub_type:"png",show:!0,res_name:"Next button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_1.png",create_date:"",main_type:"image",size:"89832 bytes"},{res_id:"img_button_play_1",sub_type:"png",show:!0,res_name:"Play button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_1.png",create_date:"",main_type:"image",size:"89261 bytes"},{res_id:"img_button_start_1",sub_type:"png",show:!0,res_name:"Start button_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_1.png",create_date:"",main_type:"image",size:"92002 bytes"},{res_id:"img_dialog_1",sub_type:"png",show:!0,res_name:"Msg bubble_Teal",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_1.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_1.png",create_date:"",main_type:"image",size:"147377 bytes"},{res_id:"img_web_2",sub_type:"png",show:!0,res_name:"Web icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_web_2.png",create_date:"",main_type:"image",size:"17544 bytes"},{res_id:"img_map_2",sub_type:"png",show:!0,res_name:"GPS icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_map_2.png",create_date:"",main_type:"image",size:"17371 bytes"},{res_id:"img_phone_2",sub_type:"png",show:!0,res_name:"Phone icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_phone_2.png",create_date:"",main_type:"image",size:"11311 bytes"},{res_id:"img_mail_2",sub_type:"png",show:!0,res_name:"Mail icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_mail_2.png",create_date:"",main_type:"image",size:"10518 bytes"},{res_id:"img_home_2",sub_type:"png",show:!0,res_name:"Home icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_home_2.png",create_date:"",main_type:"image",size:"13172 bytes"},{res_id:"img_arrow_2",sub_type:"png",show:!0,res_name:"Arrow icon_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_arrow_2.png",create_date:"",main_type:"image",size:"8860 bytes"},{res_id:"img_button_back_2",sub_type:"png",show:!0,res_name:"Back button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_back_2.png",create_date:"",main_type:"image",size:"7059 bytes"},{res_id:"img_button_next_2",sub_type:"png",show:!0,res_name:"Next button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_next_2.png",create_date:"",main_type:"image",size:"5536 bytes"},{res_id:"img_button_play_2",sub_type:"png",show:!0,res_name:"Play button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_play_2.png",create_date:"",main_type:"image",size:"5919 bytes"},{res_id:"img_button_start_2",sub_type:"png",show:!0,res_name:"Start button_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_button_start_2.png",create_date:"",main_type:"image",size:"7060 bytes"},{res_id:"img_dialog_2",sub_type:"png",show:!0,res_name:"Msg bubble_Gray",res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_2.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/defaultImg/img_dialog_2.png",create_date:"",main_type:"image",size:"3788 bytes"},{res_name:"Text",sub_type:"txt",show:!1,res_id:"Text",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Text.png",create_date:"",main_type:"text",size:"2772 bytes"},{res_name:"Light",sub_type:"light",show:!1,res_id:"Light",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Light.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Light.png",create_date:"",main_type:"light",size:"0 bytes"},{res_name:"Curve",sub_type:"curve",show:!1,res_id:"Curve",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Light.glb",default_shader_name:"",snapshot_url:"",create_date:"",main_type:"curve",size:"0 bytes"},{res_name:"ch_Bojue",sub_type:"glb",show:!1,res_id:"ch_Bojue",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Bojue.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Bojue.png",create_date:"",main_type:"model",size:"360240 bytes"},{res_name:"ch_Fei",sub_type:"glb",show:!1,res_id:"ch_Fei",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Fei.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Fei.png",create_date:"",main_type:"model",size:"348876 bytes"},{res_name:"ch_Lina",sub_type:"glb",show:!1,res_id:"ch_Lina",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Lina.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Lina.png",create_date:"",main_type:"model",size:"384992 bytes"},{res_name:"ch_Poyuan",sub_type:"glb",show:!1,res_id:"ch_Poyuan",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Poyuan.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Poyuan.png",create_date:"",main_type:"model",size:"369416 bytes"},{res_name:"ch_Roger",sub_type:"glb",show:!1,res_id:"ch_Roger",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/ch_Roger.glb",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/modelSnapshots/ch_Roger.png",create_date:"",main_type:"model",size:"371072 bytes"},{res_name:"FB_icon",sub_type:"png",show:!1,res_id:"FB_icon",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/FB_icon.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/FB_icon.png",create_date:"",main_type:"image",size:"4235 bytes"},{res_name:"Line_icon",sub_type:"png",show:!1,res_id:"Line_icon",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/Line_icon.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/Line_icon.png",create_date:"",main_type:"image",size:"8855 bytes"},{res_name:"MakAR_Room",sub_type:"png",show:!1,res_id:"MakAR_Room",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Room.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Room.png",create_date:"",main_type:"image",size:"22787 bytes"},{res_name:"MakAR_Call",sub_type:"png",show:!1,res_id:"MakAR_Call",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Call.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Call.png",create_date:"",main_type:"image",size:"22432 bytes"},{res_name:"MakAR_Mail",sub_type:"png",show:!1,res_id:"MakAR_Mail",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/MakAR_Mail.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/MakAR_Mail.png",create_date:"",main_type:"image",size:"21586 bytes"},{res_name:"SphericalImage",sub_type:"png",show:!1,res_id:"SphericalImage",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/sceneDefaultImages/SphericalImage.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/snapshots/imageSnapshots/SphericalImage.png",create_date:"",main_type:"spherical_image",size:"4258816 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_name:"InputField",sub_type:"inputfield",show:!1,res_id:"InputField",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/inputField/inputfield.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/inputField/inputfield.png",create_date:"",main_type:"inputfield",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_name:"Button",sub_type:"button",show:!1,res_id:"Button",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",create_date:"",main_type:"button",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Background",res_name:"PointCard_Background",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Point_Before",res_name:"PointCard_Point_Before",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_Before.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_Before.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"PointCard_Point_After",res_name:"PointCard_Point_After",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_After.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_DefaultPoint_After.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"camera",res_name:"Camera",main_type:"camera",sub_type:"camera",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/Camera/Camera.glb",default_shader_name:"",snapshot_url:"",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"ScratchCard_Background",res_name:"ScratchCard_Background",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"ScratchCard_Default",res_name:"ScratchCard_Default",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"AcratchCard_Default",res_name:"AcratchCard_Default",main_type:"image",sub_type:"png",show:!1,res_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/AcratchCard_Default.png",default_shader_name:"",snapshot_url:"https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/AcratchCard_Default.png",create_date:"",size:"0 bytes"},{comment:"這是一個特殊物件，該物件不展示給使用者使用，但工廠會使用到",res_id:"Curve_Cell",res_name:"Cell",main_type:"curve_cell",sub_type:"curve_cell",show:!1,res_url:"",default_shader_name:"",snapshot_url:"",create_date:"",size:"0 bytes"}]}};function o(e){for(var t="",a=0;a<e;a++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}async function n(e){let t=await fetch(e,{method:"HEAD"});return console.log(" _UrlExistsFetch: ret ",t),!!t.status&&"200"==t.status}function i(e){return"object"==typeof e&&"function"==typeof e.then}function s(e){let t=!1;if(r&&r.data&&Array.isArray(r.data.list)&&r.data.list.forEach((a=>{a.res_id==e.res_id&&(e.main_type=a.main_type,e.sub_type=a.sub_type,e.res_url=a.res_url,t=!0)})),console.log("  .getRes ",t,e),!t)switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image";break;default:console.log("image: default, obj=",e)}}function l(e){let t=!1;if(r&&r.data&&Array.isArray(r.data.list)&&r.data.list.forEach((a=>{a.res_id==e.res_id&&(e.main_type=a.main_type,e.sub_type=a.sub_type,e.res_url=a.res_url,t=!0)})),console.log("  .getRes ",t,e),!t)switch(e.res_id){case"quiz":e.main_type="empty",e.sub_type="quiz";break;case"point_card":e.main_type="empty",e.sub_type="point_card";break;case"scratch_card":e.main_type="empty",e.sub_type="scratch_card";break;case"Curve":e.main_type="curve";break;default:if(e.res_gltf_resource)break;e.generalAttr?e.generalAttr.obj_type||(e.generalAttr.obj_type="3d"):e.generalAttr={obj_type:"3d"},e.transformAttr?e.transformAttr.transform||(e.transformAttr.transform=["0,0,0","0,0,0,1","1,1,1"]):e.transformAttr={transform:["0,0,0","0,0,0,1","1,1,1"]},e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb"}}var c=a(325),d=a(19);const u=class{constructor(e){let t=this;t.GLRenderer=e,t.ARC=null,t.VRC=null,t.XRC=null,t.currentSceneController=null,t.currentSceneType="",t.mouse=new THREE.Vector2;let a=e.domElement;a.addEventListener("touchend",t.endEvent.bind(t),!1),a.addEventListener("mouseup",t.endEvent.bind(t),!1),a.addEventListener("touchmove",t.moveEvent.bind(t),!1),a.addEventListener("mousemove",t.moveEvent.bind(t),!1),a.addEventListener("touchstart",t.startEvent.bind(t),!1),a.addEventListener("mousedown",t.startEvent.bind(t),!1)}includeAR(e){this.ARC=e}includeVR(e){this.VRC=e}includeXR(e){this.XRC=e}setControllerType(e){let t=this;switch(t.currentSceneType=e,e){case"AR":t.ARC?t.currentSceneController=t.ARC:console.warn("_setControllerType_: this project do not contain AR.");break;case"VR":t.VRC?t.currentSceneController=t.VRC:console.warn("_setControllerType_: this project do not contain VR.");break;case"XR":t.XRC?t.currentSceneController=t.XRC:console.warn("_setControllerType_: this project do not contain XR.");break;default:console.warn("_setControllerType_: type unknow",e)}}endEvent(e){e.preventDefault();let t=this;switch(t.currentSceneType){case"AR":t.ARC.arController.clickEndEvent&&t.ARC.arController.clickEndEvent(e);break;case"VR":t.VRC.clickEndEvent&&t.VRC.clickEndEvent(e);break;case"XR":t.XRC.clickEndEvent&&t.XRC.clickEndEvent(e)}}moveEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickMoveEvent&&t.ARC.arController.clickMoveEvent(e);break;case"VR":t.VRC.clickMoveEvent&&t.VRC.clickMoveEvent(e);break;case"XR":t.XRC.clickMoveEvent&&t.XRC.clickMoveEvent(e)}}startEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickStartEvent&&t.ARC.arController.clickStartEvent(e);break;case"VR":t.VRC.clickStartEvent&&t.VRC.clickStartEvent(e);break;case"XR":t.XRC.clickStartEvent&&t.XRC.clickStartEvent(e)}}};function m(e,t,a,r,o){let n=e.object3D;if(n){e.setAttribute("position",t),e.setAttribute("scale",r);let a=new THREE.Euler;a.setFromQuaternion(o),a.x=-a.x,a.y=-a.y;let i=new THREE.Quaternion;i.setFromEuler(a),n.setRotationFromQuaternion(i)}}function p(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("VRFunc.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("VRFunc.js: _checkGLTFMaterialIndex: material error",t);let a=t.mesh_idx,r=t.primitive_idx,o=-1,n=-1,i=e.object3D.children[0].ModelJson.nodes,s=-1;for(let e=0;e<i.length;e++)if("number"==typeof i[e].mesh&&s++,a==s){o=i[e].mesh;break}if(o>=0){let t=e.object3D.children[0].ModelJson.meshes[o];if(t&&t.primitives){let e=t.primitives[r];e&&e.material>=0&&(n=e.material,console.log("VRFunc.js: _checkGLTFMaterialIndex: materialIndex=",n))}}return[n,o]}function h(e,t,a,r,o){let n=t.getObject3D("mesh");if(a.materialAttr&&a.materialAttr.materials)for(let r=0;r<a.materialAttr.materials.length;r++)if(n.ModelJson){let o=p(t,a.materialAttr.materials[r]);if(!a.materialAttr.materials[r].material_idx){b(e,t,a,n,r);continue}_(e,t,a.materialAttr.materials[r].material_idx,o)}}function g(e,t,a,r,o,i){let s=this,l=c.F.getProjDataEditorVer(arController.currentProjData);return arController.cubeTex,arController.cameraTexture,new Promise((function(c){n(t.res_url).then((d=>{if(1==d){let r=[];if(console.log(" __loadGLTFModel__:  ",t),""==t.res_url||"glb"!=t.sub_type&&"gltf"!=t.sub_type&&"gltf_sketchFab"!=t.sub_type&&"gltf_sketchfab"!=t.sub_type&&"gltf_poly"!=t.sub_type)return console.log(" _loadGLTFModel_: obj not support ",t),void c(-1);let d=s.gcssTargets.dpi[e.GCSSID],u=s.gcssTargets.width[e.GCSSID],p=s.gcssTargets.height[e.GCSSID],g=(s.sceneTargetList[e.GCSSID].sceneIndex,document.createElement("a-entity")),_=document.getElementById("makarAssets"),b=document.createElement("a-asset-item");if(b.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),b.setAttribute("src",t.res_url),b.setAttribute("response-type","arraybuffer"),b.setAttribute("crossorigin","anonymous"),_.appendChild(b),!t.res_url)return;g.setAttribute("gltf-model","#"+t.generalAttr.obj_id+"_"+t.res_id);let f,y=null;if(l&&3==l.v0&&l.v1>=5){if(g.setAttribute("id",t.generalAttr.obj_id),t.animationAttr){y=[];for(let e=0;e<t.animationAttr.length;e++)(t.animationAttr[e].is_default||t.animationAttr[e].is_active)&&(y.push({idle:t.animationAttr[e].uid,loop:t.animationAttr[e].uid,uid:t.animationAttr[e].uid,changed:!1,reset:!0,count:0}),f=t.animationAttr[e].animation_name);for(let e=0;e<t.animationAttr.length;e++)y.push({name:t.animationAttr[e].name,animationName:t.animationAttr[e].animation_name,startTime:t.animationAttr[e].start_time,endTime:t.animationAttr[e].end_time,uid:t.animationAttr[e].uid});g.setAttribute("animation-mixer","clip: "+f)}t.behav||t.generalAttr.logic?g.setAttribute("class","clickable"):g.setAttribute("class","unclickable")}if(g.setAttribute("crossorigin","anonymous"),g.setAttribute("shadow",""),t.model_shift){let e=(new THREE.Vector3).fromArray(t.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(o),a.add(e)}if(s.makarObjects.push(g),g.addEventListener("model-loaded",(function(e){if(e.target==e.currentTarget){let _=s.arfScene.renderer.capabilities.getMaxAnisotropy();g.object3D.children[0].scale.set(2540/d,2540/d,2540/d),g.object3D.children[0].rotation.y=Math.PI;let b=new THREE.Vector3;if(t.generalAttr.obj_parent_id){g.object3D.obj_parent_id=t.generalAttr.obj_parent_id,b.addScaledVector(a,2540/d);let e=b.z;b.z=-e,m(g,b,0,o,i)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),b.addScaledVector(a,2540/d);break;case"3.0.0":o.multiplyScalar(2),b.addScaledVector(a,5080/d);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let e=b.y,t=b.z;b.y=t,b.z=e,m(g,b,0,o,i),g.object3D.position.add(new THREE.Vector3(25.4*u/d/2,25.4*p/d/2,0)),g.object3D.rotation.x+=90*Math.PI/180,console.log("_loadGLTFModel_: loaded: no parent prs=",g.object3D.position,g.object3D.rotation,g.object3D.scale)}let f=g.object3D;if(f.originTransform={position:f.position.clone(),rotation:f.rotation.clone(),scale:f.scale.clone()},g.object3D.makarType="model",g.object3D.makarObject=!0,t.behav&&(g.object3D.behav=t.behav),t.behav_reference&&(g.object3D.behav_reference=t.behav_reference),e.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=_,e.material.map.needsUpdate=!0)})),g.object3D){let a=g.getObject3D("mesh");if(a.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),console.log("GLTFModelModule.js _loadGLTFModel, obj.materialAttr=",t.materialAttr),t.materialAttr.materials&&t.materialAttr.materials.length>0){console.log("obj.materialAttr.materials",t.materialAttr.materials);let e=!1;if(t.materialAttr.materials.forEach((t=>{t.material_idx||(e=!0)})),e)h(s,g,t);else{let e=function(e,t){let a=new Promise((function(a){if(0!=t.materialAttr.materials.length){let r=[];for(let a=0;a<t.materialAttr.materials.length;a++){let o=t.materialAttr.materials[a].material_idx;e.materials_texture_dict[o]={};let i=e.userMaterialDict[o];for(let t=0;t<i.properties.length;t++){let a,s=null;"_MainTex"!=i.properties[t].key&&"_MetallicGlossMap"!=i.properties[t].key&&"_SpecGlossMap"!=i.properties[t].key&&"_BumpMap"!=i.properties[t].key&&"_ParallaxMap"!=i.properties[t].key&&"_OcclusionMap"!=i.properties[t].key&&"_EmissionMap"!=i.properties[t].key&&"_ToonShade"!=i.properties[t].key||(s=i.properties[t].value,a=i.properties[t].scale.split(",").map((e=>Number(e))));let l=new Promise((function(r){s?n(s).then((n=>{if(1==n){let n=(new THREE.TextureLoader).load(s,(function(){n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.flipY=!1,n.repeat.x=a[0],n.repeat.y=a[1],n.format=THREE.RGBAFormat,n.needsUpdate=!0,r(n)}));"_MainTex"==i.properties[t].key?e.materials_texture_dict[o].mainTex=n:"_MetallicGlossMap"==i.properties[t].key?e.materials_texture_dict[o].metalnessMap=n:"_SpecGlossMap"==i.properties[t].key?e.materials_texture_dict[o].specGlossMap=n:"_BumpMap"==i.properties[t].key?e.materials_texture_dict[o].bumpMap=n:"_ParallaxMap"==i.properties[t].key?e.materials_texture_dict[o].parallaxMap=n:"_OcclusionMap"==i.properties[t].key?e.materials_texture_dict[o].aoMap=n:"_EmissionMap"==i.properties[t].key?e.materials_texture_dict[o].emissionMap=n:"_ToonShade"==i.properties[t].key&&(e.materials_texture_dict[o].toonShade=n)}else console.log("_loadMaterialTexture: texture url not exists."),r(1)})):r(1)}));r.push(l)}}Promise.all(r).then((function(e){console.log("GLTFModleModule.js: _loadMaterials: textures then ret = ",e),a(r)}))}else console.log("_loadMaterialTexture: obj no material texture"),a(1)}));return a}(s,t);r.push(e),e.then((e=>{h(s,g,t)}))}}else if(t.default_shader_name)switch(console.log("run default_shader_name: ",t.default_shader_name),t.default_shader_name){case"standard":break;case"Unlit/Transparent":a.ModelJson&&a.traverse((e=>{e.material&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.opacity=1,e.material.alphaTest=.5)}));break;case"Unlit/Transparent Cutout":a.ModelJson&&a.traverse((e=>{e.material&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.opacity=.5,e.material.depthWrite=!1,e.renderOrder=1)}));break;case"Unlit/Color":a.ModelJson&&a.traverse((e=>{e.material&&(e.material=new THREE.MeshBasicMaterial({color:e.material.color,name:e.material.name,skinning:e.material.skinning}))}));break;case"Unlit/Texture":a.traverse((e=>{e.material&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}))}else if(a.ModelJson&&a.ModelJson.materials){console.log("run alphaMode: ",a.ModelJson.materials);let e=g.sceneEl.renderer;for(let t=0;t<a.ModelJson.materials.length;t++)if(a.ModelJson.materials[t].alphaMode)switch(a.ModelJson.materials[t].alphaMode){case"OPAQUE":a.traverse((a=>{if(a.material){let r=a.material.name.split("_");r[r.length-1]==t&&(a.material.opacity=1,e.setClearAlpha(1),a.material.blending=THREE.CustomBlending,a.material.blendEquation=THREE.AddEquation,a.material.blendSrc=THREE.OneFactor,a.material.blendDst=THREE.ZeroFactor,a.material.blendSrcAlpha=THREE.ZeroFactor,a.material.blendDstAlpha=THREE.OneFactor)}}));break;case"MASK":a.traverse((a=>{if(a.material){let r=a.material.name.split("_");r[r.length-1]==t&&(a.material.opacity=1,a.material.alphaTest=.5,e.setClearAlpha(1),a.material.blending=THREE.CustomBlending,a.material.blendEquation=THREE.AddEquation,a.material.blendSrc=THREE.OneFactor,a.material.blendDst=THREE.ZeroFactor,a.material.blendSrcAlpha=THREE.ZeroFactor,a.material.blendDstAlpha=THREE.OneFactor,a.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:a.material.map,alphaTest:.5}))}}));break;case"BLEND":a.traverse((e=>{if(e.material){let a=e.material.name.split("_");a[a.length-1]==t&&(e.material.opacity=.5,e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.renderOrder=1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:.5}))}}))}}l&&3==l.v0&&l.v1>=5&&t.generalAttr&&1==t.generalAttr.logic&&(f.resetProperty=function(){h(s,g,t)}),Array.isArray(e.detail.model.animations)&&e.detail.model.animations.length>0&&!g.getAttribute("animation-mixer")&&(console.log("_loadGLTFModel_: the model with animation but no animation-mixer, probabily older version of editor "),g.setAttribute("animation-mixer","clip: "+e.detail.model.animations[0].name),y=[],y.push({changed:!1,idle:"mifly168",uid:"mifly168"}),y.push({animationName:e.detail.model.animations[0].name,name:e.detail.model.animations[0].name,endTime:e.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),e.detail.model.animationSlices=y,Promise.all(r).then((function(){c(g)}))}}})),0==t.generalAttr.active&&(g.setAttribute("visible",!1),g.setAttribute("class","unclickable")),t.generalAttr.obj_parent_id){let e=setInterval((function(){let a=document.getElementById(t.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(g),window.clearInterval(e))}),1)}else e.appendChild(g)}else console.log("_loadGLTFModel_: , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",t.material=[],g(e,t,a,r,o,i),c(1)}))}))}function _(e,t,a,r){let o=t.getObject3D("mesh"),n=e.userMaterialDict[a],i={};console.log("material_idx",n);let s=r[0],l=r[1];i.name=n.res_name,i.shader=n.shader;for(let t=0;t<n.properties.length;t++)switch(n.properties[t].key){case"alphaMode":break;case"doubleSided":i.doubleSided=n.properties[t].value;break;case"_Color":let r=n.properties[t].value.split(",");i.color=new THREE.Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2])),i.alpha=parseFloat(r[3]);break;case"_MainTex":i.map=e.materials_texture_dict[a].mainTex;break;case"_Cutoff":i.cutoff=n.properties[t].value;break;case"_Glossiness":i.smoothness=n.properties[t].value;break;case"_SpecGlossMap":i.specGlossMap=e.materials_texture_dict[a].specGlossMap;case"_Metallic":i.metallic=n.properties[t].value;break;case"_MetallicGlossMap":i.metalnessMap=e.materials_texture_dict[a].metalnessMap;break;case"_SpecularHighlights":i.specularHighlights=n.properties[t].value;break;case"_GlossyReflections":i.glossyReflections=n.properties[t].value;break;case"_BumpScale":i.bumpscale=n.properties[t].value;break;case"_BumpMap":i.bumpMap=e.materials_texture_dict[a].bumpMap;break;case"_Parallax":i.parallax=n.properties[t].value;break;case"_ParallaxMap":i.parallaxMap=e.materials_texture_dict[a].parallaxMap;break;case"_OcclusionStrength":i.aoMapIntensity=n.properties[t].value;break;case"_OcclusionMap":i.aoMap=e.materials_texture_dict[a].aoMap;break;case"_EmissionColor":let o=n.properties[t].value.split(",");i.emissionColor=new THREE.Color(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]));break;case"_EmissionMap":i.emissionMap=e.materials_texture_dict[a].emissionMap;break;case"_Mode":i.mode=n.properties[t].value;break;case"_ToonShade":i.toonShade=e.materials_texture_dict[a].toonShade;break;case"_TintColor":1==n.properties[t].value?i.tintColor=!0:i.tintColor=!1;break;case"_Brightness":i.brightness=n.properties[t].value;break;case"_OutlineColor":let s=n.properties[t].value.split(",");i.outlineColor=new THREE.Color(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2]));break;case"_Outline":i.outlineWidth=n.properties[t].value}switch(console.log(i),i.shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==s&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:i.color,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":case"Autodesk Interactive":var c=t.sceneEl.renderer;o.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==s&&t.meshIdx==l&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:i.map?i.map:null,emissive:i.emissionColor?i.emissionColor:t.material.emissive,emissiveMap:i.emissionMap?i.emissionMap:null,normalMap:t.material.normalMap,bumpMap:i.bumpMap?i.bumpMap:null,flatShading:t.material.flatShading}),t.material.color=i.color,i.metalnessMap?t.material.metalnessMap=i.metalnessMap:(t.material.metalness=i.metallic,t.material.roughness=1-i.smoothness),t.material.bumpscale=i.bumpscale,t.material.displacementMap=i.displacementMap?i.displacementMap:null,i.aoMap&&(t.geometry.attributes.uv2=t.geometry.attributes.uv.clone(),t.material.aoMap=i.aoMap,t.material.aoMapIntensity=i.aoMapIntensity),t.material.envMap=e.cubeTex.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=i.doubleSided?THREE.DoubleSide:THREE.FrontSide,t.material.transparent=!0,t.material.map&&(THREE.GammaEncoding&&(t.material.map.encoding=THREE.GammaEncoding),t.material.map.needsUpdate=!0),0==i.mode?(t.material.opacity=1,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==i.mode?(t.material.opacity=1,t.material.alphaTest=i.cutoff,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})):2==i.mode?(t.material.opacity=i.alpha,t.material.depthWrite=!1,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})):3==i.mode&&(console.log("土石流?"),t.material.opacity=Math.max(i.alpha,i.metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:i.map,alphaTest:i.cutoff})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==s&&e.meshIdx==l&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==s&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:i.map}),e.material.opacity=1,e.material.alphaTest=i.cutoff)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==s&&e.meshIdx==l&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:i.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/Vertex":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==s&&e.meshIdx==l&&(e.material=new THREE.MeshStandardMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning}),e.material.vertexColors=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==s&&t.meshIdx==l&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.cameraTexture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"TSF/BaseOutline1":e.needsCullFaceBack=!0;let r=t.object3D.clone(!0);r.obj_id=t.getAttribute("id"),o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==s&&e.meshIdx==l){let t=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning});t.onBeforeCompile=function(e){e.uniforms.toonShade={value:i.toonShade},e.uniforms.tintColor={value:i.tintColor},e.uniforms.color={value:i.color},e.uniforms.brightness={value:i.brightness},e.vertexShader="varying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",["#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <begin_vertex>"].join("\n")),e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","vProjection = normalize( transformedNormal );","vProjection.y = -vProjection.y;","vProjection.z = -vProjection.z;"].join("\n")),e.fragmentShader="uniform sampler2D toonShade;\nuniform bool tintColor;\nuniform vec3 color;\nuniform float brightness;\nvarying vec3 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <fog_fragment>",["#include <fog_fragment>","\tvec2 sampleUV;","   vec4 tmp;","\tsampleUV.x = vProjection.x*0.5 + 0.5;","\tsampleUV.y = vProjection.y*0.5 + 0.5;","   tmp = texture2D(toonShade, sampleUV);","   if(tintColor){","       tmp.x = tmp.x * color.x * brightness;","       tmp.y = tmp.y * color.y * brightness;","       tmp.z = tmp.z * color.z * brightness;","   }","   else{","       tmp.x = tmp.x * brightness;","       tmp.y = tmp.y * brightness;","       tmp.z = tmp.z * brightness;","   }","\tgl_FragColor.x *= tmp.x;","\tgl_FragColor.y *= tmp.y;","\tgl_FragColor.z *= tmp.z;"].join("\n"))},t.map=i.map,e.material=t}}})),r.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==s&&e.meshIdx==l){let t=e.material.clone();t.onBeforeCompile=function(e){e.uniforms.boarderColor={value:i.outlineColor},e.uniforms.boarderWidth={value:i.outlineWidth},e.vertexShader="uniform float boarderWidth;\nvarying vec3 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","mvPosition.xyz += vNormal * boarderWidth * 0.01;","gl_Position = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform vec3 boarderColor;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","gl_FragColor = vec4(boarderColor, 1.0);"].join("\n"))},e.material=t}}}));break;case"Blocks/Basic":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==s&&e.meshIdx==l){let t=e.material.clone();t.color=i.color,e.material=t}}}));break;case"Blocks/BlocksGlass":case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");if(t[t.length-1]==s&&e.meshIdx==l){let t=e.material.clone();t.color=i.color,e.material=t,e.material.depthWrite=!1,e.renderOrder=1}}}));break;default:console.log(`The shader of id ${a} material is not supported currently.`)}}function b(e,t,a,r,o){let n=function(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("three.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("three.js: _checkGLTFMaterialIndex: material error",t);let a=t.rendererIndex,r=t.materialIndex,o=-1,n=-1,i=e.object3D.children[0].ModelJson.nodes,s=-1;for(let e=0;e<i.length;e++)if("number"==typeof i[e].mesh&&s++,a==s){o=i[e].mesh;break}if(o>=0){let t=e.object3D.children[0].ModelJson.meshes[o];if(t&&t.primitives){let e=t.primitives[r];e.material>=0&&(n=e.material)}}return n}(t,a.materialAttr.materials[o]);if(Number.isInteger(n)){console.log("_loadMaterial_v340 materialIndex=",n);let s=a.materialAttr.materials[o].color,l=[1,1,1,1];("string"==typeof s||s instanceof String)&&s.split(",").length>=3&&(l=s.split(","));let c=new THREE.Color(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]));switch(a.materialAttr.materials[o].shader){case"Unlit/Color":r.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:c,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":console.log("obj.materialAttr.materials[i]",a.materialAttr.materials[o]);var i=t.sceneEl.renderer;r.traverse((t=>{if(t.material){let r=t.material.name.split("_");r[r.length-1]==n&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:t.material.map,emissive:t.material.emissive,emissiveMap:t.material.emissiveMap,normalMap:t.material.normalMap}),t.material.color=c,t.material.metalness=a.materialAttr.materials[o].metallic,t.material.roughness=1-a.materialAttr.materials[o].smoothness,t.material.envMap=e.cubeTex.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=THREE.DoubleSide,t.material.transparent=!0,t.material.map&&(THREE.GammaEncoding&&(t.material.map.encoding=THREE.GammaEncoding),t.material.map.needsUpdate=!0),0==a.materialAttr.materials[o].mode?(t.material.opacity=1,i.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==a.materialAttr.materials[o].mode?(t.material.opacity=1,t.material.alphaTest=a.materialAttr.materials[o].cut_off,i.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})):2==a.materialAttr.materials[o].mode?(t.material.opacity=parseFloat(l[3]),console.log("node.material.opacity",t.material.opacity),t.material.depthWrite=!1,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})):3==a.materialAttr.materials[o].mode&&(t.material.opacity=Math.max(parseFloat(l[3]),a.materialAttr.materials[o].metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.renderOrder=1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:a.materialAttr.materials[o].cut_off})))}}));break;case"Unlit/Transparent":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Unlit/Transparent Cutout":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":r.traverse((t=>{if(t.material){let a=t.material.name.split("_");a[a.length-1]==n&&(e.needsRenderTarget=!0,t.material.onBeforeCompile=function(t){t.uniforms.tEquirect={value:e.skyRenderTarget.texture},t.vertexShader="varying vec4 vProjection;\n"+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),t.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;case"Blocks/BlocksGlass":r.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1,e.renderOrder=1)}}));break;default:console.log(`The shader of no. ${o} material is not supported currently.`)}}}function f(e,t,a,r,o,n,i,s){const l=this;let c=l.gcssTargets.dpi[e.GCSSID],d=l.gcssTargets.width[e.GCSSID],u=l.gcssTargets.height[e.GCSSID],p=document.createElement("a-entity");if(t.behav||t.generalAttr.logic?p.setAttribute("class","clickable"):p.setAttribute("class","unclickable"),p.setAttribute("id",t.generalAttr.obj_id),p.setAttribute("crossorigin","anonymous"),p.setAttribute("shadow",""),0==t.generalAttr.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable")),l.makarObjects.push(p),p.addEventListener("loaded",(r=>{console.log("_loadWebViewNotSupport ytEntity.object3D",p.object3D);let n,h,g,_,b=new THREE.Vector3;if(t.generalAttr.obj_parent_id){p.object3D.obj_parent_id=t.generalAttr.obj_parent_id,b.addScaledVector(o,2540/c);let e=b.z;b.z=-e,m(p,b,0,i.multiplyScalar(.9),s)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),b.addScaledVector(o,2540/c);break;case"3.0.0":i.multiplyScalar(2),b.addScaledVector(o,5080/c);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let e=b.y,t=b.z;b.y=t,b.z=e,m(p,b,0,i.multiplyScalar(.9),s),p.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),p.object3D.rotation.x+=90*Math.PI/180}console.log("_loadWebViewNotSupport ytEntity loaded"),p.object3D.makarObject=!0,p.object3D.makarType="WebView",t.behav&&(p.object3D.behav=t.behav),h=1.2,g=1.2,n=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.2,1.2,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),n.scale.set(25,25,1),t.behav_reference&&(n.behav_reference=t.behav_reference),p.object3D.add(n),console.log("_loadWebViewNotSupport ytEntity loaded",n),_=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.2,1.2,0),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.1})),p.object3D.add(_),_.position.set(0,0,0),_.rotation.set(0,0,0),_.scale.set(23.75,23.75,1),console.log("_loadWebViewNotSupport ytEntity loaded",_);let f={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"WebView is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj_${l.currentSceneIndex}_${a}`,obj_name:t.generalAttr.obj_name+"_tempTexObj",obj_type:"3d",interactable:!1,obj_parent_id:t.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:["0,0,0","0,0,0,1","1,1,1"],rect_transform:[],simulated_rotation:"0,0,0"},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};l.loadText3D(e,f,new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),new THREE.Quaternion,!0).then((e=>{const t=e.object3D.clone();p.object3D.add(t),t.position.set(0,0,.005)}))})),t.generalAttr.obj_parent_id){let e=setInterval((()=>{let a=document.getElementById(t.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(p),window.clearInterval(e))}),1)}else e.appendChild(p),console.log("_loadWebViewNotSupport ytEntity loaded",p)}function y(e,t,a,r,o,n,i){const s=this,l=c.F.getObj2DTransform(s.editor_version,t,a,r,o,n,i);let d,u,m,p,h,g;if(console.log("呼叫 getObj2DTransform trans=",l),!l)return!1;d=l.rectP,u=l.rectSizeDelta,m=l.rectScale,p=l.rectR,i.x=l.rectScale[0],i.y=l.rectScale[1];let _=s.scaleRatioXY;h=u[0]*_,g=u[1]*_;let b,f,y=new THREE.Object3D;y.makarObject=!0,y.makarType="WebView2D",y.obj_id=t.generalAttr.obj_id,t.behav&&(y.behav=t.behav),0==t.generalAttr.active&&(y.visible=!1),b=new THREE.Mesh(new THREE.PlaneBufferGeometry(h,g,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),f=new THREE.Mesh(new THREE.PlaneBufferGeometry(h,g,0),new THREE.MeshBasicMaterial({color:11184810,side:THREE.DoubleSide,transparent:!0,opacity:.1})),f.position.set(0,0,0),f.rotation.set(0,0,0),f.scale.set(.9,.9,.9),y.add(b),y.add(f);let w={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"WebView is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj2D_${s.currentSceneIndex}_${a}`,obj_name:t.generalAttr.obj_name+"_tempTextObj2D",obj_type:"2d",interactable:!1,obj_parent_id:t.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:[],rect_transform:[{scale:"1,1,1",position:"0,0,0",rotation:"0,0,0,1",size_delta:t.transformAttr.rect_transform[s.selectedResolutionIndex].size_delta,simulated_rotation:"0,0,0"}],simulated_rotation:""},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};if(s.loadText2D(e,w,a,r,null,null,null,!0).then((e=>{console.log("YT後文字 result",e),e.position.z=.01})),t.generalAttr.obj_parent_id){let e=()=>{let o=!1;for(let e=0;e<s.makarObjects2D.length;e++)s.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(e,200);else for(let e=0;e<s.makarObjects2D.length;e++)if(s.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id){y.translateX(d[0]*_),y.translateY(-d[1]*_),y.translateZ(a/r-1),y.rotateZ(p.z),y.scale.set(m[0],m[1],1),y.makarObject=!0,y.obj_id=t.generalAttr.obj_id,y.obj_parent_id=t.generalAttr.obj_parent_id,s.makarObjects2D[e].add(y),s.makarObjects2D.push(y);break}};e()}else y.scale.set(i.x,i.y,1),y.translateX(d[0]*_),y.translateY(-d[1]*_),y.translateZ(a/r-1),y.rotateZ(p.z),e.add(y),s.makarObjects2D.push(y)}function w(e,t,a,r,o,i){let s=this;return c.F.getProjDataEditorVer(arController.currentProjData),new Promise((function(l){n(t.res_url).then((n=>{if(1==n){let c=s.gcssTargets.dpi[e.GCSSID],d=s.gcssTargets.width[e.GCSSID],u=s.gcssTargets.height[e.GCSSID];console.log("dpi",c,d,u);let p=document.getElementById("makarAssets");console.log("_loadAudio: checkFileExtension",t);let h=t.res_url.substring(t.res_url.lastIndexOf(".")+1);console.log("_loadAudio: checkFileExtension getTail",h);let _=document.createElement("audio"),b=!1;switch(h){case"mp3":case"wav":case"ogg":f(_,t.res_url),_.onloadedmetadata=function(){y()};break;default:fetch(t.res_url,{method:"GET",cache:"no-cache",credentials:"same-origin",mode:"cors"}).then((function(e){return e.blob()})).then((function(e){let t=URL.createObjectURL(e);console.log("__AudioModules.js: before _onloadedmetadata ",t),_.onloadedmetadata=function(){console.log(" 7777777777777777777 AudioModules.js: _onloadedmetadata ",t),b||y()},_.addEventListener("loadstart",(function(e){console.log("__AudioModules.js: loadstart  \n\n",t),b||y()})),f(_,t)}))}function f(e,a=t.res_url){e.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),e.setAttribute("src",a),e.setAttribute("crossorigin","anonymous"),e.setAttribute("loop",!0),e.setAttribute("preload","auto"),p.appendChild(e)}function y(){let r=document.createElement("a-entity");r.setAttribute("sound","src: #"+t.generalAttr.obj_id+"_"+t.res_id+"; positional: false"),r.setAttribute("id",t.generalAttr.obj_id),r.setAttribute("sound","autoplay: false"),s.makarObjects.push(r);let n=!0;0==t.generalAttr.active&&(r.setAttribute("sound","loop: false"),r.setAttribute("visible",!1),n=!1,r.setAttribute("class","unclickable"));let p=!1;if(t.generalAttr.obj_parent_id){r.setAttribute("sound","autoplay: false"),r.setAttribute("sound","autostart: false");let h=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(r),window.clearInterval(h),e.addEventListener("child-attached",(function(e){if(t.generalAttr.logic)r.blockly=t.generalAttr.logic,r.setAttribute("sound","autoplay: false");else{let e=!0;r.object3D.traverseAncestors((function(a){if("Scene"!=a.type)console.log(" _loadAudio_: traverseAncestors: not Scene parent=",a),0==a.visible&&(e=!1);else if(1==e&&1==r.object3D.visible&&1==n&&t.generalAttr.active)if(console.log("_loadAudio_: traverseAncestors: all parent visible true=",r.components.sound),1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==a.location){r.setAttribute("sound","autoplay: false");let o=document.getElementById("clickToPlayAudio");function i(){r.components.sound.playSound(),o.style.display="none",o.removeEventListener("click",i),window.allowAudioClicked=!0}o.style.display="block",o.addEventListener("click",i)}else r.setAttribute("sound","autoplay: true"),j(t,r,p);else console.log(" _loadAudio_: traverseAncestors: not all parent visible true=",r.components.sound),r.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(t.generalAttr.logic)r.blockly=t.generalAttr.logic,r.setAttribute("sound","autoplay: false");else if(t.generalAttr.active)if(console.log(" _loadAudio_: ",n,p),1==n)if(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location){r.setAttribute("sound","autoplay: false");let g=document.getElementById("clickToPlayAudio");function _(){r.components.sound.playSound(),g.style.display="none",g.removeEventListener("click",_),window.allowAudioClicked=!0}g.style.display="block",g.addEventListener("click",_)}else r.setAttribute("sound","autoplay: true"),j(t,r,p);else r.setAttribute("sound","autoplay: false");else r.setAttribute("sound","autoplay: false");e.appendChild(r)}r.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){r.object3D.makarType="audio",r.object3D.makarObject=!0,t.behav&&(r.object3D.behav=t.behav),t.behav_reference&&(r.object3D.behav_reference=t.behav_reference);let e=new THREE.Vector3;if(t.generalAttr.obj_parent_id){e.addScaledVector(a,2540/c);let t=e.z;e.z=-t,m(r,e,0,o,i)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),e.addScaledVector(a,2540/c);break;case"3.0.0":e.addScaledVector(a,5080/c),o.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let t=e.y,n=e.z;e.y=n,e.z=t,m(r,e,0,o,i),r.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),r.object3D.rotation.x+=90*Math.PI/180}l(r)}})),b=!0}}else console.log(" _loadAudio_ , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",g(e,t,a,r,o,i),l(1)})).catch((function(e){console.log("_loadAudio_: error ",e)}))}))}function j(e,t,a){0==e.generalAttr.active||a?t.setAttribute("sound","autoplay: false"):e.typeAttr&&(null!=e.typeAttr.is_play&&t.setAttribute("sound",`autoplay: ${e.typeAttr.is_play}`),null!=e.typeAttr.is_play&&t.setAttribute("sound",`loop: ${e.typeAttr.is_loop}`),null!=e.typeAttr.volume&&t.setAttribute("sound",`volume: ${e.typeAttr.volume}`))}function D(e,t,a,r,o,i){let l=this,d=c.F.getProjDataEditorVer(arController.currentProjData);return s(t),new Promise((function(s){n(t.res_url).then((n=>{if(1==n){let c,u=l.gcssTargets.dpi[e.GCSSID],p=l.gcssTargets.width[e.GCSSID],h=l.gcssTargets.height[e.GCSSID],_=(l.sceneTargetList[e.GCSSID].sceneIndex,(new THREE.TextureLoader).load(t.res_url)),b=t.res_url.split(".").length,f=t.res_url.split(".")[b-1].toLowerCase();if(t.sub_type=t.sub_type.toLowerCase(),"png"==t.sub_type||"jpg"==t.sub_type||"jpeg"==t.sub_type||"bmp"==t.sub_type)f=t.sub_type,c=document.createElement("a-plane"),c.setAttribute("src",t.res_url);else if("gif"==t.sub_type)f=t.sub_type,c=document.createElement("a-entity");else{if("button"!=t.sub_type)return console.log("_loadAframeTexture: sub_type empty, create empty plane "),c=document.createElement("a-plane"),void s(c);"png"!=f&&"jpg"!=f&&"jpeg"!=f&&(f="png"),c=document.createElement("a-plane"),c.setAttribute("src",t.res_url)}if(d&&3==d.v0&&d.v1>=5){let w,j,D,v;c.setAttribute("id",t.generalAttr.obj_id);let A=!1;if(makarUserData.scenesData.scenes[l.currentSceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[l.currentSceneIndex].behav)&&(v=makarUserData.scenesData.scenes[l.currentSceneIndex].behav.find((e=>e.obj_id==t.generalAttr.obj_id&&"Transparent"==e.behav_type)),v&&(console.log("%c ImageModule.js _loadImage: transparentBehav=","color:BlanchedAlmond;",v),A=!0,[w,j,D]=[v.color,v.slope,v.threshold])),A&&v){let E=w.split(","),C=new THREE.Color(parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2]));function k(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let T=k(parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2]));T[0]/=360,console.log(`rgb: ${E} ,\n _hsv: (${T})`),"jpg"==f||"jpeg"==f||"png"==f?"RGB"==v.mode?c.setAttribute("material","shader: chromaKey; color: #"+C.getHexString()+";transparent: true; _slope: "+parseFloat(j)+"; _threshold: "+parseFloat(D)+";"):"HSV"==v.mode&&c.setAttribute("material","shader: HSVMatting; transparent: true; side:double; depthWrite:false; _keyingColorH:"+T[0]+"; _keyingColorS:"+T[1]+"; _keyingColorV:"+T[2]+"; _deltaH:"+parseFloat(v.hue)+"; _deltaS:"+parseFloat(v.saturation)+"; _deltaV:"+parseFloat(v.brightness)+";"):"gif"==f&&("RGB"==v.mode?(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","shader:gif_RGB;  src: url("+t.res_url+"); opacity: 1; transparent: true; depthWrite:false; color: #"+C.getHexString()+"; _slope: "+parseFloat(j)+"; _threshold: "+parseFloat(D)+";")):"HSV"==v.mode&&(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","shader:gif_HSV;  src: url("+t.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; _keyingColorH:"+T[0]+"; _keyingColorS:"+T[1]+"; _keyingColorV:"+T[2]+"; _deltaH:"+parseFloat(v.hue)+"; _deltaS:"+parseFloat(v.saturation)+"; _deltaV:"+parseFloat(v.brightness)+";")))}else"jpg"==f||"jpeg"==f||"png"==f?c.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; "):"gif"==f&&(c.setAttribute("geometry","primitive: plane"),c.setAttribute("material","shader:gif;  src: url("+t.res_url+"); opacity: 1; transparent: true;"));0==t.generalAttr.active&&(c.setAttribute("visible",!1),c.setAttribute("class","unclickable"))}c.setAttribute("crossorigin","anonymous"),t.behav?0==t.behav.length&&transparentImage?c.setAttribute("class","unclickable"):c.setAttribute("class","clickable"):t.generalAttr.logic?c.setAttribute("class","clickable"):c.setAttribute("class","unclickable"),l.makarObjects.push(c);let y=l.arfScene.renderer.capabilities.getMaxAnisotropy();if(c.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=y,e.detail.texture.needsUpdate=!0})),c.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){let e=setInterval((function(){if(_.image&&c.object3D&&c.object3D.children&&c.object3D.children[0]&&c.object3D.children[0].scale){c.object3D.children[0].scale.set(25.4*_.image.width/u,25.4*_.image.height/u,1);let r=new THREE.Vector3;if(t.generalAttr.obj_parent_id){c.object3D.obj_parent_id=t.generalAttr.obj_parent_id,r.addScaledVector(a,2540/u);let e=r.z;r.z=-e,m(c,r,0,o,i)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),r.addScaledVector(a,2540/u);break;case"3.0.0":r.addScaledVector(a,5080/u),o.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let e=r.y,t=r.z;r.y=t,r.z=e,m(c,r,0,o,i),c.object3D.position.add(new THREE.Vector3(25.4*p/u/2,25.4*h/u/2,0)),c.object3D.rotation.x+=90*Math.PI/180}let n=c.object3D;n.originTransform={position:n.position.clone(),rotation:n.rotation.clone(),scale:n.scale.clone()},t.blockly&&(n.resetProperty=function(){}),c.setAttribute("heightForQuiz",.01*_.image.height),window.clearInterval(e),s(c)}}),1);c.object3D.makarType="image",c.object3D.makarObject=!0,t.behav&&(c.object3D.behav=t.behav),t.behav_reference&&(c.object3D.behav_reference=t.behav_reference),"button"==t.main_type&&(c.object3D.main_type=t.main_type,c.object3D.sub_type=t.sub_type,c.setAttribute("class","clickable"),console.log("three.js: _loadAframeTexture: button ",c))}})),t.generalAttr.obj_parent_id){let S=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(c),window.clearInterval(S))}),1)}else e.appendChild(c)}else console.log("ARFunc.js: _loadAframeTexture , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",g(e,t,a,r,o,i),s(1)}))}))}function v(e,t,a,r,o=null,n=null,i=null){let l=this;return s(t),new Promise((function(o){(new THREE.TextureLoader).load(t.res_url,(function(n){let i,s,c,d,u,m;if(console.log("VRFunc.js: _loadTexture2D: texture WH=",n.image.width,n.image.height),4==Object.keys(l.editor_version).length){let v;if(Number(l.editor_version.v0),Number(l.editor_version.v1),Number(l.editor_version.v2),v=p(),!(v.rectP&&v.rectSizeDelta&&v.rectScale))return void o(!1);i=v.rectP,s=v.rectSizeDelta,c=v.rectScale,d=v.rectR}else{let A=p();if(!(A.rectP&&A.rectSizeDelta&&A.rectScale))return void o(!1);i=A.rectP,s=A.rectSizeDelta,c=A.rectScale,d=A.rectR}function p(){let e,a,r,o,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(l.selectedResolutionIndex)||(console.warn(" _getObj2DInfo350: error, missing _selectedResolutionIndex",l.selectedResolutionIndex),l.selectedResolutionIndex=0);let i=t.transformAttr.rect_transform[l.selectedResolutionIndex];if(i.position&&i.rotation&&i.scale&&i.size_delta){e=i.position.split(",").map((function(e){return Number(e)})),a=i.size_delta.split(",").map((function(e){return Number(e)})),r=i.scale.split(",").map((function(e){return Number(e)})),o=i.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),s=(new THREE.Euler).setFromQuaternion(t,"YXZ"),l=new THREE.Vector3(s.x,s.y,s.z);l.z=-1*l.z,n={rectP:e,rectSizeDelta:a,rectScale:r,rectR:l}}}return n}n.flipY=!1,console.log("VRFunc.js: _loadTexture2D: innerWH , camera2D ",innerWidth,innerHeight,l.arScene.clientWidth,l.arScene.clientHeight);let h=l.scaleRatioXY;u=s[0]*h,m=s[1]*h,t.res_url;let g=t.sub_type,_=new THREE.Object3D;_.makarType="image2D";let b,f,y,w,j,D=!1;if(makarUserData.scenesData.scenes[l.currentSceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[l.currentSceneIndex].behav)&&(w=makarUserData.scenesData.scenes[l.currentSceneIndex].behav.find((e=>e.obj_id==t.generalAttr.obj_id&&"Transparent"==e.behav_type)),w)){console.log("%c ImageModule.js _loadImage: transparentBehav=","color:BlanchedAlmond;",w),D=!0;let E=w.color.split(",");b=[parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2])],f=w.slope,y=w.threshold}if(D&&w){function C(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let k,T=C(b[0],b[1],b[2]);if(T[0]/=360,console.log(`rgb: ${b} ,\n _hsv: (${T})`),"jpg"==g||"jpeg"==g||"png"==g||"button"==g)"RGB"==w.mode?k=new THREE.ChromaKeyMaterial({map:n,keyColor:b,side:THREE.DoubleSide,slope:f,threshold:y}):"HSV"==w.mode&&(k=new THREE.HSVMattingMaterial({map:n,side:THREE.DoubleSide,_keyingColorH:T[0],_keyingColorS:T[1],_keyingColorV:T[2],_deltaH:w.hue,_deltaS:w.saturation,_deltaV:w.brightness})),j=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,m,0),k);else if("gif"==g){j=document.createElement("a-entity"),j.setAttribute("material","side:double; shader:gif;  src: url("+t.res_url+"); opacity: 1; transparent: true; depthWrite:false; visible: false; ");let S=new THREE.Color(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]));console.log("three color",S),"RGB"==w.mode?(j.setAttribute("geometry","primitive: plane; width:"+u+"; height:"+m+";"),j.setAttribute("material","shader:gif_RGB;  src: url("+t.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; color: #"+S.getHexString()+"; _slope: "+parseFloat(f)+"; _threshold: "+parseFloat(y)+";")):"HSV"==w.mode&&(j.setAttribute("geometry","primitive: plane; width:"+u+"; height:"+m+";"),j.setAttribute("material","shader:gif_HSV;  src: url("+t.res_url+"); opacity: 1; transparent: true; side:double; depthWrite:false; _keyingColorH:"+T[0]+"; _keyingColorS:"+T[1]+"; _keyingColorV:"+T[2]+"; _deltaH:"+parseFloat(w.hue)+"; _deltaS:"+parseFloat(w.saturation)+"; _deltaV:"+parseFloat(w.brightness)+";"))}}else"jpg"==g||"jpeg"==g||"png"==g||"button"==g?j=new THREE.Mesh(new THREE.PlaneBufferGeometry(u,m,0),new THREE.MeshBasicMaterial({map:n,side:THREE.DoubleSide,transparent:!0})):"gif"==g&&(j=document.createElement("a-entity"),j.setAttribute("geometry","primitive: plane; width:"+u+"; height:"+m+";"),j.setAttribute("material","side:double; shader:gif;  src: url("+t.res_url+"); opacity: 1; transparent: true; depthWrite:false; visible: false; "));if(t.behav&&(_.behav=t.behav,l.setObjectBehavAll(t)),0==t.generalAttr.active&&(_.visible=!1),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,"button"==t.main_type&&(_.sub_type=t.sub_type),t.generalAttr.obj_parent_id){let R=function(){let e=!1;for(let a=0;a<l.makarObjects2D.length;a++)l.makarObjects2D[a].obj_id==t.generalAttr.obj_parent_id&&(e=!0);if(0==e)setTimeout(R,500);else for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(_.scale.set(c[0],c[1],1),_.translateX(i[0]*h),_.translateY(-i[1]*h),_.translateZ(a/r-1),_.rotateZ(d.z),"gif"==g?(j.addEventListener("loaded",(function(a){if(a.target==a.currentTarget){if(j&&j.object3D&&j.object3D.children&&1==j.object3D.children.length&&j.object3D.children[0]&&j.object3D.children[0].material){let a=j.object3D.children[0].material;if(a&&a.map&&a.map.image&&a.map.image.width>2&&a.map.image.height>2&&(a.map.flipY=!1),j&&j.gif&&j.gif.self&&j.gif.self.__texture){j.gif.self.__texture.flipY=!1;let e=l.arfScene.renderer.capabilities.getMaxAnisotropy();e&&(j.gif.self.__texture.anisotropy=e,j.gif.self.__texture.needsUpdate=!0)}a.visible=!0,_.add(j.object3D),l.makarObjects2D[e].add(_),l.makarObjects2D.push(_),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,j.removeFromParent(),j.remove(),o(_)}}else console.log("_loadTexture2D: loaded target different")})),l.arfScene.appendChild(j)):(_.add(j),l.makarObjects2D[e].add(_),l.makarObjects2D.push(_),o(_),console.log("______VRFunc.js: _loadTexture2D: parent exit, set obj(parent) ",t,j,l.makarObjects2D.slice(),performance.now())))};R()}else console.log("VRFunc.js: VRController: _loadTexture2D: obj() ",t),_.scale.set(c[0],c[1],1),_.translateX(i[0]*h),_.translateY(-i[1]*h),_.translateZ(a/r-1),_.rotateZ(d.z),l.makarObjects2D.push(_),e.add(_),"gif"==g?(j.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){if(console.log("_loadTexture2D: gif loaded target same"),j&&j.object3D&&j.object3D.children&&1==j.object3D.children.length&&j.object3D.children[0]&&j.object3D.children[0].material){let e=j.object3D.children[0].material;if(e&&e.map&&e.map.image&&e.map.image.width>2&&e.map.image.height>2&&(e.map.flipY=!1),j&&j.gif&&j.gif.self&&j.gif.self.__texture){j.gif.self.__texture.flipY=!1;let e=l.arfScene.renderer.capabilities.getMaxAnisotropy();e&&(j.gif.self.__texture.anisotropy=e,j.gif.self.__texture.needsUpdate=!0)}e.visible=!0,_.add(j.object3D),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,j.removeFromParent(),j.remove(),o(_),console.log("______VRFunc.js: _loadTexture2D: self.makarObjects2D.slice()=",l.makarObjects2D.slice(),performance.now())}}else console.log("_loadTexture2D: loaded target different")})),l.arfScene.appendChild(j)):(_.add(j),_.makarObject=!0,_.obj_id=t.generalAttr.obj_id,o(_),console.log("______VRFunc.js: _loadTexture2D: self.makarObjects2D.slice()=",l.makarObjects2D.slice(),performance.now()))}),void 0,(function(e){console.error("An error happened. _loadTexture2D , err=",e)}))}))}function A(e,t,a,r,o,n){let i=this,s=c.F.getProjDataEditorVer(arController.currentProjData);return new Promise((function(r){let l=i.gcssTargets.dpi[e.GCSSID],c=i.gcssTargets.width[e.GCSSID],d=i.gcssTargets.height[e.GCSSID],u=document.createElement("a-entity");if(s&&3==s.v0&&s.v1>=5){u.setAttribute("id",t.generalAttr.obj_id);let s="type:"+t.typeAttr.light_type,p=t.typeAttr.color.split(","),h=new THREE.Color(parseFloat(p[0]),parseFloat(p[1]),parseFloat(p[2]));if(s+="; color:#"+h.getHexString(),s+=";intensity:"+t.typeAttr.intensity,"point"!=t.typeAttr.light_type&&"spot"!=t.typeAttr.light_type||(s+=";distance:"+2*t.typeAttr.range*100*25.4/l,s+=";decay: 2"),"spot"==t.typeAttr.light_type&&(s+=";angle:"+(parseFloat(t.typeAttr.spotAngle)/2).toString(),s+=";penumbra: 0.2"),t.typeAttr.shadow,u.setAttribute("light",s),"directional"==t.typeAttr.light_type&&(u.setAttribute("castShadow",!1),u.setAttribute("light","castShadow: false; ")),0==t.generalAttr.active&&u.setAttribute("visible",!1),u.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){if("directional"==t.typeAttr.light_type){u.object3D.children[0].position.set(0,0,0);let e=new THREE.Object3D;e.name="lightTarget",e.position.set(0,0,-1),u.object3D.children[0].target=e,u.object3D.add(e)}else"spot"==t.typeAttr.light_type||t.typeAttr.light_type;let e=new THREE.Vector3;if(t.generalAttr.obj_parent_id){u.object3D.obj_parent_id=t.generalAttr.obj_parent_id,e.addScaledVector(a,2540/l);let r=e.z;e.z=-r,m(u,e,0,o,n)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),e.addScaledVector(a,2540/l);break;case"3.0.0":o.multiplyScalar(2),e.addScaledVector(a,5080/l);break;default:console.log("three.js: _loadAframeLight: serverVersion version wrong",serverVersion)}let t=e.y,r=e.z;e.y=r,e.z=t,m(u,e,0,o,n),u.object3D.position.add(new THREE.Vector3(25.4*c/l/2,25.4*d/l/2,0)),u.object3D.rotation.x+=90*Math.PI/180}let s=u.object3D;s.originTransform={position:s.position.clone(),rotation:s.rotation.clone(),scale:s.scale.clone()},t.generalAttr.logic&&(s.resetProperty=function(){s.children[0].intensity=t.typeAttr.intensity,s.children[0].color.copy(h)}),u.object3D.makarType="light",u.object3D.makarObject=!0,i.makarObjects.push(u),r(u)}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let a=document.getElementById(t.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(u),window.clearInterval(e))}),1)}else console.log("three.js: _loadAframeLight: loaded: no parent prs=",u.object3D.position,u.object3D.rotation,u.object3D.scale),e.appendChild(u)}}))}function E(e,t,a,r,o,n,i=!1){let s=this,l=c.F.getProjDataEditorVer(arController.currentProjData);return new Promise((function(r){let c=s.gcssTargets.dpi[e.GCSSID],d=s.gcssTargets.width[e.GCSSID],u=s.gcssTargets.height[e.GCSSID];t.typeAttr?(t.typeAttr.content||(t.typeAttr.content="dev"),t.typeAttr.color||(t.typeAttr.color="1,1,1"),t.typeAttr.back_color||(t.typeAttr.back_color="0,0,0,0")):t.typeAttr={content:"dev",color:"1,1,1",back_color:"0,0,0,0"};let p,h=document.createElement("a-entity"),g=0;l&&3==l.v0&&l.v1>=5&&h.setAttribute("id",t.generalAttr.obj_id),i||s.makarObjects.push(h),t.behav||"button"==t.main_type||t.generalAttr.logic?h.setAttribute("class","clickable"):h.setAttribute("class","unclickable");let _=document.createElement("a-text");if(_.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),_.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;"),l&&3==l.v0&&l.v1>=5){let b=t.typeAttr.content.split("\n"),f=0;const y=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,w=e=>y.test(e);for(let E=0;E<b.length;E++){let C=0;for(let k=0;k<b[E].length;k++)w(b[E][k])?C+=1.6:b[E][k]==b[E][k].toUpperCase()&&b[E][k]!=b[E][k].toLowerCase()||b[E][k]==b[E][k].toLowerCase()&&b[E][k]!=b[E][k].toUpperCase()?C+=1:isNaN(1*b[E][k])?C+=1.25:C+=1;C>f&&(f=C)}_.setAttribute("value",t.typeAttr.content),_.setAttribute("width",.08*f),_.setAttribute("wrap-count",f+1),_.setAttribute("anchor","center"),_.setAttribute("align","left"),_.setAttribute("backcolor",t.typeAttr.back_color),_.setAttribute("textcolor",t.typeAttr.color),_.setAttribute("side","double");let j="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",D=[j+"1-msdf.json",j+"2-msdf.json",j+"3-msdf.json",j+"4-msdf.json",j+"5-msdf.json",j+"6-msdf.json",j+"7-msdf.json",j+"8-msdf.json",j+"9-msdf.json",j+"10-msdf.json",j+"11-msdf.json",j+"12-msdf.json"];_.setAttribute("font",D),_.setAttribute("negate","false"),_.setAttribute("crossorigin","anonymous");let v=t.typeAttr.color.split(",");function A(e){console.log("three.js: _loadAframeText: textEntity geometry-set: evt=",e),0==g?g=1:1==g&&r(_),_.removeEventListener("geometry-set",A)}p=new THREE.Color(parseFloat(v[0]),parseFloat(v[1]),parseFloat(v[2])),_.setAttribute("color","#"+p.getHexString()),_.addEventListener("geometry-set",A)}if(h.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: _loadAframeText: anchor loaded: evt=",e),_.object3D.scale.set(2540/c,2540/c,2540/c);let l=new THREE.Vector3;if(t.generalAttr.obj_parent_id){h.object3D.obj_parent_id=t.generalAttr.obj_parent_id,l.addScaledVector(a,2540/c);let e=l.z;l.z=-e,m(h,l,0,o,n)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),l.addScaledVector(a,2540/c);break;case"3.0.0":o.multiplyScalar(2),l.addScaledVector(a,5080/c);break;default:console.log("three.js: _loadAframeText: serverVersion version wrong",serverVersion)}let e=l.y,t=l.z;l.y=t,l.z=e,m(h,l,0,o,n),h.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),h.object3D.rotation.x+=90*Math.PI/180,console.log(" +++++++++ set done",h.object3D.position,h.object3D.rotation,h.object3D.scale)}let b=h.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone(),textContent:t.typeAttr.content,textColor:p,textBackColor:t.typeAttr.back_color},t.generalAttr.logic&&(b.resetProperty=function(){_.getAttribute("value")!=t.typeAttr.content||_.components.text.attrValue.color!="#"+p.getHexString()||_.components.text.attrValue.backcolor!=t.typeAttr.back_color?(console.log("three.js: _loadAframeText: do reset"),_.components.text.textMesh.children.length=0,_.object3D.children.length=1,_.setAttribute("value",t.typeAttr.content),_.setAttribute("color","#"+p.getHexString()),_.setAttribute("backcolor",t.typeAttr.back_color)):console.log("three.js: _loadAframeText: text same, reset do nothing ")}),i?_.object3D.isTempTextObj=!0:h.object3D.makarObject=!0,h.object3D.makarType="text",t.behav&&(h.object3D.behav=t.behav,s.setObjectBehavAll(t)),t.behav_reference&&(h.object3D.behav_reference=t.behav_reference),"button"==t.main_type&&(h.object3D.main_type=t.main_type),0==g?g=1:1==g&&r(_)}})),h.appendChild(_),0==t.generalAttr.active&&(h.setAttribute("visible",!1),h.setAttribute("class","unclickable")),t.generalAttr.obj_parent_id){let T=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(h),window.clearInterval(T))}),1)}else e.appendChild(h)}))}function C(e,t,a,r,o=null,n=null,i=null,s=!1){return new Promise(((o,n)=>{let i,l,c,d,u,m,p=()=>{let e,a,r,o,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(this.selectedResolutionIndex)||(console.log(" _loadText2D: _getObj2DInfo338: error, missing _selectedResolutionIndex"),this.selectedResolutionIndex=0);let i=t.transformAttr.rect_transform[this.selectedResolutionIndex];if(i.position&&i.size_delta&&i.rotation&&i.scale){e=i.position.split(",").map((function(e){return Number(e)})),a=i.size_delta.split(",").map((function(e){return Number(e)})),r=i.scale.split(",").map((function(e){return Number(e)})),o=i.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),s=(new THREE.Euler).setFromQuaternion(t,"YXZ"),l=new THREE.Vector3(s.x,s.y,s.z);l.z=-1*l.z,r.x=r[0],r.y=r[1],n={rectP:e,rectSizeDelta:a,rectScale:r,rectR:l}}}return n};if("object"==typeof this.editor_version&&4==Object.keys(this.editor_version).length){let e=Number(this.editor_version.v0),t=Number(this.editor_version.v1);if(Number(this.editor_version.v2),e>3||e>=3&&t>=5){let e=p();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void o(!1);i=e.rectP,l=e.rectSizeDelta,c=e.rectScale,d=e.rectR}else trans=p()}else{let e=p();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale&&e.rectR))return void o(!1);i=e.rectP,l=e.rectSizeDelta,c=e.rectScale,d=e.rectR}console.log("_loadText2D: info: _rectAll= ",i,l,c,d);let h=this.scaleRatioXY;u=l[0]*h,m=l[1]*h,console.log("_loadText2D: info: wh = ",u,m,h);let g=0,_=t.typeAttr.content.split("\n");for(let e=0;e<_.length;e++)_[e].length>g&&(g=_[e].length);let b=u/g*1,f=m/_.length*.9,y=175*h,w=Math.min(b,f,y);console.log(" ******** ",t.typeAttr.content,w,g,"[",b,",",u,"]",", [",f,",",m,"], ",y);let j=new THREE.Object3D;j.makarType="text2D",t.behav&&(j.behav=t.behav,this.setObjectBehavAll(t)),0==t.generalAttr.active&&(j.visible=!1);let D=document.createElement("a-text");D.object3D.renderOrder=a,D.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),D.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let v=t.typeAttr.content.split("\n"),A=0;const E=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<v.length;e++){let t=0;for(let a=0;a<v[e].length;a++)C=v[e][a],E.test(C)?t+=1.6:v[e][a]==v[e][a].toUpperCase()&&v[e][a]!=v[e][a].toLowerCase()||v[e][a]==v[e][a].toLowerCase()&&v[e][a]!=v[e][a].toUpperCase()?t+=1:isNaN(1*v[e][a])?t+=1.25:t+=1;t>A&&(A=t)}var C;D.setAttribute("id",t.generalAttr.obj_id),D.setAttribute("value",t.typeAttr.content),D.setAttribute("width",.08*A),D.setAttribute("width",u),D.setAttribute("height",m),D.setAttribute("fontsize",w),D.setAttribute("wrap-count",A),D.setAttribute("anchor","center"),D.setAttribute("align","left"),D.setAttribute("baseline","center"),D.setAttribute("backcolor",t.typeAttr.back_color),D.setAttribute("textcolor",t.typeAttr.color),D.setAttribute("side","double");let k="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",T=[k+"1-msdf.json",k+"2-msdf.json",k+"3-msdf.json",k+"4-msdf.json",k+"5-msdf.json",k+"6-msdf.json",k+"7-msdf.json",k+"8-msdf.json",k+"9-msdf.json",k+"10-msdf.json",k+"11-msdf.json",k+"12-msdf.json"];D.setAttribute("font",T),D.setAttribute("negate","false"),D.setAttribute("crossorigin","anonymous");let S,R,x=t.typeAttr.color.split(","),M=new THREE.Color(parseFloat(x[0]),parseFloat(x[1]),parseFloat(x[2]));D.setAttribute("color","#"+M.getHexString()),document.getElementById("aTempScene")&&document.getElementById("aTempDiv")?R=document.getElementById("aTempScene"):(S=document.createElement("div"),S.style.display="none",R=document.createElement("a-scene"),R.setAttribute("id","aTempScene"),R.setAttribute("embedded",""),document.body.appendChild(S),S.appendChild(R)),R.appendChild(D),D.addEventListener("geometry-set",(function(e){let t=D.object3D;t&&(t.children[2]&&t.children[2],console.log("_loadText2D: textEntity geometry-set: textObject=",t,e)),o(j)})),D.addEventListener("loaded",(o=>{let n=D.object3D;if(j.add(n),n.rotation.x=Math.PI,n.scale.set(190,190,1),t.generalAttr.obj_parent_id){n.obj_parent_id=t.generalAttr.obj_parent_id;let e=()=>{let o=!1;for(let e=0;e<this.makarObjects2D.length;e++)this.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(e,200);else for(let e=0;e<this.makarObjects2D.length;e++)if(this.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id){j.add(n),j.translateX(i[0]*h),j.translateY(-i[1]*h),j.translateZ(a/r-1),j.rotateZ(d.z),j.scale.set(c.x,c.y,1),j.makarObject=!0,j.obj_id=t.generalAttr.obj_id,j.obj_parent_id=t.generalAttr.obj_parent_id,this.makarObjects2D[e].add(j),s||this.makarObjects2D.push(j);break}};e()}else j.add(n),j.translateX(i[0]*h),j.translateY(-i[1]*h),j.translateZ(a/r-1),j.rotateZ(d.z),j.scale.set(c.x,c.y,1),j.makarObject=!0,j.obj_id=t.generalAttr.obj_id,s||this.makarObjects2D.push(j),e.add(j)}))}))}function k(e,t,a,r,o,i){let s=this,l=c.F.getProjDataEditorVer(arController.currentProjData);return new Promise((function(c){n(t.res_url).then((n=>{if(1==n){let r=s.gcssTargets.dpi[e.GCSSID],n=s.gcssTargets.width[e.GCSSID],u=s.gcssTargets.height[e.GCSSID],p=(s.sceneTargetList[e.GCSSID].projIndex,document.getElementById("makarAssets"));var d;(d=document.createElement("video")).src=t.res_url,d.playsInline=!0,d.autoplay=!0,d.loop=!0,d.setAttribute("crossorigin","anonymous"),d.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id),p.appendChild(d),d.name4debug=t.generalAttr.obj_name,d.setAttribute("preload","auto"),window.Browser&&((null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(d.muted=!0),1==window.Browser.mobile&&(d.muted=!0,d.play())),d.onloadedmetadata=function(){var p,h;d.videoWidth>=d.videoHeight?(p=1,h=1*d.videoHeight/d.videoWidth):(p=1*d.videoWidth/d.videoHeight,h=1);let g=document.createElement("a-video");if(l&&3==l.v0&&l.v1>=5){let f,y,w,j,D=!1;if(makarUserData.scenesData.scenes[s.currentSceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[s.currentSceneIndex].behav)&&(j=makarUserData.scenesData.scenes[s.currentSceneIndex].behav.find((e=>e.obj_id==t.generalAttr.obj_id&&"Transparent"==e.behav_type)),j&&(console.log("%c VideoModule.js _loadVideo: transparentBehav=","color:BlanchedAlmond;",j),D=!0,[f,y,w]=[j.color,j.slope,j.threshold])),D&&j){let v=f.split(",");var _=new THREE.Color(parseFloat(v[0]),parseFloat(v[1]),parseFloat(v[2]));if("RGB"==j.mode)g.setAttribute("material","shader: chromaKey; color: #"+_.getHexString()+";transparent: true; _slope: "+parseFloat(y)+"; _threshold: "+parseFloat(w)+";");else if("HSV"==j.mode){function A(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let E=A(parseFloat(v[0]),parseFloat(v[1]),parseFloat(v[2]));E[0]/=360,console.log(`rgb: ${v} ,\n _hsv: (${E})`),g.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+E[0]+"; _keyingColorS:"+E[1]+"; _keyingColorV:"+E[2]+"; _deltaH:"+j.hue+"; _deltaS:"+j.saturation+"; _deltaV:"+j.brightness+";")}}else g.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");g.setAttribute("id",t.generalAttr.obj_id),g.setAttribute("src","#"+t.generalAttr.obj_id+"_"+t.res_id),0==t.generalAttr.active&&(g.setAttribute("visible",!1),g.setAttribute("class","unclickable"))}t.behav?0==t.behav.length&&transparentVideo?g.setAttribute("class","unclickable"):g.setAttribute("class","clickable"):t.generalAttr.logic?g.setAttribute("class","clickable"):g.setAttribute("class","unclickable"),g.mp4Video=d;let b=s.arfScene.renderer.capabilities.getMaxAnisotropy();if(g.addEventListener("materialtextureloaded",(function(e){console.log("three.js: _loadVideo: _materialtextureloaded: videoPlane = ",g.object3D,e),e.detail.texture.anisotropy=b,e.detail.texture.needsUpdate=!0})),g.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: videoPlane.loaded: vw vh = ",p,h,e),g.object3D.children[0].scale.set(100*p*25.4/r,100*h*25.4/r,1);let l=new THREE.Vector3;if(t.generalAttr.obj_parent_id){g.object3D.obj_parent_id=t.generalAttr.obj_parent_id,l.addScaledVector(a,2540/r);let e=l.z;l.z=-e,m(g,l,0,o,i)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),l.addScaledVector(a,2540/r);break;case"3.0.0":o.multiplyScalar(2),l.addScaledVector(a,5080/r);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let e=l.y,t=l.z;l.y=t,l.z=e,m(g,l,0,o,i),g.object3D.position.add(new THREE.Vector3(25.4*n/r/2,25.4*u/r/2,0)),g.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeVideo: loaded: no parent prs=",g.object3D.position,g.object3D.rotation,g.object3D.scale)}let _=g.object3D;_.originTransform={position:_.position.clone(),rotation:_.rotation.clone(),scale:_.scale.clone()},t.generalAttr&&t.generalAttr.logic&&(_.resetProperty=function(){d.pause()}),g.object3D.makarObject=!0,g.object3D.makarType="video";const b={behav_type:"videoTogglePlayPause",obj_id:t.generalAttr.obj_id};t.behav?(g.object3D.behav=t.behav,g.object3D.behav.push(b),s.setObjectBehavAll(t)):g.object3D.behav=[b],g.setAttribute("class","clickable"),t.behav_reference&&(g.object3D.behav_reference=t.behav_reference),c(g)}})),s.makarObjects.push(g),t.generalAttr.obj_parent_id){d.autoplay=!1;let C=setInterval((function(){let e=document.getElementById(t.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(g),window.clearInterval(C),e.addEventListener("child-attached",(function(e){if(console.log("three.js: arController: _loadVideo,: parent child-attached, el=",e),l&&3==l.v0&&l.v1>=5)if(t.generalAttr.logic)g.blockly=t.generalAttr.logic,d.pause(),d.currentTime=0;else{let e=!0;g.object3D.traverseAncestors((function(a){"Scene"!=a.type?0==a.visible&&(e=!1):1==e&&1==g.object3D.visible?(d.autoplay=!0,d.play(),T(t,d),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==a.location?S(d,!0):1==window.Browser.mobile&&S(d,!1))):(console.log("three.js: arController: _loadVideo,: traverseAncestors: not all parent visible true=",g.object3D),d.muted=!1,d.autoplay=!1,d.pause(),d.currentTime=0)}))}})))}),1)}else l&&3==l.v0&&l.v1>=5&&(t.generalAttr.logic?(g.blockly=t.generalAttr.logic,d.pause(),d.currentTime=0,d.muted=!1):(d.autoplay=!0,d.play(),T(t,d),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?S(d,!0):1==window.Browser.mobile&&S(d,!1)))),e.appendChild(g)}}else console.log("ARFunc.js: _loadAframeVideo , obj url not exist ",t),t.main_type="model",t.sub_type="glb",t.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",g(e,t,a,r,o,i),c(1)}))}))}function T(e,t,a=!1){0==e.generalAttr.active||a?(t.autoplay=!1,t.pause(),t.currentTime=0):e.typeAttr&&(null!=e.typeAttr.is_loop&&(t.loop=e.typeAttr.is_loop,window.Browser&&1==window.Browser.mobile&&"safari"!=window.Browser.name&&e.typeAttr.is_loop&&(t.loop=!1,t.addEventListener("ended",(function(){document.getElementsByTagName("a-video").length+window.arController.makarObjects2D.filter((e=>"video2D"==e.makarType)).length==1?(console.log("只剩一個影片了 播放它"),t.currentTime=.1,t.muted=!1,t.play()):(t.currentTime=.1,t.muted=!0,t.play(),R(t))}),!1))),null!=e.typeAttr.volume&&(t.volume=e.typeAttr.volume))}function S(e,t=!1){console.log("dealVideoMuted isSafari",t);let a=document.getElementById("clickToPlayAudio");a.onclick=function(){console.log("dealVideoMuted clickToPlayAudio isSafari",t),a.setAttribute("didUserClick",!0),a.style.display="none",a.onclick=null,window.allowAudioClicked=!0,t?(console.log("isSafari=",t),M(!0),x(!0),e.muted=!1):(console.log("isSafari=",t),function(e=!1,t=!1){let a=document.getElementsByTagName("a-video");Array.from(a).forEach((a=>{let r=a.mp4Video,o=!0;a.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(o=!1):1!=o||1!=a.object3D.visible||a.blockly||(console.log("解除靜音 3D影片",r.name4debug,r.currentTime),t&&(r.currentTime=.1),e&&(r.autoplay=!0,r.play()),r.muted=!1)}))}))}(!0),function(e=!1,t=!1){window.arController.makarObjects2D.forEach((a=>{if("video2D"==a.makarType&&0!=a.children.length&&a.children[0].material&&a.children[0].material.map&&a.children[0].material.map.image&&"VIDEO"==a.children[0].material.map.image.tagName){const r=a.children[0].material.map.image;if(r){let o=!0;a.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(o=!1):1==o&&1==a.visible&&(console.log("解除靜音 2D影片",r.name4debug,r.currentTime),t&&(r.currentTime=.1),e&&(r.autoplay=!0,r.play()),r.muted=!1)}))}}}))}(!0))},a.getAttribute("didUserClick")?(console.log("user已允許聲音播放 (跳轉場景)"),M(!0),x(!0),e.muted=!1):a.style.display="block"}function R(e){let t,a;e&&("a-video"==e.localName?t=e:"video2D"==e.makarType&&(a=e));let r=document.getElementsByTagName("a-video");console.log("XRFunc.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length);let o=window.arController.makarObjects2D;if(t)for(let e=0;e<r.length;e++){let a=r[e],o=r[e].mp4Video;if(a==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play(),self.safariUnMutedVideo=t;else{let r=!0;a.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("XRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,a.object3D.visible,a),1==r&&1==a.object3D.visible&&0!=o.volume&&(o.muted=!0,o.autoplay=!0,o.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else if(!t&&a){M();let e=!0;a.traverseAncestors((function(t){if("Scene"!=t.type)0==t.visible&&(e=!1);else if(1==e&&1==a.visible){if("targetVideo2D"!=a.makarType)return;if(0==a.children.length)return;if(!a.children[0].material)return;if(!a.children[0].material.map)return;if(!a.children[0].material.map.image)return;if("VIDEO"==a.children[0].material.map.image.tagName){const e=a.children[0].material.map.image;e&&0!=e.volume&&(e.muted=!1,e.autoplay=!0,self.safariUnMutedVideo=a)}}}))}else if(!t&&!a){let e=!1;for(let t=0;t<r.length;t++){let a=r[t],o=r[t].mp4Video;if(!((n=o).currentTime>=0&&!n.paused&&!n.ended&&n.readyState>2))continue;let i=!0;a.object3D.traverseAncestors((function(r){if("Scene"!=r.type)0==r.visible&&(i=!1);else if(console.log("XRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",t,i,a.object3D.visible,a),1==i&&1==a.object3D.visible&&!a.blockly&&0!=o.volume)if(0==e){console.log("XRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",a.object3D.name4debug);const t=e=>!!(e.currentTime>=0&&!e.paused&&!e.ended&&e.readyState>=1);o&&((n=o).currentTime>0&&!n.paused&&!n.ended&&n.readyState>2||t(o))&&0!=o.volume&&(o.muted=!1,o.autoplay=!0,e=!0,self.safariUnMutedVideo=a,o.play())}else console.log("XRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",a.object3D),0!=o.volume&&(o.muted=!0,o.autoplay=!0,(e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2))(o)&&o.play());var n}))}0!=r.length&&0!=e||o.forEach((t=>{let a=!0;t.traverseAncestors((function(r){if("Scene"!=r.type)0==r.visible&&(a=!1);else if(1==a&&1==t.visible&&0==e){if("video2D"!=t.makarType)return;if(0==t.children.length)return;if(!t.children[0].material)return;if(!t.children[0].material.map)return;if(!t.children[0].material.map.image)return;if("VIDEO"==t.children[0].material.map.image.tagName){const a=t.children[0].material.map.image,r=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2),o=e=>!!(e.currentTime>=0&&!e.paused&&!e.ended&&e.readyState>=1);a&&(r(a)||o(a))&&0!=a.volume?(console.log("播一下聲音阿 2d",a.name4debug),a.muted=!1,a.autoplay=!0,e=!0,self.safariUnMutedVideo=t):(a.muted=!0,a.autoplay=!0)}}}))}))}var n}function x(e=!1){window.arController.makarObjects2D.forEach((t=>{if("video2D"==t.makarType&&0!=t.children.length&&t.children[0].material&&t.children[0].material.map&&t.children[0].material.map.image&&"VIDEO"==t.children[0].material.map.image.tagName){const a=t.children[0].material.map.image;a&&(a.muted=!0,e&&a.play())}}))}function M(e=!1){let t=document.getElementsByTagName("a-video");Array.from(t).forEach((t=>{let a=t.mp4Video,r=!0;t.object3D.traverseAncestors((function(o){"Scene"!=o.type?0==o.visible&&(r=!1):1!=r||1!=t.object3D.visible||t.blockly||(a.muted=!0,e&&a.play())}))}))}function I(){window.arController.makarObjects2D.forEach((e=>{if("video2D"==e.makarType&&0!=e.children.length&&e.children[0].material&&e.children[0].material.map&&e.children[0].material.map.image&&"VIDEO"==e.children[0].material.map.image.tagName){const a=e.children[0].material.map.image;if(a&&(t=a).currentTime>0&&!t.paused&&!t.ended&&t.readyState>2)try{a.pause()}catch(e){console.log("VideoModule.js, video pause error=",e)}}var t}))}function P(){let e=document.getElementsByTagName("a-video");Array.from(e).forEach((e=>{let t=e.mp4Video;if((a=t).currentTime>0&&!a.paused&&!a.ended&&a.readyState>2)try{t.pause()}catch(e){console.log("VideoModule.js, video pause error=",e)}var a}))}function z(e,t,a,r,o,n,i){let s=this;return new Promise((o=>{let n,l,c,d,u,m;if(4==Object.keys(s.editor_version).length){let e;if(Number(s.editor_version.v0),Number(s.editor_version.v1),Number(s.editor_version.v2),e=p(),!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void texture2DResolve(!1);n=e.rectP,l=e.rectSizeDelta,c=e.rectScale,d=e.rectR}else{let e=p();if(!(e.rectP&&e.rectSizeDelta&&e.rectScale))return void texture2DResolve(!1);n=e.rectP,l=e.rectSizeDelta,c=e.rectScale,d=e.rectR}function p(){let e,a,r,o,n={};if(t.transformAttr.rect_transform&&Array.isArray(t.transformAttr.rect_transform)&&t.transformAttr.rect_transform.length>0){Number.isFinite(s.selectedResolutionIndex)||(console.log(" _getObj2DInfo350: error, missing _selectedResolutionIndex"),s.selectedResolutionIndex=0);let l=t.transformAttr.rect_transform[s.selectedResolutionIndex];if(l.position&&l.size_delta&&l.rotation&&l.scale){e=l.position.split(",").map((function(e){return Number(e)})),a=l.size_delta.split(",").map((function(e){return Number(e)})),r=l.scale.split(",").map((function(e){return Number(e)})),o=l.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])),s=(new THREE.Euler).setFromQuaternion(t,"YXZ"),c=new THREE.Vector3(s.x,s.y,s.z);c.z=-1*c.z,i.x=r[0],i.y=r[1],n={rectP:e,rectSizeDelta:a,rectScale:r,rectR:c}}}return n}u=document.createElement("video"),u.src=t.res_url,u.playsInline=!0,u.autoplay=!0,u.loop=!0,u.setAttribute("crossorigin","anonymous"),u.setAttribute("id",t.generalAttr.obj_id+"_"+t.res_id+"_"+s.loadSceneCount),u.name4debug=t.generalAttr.obj_name,u.setAttribute("preload","auto"),window.Browser&&((null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(u.muted=!0),1==window.Browser.mobile&&(u.muted=!0,u.play())),m=new THREE.VideoTexture(u),m.colorSpace=THREE.SRGBColorSpace,m.flipY=!1,console.log("_loadVideo2D: mp4Texture",m),u.onloadedmetadata=function(){let c,p,h=s.scaleRatioXY;c=l[0]*h,p=l[1]*h;let g,_,b,f,y=new THREE.Object3D;y.makarType="video2D";let w,j=!1;if(makarUserData.scenesData.scenes[s.currentSceneIndex].behav&&Array.isArray(makarUserData.scenesData.scenes[s.currentSceneIndex].behav)&&(f=makarUserData.scenesData.scenes[s.currentSceneIndex].behav.find((e=>e.obj_id==t.generalAttr.obj_id&&"Transparent"==e.behav_type)),f)){console.log("%c VideoModule.js _loadVideo: transparentBehav=","color:BlanchedAlmond;",f),j=!0;let A=f.color.split(",");g=[parseFloat(A[0]),parseFloat(A[1]),parseFloat(A[2])],_=f.slope,b=f.threshold}if(j&&f){let E;if("RGB"==f.mode)E=new THREE.ChromaKeyMaterial({map:m,keyColor:g,side:THREE.DoubleSide,slope:_,threshold:b});else if("HSV"==f.mode){function C(e,t,a){let r=Math.max(e,t,a),o=r-Math.min(e,t,a),n=o&&(r==e?(t-a)/o:r==t?2+(a-e)/o:4+(e-t)/o);return[60*(n<0?n+6:n),r&&o/r,r]}let k=C(g[0],g[1],g[2]);k[0]/=360,console.log(`rgb: ${g} ,\n _hsv: (${k})`),E=new THREE.HSVMattingMaterial({map:m,side:THREE.DoubleSide,_keyingColorH:k[0],_keyingColorS:k[1],_keyingColorV:k[2],_deltaH:f.hue,_deltaS:f.saturation,_deltaV:f.brightness})}w=new THREE.Mesh(new THREE.PlaneBufferGeometry(c,p,0),E)}else w=new THREE.Mesh(new THREE.PlaneBufferGeometry(c,p,0),new THREE.MeshBasicMaterial({map:m,side:THREE.DoubleSide,transparent:!0}));let D=!1;const v={behav_type:"videoTogglePlayPause",obj_id:t.generalAttr.obj_id};if(t.behav?(y.behav=t.behav,y.behav.push(v),s.setObjectBehavAll(t)):y.behav=[v],0==t.generalAttr.active&&(y.visible=!1),y.makarObject=!0,y.obj_id=t.generalAttr.obj_id,t.generalAttr.obj_parent_id){u.autoplay=!1;let R=function(){let e=!1;for(let a=0;a<s.makarObjects2D.length;a++)s.makarObjects2D[a].obj_id==t.generalAttr.obj_parent_id&&(e=!0);if(0==e)setTimeout(R,500);else for(let e=0;e<s.makarObjects2D.length;e++)if(s.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id){y.scale.set(i.x,i.y,1),y.translateX(n[0]*h),y.translateY(-n[1]*h),y.translateZ(a/r-1),y.rotateZ(d.z),y.add(w),s.makarObjects2D[e].add(y),s.makarObjects2D.push(y);let l=!0;y.traverseAncestors((function(e){0==e.visible&&(l=!1),1==l&&1==y.visible?(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: all parent visible true=",y,D),u.autoplay=!0,u.play(),T(t,u),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==e.location?S(u,!0):1==window.Browser.mobile&&S(u,!1))):(console.log("VideoModule.js: _loadVideo2D: traverseAncestors: not all parent visible true=",l,videoPlane.object3D.visible,D),u.muted=!1,u.autoplay=!1,u.pause(),u.currentTime=0)})),o(y)}};R()}else console.log("______VRFunc.js: _loadTexture2D: obj() ",t),y.scale.set(i.x,i.y,1),y.translateX(n[0]*h),y.translateY(-n[1]*h),y.translateZ(a/r-1),y.rotateZ(d.z),u.autoplay=!0,T(t,u),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?S(u,!0):1==window.Browser.mobile&&S(u,!1)),s.makarObjects2D.push(y),e.add(y),y.add(w),y.makarObject=!0,y.obj_id=t.generalAttr.obj_id,o(y)}}))}function O(e,t,a,r,o,n,i,s){const l=this;let c=l.gcssTargets.dpi[e.GCSSID],d=l.gcssTargets.width[e.GCSSID],u=l.gcssTargets.height[e.GCSSID],p=document.createElement("a-entity");if(t.behav||t.generalAttr.logic?p.setAttribute("class","clickable"):p.setAttribute("class","unclickable"),p.setAttribute("id",t.generalAttr.obj_id),p.setAttribute("crossorigin","anonymous"),p.setAttribute("shadow",""),0==t.generalAttr.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable")),l.makarObjects.push(p),p.addEventListener("loaded",(r=>{console.log("_loadYoutubeNotSupport ytEntity.object3D",p.object3D);let n,h,g,_,b=new THREE.Vector3;if(t.generalAttr.obj_parent_id){p.object3D.obj_parent_id=t.generalAttr.obj_parent_id,b.addScaledVector(o,2540/c);let e=b.z;b.z=-e,m(p,b,0,i,s)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),b.addScaledVector(o,2540/c);break;case"3.0.0":i.multiplyScalar(2),b.addScaledVector(o,5080/c);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let e=b.y,t=b.z;b.y=t,b.z=e,m(p,b,0,i,s),p.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),p.object3D.rotation.x+=90*Math.PI/180}console.log("_loadYoutubeNotSupport ytEntity loaded"),p.object3D.makarObject=!0,p.object3D.makarType="youtube",t.behav&&(p.object3D.behav=t.behav),h=1.1,g=.65,n=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,.65,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),n.scale.set(25,25,1),t.behav_reference&&(n.behav_reference=t.behav_reference),p.object3D.add(n),console.log("_loadYoutubeNotSupport ytEntity loaded",n),_=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.1,.65,0),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0,opacity:.1})),p.object3D.add(_),_.position.set(0,0,0),_.rotation.set(0,0,0),_.scale.set(23.75,23.75,1),console.log("_loadYoutubeNotSupport ytEntity loaded",_);let f={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"youtube is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj_${l.currentSceneIndex}_${a}`,obj_name:t.generalAttr.obj_name+"_tempTexObj",obj_type:"3d",interactable:!1,obj_parent_id:t.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:["0,0,0","0,0,0,1","1,1,1"],rect_transform:[],simulated_rotation:"0,0,0"},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};l.loadText3D(e,f,new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),new THREE.Quaternion,!0).then((e=>{const t=e.object3D.clone();p.object3D.add(t),t.position.set(0,0,.005)}))})),t.generalAttr.obj_parent_id){let e=setInterval((()=>{let a=document.getElementById(t.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(p),window.clearInterval(e))}),1)}else e.appendChild(p),console.log("_loadYoutubeNotSupport ytEntity loaded",p)}function B(e,t,a,r,o,n,i){const s=this,l=c.F.getObj2DTransform(s.editor_version,t,a,r,o,n,i);let d,u,m,p,h,g;if(console.log("呼叫 getObj2DTransform trans=",l),!l)return!1;d=l.rectP,u=l.rectSizeDelta,m=l.rectScale,p=l.rectR,i.x=l.rectScale[0],i.y=l.rectScale[1];let _=s.scaleRatioXY;h=u[0]*_,g=u[1]*_;let b,f,y=new THREE.Object3D;y.makarObject=!0,y.makarType="youtube2D",y.obj_id=t.generalAttr.obj_id,t.behav&&(y.behav=t.behav),0==t.generalAttr.active&&(y.visible=!1),b=new THREE.Mesh(new THREE.PlaneBufferGeometry(h,g,0),new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.7})),f=new THREE.Mesh(new THREE.PlaneBufferGeometry(h,g,0),new THREE.MeshBasicMaterial({color:11184810,side:THREE.DoubleSide,transparent:!0,opacity:.1})),f.position.set(0,0,0),f.rotation.set(0,0,0),f.scale.set(.9,.9,.9),y.add(b),y.add(f);let w={res_id:"Text",typeAttr:{color:"0.6, 0.6, 0.6, 0.6",margin:0,content:"youtube is\nunsupported\ncurrently.",radious:0,back_color:"1,1,1,0",anchor_type:3},blocklyAttr:{uid:"",reference:!1},generalAttr:{logic:!1,active:!0,obj_id:`tempTextObj2D_${s.currentSceneIndex}_${a}`,obj_name:t.generalAttr.obj_name+"_tempTextObj2D",obj_type:"2d",interactable:!1,obj_parent_id:t.generalAttr.obj_id},materialAttr:{materials:[]},animationAttr:[],transformAttr:{transform:[],rect_transform:[{scale:"1,1,1",position:"0,0,0",rotation:"0,0,0,1",size_delta:t.transformAttr.rect_transform[s.selectedResolutionIndex].size_delta,simulated_rotation:"0,0,0"}],simulated_rotation:""},main_type:"text",sub_type:"txt",res_url:"https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/3D/sceneDefaultModels/Text.glb"};if(s.loadText2D(e,w,a,r,null,null,null,!0).then((e=>{console.log("YT後文字 result",e),e.position.z=.01})),t.generalAttr.obj_parent_id){let e=()=>{let o=!1;for(let e=0;e<s.makarObjects2D.length;e++)s.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(o=!0);if(0==o)setTimeout(e,200);else for(let e=0;e<s.makarObjects2D.length;e++)if(s.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id){y.translateX(d[0]*_),y.translateY(-d[1]*_),y.translateZ(a/r-1),y.rotateZ(p.z),y.scale.set(m[0],m[1],1),y.makarObject=!0,y.obj_id=t.generalAttr.obj_id,y.obj_parent_id=t.generalAttr.obj_parent_id,s.makarObjects2D[e].add(y),s.makarObjects2D.push(y);break}};e()}else y.scale.set(i.x,i.y,1),y.translateX(d[0]*_),y.translateY(-d[1]*_),y.translateZ(a/r-1),y.rotateZ(p.z),e.add(y),s.makarObjects2D.push(y)}function H(e,t,a,r,o,n){console.log("ARFunc.js: ARWrapper: _loadCurve, obj=",t,a,r,o);let i=this;return s(t),new Promise((function(r){let s=document.createElement("a-entity"),l=document.createElement("a-entity"),c=i.gcssTargets.dpi[e.GCSSID],d=i.gcssTargets.width[e.GCSSID],u=i.gcssTargets.height[e.GCSSID];if(s.setAttribute("id",t.generalAttr.obj_id+"_curve"),l.setAttribute("id",t.generalAttr.obj_id),l.setAttribute("crossorigin","anonymous"),i.makarObjects.push(s),i.makarObjects.push(l),s.appendChild(l),s.addEventListener("loaded",(function(e){for(let e=0;e<t.typeAttr.nodes.length-1;e++){let a,r,o,n,i=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e][1].split(",").map((e=>Number(e)))),l=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e][2].split(",").map((e=>Number(e)))),m=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e+1][0].split(",").map((e=>Number(e)))),p=(new THREE.Vector3).fromArray(t.typeAttr.nodes[e+1][1].split(",").map((e=>Number(e))));i.multiplyScalar(5080/c),o=i.y,n=i.z,i.y=n,i.z=o,i.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),l.multiplyScalar(5080/c),o=l.y,n=l.z,l.y=n,l.z=o,l.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),m.multiplyScalar(5080/c),o=m.y,n=m.z,m.y=n,m.z=o,m.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),p.multiplyScalar(5080/c),o=p.y,n=p.z,p.y=n,p.z=o,p.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),a=new THREE.CubicBezierCurve3(i,l,m,p);let h=new THREE.Color(16777215);h.setHex(16777215*Math.random()),r=new THREE.LineBasicMaterial({color:h});let g=new THREE.TubeGeometry(a,20,1,2,!1),_=new THREE.MeshBasicMaterial({color:h,side:THREE.DoubleSide}),b=new THREE.Mesh(g,_);b.visible=!1,s.object3D.add(b)}if(t.typeAttr.is_cycle){let e,a,r,o,n=(new THREE.Vector3).fromArray(t.typeAttr.nodes[t.typeAttr.nodes.length-1][1].split(",").map((e=>Number(e)))),i=(new THREE.Vector3).fromArray(t.typeAttr.nodes[t.typeAttr.nodes.length-1][2].split(",").map((e=>Number(e)))),l=(new THREE.Vector3).fromArray(t.typeAttr.nodes[0][0].split(",").map((e=>Number(e)))),m=(new THREE.Vector3).fromArray(t.typeAttr.nodes[0][1].split(",").map((e=>Number(e))));n.multiplyScalar(5080/c),r=n.y,o=n.z,n.y=o,n.z=r,n.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),i.multiplyScalar(5080/c),r=i.y,o=i.z,i.y=o,i.z=r,i.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),l.multiplyScalar(5080/c),r=l.y,o=l.z,l.y=o,l.z=r,l.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),m.multiplyScalar(5080/c),r=m.y,o=m.z,m.y=o,m.z=r,m.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),e=new THREE.CubicBezierCurve3(n,i,l,m);let p=new THREE.Color(16777215);p.setHex(16777215*Math.random()),a=new THREE.LineBasicMaterial({color:p});let h=new THREE.TubeGeometry(e,20,10,2,!1),g=new THREE.MeshBasicMaterial({color:p,side:THREE.DoubleSide}),_=new THREE.Mesh(h,g);_.visible=!1,s.object3D.add(_)}r(s)})),l.addEventListener("loaded",(function(e){let r=new THREE.Object3D;if(l.object3D.add(r),e.target==e.currentTarget){l.object3D.children[0].scale.set(2540/c,2540/c,2540/c),l.object3D.children[0].rotation.y=Math.PI;let e=new THREE.Vector3;if(t.generalAttr.obj_parent_id){l.object3D.obj_parent_id=t.generalAttr.obj_parent_id,e.addScaledVector(a,2540/c);let r=e.z;e.z=-r,m(l,e,0,o,n)}else{switch(window.serverVersion){case"2.0.0":o.multiplyScalar(1),e.addScaledVector(a,2540/c);break;case"3.0.0":o.multiplyScalar(2),e.addScaledVector(a,5080/c);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let t=e.y,r=e.z;e.y=r,e.z=t,m(l,e,0,o,n),l.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),l.object3D.rotation.x+=90*Math.PI/180,console.log("_loadCurveModule_: loaded: no parent prs=",l.object3D.position,l.object3D.rotation,l.object3D.scale)}}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let a=document.getElementById(t.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(s),window.clearInterval(e))}),100)}else e.appendChild(s)}))}function V(e,t,a){let r=this,o=document.getElementById(t.bezier_id).parentNode.object3D,n=t.period;if(n<=0)return;let i=t.shift_position.split(",").map((e=>Number(e))),s=t.shift_rotation.split(",").map((e=>Number(e))),l=new THREE.Quaternion(s[0],s[1],s[2],s[3]),c=(new THREE.Euler).setFromQuaternion(l,"XYZ");l.setFromEuler(new THREE.Euler(c.x,c.y,c.z));let d=[],u=[],m=[],p=0;for(let e=0;e<o.children.length;e++)"Mesh"==o.children[e].type&&(m.push(o.children[e]),p+=o.children[e].geometry.parameters.path.getLength());let h,g,_=r.scenesData.scenes[a].objs,b=!1;for(let e=0;e<_.length;e++)_[e].generalAttr.obj_id==t.bezier_id&&(h=_[e]),_[e].generalAttr.obj_id==t.obj_id&&"camera"==_[e].res_id&&(b=!0);b&&(t.obj_id="camera_cursor"),g=document.getElementById(t.obj_id);for(let e=0;e<h.typeAttr.nodes.length;e++){let t=h.typeAttr.nodes[e][1].split(",").map((e=>Number(e))),a=h.typeAttr.nodes[e][3].split(",").map((e=>Number(e)));d.push(new THREE.Vector3(-a[0],a[1],a[2]).sub(new THREE.Vector3(-t[0],t[1],t[2])));let r=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),d[e].normalize());u.push(r)}h.typeAttr.is_cycle&&(d.push(d[0]),u.push(u[0]));let f=r.gcssTargets.dpi[e.GCSSID],y=(r.gcssTargets.width[e.GCSSID],r.gcssTargets.height[e.GCSSID],1e3*p/(2*n*100*25.4/f)),w=new THREE.Vector3,j=(new THREE.Vector3,new THREE.Vector3),D=new THREE.Vector3,v=new THREE.Vector3,A=new THREE.Matrix4,E=new THREE.Quaternion,C=function(e){let t,a=new Array(e),r=new Array(e),o=0,n=0,i=0,s=m[n].geometry.parameters.path.getLengths(m[n].geometry.parameters.path.getLength()/p*e);for(let l=0;l<e;l++){l>(i+m[n].geometry.parameters.path.getLength())/p*e&&(i+=m[n].geometry.parameters.path.getLength(),n+=1,s=m[n].geometry.parameters.path.getLengths(m[n].geometry.parameters.path.getLength()/p*e)),t=m[n].geometry,o=(l-i/p*e)/(m[n].geometry.parameters.path.getLength()/p*e),t.parameters.path.getPoint(o,D),w=t.parameters.path.getTangent(o);let c=u[n].clone();c.slerp(u[n+1],s[Math.floor(o*(m[n].geometry.parameters.path.getLength()/p*e))]/t.parameters.path.getLength()),j.set(0,1,0),j.applyAxisAngle(new THREE.Vector3(1,0,0),90*Math.PI/180),j.applyQuaternion(c),a[l]=D.clone(),v.copy(D).add(w),A.lookAt(D,v,j),E.setFromRotationMatrix(A),r[l]=E.clone()}return[a,r]}(3e3);console.log(" -- PR = ",C);let k,T,S=!1;if("Direct"==t.trigger_type)S=!0;else{let e=document.getElementById(t.trigger_id);e.setAttribute("class","clickable"),null==e.object3D.behav&&(e.object3D.behav=[]),e.object3D.behav.push({trigger_type:"Click",trigger_obj_id:t.trigger_id,behav_type:"MoveAlongPath",switch_type:"On",obj_id:t.obj_id,group:"",reset:!1})}let R=new THREE.Quaternion;g.parentNode.object3D.getWorldQuaternion(R);let x=new THREE.Quaternion;e.object3D.getWorldQuaternion(x);var M={ratio:0};let I=anime({targets:M,ratio:3e3,loop:t.loop,easing:"linear",round:1,duration:y,autoplay:S,begin:function(){k=g.object3D.position.clone(),T=g.object3D.quaternion.clone()},update:function(){let t=C[0][M.ratio-1].clone(),a=new THREE.Vector3(i[0],i[1],i[2]);if(g.object3D.obj_parent_id)t.applyMatrix4(e.object3D.matrix),g.parentNode.object3D.worldToLocal(t),a.multiplyScalar(2540/f),a.z=-a.z,t.add(a);else{let e,r;a.multiplyScalar(5080/f),e=a.y,r=a.z,a.y=r,a.z=e,t.add(a)}let r=C[1][M.ratio-1].clone();r.premultiply(x.clone()),r.premultiply(R.clone().inverse()),r.multiply(l),g.object3D.position.copy(t),g.object3D.quaternion.copy(r)},complete:function(){g.object3D.position.copy(k),g.object3D.quaternion.copy(T)}});g.object3D.bezier=I}function F(e,t,a,r,o,n,i){console.log("ARFunc.js: ARWrapper: _loadScratchCard obj=",t,o,n,i);let l=this;return s(t),new Promise((function(s){const c=t.generalAttr.obj_id,d=makarUserData.oneProjData.proj_id;e.module="ScratchCard",e.loadModule="scratchCard",e.project_module=t.typeAttr.module,e.project_module.obj_id=c,e.proj_id=d;let u=new THREE.Object3D;u.makarType="scratchCard",u.visible=!0,0==t.generalAttr.active&&(u.visible=!1),u.makarObject=!0,u.obj_id=c,u.scale.set(i.x,i.y,1),u.translateX(o.x*l.scaleRatioXY),u.translateY(-o.y*l.scaleRatioXY),u.translateZ(a/r-1),u.rotateZ(n.z),l.makarObjects2D.push(u);let m=window.aScratchCard.makeTempObjJson(t,"Background");if(l.loadTexture2D(e,m,a,r).then((o=>{let n=localStorage.getItem("MakarUserID");n="",window.aScratchCard.getScratchCardProjectFromMDB(makarUserData.oneProjData.proj_id).then((n=>{console.log("ARController _loadMakarARScene: getScratchCardProjectFromMDB return=",n);const i=window.aScratchCard.createScratchCard(e,t,d);if(n.proj_id){const s=t.generalAttr.obj_id;if(n.scratchCards&&n.scratchCards[s]){let e=n.scratchCards[s];i.update(e,o)}else i.init(o),window.aScratchCard.loadNewCard(e,t,i,a,r)}else i.init(o),window.aScratchCard.loadNewCard(e,t,i,a,r);let c,m;console.log(i.scratchCardInfo);let p,h,g=window.aScratchCard.makeTempObjJson(t,"Scratch");switch(window.aScratchCard.clearScratchImage(document.getElementById("scratchCanvas")),i.scratchCardInfo.scratchCardState){case 0:c=window.aScratchCard.getScratchRandomAwardandUpdate(i),m=window.aScratchCard.makeTempObjJson(t,"Award",c),p=l.loadTexture2D(e,m,a,r),p.then((e=>{e.updateMatrixWorld(),h=window.aScratchCard.loadScratchImage(t.generalAttr.obj_id,g,e.matrixWorld.clone(),l.scaleRatioXY),h.then((t=>{e.visible=!0,window.aScratchCard.scratchCardExchangeDiv.innerText="尚未完成刮刮卡",window.aScratchCard.loadBrushSetting(t,e.matrixWorld.clone())}))})),console.log("init, getAwardIndex = ",c);break;case 1:c=i.scratchCardInfo.getAwardIndex,m=window.aScratchCard.makeTempObjJson(t,"Award",c),p=l.loadTexture2D(e,m,a,r),p.then((e=>{e.updateMatrixWorld(),h=window.aScratchCard.loadScratchImage(t.generalAttr.obj_id,g,e.matrixWorld.clone(),l.scaleRatioXY),h.then((t=>{e.visible=!0,window.aScratchCard.scratchCardExchangeDiv.innerText="尚未完成刮刮卡",window.aScratchCard.loadBrushSetting(t,e.matrixWorld.clone())}))})),console.log("scratched, getAwardIndex = ",c);break;case 2:c=i.scratchCardInfo.getAwardIndex,m=window.aScratchCard.makeTempObjJson(t,"Award",c),p=l.loadTexture2D(e,m,a,r),p.then((e=>{e.visible=!0,window.aScratchCard.getScratchCard(window.aScratchCard.currentScratchCardObjId).canExchange=!0,window.aScratchCard.scratchCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)",window.aScratchCard.scratchCardExchangeDiv.innerText="按此兌換獎項"})),console.log("getAward, getAwardIndex = ",c);break;case 3:c=i.scratchCardInfo.getAwardIndex,m=window.aScratchCard.makeTempObjJson(t,"Award",c),p=l.loadTexture2D(e,m,a,r),p.then((e=>{e.visible=!0,window.aScratchCard.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",window.aScratchCard.scratchCardExchangeDiv.innerText="已兌換"})),console.log("exchanged, getAwardIndex = ",c)}s(u)}))})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let a=null;for(let e=0;e<l.makarObjects2D.length;e++)l.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(a=l.makarObjects2D[e]);a&&a.children.length>0&&(a.add(u),window.clearInterval(e))}),10)}else e.add(u)}))}function L(e,t,a,r,o,n,i,s){console.log("ARFunc.js: ARWrapper: _loadPointCard obj=",t);let c=this,d=new Promise((function(n){const i=t.generalAttr.obj_id,s=makarUserData.oneProjData.proj_id;e.module="PointCard",e.loadModule="pointCard",e.project_module=t.typeAttr.module,e.project_module.obj_id=i,e.proj_id=s;const d=window.aPointCard.createPointCard(e,t,s);let u=c.scaleRatioXY,m=c.selectedResolutionIndex;m||(m=0);let p=(new THREE.Vector3).fromArray(t.transformAttr.rect_transform[m].position.split(",").map((e=>Number(e)))),h=(new THREE.Vector4).fromArray(t.transformAttr.rect_transform[m].rotation.split(",").map((e=>Number(e)))),g=(new THREE.Vector3).fromArray(t.transformAttr.rect_transform[m].scale.split(",").map((e=>Number(e)))),_=new THREE.Quaternion(h.x,h.y,h.z,h.w),b=(new THREE.Euler).setFromQuaternion(_,"YXZ"),f=new THREE.Vector3(b.x,b.y,b.z);f.z=-1*f.z;let y,w=new THREE.Object3D;d.pointCardEntity=w,w.translateX(p.x*u),w.translateY(-p.y*u),w.translateZ(a/r-1),w.rotateZ(f.z),w.scale.set(g.x,g.y,1),c.makarObjects2D.push(w),t.behav&&(w.behav=t.behav,c.setObjectBehavAll(t)),w.visible=!0,0==t.generalAttr.active&&(w.visible=!1),w.makarObject=!0,w.makarType="pointCard",w.obj_id=t.generalAttr.obj_id,t.typeAttr.module.backgroundID?"PointCard_Background"==t.typeAttr.module.backgroundID?y="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png":makarUserData.userProjResDict[t.typeAttr.module.backgroundID]&&(y=makarUserData.userProjResDict[t.typeAttr.module.backgroundID].res_url):y="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/pointCard/PointCard_Background.png";let j={res_id:t.typeAttr.module.backgroundID,transformAttr:{rect_transform:t.typeAttr.module.rectTransform},generalAttr:{obj_id:t.typeAttr.module.backgroundID,obj_type:"2d",obj_parent_id:t.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},typeAttr:{placeholder:"placeholder"},sub_type:"jpg",res_url:y};if(j.res_url||l(j),c.loadTexture2D(e,j,a,r,null,null,{x:null,y:null}).then((l=>{let c=localStorage.getItem("MakarUserID");{c="";let u=localStorage.getItem("device_id");u||(u=(new Date).getTime()+"_"+makeid(10),localStorage.setItem("device_id",u)),o?window.aPointCard.getPointCardProjectFromMDB(s).then((n=>{let s=t.typeAttr.module.points.find((e=>e.targetID==o));n.proj_id&&n.pointCards&&n.pointCards[i]?aPointCard.addPoint(n,i,s.targetID).then((o=>{d.update(o.pointCards[i],l);const c=n!=o;aPointCard.loadCardWithAddedPoint(e,d,t,s,a,r,o,c)})):(d.init(s.targetID,l),window.aPointCard.loadNewCard(e,t,d,s,a,r))})):window.aPointCard.getPointCardProjectFromMDB(s).then((o=>{window.aPointCard.loadCardWithAddedPoint(e,d,t,null,a,r,o,!1)})),n(w)}})),t.generalAttr.obj_parent_id){let e=setInterval((function(){let a=null;for(let e=0;e<c.makarObjects2D.length;e++)c.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(a=c.makarObjects2D[e]);a&&a.children.length>0&&(a.add(w),window.clearInterval(e))}),10)}else e.add(w)}));return d}const W=class{getProjectIdx(){}addTextToScene(){}addTextureToScene(){}addGLTFModelToScene(){}addAudioToScene(){}addVideoToScene(){}pushObjectToMakarObjects(){}setTransform(){}appendToArScene(){}initTest(){console.log("AddObjectToArController.initTest: ",window.ArController)}};class U extends W{type="Quiz";obj_id;obj_type;isButtonPushed=!1;isPlaying=!0;isPlayed=!1;module={};currentProjData={};scene3DRoot;scene2DRoot;record=[];constructor(e){super(),this.obj_id=e.generalAttr.obj_id,this.obj_type=e.generalAttr.obj_type,window.arController&&(this.currentProjData.user_id=window.arController.currentProjData.user_id,this.currentProjData.proj_id=window.arController.currentProjData.proj_id,this.currentProjData.head_pic=window.arController.currentProjData.head_pic,this.currentProjData.loc=window.arController.currentProjData.loc,this.currentProjData.module_type=window.arController.currentProjData.module_type,this.currentProjData.name=window.arController.currentProjData.name,this.currentProjData.proj_cover_urls=window.arController.currentProjData.proj_cover_urls,this.currentProjData.proj_name=window.arController.currentProjData.proj_name,this.currentProjData.shared_id=window.arController.currentProjData.shared_id,this.currentProjData.snapshot_url=window.arController.currentProjData.snapshot_url),this.module=e.typeAttr.module}addTextToScene(e,t,a,r,o,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadText3D(this.scene3DRoot,e,t,a,r,o):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadText2D(this.scene2DRoot,e,n,i,t,a,r):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}addTextureToScene(e,t,a,r,o,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadTexture3D(this.scene3DRoot,e,t,a,r,o):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadTexture2D(this.scene2DRoot,e,n,i,t,a,r):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}addGLTFModelToScene(e,t,a,r,o){if("3d"==e.generalAttr.obj_type&&this.checkScene3DRoot())return window.arController.loadGLTFModel(this.scene3DRoot,e,t,a,r,o);console.log("%c quiz loadGLTFModel: quiz currently does not support GLTFModel in 2D scene.","color:tomato;")}addAudioToScene(e,t,a,r,o){if("3d"==e.generalAttr.obj_type&&this.checkScene3DRoot())return window.arController.loadAudio(this.scene3DRoot,e,t,a,r,o);console.log("%c quiz loadAudio: quiz currently does not support Audio in 2D scene.","color:tomato;")}addVideoToScene(e,t,a,r,o,n=0,i=1){return"3d"==e.generalAttr.obj_type&&this.checkScene3DRoot()?window.arController.loadVideo3D(this.scene3DRoot,e,t,a,r,o):"2d"==e.generalAttr.obj_type&&this.checkScene2DRoot()?window.arController.loadVideo2D(this.scene2DRoot,e,n,i,t,a,r):void console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}pushToMakarObjects(e){window.arController.makarObjects&&Array.isArray(window.arController.makarObjects)?window.arController.makarObjects.push(e):console.warn("window.arController.makarObjects does not exist")}pushToMakarObjects2d(e){window.arController.makarObjects2D&&Array.isArray(window.arController.makarObjects2D)?window.arController.makarObjects2D.push(e):console.warn("window.arController.makarObjects does not exist")}setTransform(e,t,a,r){!function(e,t,a,r){console.log("VRFunc.js: setTransform: obj=",e,"\n position=",t,"\n rotation=",a,"\n scale=",r);let o=t.clone();o.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",o);let n=a.clone();n.multiply(new THREE.Vector3(1,-1,-1)),e.setAttribute("rotation",n),e.setAttribute("scale",r)}(e,t,a,r)}setARTransform(e,t,a,r,o){window.arController.setARTransform(e,t,a,r,o)}appendToArScene(e,t){if(this.checkScene3DRoot())if(t.generalAttr.obj_parent_id){console.log("jsonObj.generalAttr.obj_parent_id",t.generalAttr.obj_parent_id);let a=setInterval((function(){let r=document.getElementById(t.generalAttr.obj_parent_id);r&&r.object3D.children.length>0&&(r.appendChild(e),window.clearInterval(a))}),1)}else console.log("quizEntity",e),this.scene3DRoot.appendChild(e)}appendToArScene2d(e,t){if(this.checkScene2DRoot())if(t.generalAttr.obj_parent_id){let a=setInterval((function(){let r=null;for(let e=0;e<window.arController.makarObjects2D.length;e++)window.arController.makarObjects2D[e].obj_id==t.generalAttr.obj_parent_id&&(r=window.arController.makarObjects2D[e]);r&&r.children.length>0&&(r.add(e.object3D),console.log("quizEntity.object3D",e.object3D),window.clearInterval(a))}),10)}else this.scene2DRoot.add(e.object3D)}checkScene3DRoot(){return!!this.scene3DRoot||(console.warn("scene3DRoot does not exist, or quiz is not loaded. scene3DRoot=",this.scene3DRoot),!1)}checkScene2DRoot(){return!!this.scene2DRoot||(console.warn("scene2DRoot does not exist, or quiz is not loaded. scene2DRoot=",this.scene2DRoot),!1)}clearObject(){if("3d"==this.obj_type){let e=[],t=this.module.quizEntity;for(let a of t.children)e.push(a);e.forEach((e=>{for(let t=0;t<window.arController.makarObjects.length;t++)if(window.arController.makarObjects[t].id==e.id){let e=window.arController.makarObjects[t];if(e.getAttribute("src")){let t=e.getAttribute("src").split("#")[1];document.getElementById(t)&&document.getElementById(t).remove()}e.remove(),window.arController.makarObjects.splice(t,1)}}))}else if("2d"==this.obj_type){let e=this.module.quizEntity.object3D.children;e.forEach((e=>{arController.makarObjects2D=arController.makarObjects2D.filter((t=>t!==e))})),e.length=0}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d")}setTypesFromUserRes(e){if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[e.res_id])makarUserData.userProjResDict[e.res_id].res_url&&(e.res_url=makarUserData.userProjResDict[e.res_id].res_url),makarUserData.userProjResDict[e.res_id].main_type&&(e.main_type=makarUserData.userProjResDict[e.res_id].main_type),makarUserData.userProjResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userProjResDict[e.res_id].sub_type);else if(makarUserData.userOnlineResDict[e.res_id])makarUserData.userOnlineResDict[e.res_id].res_url&&(e.res_url=makarUserData.userOnlineResDict[e.res_id].res_url),makarUserData.userOnlineResDict[e.res_id].main_type&&(e.main_type=makarUserData.userOnlineResDict[e.res_id].main_type),makarUserData.userOnlineResDict[e.res_id].sub_type&&(e.sub_type=makarUserData.userOnlineResDict[e.res_id].sub_type);else switch(l(e),e.res_id){case"Text":e.main_type=e.res_id.toLowerCase(),e.sub_type="txt";break;case"Button":e.main_type=e.res_id.toLowerCase(),e.main_type="button",e.sub_type="button";break;default:["Cube","Capsule","Sphere","ch_Bojue","ch_Fei","ch_Lina","ch_Poyuan","ch_Roger"].find((t=>t==e.res_id))&&(e.main_type="model")}else console.warn("Quiz.js: setTypesFromUserRes: userProjResDict or userOnlineResDict does not exist. obj=",e);return e}load(e,t,a,r){this.scene3DRoot=e,this.scene2DRoot=t;const o=r.position,n=r.rotation,s=r.scale,l=r.quaternion,c=r.panByScene3DRoot.dpi,d=r.panByScene3DRoot.GCSSWidth,u=r.panByScene3DRoot.GCSSHeight;let m=document.createElement("a-entity");m.setAttribute("id",a.generalAttr.obj_id),m.object3D.makarType="quiz";let p=new THREE.Object3D;if("3d"==a.generalAttr.obj_type)this.pushToMakarObjects(m),m.addEventListener("loaded",(function(){let e=new THREE.Object3D;if(e.obj_id=a.generalAttr.obj_id,e.makarType="quiz",e.makarObject=!0,m.object3D.add(e),a.generalAttr.obj_parent_id){m.object3D.obj_parent_id=a.generalAttr.obj_parent_id;let e=new THREE.Vector3;switch(window.serverVersion){case"2.0.0":case"3.0.0":s.multiplyScalar(1),e.addScaledVector(o,2540/c);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let t=e.y,r=e.z;e.y=r,e.z=t,window.arController.setARTransform(m,e,n,s,l)}else{let e=new THREE.Vector3;switch(window.serverVersion){case"2.0.0":s.multiplyScalar(1),e.addScaledVector(o,2540/c);break;case"3.0.0":s.multiplyScalar(2),e.addScaledVector(o,5080/c);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let t=e.y,a=e.z;e.y=a,e.z=t,window.arController.setARTransform(m,e,n,s,l),m.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),m.object3D.rotation.x+=90*Math.PI/180,console.log("_loadGLTFModel_: loaded: no parent prs=",m.object3D.position,m.object3D.rotation,m.object3D.scale)}}));else if("2d"==a.generalAttr.obj_type){let e=window.arController.scaleRatioXY,t=window.arController.selectedResolutionIndex;t||(t=0);let r=(new THREE.Vector3).fromArray(a.transformAttr.rect_transform[t].position.split(",").map((e=>Number(e)))),o=(new THREE.Vector4).fromArray(a.transformAttr.rect_transform[t].rotation.split(",").map((e=>Number(e)))),n=(new THREE.Vector3).fromArray(a.transformAttr.rect_transform[t].scale.split(",").map((e=>Number(e)))),i=new THREE.Quaternion(o.x,o.y,o.z,o.w),s=(new THREE.Euler).setFromQuaternion(i,"YXZ"),l=new THREE.Vector3(s.x,s.y,s.z);l.z=-1*l.z,p.obj_id=a.generalAttr.obj_id,p.makarType="quiz2D",p.makarObject=!0,m.object3D=p,p.translateX(r.x*e),p.translateY(-r.y*e),p.translateZ(1),p.rotateZ(l.z),p.scale.set(n.x,n.y,1),this.pushToMakarObjects2d(p),a.behav&&(p.behav=a.behav,self.setObjectBehavAll(a)),p.visible=!0,0==a.generalAttr.active&&(p.visible=!1)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let h=[];for(let e=0;e<a.typeAttr.module.question_list.length;e++)a.typeAttr.module.question_list[e].allowRandom&&h.push(e);if(!a.typeAttr.module.display_order_list)return void console.warn("Quiz.js _load: ERROR - user has not set display_order_list. obj.typeAttr.module=",a.typeAttr.module);let g=0;for(let e=0;e<a.typeAttr.module.display_order_list.length;e++){let t=a.typeAttr.module.display_order_list[e].index;if(-1==t){let r=(_=h.length,Math.floor(Math.random()*Math.floor(_))),o=h[r];a.typeAttr.module.display_order_list[e].index=o,t=o,h.splice(r,1)}a.typeAttr.module.question_list[t].active_score&&(g+=1)}var _;let b=a.typeAttr.module.display_order_list[0].index,f=a.typeAttr.module.question_list[b],y=document.getElementById("timerContent"),w=-1;if("Total"==a.typeAttr.module.timer_type){w=a.typeAttr.module.total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(w/3600),t=Math.floor((w-3600*e)/60),r=w-3600*e-60*t;y.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==a.typeAttr.module.timer_type){w=f.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(w/3600),t=Math.floor((w-3600*e)/60),a=w-3600*e-60*t;y.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")}let j=document.getElementById("tipButtonDiv");f.show_tips?(j.style.display="block",j.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),a=document.getElementById("tipContent");e.style.display="block",a.textContent=f.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):j.style.display="none",this.module={json:a.typeAttr.module,quizEntity:m,currentIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:g,record:new Array(a.typeAttr.module.question_list.length),timer:{currentTimer:null,counter:w},record_time:0,qClock:Date.now()};let D=document.getElementById("scoreDiv");if(D.addEventListener("click",(()=>{D.style.display="none",this.nextQuestion()})),f.trigger_type&&"Target"==f.trigger_type)return console.log("%c _quiz _load _first_question 辨識圖觸發 目前web暫時跳過","color: Khaki"),"3d"==a.generalAttr.obj_type?this.appendToArScene(m,a):(this.setTransform(m,o,n,s),this.appendToArScene2d(m,a)),void this.nextQuestion();if(f.questions_json&&Array.isArray(f.questions_json))for(let e=0;e<f.questions_json.length;e++)this.loadQuestion(f.questions_json[e]);if(f.options_json){for(let e=0;e<f.options_json.length;e++){let{pOption:t,sub_type:a}=this.loadOption(f.options_json[e]);if("button"!=a&&("MutiOption_Text"==f.option_type||"MutiOption_Image"==f.option_type)){if(0==i(t))continue;t.then((e=>{let t=e,a=new THREE.Vector3(0,0,0),r=new THREE.Vector3(0,0,0),o=new THREE.Vector3(1,1,1);if(new THREE.Quaternion,"MutiOption_Text"==f.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(t,a,r,o);break;case"2d":this.multiOptionTextCircle2d(t,a,r,o);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==f.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),t.getAttribute("heightForQuiz")&&(t.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(t,a,r,o),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(t,a,r,o);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}if(this.module.timer.counter>=0){this.module.qClock=Date.now();let e=setInterval((()=>{this.module.timer.currentTimer=e,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let t=Math.floor(this.module.timer.counter/3600),r=Math.floor((this.module.timer.counter-3600*t)/60),o=this.module.timer.counter-3600*t-60*r;if(y.textContent=t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0"),0==this.module.timer.counter)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==a.typeAttr.module.timer_type)if(f.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let a=document.getElementById("startQuiz"),r=document.getElementById("QuizStartButton"),o=document.getElementById("QuizStartContent");a.style.display="block",o.textContent="時間到";let n={question:b,get_score:0,answer_time:this.module.json.question_list[b].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[b]=n,this.record[b]=n,this.module.record_time+=this.module.json.question_list[b].time_limit,this.module.qClock=Date.now(),r.addEventListener("click",(()=>{a.style.display="none",this.saveQuizStatus()}))}}),1e3)}"3d"==a.generalAttr.obj_type?this.appendToArScene(m,a):this.appendToArScene2d(m,a)}else console.warn("_quiz _load: data might be incorrect, first_question.options_json=",f.options_json)}loadQuestion(e){let t=c.F.getObjTransform(window.arController.scenesData,e),a=t.position,r=t.rotation,o=t.scale,n=t.quaternion;if("3d"==e.generalAttr.obj_type)console.log("Quiz _loadQuestion VC objTranform",a,r,o);else if("2d"==e.generalAttr.obj_type){let e=window.arController.selectedResolutionIndex;window.arController.selectedResolutionIndex||(e=0)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let i,s=this.setTypesFromUserRes(e);switch(s.main_type){case"text":i=this.addTextToScene(s,a,r,o,n);break;case"image":i=this.addTextureToScene(s,a,r,o,n,0,1);break;case"video":i=this.addVideoToScene(s,a,r,o,n);break;case"model":i=this.addGLTFModelToScene(s,a,r,o,n);break;case"audio":i=this.addAudioToScene(s,a,r,o,n)}return i}loadOption(e){let t=c.F.getObjTransform(window.arController.scenesData,e),a=t.position,r=t.rotation,o=t.scale,n=t.quaternion;if("3d"==e.generalAttr.obj_type)console.log("Quiz loadOption VC objTranform",a,r,o);else if("2d"==e.generalAttr.obj_type){let e=window.arController.selectedResolutionIndex;window.arController.selectedResolutionIndex||(e=0)}else console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");let i=e;if(makarUserData.userProjResDict||"object"==typeof makarUserData.userOnlineResDict)if(makarUserData.userProjResDict[i.res_id])makarUserData.userProjResDict[i.res_id].res_url&&(i.res_url=makarUserData.userProjResDict[i.res_id].res_url),makarUserData.userProjResDict[i.res_id].sub_type&&(i.sub_type=makarUserData.userProjResDict[i.res_id].sub_type);else if(makarUserData.userOnlineResDict[i.res_id])makarUserData.userOnlineResDict[i.res_id].res_url&&(i.res_url=makarUserData.userOnlineResDict[i.res_id].res_url),makarUserData.userOnlineResDict[i.res_id].sub_type&&(i.sub_type=makarUserData.userOnlineResDict[i.res_id].sub_type);else switch(l(i),i.main_type="button",i.res_id){case"Text":i.main_type=i.res_id.toLowerCase(),i.sub_type="txt";break;case"Button":i.main_type=i.res_id.toLowerCase(),i.sub_type="button"}else console.warn("Quiz.js: loadOption: userProjResDict or userOnlineResDict does not exist. obj=",i);if(i.behav){let e=!1;i.behav.forEach((t=>{"QuizOption"==t.behav_type&&(e=!0)})),e||i.behav.push({behav_type:"QuizOption"})}else i.behav=[{behav_type:"QuizOption"}];i.main_type="button";let s,d=i.sub_type;switch(d){case"txt":s=this.addTextToScene(i,a,r,o,n);break;case"gif":case"jpg":case"jpeg":case"png":s=this.addTextureToScene(i,a,r,o,n);break;case"button":i.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",s=this.addTextureToScene(i,a,r,o,n)}return{pOption:s,sub_type:d}}multiOptionTextCircle3d(e,t,a,r,o=.7){let n=document.createElement("a-plane");n.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),n.setAttribute("id","circle_base"),n.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),e.appendChild(n);let i=document.createElement("a-plane");i.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),i.setAttribute("id","circle_out"),i.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),e.appendChild(i);let s=document.createElement("a-plane");s.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),s.setAttribute("id","circle_in"),s.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),s.setAttribute("visible",!1),e.appendChild(s);let l=2*Math.abs(e.getObject3D("mesh").geometry.attributes.position.array[0]);t.x=t.x+.5*l+.3/e.object3D.parent.el.getAttribute("scale").x,t.z=t.z-.01,n.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),i.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1))),s.setAttribute("position",t.clone().multiply(new THREE.Vector3(-1,1,1)));let c=new THREE.Vector3(1,1,1).multiply(e.object3D.scale).multiply(e.object3D.parent.scale).multiply(e.object3D.parent.parent.scale),d=e.object3D.children[1].scale.clone().multiply(c),u=Math.max(d.x,d.y);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(u)),r.divide(e.object3D.parent.el.getAttribute("scale")),n.setAttribute("scale",r),i.setAttribute("scale",r),s.setAttribute("scale",r.multiplyScalar(.7));let m=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};n.addEventListener("loaded",m),i.addEventListener("loaded",m),s.addEventListener("loaded",m)}multiOptionTextCircle2d(e,t,a,r,o=.7){let n=e.children[0].children[1],i=n.scale.clone(),s=e.children[0].getWorldScale(new THREE.Vector3),l=Math.max(i.x*n.geometry.parameters.width,i.y*n.geometry.parameters.height);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(l)),r.divide(s);let c=n.geometry.parameters.width*i.x,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(a){t.x=.5*-c-64*r.x;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));o.name="circle_base",o.position.copy(t.clone()),o.scale.copy(r.clone()),e.children[0].add(o);let n=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(r.clone().multiplyScalar(.7)),e.children[0].add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(a){t.x=.5*-c-64*r.x;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));o.name="circle_out",o.renderOrder=1,o.position.copy(t.clone()),o.scale.copy(r.clone().multiplyScalar(.9)),e.children[0].add(o)}))}multiOptionImageCircle3d(e,t,a,r,o=50){let n=e.object3D.getWorldScale(new THREE.Vector3),i=e.object3D.scale.clone(),s=Math.max(i.x,i.y);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(s)),r.divide(n);let l=e.object3D.children[0].scale.clone();t.y=.5*-r.y-.6*l.y;let c=document.createElement("a-plane");c.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),c.setAttribute("id","circle_base"),c.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),this.setTransform(c,t,a,r),e.appendChild(c);let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),d.setAttribute("id","circle_out"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),this.setTransform(d,t,a,r),e.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id","circle_in"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),u.setAttribute("visible",!1),r.multiply(new THREE.Vector3(.7,.7,.7)),this.setTransform(u,t,a,r),e.appendChild(u);let m=function(e){e.target==e.currentTarget&&e.target.object3D&&e.target.object3D.children[0]&&(e.target.object3D.children[0].renderOrder=1)};c.addEventListener("loaded",m),d.addEventListener("loaded",m),u.addEventListener("loaded",m)}multiOptionImageCircle2d(e,t,a,r,o=.0025){let n=e.getWorldScale(new THREE.Vector3),i=e.scale.clone(),s=Math.max(i.x*e.children[0].geometry.parameters.width,i.y*e.children[0].geometry.parameters.height);r.multiply(new THREE.Vector3(o,o,o).multiplyScalar(s)),r.divide(n);let l=e.children[0].scale.clone(),c=e.children[0].geometry.parameters.height,d=new THREE.TextureLoader,u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png";d.load(u,(function(a){t.y=l.y*c*.5+48*r.y;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));o.name="circle_base",o.position.copy(t.clone()),o.scale.copy(r.clone()),e.add(o);let n=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(t.clone()),n.scale.copy(r.clone().multiplyScalar(.7)),e.add(n)})),u="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",d.load(u,(function(a){t.y=l.y*c*.5+48*r.y;let o=new THREE.Mesh(new THREE.PlaneGeometry(a.image.width,a.image.height),new THREE.MeshBasicMaterial({map:a,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));o.name="circle_out",o.renderOrder=1,o.position.copy(t.clone()),o.scale.copy(r.clone().multiplyScalar(.9)),e.add(o)}))}quizOption(e){if(window.aQuizAR.checkIs2DPictureShowing())return;if(this.isButtonPushed)return;let t,a=[],r=!1,o=0,n=this.module.json.display_order_list[this.module.currentIndex].index,i=this.module.json.question_list[n],s=this.module.json.score_type,l=document.getElementById("makarDragon"),c=document.getElementById("imgRight"),d=document.getElementById("imgWrong");if("3d"==this.obj_type?t="a-text"==e.localName?e.parentNode.id:e.id:"2d"==this.obj_type?t=e.obj_id:console.log("%c _quiz _quizOption: target=","color:tomato;",e),"Option_Text"==i.option_type||"Option_Image"==i.option_type){this.isButtonPushed=!0,null==i.answer_list&&(i.answer_list=[]);let e=i.answer_list[0],u=i.options_json[e-1];for(let e=0,r=i.options_json.length;e<r;e++)i.options_json[e].generalAttr.obj_id==t&&a.push(e);if(u&&u.generalAttr.obj_id==t){if(i.active_score)if("Custom"==s)this.module.score+=i.score,o=i.score;else if("Total"==s){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),o=Math.round(e/this.module.totalActiveScoreQuestion)}r=!0,l.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else r=!1,l.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer),setTimeout((()=>{l.style.display="none";let e={question:n,get_score:o,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:a,answer_cloze:"",answer_is_enable:!0,answer_is:r};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),i.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,i)}else{if("MutiOption_Text"!=i.option_type&&"MutiOption_Image"!=i.option_type)return;{let u="3d"==this.obj_type?e.object3D:e;if(u.traverse((a=>{if("3d"==this.obj_type){if("Group"==a.type&&a.el&&"circle_in"==a.el.getAttribute("id")){let t,r=a.el;if(r.setAttribute("visible",!r.getAttribute("visible")),t="a-text"==e.localName?e.parentNode.id:e.id,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);console.log("Quiz.js: _pushButton: choices = ",this.module.choices)}else if("Group"==a.type&&a.el&&"circle_out"==a.el.getAttribute("id")){let e=a.el;"#7B7B7B"==e.getAttribute("material").color?e.setAttribute("material","color:#00d1c1;"):"#00d1c1"==e.getAttribute("material").color&&e.setAttribute("material","color:#7B7B7B;")}}else if("2d"!=this.obj_type||"text2D"!=e.makarType&&"image2D"!=e.makarType)console.log("_Quiz _loadQuestion: There shall not be any type except for 2d3d");else if(a.isMesh){if("circle_in"==a.name)if(a.visible=!a.visible,this.module.choices.includes(t)){let e=this.module.choices.indexOf(t);this.module.choices.splice(e,1)}else this.module.choices.push(t);"circle_out"==a.name&&("7b7b7b"==a.material.color.getHexString()?a.material.color.setStyle("#00d1c1"):"00d1c1"==a.material.color.getHexString()&&a.material.color.setStyle("#7b7b7b"))}})),"button"==u.sub_type){this.isButtonPushed=!0;let e=0;null==i.answer_list&&(i.answer_list=[]);for(let t of i.answer_list){let a=i.options_json[t];if(a)for(let t of this.module.choices)t==a.generalAttr.obj_id&&(e+=1)}for(let e=0,t=i.options_json.length;e<t;e++)for(let t=0,r=this.module.choices.length;t<r;t++)i.options_json[e].generalAttr.obj_id==this.module.choices[t]&&a.push(e-1);if(e==i.answer_list.length&&i.answer_list.length==this.module.choices.length){if(i.active_score)if("Custom"==s)this.module.score+=i.score,o=i.score;else if("Total"==s){let e=this.module.json.total_score;this.module.correctAnswer+=1,this.module.score=Math.round(e*this.module.correctAnswer/this.module.totalActiveScoreQuestion),o=Math.round(e/this.module.totalActiveScoreQuestion)}r=!0,l.style.display="block",c.style.display="block",d.style.display="none",console.log("Quiz.js: _pushButton: Congratulations! Correct Answer!")}else r=!1,l.style.display="block",c.style.display="none",d.style.display="block",console.log("Quiz.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(this.module.timer.currentTimer),setTimeout((()=>{l.style.display="none";let e={question:n,get_score:o,answer_time:Math.round((Date.now()-this.module.qClock)/1e3),answer_options:a,answer_cloze:"",answer_is_enable:!0,answer_is:r};if(this.module.record[n]=e,this.record[n]=e,this.module.record_time+=Math.round((Date.now()-this.module.qClock)/1e3),this.module.qClock=Date.now(),i.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion()}),1600),console.log("Quiz.js: _pushButton: score: ",this.module.score,i)}}}}nextQuestion(){if(this.isButtonPushed=!1,this.module.choices=[],window.clearInterval(this.module.timer.currentTimer),this.clearObject(),this.module.currentIndex+=1,this.module.currentIndex<this.module.json.display_order_list.length){let e=this.module.json.display_order_list[this.module.currentIndex].index,t=this.module.json.question_list[e];"Custom"==this.module.json.timer_type&&(this.module.timer.counter=t.time_limit);let a=document.getElementById("tipButtonDiv");if(t.show_tips?(a.style.display="block",a.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),a=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=t.tips_content,a.addEventListener("click",(function(){e.style.display="none"}))}))):a.style.display="none",t.trigger_type&&"Target"==t.trigger_type)return console.log("%c _quiz _nextQuestion 辨識圖觸發 目前web暫時跳過","color: Khaki"),void this.nextQuestion();if(t.questions_json&&Array.isArray(t.questions_json))for(let e=0;e<t.questions_json.length;e++)this.loadQuestion(t.questions_json[e]);if(!t.options_json||!Array.isArray(t.options_json))return void console.warn("_quiz _load: data might be incorrect, first_question.options_json=",first_question.options_json);for(let e=0;e<t.options_json.length;e++){let{pOption:a,sub_type:r}=this.loadOption(t.options_json[e]);if("button"!=r&&("MutiOption_Text"==t.option_type||"MutiOption_Image"==t.option_type)){if(0==i(a))continue;a.then((e=>{let a=e,r=new THREE.Vector3(0,0,0),o=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1);if("MutiOption_Text"==t.option_type)switch(this.obj_type){case"3d":this.multiOptionTextCircle3d(a,r,o,n);break;case"2d":this.multiOptionTextCircle2d(a,r,o,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else if("MutiOption_Image"==t.option_type)switch(this.obj_type){case"3d":let e=setInterval((()=>{this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer),a.getAttribute("heightForQuiz")&&(a.getAttribute("heightForQuiz"),this.multiOptionImageCircle3d(a,r,o,n),window.clearInterval(e))}),1);break;case"2d":this.multiOptionImageCircle2d(a,r,o,n);break;default:console.log("_Quiz _load: There shall not be any type except for 2d3d")}else console.warn("MultiOption should be either MutiOption_Text or MutiOption_Image.")}))}}let r=document.getElementById("timerContent");if("Custom"==this.module.json.timer_type&&this.module.timer.counter>=0){let e=Math.floor(this.module.timer.counter/3600),t=Math.floor((this.module.timer.counter-3600*e)/60),a=this.module.timer.counter-3600*e-60*t;r.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")}setTimeout((()=>{if(this.module.timer.counter>=0){this.module.qClock=Date.now(),window.clearInterval(this.module.timer.currentTimer);let a=setInterval((()=>{this.module.timer.currentTimer=a,this.module.timer.counter-=1,this.module.currentIndex>=this.module.json.display_order_list.length&&window.clearInterval(this.module.timer.currentTimer);let o=Math.floor(this.module.timer.counter/3600),n=Math.floor((this.module.timer.counter-3600*o)/60),i=this.module.timer.counter-3600*o-60*n;if(r.textContent=o.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0"),this.module.timer.counter<=0)if(window.clearInterval(this.module.timer.currentTimer),"Custom"==this.module.json.timer_type)if(t.show_score){let e=document.getElementById("scoreDiv"),t=document.getElementById("score");e.style.display="block",t.textContent=this.module.score}else this.nextQuestion();else{this.clearObject();let t=document.getElementById("tipButtonDiv"),a=document.getElementById("tipDiv");t.style.display="none",a.style.display="none";let r=document.getElementById("startQuiz"),o=document.getElementById("QuizStartButton");document.getElementById("QuizStartContent").textContent="時間到",0==this.module.timer.counter&&(r.style.display="block");let n={question:e,get_score:0,answer_time:this.module.json.question_list[e].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};this.module.record[e]=n,this.record[e]=n,this.module.record_time+=this.module.json.question_list[e].time_limit,this.module.qClock=Date.now(),o.addEventListener("click",(()=>{r.style.display="none",this.saveQuizStatus()}))}}),1e3)}}),3e3)}else this.saveQuizStatus()}saveQuizStatus(){this.isPlayed=!0,window.clearInterval(this.module.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let e=document.getElementById("tipButtonDiv"),t=document.getElementById("tipDiv");e.style.display="none",t.style.display="none";let a=document.getElementById("quizEndDiv");a.style.display="block",a.addEventListener("click",(function(){a.style.display="none"})),console.log("Quiz.js: quiz end , this.module.record = ",this.module.record);let r="",o="";localStorage.getItem("MakarUserID")&&(r=localStorage.getItem("MakarUserID")),localStorage.getItem("device_id")&&(o=localStorage.getItem("device_id"));let n,i={user_id:this.currentProjData.user_id,playing_user:r,proj_id:this.currentProjData.proj_id,proj_type:"ar",device_id:o,module_id:"",brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0,module:[this.module.json],record_time:this.module.record_time,record_score:this.module.score,record:this.module.record};d.A.quizLog(i).then((e=>{console.log("_quizLog post to api: result=",e,"\n\n quizLogData=",i)})),d.A.getRecordModule(r,this.currentProjData.proj_id).then((e=>{e.data.record_module_list&&Array.isArray(e.data.record_module_list)&&e.data.record_module_list.length>0&&e.data.record_module_list[0].project_module&&(n=e.data.record_module_list[0].project_module);let t={head_pic:this.currentProjData.head_pic,loc:this.currentProjData.loc,module_type:this.currentProjData.module_type,name:this.currentProjData.name,playing_user_id:r,proj_cover_urls:this.currentProjData.proj_cover_urls,proj_id:this.currentProjData.proj_id,proj_name:this.currentProjData.proj_name,proj_type:"ar",snapshot_url:this.currentProjData.snapshot_url,user_id:this.currentProjData.user_id,project_module:n};n?n.playedQuizzes&&Array.isArray(n.playedQuizzes)?n.playedQuizzes.find((e=>e.obj_id==this.obj_id))||t.project_module.playedQuizzes.push({obj_id:this.obj_id,record:this.module.record}):t.project_module.playedQuizzes=[{obj_id:this.obj_id,record:this.module.record}]:(t.project_module={},t.project_module.playedQuizzes=[{obj_id:this.obj_id,record:this.module.record}]),d.A.updateRecordModule(t).then((e=>{console.log("_updateRecordModule post to api: result=",e,"\n\n quizRecord=",t)}))})),this.isPlaying=!1,console.log("Quiz.js: quiz end, quiz=",this)}}class G{quizData=[];loadedQuizzes=[];triggers=[];scene3DRoot;scene2DRoot;quizIdOpenDirectly=[];quizIdWithTriggers=[];currentlyTriggeredQuizId="";alreadyTriggeredQuizId="";constructor(){return G.exists?G.instance:(G.instance=this,G.exists=!0,this)}createQuiz(e){const t=e.generalAttr.obj_id;let a=this.getQuiz(t);if(a)return a;{const t=new U(e);return this.loadedQuizzes.push(t),t}}getQuiz(e){return this.loadedQuizzes.find((t=>t.obj_id===e))}getQuizProjectFromMDB=function(e){return parent.mdb.getQuizProject(e)};putQuizProjectToMDB=function(e){return parent.mdb.putQuizProject(e)};checkIs2DPictureShowing(){return this.loadedQuizzes.some((e=>e.isButtonPushed))}checkIsAnyQuizPlaying(){return this.loadedQuizzes.some((e=>1==e.isPlaying&&e.scene3DRoot==this.scene3DRoot))}clear(){this.triggers=[],this.currentlyTriggeredQuizId="",this.alreadyTriggeredQuizId="",document.getElementById("QuizStartButton").removeEventListener("click",this.startQuizFunc)}saveQuizDataToMDB(e,t,a,r){let o={user_id:t,proj_id:a,device_id:r,obj_id:e,is_played:!0,type:"quiz",login_id:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"not logged in",date_time:(new Date).toString()};this.getQuizProjectFromMDB(a).then((t=>{if(0==Object.keys(t).length){let t={proj_id:a,quizzes:{}};t.quizzes[e]=o,this.putQuizProjectToMDB(t)}else{let a=t;t.quizzes||(a.quizzes={}),a.quizzes[e]=o,this.putQuizProjectToMDB(a)}})).catch((e=>{console.warn("Quiz.js _saveQuizDataToMDB: saveQuizDataToMDB but error:",e)}))}loadQuiz(e,t,a,r,o,n,i,s,l){this.scene3DRoot=e,this.scene2DRoot=t;let c=[];this.quizData.find((e=>e.generalAttr.obj_id==a.generalAttr.obj_id))||this.quizData.push(a);let u=i.startQuiz;if(0!=a.typeAttr.module.trigger.length){const e=a.typeAttr.module.trigger;this.triggers.find((t=>t==e))||this.triggers.push(e),this.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id))||this.quizIdWithTriggers.push({obj_id:a.generalAttr.obj_id,trigger_id:e,force_login:a.typeAttr.module.force_login,allow_retry:a.typeAttr.module.allow_retry})}let m=i.QuizStartButton,p=i.QuizStartContent,h=()=>{if(e==aQuizAR.scene3DRoot)if(this.startQuizFunc=h,m.removeEventListener("click",h),0==a.typeAttr.module.trigger.length){let n=this.createQuiz(a);n.load(e,t,a,r),u.style.display="none";const i=makarUserData.oneProjData.user_id,s=o,l=localStorage.getItem("device_id");this.saveQuizDataToMDB(n.obj_id,i,s,l)}else if(this.currentlyTriggeredQuizId&&this.currentlyTriggeredQuizId==a.generalAttr.obj_id)if(this.alreadyTriggeredQuizId==this.currentlyTriggeredQuizId);else{this.alreadyTriggeredQuizId=this.currentlyTriggeredQuizId;let n=this.createQuiz(a);n.load(e,t,a,r),u.style.display="none";const i=makarUserData.oneProjData.user_id,s=o,l=localStorage.getItem("device_id");this.saveQuizDataToMDB(n.obj_id,i,s,l)}},g=()=>{if(u.style.display="none",0==a.typeAttr.module.trigger.length){const e=this.quizIdOpenDirectly.find((e=>e.obj_id==a.generalAttr.obj_id&&e.scene3DRoot==this.scene3DRoot));e&&(e.clicked=!0)}else{let e=this.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id&&e.scene3DRoot==this.scene3DRoot));e&&(e.clicked=!0)}};window.serverUrl;const _=a.typeAttr.module.force_login,b=a.typeAttr.module.allow_retry,f=0==a.typeAttr.module.trigger.length;if(_&&b&&f&&n)p.textContent=s.clickToPlay[l],m.addEventListener("click",h),this.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!1});else if(_&&b&&!f&&n){p.textContent=s.clickToPlay[l],m.addEventListener("click",h);let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!0)}else if(_&&!b&&f&&n){let e=w(n,o,f);c.push(e)}else if(_&&!b&&!f&&n){let e=w(n,o,f);c.push(e)}else if(_&&b&&f&&!n)y(f);else if(_&&b&&!f&&!n)y(f);else if(_&&!b&&f&&!n)y(f);else if(!_||b||f||n)if(!_&&b&&f)p.textContent=s.clickToPlay[l],m.addEventListener("click",h),this.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!0});else if(_||!b||f)if(_||b||!f){if(!_&&!b&&!f){let e=j(o,f);c.push(e.pQuizGetMdbRecord)}}else{let e=j(o,f);c.push(e)}else{p.textContent=s.clickToPlay[l],m.addEventListener("click",h);let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!0)}else y(f);function y(t){if(p.textContent=s.userNotLoginInfo[l],m.addEventListener("click",g),t)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!1});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!1)}}function w(t,r,o){return d.A.getRecordModule(t,r).then((n=>{console.log("arController.js: _getRecordModule: login_id=",t,"proj_id=",r,"\n  ret= ",n);let i=!1;if(0!=n.data.record_module_list.length){let e;n.data.record_module_list&&Array.isArray(n.data.record_module_list)&&n.data.record_module_list[0].project_module&&(e=n.data.record_module_list[0].project_module);let t=!1;e&&e.playedQuizzes&&Array.isArray(e.playedQuizzes)&&(t=e.playedQuizzes.find((e=>e.obj_id==a.generalAttr.obj_id))),t?(p.textContent=s.userAlreadyPlayed[l],m.addEventListener("click",g),i=!1):(p.textContent=s.clickToPlay[l],m.addEventListener("click",h),i=!0)}else p.textContent=s.clickToPlay[l],m.addEventListener("click",h),i=!0;if(o)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:i});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=i)}}))}function j(t,r){return parent.mdb.getProject(t,(t=>{if("done"==t.target.readyState&&t.target.result){if(t.target.result.quizzes){const o=a.generalAttr.obj_id;if(t.target.result.quizzes[o]){if(console.log("arController.js: indexedDB.js _getProject: already have the project with same proj_id and the quiz have been played.",t.target.result,t.target.result.getAwardIndex),p.textContent=s.userAlreadyPlayed[l],m.addEventListener("click",g),r)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!1});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!1)}return t}if(p.textContent=s.clickToPlay[l],m.addEventListener("click",h),r)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}if(p.textContent=s.clickToPlay[l],m.addEventListener("click",h),r)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}if(p.textContent=s.clickToPlay[l],m.addEventListener("click",h),r)window.aQuizAR.quizIdOpenDirectly.push({obj_id:a.generalAttr.obj_id,scene3DRoot:e,textContext:p.textContent,allowPlay:!0});else{let t=window.aQuizAR.quizIdWithTriggers.find((e=>e.obj_id==a.generalAttr.obj_id));t&&(t.textContext=p.textContent,t.scene3DRoot=e,t.allowPlay=!0)}return t}))}return c}checkIfQuizOpenDirectly(e){if(e||(e=document.getElementById("startQuiz")),!this.checkIsAnyQuizPlaying())if(this.quizIdOpenDirectly.length>=1){const t=this.quizIdOpenDirectly.find((e=>e.scene3DRoot==this.scene3DRoot));if(!t)return;QuizStartContent.textContent=t.textContext;const a=this.getQuiz(t.obj_id);if(a)a.isPlayed?e.style.display="none":e.style.display="block";else if("此登入用戶已經遊玩過"==t.textContext&&0==t.allowPlay){if(!t.clicked){e.style.display="block";let a=function(){e.style.display="none",t.clicked=!0};QuizStartButton.addEventListener("click",a)}}else e.style.display="block",QuizStartButton.addEventListener("click",this.startQuizFunc)}else e.style.display="none"}checkIfQuizOpenByTrigger(e,t){if(e||(e=document.getElementById("startQuiz")),!this.checkIsAnyQuizPlaying())if(this.quizIdWithTriggers.length>=1){const a=this.quizIdWithTriggers.find((e=>e.obj_id==t&&e.scene3DRoot==this.scene3DRoot));if(!a)return;QuizStartContent.textContent=a.textContext;const r=this.getQuiz(a.obj_id);if(r)r.isPlayed?e.style.display="none":e.style.display="block";else if("此登入用戶已經遊玩過"==a.textContext&&0==a.allowPlay){if(!a.clicked){e.style.display="block";let t=function(){e.style.display="none",a.clicked=!0};QuizStartButton.addEventListener("click",t)}}else e.style.display="block",QuizStartButton.addEventListener("click",this.startQuizFunc)}else e.style.display="none"}}window.aQuizAR=new G;class Q{currentScene2DRoot=null;canExchange=!1;obj_id="";proj_id=window.makarUserData.oneProjData.proj_id;exchanged=-1;pointCardState=0;pointCardObjs=[];pointCardInfo={};constructor(e,t,a){this.obj_id=t.generalAttr.obj_id,this.scene_obj=t,this.proj_id=a,this.module=t.typeAttr.module,this.currentScene2DRoot=e}init(e,t){this.pointCardObjs.push(t);let a=localStorage.getItem("device_id");a||(a=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",a)),this.pointCardInfo={user_id:window.makarUserData.oneProjData.user_id,proj_id:this.proj_id,device_id:a,module_id:this.scene_obj.typeAttr.module.moduleID,obj_id:this.obj_id,is_exchanged:!1,can_reward_point_count:this.scene_obj.typeAttr.module.canRewardPointCount,collected_points:[e],type:"point_card"},this.currentScene2DRoot.exchanged=-1,this.exchanged=-1}update(e,t=null){null!=t&&this.pointCardObjs.push(t),this.pointCardInfo=e,this.currentScene2DRoot.exchanged=e.is_exchanged?1:-1,this.exchanged=e.is_exchanged?1:-1,1==this.exchanged?this.pointCardState=2:e.collected_points.length>=e.can_reward_point_count&&(this.pointCardState=1)}}class N{mdb=null;loadedPointCards={};currentPointCardObjId="";constructor(){return parent.mdb?this.mdb=parent.mdb:console.warn("pointCard.js: parent.mdb does not exist, error"),N.exists?N.instance:(N.instance=this,N.exists=!0,this)}createPointCard(e,t,a=window.makarUserData.oneProjData.proj_id){this.currentPointCardObjId=t.generalAttr.obj_id;let r=this.getPointCard(this.currentPointCardObjId);return r||(r=new Q(e,t,a)),this.loadedPointCards[this.currentPointCardObjId]=r,this.setupExchangeButtonDiv(),this.setupPasswordDiv(),r}getPointCard(e){return this.loadedPointCards[e]}getPointCardProjectFromMDB=function(e){return console.log("pointCard.js: _getPointCardProject"),parent.mdb.getPointCardProject(e)};_setPointCardProjectToMDB=function(e){return console.log("pointCard.js: _setPointCardProject"),parent.mdb.setPointCardProject(e)};setPointCardtoMDB(e){return new Promise(((t,a)=>{this.getPointCardProjectFromMDB(e.proj_id).then((a=>{let r={};0==Object.keys(a).length?r={proj_id:e.proj_id,pointCards:{}}:(r=a,a.pointCards||(r.pointCards={})),r.pointCards[e.obj_id]=e,t(parent.mdb.setPointCardProject(r))}))}))}getHtmlElement(e="tempElement",t="div"){let a=document.getElementById(e);return a||(a=document.createElement(t),a.setAttribute("id",e)),a}setupExchangeButtonDiv(){this.pointCardExchangeDiv=this.getHtmlElement("pointCardExchangeDiv"),this.pointCardExchangeDiv.setAttribute("class","moduleExchangeDiv"),this.pointCardExchangeDiv.style.display="inline",this.pointCardExchangeDiv.style.width="100%",this.pointCardExchangeDiv.style.left="0%",this.pointCardExchangeDiv.style.bottom="60px",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.pointCardExchangeDiv.innerText="loading",this.pointCardExchangeDiv.onclick=e=>{this.getPointCard(this.currentPointCardObjId).canExchange&&(this.pointCardPWDBG.style.display="inline")},document.body.appendChild(this.pointCardExchangeDiv)}setupPasswordDiv(){this.pointCardPWDBG=this.getHtmlElement("pointCardPWDBG"),this.pointCardPWDBG.setAttribute("class","backgroundModal"),document.body.appendChild(this.pointCardPWDBG),this.pointCardPWDiv=this.getHtmlElement("pointCardPWDiv"),this.pointCardPWDiv.setAttribute("class","modulePWDDiv"),this.pointCardPWDiv.style.display="block",this.pointCardPWDBG.appendChild(this.pointCardPWDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.pointCardPWDiv.style.left=(innerWidth-e)/2+"px",this.pointCardPWDiv.style.top=(innerHeight-t)/2+"px",this.pointCardPWDiv.style.width=e+"px",this.pointCardPWDiv.style.height=t+"px",this.pointCardPWDiv.innerHTML="<br> 輸入密碼 <br>";let a=this.getHtmlElement("pointCardPWDInputText","input");a.setAttribute("class","modulePWDInputText"),a.setAttribute("type","text"),a.setAttribute("placeholder","pwd"),this.pointCardPWDiv.appendChild(a);let r=this.getHtmlElement("pointCardPWDRetText");r.setAttribute("class","modulePWDRetText"),this.pointCardPWDiv.appendChild(r),r.innerText="";let o=this.getHtmlElement("pointCardPWDCancel");o.setAttribute("class","bottomLeftCell"),o.innerText="取消",this.pointCardPWDiv.appendChild(o),o.onclick=function(){console.log("pointCard.js: cancel button click "),pointCardPWDBG.style.display="none",a.value="",r.innerText=""};let n=this.getHtmlElement("pointCardPWDConfirm");n.setAttribute("class","bottomRightCell"),n.innerText="確認",this.pointCardPWDiv.appendChild(n),n.onclick=e=>{let t=this.getPointCard(this.currentPointCardObjId);console.log("pointCard.js: _passwordConfirm pointCard = ",t);let o=t.module.rewardPassword;a.value==o?(console.log("pointCard.js: confirm button click password correct ",a.value,t.module.rewardPassword),r.innerText="密碼正確",this.pointCardExchangeDiv.innerText="已兌換",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",t.currentScene2DRoot.exchanged=1,t.exchanged=1,t.canExchange=!1,t.pointCardState=2,parent.mdb.getPointCardProject(t.proj_id).then((e=>{let a=e.pointCards[t.obj_id];a.is_exchanged=!0,parent.mdb.setPointCardProject(e).then((e=>{let t=a.collected_points[a.collected_points.length-1],r={user_id:a.user_id,playing_user:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"",proj_id:a.proj_id,proj_type:"ar",module_id:a.module_id,device_id:a.device_id,can_reward_point_count:a.can_reward_point_count,target_id:t,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==t)).image_url,brand:window.Browser.name+window.Browser.version,os:window.Browser.platform,location_long:0,location_lan:0};d.A.pointCardLog(r).then((e=>{console.log("_pointCardLog post to api: result=",e,"\n\n pointCardLogData=",r)}))}))})),setTimeout((()=>{window.aPointCard.pointCardPWDBG.style.display="none"}),2e3)):(console.log("pointCard.js: confirm button click password wrong ",a.value),r.innerText="密碼錯誤")}}showPointCardCanvas(e,t,a,r){this.currentPointCardObjId=r;let o=this.getPointCard(this.currentPointCardObjId);o.currentScene2DRoot=e,this.pointCardExchangeDiv.style.display="inline",a?(this.pointCardExchangeDiv.innerText="已兌換",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",o.canExchange=!1):t>=0?(o.canExchange=!0,o.pointCardState=1,this.pointCardExchangeDiv.innerText="按此兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)"):(o.canExchange=!1,this.pointCardExchangeDiv.innerText="還差 "+-t+" 點就可兌換獎項",this.pointCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )")}hidePointCardCanvas(e){console.log("PointCard.js: aPointCard.hidePointCardCanvas: obj_2D = ",e),(e.loadModule="pointCard")&&(this.pointCardExchangeDiv.style.display="none",this.pointCardPWDBG.style.display="none",pointCardPWDInputText.value="",pointCardPWDRetText.innerText="")}loadNewCard(e,t,a,r,n,i){let l=localStorage.getItem("device_id");l||(l=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",l)),window.aPointCard.setPointCardtoMDB(a.pointCardInfo).then((o=>{for(let o=0;o<t.typeAttr.module.points.length;o++){let c=t.typeAttr.module.points[o];console.log("%c pointObj.transformAttr.rectTransform[0]",`color: rgb(${100*o}, ${80*o}, ${110*o}); font-size:18px`,o,c);let u=window.arController.selectedResolutionIndex;u||(u=0);let m,p=(new THREE.Vector3).fromArray(c.rectTransform[u].position.split(",").map((e=>Number(e)))),h=(new THREE.Vector4).fromArray(c.rectTransform[u].rotation.split(",").map((e=>Number(e)))),g=(new THREE.Vector3).fromArray(c.rectTransform[u].scale.split(",").map((e=>Number(e))));c.res_id=c.collectedPointID,c.transformAttr={rect_transform:c.rectTransform},c.generalAttr={obj_id:"tempJson_pointObj_no"+o,obj_type:"2d",obj_parent_id:t.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},c.typeAttr={placeholder:"placeholder"},c.sub_type="jpg",window.makarUserData.userProjResDict[c.collectedPointID]?m=window.makarUserData.userProjResDict[c.collectedPointID].res_url:"PointCard_Point_After"==c.collectedPointID&&(m="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png"),c.res_url=m,c.res_url||(console.log("pointObj 沒有pointObj.res_url",c),s(c));const _=(o+1)/(t.typeAttr.module.points.length+1);if(r.targetID==c.targetID){window.arController.loadTexture2D(e,c,n+_,i,p,h,g).then((e=>{a.pointCardObjs.push(e);let t={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,t)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),t.typeAttr.module.points[o].collected=!0;let s={user_id:window.makarUserData.oneProjData.user_id,playing_user:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"",proj_id:window.makarUserData.oneProjData.proj_id,proj_type:"ar",module_id:t.typeAttr.module.moduleID,device_id:l,can_reward_point_count:t.typeAttr.module.canRewardPointCount,target_id:r.targetID,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==r.targetID)).image_url,brand:window.Browser.name+window.Browser.version,os:window.Browser.platform,location_long:0,location_lan:0};d.A.pointCardLog(s).then((e=>{console.log("_pointCardLog post to api: result=",e,"\n\n pointCardLogData=",s)}))}else{let t;c.res_id=c.uncollectedPointID,window.makarUserData.userProjResDict[c.uncollectedPointID]?t=window.makarUserData.userProjResDict[c.uncollectedPointID].res_url:"PointCard_Point_Before"==c.collectedPointID&&(t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png"),c.res_url=t,c.res_url||s(c),window.arController.loadTexture2D(e,c,n+_,i,p,h,g).then((e=>{a.pointCardObjs.push(e)})),c.collected=!1}}const c=a.pointCardInfo.collected_points.length-t.typeAttr.module.canRewardPointCount;this.showPointCardCanvas(e,c,a.pointCardInfo.is_exchanged,a.pointCardInfo.obj_id)}))}addPoint(e,t,a){return new Promise(((r,o)=>{let n=e.pointCards[t];console.log("pointCard.js: _addPoint:  getProjRet: ",n,a);let i=n.collected_points.find((e=>e==a));i?(console.log("pointCard.js _addPoint: point exists, do nothing. \n",i,e),r(e)):(console.log("pointCard.js: _addPoint: the pointCard is already there, but the target is not: ",i,e),n.collected_points.push(a),this._setPointCardProjectToMDB(e).then((t=>{this.getPointCardProjectFromMDB(e.proj_id).then((e=>{r(e)}))})))}))}loadCardWithAddedPoint(e,t,a,r,n,i,l,c){const u=a.generalAttr.obj_id;this.currentPointCardObjId=u;let m=l.pointCards[u],p=localStorage.getItem("device_id");p||(p=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",p));for(let o=0;o<a.typeAttr.module.points.length;o++){let l=a.typeAttr.module.points[o],u=window.arController.selectedResolutionIndex;u||(u=0);let h,g=(new THREE.Vector3).fromArray(l.rectTransform[u].position.split(",").map((e=>Number(e)))),_=(new THREE.Vector4).fromArray(l.rectTransform[u].rotation.split(",").map((e=>Number(e)))),b=(new THREE.Vector3).fromArray(l.rectTransform[u].scale.split(",").map((e=>Number(e))));l.res_id=l.collectedPointID,l.transformAttr={rect_transform:l.rectTransform},l.generalAttr={obj_id:"tempJson_pointObj_no"+o,obj_type:"2d",obj_parent_id:a.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},l.typeAttr={placeholder_pointObj:"placeholder_pointObj"},l.sub_type="jpg",window.makarUserData.userProjResDict[l.collectedPointID]?h=window.makarUserData.userProjResDict[l.collectedPointID].res_url:"PointCard_Point_After"==l.collectedPointID&&(h="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png"),l.res_url=h,l.res_url||(console.log("pointObj 沒有pointObj.res_url",l),s(l));const f=(o+1)/(a.typeAttr.module.points.length+1);if(m.collected_points.find((e=>e==l.targetID))){if(window.arController.loadTexture2D(e,l,n+f,i,g,_,b).then((e=>{t.pointCardObjs.push(e);let a={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,a)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),c&&r.targetID==l.targetID){let e={user_id:window.makarUserData.oneProjData.user_id,playing_user:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"",proj_id:window.makarUserData.oneProjData.proj_id,proj_type:"ar",module_id:a.typeAttr.module.moduleID,device_id:p,can_reward_point_count:a.typeAttr.module.canRewardPointCount,target_id:r.targetID,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==r.targetID)).image_url,brand:window.Browser.name+window.Browser.version,os:window.Browser.platform,location_long:0,location_lan:0};d.A.pointCardLog(e).then((t=>{console.log("_pointCardLog post to api: result=",t,"\n\n pointCardLogData=",e)}))}}else{let a;l.res_id=l.uncollectedPointID,window.makarUserData.userProjResDict[l.uncollectedPointID]?a=window.makarUserData.userProjResDict[l.uncollectedPointID].res_url:"PointCard_Point_Before"==l.collectedPointID&&(a="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png"),l.res_url=a,l.res_url||s(l),window.arController.loadTexture2D(e,l,n+f,i,g,_,b).then((e=>{t.pointCardObjs.push(e)})),l.collected=!1}}const h=m.collected_points.length-a.typeAttr.module.canRewardPointCount;this.showPointCardCanvas(e,h,m.is_exchanged,u)}checkPointThenAdd(e,t,a,r,n){let i=localStorage.getItem("device_id");i||(i=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",i));const l=window.makarUserData.oneProjData.proj_id;this.getPointCardProjectFromMDB(l).then((o=>{if(console.log("PointCard.js: _checkPointThenAdd: getProjRet=",o),0==Object.keys(o).length)return;const n=e.project_module.obj_id;let c=o.pointCards[n];const u=this.getPointCard(n);if(!u)return;let m;if(this.currentPointCardObjId=n,c.collected_points)if(m=c.collected_points.find((e=>e==t)),m){console.log("PointCard.js: _checkPointThenAdd: already collected.");let t=c.collected_points.length-u.module.canRewardPointCount;this.showPointCardCanvas(e,t,c.is_exchanged,n)}else console.log("PointCard.js: _checkPointThenAdd: not collected "),this.addPoint(o,n,t).then((o=>{console.log("PointCard.js: _checkPointThenAdd: setProjRet",o);let c=o.pointCards[n];if(u.update(c),console.log("pointCard updated",u),c.collected_points){for(let o=0;o<u.module.points.length;o++){let c=u.module.points[o];if(c.targetID==t){let m=window.arController.selectedResolutionIndex;m||(m=0);let p,h=(new THREE.Vector3).fromArray(c.rectTransform[m].position.split(",").map((e=>Number(e)))),g=(new THREE.Vector4).fromArray(c.rectTransform[m].rotation.split(",").map((e=>Number(e)))),_=(new THREE.Vector3).fromArray(c.rectTransform[m].scale.split(",").map((e=>Number(e))));c.res_id=c.collectedPointID,c.transformAttr={rect_transform:c.rectTransform},c.generalAttr={obj_id:"tempJson_pointObj_no"+o,obj_type:"2d",obj_parent_id:n,active:!0,interactable:!0,logic:!1},c.typeAttr={placeholder:"placeholder"},c.sub_type="jpg",window.makarUserData.userProjResDict[c.collectedPointID]?p=window.makarUserData.userProjResDict[c.collectedPointID].res_url:"PointCard_Point_After"==c.collectedPointID&&(p="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png"),c.res_url=p,c.res_url||(console.log("pointObj 沒有pointObj.res_url",c),s(c));const b=(o+1)/(u.module.points.length+1);window.arController.loadTexture2D(e,c,a+b,r,h,g,_).then((e=>{u.pointCardObjs.push(e),this.loadedPointCards[this.currentPointCardObjId].pointCardObjs.find((e=>e.obj_id==c.generalAttr.obj_id)).visible=!1;let t={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};window.arController.runAnimation2D(e,t)})).catch((e=>console.warn("ARController _loadMakarARScene: pointCard, user got a new point, error=",e))),c.collected=!0;let f={user_id:window.makarUserData.oneProjData.user_id,playing_user:localStorage.getItem("MakarUserID")?localStorage.getItem("MakarUserID"):"",proj_id:l,proj_type:"ar",module_id:u.module.moduleID,device_id:i,can_reward_point_count:u.module.canRewardPointCount,target_id:t,target_img_url:window.makarUserData.targetList.find((e=>e.target_id==t)).image_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};d.A.pointCardLog(f).then((e=>{console.log("_pointCardLog post to api: result=",e,"\n\n pointCardLogData=",f)}))}}let o=c.collected_points.length-u.module.canRewardPointCount;this.showPointCardCanvas(e,o,c.is_exchanged,n)}else console.error("PointCard.js: _checkPointThenAdd: collected_points not exist, shouldnt happen ",u.module.points)}))}))}}window.aPointCard=new N;class q{currentScene2DRoot=null;canExchange=!1;obj_id="";proj_id=window.makarUserData.oneProjData.proj_id;exchanged=-1;scratchCardState=0;scratchCardObjs=[];scratchCardInfo={};constructor(e,t,a){this.obj_id=t.generalAttr.obj_id,this.scene_obj=t,this.proj_id=a,this.module=t.typeAttr.module,this.currentScene2DRoot=e}init(e){this.scratchCardObjs.push(e);let t=localStorage.getItem("device_id");t||(t=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",t)),this.scratchCardInfo={user_id:window.makarUserData.oneProjData.user_id,proj_id:this.proj_id,device_id:t,card_id:this.scene_obj.typeAttr.module.moduleID,obj_id:this.obj_id,is_exchanged:!1,scratchCardState:this.scratchCardState,type:"scratch_card"},this.currentScene2DRoot.exchanged=-1,this.exchanged=-1}update(e,t=null){null!=t&&this.scratchCardObjs.push(t),this.scratchCardInfo=e,this.currentScene2DRoot.exchanged=e.is_exchanged?1:-1,this.exchanged=e.is_exchanged?1:-1}}class X{mdb=null;loadedScratchCards={};currentScratchCardObjId="";constructor(){return parent.mdb?this.mdb=parent.mdb:console.warn("scratchCard.js: parent.mdb does not exist, error"),X.exists?X.instance:(X.instance=this,X.exists=!0,this)}makeTempObjJson(e,t,a=0){let r={};if("Background"==t)if(e.typeAttr.module.backgroundID){if(r.res_id=e.typeAttr.module.backgroundID,s(r),!r.res_url){r.res_url=makarUserData.userProjResDict[e.typeAttr.module.backgroundID].res_url;let t=r.res_url.split(".");r.sub_type=t[t.length-1]}}else r.res_url="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png",r.sub_type="png";else if("Award"==t)if(e.typeAttr.module.cards[0].awards[a].awardID){if(r.res_id=e.typeAttr.module.cards[0].awards[a].awardID,s(r),!r.res_url){r.res_url=makarUserData.userProjResDict[e.typeAttr.module.cards[0].awards[a].awardID].res_url;let t=r.res_url.split(".");r.sub_type=t[t.length-1]}}else r.res_url="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/AcratchCard_Default.png",r.sub_type="png";else if("Scratch"==t)if(e.typeAttr.module.cards[0].scratchID){if(r.res_id=e.typeAttr.module.cards[0].scratchID,s(r),!r.res_url){r.res_url=makarUserData.userProjResDict[e.typeAttr.module.cards[0].scratchID].res_url;let t=r.res_url.split(".");r.sub_type=t[t.length-1]}}else r.res_url="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png",r.sub_type="png";return r.transformAttr="Background"==t?{rect_transform:e.typeAttr.module.bRectTransform}:{rect_transform:e.typeAttr.module.cards[0].sRectTransform},r.generalAttr={obj_id:r.res_id+"_"+e.generalAttr.obj_id,obj_type:"2d",obj_parent_id:e.generalAttr.obj_id,active:!0,interactable:!0,logic:!1},"Award"==t&&(r.generalAttr.active=!1),r.typeAttr={},r}createScratchCard(e,t,a=window.makarUserData.oneProjData.proj_id){this.currentScratchCardObjId=t.generalAttr.obj_id;let r=this.getScratchCard(this.currentScratchCardObjId);return r||(r=new q(e,t,a)),this.loadedScratchCards[this.currentScratchCardObjId]=r,this.setupExchangeButtonDiv(),this.setupPasswordDiv(),r}getScratchCard(e){return this.loadedScratchCards[e]}getScratchCardProjectFromMDB=function(e){return console.log("scratchCard.js: _getScratchCardProject"),parent.mdb.getScratchProject(e)};_setScratchCardProjectToMDB=function(e){return console.log("scratchCard.js: _setScratchCardProject"),parent.mdb.setScratchProject(e)};setScratchCardtoMDB(e){return new Promise(((t,a)=>{this.getScratchCardProjectFromMDB(e.proj_id).then((a=>{if(0==Object.keys(a).length){let a={proj_id:e.proj_id,scratchCards:{}};a.scratchCards[e.obj_id]=e,t(parent.mdb.setScratchProject(a))}else{let r=a;r.scratchCards[e.obj_id]=e,t(parent.mdb.setScratchProject(r))}}))}))}restProjInfoMDB(e){let t={proj_id:e,scratchCards:{}};return new Promise(((e,a)=>{e(parent.mdb.setScratchProject(t))}))}getScratchRandomAwardandUpdate(e){let t=null;if(Array.isArray(e.module.cards)&&1==e.module.cards.length&&(t=e.module.cards[0].awards),!t)return-1;let a=0,r=[];for(let e in t)a+=t[e].probability,r.push(a);let o=Math.floor(Math.random()*a)+1,n=0;console.log("scratchCard.js: _chooseAward: awardArray=",r,", getNum=",o);for(let e=0;e<r.length;e++)if(o<=r[e]){n=e;break}return e.scratchCardInfo.getAwardIndex=n,e.scratchCardInfo.scratchCardState=1,console.log("20240227",e.scratchCardInfo),this.setScratchCardtoMDB(e.scratchCardInfo),n}getHtmlElement(e="tempElement",t="div"){let a=document.getElementById(e);return a||(a=document.createElement(t),a.setAttribute("id",e)),a}setupExchangeButtonDiv(){this.scratchCardExchangeDiv=this.getHtmlElement("scratchCardExchangeDiv"),this.scratchCardExchangeDiv.setAttribute("class","moduleExchangeDiv"),this.scratchCardExchangeDiv.style.display="inline",this.scratchCardExchangeDiv.style.width="100%",this.scratchCardExchangeDiv.style.left="0%",this.scratchCardExchangeDiv.style.bottom="0px",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.scratchCardExchangeDiv.innerText="loading",this.scratchCardExchangeDiv.onclick=e=>{let t=this.getScratchCard(this.currentScratchCardObjId);console.log("%c ScratchCard _setupExchangeButtonDiv exChangeClick=","color:salmon; font-size:20px",t,this.currentScratchCardObjId),t.canExchange&&(this.scratchCardPWDBG.style.display="inline")},document.body.appendChild(this.scratchCardExchangeDiv)}loadScratchImage(e,t,a,r){let o=this;return new Promise((function(e){let n=(new THREE.Vector3).setFromMatrixPosition(a),i=(new THREE.Euler).setFromRotationMatrix(a),s=Math.round(i.z/Math.PI*180),l=(new THREE.Vector3).setFromMatrixScale(a);console.log(t);let c,d,u=t.transformAttr.rect_transform[0].size_delta.split(",").map((function(e){return Number(e)}));console.log(n,s,l,u),c=u[0]*l.x*r,d=u[1]*l.y*r;let m=o.getHtmlElement("scratchImageDiv");m.setAttribute("class","scratchCanvasContainer"),m.style.width=c+"px",m.style.height=d+"px",m.style.left=window.innerWidth/2-c/2+n.x+"px",m.style.top=window.innerHeight/2-d/2+n.y+"px",m.style.transform="rotateZ("+s+"deg)";let p=o.getHtmlElement("scratchCanvas","canvas"),h=p.getContext("2d");p.setAttribute("class","scratchCanvas"),p.setAttribute("width",c),p.setAttribute("height",d);let g=new Image;g.onload=function(){h.drawImage(g,0,0,g.width,g.height,0,0,p.width,p.height),e(p)};let _=new XMLHttpRequest;_.open("GET",t.res_url),_.responseType="blob",_.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);g.src=t},_.send(),m.appendChild(p),document.body.appendChild(m)}))}clearScratchImage(e){if(e){let t=e.parentNode;t&&(t.removeChild(e),t.parentNode.removeChild(t))}}loadBrushSetting(e,t){let a=this;if(!e)return;let r=e.width,o=e.height,n=e.getContext("2d");var i,s;let l=new Image;l.onload=function(){};let c=new XMLHttpRequest;function d(e,a){let r,o,n=(new THREE.Euler).setFromRotationMatrix(t);if(e.touches){let t=e.touches[0].clientX-e.target.offsetParent.offsetLeft,a=e.touches[0].clientY-e.target.offsetParent.offsetTop;t-=e.target.offsetParent.offsetWidth/2,a-=e.target.offsetParent.offsetHeight/2,r=Math.cos(-n.z)*t-Math.sin(-n.z)*a,o=Math.sin(-n.z)*t+Math.cos(-n.z)*a,r+=e.target.offsetParent.offsetWidth/2,o+=e.target.offsetParent.offsetHeight/2}else r=e.offsetX,o=e.offsetY;return{x:r,y:o}}function u(e){i=!0,s=d(e)}function m(t){if(i){t.preventDefault();for(var c,u,m,p,h=d(t),g=(m=s,p=h,Math.sqrt(Math.pow(p.x-m.x,2)+Math.pow(p.y-m.y,2))),_=function(e,t){return Math.atan2(t.x-e.x,t.y-e.y)}(s,h),b=0;b<g;b++)c=s.x+Math.sin(_)*b-15,u=s.y+Math.cos(_)*b-15,n.globalCompositeOperation="destination-out",n.drawImage(l,c,u,80,40);s=h,function(t){let r=window.aScratchCard.scratchCardExchangeDiv;if(t>70){a.clearScratchImage(e);let t=window.aScratchCard.getScratchCard(window.aScratchCard.currentScratchCardObjId);t.scratchCardInfo.scratchCardState=2,window.aScratchCard.setScratchCardtoMDB(t.scratchCardInfo),t.canExchange=!0,r.style.backgroundColor="rgba(0, 201, 157, 1.0)",r.innerText="按此兌換獎項"}else r.innerText="尚未完成刮刮卡"}(function(e){(!e||e<1)&&(e=1);for(var t=n.getImageData(0,0,r,o).data,a=t.length,i=a/e,s=0,l=s=0;l<a;l+=e)t[l+0]+t[l+1]+t[l+2]===0&&s++;return Math.round(s/i*100)}(32))}}function p(e){i=!1}c.open("GET","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/brush.png"),c.responseType="blob",c.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);l.src=t},c.send(),e.addEventListener("mousedown",u,!1),e.addEventListener("touchstart",u,!1),e.addEventListener("mousemove",m,!1),e.addEventListener("touchmove",m,!1),e.addEventListener("mouseup",p,!1),e.addEventListener("touchend",p,!1),e.addEventListener("mouseleave",(function(e){i=!1}),!1)}setupPasswordDiv(){this.scratchCardPWDBG=this.getHtmlElement("scratchCardPWDBG"),this.scratchCardPWDBG.setAttribute("class","backgroundModal"),document.body.appendChild(this.scratchCardPWDBG),this.scratchCardPWDiv=this.getHtmlElement("scratchCardPWDiv"),this.scratchCardPWDiv.setAttribute("class","modulePWDDiv"),this.scratchCardPWDiv.style.display="block",this.scratchCardPWDBG.appendChild(this.scratchCardPWDiv);let e=innerWidth>600?300:.5*innerWidth,t=innerHeight>900?270:.3*innerHeight;this.scratchCardPWDiv.style.left=(innerWidth-e)/2+"px",this.scratchCardPWDiv.style.top=(innerHeight-t)/2+"px",this.scratchCardPWDiv.style.width=e+"px",this.scratchCardPWDiv.style.height=t+"px",this.scratchCardPWDiv.innerHTML="<br> 輸入密碼 <br>";let a=this.getHtmlElement("scratchCardPWDInputText","input");a.setAttribute("class","modulePWDInputText"),a.setAttribute("type","text"),a.setAttribute("placeholder","pwd"),this.scratchCardPWDiv.appendChild(a);let r=this.getHtmlElement("scratchCardPWDRetText");r.setAttribute("class","modulePWDRetText"),this.scratchCardPWDiv.appendChild(r),r.innerText="";let o=this.getHtmlElement("scratchCardPWDCancel");o.setAttribute("class","bottomLeftCell"),o.innerText="取消",this.scratchCardPWDiv.appendChild(o),o.onclick=function(){console.log("scratchCard.js: cancel button click "),scratchCardPWDBG.style.display="none",a.value="",r.innerText=""};let n=this.getHtmlElement("scratchCardPWDConfirm");n.setAttribute("class","bottomRightCell"),n.innerText="確認",this.scratchCardPWDiv.appendChild(n),n.onclick=e=>{let t=this.getScratchCard(this.currentScratchCardObjId);console.log("scratchCard.js: _passwordConfirm scratchCard = ",t);let o=t.module.rewardPassword;a.value==o?(console.log("scratchCard.js: confirm button click password correct ",a.value,t.module.rewardPassword),r.innerText="密碼正確",this.scratchCardExchangeDiv.innerText="已兌換",this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",t.currentScene2DRoot.exchanged=1,t.exchanged=1,t.canExchange=!1,t.scratchCardState=3,t.scratchCardInfo.scratchCardState=3,t.scratchCardInfo.is_exchanged=!0,this.setScratchCardtoMDB(t.scratchCardInfo),setTimeout((()=>{window.aScratchCard.scratchCardPWDBG.style.display="none"}),2e3)):(console.log("scratchCard.js: confirm button click password wrong ",a.value),r.innerText="密碼錯誤")}}showScratchCardCanvas(e,t){this.currentScratchCardObjId=t.generalAttr.obj_id;let a,r,o=this.getScratchCard(this.currentScratchCardObjId);o.currentScene2DRoot=e,console.log(o);let n=o.scratchCardInfo.getAwardIndex;for(let e=0;e<arController.makarObjects2D.length;e++)arController.makarObjects2D[e].obj_id==t.typeAttr.module.cards[0].awards[n].awardID+"_"+t.generalAttr.obj_id&&(r=arController.makarObjects2D[e]);if(!r)return;this.scratchCardExchangeDiv.style.display="inline";let i=window.aScratchCard.makeTempObjJson(t,"Scratch");switch(o.scratchCardInfo.scratchCardState){case 1:r.updateMatrixWorld(),a=this.loadScratchImage(t.generalAttr.obj_id,i,r.matrixWorld.clone(),arController.scaleRatioXY),a.then((e=>{r.visible=!0,this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.scratchCardExchangeDiv.innerText="尚未完成刮刮卡",this.loadBrushSetting(e,r.matrixWorld.clone())}));break;case 2:r.visible=!0,o.canExchange=!0,this.scratchCardExchangeDiv.style.backgroundColor="rgba(0, 201, 157, 1.0)",this.scratchCardExchangeDiv.innerText="按此兌換獎項";break;case 3:r.visible=!0,this.scratchCardExchangeDiv.style.backgroundColor="rgba( 49, 51, 63, 0.9 )",this.scratchCardExchangeDiv.innerText="已兌換"}}hideScratchCardCanvas(e){console.log("ScratchCard.js: aScratchCard.hideScratchCardCanvas: obj_2D = ",e),(e.loadModule="scratchCard")&&(this.clearScratchImage(document.getElementById("scratchCanvas")),this.scratchCardExchangeDiv.style.display="none",this.scratchCardPWDBG.style.display="none",scratchCardPWDInputText.value="",scratchCardPWDRetText.innerText="")}loadNewCard(e,t,a,r,n){let i=localStorage.getItem("device_id");i||(i=(new Date).getTime()+"_"+o(10),localStorage.setItem("device_id",i)),window.aScratchCard.setScratchCardtoMDB(a.scratchCardInfo).then((e=>{}))}}window.aScratchCard=new X;const Y=class{currentController;eventDispatchTarget;constructor(e,t){this.currentController=e,this.eventDispatchTarget=t}dispatchEvent(e,t=this.eventDispatchTarget){let a=this.genenrateCustomEvent(e);t.dispatchEvent(a)}genenrateCustomEvent(e){let t=new CustomEvent("MakarEvent",{detail:{behavType:e.behav_type,sourceID:e.trigger_obj_id,delay:e.delay,triggerType:e.trigger_type,typeAttr:{},_originalData:e}});const a={URL:{url:e.url,background:e.background},Dialing:{phone:e.phone},Email:{body:e.body,mailTo:e.mail_to,subject:e.subject},Animation:{uid:e.uid,loop:e.loop,reset:e.reset,towardID:e.obj_id},TTS:{pitch:e.pitch,speed:e.speed,language:e.language,towardID:e.obj_id},Scenes:{sceneID:e.scene_id,previousID:e.previousID},Skybox:{skyboxID:e.skybox_id,previousID:e.previousID},Display:{group:e.group,towardID:e.obj_id,switchType:e.switch_type,reset:e.reset},Facing:{isFront:e.is_front,towarID:e.toward_id}};return t.detail.typeAttr=a[e.behav_type],t}},Z=class{constructor(e){this.type="ARWrapper",e.oneProjData&&(this.currentProjData=e.oneProjData),e.scenesData&&(this.scenesData=e.scenesData),e.targetList&&(this.targetList=e.targetList),e.userOnlineResDict&&(this.userOnlineResDict=e.userOnlineResDict),e.userProjResDict&&(this.userProjResDict=e.userProjResDict),e.userMaterialDict&&(this.userMaterialDict=e.userMaterialDict);let t=this;window.ARController&&window.THREE&&(ARController.getUserMediaThreeScene=function(e){let t={};for(let a in e)t[a]=e[a];let a=e.onSuccess;return t.onSuccess=function(e,t){let r=e.createThreeScene();a(r,e,t)},this.getUserMediaARController(t)},ARController.prototype.createThreeScene=function(e){e=e||this.image,this.setupThree();var t=new THREE.VideoTexture(e);t.minFilter=THREE.LinearFilter,t.flipY=!1,this.cameraTexture=t.clone(),this.cameraTexture.flipY=!0;var a=new THREE.Mesh(new THREE.PlaneGeometry(t.image.videoWidth,t.image.videoHeight),new THREE.MeshBasicMaterial({map:t,side:THREE.BackSide}));a.material.depthTest=!1,a.material.depthWrite=!1,a.position.set(0,0,-1);var r=new THREE.OrthographicCamera(-t.image.videoWidth/2,t.image.videoWidth/2,-t.image.videoHeight/2,t.image.videoHeight/2,-100,2e4);let o,n,i=document.getElementById("arfScene"),s=t.image.videoWidth,l=t.image.videoHeight;window.innerWidth/window.innerHeight>s/l?(o=window.innerWidth,n=window.innerWidth/s*l):(o=window.innerHeight/l*s,n=window.innerHeight);var c=new THREE.OrthographicCamera(-o/2,o/2,-n/2,n/2,-100,2e4),d=new THREE.Scene;d.name="videoScene",d.add(a),d.add(r);var u=new THREE.Scene;u.name="scene2D";var m=new THREE.Scene,p=new THREE.PerspectiveCamera(45,1.33333,1,2e4);if(p.projectionMatrix.fromArray(this.getCameraMatrix()),p.rotation.set(0,180*Math.PI/180,180*Math.PI/180),p.projectionMatrix.elements[5]=-p.projectionMatrix.elements[5],p.projectionMatrix.elements[8]=-p.projectionMatrix.elements[8],p.projectionMatrix.elements[9]=-p.projectionMatrix.elements[9],p.projectionMatrix.elements[10]=-p.projectionMatrix.elements[10],p.projectionMatrix.elements[11]=-p.projectionMatrix.elements[11],p.projectionMatrixInverse.getInverse)p.projectionMatrixInverse.getInverse(p.projectionMatrix);else{let e=p.projectionMatrix.clone();p.projectionMatrixInverse.copy(e.invert())}let h=p.clone(),g=document.getElementById("oCamera"),_=new THREE.PerspectiveCamera(60,o/n,.3,1e4),b=g.getObject3D("camera").position.clone();_.position.copy(b);let f={aspect:o/n,near:.3,far:1e4,fov:60};g.setObject3D("camera",_),g.setAttribute("camera",f),g.components.camera.camera=_,g.components["orbit-controls"].controls.object=_;var y=new THREE.PerspectiveCamera(45,1.33333,1,2e4);y.projectionMatrix.fromArray(this.getCameraMatrix()),this.orientation,this.camera=p,this.aCamera=p,this.oCamera=g,this.oCamera3D=_,this.bkCamera=h,this.CSScamera=y,this.videoCamera=r,this.videoScene=d,this.scene2D=u,this.camera2D=c,this.videoStreamPlane=a,this.enableTracking=!1,this.enableARRendering=!1,this.needsCullFaceBack=!1;var w=new THREE.Clock;this.clock=w,this.cssScene=m;var j=this;return{videoScene:d,scene2D:u,cssScene:m,camera:p,CSScamera:y,videoCamera:r,camera2D:c,arController:this,video:e,clock:w,process:function(){for(var t in j.aframeNFTMarkers)j.aframeNFTMarkers[t].object3D.visible=!1;j.process(e)},renderOn:function(e){t.needsUpdate=!0,e.autoClear=!1,j.arScene.video.paused||e.render(this.videoScene,this.videoCamera),e.clearDepth(),e.render(i.object3D,arController.camera),e.render(this.scene2D,this.camera2D)}}},ARController.prototype.createAframeNFTMarker=function(e){this.setupThree();let t=document.createElement("a-entity"),a=this;if(console.log(" _createAframeNFTMarker_: ",e),a.sceneTargetList&&a.sceneTargetList[e]){let r=a.sceneTargetList[e].target_id;t.setAttribute("id",r),t.GCSSID=e;let o=a.sceneTargetList[e].sceneIndex,n=c.F.getScenes(a.scenesData);if(Array.isArray(n)&&n[o]){let e=n[o];t.makarSceneName=e.info.name,t.makarSceneIndex=o,t.makarSceneID=e.info.id,t.setAttribute("visible",!1),t.loadedObjects=!1,t.showObjects=!0,t.addEventListener("loaded",(function(){t.object3D.matrixAutoUpdate=!1,t.object3D.targetRoot=!0,t.object3D.makarSceneName=e.info.name,t.object3D.makarSceneIndex=o,t.object3D.makarSceneID=e.info.id})),a.aframeNFTMarkers[o]?console.log(" _createAframeNFTMarker_: this scene entity is already loaded ",o,e):(console.log(" _createAframeNFTMarker_: load this scene entity ",o,e),a.arfScene.appendChild(t),a.aframeNFTMarkers[o]=t)}}return t},ARController.prototype.createThreeNFTMarker2D=function(e){this.setupThree();let t=this;var a=new THREE.Object3D;if(a.visible=!1,t.sceneTargetList&&t.sceneTargetList[e]){let r=t.sceneTargetList[e].sceneIndex,o=t.sceneTargetList[e].target_id;a.targetID=o,a.GCSSID=e,a.loadedObjects=!1,a.matrixAutoUpdate=!1;let n=c.F.getScenes(t.scenesData);if(Array.isArray(n)&&n[r]){let e=n[r];a.makarSceneName=e.info.name,a.makarSceneIndex=r,a.makarSceneID=e.info.id,t.threeNFTMarkers2D[r]?console.log(" _createThreeNFTMarker2D_: this scene entity is already loaded ",r,e):(console.log(" _createThreeNFTMarker2D_: load this scene entity ",r,e),t.arScene.scene2D.add(a),t.threeNFTMarkers2D[r]=a)}}return a},ARController.prototype.get2DScaleRatio=function(){let t,a,r,o=this,n="";if(4==Object.keys(this.editor_version).length){let e=Number(this.editor_version.v0),t=Number(this.editor_version.v1);Number(this.editor_version.v2),(e>3||3==e&&t>4)&&(n=i())}else n=i();function i(){let t="",a=o.arScene.clientWidth,r=o.arScene.clientHeight;if(e.oneProjData&&Array.isArray(e.oneProjData.orientation)){let n=e.oneProjData.orientation,i=1e3,s=0;n.forEach(((e,t)=>{let o=e.width/e.height/(a/r),n=e.width/a,l=e.height/r,c=o>1?o:1/o,d=n>1?n:1/n,u=l>1?l:1/l;e.nrdScore=c*(d+u),e.nrdScore<i&&(i=e.nrdScore,s=t)}));let l=n[s];o.selectedResolutionIndex=s,t=String(l.width)+","+String(l.height),console.log(" _getResolution350: ",i,s,l,t)}return t}if(""==n&&(console.log(" _get2DScaleRatio: fucking lose resolutionString "),o.selectedResolutionIndex=0,n="720,1280"),""!=n){let e=n.split(","),i=Number(e[0]),s=Number(e[1]),l=o.arfScene.clientWidth,c=o.arfScene.clientHeight;if(a=Math.abs(o.camera2D.right-o.camera2D.left),r=Math.abs(o.camera2D.bottom-o.camera2D.top),a/r>=l/c)if(l/c>=i/s){t=c*(i/s)/i,console.log(" _loadTexture2D: 1 ",i,s,l,c,t)}else t=l/i,console.log(" _loadTexture2D: 2 ",i,s,l,c,t);else if(l/c>=i/s){let e=c*(i/s),o=c/(l*(r/a)),n=e/l,d=e/i;t=d,console.log(" _loadTexture2D: 3 ",i,s,l,c,t,o,n,d)}else{let e=c/(l*(r/a)),o=l*(s/i)/c,n=l/i;t=n,console.log(" _loadTexture2D: 4 ",i,s,l,c,t,e,o,n)}}else console.log(" fucking lose resolutionString ");return console.log(" _get2DScaleRatio: srxy=",t),t},ARController.prototype.set2DScaleRatio=function(e){this.scaleRatioXY=e},ARController.prototype.loadMakarARScene=function(e,a,r,o){let n=this,i=c.F.getProjDataEditorVer(n.currentProjData);n.editor_version=i,window.aQuizAR.clear(),window.aQuizAR.scene3DRoot=a;let s=this.get2DScaleRatio();this.set2DScaleRatio(s),n.groupEventTargetDict[e]?console.log("_loadMakarARScene_: _groupEventTargetDict: already exist ",e):n.groupEventTargetDict[e]=JSON.parse(JSON.stringify(n.groupDict)),n.lookAtTargetTimelineDict[e]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",e):n.lookAtTargetTimelineDict[e]=[];let d=c.F.getSceneObjs(n.scenesData,e),u=n.scenesData.scenes[e].behav;t.setBehavsGroup(u,e);let m=[];for(let i=0;i<d.length;i++){let s=d[i];c.F.setBehavIntoObj(n.scenesData,e,s);let p=c.F.getObjTransform(n.scenesData,s),h=p.position,g=p.rotation,_=p.scale,b=p.quaternion;t.setObjBehav(s,u);let f=n.userProjResDict,y=n.userOnlineResDict;f[s.res_id]&&f[s.res_id].main_type?s.main_type=f[s.res_id].main_type:y[s.res_id]&&y[s.res_id].res_url?s.main_type=y[s.res_id].main_type:l(s),f[s.res_id]&&f[s.res_id].sub_type?s.sub_type=f[s.res_id].sub_type:y[s.res_id]&&y[s.res_id].res_url&&(s.sub_type=y[s.res_id].sub_type),f[s.res_id]&&f[s.res_id].res_url?s.res_url=f[s.res_id].res_url:y[s.res_id]&&y[s.res_id].res_url?s.res_url=y[s.res_id].res_url:console.log("_loadMakarARScene_: res_url does not exist. obj=",s),f[s.res_id]&&f[s.res_id].default_shader_name?s.default_shader_name=f[s.res_id].default_shader_name:y[s.res_id]&&y[s.res_id].default_shader_name?s.default_shader_name=y[s.res_id].default_shader_name:console.log("_loadMakarARScene_: default_shader_name does not exist. obj=",s);let w=c.F.getObjObjType(n.scenesData,s);switch(s.main_type){case"camera":break;case"image":let e;console.log(" _ARWrapper: load image ",i,w,s),"3d"==w?e=n.loadTexture3D(a,s,h,g,_,b):"2d"==w?e=n.loadTexture2D(r,s,i,d.length,h,g,_):console.log("VRController.js: _loadSceneObjects: image obj_type=",w),m.push(e);break;case"video":if(console.log(" _ARWrapper: load video ",i,w,s),"mp4"==d[i].sub_type){let e;"3d"==w?e=n.loadVideo3D(a,s,h,g,_,b):"2d"==w?e=n.loadVideo2D(r,s,i,d.length,h,g,_):console.log("VRFunc.js: _loadSceneObjects: video obj_type=",w),m.push(e)}else"youtube"==d[i].sub_type&&(console.log("makar webXR currently does not support yt video, please wait until next update."),"3d"==w?n.loadYouTubeNotSupport(a,s,i,d.length,h,g,_,b):"2d"==w?n.loadYouTubeNotSupport2D(r,s,i,d.length,h,g,_):console.log("VRController.js: _loadSceneObjects: yt video obj_type=",w));break;case"text":let t;"3d"==w?t=n.loadText3D(a,s,h,g,_,b):"2d"==w?t=n.loadText2D(r,s,i,d.length,h,g,_):console.log("VRFunc.js: _loadSceneObjects: text obj_type=",w),m.push(t);break;case"model":if(console.log(" _ARWrapper: load model ",i,w,s),"WebView"==s.res_id)console.log("webview obj",s),"3d"==w?n.loadWebViewNotSupport(a,s,i,d.length,h,g,_,b):"2d"==w&&n.loadWebViewNotSupport2D(r,s,i,d.length,h,g,_);else if("3d"==w){let e=n.loadGLTFModel(a,s,h,g,_,b);m.push(e)}break;case"curve":if("3d"==w){let e=n.loadCurve(a,s,h,g,_,b);m.push(e)}break;case"audio":if("mp3"==s.sub_type||"wav"==s.sub_type||"ogg"==s.sub_type){let e=n.loadAudio(a,s,h,g,_,b);m.push(e)}break;case"light":console.log(" _ARWrapper: load light ",i,w,s);let l=n.loadLight(a,s,h,g,_,b);m.push(l);break;case"empty":const c=n.currentProjData.proj_id;switch(d[i].sub_type){case"quiz":if(!d[i].typeAttr.module.display_order_list){console.log("%c _arController _loadMakarARScene: user has not set display_order_list. obj.typeAttr.module=","color:Salmon",d[i].typeAttr.module);break}a?(a.module="Quiz",a.loadModule="quiz"):r&&(r.module="Quiz",r.loadModule="quiz"),d[i].typeAttr.module.question_list.forEach((e=>{let t=e.options_json.find((e=>"Button"==e.res_id));t&&(t.generalAttr.obj_parent_id||(t.generalAttr.obj_parent_id=d[i].generalAttr.obj_id,console.log("%c 多選按鈕 btnJson","color: tomato",t)))}));const e=localStorage.getItem("MakarUserID");let t={position:h,rotation:g,scale:_,quaternion:b};const l={dpi:n.gcssTargets.dpi[a.GCSSID],GCSSWidth:n.gcssTargets.width[a.GCSSID],GCSSHeight:n.gcssTargets.height[a.GCSSID]};t.panByScene3DRoot=l;const u={startQuiz:document.getElementById("startQuiz"),QuizStartButton:document.getElementById("QuizStartButton"),QuizStartContent:document.getElementById("QuizStartContent")},p=window.aQuizAR.loadQuiz(a,r,d[i],t,c,e,u,n.worldContent,n.languageType);m.concat(p),console.log("VRFunc.js: _loadSceneObjects: empty, quiz ",i,d[i]);break;case"point_card":if("point_card"!=s.res_id)break;if(!s.typeAttr.module)break;if(!parent.mdb)break;if(!s.generalAttr.active)break;let f=n.loadPointCard(r,s,i,d.length,o);m.push(f);break;case"scratch_card":if(console.log("ARWrapper.js: _loadMakarARScene: scratch_card ",i,s),"scratch_card"==s.res_id&&s.typeAttr.module){if(!parent.mdb)break;let e=n.loadScratchCard(r,s,i,d.length,h,g,_);m.push(e)}break;default:console.log("VRFunc.js: _loadSceneObjects: empty object default, ",i,d[i])}break;default:console.log(" _ARWrapper: load default ",i,w,s)}}return m},ARController.prototype.setupThree=function(){if(this.THREE_JS_ENABLED)return;this.THREE_JS_ENABLED=!0;let a=this;this.currentSceneIndex=null,this.currentTargetIndex=null,this.currentTargetID=null,this.projStartTimeList=[],this.userStartTime=(new Date).getTime(),this.currentViewMode=null,this.aframeNFTMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={},this.threeNFTMarkers2D={},this.threeNFTMarkersCSS={},this.currentProjectIndex=null,this.objectControlState=null,this.safariUnMutedVideo=null,this.quizModule=[],this.logicList=[],this.controlObject=null,this.currentControllObject=null,this.makarObjects=[],this.makarObjects2D=[],this.sceneTargetList=null,this.materials_texture_dict={},this.init_gyro=null,this.intervalList=[],this.previousSceneIdx=-1,this.previousTargetID=-1,this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.groupEventTargetDict={},this.lookAtTargetTimelineDict={},this.gcssTargets={a:123},this.addEventListener("loadNFTDone",(function(e){a.gcssTargets=e.data})),this.addEventListener("getFrameTarget",(function(e){if(console.log("three.js, listened getFrameTarget, ev=",e),e.data.index<0){if(console.log("three.js: listened getFrameTarget index < 0, return ",this.threeNFTMarkers2D[-3]),this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name){this.threeNFTMarkers2D[-3].visible=!0;let e=this;setTimeout((function(){e.threeNFTMarkers2D[-3].visible=!1}),2e3)}}else{this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name&&(this.threeNFTMarkers2D[-3].visible=!1);var r=e.data.uArray,o=new ImageData(r,256,256);this.targetCtx.putImageData(o,0,0);let n=this.aframeNFTMarkers[a.sceneTargetList[e.data.index].sceneIndex],i=this.threeNFTMarkers2D[a.sceneTargetList[e.data.index].sceneIndex];console.log("artk.three.js, listened getFrameTarget, obj=",n,"\nobj2D=",i),console.log(" ************* ",e.data.index,a.sceneTargetList[e.data.index]),n.coloringStatus=1,n.loadModel=!0;let s=a.sceneTargetList[e.data.index].sceneIndex,l=a.sceneTargetList[marker.id].target_id;t.arController.loadMakarARScene(s,n,i,l)}})),this.checkColoring=function(e,t,r,o){if(a.sceneTargetList[e].sceneIndex,a.sceneTargetList[e].modules.includes("coloring")){if(1!=t.loadModel){if(1==o){for(let e in t.object3D.children)"coloredPlane"==t.object3D.children[e].name&&(t.object3D.children[e].material.color.r=0,t.object3D.children[e].material.color.g=1);for(let e in r.children)"colorButton"==r.children[e].name&&(r.children[e].material.opacity=1,r.children[e].behav[0].enable=!0)}else{for(let e in t.object3D.children)"coloredPlane"==t.object3D.children[e].name&&(t.object3D.children[e].material.color.r=1,t.object3D.children[e].material.color.g=0);for(let e in r.children)"colorButton"==r.children[e].name&&(r.children[e].material.opacity=.3,r.children[e].behav[0].enable=!1)}return 0}return 1}return-1},this.addEventListener("getNFTMarkerDraw",(function(e){let r=e.data.marker,o=this.aframeNFTMarkers[a.sceneTargetList[r.id].sceneIndex],n=this.threeNFTMarkers2D[a.sceneTargetList[r.id].sceneIndex],s=[];if(o){if(!o.loadedObjects||!n.loadedObjects){a.enableTracking=!1,o.loadedObjects=n.loadedObjects=!0;let d=document.getElementById("clickToPlayAudio");if(d.style.display="none",d.onclick=null,Array.isArray(a.currentProjData.loc)&&a.currentProjData.loc.length>0){function u(e,t,a,r,o="M"){if(e==a&&t==r)return 0;{let n=Math.PI*e/180,i=Math.PI*a/180,s=n-i,l=Math.PI*t/180-Math.PI*r/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(s/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(l/2),2)));return"M"==o&&(c*=6378137),console.log("three.js: _calculateGeosToDistanceHaversine dist=",c),c}}if(warnButtonTitle.textContent=a.worldContent.comfirm[languageType],warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none",o.loadedObjects=n.loadedObjects=!1},navigator.geolocation){function m(e){console.log("three.js: showProjectInfo: get Geolocation geoPosition=.",e.coords.latitude,e.coords.longitude);let l=u(e.coords.latitude,e.coords.longitude,a.currentProjData.loc[0],a.currentProjData.loc[1]);getViewerConfig(serverUrl,(function(e){if(l<e.data.gps_range_distance){let e=a.sceneTargetList[r.id].sceneIndex,l=a.sceneTargetList[r.id].target_id;s=t.arController.loadMakarARScene(e,o,n,l);let c=a.parseLogicXMLBySceneIndex(e);i(c)&&s.push(c)}else console.log("three.js: showProjectInfo: get Geolocation distance not allow",l),warnModal.style.display="block",warnModalInfo.textContent=a.worldContent.GPSDistanceMsg[languageType]+Math.floor(l)+" meter"}))}function p(e){console.log("three.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),warnModal.style.display="block",warnModalInfo.textContent=a.worldContent.GPSErrorMsg[languageType]+"\r\n"+e.message}navigator.geolocation.getCurrentPosition(m,p,{enableHighAccuracy:!1,timeout:5e3,maximumAge:0})}else console.log("three.js: showProjectInfo: Geolocation is not supported by this browser."),warnModal.style.display="block",warnModalInfo.textContent=a.worldContent.GPSnotSupportMsg[languageType]}else{let h=a.sceneTargetList[r.id].sceneIndex,g=a.sceneTargetList[r.id].target_id;s=t.arController.loadMakarARScene(h,o,n,g);let _=a.parseLogicXMLBySceneIndex(h);i(_)&&s.push(_),Array.isArray(s)&&Promise.all(s).then((function(e){console.log("three.js: _getNFTMarkerDraw _loadMakarScene done: ret = ",e),a.enableTracking=!0;let t=[];if(t=c.F.getScenes(a.scenesData),t[a.currentSceneIndex].bezier.length>0)for(let e=0;e<t[a.currentSceneIndex].bezier.length;e++)a.bezierPathAnime(o,t[a.currentSceneIndex].bezier[e],a.currentSceneIndex)}))}}if(r.found>0){if(a.currentSceneIndex=a.sceneTargetList[r.id].sceneIndex,a.currentTargetID=a.sceneTargetList[r.id].target_id,2==r.found){o.targetState=2,a.logicList[a.currentSceneIndex]&&0==a.logicList[a.currentSceneIndex].logicSystemState&&a.logicList[a.currentSceneIndex].parseXML();var l=this.checkColoring(a.sceneTargetList[r.id].targetIndex,o,n,e.data.marker.allowColor);1==l?parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="block"):0==l&&parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="none")}else if(o.targetState=1,Promise.all(s).then((e=>{if(null==a.init_gyro){let e=document.getElementById("cameraForGyro");a.init_gyro=e.components["look-controls"].magicWindowAbsoluteEuler.clone()}this.activeAndClearScene(this.sceneTargetList[r.id].sceneIndex,this.sceneTargetList[r.id].target_id),this.previousSceneIdx=this.currentSceneIndex,this.previousTargetID=this.currentTargetID,window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(a.mute3dVideos(!0),a.mute2dVideos(!0),a.UnMutedAndPlayAllVisibleVideo())),this.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly()})).catch((e=>{console.warn("ARController.js  load scene  error:",e)})),o.object3D&&o.object3D.children.length>0&&(o.object3D.traverse((function(e){e.originTransform&&(e.position.copy(e.originTransform.position),e.rotation.copy(e.originTransform.rotation),e.scale.copy(e.originTransform.scale))})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1),a.camera.projectionMatrix.elements[8]=a.bkCamera.projectionMatrix.elements[8],a.camera.projectionMatrixInverse.getInverse)a.camera.projectionMatrixInverse.getInverse(a.camera.projectionMatrix);else{let b=a.camera.projectionMatrix.clone();a.camera.projectionMatrixInverse.copy(b.invert())}o.object3D.matrix.fromArray(e.data.matrix)}else if(o.object3D.visible=!1,console.log("three.js: losing: obj= ",o,e.data.marker.id),this.checkColoring(e.data.marker.id,o,n,0),1==o.showObjects){if(o.targetState=0,arController.logicList[arController.currentSceneIndex]&&arController.logicList[arController.currentSceneIndex].stopLogic(),a.camera.projectionMatrix.elements[8]=0,a.camera.projectionMatrixInverse.getInverse)a.camera.projectionMatrixInverse.getInverse(a.camera.projectionMatrix);else{let w=a.camera.projectionMatrix.clone();a.camera.projectionMatrixInverse.copy(w.invert())}let f=e.data.marker.id,y=25.4*a.gcssTargets.width[f]/a.gcssTargets.dpi[f]/2;o.object3D.visible=!0,o.object3D.matrixAutoUpdate=!0,o.object3D.position.set(-y,40,250),o.object3D.rotation.x=90*Math.PI/180,o.object3D.updateMatrix(),o.object3D.updateMatrixWorld(),o.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;if(e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"image"==e.makarType||"video"==e.makarType){let t=e.getWorldQuaternion(new THREE.Quaternion),a=new THREE.Euler;a.setFromQuaternion(t),e.rotateOnAxis(new THREE.Vector3(0,1,0),0-a.y),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI-a.x),e.updateMatrixWorld(),e.updateMatrix()}"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1}}})),this.setViewMode=function(e=""){let t=this,a=t.aCamera,r=document.getElementById("oCamera");return""!=e&&(t.currentViewMode=e),new Promise((function(o){a&&r&&("AR"==e?(t.camera=a,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,o("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: AR err=",e)}))):"model"==e?(t.camera=r.object3D.children[0],r.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,o("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _model err=",e)}))):t.camera==a?(t.camera=r.object3D.children[0],r.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,o("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch model err=",e)}))):(t.camera=a,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,o("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch AR err=",e)}))))}))},this.setCurrentSceneIndex=function(e){this.currentSceneIndex=e},this.setViewModeSceneObj=function(e){let a=this;return new Promise((function(r,o){let n=-1;if(null==a.currentSceneIndex){let e=c.F.getScenes(a.scenesData);for(let t=0;t<e.length;t++)if("ar"==e[t].info.type){n=t,a.setCurrentSceneIndex(t);break}}else n=a.currentSceneIndex;if(n<0)return void r(!1);let s=!1;for(let e=0,t=a.sceneTargetList.length;e<t;e++)a.sceneTargetList[e].sceneIndex==n&&a.sceneTargetList[e].modules.includes("coloring")&&(s=!0);console.log(" _setViewModeSceneObj: _sceneIndex ",n);let l=a.aframeNFTMarkers[n],d=a.threeNFTMarkers2D[n];for(let e in a.aframeNFTMarkers)a.aframeNFTMarkers[e].object3D.visible=!1,a.aframeNFTMarkers[e].setAttribute("visible",!1);for(let e in a.threeNFTMarkers2D)a.threeNFTMarkers2D[e].visible=!1;if("AR"==e)if(1==l.loadedObjects||1==d.loadedObjects)if(d.visible=!1,l.setAttribute("visible",!1),l.object3D.visible=!1,l.object3D.traverse((function(e){"video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound()})),null!=l.coloringStatus&&1==s)if(-1==l.coloringStatus||0==l.coloringStatus){for(console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),l.loadModel=!1;l.children.length>0;)l.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=t.arController.loadMakarARScene(n,l,d,null),o=a.parseLogicXMLBySceneIndex(n);i(o)&&e.push(o),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),a.logicList[n]&&a.logicList[n].parseXML(),a.setupSceneBehav(n),r(!0)}))}else 1==l.coloringStatus&&(console.log(" _setViewModeSceneObj: model: color 1"),r(!0));else console.log(" _setViewModeSceneObj: AR: not _coloring module "),r(!0);else r(!0);else if("model"==e){if(1!=l.loadedObjects||1!=d.loadedObjects){l.loadedObjects=d.loadedObjects=!0,1==s&&(l.loadModel=!0,l.coloringStatus=0,(u=a.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,a.targetCanvas.width,a.targetCanvas.height));let e=t.arController.loadMakarARScene(n,l,d,null),o=a.parseLogicXMLBySceneIndex(n);i(o)&&e.push(o),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e);let t=[];if(t=c.F.getScenes(a.scenesData),t[a.currentSceneIndex].bezier.length>0)for(let e=0;e<t[a.currentSceneIndex].bezier.length;e++)a.bezierPathAnime(l,t[a.currentSceneIndex].bezier[e],a.currentSceneIndex);t[n].behav.length>0&&a.activeSceneEvent(t[n]),a.logicList[n]&&a.logicList[n].parseXML(),a.setupSceneBehav(n),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(a.mute3dVideos(!0),a.mute2dVideos(!0),a.UnMutedAndPlayAllVisibleVideo())),a.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly(),r(!0)})).catch((e=>{console.warn("ARController.js: _setViewModeSceneObj  load scene  error:",e)}))}else if(a.logicList[n]&&0==a.logicList[n].logicSystemState&&a.logicList[n].parseXML(),l.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),null!=l.coloringStatus&&1==s)if(-1==l.coloringStatus){var u;for(console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),l.loadModel=!0,l.coloringStatus=0,(u=a.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,a.targetCanvas.width,a.targetCanvas.height);l.children.length>0;)l.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=a.sceneTargetList[marker.id].target_id,o=t.arController.loadMakarARScene(n,l,d,e),s=a.parseLogicXMLBySceneIndex(n);i(s)&&o.push(s),Array.isArray(o)&&Promise.all(o).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),a.logicList[n]&&a.logicList[n].parseXML(),a.setupSceneBehav(n),r(!0)}))}else console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),r(!0);else console.log(" _setViewModeSceneObj: model: not _coloring module "),r(!0);d.visible=!0;let e=a.gcssTargets.dpi[l.GCSSID],o=a.gcssTargets.width[l.GCSSID],m=a.gcssTargets.height[l.GCSSID];l.setAttribute("visible",!0),l.object3D.visible=!0,l.object3D.matrixAutoUpdate=!0,l.object3D.position.set(0,0,0),l.object3D.position.add(new THREE.Vector3(25.4*-o/e/2,25.4*-m/e/2,0)),l.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&(e.el.blockly?console.log("ARWrapper.js: _setViewModeSceneObj:  audio blockly: do nothing ",e):e.el.components.sound.playSound()))})),l.object3D.rotation.x=-90*Math.PI/180,l.object3D.updateMatrix(),l.object3D.updateMatrixWorld()}else console.log(" _setViewModeSceneObj: error",e),o(e)}))},this.parseLogicXMLBySceneIndex=function(e){let t,r=c.F.getSceneLogicXML(a.scenesData,e);if(""!=r){let a=new Logic;t=a.loadXMLtoDoc(r),arController.logicList[e]=a}return t},this.activeAndClearScene=function(t,a=-1){let r=this;if(r.previousSceneIdx!=t){for(let e=0;e<r.intervalList.length;e++)window.clearInterval(r.intervalList[e]);r.init_gyro=null}for(let e in this.aframeNFTMarkers)if(e==t){this.aframeNFTMarkers[e].object3D.visible=!0,this.threeNFTMarkers2D[e].visible=!0;let t=this.aframeNFTMarkers[e];t.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location?r.dealVideoMuted():e.el.mp4Video.play()),"audio"==e.makarType&&(e.el.blockly?console.log("ARWrapper.js: _activeAndClearScene:  audio blockly: do nothing ",e):e.el.components.sound.playSound()))})),window.aQuizAR.scene3DRoot=t}else{if(this.aframeNFTMarkers[e].object3D.traverse((function(e){if("video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound(),e.behav_reference&&e.behav_reference.length>0)for(let t=0;t<e.behav_reference.length;t++)"ShowVideo"!=e.behav_reference[t].behav_name&&"ShowModel"!=e.behav_reference[t].behav_name&&"ShowImage"!=e.behav_reference[t].behav_name&&"PlayMusic"!=e.behav_reference[t].behav_name&&"ShowText"!=e.behav_reference[t].behav_name||e.el.setAttribute("visible",!1)})),this.aframeNFTMarkers[e].loadModule,0==this.aframeNFTMarkers[e].object3D.visible&&0==this.threeNFTMarkers2D[e].visible)continue;if(this.aframeNFTMarkers[e].object3D.visible=!1,this.threeNFTMarkers2D[e].visible=!1,this.threeNFTMarkers2D[e].loadModule)switch(this.threeNFTMarkers2D[e].loadModule){case"scratchCard":window.aScratchCard.hideScratchCardCanvas(this.threeNFTMarkers2D[e]);break;case"pointCard":console.log("three.js: recognize: _clearScene, processing pointCard "),aPointCard.hidePointCardCanvas(this.threeNFTMarkers2D[e]);break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[e].loadModule)}}if(r.previousSceneIdx!=t&&-1!=t){let e=[];e=c.F.getScenes(r.scenesData),e[t].behav.length>0&&r.activeSceneEvent(e[t])}if((this.previousSceneIdx!=t&&-1!=t||this.previousTargetID!=a&&-1!=a)&&this.threeNFTMarkers2D[t].loadModule)switch(this.threeNFTMarkers2D[t].loadModule){case"scratchCard":if("block"==startQuiz.style.display&&(startQuiz.style.display="none"),!parent.mdb)return[];let o;r.scenesData.scenes[r.currentSceneIndex].objs.forEach(((e,a)=>{e.typeAttr&&e.typeAttr.module&&e.typeAttr.module.moduleID==r.threeNFTMarkers2D[t].project_module.moduleID&&(o=e)})),window.aScratchCard.showScratchCardCanvas(this.threeNFTMarkers2D[t],o);break;case"pointCard":if("block"==startQuiz.style.display&&(startQuiz.style.display="none"),console.log("ARController _activeAndClearScene recognize: _clearScene, pointCard processing",r.threeNFTMarkers2D[t]),!parent.mdb)return[];let n=localStorage.getItem("MakarUserID");{let o,i;n="",r.scenesData.scenes[r.currentSceneIndex].objs.forEach(((e,a)=>{e.typeAttr&&e.typeAttr.module&&e.typeAttr.module.moduleID==r.threeNFTMarkers2D[t].project_module.moduleID&&(o=a,i=e)}));const s=r.scenesData.scenes[r.currentSceneIndex].objs.length;window.aPointCard.getPointCardProjectFromMDB(e.oneProjData.proj_id).then((e=>{const l=i.generalAttr.obj_id;e.pointCards&&e.pointCards[l]&&aPointCard.checkPointThenAdd(r.threeNFTMarkers2D[t],a,o,s,n)}))}break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[t].loadModule)}},this.dealVideoMuted=function(e){let t=document.getElementById("clickToPlayAudio");t.style.display="block",t.onclick=function(){t.setAttribute("didUserClick",!0),a.UnMutedAndPlayAllVisibleVideo(),window.allowAudioClicked=!0,t.style.display="none",t.onclick=null,window.alreadyClicked=!0,window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?(a.mute3dVideos(!0),a.mute2dVideos(!0),a.UnMutedAndPlayAllVisibleVideo()):1==window.Browser.mobile&&(a.unmute3dVideos(!0),a.unmute2dVideos(!0)))},t.getAttribute("didUserClick")?(console.log("user已允許聲音播放 (跳轉場景)"),mute3dVideos(!0),mute2dVideos(!0),e.muted=!1):t.style.display="block"},this.getMakarObject=function(e){return 1!=e.makarObject?e.parent?a.getMakarObject(e.parent):0:e},this.dealAllGroupHide=function(e,t){let a=this,r=a.groupEventTargetDict[t];if(r)for(let t=0;t<e.behav.length;t++){let o=e.behav[t];""!=o.group&&r[o.group]&&r[o.group].objs.forEach(((t,r)=>{if(!e.behav.find((e=>e.obj_id==t.obj_id))){let e=t.obj_id,r=!1;a.scenesData.scenes[a.currentSceneIndex].behav.forEach((t=>{t.obj_id!=e||"Display"!=t.behav_type||"Switch"!=t.switch_type&&"Show"!=t.switch_type||(r=!0)}));let n=a.getObjectTypeByObj_id(e);if("2d"==n.obj_type){let t=n.obj;o.obj_id!=e&&r&&(t.visible=!1)}else if("3d"==n.obj_type){let t=n.obj;o.obj_id!=e&&r&&a.hideGroupObjectEvent(t,r)}}}))}else console.log("_dealAllGroup: missing groupDict")},this.speechTextObj=function(e,t,a){if(console.log(" _speechTextObj: _textObj: ",e),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){1==speechSynthesis.speaking&&(speechSynthesis.pause(),speechSynthesis.cancel());let r=1;Number.isFinite(t)&&t>0&&(r=t);let o=e.typeAttr.content,n=new SpeechSynthesisUtterance(o);n.rate=r**3*.1837+r**2*-.9948+2.3352*r-.5196,n.pitch=1;let i="en",s="en-US";switch(a){case 0:default:i="en",s="en-US";break;case 1:i="zh-TW",s="zh-TW";break;case 2:i="zh-CN",s="zh-CN";break;case 3:i="ja",s="ja-JP";break;case 4:i="ko",s="ko-KR"}let l=setInterval((function(){let e=!1,t=speechSynthesis.getVoices();t.length>0&&(clearInterval(l),window.Browser&&"safari"!=window.Browser.name&&t.forEach((t=>{t.lang==s&&(e=!0,n.voice=t)})),0==e&&(n.lang=i),speechSynthesis.speak(n))}),1)}},this.hideGroupObjectEvent=function(e){e?e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)if("Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying){e.el.components.sound.stopSound();let t=new Event("sound-ended");e.el.dispatchEvent(t)}}}}))):console.log("VRFunc.js: _hideGroupObjectEvent: target not exist ",e)},this.setupSceneBehav=function(e){let t=this;for(let e=0,a=t.makarObjects.length;e<a;e++){let a=t.makarObjects[e].object3D;a?(a.behav,a.behav_reference):console.error(" _setupSceneBehav: 3d obj error",e,t.makarObjects[e])}},this.addLookAtTimeLine=function(e,t,a,r=this.currentSceneIndex){console.log(" _addLookAtTimeLine: _facingEvent=",a),this.lookAtTargetTimelineDict[r];let o=new THREE.Vector3;t.object3D.getWorldPosition(o),e.object3D.lookAt(o),e.object3D.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI),a&&0==a.is_front&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)},this.setObjectBehavAll=function(e,t){},this.addBehavToQuizTriggerObj=()=>{const e=window.aQuizAR.triggers;Array.isArray(e)&&0!=e.length&&window.aQuizAR.quizIdWithTriggers.forEach((e=>{let t=document.getElementById(e.trigger_id),r=this.makarObjects2D.find((t=>t.obj_id==e.trigger_id));const o={obj_id:e.obj_id,played:!1,behav_type:"ShowQuiz",force_login:e.force_login,allow_retry:e.allow_retry};if(t){console.log("ARController.js: _addBehavToQuizTriggerObj get quizTrigger=",t),t.className="clickable";let a=t.object3D;a.behav&&Array.isArray(a.behav)?a.behav.find((t=>t.obj_id==e.obj_id))||(a.behav.push(o),console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj3D=",a)):(a.behav=[o],console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj3D=",a))}else r?(console.log("ARController.js: _addBehavToQuizTriggerObj get quizTriggerObj2D=",r),r.behav?r.behav.find((t=>t.obj_id==e.obj_id))||(r.behav.push(o),console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj2D=",r)):(r.behav=[o],console.log("ARController.js: _addBehavToQuizTriggerObj  add behav to quizTriggerObj2D=",r))):console.log("VRController.js _loadScene: can not find quiz's trigger",e.trigger_id," performance.now()=",performance.now(),a.makarObjects2D.slice())}))},this.getMakarObject=function(e){return 1!=e.makarObject?e.parent?a.getMakarObject(e.parent):0:e},this.getObjectTypeByObj_id=function(e){let t=this,a=null,r=null,o=null,n=null,i={obj_type:"",obj_index:null,obj:null};return e&&(t.makarObjects.forEach(((t,o)=>{t.id==e&&(a=t,r=o)})),t.makarObjects2D&&t.makarObjects2D.forEach(((t,a)=>{t.obj_id==e&&(o=t,n=a)})),null!=a&&null!=r||null!=o&&null!=n?null!=a&&null!=r?(i.obj_type="3d",i.obj_index=r,i.obj=a):null!=o&&null!=n?(i.obj_type="2d",i.obj_index=n,i.obj=o):console.log("_getObjectTypeByObj_id: fucking logic trouble.",n,o):null!=a&&null!=r&&null!=o&&null!=n&&(i.obj_type="3d",i.obj_index=r,i.obj=a)),i},this.triggerEvent=function(e,t,a){let r=this,o=null;void 0===t&&(t=!1);let n=e.obj_id,i=document.getElementById("arDiv");switch(new Y(r,i).dispatchEvent(e),e.behav_type){case"Dialing":console.log("ARWrapper.js: _triggerEvent: Dialing: event=",e);let l=window.document.getElementById("phoneCall");l&&(l.href="tel:"+e.phone,l.click());break;case"Email":console.log("ARWrapper.js: _triggerEvent: SendEmail: event=",e);let c=window.document.getElementById("sendEmail");c&&(c.href="mailto:"+e.mail_to,c.click());break;case"URL":console.log("ARWrapper.js: _triggerEvent: URL: event=",e,e.url);let d=window.document.getElementById("openWebBrowser");d&&(d.href=e.url,d.click());break;case"Scenes":console.log("ARWrapper.js: _triggerEvent: _Scenes: event=",e);let u=e.scene_id;if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let _=setTimeout((()=>{r.eventChangeScene(u)}),3e3);e.previousID=_}else r.eventChangeScene(u);break;case"Display":if(console.log("ARWrapper.js: _triggerEvent: _Display: event=",e),o=document.getElementById(n),!o){console.warn("VRFunc.js: Media: target not exist",o);break}if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let b=setTimeout((()=>{m()}),3e3);e.previousID=b}else m();function m(){if("a-sound"==o.nodeName.toLowerCase()){if("Switch"==e.switch_type)if(o.getAttribute("visible")){o.setAttribute("visible",!1),o.setAttribute("class","unclickable"),o.components.sound.stopSound();let e=new Event("sound-ended");o.dispatchEvent(e)}else o.setAttribute("visible",!0),o.object3D.behav&&o.setAttribute("class","clickable"),o.blockly?console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",o):o.components.sound.playSound();else if("Show"==e.switch_type)o.setAttribute("visible",!0),o.object3D.behav&&o.setAttribute("class","clickable"),o.blockly?console.log("VRFunc.js: _showObjectEvent: set true, audio blockly: do nothing ",o):o.components.sound.playSound();else if("Hide"==e.switch_type){o.setAttribute("visible",!1),o.setAttribute("class","unclickable"),o.components.sound.stopSound();let e=new Event("sound-ended");o.dispatchEvent(e)}}else r.showObjectEvent(o,t,e.switch_type)}break;case"Display2D":if(console.log("VRFunc.js: _triggerEvent: Display2D: event=",e),1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("ARcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let f=setTimeout((()=>{p()}),3e3);e.previousID=f}else p();function p(){let t=r.makarObjects2D.find((t=>t.obj_id==e.obj_id));switch(e.switch_type){case"Switch":t&&(t.visible=!t.visible);break;case"Show":t.visible=!0;break;case"Hide":t.visible=!1}t.traverse((function(a){if(0==a.children.length)return;if(!a.children[0].material)return;if(!a.children[0].material.map)return;let o=a.children[0].material.map.image;if(a.children[0].material.map.image&&"video"==o.tagName.toLowerCase())switch(e.switch_type){case"Switch":t.visible?(window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(r.mute3dVideos(),r.mute2dVideos())),o.play(),o.muted=!1,r.safariUnMutedVideo=t):(o.pause(),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo()));break;case"Show":o.play(),o.muted=!1,r.safariUnMutedVideo=t;break;case"Hide":o.pause(),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||r.UnMutedAndPlayAllVisibleVideo())}}))}break;case"Media":console.warn("ARWrapper.js: _triggerEvent: _Media: event=",e);break;case"Animation":if(console.log("ARWrapper.js: _triggerEvent: _Animation: event=",e),o=document.getElementById(n),!(o&&o.object3D&&o.object3D.children[0]&&Array.isArray(o.object3D.children[0].animationSlices))){console.log("ARWrapper.js: _Animation: target not exist",o);break}{let y;for(let w=1;w<o.object3D.children[0].animationSlices.length;w++)o.object3D.children[0].animationSlices[w].uid==e.uid&&(y=o.object3D.children[0].animationSlices[w].animationName);o.setAttribute("animation-mixer","clip: "+y),e.loop?(o.object3D.children[0].animationSlices[0].loop=e.uid,o.object3D.children[0].animationSlices[0].uid=e.uid,o.object3D.children[0].animationSlices[0].changed=!0,o.object3D.children[0].animationSlices[0].reset=!0):(o.object3D.children[0].animationSlices[0].uid=e.uid,o.object3D.children[0].animationSlices[0].changed=!0,o.object3D.children[0].animationSlices[0].reset=e.reset)}break;case"TTS":if(console.log("ARWrapper.js: _triggerEvent: _TTS: event=",e),o=document.getElementById(n),!o||!o.object3D){console.log("ARWrapper.js: _TTS: target not exist",o);break}if(e.obj_id){let j=e.obj_id;r.scenesData&&r.scenesData.scenes[r.currentSceneIndex]&&Array.isArray(r.scenesData.scenes[r.currentSceneIndex].objs)&&r.scenesData.scenes[r.currentSceneIndex].objs.forEach((t=>{t.generalAttr.obj_id==j&&r.speechTextObj(t,e.speed,e.language)}))}break;case"ShowQuiz":if(window.aQuizAR.checkIsAnyQuizPlaying())console.log("%cVRController.js _triggerEvent: ShowQuiz triggered, but user hasn't finnish previous quiz yet.","color: orange");else{const D=document.getElementById("startQuiz");window.aQuizAR.currentlyTriggeredQuizId=e.obj_id,window.aQuizAR.checkIfQuizOpenByTrigger(D,n)}case"QuizOption":aQuizAR.loadedQuizzes.forEach((e=>{e.module.json.question_list.forEach((t=>{t.options_json.forEach((t=>{a.el?a.el.id==t.generalAttr.obj_id&&e.quizOption(a.el):a.obj_id==t.generalAttr.obj_id&&e.quizOption(a)}))}))}));break;case"MoveAlongPath":o=document.getElementById(n),o.object3D.bezier.play();break;case"Facing":if(1==e.delay){e.previousID&&clearTimeout(e.previousID),console.log("VRcontroller.js _triggerEvent: Delayed for 3 second.",e.behav_type);let v=setTimeout((()=>{h()}),3e3);e.previousID=v}else h();function h(){console.log("_triggerEvent: _Facing event=",e);let t=e.source_id,a=document.getElementById(t),o=e.toward_id,n=document.getElementById(o);a&&a.object3D&&n&&n.object3D?r.addLookAtTimeLine(a,n,e):console.log("_triggerEvent: _Facing error, obj not exist",a,n)}break;case"videoTogglePlayPause":console.log("_videoTogglePlayPause",e),o=document.getElementById(n);let g=r.makarObjects2D.find((t=>t.obj_id==e.obj_id));if(window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(r.mute3dVideos(),r.mute2dVideos()),o){if("a-video"==o.localName){let A=o.getAttribute("src");if(null!=A){A=A.split("#").pop();let E=document.getElementById(A);E instanceof HTMLElement&&((s=E).currentTime>0&&!s.paused&&!s.ended&&s.readyState>2?(E.pause(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(console.log("這裡應該讓其他的影片發出聲音"),E.muted=!0,r.UnMutedAndPlayAllVisibleVideo())):(E.play(),E.muted=!1,r.safariUnMutedVideo=o))}}}else{if(!g){console.warn("VRFunc.js: _videoTogglePlayPause: target not exist. obj_id=",n," target=",o);break}if("video2D"!=g.makarType)return;if(0==g.children.length)return;if(!g.children[0].material)return;if(!g.children[0].material.map)return;if(!g.children[0].material.map.image)return;if("VIDEO"==g.children[0].material.map.image.tagName){const C=g.children[0].material.map.image;if(C){console.log("video.volume",C.volume),0!=C.volume&&window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location||1==window.Browser.mobile)&&r.UnMutedAndPlayAllVisibleVideo(g);const k=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2);console.log("_videoTogglePlayPause obj2D isVideoPlaying",k),k(C)?(C.pause(),0!=C.volume&&window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location?(C.muted=!0,r.UnMutedAndPlayAllVisibleVideo()):1==window.Browser.mobile&&(console.log("chrome mobile ios 為何chrome自動播放會只剩一個然後停止別人??  所以在點擊事件也要像ios一樣嗎"),r.UnMutedAndPlayAllVisibleVideo()))):(C.play(),C.muted=!1,r.safariUnMutedVideo=g)}}}break;default:console.log("ARWrapper.js: _triggerEvent: default: event=",e)}var s},this.eventChangeScene=function(e){let a=this;return new Promise((function(r){a.scenesData&&Array.isArray(a.scenesData.scenes)?console.log(" _eventChangeScene_: _sceneID: ",e):(console.log("_eventChangeScene_: scenesData error ",a.scenesData),r(!1));for(let o=0;o<a.scenesData.scenes.length;o++)if(a.scenesData.scenes[o].info.id==e){let e=a.scenesData.scenes[o].info;if("ar"==e.type)console.log(" _Scenes_ , to AR , ",o,e),"model"==a.currentViewMode?(a.setCurrentSceneIndex(o),a.sceneTargetList.forEach((e=>{if(e.sceneIndex==o){let o=e.sceneIndex,n=a.aframeNFTMarkers[o],s=a.threeNFTMarkers2D[o];if(1==n.loadedObjects||1==s.loadedObjects){console.log("three.js: _setViewModeSceneObj: already loaded, call _activeAndClearScene_ "),a.activeAndClearScene(o,e.target_id);let t=a.gcssTargets.dpi[n.GCSSID],i=a.gcssTargets.width[n.GCSSID],s=a.gcssTargets.height[n.GCSSID];n.object3D.position.set(0,0,0),n.object3D.position.add(new THREE.Vector3(25.4*-i/t/2,25.4*-s/t/2,0)),n.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&e.el.components.sound.playSound())})),n.object3D.rotation.x=-90*Math.PI/180,n.object3D.updateMatrix(),n.object3D.updateMatrixWorld(),r(!0)}else{console.log("three.js: _setViewModeSceneObj: not loaded, call _loadMakarARScene_ "),n.loadedObjects=!0,s.loadedObjects=!0;let l=a.sceneTargetList[marker.id].target_id,d=t.arController.loadMakarARScene(o,n,s,l),u=a.parseLogicXMLBySceneIndex(o);i(u)&&d.push(u),Array.isArray(d)&&Promise.all(d).then((function(t){console.log("three.js: _setViewModeSceneObj: done: ret = ",t);let i=[];if(i=c.F.getScenes(a.scenesData),i[o].bezier.length>0)for(let e=0;e<i[o].bezier.length;e++)a.bezierPathAnime(n,i[o].bezier[e],o);i[o].behav.length>0&&a.activeSceneEvent(i[o]),a.logicList[o]&&a.logicList[o].parseXML(),a.setupSceneBehav(o),a.activeAndClearScene(o,e.target_id),window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||(a.mute3dVideos(!0),a.mute2dVideos(!0),a.UnMutedAndPlayAllVisibleVideo())),a.addBehavToQuizTriggerObj(),aQuizAR.checkIfQuizOpenDirectly(),r(!0)})).catch((e=>{console.warn("ARController.js: _eventChangeScene  load scene  error:",e)}))}}}))):"AR"==a.currentViewMode&&(a.setCurrentSceneIndex(o),a.activeAndClearScene(-1));else if("vr"==e.type){if(console.log(" _Scenes_ , to VR , ",e),window.mixController&&window.vrController&&window.vrController){let e=document.getElementById("loadPage");e&&(e.style.display="block"),arController.activeAndClearScene(-1),arController.enableARRendering=!1,vrController.enableVRRendering=!0,mixController.setActiveType("VR"),vrController.triggerEnable=!1,vrController.loadScene(o),"model"==a.currentViewMode?vrController.setViewMode("model"):"AR"==a.currentViewMode&&vrController.setViewMode("VR")}}else"ar_slam"==e.type&&(console.log(" _Scenes_ , to AR_SLAM , not yet ",e),window.mixController&&window.xrController&&window.xrController&&(arController.activeAndClearScene(-1),arController.enableARRendering=!1,xrController.enableXRRendering=!0,mixController.setActiveType("XR"),xrController.triggerEnable=!1,xrController.loadScene(o),"model"==a.currentViewMode?xrController.setViewMode("model"):"AR"==a.currentViewMode&&xrController.setViewMode("VR")))}}))},this.showObjectEvent=function(e,t,r){function o(){if(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),"a-video"==e.localName){let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||a.UnMutedAndPlayAllVisibleVideo(a.safariUnMutedVideo)),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound"))if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)if("Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying){e.el.components.sound.stopSound();let t=new Event("sound-ended");e.el.dispatchEvent(t)}}}})),t&&e.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}function n(){window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||a.UnMutedAndPlayAllVisibleVideo(e)),e.setAttribute("visible",!0);let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}e.object3D.behav&&e.setAttribute("class","clickable"),e.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&(e.el.blockly?console.log("ARWrapper.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}e?"Switch"==r?e.getAttribute("visible")?o():n():"Show"==r?n():"Hide"==r&&o():console.log("ARWrapper.js: _showObjectEvent: target not exist",e)},this.activeSceneEvent=function(e){let t=this;for(let r=0;r<e.behav.length;r++){let o=e.behav[r];if("Time"==o.trigger_type){let e=(new Date).toTimeString().split(":")[0];o.trigger_end_time-o.trigger_start_time>=0?e>=o.trigger_start_time&&e<o.trigger_end_time&&a(o):(e>=o.trigger_start_time||e<o.trigger_end_time)&&a(o)}else if("Gyro"==o.trigger_type){let e=!1,r=setInterval((function(){if(null!=t.init_gyro){let r;r=-(document.getElementById("cameraForGyro").components["look-controls"].magicWindowAbsoluteEuler.y-t.init_gyro.y)/Math.PI*180%360,r<0&&(r+=360);let n=o.trigger_start_vec.split(",").map((e=>Number(e)))[1],i=o.trigger_end_vec.split(",").map((e=>Number(e)))[1];n%=360,n<0&&(n+=360),i%=360,i<0&&(i+=360),i-n>0?r>=n&&r<=i?e||(e=!0,a(o)):e=!1:r>=n||r<=i?e||(e=!0,a(o)):e=!1}}),0);t.intervalList.push(r)}}function a(e){let a;if(e.obj_id){if(a=t.getObjectTypeByObj_id(e.obj_id),"Display"==e.behav_type){console.log("gObj",a);const r={behav:[e]};console.log("dealAllGroupHide"),t.dealAllGroupHide(r,arController.currentSceneIndex),"2d"==a.obj_type&&(e.behav_type="Display2D")}t.triggerEvent(e,!1,null)}}},this.runAnimation2D=function(e,t){if(!e||!t.dt)return console.warn("three.js: _runAnimation2D warning, obj is null "),-1;if(!e.isObject3D)return console.warn("three.js: _runAnimation2D warning, obj is not THREE.Object3D "),-1;if(t.dp&&t.dp.isVector3){var a=t.dp.clone().normalize(),r=t.dp.length(),o=null,n=null,i=null,s=null,l=function(c){o||(o=c),s=i?c-i:0,i=c,(n=c-o)<t.dt&&(e.translateOnAxis(a,r*(s/t.dt)),requestAnimationFrame(l))};requestAnimationFrame(l)}if(t.ds&&t.ds.isVector3){t.ds.x<0||t.ds.y<0||t.ds.z,t.ds.clone().normalize(),t.ds.length();let a=e.scale.clone(),r=t.ds,l=e.scale.clone().multiply(r),d=l.clone().sub(a),u=(new THREE.Vector3(1,1,1).divide(r),l.clone()),m=a.clone().clone().sub(u);o=null,n=null,i=null,s=null;var c=function(r){o||(o=r),s=i?r-i:0,i=r,(n=r-o)<t.dt?(e.scale.copy(a.clone().add(d.clone().multiplyScalar(n/t.dt))),requestAnimationFrame(c)):t.reverse?n<2*t.dt?(e.scale.copy(u.clone().add(m.clone().multiplyScalar((n-t.dt)/t.dt))),requestAnimationFrame(c)):(e.scale.copy(a),console.log("three.js: _runAnimation2D: ds reverse end ",e.scale)):(e.scale.copy(l),console.log("three.js: _runAnimation2D: ds end , not reverse ",e.scale))};requestAnimationFrame(c)}if(t.dopacity&&e.material&&e.material.opacity){console.log("0 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity);var d=e.material.opacity,u=d-t.dopacity,m=(o=null,n=null,function(a){o||(o=a),(n=a-o)<t.dt?(e.material.opacity=d-u*(n/t.dt),requestAnimationFrame(m)):console.log("1 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity)});requestAnimationFrame(m)}},this.getSnapShot=function(){let e=this;return new Promise((function(t){if(!(e&&e.GLRenderer&&e.arScene&&e.arScene.videoScene&&e.arScene.videoCamera&&e.arScene.camera&&e.arScene.scene2D&&e.arScene.camera2D&&e.GLRenderer.domElement&&e.GLRenderer.domElement.clientWidth&&e.GLRenderer.domElement.clientHeight&&e.GLRenderer.domElement.width&&e.GLRenderer.domElement.height))return console.log(" _XRController: _getSnapShot: something error ",e),void t(-1);let a,r=[];for(var o=0;o<e.arScene.scene2D.children.length;o++)e.arScene.scene2D.children[o].GCSSID<0&&1==e.arScene.scene2D.children[o].visible&&(r.push(o),e.arScene.scene2D.children[o].visible=!1);for(e.GLRenderer.autoClear=!1,e.GLRenderer.render(e.arScene.videoScene,e.arScene.videoCamera),e.GLRenderer.clearDepth(),e.GLRenderer.render(e.arfScene.object3D,e.camera),e.GLRenderer.render(e.arScene.scene2D,e.arScene.camera2D),o=0;o<r.length;o++)e.arScene.scene2D.children[r[o]].visible=!0;a=e.GLRenderer.domElement.toDataURL("image/png",1),t(a)}))},this.switchCamera=function(e){let t=e||{facing:"environment"};"environment"==a.facing?(t.facing="user",a.facing="user"):(t.facing="environment",a.facing="environment"),a.arScene.video.srcObject.getTracks().forEach((e=>{e.stop()}));let r=function(e){if(console.log("three.js: _startWebCam: videoSuccess: stream=",e),window.videoStream=e,a.videoStreamPlane.material.map.image){let t=a.videoStreamPlane.material.map.image;t.srcObject=e,t.playsInline=!0,t.onloadedmetadata=function(){a.videoCamera?console.log("three.js: _startWebCam: videoCamera exist, donothing "):console.log("three.js: _startWebCam: videoCamera not exist, start video "),function e(){t.videoWidth>200||t.videoHeight>200?(t.play(),console.log("three.js: _switchCamera: video play  ")):setTimeout(e,100)}()},a.streamVideo=t}},o=function(e){console.log("three.js: _switchCamera: onError e = ",e)};navigator.mediaDevices.enumerateDevices().then((function(e){let a,n,i,s=!1;e=e.filter((function(e){return"videoinput"===e.kind})),n="environment"==t.facing?"back":"user"==t.facing?"front":"back";for(let t in e)-1!=e[t].label.toLowerCase().search(n)&&(a=e[t].deviceId,s=!0);if(s)console.log("three.js: _useDeviceID true, cameraID=",a),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},deviceId:{exact:a}}};else{let e;t.facing?(e=t.facing,console.log("three.js: _configuration.facing do exist: set facing = ",e),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:e}}):(console.log("api.js: _configuration.facing dosent exist: set facing = environment"),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:"environment"}})}navigator.mediaDevices.getUserMedia(i).then(r,o)}))}})}initARProcess(e){let t=this;return new Promise((function(e){if(!(window.ARController&&ARController.getUserMediaThreeScene&&window.ARProxy))return void console.warn(" _initARProcess_: not loaded , _return ");console.log(" _initARProcess_: all done ");let a="environment";ARController.getUserMediaThreeScene({maxARVideoSize:640,cameraParam:"../camera_para_640_480_fei.dat",facing:a,onSuccess:function(r,o,n){var i=new ARProxy(o,"../camera_para_640_480_fei.dat",(function(){}));window.proxy=i;let s=document.getElementById("arfScene"),l=s.canvas;o.arfScene=s,o.facing=a;let d=s.renderer;if(l.style.position="relative",d.outputEncoding=THREE.GammaEncoding,d.gammaFactor=1,d.sortObjects=!0,o.GLRenderer=d,o.arScene=r,window.arController=o,t.arController=o,t.arController.setARTransform=m,t.arController.loadAudio=w,t.arController.loadGLTFModel=g,t.arController.loadWebViewNotSupport=f,t.arController.loadWebViewNotSupport2D=y,t.arController.loadTexture2D=v,t.arController.loadTexture3D=D,t.arController.loadLight=A,t.arController.loadText2D=C,t.arController.loadText3D=E,t.arController.loadVideo2D=z,t.arController.loadVideo3D=k,t.arController.loadCurve=H,t.arController.bezierPathAnime=V,t.arController.loadScratchCard=F,t.arController.loadPointCard=L,t.arController.UnMutedAndPlayAllVisibleVideo=R,t.arController.mute2dVideos=x,t.arController.mute3dVideos=M,t.arController.pause2dVideos=I,t.arController.pause3dVideos=P,t.arController.loadYouTubeNotSupport=O,t.arController.loadYouTubeNotSupport2D=B,t.arController.languageType=window.languageType="tw",t.arController.worldContent={inputSearch:{tw:"搜尋",en:"Search"},labelSelected:{tw:"精選",en:"Selected"},userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},targetNumberError:{tw:"辨識圖的數量不可超過20 ",en:"the max number of image targets can't larger than 20 "},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"comfire"},timeIsUp:{tw:"時間到",en:"Time is up"}},"object"==typeof t.userProjResDict&&(o.userProjResDict=t.userProjResDict),"object"==typeof t.userOnlineResDict&&(o.userOnlineResDict=t.userOnlineResDict),"object"==typeof t.userMaterialDict&&(o.userMaterialDict=t.userMaterialDict),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();o.voices=e}if(i.addEventListener("load",(function(a){if(this.processingDone=!1,t.currentProjData&&t.scenesData&&t.targetList){let a=t.currentProjData,n=t.scenesData;o.currentProjData=a,o.scenesData=t.scenesData;let s=0,l=0,d=0,u=0,m=[];o.sceneTargetList=m;let p=[];p=c.F.getScenes(n);for(let e=0;e<p.length;e++){Array.isArray(p[e].target_ids)&&(s+=p[e].target_ids.length);let t=p[e];t.info&&"ar"==t.info.type&&(l+=1)}if(console.log("three.js: _load: the total target number = ",s),s>19)return console.log("three.js: _load: languageType = ",languageType),warnModal.style.display="block",warnModalInfo.textContent=t.arController.worldContent.targetNumberError[languageType],void(warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none"});let h=function(t){if(console.log("three.js: _onloadNFTMarker: ev = ",t),o.createAframeNFTMarker(t.result[0]),o.createThreeNFTMarker2D(t.result[0]),u+=1,Object.values(o.aframeNFTMarkers).length==l){let t=o;if(t.aframeNFTMarkers)for(let e in t.aframeNFTMarkers){let a=t.aframeNFTMarkers[e];if(Number.isInteger(Number(a.GCSSID))&&a&&a.object3D&&t.gcssTargets&&t.gcssTargets.dpi&&t.gcssTargets.width&&t.gcssTargets.height){let e=t.gcssTargets.dpi[a.GCSSID],r=t.gcssTargets.width[a.GCSSID],o=t.gcssTargets.height[a.GCSSID];a.object3D.matrixAutoUpdate=!0,a.object3D.position.set(0,0,0),a.object3D.position.add(new THREE.Vector3(25.4*-r/e/2,25.4*-o/e/2,0)),a.object3D.rotation.x=-90*Math.PI/180,a.object3D.updateMatrix(),a.object3D.updateMatrixWorld()}}console.log("three.js: _onloadNFTMarker done, call arScene.video.play() "),i.processingDone=!0,console.log("three.js:arScene.video.play()=>tick()"),e(),b(),setTimeout((function(){r.video.play().then((function(){console.log("three.js:arScene.video.play()=> succes")})).catch((function(e){console.error("three.js:arScene.video.play()=> error",e)}))}),10),o.userStartTime=(new Date).getTime()}};(new THREE.TextureLoader).load("https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg",(function(e){let r;r=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let n=o.GLRenderer,l=r.fromEquirectangularTexture(n,e);o.cubeTex=l;let u=[],g=c.F.getOneProj(a);if(g&&g.proj_descr&&g.proj_descr.includes("_coloring")){let e=g.proj_descr,t=e.indexOf("_coloring"),a=e.slice(t+10).indexOf(" "),r=e.slice(t+10,t+10+a).split("_");for(let e=0;e<r.length;e++)Number.isInteger(Number(r[e]))&&u.push(Number(r[e]))}for(let e=0;e<p.length;e++)if(Array.isArray(p[e].target_ids)&&p[e].info&&"ar"==p[e].info.type){let a=p[e].target_ids;for(let r=0;r<a.length;r++){let o=a[r];if(t.targetList){let a=t.targetList;for(let t=0;t<a.length;t++)if(a[t].target_id==o){let n=a[t].gcss_url;m[d]={sceneIndex:e,targetIndex:r,target_id:o,modules:[]},u.includes(e)&&m[d].modules.push("coloring"),i.loadNFTMarker(n.substring(0,n.length-5),d,s,h),d++}}}}console.log("three.js: _load: , _sceneTargetList = ",m)}))}})),document.body.className=o.orientation,"portrait"===o.orientation){let e,t;window.innerWidth/window.innerHeight>o.videoWidth/o.videoHeight?(e=window.innerWidth,t=window.innerWidth/o.videoWidth*o.videoHeight):(e=window.innerHeight/o.videoHeight*o.videoWidth,t=window.innerHeight),d.setSize(e,t),console.log("3 three.js:portrait GLRenderer.setSize=",e,t),l.style.left=(innerWidth-e)/2+"px",l.style.top=(innerHeight-t)/2+"px"}else if(/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)){let e,t;console.log("4 three.js:GLRenderer.setSize=",window.innerWidth,window.innerWidth/o.videoWidth*o.videoHeight),window.innerWidth/window.innerHeight>o.videoWidth/o.videoHeight?(e=window.innerWidth,t=window.innerWidth/o.videoWidth*o.videoHeight):(e=window.innerHeight/o.videoHeight*o.videoWidth,t=window.innerHeight),d.setSize(e,t),l.style.left=(innerWidth-e)/2+"px",l.style.top=(innerHeight-t)/2+"px"}else{let e,t;window.innerWidth/window.innerHeight>o.videoWidth/o.videoHeight?(e=window.innerWidth,t=window.innerWidth/o.videoWidth*o.videoHeight):(e=window.innerHeight/o.videoHeight*o.videoWidth,t=window.innerHeight),d.setSize(e,t),l.style.left=(innerWidth-e)/2+"px",l.style.top=(innerHeight-t)/2+"px",document.body.className+=" desktop",console.log("5 three.js: landscape GLRenderer.setSize=",o.videoWidth,o.videoHeight)}var u=new THREE.ObjectControls(d.domElement,new THREE.Object3D);u.enableVerticalRotation(),u.setRotationSpeed(.1),u.setRotationSpeedTouchDevices(.05);var p=function(e){null!=o.controlObject&&0!=o.controlObject?(this.setObjectToMove(o.controlObject),this.setCurrentControllObject(o.currentControllObject)):this.setObjectToMove(null)};u.addEventListener("mouseDown",p),u.addEventListener("onTouchStart",p),o.objectControls=u;let h=new THREE.Vector2,_=(new THREE.Vector2,new THREE.Raycaster);o.getMouse=function(e){let t=o.GLRenderer.domElement,a=t.getBoundingClientRect(),r=new THREE.Vector2;switch(e.type){case"mouseup":case"mousemove":case"mousedown":r.x=(e.clientX-a.left)/t.clientWidth*2-1,r.y=-(e.clientY-a.top)/t.clientHeight*2+1;break;case"touchend":case"touchstart":case"touchmove":r.x=(e.changedTouches[0].clientX-a.left)/t.clientWidth*2-1,r.y=-(e.changedTouches[0].clientY-a.top)/t.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",e.type," not mouseup/touchend, return ")}return r},o.clickEndEvent=function(e){let t=o;if(2==o.objectControlState)return;let a=t.getMouse(e),n={};if(_.setFromCamera(a,r.camera2D),null!=o.currentSceneIndex){let e=o.threeNFTMarkers2D[o.currentSceneIndex],r=_.intersectObject(e,!0);if(0!=r.length){console.log(" intersects2D =",r);let e=0;for(var i=0;i<r.length;i++)r[i].object.defaultTexture&&(e=i);let t=o.getMakarObject(r[e].object);if(console.log("three.js: endEvent: 2D intersects touchObject2D =",t),t.behav){let e=!1;for(let a=0;a<t.behav.length;a++)"CloseAndResetChildren"==t.behav[a].simple_behav&&(e=!0);o.dealAllGroupHide(t,o.currentSceneIndex);for(let a=0;a<t.behav.length;a++){let r;if(t.behav[a].obj_id&&(r=o.getObjectTypeByObj_id(t.behav[a].obj_id)),"Display"==t.behav[a].behav_type)if("2d"==r.obj_type){var s=Object.assign({},t.behav[a]);s.behav_type="Display2D",o.triggerEvent(s,e,t)}else"3d"==r.obj_type&&o.triggerEvent(t.behav[a],e,t);else t.behav[a].behav_type,o.triggerEvent(t.behav[a],e,t)}}return void("button"==t.main_type&&(console.log("three.js: button click ",t),o.clickQuiz2DButton(t)))}_.setFromCamera(a,o.camera);let l=[];for(let e=0;e<o.makarObjects.length;e++){let t=o.makarObjects[e];t.object3D&&l.push(t.object3D)}let c=o.aframeNFTMarkers[o.currentSceneIndex],d=_.intersectObject(c.object3D,!0);if(0!=d.length){console.log("endEvent: intersects =",d);let e=o.getMakarObject(d[0].object),a=e.el;if(console.log("three.js: _setupFunction: endEvent, intersectObject3D=",a.object3D),a&&a.onclickBlock)for(let e=0;e<a.onclickBlock.length;e++)a.onclickBlockState[e]&&(a.onclickBlockState[e]=!1,o.logicList[o.currentSceneIndex].parseBlock(a.onclickBlock[e],(function(){a.onclickBlockState[e]=!0})),n["3d_logic"]=a.onclickBlock[e]);if(e.behav){n["3d_behav"]=e.behav,o.dealAllGroupHide(e,o.currentSceneIndex);let a=!1;for(let t=0;t<e.behav.length;t++)"CloseAndResetChildren"==e.behav[t].simple_behav&&(a=!0);for(let r=0;r<e.behav.length;r++)if("CloseAndResetChildren"!=e.behav[r].simple_behav){let o;if(e.behav[r].obj_id&&(o=t.getObjectTypeByObj_id(e.behav[r].obj_id)),"ShowQuiz"==e.behav[r].behav_type)e.behav[r].scene3DRoot=c,0==e.behav[r].played?t.triggerEvent(e.behav[r],a,e):console.log("VRFunc.js: _setupFunction: endEvent:  Quiz had been played.",e.behav[r].played);else if("Display"==e.behav[r].behav_type)if("2d"==o.obj_type){let o=Object.assign({},e.behav[r]);o.behav_type="Display2D",t.triggerEvent(o,a,e)}else"3d"==o.obj_type&&t.triggerEvent(e.behav[r],a,e);else if("Media"==e.behav[r].behav_type)if("2d"==o.obj_type){let o=Object.assign({},e.behav[r]);o.behav_type="Media2D",t.triggerEvent(o,a,e)}else"3d"==o.obj_type&&t.triggerEvent(e.behav[r],a,e);else t.triggerEvent(e.behav[r],a,e)}}console.log("three.js: touchObject",e)}}0==Object.keys(n).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",n)},o.clickStartEvent=function(e){let t=o;o.objectControlState=1,e.preventDefault();let a=t.getMouse(e);if(h=t.getMouse(e),_.setFromCamera(a,o.camera),null!=o.currentSceneIndex){let e=o.aframeNFTMarkers[o.currentSceneIndex],a=_.intersectObjects([e.object3D],!0);if(0!=a.length){console.log("startEvent: intersects =",a);let e=o.getMakarObject(a[0].object),r=!1,n=!0;const i=e.el.id;let s=makarUserData.scenesData.scenes[t.currentSceneIndex].objs.find((e=>e.generalAttr.obj_id==i));s?(r=!0,s.generalAttr.interactable&&"3d"==s.generalAttr.obj_type&&"youtube"!=s.sub_type?(u.setObjectToMove(e),u.setCurrentControllObject(e),n=!0):n=!1):(n=!1,r=!1),n||r?1==r?1==n?(o.controlObject=e,o.currentControllObject=e):o.controlObject=null:(o.controlObject=e,o.currentControllObject=e):console.log("startEvent: fingerActive=",n,"gotFingerGesture=",r)}else o.controlObject=null}},o.clickMoveEvent=function(e){let t=o.getMouse(e);1==o.objectControlState&&t.sub(h).length()>.01&&(o.objectControlState=2)};let b=function(){let e=(new Date).getTime(),t=30;if(1==o.enableARRendering){1==o.enableTracking&&i.process(r.video);let a=o.clock.getDelta();for(let e=0;e<o.makarObjects.length;e++)1==o.makarObjects[e].playAnimation&&1==o.makarObjects[e].visible&&o.checkAimation(o.makarObjects[e].children[0],a);r.renderOn(d,null);let n=(new Date).getTime();t=n-e<30?30-(n-e)+1:1}else t=30;setTimeout(b,t)}}})}))}startAR(){let e=arController;e.enableARRendering=!0;let t=document.getElementById("homePage");parent.selectedProject?"XR"==parent.selectedProject.viewMode?e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):"model"==parent.selectedProject.viewMode?e.setViewMode("model").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()}setBehavsGroup(e,t){let a=arController.groupEventTargetDict[t];e.forEach((e=>{""!=e.group&&Number.isFinite(Number(e.group))&&a[e.group]&&a[e.group].objs.push(e)}))}setObjBehav(e,t){e.behav&&Array.isArray(e.behav)&&e.behav.length>0||t.forEach((t=>{t.trigger_obj_id&&t.trigger_obj_id==e.generalAttr.obj_id&&(e.behav&&Array.isArray(e.behav)&&e.behav.length>0?e.behav.push(t):e.behav=[t])})),e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0||t.forEach((t=>{t.obj_id&&t.obj_id==e.generalAttr.obj_id&&("Display"!=t.behav_type&&"Media"!=t.behav_type||(e.behav_reference&&Array.isArray(e.behav_reference)&&e.behav_reference.length>0?e.behav_reference.push({behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}):e.behav_reference=[{behav_type:t.behav_type,switch_type:t.switch_type,trigger_obj_id:t.trigger_obj_id}]))}))}};window.startARProcess=function(e){!function(e){if(parent&&parent.selectedProject&&"string"==typeof parent.selectedProject.proj_id&&"string"==typeof parent.selectedProject.user_id){let t=parent.selectedProject.user_id,a=[parent.selectedProject.proj_id],r={};window.makarUserData=r,r.oneProjData=e;let o=[],n=c.F.getProjDataEditorVer(e);if(3==n.v0&&n.v1>=5){if(e&&Array.isArray(e.target_ids)){let t=d.A.getTargetList(e.target_ids);o.push(t),t.then((function(e){e.data&&Array.isArray(e.data.targetList)&&(r.targetList=e.data.targetList)}))}let n=d.A.getProjectSceneList(a),i=d.A.getUserOnlineResources(t),s=d.A.getUserResources(t),l=d.A.GetUserMaterials(t);o.push(n),o.push(i),o.push(s),o.push(l),n.then((function(e){console.log(" _pScenes_: ",e),e.data&&Array.isArray(e.data.projectSceneList)&&1==e.data.projectSceneList.length&&(r.scenesData=e.data.projectSceneList[0])})),i.then((function(e){if(e.data&&Array.isArray(e.data.onlineResourcesList)){let t=e.data.onlineResourcesList;r.onlineResourcesList=t;let a={};for(let e=0;e<t.length;e++)a[t[e].res_id]=t[e];r.userOnlineResDict=a}})),s.then((function(e){if(e.data&&Array.isArray(e.data.resourcesList)){let t=e.data.resourcesList;r.resourcesList=t;let a={};for(let e=0;e<t.length;e++)a[t[e].res_id]=t[e];r.userProjResDict=a}})),l.then((function(e){if(console.log(" _pUM_: ",e),e.data&&Array.isArray(e.data.materials)){let t=e.data.materials;r.materials=t;let a={};for(let e=0;e<t.length;e++)a[t[e].id]=t[e];r.userMaterialDict=a}})),Promise.all(o).then((function(e){window.startSceneController()}))}else console.warn(" _startInitProjAndScene_: VC error ",e)}}(e)},window.startSceneController=function(){console.log(" _startSceneController_  start"),new Promise((function(e){let t=document.createElement("div");t.style.position="absolute",t.setAttribute("id","arDiv"),t.style.top="0px",t.style.width=document.documentElement.clientWidth+"px",t.style.height=Math.round(document.documentElement.clientHeight-0)+"px",document.body.appendChild(t);let a=document.createElement("a-scene");a.setAttribute("id","arfScene"),a.setAttribute("embedded",""),a.setAttribute("renderer","logarithmicDepthBuffer: true; physicallyCorrectLights: false; "),a.setAttribute("vr-mode-ui","enabled: false"),t.appendChild(a);let r=document.createElement("a-light");r.setAttribute("id","ambientLight"),r.setAttribute("type","ambient"),r.setAttribute("color","#808080"),r.setAttribute("ground-color","#fff"),r.setAttribute("intensity",1),a.appendChild(r);let o=document.createElement("a-entity");o.setAttribute("id","oCamera"),o.setAttribute("crossorigin","anonymous"),o.setAttribute("camera",{active:!0,fov:80}),o.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\tmaxPolarAngle: 180; \n\t\t\tminDistance: 0.1; \n\t\t\tmaxDistance: 1000; \n\t\t\tinitialPosition: 0 60 -300;"),a.appendChild(o);let n=document.createElement("a-entity");n.setAttribute("id","cameraForGyro"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("camera",{active:!1}),n.setAttribute("look-controls",{enabled:!0,touchEnabled:!1}),a.appendChild(n);let i=document.createElement("a-assets");i.setAttribute("id","makarAssets"),i.setAttribute("timeout","1000"),i.setAttribute("crossorigin","anonymous"),a.appendChild(i),a.hasLoaded?e():a.addEventListener("loaded",(function(){e()}))})).then((function(){let e=document.getElementById("arfScene"),t=window.makarUserData,a=[];if(c.F.checkSceneIncludeAR(t.scenesData)){let e=new Promise((function(e){console.log(" _startInitProjAndScene_ with AR: load scripts ");let a=setInterval((function(){if(window.ARController){clearInterval(a),console.log(" _startInitProjAndScene_ with AR: ARController load done");let r=new Z(t);window.arWrapper=r,e(r)}else console.log(" _startInitProjAndScene_ with AR: ARController load not done")}),500)}));a.push(e)}Promise.all(a).then((function(a){console.log(" _pControllerLoaded_ ",a);let r,o=!1,n=[],i=new u(e.renderer);for(let e=0;e<a.length;e++){let t=a[e];if(0==o&&"ARWrapper"==t.type){o=!0,r=t,i.includeAR(r);let e=r.initARProcess();n.push(e)}}Promise.all(n).then((function(e){let a=c.F.getScenes(t.scenesData);a[0]&&"ar"==a[0].info.type&&(i.setControllerType("AR"),r.arController.enableARRendering=!0,r.startAR())}))}))})),delete window.startSceneController}}}]);