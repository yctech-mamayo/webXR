"use strict";(self.webpackChunkmifly_ar=self.webpackChunkmifly_ar||[]).push([[572],{572:(e,t,r)=>{r.r(t);var a=r(634),o=r(406);const n=class{constructor(e){let t=this;t.GLRenderer=e,t.ARC=null,t.VRC=null,t.XRC=null,t.currentSceneController=null,t.currentSceneType="",t.mouse=new THREE.Vector2;let r=e.domElement;r.addEventListener("touchend",t.endEvent.bind(t),!1),r.addEventListener("mouseup",t.endEvent.bind(t),!1),r.addEventListener("touchmove",t.moveEvent.bind(t),!1),r.addEventListener("mousemove",t.moveEvent.bind(t),!1),r.addEventListener("touchstart",t.startEvent.bind(t),!1),r.addEventListener("mousedown",t.startEvent.bind(t),!1)}includeAR(e){this.ARC=e}includeVR(e){this.VRC=e}includeXR(e){this.XRC=e}setControllerType(e){let t=this;switch(t.currentSceneType=e,e){case"AR":t.ARC?t.currentSceneController=t.ARC:console.warn("_setControllerType_: this project do not contain AR.");break;case"VR":t.VRC?t.currentSceneController=t.VRC:console.warn("_setControllerType_: this project do not contain VR.");break;case"XR":t.XRC?t.currentSceneController=t.XRC:console.warn("_setControllerType_: this project do not contain XR.");break;default:console.warn("_setControllerType_: type unknow",e)}}endEvent(e){e.preventDefault();let t=this;switch(t.currentSceneType){case"AR":t.ARC.arController.clickEndEvent&&t.ARC.arController.clickEndEvent(e);break;case"VR":t.VRC.clickEndEvent&&t.VRC.clickEndEvent(e);break;case"XR":t.XRC.clickEndEvent&&t.XRC.clickEndEvent(e)}}moveEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickMoveEvent&&t.ARC.arController.clickMoveEvent(e);break;case"VR":t.VRC.clickMoveEvent&&t.VRC.clickMoveEvent(e);break;case"XR":t.XRC.clickMoveEvent&&t.XRC.clickMoveEvent(e)}}startEvent(e){let t=this;switch(e.preventDefault(),t.currentSceneType){case"AR":t.ARC.arController.clickStartEvent&&t.ARC.arController.clickStartEvent(e);break;case"VR":t.VRC.clickStartEvent&&t.VRC.clickStartEvent(e);break;case"XR":t.XRC.clickStartEvent&&t.XRC.clickStartEvent(e)}}};async function i(e){let t=await fetch(e,{method:"HEAD"});return console.log(" _UrlExistsFetch: ret ",t),!!t.status&&"200"==t.status}function l(e){return"object"==typeof e&&"function"==typeof e.then}function s(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image",e.sub_type="png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image",e.sub_type="png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image",e.sub_type="png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image",e.sub_type="png";break;case"Cube":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb",e.main_type="model",e.sub_type="glb";break;case"Capsule":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb",e.main_type="model",e.sub_type="glb";break;case"Sphere":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Bojue":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Fei":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Lina":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Poyuan":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb",e.main_type="model",e.sub_type="glb";break;case"ch_Roger":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb",e.main_type="model",e.sub_type="glb";break;default:if(e.res_gltf_resource)break;e.generalAttr?e.generalAttr.obj_type||(e.generalAttr.obj_type="3d"):e.generalAttr={obj_type:"3d"},e.transformAttr?e.transformAttr.transform||(e.transformAttr.transform=["0,0,0","0,0,0,1","1,1,1"]):e.transformAttr={transform:["0,0,0","0,0,0,1","1,1,1"]},e.main_type="model",e.sub_type="glb",e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb"}}function c(e,t,r,a,o){let n=e.object3D;if(n){e.setAttribute("position",t),e.setAttribute("scale",a);let r=new THREE.Euler;r.setFromQuaternion(o),r.x=-r.x,r.y=-r.y;let i=new THREE.Quaternion;i.setFromEuler(r),n.setRotationFromQuaternion(i)}}function d(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("VRFunc.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("VRFunc.js: _checkGLTFMaterialIndex: material error",t);let r=t.rendererIndex,a=t.materialIndex,o=-1,n=-1,i=e.object3D.children[0].ModelJson.nodes,l=-1;for(let e=0;e<i.length;e++)if("number"==typeof i[e].mesh&&l++,r==l){o=i[e].mesh;break}if(o>=0){let t=e.object3D.children[0].ModelJson.meshes[o];if(t&&t.primitives){let e=t.primitives[a];e&&e.material>=0&&(n=e.material,console.log("VRFunc.js: _checkGLTFMaterialIndex: materialIndex=",n))}}return n}function u(e,t,r,a){let o=e.getObject3D("mesh"),n=-1;t.materialAttr&&t.materialAttr.materials;for(let l=0;l<t.materialAttr.materials.length;l++){o.ModelJson&&(n=d(e,t.materialAttr.materials[l]));let s=t.materialAttr.materials[l].color.split(","),c=new THREE.Color(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2]));switch(o.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),t.materialAttr.materials[l].shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:c,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":var i=e.sceneEl.renderer;o.traverse((e=>{if(e.material){let a=e.material.name.split("_");a[a.length-1]==n&&(e.material=new THREE.MeshStandardMaterial({name:e.material.name,skinning:e.material.skinning,map:e.material.map,emissive:e.material.emissive,emissiveMap:e.material.emissiveMap,normalMap:e.material.normalMap}),e.material.color=c,e.material.metalness=t.materialAttr.materials[l].metallic,e.material.roughness=1-t.materialAttr.materials[l].smoothness,e.material.envMap=r.texture,e.material.envMapIntensity=1,e.material.needsUpdate=!0,e.material.reflectivity=0,e.material.side=THREE.DoubleSide,e.material.transparent=!0,e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),0==t.materialAttr.materials[l].mode?(e.material.opacity=1,i.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor):1==t.materialAttr.materials[l].mode?(e.material.opacity=1,e.material.alphaTest=t.materialAttr.materials[l].cut_off,i.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.materialAttr.materials[l].cut_off})):2==t.materialAttr.materials[l].mode?(e.material.opacity=parseFloat(s[3]),e.material.depthWrite=!1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.materialAttr.materials[l].cut_off})):3==t.materialAttr.materials[l].mode&&(e.material.opacity=Math.max(parseFloat(s[3]),t.materialAttr.materials[l].metallic),e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.materialAttr.materials[l].cut_off})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.depthWrite=!1)}}));break;case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0,console.log(e.material.map)),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.onBeforeCompile=function(e){e.uniforms.tEquirect={value:a},e.vertexShader="varying vec4 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = -vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1)}}));break;case"Blocks/BlocksGlass":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==n&&(e.material.depthWrite=!1)}}));break;default:console.log(`The shader of no. ${l} material is not supported currently.`)}}}function b(e,t,r,o,n,l,s){let d=e,p=a.o.getProjDataEditorVer(e.currentProjData),m=e.cubeTex,h=e.cameraTexture;return new Promise((function(a){i(r.res_url).then((i=>{if(1==i){if(console.log(" __loadGLTFModel__:  ",r),""==r.res_url||"glb"!=r.sub_type&&"gltf"!=r.sub_type&&"gltf_sketchFab"!=r.sub_type&&"gltf_sketchfab"!=r.sub_type&&"gltf_poly"!=r.sub_type)return console.log(" _loadGLTFModel_: obj not support ",r),void a(-1);let e=d.gcssTargets.dpi[t.GCSSID],n=d.gcssTargets.width[t.GCSSID],i=d.gcssTargets.height[t.GCSSID],b=d.sceneTargetList[t.GCSSID].sceneIndex,g=document.createElement("a-entity"),f=document.getElementById("makarAssets"),_=document.createElement("a-asset-item");if(_.setAttribute("id",r.generalAttr.obj_id+"_"+r.res_id),_.setAttribute("src",r.res_url),_.setAttribute("response-type","arraybuffer"),_.setAttribute("crossorigin","anonymous"),f.appendChild(_),!r.res_url)return;g.setAttribute("gltf-model","#"+r.generalAttr.obj_id+"_"+r.res_id);let j,v=null;if(p&&3==p.v0&&p.v1>=5){if(g.setAttribute("id",r.generalAttr.obj_id),r.animationAttr){v=[];for(let e=0;e<r.animationAttr.length;e++)(r.animationAttr[e].is_default||r.animationAttr[e].is_active)&&(v.push({idle:r.animationAttr[e].uid,loop:r.animationAttr[e].uid,uid:r.animationAttr[e].uid,changed:!1,reset:!0,count:0}),j=r.animationAttr[e].animation_name);for(let e=0;e<r.animationAttr.length;e++)v.push({name:r.animationAttr[e].name,animationName:r.animationAttr[e].animation_name,startTime:r.animationAttr[e].start_time,endTime:r.animationAttr[e].end_time,uid:r.animationAttr[e].uid});g.setAttribute("animation-mixer","clip: "+j)}r.behav?g.setAttribute("class","clickable"):g.setAttribute("class","unclickable")}if(g.setAttribute("crossorigin","anonymous"),g.setAttribute("shadow",""),r.model_shift){let e=(new THREE.Vector3).fromArray(r.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(l),o.add(e)}if(d.makarObjects.push(g),g.addEventListener("model-loaded",(function(t){if(t.target==t.currentTarget){let f=d.arfScene.renderer.capabilities.getMaxAnisotropy();g.object3D.children[0].scale.set(2540/e,2540/e,2540/e),g.object3D.children[0].rotation.y=Math.PI;let _=new THREE.Vector3;if(r.obj_parent_id){g.object3D.obj_parent_id=r.obj_parent_id,_.addScaledVector(o,2540/e);let t=_.z;_.z=-t,c(g,_,0,l,s)}else{switch(window.serverVersion){case"2.0.0":l.multiplyScalar(1),_.addScaledVector(o,2540/e);break;case"3.0.0":l.multiplyScalar(2),_.addScaledVector(o,5080/e);break;default:console.log(" _loadGLTFModel_: serverVersion version wrong",serverVersion)}let t=_.y,r=_.z;_.y=r,_.z=t,c(g,_,0,l,s),g.object3D.position.add(new THREE.Vector3(25.4*n/e/2,25.4*i/e/2,0)),g.object3D.rotation.x+=90*Math.PI/180,console.log("_loadGLTFModel_: loaded: no parent prs=",g.object3D.position,g.object3D.rotation,g.object3D.scale)}let j=g.object3D;j.originTransform={position:j.position.clone(),rotation:j.rotation.clone(),scale:j.scale.clone()},p&&3==p.v0&&p.v1>=5&&r.generalAttr&&1==r.generalAttr.logic&&(j.resetProperty=function(){u(g,r,m,h)}),g.object3D.makarType="model",g.object3D.makarObject=!0,r.behav&&(g.object3D.behav=r.behav,d.setObjectBehavAll(r,b)),r.behav_reference&&(g.object3D.behav_reference=r.behav_reference),t.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=f,e.material.map.needsUpdate=!0)})),g.object3D&&(p&&3==p.v0&&p.v1>=5&&r.generalAttr&&1==r.generalAttr.logic&&(j.resetProperty=function(){u(g,r,m,h)}),Array.isArray(t.detail.model.animations)&&t.detail.model.animations.length>0&&!g.getAttribute("animation-mixer")&&(console.log("_loadGLTFModel_: the model with animation but no animation-mixer, probabily older version of editor "),g.setAttribute("animation-mixer","clip: "+t.detail.model.animations[0].name),v=[],v.push({changed:!1,idle:"mifly168",uid:"mifly168"}),v.push({animationName:t.detail.model.animations[0].name,name:t.detail.model.animations[0].name,endTime:t.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),t.detail.model.animationSlices=v,a(g))}})),0==r.active&&(g.setAttribute("visible",!1),g.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowModel"==r.behav_reference[e].behav_name){g.setAttribute("visible",!1),g.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(g),window.clearInterval(e))}),1)}else t.appendChild(g)}else console.log("_loadGLTFModel_: , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],b(e,t,r,o,n,l,s),a(1)}))}))}function p(e,t,r,o,n,l,s){let d=e,u=a.o.getProjDataEditorVer(e.currentProjData);return new Promise((function(a){i(r.res_url).then((i=>{if(1==i){let e=document.getElementById("makarAssets"),n=document.createElement("audio");n.setAttribute("src",r.res_url),n.setAttribute("crossorigin","anonymous"),n.setAttribute("loop",!0),n.setAttribute("preload","auto"),u&&3==u.v0&&u.v1>=5&&n.setAttribute("id",r.generalAttr.obj_id+"_"+r.res_id),e.appendChild(n),n.onloadedmetadata=function(){let e=document.createElement("a-entity");e.setAttribute("sound","src: #"+r.generalAttr.obj_id+"_"+r.res_id+"; autoplay: true; loop: true; volume: 1; positional: false"),e.setAttribute("id",r.generalAttr.obj_id),c(e,o,0,l,s),d.makarObjects.push(e);let n=!0;0==r.generalAttr.active&&(e.setAttribute("sound","loop: false"),e.setAttribute("visible",!1),n=!1,e.setAttribute("class","unclickable"));let i=!1;if(r.behav_reference){for(let u=0;u<r.behav_reference.length;u++)if("PlayMusic"==r.behav_reference[u].behav_name){i=!0,e.setAttribute("sound","loop: false"),e.setAttribute("visible",!1),n=!1,e.setAttribute("class","unclickable"),e.setAttribute("sound","autoplay: false ");break}}else e.setAttribute("visible",!0);if(r.generalAttr.obj_parent_id){e.setAttribute("sound","autoplay: false");let b=setInterval((function(){let t=document.getElementById(r.generalAttr.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(e),window.clearInterval(b),t.addEventListener("child-attached",(function(t){if(r.generalAttr.logic)e.blockly=r.generalAttr.logic,e.setAttribute("sound","autoplay: false");else{let t=!0;e.object3D.traverseAncestors((function(r){if("Scene"!=r.type)console.log(" _loadAudio_: traverseAncestors: not Scene parent=",r),0==r.visible&&(t=!1);else if(1==t&&1==e.object3D.visible&&0==i&&1==n)if(console.log("_loadAudio_: traverseAncestors: all parent visible true=",e.components.sound),1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==r.location){e.setAttribute("sound","autoplay: false");let a=document.getElementById("clickToPlayAudio");function o(){e.components.sound.playSound(),a.style.display="none",a.removeEventListener("click",o),window.allowAudioClicked=!0}a.style.display="block",a.addEventListener("click",o)}else e.setAttribute("sound","autoplay: true");else console.log(" _loadAudio_: traverseAncestors: not all parent visible true=",e.components.sound),e.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(r.generalAttr.logic)e.blockly=r.generalAttr.logic,e.setAttribute("sound","autoplay: false");else if(console.log(" _loadAudio_: ",n,i),1==n&&0==i)if(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location){e.setAttribute("sound","autoplay: false");let p=document.getElementById("clickToPlayAudio");function m(){e.components.sound.playSound(),p.style.display="none",p.removeEventListener("click",m),window.allowAudioClicked=!0}p.style.display="block",p.addEventListener("click",m)}else e.setAttribute("sound","autoplay: true");else e.setAttribute("sound","autoplay: false");t.appendChild(e)}e.addEventListener("loaded",(function(t){t.target==t.currentTarget&&(e.object3D.makarType="audio",e.object3D.makarObject=!0,r.behav&&(e.object3D.behav=r.behav,d.setObjectBehavAll(r)),r.behav_reference&&(e.object3D.behav_reference=r.behav_reference),a(e))}))}}else console.log(" _loadAudio_ , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",b(e,t,r,o,n,l,s),a(1)})).catch((function(e){console.log("_loadAudio_: error ",e)}))}))}function m(e,t,r,o,n,l,s){let d=e,u=a.o.getProjDataEditorVer(e.currentProjData);return function(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png",e.main_type="image";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png",e.main_type="image";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png",e.main_type="image";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png",e.main_type="image";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png",e.main_type="image";break;default:console.log("image: default, obj=",e)}}(r),new Promise((function(a){i(r.res_url).then((i=>{if(1==i){let e,n,i,b,p,m=d.gcssTargets.dpi[t.GCSSID],h=d.gcssTargets.width[t.GCSSID],g=d.gcssTargets.height[t.GCSSID],f=d.sceneTargetList[t.GCSSID].sceneIndex,_=(new THREE.TextureLoader).load(r.res_url),j=r.res_url.split(".").length,v=r.res_url.split(".")[j-1].toLowerCase();if(r.sub_type=r.sub_type.toLowerCase(),"png"==r.sub_type||"jpg"==r.sub_type||"jpeg"==r.sub_type||"bmp"==r.sub_type)v=r.sub_type,e=document.createElement("a-plane"),e.setAttribute("src",r.res_url);else if("gif"==r.sub_type)v=r.sub_type,e=document.createElement("a-entity");else{if("button"!=r.sub_type)return console.log("_loadAframeTexture: sub_type empty, create empty plane "),e=document.createElement("a-plane"),void a(e);"png"!=v&&"jpg"!=v&&"jpeg"!=v&&(v="png"),e=document.createElement("a-plane"),e.setAttribute("src",r.res_url)}let y=!1;if(u&&3==u.v0&&u.v1>=5){if(e.setAttribute("id",r.generalAttr.obj_id),r.typeAttr.matting&&(y=!0,n=r.typeAttr.matting.chromakey,i=r.typeAttr.matting.slope,b=r.typeAttr.matting.threshold,p=r.typeAttr.matting),y){let t=n.split(","),a=new THREE.Color(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),o=p.HSV.split(","),l=parseFloat(o[0]),s=parseFloat(o[1]),c=parseFloat(o[2]);"jpg"==v||"jpeg"==v||"png"==v?"RGB"==p.mode?e.setAttribute("material","shader: chromaKey; color: #"+a.getHexString()+";transparent: true; _slope: "+parseFloat(i)+"; _threshold: "+parseFloat(b)+";"):"HSV"==p.mode&&e.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+l+"; _keyingColorS:"+s+"; _keyingColorV:"+c+"; _deltaH:"+parseFloat(p.hue)+"; _deltaS:"+parseFloat(p.saturation)+"; _deltaV:"+parseFloat(p.brightness)+";"):"gif"==v&&("RGB"==p.mode?(e.setAttribute("geometry","primitive: plane"),e.setAttribute("material","shader:gif_RGB;  src: url("+r.res_url+"); opacity: 1; transparent: true; depthWrite:false; color: #"+a.getHexString()+"; _slope: "+parseFloat(i)+"; _threshold: "+parseFloat(b)+";")):"HSV"==p.mode&&(e.setAttribute("geometry","primitive: plane"),e.setAttribute("material","shader:gif_HSV;  src: url("+r.res_url+"); opacity: 1; transparent: true; depthWrite:false; _keyingColorH:"+l+"; _keyingColorS:"+s+"; _keyingColorV:"+c+"; _deltaH:"+parseFloat(p.hue)+"; _deltaS:"+parseFloat(p.saturation)+"; _deltaV:"+parseFloat(p.brightness)+";")))}else"jpg"==v||"jpeg"==v||"png"==v?e.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; "):"gif"==v&&(e.setAttribute("geometry","primitive: plane"),e.setAttribute("material","shader:gif;  src: url("+r.res_url+"); opacity: 1; transparent: true;"));0==r.generalAttr.active&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"))}e.setAttribute("crossorigin","anonymous"),r.behav?0==r.behav.length&&y?e.setAttribute("class","unclickable"):e.setAttribute("class","clickable"):e.setAttribute("class","unclickable"),d.makarObjects.push(e);let A=d.arfScene.renderer.capabilities.getMaxAnisotropy();if(e.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=A,e.detail.texture.needsUpdate=!0})),e.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){let t=setInterval((function(){if(_.image&&e.object3D&&e.object3D.children&&e.object3D.children[0]&&e.object3D.children[0].scale){e.object3D.children[0].scale.set(25.4*_.image.width/m,25.4*_.image.height/m,1);let n=new THREE.Vector3;if(r.generalAttr.obj_parent_id){e.object3D.obj_parent_id=r.generalAttr.obj_parent_id,n.addScaledVector(o,2540/m);let t=n.z;n.z=-t,c(e,n,0,l,s)}else{switch(window.serverVersion){case"2.0.0":l.multiplyScalar(1),n.addScaledVector(o,2540/m);break;case"3.0.0":n.addScaledVector(o,5080/m),l.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let t=n.y,r=n.z;n.y=r,n.z=t,c(e,n,0,l,s),e.object3D.position.add(new THREE.Vector3(25.4*h/m/2,25.4*g/m/2,0)),e.object3D.rotation.x+=90*Math.PI/180}let i=e.object3D;i.originTransform={position:i.position.clone(),rotation:i.rotation.clone(),scale:i.scale.clone()},r.blockly&&(i.resetProperty=function(){}),e.setAttribute("heightForQuiz",.01*_.image.height),window.clearInterval(t),a(e)}}),1);e.object3D.makarType="image",e.object3D.makarObject=!0,r.behav&&(e.object3D.behav=r.behav,d.setObjectBehavAll(r,f)),r.behav_reference&&(e.object3D.behav_reference=r.behav_reference),"button"==r.main_type&&(e.object3D.main_type=r.main_type,e.object3D.sub_type=r.sub_type,e.setAttribute("class","clickable"),console.log("three.js: _loadAframeTexture: button ",e))}})),r.behav_reference)for(let t=0;t<r.behav_reference.length;t++)if("ShowImage"==r.behav_reference[t].behav_name){e.setAttribute("visible",!1),e.setAttribute("class","unclickable");break}if(r.generalAttr.obj_parent_id){let t=setInterval((function(){let a=document.getElementById(r.generalAttr.obj_parent_id);a&&a.object3D.children.length>0&&(a.appendChild(e),window.clearInterval(t))}),1)}else t.appendChild(e)}else console.log("ARFunc.js: _loadAframeTexture , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",b(e,t,r,o,n,l,s),a(1)}))}))}function h(e,t,r,o,n,i,l){let s=e,d=a.o.getProjDataEditorVer(e.currentProjData);return new Promise((function(e){let a=s.gcssTargets.dpi[t.GCSSID],n=s.gcssTargets.width[t.GCSSID],u=s.gcssTargets.height[t.GCSSID],b=document.createElement("a-entity");if(d&&3==d.v0&&d.v1>=5){b.setAttribute("id",r.generalAttr.obj_id);let d="type:"+r.typeAttr.light_type,p=r.typeAttr.color.split(","),m=new THREE.Color(parseFloat(p[0]),parseFloat(p[1]),parseFloat(p[2]));if(d+="; color:#"+m.getHexString(),d+=";intensity:"+r.typeAttr.intensity,"point"!=r.typeAttr.light_type&&"spot"!=r.typeAttr.light_type||(d+=";distance:"+2*r.typeAttr.range*100*25.4/a,d+=";decay: 2"),"spot"==r.typeAttr.light_type&&(d+=";angle:"+(parseFloat(r.typeAttr.spotAngle)/2).toString(),d+=";penumbra: 0.2"),r.typeAttr.shadow,b.setAttribute("light",d),"directional"==r.typeAttr.light_type&&(b.setAttribute("castShadow",!1),b.setAttribute("light","castShadow: false; ")),0==r.generalAttr.active&&b.setAttribute("visible",!1),b.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){if("directional"==r.typeAttr.light_type){b.object3D.children[0].position.set(0,0,0);let e=new THREE.Object3D;e.name="lightTarget",e.position.set(0,0,-1),b.object3D.children[0].target=e,b.object3D.add(e)}else"spot"==r.typeAttr.light_type||r.typeAttr.light_type;let t=new THREE.Vector3;if(r.generalAttr.obj_parent_id){b.object3D.obj_parent_id=r.generalAttr.obj_parent_id,t.addScaledVector(o,2540/a);let e=t.z;t.z=-e,c(b,t,0,i,l)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),t.addScaledVector(o,2540/a);break;case"3.0.0":i.multiplyScalar(2),t.addScaledVector(o,5080/a);break;default:console.log("three.js: _loadAframeLight: serverVersion version wrong",serverVersion)}let e=t.y,r=t.z;t.y=r,t.z=e,c(b,t,0,i,l),b.object3D.position.add(new THREE.Vector3(25.4*n/a/2,25.4*u/a/2,0)),b.object3D.rotation.x+=90*Math.PI/180}let d=b.object3D;d.originTransform={position:d.position.clone(),rotation:d.rotation.clone(),scale:d.scale.clone()},r.generalAttr.logic&&(d.resetProperty=function(){d.children[0].intensity=r.typeAttr.intensity,d.children[0].color.copy(m)}),b.object3D.makarType="light",b.object3D.makarObject=!0,s.makarObjects.push(b),e(b)}})),r.generalAttr.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.generalAttr.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(b),window.clearInterval(e))}),1)}else console.log("three.js: _loadAframeLight: loaded: no parent prs=",b.object3D.position,b.object3D.rotation,b.object3D.scale),t.appendChild(b)}}))}function g(e,t,r,o,n,i,l){let s=e,d=a.o.getProjDataEditorVer(e.currentProjData);return new Promise((function(e){let a,n=s.gcssTargets.dpi[t.GCSSID],u=s.gcssTargets.width[t.GCSSID],b=s.gcssTargets.height[t.GCSSID],p=document.createElement("a-entity"),m=0;d&&3==d.v0&&d.v1>=5&&p.setAttribute("id",r.generalAttr.obj_id),s.makarObjects.push(p),r.behav||"button"==r.main_type?p.setAttribute("class","clickable"):p.setAttribute("class","unclickable");let h=document.createElement("a-text");if(h.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),h.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;"),d&&3==d.v0&&d.v1>=5){let g=r.typeAttr.content.split("\n"),f=0;const _=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u,j=e=>_.test(e);for(let w=0;w<g.length;w++){let D=0;for(let T=0;T<g[w].length;T++)j(g[w][T])?D+=1.6:g[w][T]==g[w][T].toUpperCase()&&g[w][T]!=g[w][T].toLowerCase()||g[w][T]==g[w][T].toLowerCase()&&g[w][T]!=g[w][T].toUpperCase()?D+=1:isNaN(1*g[w][T])?D+=1.25:D+=1;D>f&&(f=D)}h.setAttribute("value",r.typeAttr.content),h.setAttribute("width",.08*f),h.setAttribute("wrap-count",f+1),h.setAttribute("anchor","center"),h.setAttribute("align","left"),h.setAttribute("backcolor",r.typeAttr.back_color),h.setAttribute("textcolor",r.typeAttr.color),h.setAttribute("side","double");let v="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",y=[v+"1-msdf.json",v+"2-msdf.json",v+"3-msdf.json",v+"4-msdf.json",v+"5-msdf.json",v+"6-msdf.json",v+"7-msdf.json",v+"8-msdf.json",v+"9-msdf.json",v+"10-msdf.json",v+"11-msdf.json",v+"12-msdf.json"];h.setAttribute("font",y),h.setAttribute("negate","false"),h.setAttribute("crossorigin","anonymous");let A=r.typeAttr.color.split(",");function k(t){console.log("three.js: _loadAframeText: textEntity geometry-set: evt=",t),0==m?m=1:1==m&&e(h),h.removeEventListener("geometry-set",k)}a=new THREE.Color(parseFloat(A[0]),parseFloat(A[1]),parseFloat(A[2])),h.setAttribute("color","#"+a.getHexString()),h.addEventListener("geometry-set",k)}if(p.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){console.log("three.js: _loadAframeText: anchor loaded: evt=",t),h.object3D.scale.set(2540/n,2540/n,2540/n);let d=new THREE.Vector3;if(r.generalAttr.obj_parent_id){p.object3D.obj_parent_id=r.generalAttr.obj_parent_id,d.addScaledVector(o,2540/n);let e=d.z;d.z=-e,c(p,d,0,i,l)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),d.addScaledVector(o,2540/n);break;case"3.0.0":i.multiplyScalar(2),d.addScaledVector(o,5080/n);break;default:console.log("three.js: _loadAframeText: serverVersion version wrong",serverVersion)}let e=d.y,t=d.z;d.y=t,d.z=e,c(p,d,0,i,l),p.object3D.position.add(new THREE.Vector3(25.4*u/n/2,25.4*b/n/2,0)),p.object3D.rotation.x+=90*Math.PI/180,console.log(" +++++++++ set done",p.object3D.position,p.object3D.rotation,p.object3D.scale)}let g=p.object3D;g.originTransform={position:g.position.clone(),rotation:g.rotation.clone(),scale:g.scale.clone(),textContent:r.typeAttr.content,textColor:a,textBackColor:r.typeAttr.back_color},r.generalAttr.logic&&(g.resetProperty=function(){h.getAttribute("value")!=r.typeAttr.content||h.components.text.attrValue.color!="#"+a.getHexString()||h.components.text.attrValue.backcolor!=r.typeAttr.back_color?(console.log("three.js: _loadAframeText: do reset"),h.components.text.textMesh.children.length=0,h.object3D.children.length=1,h.setAttribute("value",r.typeAttr.content),h.setAttribute("color","#"+a.getHexString()),h.setAttribute("backcolor",r.typeAttr.back_color)):console.log("three.js: _loadAframeText: text same, reset do nothing ")}),p.object3D.makarObject=!0,p.object3D.makarType="text",r.behav&&(p.object3D.behav=r.behav,s.setObjectBehavAll(r)),r.behav_reference&&(p.object3D.behav_reference=r.behav_reference),"button"==r.main_type&&(p.object3D.main_type=r.main_type),0==m?m=1:1==m&&e(h)}})),p.appendChild(h),0==r.generalAttr.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable")),r.behav_reference)for(let S=0;S<r.behav_reference.length;S++)if("ShowText"==r.behav_reference[S].behav_name){p.setAttribute("visible",!1),p.setAttribute("class","unclickable");break}if(r.generalAttr.obj_parent_id){let E=setInterval((function(){let e=document.getElementById(r.generalAttr.obj_parent_id);e&&e.object3D.children.length>0&&(e.appendChild(p),window.clearInterval(E))}),1)}else t.appendChild(p)}))}function f(e,t,r,o,n,i,l){let s=e,c=a.o.getProjDataEditorVer(e.currentProjData);return new Promise((function(a){s.UrlExistsFetch(r.res_url).then((d=>{if(1==d){let e=s.gcssTargets.dpi[t.GCSSID],d=s.gcssTargets.width[t.GCSSID],b=s.gcssTargets.height[t.GCSSID],p=(s.sceneTargetList[t.GCSSID].projIndex,document.getElementById("makarAssets"));var u;(u=document.createElement("video")).src=r.res_url,u.playsInline=!0,u.autoplay=!1,u.loop=!0,u.setAttribute("crossorigin","anonymous"),u.setAttribute("id",r.generalAttr.obj_id+"_"+r.res_id),p.appendChild(u),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(u.muted=!0),u.onloadedmetadata=function(){var p,m;u.videoWidth>=u.videoHeight?(p=1,m=1*u.videoHeight/u.videoWidth):(p=1*u.videoWidth/u.videoHeight,m=1);let h=document.createElement("a-video");if(c&&3==c.v0&&c.v1>=5){let e,t,a,o,n=!1;if(r.typeAttr.matting&&(n=!0,e=r.typeAttr.matting.chromakey,t=r.typeAttr.matting.slope,a=r.typeAttr.matting.threshold,o=r.typeAttr.matting),n){let r=e.split(",");var g=new THREE.Color(parseFloat(r[0]),parseFloat(r[1]),parseFloat(r[2]));let n=o.HSV.split(","),i=parseFloat(n[0]),l=parseFloat(n[1]),s=parseFloat(n[2]);"RGB"==o.mode?h.setAttribute("material","shader: chromaKey; color: #"+g.getHexString()+";transparent: true; _slope: "+parseFloat(t)+"; _threshold: "+parseFloat(a)+";"):"HSV"==o.mode&&h.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+i+"; _keyingColorS:"+l+"; _keyingColorV:"+s+"; _deltaH:"+o.hue+"; _deltaS:"+o.saturation+"; _deltaV:"+o.brightness+";")}else h.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");h.setAttribute("id",r.generalAttr.obj_id),h.setAttribute("src","#"+r.generalAttr.obj_id+"_"+r.res_id),0==r.generalAttr.active&&(h.setAttribute("visible",!1),h.setAttribute("class","unclickable"))}r.behav?0==r.behav.length&&transparentVideo?h.setAttribute("class","unclickable"):h.setAttribute("class","clickable"):h.setAttribute("class","unclickable"),h.mp4Video=u;let f=s.arfScene.renderer.capabilities.getMaxAnisotropy();h.addEventListener("materialtextureloaded",(function(e){console.log("three.js: _loadVideo: _materialtextureloaded: videoPlane = ",h.object3D,e),e.detail.texture.anisotropy=f,e.detail.texture.needsUpdate=!0})),h.addEventListener("loaded",(function(t){if(t.target==t.currentTarget){console.log("three.js: videoPlane.loaded: vw vh = ",p,m,t),h.object3D.children[0].scale.set(100*p*25.4/e,100*m*25.4/e,1);let c=new THREE.Vector3;if(r.generalAttr.obj_parent_id){h.object3D.obj_parent_id=r.generalAttr.obj_parent_id,c.addScaledVector(o,2540/e);let t=c.z;c.z=-t,s.setAframeTransform(h,c,n,i,l)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),c.addScaledVector(o,2540/e);break;case"3.0.0":i.multiplyScalar(2),c.addScaledVector(o,5080/e);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let t=c.y,r=c.z;c.y=r,c.z=t,s.setAframeTransform(h,c,n,i,l),h.object3D.position.add(new THREE.Vector3(25.4*d/e/2,25.4*b/e/2,0)),h.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeVideo: loaded: no parent prs=",h.object3D.position,h.object3D.rotation,h.object3D.scale)}let g=h.object3D;g.originTransform={position:g.position.clone(),rotation:g.rotation.clone(),scale:g.scale.clone()},r.generalAttr&&r.generalAttr.logic&&(g.resetProperty=function(){u.pause()}),h.object3D.makarType="video",h.object3D.makarObject=!0,r.behav&&(h.object3D.behav=r.behav,s.setObjectBehavAll(r)),r.behav_reference&&(h.object3D.behav_reference=r.behav_reference),a(h)}})),s.makarObjects.push(h);let v=!1;if(r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowVideo"==r.behav_reference[e].behav_name){v=!0,h.setAttribute("visible",!1),h.setAttribute("class","unclickable"),u.muted=!1;break}if(r.generalAttr.obj_parent_id){u.autoplay=!1;let e=setInterval((function(){let t=document.getElementById(r.generalAttr.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(h),window.clearInterval(e),t.addEventListener("child-attached",(function(e){if(console.log("three.js: arController: _loadVideo,: parent child-attached, el=",e),c&&3==c.v0&&c.v1>=5)if(r.generalAttr.logic)h.blockly=r.generalAttr.logic,u.pause(),u.currentTime=0;else{let e=!0;h.object3D.traverseAncestors((function(t){"Scene"!=t.type?0==t.visible&&(e=!1):1==e&&1==h.object3D.visible&&0==v?(u.autoplay=!0,u.play(),_(r,u,v,c),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==t.location)&&j()):(console.log("three.js: arController: _loadVideo,: traverseAncestors: not all parent visible true=",h.object3D),u.muted=!1,u.autoplay=!1,u.pause(),u.currentTime=0)}))}})))}),1)}else c&&3==c.v0&&c.v1>=5&&(r.generalAttr.logic?(h.blockly=r.generalAttr.logic,u.pause(),u.currentTime=0,u.muted=!1):(u.autoplay=!0,u.play(),_(r,u,v,c),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&j())),t.appendChild(h)}}else console.log("ARFunc.js: _loadAframeVideo , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",b(e,t,r,o,n,i,l),a(1)}))}))}function _(e,t,r,a){a&&3==a.v0&&a.v1>=5&&((0==e.generalAttr.active||r)&&(t.autoplay=!1,t.pause(),t.currentTime=0),e.typeAttr&&(null!=e.typeAttr.is_play&&(t.autoplay=e.typeAttr.is_play,0==e.typeAttr.is_play&&(t.pause(),t.currentTime=0)),null!=e.typeAttr.is_play&&(t.loop=e.typeAttr.is_loop),null!=e.typeAttr.volune&&(t.volume=e.typeAttr.volune)))}function j(e){let t=document.getElementById("clickToPlayAudio");t.style.display="block",t.onclick=function(){!function(e){let t,r=document.getElementsByTagName("a-video");if(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length),t)for(let e=0;e<r.length;e++){let a=r[e],o=r[e].mp4Video;if(a==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play();else{let r=!0;a.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,a.object3D.visible,a),1==r&&1==a.object3D.visible&&(o.muted=!0,o.autoplay=!0,o.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else{let e=!1;for(let t=0;t<r.length;t++){let a=r[t],o=r[t].mp4Video,n=!0;a.object3D.traverseAncestors((function(r){"Scene"!=r.type?0==r.visible&&(n=!1):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: videoPlane =",t,n,a.object3D.visible,a),1!=n||1!=a.object3D.visible||a.blockly||(0==e?(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",a.object3D),o.muted=!1,o.autoplay=!0,o.play(),e=!0):(console.log("VRFunc.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",a.object3D),o.muted=!0,o.autoplay=!0,o.play())))}))}}}(),t.style.display="none",t.onclick=null,window.allowAudioClicked=!0}}const v=class{constructor(e){this.type="ARWrapper",e.oneProjData&&(this.currentProjData=e.oneProjData),e.scenesData&&(this.scenesData=e.scenesData),e.scenesData&&e.oneProjData&&"ar0_new"==e.oneProjData.proj_name&&(this.scenesData.scenes[0]&&Array.isArray(this.scenesData.scenes[0].behav)&&"ar1"==this.scenesData.scenes[0].info.name&&(this.scenesData.scenes[0].behav=[{trigger_type:"Click",trigger_obj_id:"fd1759b1-2ebe-4b23-8ae6-28b0e703fec6",behav_type:"Scenes",scene_id:"683504db-0ebe-4ed9-8b84-1f7ae4734d3d"},{trigger_type:"Click",trigger_obj_id:"fe848e17-3ac1-4da5-807c-8e348389167c",behav_type:"Scenes",scene_id:"683504db-0ebe-4ed9-8b84-1f7ae4734d3d"}]),this.scenesData.scenes[1]&&Array.isArray(this.scenesData.scenes[1].behav)&&"ar2"==this.scenesData.scenes[1].info.name&&(this.scenesData.scenes[1].behav=[{trigger_type:"Click",trigger_obj_id:"ab999aa6-aeb1-4a73-a8bd-2031850edc3e",behav_type:"Scenes",scene_id:"70822be4-be14-4749-952d-8410096831b9"},{trigger_type:"Click",trigger_obj_id:"78ec05b0-722d-4d16-abfb-894e86b42067",behav_type:"Scenes",scene_id:"70822be4-be14-4749-952d-8410096831b9"}])),e.targetList&&(this.targetList=e.targetList),e.userOnlineResDict&&(this.userOnlineResDict=e.userOnlineResDict),e.userProjResDict&&(this.userProjResDict=e.userProjResDict);let t=this;window.ARController&&window.THREE&&(ARController.getUserMediaThreeScene=function(e){let t={};for(let r in e)t[r]=e[r];let r=e.onSuccess;return t.onSuccess=function(e,t){let a=e.createThreeScene();r(a,e,t)},this.getUserMediaARController(t)},ARController.prototype.createThreeScene=function(e){e=e||this.image,this.setupThree();var t=new THREE.VideoTexture(e);t.minFilter=THREE.LinearFilter,t.flipY=!1,this.cameraTexture=t;var r=new THREE.Mesh(new THREE.PlaneGeometry(t.image.videoWidth,t.image.videoHeight),new THREE.MeshBasicMaterial({map:t,side:THREE.BackSide}));r.material.depthTest=!1,r.material.depthWrite=!1,r.position.set(0,0,-1);var a=new THREE.OrthographicCamera(-t.image.videoWidth/2,t.image.videoWidth/2,-t.image.videoHeight/2,t.image.videoHeight/2,-100,2e4);let o,n,i=document.getElementById("arfScene"),l=t.image.videoWidth,s=t.image.videoHeight;window.innerWidth/window.innerHeight>l/s?(o=window.innerWidth,n=window.innerWidth/l*s):(o=window.innerHeight/s*l,n=window.innerHeight);var c=new THREE.OrthographicCamera(-o/2,o/2,-n/2,n/2,-100,2e4),d=new THREE.Scene;d.name="videoScene",d.add(r),d.add(a);var u=new THREE.Scene;u.name="scene2D";var b=new THREE.Scene,p=new THREE.PerspectiveCamera(45,1.33333,1,2e4);if(p.projectionMatrix.fromArray(this.getCameraMatrix()),p.rotation.set(0,180*Math.PI/180,180*Math.PI/180),p.projectionMatrix.elements[5]=-p.projectionMatrix.elements[5],p.projectionMatrix.elements[8]=-p.projectionMatrix.elements[8],p.projectionMatrix.elements[9]=-p.projectionMatrix.elements[9],p.projectionMatrix.elements[10]=-p.projectionMatrix.elements[10],p.projectionMatrix.elements[11]=-p.projectionMatrix.elements[11],p.projectionMatrixInverse.getInverse)p.projectionMatrixInverse.getInverse(p.projectionMatrix);else{let e=p.projectionMatrix.clone();p.projectionMatrixInverse.copy(e.invert())}let m=p.clone(),h=document.getElementById("oCamera"),g=new THREE.PerspectiveCamera(60,o/n,.3,1e4),f=h.getObject3D("camera").position.clone();g.position.copy(f);let _={aspect:o/n,near:.3,far:1e4,fov:60};h.setObject3D("camera",g),h.setAttribute("camera",_),h.components.camera.camera=g,h.components["orbit-controls"].controls.object=g;var j=new THREE.PerspectiveCamera(45,1.33333,1,2e4);j.projectionMatrix.fromArray(this.getCameraMatrix()),this.orientation,this.camera=p,this.aCamera=p,this.oCamera=h,this.oCamera3D=g,this.bkCamera=m,this.CSScamera=j,this.videoCamera=a,this.videoScene=d,this.scene2D=u,this.camera2D=c,this.videoStreamPlane=r,this.enableTracking=!0,this.enableARRendering=!1;var v=new THREE.Clock;this.clock=v,this.cssScene=b;var y=this;return{videoScene:d,scene2D:u,cssScene:b,camera:p,CSScamera:j,videoCamera:a,camera2D:c,arController:this,video:e,clock:v,process:function(){for(var t in y.aframeNFTMarkers)y.aframeNFTMarkers[t].object3D.visible=!1;y.process(e)},renderOn:function(e){t.needsUpdate=!0,e.autoClear=!1,y.arScene.video.paused||e.render(this.videoScene,this.videoCamera),e.clearDepth(),e.render(i.object3D,arController.camera),e.render(this.scene2D,this.camera2D)}}},ARController.prototype.createAframeNFTMarker=function(e){this.setupThree();let t=document.createElement("a-entity"),r=this;if(console.log(" _createAframeNFTMarker_: ",e),r.sceneTargetList&&r.sceneTargetList[e]){let o=r.sceneTargetList[e].target_id;t.setAttribute("id",o),t.GCSSID=e;let n=r.sceneTargetList[e].sceneIndex,i=a.o.getScenes(r.scenesData);if(Array.isArray(i)&&i[n]){let e=i[n];t.makarSceneName=e.info.name,t.makarSceneIndex=n,t.makarSceneID=e.info.id,t.setAttribute("visible",!1),t.loadedObjects=!1,t.showObjects=!0,t.addEventListener("loaded",(function(){t.object3D.matrixAutoUpdate=!1,t.object3D.targetRoot=!0,t.object3D.makarSceneName=e.info.name,t.object3D.makarSceneIndex=n,t.object3D.makarSceneID=e.info.id})),r.aframeNFTMarkers[n]?console.log(" _createAframeNFTMarker_: this scene entity is already loaded ",n,e):(console.log(" _createAframeNFTMarker_: load this scene entity ",n,e),r.arfScene.appendChild(t),r.aframeNFTMarkers[n]=t)}}return t},ARController.prototype.createThreeNFTMarker2D=function(e){this.setupThree();let t=this;var r=new THREE.Object3D;if(r.visible=!1,t.sceneTargetList&&t.sceneTargetList[e]){let o=t.sceneTargetList[e].sceneIndex;r.GCSSID=e,r.loadedObjects=!1,r.matrixAutoUpdate=!1;let n=a.o.getScenes(t.scenesData);if(Array.isArray(n)&&n[o]){let e=n[o];r.makarSceneName=e.info.name,r.makarSceneIndex=o,r.makarSceneID=e.info.id,t.threeNFTMarkers2D[o]?console.log(" _createThreeNFTMarker2D_: this scene entity is already loaded ",o,e):(console.log(" _createThreeNFTMarker2D_: load this scene entity ",o,e),t.arScene.scene2D.add(r),t.threeNFTMarkers2D[o]=r)}}return r},ARController.prototype.setupThree=function(){if(this.THREE_JS_ENABLED)return;this.THREE_JS_ENABLED=!0;let e=this;this.currentSceneIndex=null,this.currentTargetIndex=null,this.projStartTimeList=[],this.userStartTime=(new Date).getTime(),this.currentViewMode=null,this.aframeNFTMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={},this.threeNFTMarkers2D={},this.threeNFTMarkersCSS={},this.currentProjectIndex=null,this.objectControlState=null,this.quizModule=[],this.logicList=[],this.controlObject=null,this.currentControllObject=null,this.makarObjects=[],this.makarObjects2D=[],this.sceneTargetList=null,this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.groupEventTargetDict={},this.lookAtTargetDict={},this.lookAtObjectList=[],this.lookAtTargetTimelineDict={},this.gcssTargets={a:123},this.addEventListener("loadNFTDone",(function(t){e.gcssTargets=t.data})),this.addEventListener("getFrameTarget",(function(r){if(console.log("three.js, listened getFrameTarget, ev=",r),r.data.index<0){if(console.log("three.js: listened getFrameTarget index < 0, return ",this.threeNFTMarkers2D[-3]),this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name){this.threeNFTMarkers2D[-3].visible=!0;let e=this;setTimeout((function(){e.threeNFTMarkers2D[-3].visible=!1}),2e3)}}else{this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name&&(this.threeNFTMarkers2D[-3].visible=!1);var a=r.data.uArray,o=new ImageData(a,256,256);this.targetCtx.putImageData(o,0,0);let n=this.aframeNFTMarkers[e.sceneTargetList[r.data.index].sceneIndex],i=this.threeNFTMarkers2D[e.sceneTargetList[r.data.index].sceneIndex];console.log("artk.three.js, listened getFrameTarget, obj=",n,"\nobj2D=",i),console.log(" ************* ",r.data.index,e.sceneTargetList[r.data.index]),n.coloringStatus=1,n.loadModel=!0;let l=e.sceneTargetList[r.data.index].sceneIndex;t.loadMakarARScene(l,n,i)}})),this.checkColoring=function(t,r,a,o){if(e.sceneTargetList[t].sceneIndex,e.sceneTargetList[t].modules.includes("coloring")){if(1!=r.loadModel){if(1==o){for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=0,r.object3D.children[e].material.color.g=1);for(let e in a.children)"colorButton"==a.children[e].name&&(a.children[e].material.opacity=1,a.children[e].behav[0].enable=!0)}else{for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=1,r.object3D.children[e].material.color.g=0);for(let e in a.children)"colorButton"==a.children[e].name&&(a.children[e].material.opacity=.3,a.children[e].behav[0].enable=!1)}return 0}return 1}return-1},this.addEventListener("getNFTMarkerDraw",(function(r){let a=r.data.marker,o=this.aframeNFTMarkers[e.sceneTargetList[a.id].sceneIndex],n=this.threeNFTMarkers2D[e.sceneTargetList[a.id].sceneIndex];if(o){if(!o.loadedObjects||!n.loadedObjects){o.loadedObjects=n.loadedObjects=!0;let s=document.getElementById("clickToPlayAudio");if(s.style.display="none",s.onclick=null,Array.isArray(e.currentProjData.loc)&&e.currentProjData.loc.length>0){function c(e,t,r,a,o="M"){if(e==r&&t==a)return 0;{let n=Math.PI*e/180,i=Math.PI*r/180,l=n-i,s=Math.PI*t/180-Math.PI*a/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(l/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2)));return"M"==o&&(c*=6378137),console.log("three.js: _calculateGeosToDistanceHaversine dist=",c),c}}if(warnButtonTitle.textContent=worldContent.comfirm[languageType],warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none",o.loadedObjects=n.loadedObjects=!1},navigator.geolocation){function d(r){console.log("three.js: showProjectInfo: get Geolocation geoPosition=.",r.coords.latitude,r.coords.longitude);let i=c(r.coords.latitude,r.coords.longitude,e.currentProjData.loc[0],e.currentProjData.loc[1]);getViewerConfig(serverUrl,(function(r){if(i<r.data.gps_range_distance){let r=e.sceneTargetList[a.id].sceneIndex,i=t.loadMakarARScene(r,o,n),s=e.parseLogicXMLBySceneIndex(r);l(s)&&i.push(s)}else console.log("three.js: showProjectInfo: get Geolocation distance not allow",i),warnModal.style.display="block",warnModalInfo.textContent=worldContent.GPSDistanceMsg[languageType]+Math.floor(i)+" meter"}))}function u(e){console.log("three.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),warnModal.style.display="block",warnModalInfo.textContent=worldContent.GPSErrorMsg[languageType]+"\r\n"+e.message}navigator.geolocation.getCurrentPosition(d,u,{enableHighAccuracy:!1,timeout:5e3,maximumAge:0})}else console.log("three.js: showProjectInfo: Geolocation is not supported by this browser."),warnModal.style.display="block",warnModalInfo.textContent=worldContent.GPSnotSupportMsg[languageType]}else{let b=e.sceneTargetList[a.id].sceneIndex,p=t.loadMakarARScene(b,o,n),m=e.parseLogicXMLBySceneIndex(b);l(m)&&p.push(m)}}if(a.found>0){if(e.currentSceneIndex=e.sceneTargetList[a.id].sceneIndex,2==a.found){o.targetState=2,e.logicList[e.currentSceneIndex]&&0==e.logicList[e.currentSceneIndex].logicSystemState&&e.logicList[e.currentSceneIndex].parseXML();var i=this.checkColoring(e.sceneTargetList[a.id].targetIndex,o,n,r.data.marker.allowColor);1==i?parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="block"):0==i&&parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="none")}else if(o.targetState=1,this.activeAndClearScene(e.sceneTargetList[a.id].sceneIndex),o.object3D&&o.object3D.children.length>0&&(o.object3D.traverse((function(e){e.originTransform&&(e.position.copy(e.originTransform.position),e.rotation.copy(e.originTransform.rotation),e.scale.copy(e.originTransform.scale))})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1),e.camera.projectionMatrix.elements[8]=e.bkCamera.projectionMatrix.elements[8],e.camera.projectionMatrixInverse.getInverse)e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix);else{let h=e.camera.projectionMatrix.clone();e.camera.projectionMatrixInverse.copy(h.invert())}o.object3D.matrix.fromArray(r.data.matrix)}else if(o.object3D.visible=!1,console.log("three.js: losing: obj= ",o,r.data.marker.id),this.checkColoring(r.data.marker.id,o,n,0),1==o.showObjects){if(o.targetState=0,arController.logicList[arController.currentSceneIndex]&&arController.logicList[arController.currentSceneIndex].stopLogic(),e.camera.projectionMatrix.elements[8]=0,e.camera.projectionMatrixInverse.getInverse)e.camera.projectionMatrixInverse.getInverse(e.camera.projectionMatrix);else{let _=e.camera.projectionMatrix.clone();e.camera.projectionMatrixInverse.copy(_.invert())}let g=r.data.marker.id,f=25.4*e.gcssTargets.width[g]/e.gcssTargets.dpi[g]/2;o.object3D.visible=!0,o.object3D.matrixAutoUpdate=!0,o.object3D.position.set(-f,40,250),o.object3D.rotation.x=90*Math.PI/180,o.object3D.updateMatrix(),o.object3D.updateMatrixWorld(),o.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;if(e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"image"==e.makarType||"video"==e.makarType){let t=e.getWorldQuaternion(new THREE.Quaternion),r=new THREE.Euler;r.setFromQuaternion(t),e.rotateOnAxis(new THREE.Vector3(0,1,0),0-r.y),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI-r.x),e.updateMatrixWorld(),e.updateMatrix()}"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1}}})),this.setViewMode=function(e=""){let t=this,r=t.aCamera,a=document.getElementById("oCamera");return""!=e&&(t.currentViewMode=e),new Promise((function(o){r&&a&&("AR"==e?(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,o("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: AR err=",e)}))):"model"==e?(t.camera=a.object3D.children[0],a.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,o("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _model err=",e)}))):t.camera==r?(t.camera=a.object3D.children[0],a.setAttribute("camera","active",!0),t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,o("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch model err=",e)}))):(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,o("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch AR err=",e)}))))}))},this.setCurrentSceneIndex=function(e){this.currentSceneIndex=e},this.setViewModeSceneObj=function(e){let r=this;return new Promise((function(o,n){let i=-1;if(null==r.currentSceneIndex){let e=a.o.getScenes(r.scenesData);for(let t=0;t<e.length;t++)if("ar"==e[t].info.type){i=t,r.setCurrentSceneIndex(t);break}}else i=r.currentSceneIndex;if(i<0)return void o(!1);let s=!1;for(let e=0,t=r.sceneTargetList.length;e<t;e++)r.sceneTargetList[e].sceneIndex==i&&r.sceneTargetList[e].modules.includes("coloring")&&(s=!0);console.log(" _setViewModeSceneObj: _sceneIndex ",i);let c=r.aframeNFTMarkers[i],d=r.threeNFTMarkers2D[i];for(let e in r.aframeNFTMarkers)r.aframeNFTMarkers[e].object3D.visible=!1,r.aframeNFTMarkers[e].setAttribute("visible",!1);for(let e in r.threeNFTMarkers2D)r.threeNFTMarkers2D[e].visible=!1;if("AR"==e)if(1==c.loadedObjects||1==d.loadedObjects)if(d.visible=!1,c.setAttribute("visible",!1),c.object3D.visible=!1,c.object3D.traverse((function(e){"video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound()})),null!=c.coloringStatus&&1==s)if(-1==c.coloringStatus||0==c.coloringStatus){for(console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),c.loadModel=!1;c.children.length>0;)c.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=t.loadMakarARScene(i,c,d),a=r.parseLogicXMLBySceneIndex(i);l(a)&&e.push(a),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),o(!0)}))}else 1==c.coloringStatus&&(console.log(" _setViewModeSceneObj: model: color 1"),o(!0));else console.log(" _setViewModeSceneObj: AR: not _coloring module "),o(!0);else o(!0);else if("model"==e){if(1!=c.loadedObjects||1!=d.loadedObjects){c.loadedObjects=d.loadedObjects=!0,1==s&&(c.loadModel=!0,c.coloringStatus=0,(u=r.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,r.targetCanvas.width,r.targetCanvas.height));let e=t.loadMakarARScene(i,c,d),a=r.parseLogicXMLBySceneIndex(i);l(a)&&e.push(a),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),o(!0)}))}else if(r.logicList[i]&&0==r.logicList[i].logicSystemState&&r.logicList[i].parseXML(),c.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),null!=c.coloringStatus&&1==s)if(-1==c.coloringStatus){var u;for(console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),c.loadModel=!0,c.coloringStatus=0,(u=r.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",u.fillRect(0,0,r.targetCanvas.width,r.targetCanvas.height);c.children.length>0;)c.children[0].remove();for(;d.children.length>0;)d.remove(d.children[0]);let e=t.loadMakarARScene(i,c,d),a=r.parseLogicXMLBySceneIndex(i);l(a)&&e.push(a),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[i]&&r.logicList[i].parseXML(),r.setupSceneBehav(i),o(!0)}))}else console.log(" _setViewModeSceneObj: model: _coloring module ",c.coloringStatus),o(!0);else console.log(" _setViewModeSceneObj: model: not _coloring module "),o(!0);d.visible=!0;let e=r.gcssTargets.dpi[c.GCSSID],a=r.gcssTargets.width[c.GCSSID],n=r.gcssTargets.height[c.GCSSID];c.setAttribute("visible",!0),c.object3D.visible=!0,c.object3D.matrixAutoUpdate=!0,c.object3D.position.set(0,0,0),c.object3D.position.add(new THREE.Vector3(25.4*-a/e/2,25.4*-n/e/2,0)),c.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&e.el.components.sound.playSound())})),c.object3D.rotation.x=-90*Math.PI/180,c.object3D.updateMatrix(),c.object3D.updateMatrixWorld()}else console.log(" _setViewModeSceneObj: error",e),n(e)}))},this.parseLogicXMLBySceneIndex=function(t){let r,o=a.o.getSceneLogicXML(e.scenesData,t);if(""!=o){let e=new Logic;r=e.loadXMLtoDoc(o),arController.logicList[t]=e}return r},this.activeAndClearScene=function(e){let t=this;for(let r in this.aframeNFTMarkers)if(r==e)this.aframeNFTMarkers[r].object3D.visible=!0,this.threeNFTMarkers2D[r].visible=!0,this.aframeNFTMarkers[r].object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location?t.dealVideoMuted():e.el.mp4Video.play()),"audio"==e.makarType&&e.el.components.sound.playSound())}));else{if(this.aframeNFTMarkers[r].object3D.traverse((function(e){if("video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound(),e.behav_reference&&e.behav_reference.length>0)for(let t=0;t<e.behav_reference.length;t++)"ShowVideo"!=e.behav_reference[t].behav_name&&"ShowModel"!=e.behav_reference[t].behav_name&&"ShowImage"!=e.behav_reference[t].behav_name&&"PlayMusic"!=e.behav_reference[t].behav_name&&"ShowText"!=e.behav_reference[t].behav_name||e.el.setAttribute("visible",!1)})),this.aframeNFTMarkers[r].loadModule&&"quiz"==this.aframeNFTMarkers[r].loadModule){let a=this.aframeNFTMarkers[r];for(;a.children.length>0;)a.children[0].remove();for(let e=0;e<t.makarObjects.length;e++)null!=t.makarObjects[e].object3D.el&&null!=t.makarObjects[e].object3D.parent||t.makarObjects.splice(e,1);let o=document.getElementById("startQuiz");"quiz"==this.aframeNFTMarkers[e].loadModule||(o.style.display="none"),t.aframeNFTMarkers[r].loadedObjects=!1,t.threeNFTMarkers2D[r].loadedObjects=!1}if(0==this.aframeNFTMarkers[r].object3D.visible&&0==this.threeNFTMarkers2D[r].visible)continue;if(this.aframeNFTMarkers[r].object3D.visible=!1,this.threeNFTMarkers2D[r].visible=!1,this.threeNFTMarkers2D[r].loadModule)switch(this.threeNFTMarkers2D[r].loadModule){case"scratchCard":aScratchCard.hideScratchCanvas(this.threeNFTMarkers2D[r]);break;case"pointCard":console.log("three.js: recognize: _clearScene, processing pointCard "),aPointCard.hidePointCardCanvas(this.threeNFTMarkers2D[r]);break;case"coloring":console.log("three.js: recognize: _clearScene, not support coloring ");break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[r].loadModule)}}},this.dealVideoMuted=function(t){let r=document.getElementById("clickToPlayAudio");r.style.display="block",r.onclick=function(){e.UnMutedAndPlayAllVisibleVideo(),window.allowAudioClicked=!0,r.style.display="none",r.onclick=null,window.alreadyClicked=!0}},this.getMakarObject=function(t){return 1!=t.makarObject?t.parent?e.getMakarObject(t.parent):0:t},this.dealAllGroupHide=function(e,t){let r=this,a=r.groupEventTargetDict[t];if(!a)return void console.log("_dealAllGroup: missing groupDict");let o=["ShowImage2D","ShowImage","ShowText2D","ShowText","ShowModel","PlayMusic","ShowVideo"];for(let t=0;t<e.behav.length;t++){let n=e.behav[t];""!=n.group&&a[n.group]&&a[n.group].objs.forEach(((e,t)=>{let a=e.behav.obj_id,i=r.getObjectTypeByObj_id(a);if("2d"==i.obj_type){let e=i.obj;if(n.obj_id!=a&&e.behav_reference)for(let t=0;t<e.behav_reference.length;t++)if(o.filter((r=>r==e.behav_reference[t].behav_name)).length>0){e.visible=!1;break}}else if("3d"==i.obj_type){let e=i.obj;if(e.object3D.behav_reference&&Array.isArray(e.object3D.behav_reference)&&n.obj_id!=a)for(let t=0;t<e.object3D.behav_reference.length;t++)if(o.filter((r=>r==e.object3D.behav_reference[t].behav_name)).length>0){r.hideAframeGroupObjectEvent(e);break}}}))}},this.setupSceneBehav=function(e){let t=this;for(let e=0,r=t.makarObjects.length;e<r;e++){let r=t.makarObjects[e].object3D;r?(r.behav,r.behav_reference):console.error(" _setupSceneBehav: 3d obj error",e,t.makarObjects[e])}let r=t.lookAtTargetDict[e];if(Array.isArray(r))for(let a=0,o=r.length;a<o;a++){let o=r[a],n=o.lookObjId,i=document.getElementById(n),l=o.lookBehav,s=l.obj_id,c=(l.reverse,document.getElementById(s));i&&i.object3D&&c&&c.object3D?t.addLookAtTimeLine(i,c,o,e):console.log("_setupSceneBehav: _lookAt error, obj not exist",i,c)}},this.addLookAtTimeLine=function(e,t,r,a){console.log(" _addLookAtTimeLine: ",r);let o=this.lookAtTargetTimelineDict[a],n=new THREE.Vector3;t.object3D.getWorldPosition(n);let i=gsap.timeline();o[r.lookObjId]=i,i.to(e.object3D,{duration:1100,delay:0,ease:"none",repeat:-1,onUpdate:function(){t.object3D.getWorldPosition(n),e.object3D.lookAt(n),r.lookBehav&&0==r.lookBehav.reverse&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}})},this.setObjectBehavAll=function(e,t){let r=this.groupEventTargetDict[t],a=this.lookAtTargetDict[t];console.log(" _setObjectBehavAll: ",t);for(let t=0,o=e.behav.length;t<o;t++)if(""!=e.behav[t].group&&r[e.behav[t].group]&&r[e.behav[t].group].objs.push({behav:e.behav[t]}),"LookAt"==e.behav[t].simple_behav&&e.behav[t].obj_id){let r={lookBehav:e.behav[t],lookObjId:e.obj_id};a.push(r)}},this.getMakarObject=function(t){return 1!=t.makarObject?t.parent?e.getMakarObject(t.parent):0:t},this.triggerEvent=function(e){let t=this,r=null,a=e.obj_id;switch(e.behav_type){case"Dialing":console.log("ARWrapper.js: _triggerEvent: Dialing: event=",e);let o=window.document.getElementById("phoneCall");o&&(o.href="tel:"+e.phone,o.click());break;case"Email":console.log("ARWrapper.js: _triggerEvent: SendEmail: event=",e);let n=window.document.getElementById("sendEmail");n&&(n.href="mailto:"+e.mail_to,n.click());break;case"URL":console.log("ARWrapper.js: _triggerEvent: URL: event=",e,e.url);let i=window.document.getElementById("openWebBrowser");i&&(i.href=e.url,i.click());break;case"Scenes":console.log("ARWrapper.js: _triggerEvent: _Scenes: event=",e);let l=e.scene_id;t.eventChangeScene(l);break;case"Display":console.log("ARWrapper.js: _triggerEvent: _Display: event=",e),r=document.getElementById(a),t.showObjectEvent(r,!1);break;case"Media":if(console.log("ARWrapper.js: _triggerEvent: _Media: event=",e),r=document.getElementById(a),!r){console.log("ARWrapper.js: _Media: target not exist",r);break}"a-video"==r.nodeName.toLowerCase()?t.showObjectEvent(r,!1):"a-sound"==r.nodeName.toLowerCase()?r.getAttribute("visible")?(r.setAttribute("visible",!1),r.setAttribute("class","unclickable"),r.components.sound.stopSound()):(r.setAttribute("visible",!0),r.object3D.behav&&r.setAttribute("class","clickable"),r.components.sound.playSound()):console.log("ARWrapper.js: _triggerEvent: Media: target is neither video nor sound object.",r);break;case"Animation":if(console.log("ARWrapper.js: _triggerEvent: _Animation: event=",e),r=document.getElementById(a),!(r&&r.object3D&&r.object3D.children[0]&&Array.isArray(r.object3D.children[0].animationSlices))){console.log("ARWrapper.js: _Animation: target not exist",r);break}{let t;for(let a=1;a<r.object3D.children[0].animationSlices.length;a++)r.object3D.children[0].animationSlices[a].uid==e.uid&&(t=r.object3D.children[0].animationSlices[a].animationName);r.setAttribute("animation-mixer","clip: "+t),e.loop?(r.object3D.children[0].animationSlices[0].loop=e.uid,r.object3D.children[0].animationSlices[0].uid=e.uid,r.object3D.children[0].animationSlices[0].changed=!0,r.object3D.children[0].animationSlices[0].reset=!0):(r.object3D.children[0].animationSlices[0].uid=e.uid,r.object3D.children[0].animationSlices[0].changed=!0,r.object3D.children[0].animationSlices[0].reset=e.reset)}break;case"TTS":if(console.log("ARWrapper.js: _triggerEvent: _TTS: event=",e),r=document.getElementById(a),!r||!r.object3D){console.log("ARWrapper.js: _TTS: target not exist",r);break}e.obj_id;break;default:console.log("ARWrapper.js: _triggerEvent: default: event=",e)}},this.eventChangeScene=function(e){let r=this;return new Promise((function(a){r.scenesData&&Array.isArray(r.scenesData.scenes)?console.log(" _eventChangeScene_: _sceneID: ",e):(console.log("_eventChangeScene_: scenesData error ",r.scenesData),a(!1));for(let o=0;o<r.scenesData.scenes.length;o++)if(r.scenesData.scenes[o].info.id==e){let e=r.scenesData.scenes[o].info;if("ar"==e.type)console.log(" _Scenes_ , to AR , ",o,e),"model"==r.currentViewMode?(r.setCurrentSceneIndex(o),r.sceneTargetList.forEach((e=>{if(e.sceneIndex==o){let o=e.sceneIndex,n=r.aframeNFTMarkers[o],i=r.threeNFTMarkers2D[o];if(1==n.loadedObjects||1==i.loadedObjects){console.log("three.js: _setViewModeSceneObj: already loaded, call _activeAndClearScene_ "),r.activeAndClearScene(o);let e=r.gcssTargets.dpi[n.GCSSID],t=r.gcssTargets.width[n.GCSSID],i=r.gcssTargets.height[n.GCSSID];n.object3D.position.set(0,0,0),n.object3D.position.add(new THREE.Vector3(25.4*-t/e/2,25.4*-i/e/2,0)),n.object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&e.el.mp4Video.play(),"audio"==e.makarType&&e.el.components.sound.playSound())})),n.object3D.rotation.x=-90*Math.PI/180,n.object3D.updateMatrix(),n.object3D.updateMatrixWorld(),a(!0)}else{console.log("three.js: _setViewModeSceneObj: not loaded, call _loadMakarARScene_ "),n.loadedObjects=!0,i.loadedObjects=!0;let e=t.loadMakarARScene(o,n,i),s=r.parseLogicXMLBySceneIndex(o);l(s)&&e.push(s),Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),r.logicList[o]&&r.logicList[o].parseXML(),r.setupSceneBehav(o),r.activeAndClearScene(o),a(!0)}))}}}))):"AR"==r.currentViewMode&&(r.setCurrentSceneIndex(o),r.activeAndClearScene(-1));else if("vr"==e.type){if(console.log(" _Scenes_ , to VR , ",e),window.mixController&&window.vrController&&window.vrController){let e=document.getElementById("loadPage");e&&(e.style.display="block"),arController.activeAndClearScene(-1),arController.enableARRendering=!1,vrController.enableVRRendering=!0,mixController.setActiveType("VR"),vrController.triggerEnable=!1,vrController.loadScene(o),"model"==r.currentViewMode?vrController.setViewMode("model"):"AR"==r.currentViewMode&&vrController.setViewMode("VR")}}else"ar_slam"==e.type&&(console.log(" _Scenes_ , to AR_SLAM , not yet ",e),window.mixController&&window.xrController&&window.xrController&&(arController.activeAndClearScene(-1),arController.enableARRendering=!1,xrController.enableXRRendering=!0,mixController.setActiveType("XR"),xrController.triggerEnable=!1,xrController.loadScene(o),"model"==r.currentViewMode?xrController.setViewMode("model"):"AR"==r.currentViewMode&&xrController.setViewMode("VR")))}}))},this.showObjectEvent=function(e,t){if(e)if(e.getAttribute("visible")){if(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),"a-video"==e.localName){let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||UnMutedAndPlayAllVisibleVideo()),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound"))if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})),t&&e.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}else{window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||UnMutedAndPlayAllVisibleVideo(e)),e.setAttribute("visible",!0);let t=e.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}e.object3D.behav&&e.setAttribute("class","clickable"),e.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("ARWrapper.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&(e.el.blockly?console.log("ARWrapper.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}else console.log("ARWrapper.js: _showObjectEvent: target not exist",e)}})}initARProcess(e){let t=this;return new Promise((function(e){if(!(window.ARController&&ARController.getUserMediaThreeScene&&window.ARProxy))return void console.warn(" _initARProcess_: not loaded , _return ");console.log(" _initARProcess_: all done ");let r="environment";ARController.getUserMediaThreeScene({maxARVideoSize:640,cameraParam:"../camera_para_640_480_fei.dat",facing:r,onSuccess:function(o,n,i){var l=new ARProxy(n,"../camera_para_640_480_fei.dat",(function(){}));window.proxy=l;let s=document.getElementById("arfScene"),c=s.canvas;n.arfScene=s,n.facing=r;let d=s.renderer;if(c.style.position="relative",d.outputEncoding=THREE.GammaEncoding,d.gammaFactor=1,d.sortObjects=!0,n.GLRenderer=d,n.arScene=o,window.arController=n,t.arController=n,"object"==typeof t.userProjResDict&&(n.userProjResDict=t.userProjResDict),"object"==typeof t.userOnlineResDict&&(n.userOnlineResDict=t.userOnlineResDict),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();n.voices=e}if(l.addEventListener("load",(function(r){if(this.processingDone=!1,t.currentProjData&&t.scenesData&&t.targetList){let r=t.currentProjData,i=t.scenesData;n.currentProjData=r,n.scenesData=t.scenesData;let s=0,c=0,d=0,u=0,b=[];n.sceneTargetList=b;let p=[];p=a.o.getScenes(i);for(let e=0;e<p.length;e++){Array.isArray(p[e].target_ids)&&(s+=p[e].target_ids.length);let t=p[e];t.info&&"ar"==t.info.type&&(c+=1)}if(console.log("three.js: _load: the total target number = ",s),s>19)return console.log("three.js: _load: languageType = ",languageType),warnModal.style.display="block",warnModalInfo.textContent=worldContent.targetNumberError[languageType],void(warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none"});let m=function(t){if(console.log("three.js: _onloadNFTMarker: ev = ",t),n.createAframeNFTMarker(t.result[0]),n.createThreeNFTMarker2D(t.result[0]),u+=1,Object.values(n.aframeNFTMarkers).length==c){let t=n;if(t.aframeNFTMarkers)for(let e in t.aframeNFTMarkers){let r=t.aframeNFTMarkers[e];if(Number.isInteger(Number(r.GCSSID))&&r&&r.object3D&&t.gcssTargets&&t.gcssTargets.dpi&&t.gcssTargets.width&&t.gcssTargets.height){let e=t.gcssTargets.dpi[r.GCSSID],a=t.gcssTargets.width[r.GCSSID],o=t.gcssTargets.height[r.GCSSID];r.object3D.matrixAutoUpdate=!0,r.object3D.position.set(0,0,0),r.object3D.position.add(new THREE.Vector3(25.4*-a/e/2,25.4*-o/e/2,0)),r.object3D.rotation.x=-90*Math.PI/180,r.object3D.updateMatrix(),r.object3D.updateMatrixWorld()}}console.log("three.js: _onloadNFTMarker done, call arScene.video.play() "),l.processingDone=!0,console.log("three.js:arScene.video.play()=>tick()"),e(),h(),setTimeout((function(){o.video.play().then((function(){console.log("three.js:arScene.video.play()=> succes")})).catch((function(e){console.error("three.js:arScene.video.play()=> error",e)}))}),10),n.userStartTime=(new Date).getTime()}};(new THREE.TextureLoader).load("https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg",(function(e){let o;o=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let i=n.GLRenderer,c=o.fromEquirectangularTexture(i,e);n.cubeTex=c;let u=[],h=a.o.getOneProj(r);if(h&&h.proj_descr&&h.proj_descr.includes("_coloring")){let e=h.proj_descr,t=e.indexOf("_coloring"),r=e.slice(t+10).indexOf(" "),a=e.slice(t+10,t+10+r).split("_");for(let e=0;e<a.length;e++)Number.isInteger(Number(a[e]))&&u.push(Number(a[e]))}for(let e=0;e<p.length;e++)if(Array.isArray(p[e].target_ids)&&p[e].info&&"ar"==p[e].info.type){let r=p[e].target_ids;for(let a=0;a<r.length;a++){let o=r[a];if(t.targetList){let r=t.targetList;for(let t=0;t<r.length;t++)if(r[t].target_id==o){let n=r[t].gcss_url;b[d]={sceneIndex:e,targetIndex:a,target_id:o,modules:[]},u.includes(e)&&b[d].modules.push("coloring"),l.loadNFTMarker(n.substring(0,n.length-5),d,s,m),d++}}}}console.log("three.js: _load: , _sceneTargetList = ",b)}))}})),document.body.className=n.orientation,"portrait"===n.orientation){let e,t;window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),console.log("3 three.js:portrait GLRenderer.setSize=",e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else if(/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)){let e,t;console.log("4 three.js:GLRenderer.setSize=",window.innerWidth,window.innerWidth/n.videoWidth*n.videoHeight),window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else{let e,t;window.innerWidth/window.innerHeight>n.videoWidth/n.videoHeight?(e=window.innerWidth,t=window.innerWidth/n.videoWidth*n.videoHeight):(e=window.innerHeight/n.videoHeight*n.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px",document.body.className+=" desktop",console.log("5 three.js: landscape GLRenderer.setSize=",n.videoWidth,n.videoHeight)}var u=new THREE.ObjectControls(d.domElement,new THREE.Object3D);u.enableVerticalRotation(),u.setRotationSpeed(.1),u.setRotationSpeedTouchDevices(.05);var b=function(e){null!=n.controlObject&&0!=n.controlObject?(this.setObjectToMove(n.controlObject),this.setCurrentControllObject(n.currentControllObject)):this.setObjectToMove(null)};u.addEventListener("mouseDown",b),u.addEventListener("onTouchStart",b),n.objectControls=u;let p=new THREE.Vector2,m=(new THREE.Vector2,new THREE.Raycaster);n.getMouse=function(e){let t=n.GLRenderer.domElement,r=t.getBoundingClientRect(),a=new THREE.Vector2;switch(e.type){case"mouseup":case"mousemove":case"mousedown":a.x=(e.clientX-r.left)/t.clientWidth*2-1,a.y=-(e.clientY-r.top)/t.clientHeight*2+1;break;case"touchend":case"touchstart":case"touchmove":a.x=(e.changedTouches[0].clientX-r.left)/t.clientWidth*2-1,a.y=-(e.changedTouches[0].clientY-r.top)/t.clientHeight*2+1;break;default:return void console.log("default endEvent: event.type=",e.type," not mouseup/touchend, return ")}return a},n.clickEndEvent=function(e){let t=n;if(2==n.objectControlState)return;let r=t.getMouse(e),a={};if(m.setFromCamera(r,o.camera2D),null!=n.currentSceneIndex){let e=n.threeNFTMarkers2D[n.currentSceneIndex],t=m.intersectObject(e,!0);if(0!=t.length){console.log(" intersects2D =",t);let e=0;for(var i=0;i<t.length;i++)t[i].object.defaultTexture&&(e=i);let r=n.getMakarObject(t[e].object);if(console.log("three.js: endEvent: 2D intersects touchObject2D =",r),r.behav){let e=!1;for(let t=0;t<r.behav.length;t++)"CloseAndResetChildren"==r.behav[t].simple_behav&&(e=!0);n.dealAllGroupHide(r,n.currentSceneIndex);for(let t=0;t<r.behav.length;t++){let a;if(r.behav[t].obj_id&&(a=n.getObjectTypeByObj_id(r.behav[t].obj_id)),"ShowImage"==r.behav[t].simple_behav)if("2d"==a.obj_type){var l=Object.assign({},r.behav[t]);l.simple_behav="ShowImage2D",n.triggerEvent(l,r,e)}else"3d"==a.obj_type&&n.triggerEvent(r.behav[t],r,e);else if("ShowText"==r.behav[t].simple_behav){let o=Object.assign({},r.behav[t]);if(o.simple_behav="ShowText2D",n.triggerEvent(o,r,e),"2d"==a.obj_type){let a=Object.assign({},r.behav[t]);a.simple_behav="ShowText2D",n.triggerEvent(a,r,e)}else"3d"==a.obj_type&&n.triggerEvent(r.behav[t],r,e)}else r.behav[t].simple_behav,n.triggerEvent(r.behav[t],r,e)}}return void("button"==r.main_type&&(console.log("three.js: button click ",r),n.clickQuiz2DButton(r)))}m.setFromCamera(r,n.camera);let o=[];for(let e=0;e<n.makarObjects.length;e++){let t=n.makarObjects[e];t.object3D&&o.push(t.object3D)}let s=n.aframeNFTMarkers[n.currentSceneIndex],c=m.intersectObject(s.object3D,!0);if(0!=c.length){console.log("endEvent: intersects =",c);let e=n.getMakarObject(c[0].object),t=e.el;if(console.log("three.js: _setupFunction: endEvent, intersectObject3D=",t.object3D),t&&t.onclickBlock)for(let e=0;e<t.onclickBlock.length;e++)t.onclickBlockState[e]&&(t.onclickBlockState[e]=!1,n.logicList[n.currentSceneIndex].parseBlock(t.onclickBlock[e],(function(){t.onclickBlockState[e]=!0})),a["3d_logic"]=t.onclickBlock[e]);if(e.behav){a["3d_behav"]=e.behav,n.dealAllGroupHide(e,n.currentSceneIndex);let t=!1;for(let r=0;r<e.behav.length;r++)"CloseAndResetChildren"==e.behav[r].simple_behav&&(t=!0);for(let r=0;r<e.behav.length;r++)if("CloseAndResetChildren"!=e.behav[r].simple_behav){let a;if(e.behav[r].obj_id&&(a=n.getObjectTypeByObj_id(e.behav[r].obj_id)),"ShowImage"==e.behav[r].simple_behav)if("2d"==a.obj_type){let a=Object.assign({},e.behav[r]);a.simple_behav="ShowImage2D",n.triggerEvent(a,e,t)}else"3d"==a.obj_type&&n.triggerEvent(e.behav[r],e,t);else if("ShowText"==e.behav[r].simple_behav)if("2d"==a.obj_type){let a=Object.assign({},e.behav[r]);a.simple_behav="ShowText2D",n.triggerEvent(a,e,t)}else"3d"==a.obj_type&&n.triggerEvent(e.behav[r],e,t);else n.triggerEvent(e.behav[r],e,t)}}console.log("three.js: touchObject",e),"button"==e.main_type&&(console.log("three.js: button click ",e),n.pushButton(e))}}0==Object.keys(a).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",a)},n.clickStartEvent=function(e){let t=n;n.objectControlState=1,e.preventDefault();let r=t.getMouse(e);if(p=t.getMouse(e),m.setFromCamera(r,n.camera),null!=n.currentSceneIndex){let e=n.aframeNFTMarkers[n.currentSceneIndex],t=m.intersectObjects([e.object3D],!0);if(0!=t.length){console.log("startEvent: intersects =",t);let e=n.getMakarObject(t[0].object);if(e.behav){let t=!1,r=!0;e.behav&&e.behav.forEach((e=>{"FingerGesture"==e.simple_behav&&(t=!0,r=1==e.active)})),1==t?1==r?(n.controlObject=e,n.currentControllObject=e):n.controlObject=null:(n.controlObject=e,n.currentControllObject=e)}else n.controlObject=e,n.currentControllObject=e}else n.controlObject=null}},n.clickMoveEvent=function(e){let t=n.getMouse(e);1==n.objectControlState&&t.sub(p).length()>.01&&(n.objectControlState=2)};let h=function(){let e=(new Date).getTime(),t=30;if(1==n.enableARRendering){1==n.enableTracking&&l.process(o.video);let r=n.clock.getDelta();for(let e=0;e<n.makarObjects.length;e++)1==n.makarObjects[e].playAnimation&&1==n.makarObjects[e].visible&&n.checkAimation(n.makarObjects[e].children[0],r);o.renderOn(d,null);let a=(new Date).getTime();t=a-e<30?30-(a-e)+1:1}else t=30;setTimeout(h,t)}}})}))}startAR(){let e=arController;e.enableARRendering=!0;let t=document.getElementById("homePage");parent.selectedProject?"XR"==parent.selectedProject.viewMode?e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):"model"==parent.selectedProject.viewMode?e.setViewMode("model").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})):e.setViewMode("AR").then((function(){t&&(t.style.display="none")})),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()}loadMakarARScene(e,t,r){let o=this;o.arController.groupEventTargetDict[e]?console.log("_loadMakarARScene_: _groupEventTargetDict: already exist ",e):o.arController.groupEventTargetDict[e]=JSON.parse(JSON.stringify(o.arController.groupDict)),o.arController.lookAtTargetDict[e]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",e):o.arController.lookAtTargetDict[e]=[],o.arController.lookAtTargetTimelineDict[e]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",e):o.arController.lookAtTargetTimelineDict[e]=[];let n=a.o.getSceneObjs(o.scenesData,e),i=[];for(let r=0;r<n.length;r++){let l=n[r],c=o.userProjResDict,d=o.userOnlineResDict;if(c[l.res_id]&&c[l.res_id].main_type)l.main_type=c[l.res_id].main_type;else if(d[l.res_id]&&d[l.res_id].res_url)l.main_type=d[l.res_id].main_type;else switch(s(l),l.res_id){case"Camera":case"Light":case"Text":l.main_type=l.res_id.toLowerCase();break;case"MakAR_Call":case"MakAR_Room":case"MakAR_Mail":case"Line_icon":case"FB_icon":break;default:["Cube","Capsule","Sphere","ch_Bojue","ch_Fei","ch_Lina","ch_Poyuan","ch_Roger"].find((e=>e==l.res_id))?l.main_type="model":console.log("_ARWrapper: _loadSceneObjects: main_type does not exist. obj=",l)}c[l.res_id]&&c[l.res_id].sub_type?l.sub_type=c[l.res_id].sub_type:d[l.res_id]&&d[l.res_id].res_url&&(l.sub_type=d[l.res_id].sub_type),c[l.res_id]&&c[l.res_id].res_url?l.res_url=c[l.res_id].res_url:d[l.res_id]&&d[l.res_id].res_url?l.res_url=d[l.res_id].res_url:console.log("_loadMakarARScene_: res_url does not exist. obj=",l);let u=a.o.getObjObjType(o.scenesData,l);a.o.setBehavIntoObj(o.scenesData,e,l);let _=a.o.getObjTransform(o.scenesData,l),j=_.position,v=_.rotation,y=_.scale,A=_.quaternion;switch(l.main_type){case"camera":break;case"image":if(console.log(" _ARWrapper: load image ",r,u,l),"3d"==u){let e=m(o.arController,t,l,j,v,y,A);i.push(e)}break;case"video":if(console.log(" _ARWrapper: load video ",r,u,l),"3d"==u){let e=f(o.arController,t,l,j,v,y,A);i.push(e)}break;case"text":if("3d"==u){let e=g(o.arController,t,l,j,0,y,A);i.push(e)}break;case"model":if(console.log(" _ARWrapper: load model ",r,u,l),"3d"==u){let e=b(o.arController,t,l,j,v,y,A);i.push(e)}break;case"audio":if("mp3"==l.sub_type||"wav"==l.sub_type||"ogg"==l.sub_type){let e=p(o.arController,t,l,j,v,y,A);i.push(e)}break;case"light":console.log(" _ARWrapper: load light ",r,u,l);let e=h(o.arController,t,l,j,0,y,A);i.push(e);break;default:console.log(" _ARWrapper: load default ",r,u,l)}}return i}};window.startARProcess=function(e){!function(e){if(parent&&parent.selectedProject&&"string"==typeof parent.selectedProject.proj_id&&"string"==typeof parent.selectedProject.user_id){let t=parent.selectedProject.user_id,r=[parent.selectedProject.proj_id],n={};window.makarUserData=n,n.oneProjData=e;let i=[],l=a.o.getProjDataEditorVer(e);if(3==l.v0&&l.v1>=5){if(e&&Array.isArray(e.target_ids)){let t=o.Z.getTargetList(e.target_ids);i.push(t),t.then((function(e){e.data&&Array.isArray(e.data.targetList)&&(n.targetList=e.data.targetList)}))}let a=o.Z.getProjectSceneList(r),l=o.Z.getUserOnlineResources(t),s=o.Z.getUserResources(t);i.push(a),i.push(l),i.push(s),a.then((function(e){console.log(" _pScenes_: ",e),e.data&&Array.isArray(e.data.projectSceneList)&&1==e.data.projectSceneList.length&&(n.scenesData=e.data.projectSceneList[0])})),l.then((function(e){if(e.data&&Array.isArray(e.data.onlineResourcesList)){let t=e.data.onlineResourcesList;n.onlineResourcesList=t;let r={};for(let e=0;e<t.length;e++)r[t[e].res_id]=t[e];n.userOnlineResDict=r}})),s.then((function(e){if(e.data&&Array.isArray(e.data.resourcesList)){let t=e.data.resourcesList;n.resourcesList=t;let r={};for(let e=0;e<t.length;e++)r[t[e].res_id]=t[e];n.userProjResDict=r}})),Promise.all(i).then((function(e){window.startSceneController()}))}else console.warn(" _startInitProjAndScene_: VC error ",e)}}(e)},window.startSceneController=function(){console.log(" _startSceneController_  start"),new Promise((function(e){let t=document.createElement("div");t.style.position="absolute",t.setAttribute("id","arDiv"),t.style.top="0px",t.style.width=document.documentElement.clientWidth+"px",t.style.height=Math.round(document.documentElement.clientHeight-0)+"px",document.body.appendChild(t);let r=document.createElement("a-scene");r.setAttribute("id","arfScene"),r.setAttribute("embedded",""),r.setAttribute("renderer","logarithmicDepthBuffer: true; physicallyCorrectLights: false; "),r.setAttribute("vr-mode-ui","enabled: false"),t.appendChild(r);let a=document.createElement("a-light");a.setAttribute("id","ambientLight"),a.setAttribute("type","ambient"),a.setAttribute("color","#808080"),a.setAttribute("ground-color","#fff"),a.setAttribute("intensity",1),r.appendChild(a);let o=document.createElement("a-entity");o.setAttribute("id","oCamera"),o.setAttribute("crossorigin","anonymous"),o.setAttribute("camera",{active:!0,fov:80}),o.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\tmaxPolarAngle: 180; \n\t\t\tminDistance: 0.1; \n\t\t\tmaxDistance: 1000; \n\t\t\tinitialPosition: 0 60 -300;"),r.appendChild(o);let n=document.createElement("a-assets");n.setAttribute("id","makarAssets"),n.setAttribute("timeout","1000"),n.setAttribute("crossorigin","anonymous"),r.appendChild(n),r.hasLoaded?e():r.addEventListener("loaded",(function(){e()}))})).then((function(){let e=document.getElementById("arfScene"),t=window.makarUserData,r=[];if(a.o.checkSceneIncludeAR(t.scenesData)){let e=new Promise((function(e){console.log(" _startInitProjAndScene_ with AR: load scripts ");let r=setInterval((function(){if(window.ARController){clearInterval(r),console.log(" _startInitProjAndScene_ with AR: ARController load done");let a=new v(t);window.arWrapper=a,e(a)}else console.log(" _startInitProjAndScene_ with AR: ARController load not done")}),500)}));r.push(e)}Promise.all(r).then((function(r){console.log(" _pControllerLoaded_ ",r);let o,i=!1,l=[],s=new n(e.renderer);for(let e=0;e<r.length;e++){let t=r[e];if(0==i&&"ARWrapper"==t.type){i=!0,o=t,s.includeAR(o);let e=o.initARProcess();l.push(e)}}Promise.all(l).then((function(e){let r=a.o.getScenes(t.scenesData);r[0]&&"ar"==r[0].info.type&&(s.setControllerType("AR"),o.arController.enableARRendering=!0,o.startAR())}))}))})),delete window.startSceneController}}}]);