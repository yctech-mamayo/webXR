!function(){function e(e){for(var t="",r=0;r<e;r++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}window.FuncColoring=function(){window.proxy?(console.log("three.js: proxy is created"),proxy.getFrameTarget()):console.log("three.js: proxy is not created, please StartAR first")};var t=window.leavedSendLog=function(t){if(!window.proxy||!window.publishARProjs)return;if(!proxy.arController)return;if(!proxy.arController.userStartTime)return;if(!proxy.arController.projStartTimeList)return;let r;localStorage.getItem("device_id")&&localStorage.getItem("device_id")>=24?r=localStorage.getItem("device_id"):(r=(new Date).getTime()+"_"+e(10),localStorage.setItem("device_id",r));let o=(new Date).getTime(),a={brand:Browser.name+Browser.version,os:Browser.platform,device_id:r,client:"viewer",user_id:publishARProjs.user_id,proj_id:"",proj_type:"ar",duration_time:0,explore_time:0,play_time:0,location_long:0,location_lan:0};console.log("three.js: window refresh ",proxy.arController.userStartTime,proxy.arController.projStartTimeList);let n=[];for(let e=0;e<proxy.arController.projStartTimeList.length;e++){let t=proxy.arController.projStartTimeList[e],r=proxy.arController.projStartTimeList[e+1];a.proj_id=publishARProjs.proj_list[t.projIndex].proj_id,0==e?r?(a.duration_time=(r.time-proxy.arController.userStartTime)/1e3,a.play_time=(r.time-t.time)/1e3,a.explore_time=(t.time-proxy.arController.userStartTime)/1e3):(a.duration_time=(o-proxy.arController.userStartTime)/1e3,a.play_time=(o-t.time)/1e3,a.explore_time=(t.time-proxy.arController.userStartTime)/1e3):r?(a.duration_time=(r.time-t.time)/1e3,a.play_time=(r.time-t.time)/1e3,a.explore_time=0):(a.duration_time=(o-t.time)/1e3,a.play_time=(o-t.time)/1e3,a.explore_time=0),console.log("three.js: project["+e+"] playing time = ",a.duration_time,a.play_time,a.explore_time),n.push(a)}localStorage.setItem("savedProjLogs",JSON.stringify(n))};function r(){window.ARController&&ARController.getUserMediaThreeScene&&window.ARThreeOnLoad?"undefined"!=typeof sceneResult?(console.log("three.js: the sceneResult is exist, do _ARThreeOnLoad user_id=",sceneResult.user_id),window.ARThreeOnLoad(),window.allowedMakarIDUseWeb):window.serverUrl&&window.makarID?getARSceneByUserID(window.serverUrl,window.makarID,(function(e){if(console.log(" _getARSceneByUserID_: ",e),"string"==typeof e){let t="";t=e,document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="block",document.getElementById("pUserInfo").innerHTML=t,leaveIframe.onclick=function(e){e.preventDefault(),parent.aUI})}else document.getElementById("freeUserWarnDiv")&&(document.getElementById("freeUserWarnDiv").style.display="none"),r()})):console.log("three.js: fail, the makarID=",winodw.makarID,", serverURL=",serverUrl):(console.log("three.js: _tick_ARThreeOnLoad: tick again, absence ARC && gMT && ART"),setTimeout(r,500))}window.onbeforeunload=t,window.ARThreeOnLoad=function(){let e="environment";console.log("three.js: _ARThreeOnLoad start, facing=",e),parent&&parent.fullScreenIcon&&parent.fullScreenIcon.style&&(parent.fullScreenIcon.style.display="none"),new Promise((function(e){let t=document.createElement("div");t.style.position="absolute",t.setAttribute("id","arDiv"),t.style.top="0px",t.style.width=document.documentElement.clientWidth+"px",t.style.height=Math.round(document.documentElement.clientHeight-0)+"px",document.body.appendChild(t);let r=document.createElement("a-scene");r.setAttribute("id","arfScene"),r.setAttribute("embedded",""),r.setAttribute("renderer","logarithmicDepthBuffer: true; physicallyCorrectLights: false; "),r.setAttribute("vr-mode-ui","enabled: false"),t.appendChild(r);let o=document.createElement("a-light");o.setAttribute("id","ambientLight"),o.setAttribute("type","ambient"),o.setAttribute("color","#808080"),o.setAttribute("ground-color","#fff"),o.setAttribute("intensity",1),r.appendChild(o);let a=document.createElement("a-entity");a.setAttribute("id","oCamera"),a.setAttribute("crossorigin","anonymous"),a.setAttribute("camera",{active:!0,fov:80}),a.setAttribute("orbit-controls","minPolarAngle: 0; \n\t\t\tmaxPolarAngle: 180; \n\t\t\tminDistance: 0.1; \n\t\t\tmaxDistance: 1000; \n\t\t\tinitialPosition: 0 60 -300;"),r.appendChild(a),r.hasLoaded?e():r.addEventListener("loaded",(function(){e()}))})).then((function(){ARController.getUserMediaThreeScene({maxARVideoSize:640,cameraParam:"../camera_para_640_480_fei.dat",facing:e,onSuccess:function(t,r,o){var a=new ARProxy(r,"../camera_para_640_480_fei.dat",(function(){}));window.proxy=a;let n=document.getElementById("arfScene"),s=n.renderer,c=n.canvas;r.arfScene=n,r.loadAssets(),r.facing=e;let d=s;if(c.style.position="relative",d.outputEncoding=THREE.GammaEncoding,d.gammaFactor=1,d.sortObjects=!0,r.GLRenderer=d,r.arScene=t,r.ARSceneResult=sceneResult,window.arController=r,"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){let e=speechSynthesis.getVoices();r.voices=e}if(a.addEventListener("load",(function(e){if(this.processingDone=!1,window.publishARProjs&&window.sceneResult){var o=this.arController.createThreeNFTMarker2D("-3");this.arController.loadDeaultTexture2D(o,"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/note1.png",new THREE.Vector3(0,-50,0),new THREE.Vector3(0,0,0),new THREE.Vector3(.9,.9,.9),[.5,1],{simple_behav:"runAnimation2D",dt:200,dopacity:.1}),o.name="note1",o.visible=!1,t.scene2D.add(o);let e=0,n=0,s=[];r.sceneTargetList=s;for(let t in window.publishARProjs.proj_list)window.publishARProjs.proj_list[t].targets_gcss_urls?e+=window.publishARProjs.proj_list[t].targets_gcss_urls.length:e++;if(console.log("three.js: _load: the total target number = ",e),e>19)return console.log("three.js: _load: languageType = ",i),warnModal.style.display="block",warnModalInfo.textContent=l.targetNumberError[i],void(warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none"});let c=function(o){console.log("three.js: _onloadNFTMarker: ev = ",o);let n=r.createAframeNFTMarker(o.result[0]),i=r.createThreeNFTMarker2D(o.result[0]);if(t.scene2D.add(i),r.arfScene.appendChild(n),Object.values(r.aframeNFTMarkers).length==e){console.log("three.js: _onloadNFTMarker done, call arScene.video.play() "),a.processingDone=!0,console.log("three.js:arScene.video.play()=>tick()"),j(),setTimeout((function(){t.video.play().then((function(){console.log("three.js:arScene.video.play()=> succes")})).catch((function(e){console.error("three.js:arScene.video.play()=> error",e)}))}),1e3),r.userStartTime=(new Date).getTime(),r.projStartTimeList=[];let e=document.getElementById("homePage");parent.selectedProject?"XR"==parent.selectedProject.viewMode?r.setViewMode("AR").then((function(){e&&(e.style.display="none")})):"model"==parent.selectedProject.viewMode?r.setViewMode("model").then((function(){e&&(e.style.display="none")})):r.setViewMode("AR").then((function(){e&&(e.style.display="none")})):r.setViewMode("AR").then((function(){e&&(e.style.display="none")})),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&-1==parent.projectUIController.status&&parent.projectUIController.showUI()}};console.log(" three.js: load publishARProjs proj_list =",window.publishARProjs.proj_list,userPublishProjs),(new THREE.TextureLoader).load("https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/spherical_image/defaultGray2.jpg",(function(t){let o;o=THREE.WebGLRenderTargetCube?new THREE.WebGLRenderTargetCube(1024,1024):new THREE.WebGLCubeRenderTarget(1024);let i=r.GLRenderer,l=o.fromEquirectangularTexture(i,t);r.cubeTex=l;for(let t in window.publishARProjs.proj_list){let r=window.publishARProjs.proj_list[t].target_gcss_url;if(window.publishARProjs.proj_list[t].proj_descr.indexOf("_coloring")>0&&(window.sceneResult[t].module="coloring",Array.isArray(window.sceneResult[t].data.module_type)&&window.sceneResult[t].data.module_type.push("coloring")),window.publishARProjs.proj_list[t].module_type){let o=window.publishARProjs.proj_list[t].module_type.find((function(e){let t;return"point_card"!=e&&"quiz"!=e||(t=e),t}));if("point_card"==o||"quiz"==o)for(let o=0;o<window.publishARProjs.proj_list[t].targets_gcss_urls.length;o++)s[n]={projIndex:t,target_id:window.publishARProjs.proj_list[t].target_ids[o]},r=window.publishARProjs.proj_list[t].targets_gcss_urls[o],a.loadNFTMarker(r.substring(0,r.length-5),n,e,c),n++;else s[n]={projIndex:t,target_id:window.publishARProjs.proj_list[t].target_id},a.loadNFTMarker(r.substring(0,r.length-5),n,e,c),n++}else s[n]={projIndex:t,target_id:window.publishARProjs.proj_list[t].target_id},a.loadNFTMarker(r.substring(0,r.length-5),n,e,c),n++}console.log("three.js: _load: , sceneTargetList = ",s)}))}})),document.body.className=r.orientation,"portrait"===r.orientation){let e,t;window.innerWidth/window.innerHeight>r.videoWidth/r.videoHeight?(e=window.innerWidth,t=window.innerWidth/r.videoWidth*r.videoHeight):(e=window.innerHeight/r.videoHeight*r.videoWidth,t=window.innerHeight),d.setSize(e,t),console.log("3 three.js:portrait GLRenderer.setSize=",e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else if(/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)){let e,t;console.log("4 three.js:GLRenderer.setSize=",window.innerWidth,window.innerWidth/r.videoWidth*r.videoHeight),window.innerWidth/window.innerHeight>r.videoWidth/r.videoHeight?(e=window.innerWidth,t=window.innerWidth/r.videoWidth*r.videoHeight):(e=window.innerHeight/r.videoHeight*r.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px"}else{let e,t;window.innerWidth/window.innerHeight>r.videoWidth/r.videoHeight?(e=window.innerWidth,t=window.innerWidth/r.videoWidth*r.videoHeight):(e=window.innerHeight/r.videoHeight*r.videoWidth,t=window.innerHeight),d.setSize(e,t),c.style.left=(innerWidth-e)/2+"px",c.style.top=(innerHeight-t)/2+"px",document.body.className+=" desktop",console.log("5 three.js: landscape GLRenderer.setSize=",r.videoWidth,r.videoHeight)}d.domElement.addEventListener("touchend",g,!1),d.domElement.addEventListener("mouseup",g,!1),d.domElement.addEventListener("touchmove",f,!1),d.domElement.addEventListener("mousemove",f,!1),d.domElement.addEventListener("touchstart",_,!1),d.domElement.addEventListener("mousedown",_,!1);var u=new THREE.ObjectControls(d.domElement,new THREE.Object3D);u.enableVerticalRotation(),u.setRotationSpeed(.1),u.setRotationSpeedTouchDevices(.05);var m=function(e){null!=r.controlObject&&0!=r.controlObject?(this.setObjectToMove(r.controlObject),this.setCurrentControllObject(r.currentControllObject)):this.setObjectToMove(null)};u.addEventListener("mouseDown",m),u.addEventListener("onTouchStart",m),r.objectControls=u;var p=new THREE.Vector2,h=new THREE.Vector2,b=new THREE.Raycaster;function g(e){if(2==r.objectControlState)return;e.preventDefault();let o=d.domElement.getBoundingClientRect();switch(e.type){case"mouseup":h.x=(e.clientX-o.left)/d.domElement.clientWidth*2-1,h.y=-(e.clientY-o.top)/d.domElement.clientHeight*2+1;break;case"touchend":h.x=(e.changedTouches[0].clientX-o.left)/d.domElement.clientWidth*2-1,h.y=-(e.changedTouches[0].clientY-o.top)/d.domElement.clientHeight*2+1;break;default:return void console.log(" endEvent: event.type=",e.type," not mouseup/touchend, return ")}let a={};if(b.setFromCamera(h,t.camera2D),null!=r.currentProjectIndex){let e=r.threeNFTMarkers2D[r.currentProjectIndex],t=b.intersectObject(e,!0);if(0!=t.length){console.log(" intersects2D =",t);let e=0;for(var n=0;n<t.length;n++)t[n].object.defaultTexture&&(e=n);let o=r.getMakarObject(t[e].object);if(console.log("three.js: endEvent: 2D intersects touchObject2D =",o),o.behav){let e=!1;for(let t=0;t<o.behav.length;t++)"CloseAndResetChildren"==o.behav[t].simple_behav&&(e=!0);let t=r.sceneTargetList[r.currentProjectIndex].projIndex;r.dealAllGroupHide(o,t);for(let t=0;t<o.behav.length;t++){let a;if(o.behav[t].obj_id&&(a=r.getObjectTypeByObj_id(o.behav[t].obj_id)),"ShowImage"==o.behav[t].simple_behav)if("2d"==a.obj_type){var i=Object.assign({},o.behav[t]);i.simple_behav="ShowImage2D",r.triggerEvent(i,o,e)}else"3d"==a.obj_type&&r.triggerEvent(o.behav[t],o,e);else if("ShowText"==o.behav[t].simple_behav){let n=Object.assign({},o.behav[t]);if(n.simple_behav="ShowText2D",r.triggerEvent(n,o,e),"2d"==a.obj_type){let a=Object.assign({},o.behav[t]);a.simple_behav="ShowText2D",r.triggerEvent(a,o,e)}else"3d"==a.obj_type&&r.triggerEvent(o.behav[t],o,e)}else o.behav[t].simple_behav,r.triggerEvent(o.behav[t],o,e)}}return void("button"==o.main_type&&(console.log("three.js: button click ",o),r.clickQuiz2DButton(o)))}b.setFromCamera(h,r.camera);let o=[];for(let e=0;e<r.makarObjects.length;e++){let t=r.makarObjects[e];t.object3D&&o.push(t.object3D)}let l=r.aframeNFTMarkers[r.currentProjectIndex],s=b.intersectObject(l.object3D,!0);if(0!=s.length){let e=r.getMakarObject(s[0].object),t=e.el;if(console.log("three.js: _setupFunction: endEvent, intersectObject3D=",t.object3D),t&&t.onclickBlock)for(let e=0;e<t.onclickBlock.length;e++)t.onclickBlockState[e]&&(t.onclickBlockState[e]=!1,r.logicList[r.currentProjectIndex].parseBlock(t.onclickBlock[e],(function(){t.onclickBlockState[e]=!0})),a["3d_logic"]=t.onclickBlock[e]);if(e.behav){a["3d_behav"]=e.behav;let t=r.sceneTargetList[r.currentProjectIndex].projIndex;r.dealAllGroupHide(e,t);let o=!1;for(let t=0;t<e.behav.length;t++)"CloseAndResetChildren"==e.behav[t].simple_behav&&(o=!0);for(let t=0;t<e.behav.length;t++)if("CloseAndResetChildren"!=e.behav[t].simple_behav){let a;if(e.behav[t].obj_id&&(a=r.getObjectTypeByObj_id(e.behav[t].obj_id)),"ShowImage"==e.behav[t].simple_behav)if("2d"==a.obj_type){let a=Object.assign({},e.behav[t]);a.simple_behav="ShowImage2D",r.triggerEvent(a,e,o)}else"3d"==a.obj_type&&r.triggerEvent(e.behav[t],e,o);else if("ShowText"==e.behav[t].simple_behav)if("2d"==a.obj_type){let a=Object.assign({},e.behav[t]);a.simple_behav="ShowText2D",r.triggerEvent(a,e,o)}else"3d"==a.obj_type&&r.triggerEvent(e.behav[t],e,o);else r.triggerEvent(e.behav[t],e,o)}}console.log("three.js: touchObject",e),"button"==e.main_type&&(console.log("three.js: button click ",e),r.pushButton(e))}}0==Object.keys(a).length?(console.log(" _entEvent: not touch anything "),parent&&parent.projMenuGroup&&parent.controlGroup&&parent.pictureBackground&&parent.projectUIController&&"function"==typeof parent.projectUIController.showUI&&"function"==typeof parent.projectUIController.hideUI&&(1==parent.projectUIController.status?parent.projectUIController.g_tl_show._time>3?parent.projectUIController.showUI():parent.projectUIController.hideUI():(parent.projectUIController.status,parent.projectUIController.showUI()))):console.log(" _entEvent:  touch somethong ",a)}function _(e){r.objectControlState=1,e.preventDefault();let t=d.domElement.getBoundingClientRect();switch(e.type){case"mousedown":p.x=e.clientX,p.y=e.clientY,h.x=(e.clientX-t.left)/d.domElement.clientWidth*2-1,h.y=-(e.clientY-t.top)/d.domElement.clientHeight*2+1;break;case"touchstart":p.x=e.changedTouches[0].clientX,p.y=e.changedTouches[0].clientY,h.x=(e.changedTouches[0].clientX-t.left)/d.domElement.clientWidth*2-1,h.y=-(e.changedTouches[0].clientY-t.top)/d.domElement.clientHeight*2+1;break;default:return void console.log(" startEvent: event.type=",e.type," not mousedown/touchstart, return ")}if(b.setFromCamera(h,r.camera),null!=r.currentProjectIndex){let e=r.aframeNFTMarkers[r.currentProjectIndex],t=b.intersectObjects([e.object3D],!0);if(console.log(" _startEvent: ",b,r.camera,e.object3D),0!=t.length){console.log("startEvent: intersects =",t);let e=r.getMakarObject(t[0].object);if(e.behav){let t=!1,o=!0;e.behav&&e.behav.forEach((e=>{"FingerGesture"==e.simple_behav&&(t=!0,o=1==e.active)})),1==t?1==o?(r.controlObject=e,r.currentControllObject=e):r.controlObject=null:(r.controlObject=e,r.currentControllObject=e)}else r.controlObject=e,r.currentControllObject=e}else console.log("2 startEvent: intersects =",t),r.controlObject=null}}function f(e){switch(e.type){case"mousemove":1==r.objectControlState&&(Math.abs(p.x-e.clientX)>2||Math.abs(p.y-e.clientY)>2)&&(r.objectControlState=2);break;case"touchmove":(Math.abs(p.x-e.changedTouches[0].clientX)>2||Math.abs(p.y-e.changedTouches[0].clientY)>2)&&(r.objectControlState=2);break;default:return void console.log(" startEvent: event.type=",e.type," not mousemove/touchmove, return ")}}var j=function(){let e=(new Date).getTime();1==r.enableTracking&&a.process(t.video);var o=r.clock.getDelta();for(let e=0;e<r.makarObjects.length;e++)1==r.makarObjects[e].playAnimation&&1==r.makarObjects[e].visible&&r.checkAimation(r.makarObjects[e].children[0],o);t.renderOn(d,null);let n=(new Date).getTime(),i=30;i=n-e<30?30-(n-e)+1:1,setTimeout(j,i)}}})})),delete window.ARThreeOnLoad};var o,a=function(){if("undefined"!=typeof checkHost){if("yet"==checkHost)setTimeout(a,50);else if("correct"==checkHost)r();else if("fail"==checkHost){for(;document.body.firstChild;)document.body.removeChild(document.body.firstChild);var e=document.createElement("div");e.innerHTML="<br>The host of webAR seems unauthorized,<br> please contact MIFLY ",e.style.fontSize="18px",e.style.margin="5px",e.style.fontWeight="700",document.body.append(e)}}else console.log("three.js: checkHost = undefined, something ERROR.")};window.startARProcess=a,o="undefined"!=typeof window?window:self;var n=function(){o.ARController&&o.THREE?(function(){ARController.getUserMediaThreeScene=function(e){var t={};for(var r in e)t[r]=e[r];var o=e.onSuccess;return t.onSuccess=function(e,t){var r=e.createThreeScene();o(r,e,t)},this.getUserMediaARController(t)},ARController.prototype.UrlExistsFetch=async function(e){let t=await fetch(e,{method:"HEAD"});return console.log("_ARController: _UrlExistsFetch: ret ",t),!!t.status&&"200"==t.status},ARController.prototype.createThreeScene=function(e){e=e||this.image,this.setupThree();var t=new THREE.VideoTexture(e);t.minFilter=THREE.LinearFilter,t.flipY=!1,this.cameraTexture=t;var r=new THREE.Mesh(new THREE.PlaneGeometry(t.image.videoWidth,t.image.videoHeight),new THREE.MeshBasicMaterial({map:t,side:THREE.BackSide}));r.material.depthTest=!1,r.material.depthWrite=!1,r.position.set(0,0,-1);var o=new THREE.OrthographicCamera(-t.image.videoWidth/2,t.image.videoWidth/2,-t.image.videoHeight/2,t.image.videoHeight/2,-100,2e4);let a,n,i=document.getElementById("arfScene"),l=t.image.videoWidth,s=t.image.videoHeight;window.innerWidth/window.innerHeight>l/s?(a=window.innerWidth,n=window.innerWidth/l*s):(a=window.innerHeight/s*l,n=window.innerHeight);var c=new THREE.OrthographicCamera(-a/2,a/2,-n/2,n/2,-100,2e4),d=new THREE.Scene;d.name="videoScene",d.add(r),d.add(o);var u=new THREE.Scene;u.name="glScene";var m=new THREE.Scene;m.name="scene2D";var p=new THREE.Scene,h=new THREE.PerspectiveCamera(45,1.33333,1,2e4);if(h.projectionMatrix.fromArray(this.getCameraMatrix()),h.rotation.set(0,180*Math.PI/180,180*Math.PI/180),h.projectionMatrix.elements[5]=-h.projectionMatrix.elements[5],h.projectionMatrix.elements[8]=-h.projectionMatrix.elements[8],h.projectionMatrix.elements[9]=-h.projectionMatrix.elements[9],h.projectionMatrix.elements[10]=-h.projectionMatrix.elements[10],h.projectionMatrix.elements[11]=-h.projectionMatrix.elements[11],h.projectionMatrixInverse.getInverse)h.projectionMatrixInverse.getInverse(h.projectionMatrix);else{let e=h.projectionMatrix.clone();h.projectionMatrixInverse.copy(e.invert())}let b=h.clone(),g=document.getElementById("oCamera"),_=new THREE.PerspectiveCamera(60,a/n,.3,1e4),f=g.getObject3D("camera").position.clone();_.position.copy(f);let j={aspect:a/n,near:.3,far:1e4,fov:60};g.setObject3D("camera",_),g.setAttribute("camera",j),g.components.camera.camera=_,g.components["orbit-controls"].controls.object=_;var y=new THREE.PerspectiveCamera(45,1.33333,1,2e4);y.projectionMatrix.fromArray(this.getCameraMatrix()),this.orientation,this.glScene=u,this.camera=h,this.aCamera=h,this.oCamera=g,this.oCamera3D=_,this.bkCamera=b,this.CSScamera=y,this.videoCamera=o,this.videoScene=d,this.scene2D=m,this.camera2D=c,this.videoStreamPlane=r,this.enableTracking=!0;var w=new THREE.Clock;this.clock=w,this.cssScene=p;var v=this;return{glScene:u,videoScene:d,scene2D:m,cssScene:p,camera:h,CSScamera:y,videoCamera:o,camera2D:c,arController:this,video:e,clock:w,process:function(){for(var t in v.aframeNFTMarkers)v.aframeNFTMarkers[t].object3D.visible=!1;v.process(e)},renderOn:function(e,r){t.needsUpdate=!0,e.autoClear=!1,v.arScene.video.paused||e.render(this.videoScene,this.videoCamera),e.clearDepth(),e.render(i.object3D,arController.camera),e.render(this.scene2D,this.camera2D)}}},ARController.prototype.createThreeMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.markerTracker=this.trackPatternMarkerId(e,t),r.matrixAutoUpdate=!1,this.threePatternMarkers[e]=r,r},ARController.prototype.createThreeNFTMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.visible=!1,r.GCSSID=e,r.loadedObjects=!1,r.showObjects=!0,r.matrixAutoUpdate=!1,this.threeNFTMarkers[e]=r,r},ARController.prototype.createAframeNFTMarker=function(e){this.setupThree();let t=document.createElement("a-entity"),r=this;if(e<publishARProjs.result.length){let o=publishARProjs.result[e].target_ids[0],a=r.sceneTargetList.findIndex((e=>e.target_id==o));t.setAttribute("id",o),t.GCSSID=a}return t.setAttribute("visible",!1),t.loadedObjects=!1,t.showObjects=!0,t.addEventListener("loaded",(function(){t.object3D.matrixAutoUpdate=!1,t.object3D.targetRoot=!0})),this.aframeNFTMarkers[e]=t,t},ARController.prototype.createThreeNFTMarker2D=function(e){this.setupThree();let t=this;var r=new THREE.Object3D;if(r.visible=!1,e<publishARProjs.result.length&&e>-1){let o=publishARProjs.result[e].target_ids[0],a=t.sceneTargetList.findIndex((e=>e.target_id==o));r.GCSSID=a}else r.GCSSID=e;return r.loadedObjects=!1,r.matrixAutoUpdate=!1,this.threeNFTMarkers2D[e]=r,r},ARController.prototype.createThreeNFTMarkerCSS=function(e){var t=new THREE.Object3D;return t.visible=!1,t.GCSSID=e,t.loadedObjects=!1,t.matrixAutoUpdate=!1,this.threeNFTMarkersCSS[e]=t,t},ARController.prototype.createThreeMultiMarker=function(e){this.setupThree();var t=new THREE.Object3D;return t.matrixAutoUpdate=!1,t.markers=[],this.threeMultiMarkers[e]=t,t},ARController.prototype.createThreeBarcodeMarker=function(e,t){this.setupThree();var r=new THREE.Object3D;return r.markerTracker=this.trackBarcodeMarkerId(e,t),r.matrixAutoUpdate=!1,this.threeBarcodeMarkers[e]=r,r},ARController.prototype.setupThree=function(){if(!this.THREE_JS_ENABLED){this.THREE_JS_ENABLED=!0;var t=this;this.addEventListener("loadNFTDone",(function(e){t.gcssTargets=e.data})),this.addEventListener("getMarker",(function(e){e.data.marker})),this.addEventListener("getFrameTarget",(function(e){if(console.log("three.js, listened getFrameTarget, ev=",e),e.data.index<0){if(console.log("three.js: listened getFrameTarget index < 0, return ",this.threeNFTMarkers2D[-3]),this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name){this.threeNFTMarkers2D[-3].visible=!0;let e=this;setTimeout((function(){e.threeNFTMarkers2D[-3].visible=!1}),2e3)}}else{this.threeNFTMarkers2D[-3]&&"note1"==this.threeNFTMarkers2D[-3].name&&(this.threeNFTMarkers2D[-3].visible=!1);var r=e.data.uArray,o=new ImageData(r,256,256);this.targetCtx.putImageData(o,0,0);let a=this.aframeNFTMarkers[t.sceneTargetList[e.data.index].projIndex],n=this.threeNFTMarkers2D[t.sceneTargetList[e.data.index].projIndex],i=this.threeNFTMarkersCSS[t.sceneTargetList[e.data.index].projIndex];console.log("artk.three.js, listened getFrameTarget, obj=",a,"\nobj2D=",n),console.log(" ************* ",e.data.index,t.sceneTargetList[e.data.index].projIndex),a.coloringStatus=1,a.loadModel=!0,t.loadMakarScene(e.data.index,a,n,i)}})),this.addEventListener("getNFTMarkerDraw",(function(e){let r=e.data.marker,o=this.aframeNFTMarkers[t.sceneTargetList[r.id].projIndex],a=this.threeNFTMarkers2D[t.sceneTargetList[r.id].projIndex],n=this.threeNFTMarkersCSS[t.sceneTargetList[r.id].projIndex];if(o){if(!o.loadedObjects||!a.loadedObjects){o.loadedObjects=a.loadedObjects=!0;let e=document.getElementById("clickToPlayAudio");e.style.display="none",e.onclick=null;let s=t.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[s].loc))if(publishARProjs.proj_list[s].loc.length>1&&publishARProjs.proj_list[s].module_type.find((function(e){return"gps"==e})))warnButtonTitle.textContent=l.comfirm[i],warnModalButton.onclick=function(){console.log("three.js: the warnModalButton is clicked "),warnModal.style.display="none",o.loadedObjects=a.loadedObjects=!1},navigator.geolocation?navigator.geolocation.getCurrentPosition((function(e){console.log("three.js: showProjectInfo: get Geolocation geoPosition=.",e.coords.latitude,e.coords.longitude);let c=function(e,t,r,o,a="M"){if(e==r&&t==o)return 0;{let n=Math.PI*e/180,i=Math.PI*r/180,l=n-i,s=Math.PI*t/180-Math.PI*o/180,c=2*Math.asin(Math.sqrt(Math.pow(Math.sin(l/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2)));return"M"==a&&(c*=6378137),console.log("three.js: calculateGeosToDistanceHaversine dist=",c),c}}(e.coords.latitude,e.coords.longitude,publishARProjs.proj_list[s].loc[0],publishARProjs.proj_list[s].loc[1]);getViewerConfig(serverUrl,(function(e){if(c<e.data.gps_range_distance){let e=t.loadMakarScene(r.id,o,a,n),i=t.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[i].xml_urls)&&publishARProjs.proj_list[i].xml_urls[0]){console.log("three.js: _getNFTMarkerDraw: _GPS get _logic xml ",i,publishARProjs.proj_list[i].xml_urls[0]);let r=t.parseLogicXML(i,0);e.push(r)}}else console.log("three.js: showProjectInfo: get Geolocation distance not allow",c),warnModal.style.display="block",warnModalInfo.textContent=l.GPSDistanceMsg[i]+Math.floor(c)+" meter"}))}),(function(e){console.log("three.js: showProjectInfo: get Geolocation err=.",e,e.code,e.message),warnModal.style.display="block",warnModalInfo.textContent=l.GPSErrorMsg[i]+"\r\n"+e.message}),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0}):(console.log("three.js: showProjectInfo: Geolocation is not supported by this browser."),warnModal.style.display="block",warnModalInfo.textContent=l.GPSnotSupportMsg[i]);else{let e=t.loadMakarScene(r.id,o,a,n),i=t.sceneTargetList[r.id].projIndex;if(Array.isArray(publishARProjs.proj_list[i].xml_urls)&&publishARProjs.proj_list[i].xml_urls[0]){console.log("three.js: _getNFTMarkerDraw: get _logic xml ",i,publishARProjs.proj_list[i].xml_urls[0]);let r=t.parseLogicXML(i,0);e.push(r)}}}if(r.found>0){if(this.currentProjectIndex=t.sceneTargetList[r.id].projIndex,2==r.found){o.targetState=2,t.logicList[t.currentProjectIndex]&&0==t.logicList[t.currentProjectIndex].logicSystemState&&t.logicList[t.currentProjectIndex].parseXML();var s=this.checkColoring(t.sceneTargetList[r.id].projIndex,o,a,e.data.marker.allowColor);1==s?parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="block"):0==s&&parent&&parent.pictureBackground&&parent.pictureBackground.style&&(parent.pictureBackground.style.display="none")}else if(o.targetState=1,addScanTimesByTargetID(window.serverUrl,publishARProjs.user_id,t.sceneTargetList[r.id].target_id),this.activeAndClearScene(e.data.marker.id),o.object3D&&o.object3D.children.length>0&&(o.object3D.traverse((function(e){e.originTransform&&(e.position.copy(e.originTransform.position),e.rotation.copy(e.originTransform.rotation),e.scale.copy(e.originTransform.scale))})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1),t.camera.projectionMatrix.elements[8]=t.bkCamera.projectionMatrix.elements[8],t.camera.projectionMatrixInverse.getInverse)t.camera.projectionMatrixInverse.getInverse(t.camera.projectionMatrix);else{let e=t.camera.projectionMatrix.clone();t.camera.projectionMatrixInverse.copy(e.invert())}o.object3D.matrix.fromArray(e.data.matrix)}else if(o.object3D.visible=!1,console.log("three.js: losing: obj= ",o,e.data.marker.id),this.checkColoring(e.data.marker.id,o,a,0),1==o.showObjects){if(o.targetState=0,arController.logicList[arController.currentProjectIndex]&&arController.logicList[arController.currentProjectIndex].stopLogic(),t.camera.projectionMatrix.elements[8]=0,t.camera.projectionMatrixInverse.getInverse)t.camera.projectionMatrixInverse.getInverse(t.camera.projectionMatrix);else{let e=t.camera.projectionMatrix.clone();t.camera.projectionMatrixInverse.copy(e.invert())}let r=e.data.marker.id,a=25.4*t.gcssTargets.width[r]/t.gcssTargets.dpi[r]/2;o.object3D.visible=!0,o.object3D.matrixAutoUpdate=!0,o.object3D.position.set(-a,40,250),o.object3D.rotation.x=90*Math.PI/180,o.object3D.updateMatrix(),o.object3D.updateMatrixWorld(),o.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;if(e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"image"==e.makarType||"video"==e.makarType){let t=e.getWorldQuaternion(new THREE.Quaternion),r=new THREE.Euler;r.setFromQuaternion(t),e.rotateOnAxis(new THREE.Vector3(0,1,0),0-r.y),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI-r.x),e.updateMatrixWorld(),e.updateMatrix()}"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),o.object3D.updateMatrix(),o.object3D.matrixAutoUpdate=!1}}})),this.addEventListener("getMultiMarker",(function(e){var t=this.threeMultiMarkers[e.data.multiMarkerId];t&&(t.matrix.elements.set(e.data.matrix),t.visible=!0)})),this.addEventListener("getMultiMarkerSub",(function(e){var t=e.data.multiMarkerId,r=e.data.markerIndex,o=e.data.marker,a=this.threeMultiMarkers[t];if(a&&a.markers&&a.markers[r]){var n=a.markers[r];n.matrix.elements.set(e.data.matrix),n.visible=o.visible>=0}})),this.threePatternMarkers={},this.threeNFTMarkers={},this.aframeNFTMarkers={},this.threeBarcodeMarkers={},this.threeMultiMarkers={},this.threeNFTMarkers2D={},this.threeNFTMarkersCSS={},this.currentProjectIndex=null,this.objectControlState=null,this.quizModule=[],this.logicList=[],this.controlObject=null,this.currentControllObject=null,this.makarObjects=[],this.makarObjects2D=[],this.sceneTargetList=null,this.groupDict={0:{activeObj:null,objs:[]},1:{activeObj:null,objs:[]},2:{activeObj:null,objs:[]},3:{activeObj:null,objs:[]},4:{activeObj:null,objs:[]},5:{activeObj:null,objs:[]},6:{activeObj:null,objs:[]},7:{activeObj:null,objs:[]}},this.groupEventTargetDict={},this.lookAtTargetDict={},this.lookAtObjectList=[],this.lookAtTargetTimelineDict={},this.gcssTargets={},this.checkVideoOpt=function(e,t){for(let r=0;r<e.children.length;r++)1==e.children[r].makarObject&&e.children[r].mp4Video&&(t?e.children[r].mp4Video.play():e.children[r].mp4Video.pause())},this.checkAudioOpt=function(e,t){for(var r in e.children)e.children[r]&&e.children[r]&&e.children[r].type&&"Audio"==e.children[r].type&&(1==t?0==e.children[r].isPlaying&&(console.log("audio laod and play, ",e.children[r]),e.children[r].offset=0,e.children[r].play()):0==t&&1==e.children[r].isPlaying&&e.children[r].pause())},this.checkAimation=function(e,t){if(e.animationSlices&&e.animationSlices[0].uid){var r;for(let t=1;t<e.animationSlices.length;t++)e.animationSlices[0].uid==e.animationSlices[t].uid&&(r=t);if(e.animationSlices[0].changed&&(e.mixer._actions[0].time=e.animationSlices[r].startTime,e.animationSlices[0].changed=!1,e.animationSlices[0].count=0),!e.animationSlices[0].reset&&1==e.animationSlices[0].count)return void(e.mixer._actions[0].time=e.animationSlices[r].endTime);if(e.mixer._actions[0].time<e.animationSlices[r].startTime&&(e.mixer._actions[0].time=e.animationSlices[r].startTime),e.mixer._actions[0].time+0>e.animationSlices[r].endTime){if(e.animationSlices[0].uid==e.animationSlices[0].loop)e.mixer._actions[0].time=e.animationSlices[r].startTime;else if(e.animationSlices[0].reset){let t;e.animationSlices[0].uid=e.animationSlices[0].idle,e.animationSlices[0].loop=e.animationSlices[0].idle;for(let r=1;r<e.animationSlices.length;r++)if(e.animationSlices[0].uid==e.animationSlices[r].uid){t=r;for(let t=0;t<e.mixer._actions.length;t++)e.mixer._actions[t].stop();let o=e.animations.findIndex((function(r){return r.name==e.animationSlices[t].animationName}));e.mixer=new THREE.AnimationMixer(e),e.mixer.clipAction(e.animations[o]).play()}e.mixer._actions[0].time=e.animationSlices[t].startTime}e.animationSlices[0].count=1,e.mixer&&e.mixer.update(1e-6)}else e.mixer&&e.mixer.update(t)}},this.checkColoring=function(e,r,o,a){let n=t.sceneTargetList[e].projIndex;if("coloring"==window.sceneResult[n].module){if(1!=r.loadModel){if(1==a){for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=0,r.object3D.children[e].material.color.g=1);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=1,o.children[e].behav[0].enable=!0)}else{for(let e in r.object3D.children)"coloredPlane"==r.object3D.children[e].name&&(r.object3D.children[e].material.color.r=1,r.object3D.children[e].material.color.g=0);for(let e in o.children)"colorButton"==o.children[e].name&&(o.children[e].material.opacity=.3,o.children[e].behav[0].enable=!1)}return 0}return 1}return-1},this.dealImageUrl=function(e){let r="";return userProjResDict[e.res_id]?(console.log("three.js: _dealImageUrl: image from user resource"),e.res_url!=userProjResDict[e.res_id].res_url&&console.log("three.js: _dealImageUrl: image from user resource, but difference ",e.res_url,userProjResDict[e.res_id].res_url),e.res_url=userProjResDict[e.res_id].res_url,r=t.getDefaultImageUrl(e.res_url),e.res_url=r):userOnlineResDict[e.res_id]?(console.log("three.js: _dealImageUrl: image from online resource",userOnlineResDict[e.res_id].res_url),e.res_url!=userOnlineResDict[e.res_id].res_url&&console.log("three.js: _dealImageUrl: image from online resource, but difference ",e.res_url,userOnlineResDict[e.res_id].res_url),e.res_url=userOnlineResDict[e.res_id].res_url,r=t.getDefaultImageUrl(e.res_url),e.res_url=r):(console.log("three.js: _dealImageUrl: image not in user/online resource",e),r=t.getDefaultImageUrl(e.res_url),e.res_url=r),r},this.getDefaultImageUrl=function(e){let t="";if(e.indexOf("https")>-1)return console.log("three.js: _getDefaultImageUrl: contain [https] direct return, imageStr=",e),e;switch(e){case"DefaultResource/Image/MakAR_Call.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Call"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"DefaultResource/Image/MakAR_Room.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Room"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"DefaultResource/Image/MakAR_Mail.png":console.log("three.js: _getDefaultImageUrl: image: MakAR_Mail"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"DefaultResource/Image/Line_icon.png":console.log("three.js: _getDefaultImageUrl: image: Line_icon"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"DefaultResource/Image/FB_icon.png":console.log("three.js: _getDefaultImageUrl: image: FB_icon"),t="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;case"DefaultResource/ProjectModule/ScratchCardBackground.png":console.log("three.js: _getDefaultImageUrl: image: ScratchCardBackground"),t="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCardBackground.png";break;default:t="https://mifly0makar0assets.s3.ap-northeast-1.amazonaws.com/DefaultResource/2D/icon/qm256.png",console.log("three.js: _getDefaultImageUrl: unknown, obj=",e)}return t},this.getUserRes_onlineRes=function(e){if(userProjResDict[e.res_id])console.log("three.js: _getUserRes_onlineRes: model from user resource"),e.res_url=userProjResDict[e.res_id].res_url;else if(userOnlineResDict[e.res_id])console.log("three.js: _getUserRes_onlineRes: model from online resource",userOnlineResDict[e.res_id].res_url),e.res_url=userOnlineResDict[e.res_id].res_url;else switch(e.res_id){case"Cube":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb";break;case"Capsule":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb";break;case"Sphere":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb";break;case"ch_Bojue":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb";break;case"ch_Fei":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb";break;case"ch_Lina":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb";break;case"ch_Poyuan":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb";break;case"ch_Roger":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb";break;default:e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",console.log("three.js: _loadSceneObjects: model not exist show missing model ")}return e.res_url},this.countObject2D=function(e){let t=0;for(let r=0;r<e.length;r++){let o=e[r];"2d"==o.obj_type&&("image"==o.main_type&&t++,"module"==o.main_type&&"scratch_card"==o.sub_type&&t++)}return t},this.getMakarObjectByObjID=function(e,t){for(let r in e)if(e[r].obj_id==t)return e[r];return console.error("three.js: _getMakarObjectByObjID: get null object ",t,e),null},this.loadAssets=function(e){let r=document.createElement("a-assets");r.setAttribute("id","makarAssets"),r.setAttribute("timeout","1000"),t.arfScene.appendChild(r)},this.getProjectVersion=function(e){let t=[],r=e;return"string"!=typeof window.sceneResult[r].data.editor_ver?(console.log("three.js: _loadMakarScene: the editor_ver is not string, error and return "),-1):(t=window.sceneResult[r].data.editor_ver.split("."),t)},this.getResolutionIndex=function(e){let t=e,r=0,o=this.arScene.clientWidth,a=this.arScene.clientHeight;if(sceneResult[t]&&sceneResult[t].data.scene_objs_v2&&sceneResult[t].data.scene_objs_v2.screen&&Array.isArray(sceneResult[t].data.scene_objs_v2.screen.orientationData)){let e=sceneResult[t].data.scene_objs_v2.screen.orientationData,n=1e4;e.forEach(((e,t)=>{let i=e.width/e.height/(o/a),l=e.width/o,s=e.height/a,c=i>1?i:1/i,d=l>1?l:1/l,u=s>1?s:1/s;e.nrdScore=c*(d+u),e.nrdScore<n&&(n=e.nrdScore,r=t)}));let i=e[r];tempR=String(i.width)+","+String(i.height),console.log(" _getResolutionIndex: ",n,r,i,tempR)}else console.log(" _getResolutionIndex: error",t,sceneResult);return r},this.get2DScaleRatioByProjIndex=function(e){let t,r,o,a=this,n=e,i=a.getProjectVersion(n),l="";if(Array.isArray(i)&&3==i.length){let e=Number(i[0]),t=Number(i[1]),r=Number(i[2]);l=e>3||3==e&&t>3||3==e&&3==t&&r>8?s():function(){let e="";return sceneResult[n]&&sceneResult[n].data.scene_objs_v2&&sceneResult[n].data.scene_objs_v2.resolution&&(e=sceneResult[n].data.scene_objs_v2.resolution),e}()}else l=s();function s(){let e="",t=a.arScene.clientWidth,r=a.arScene.clientHeight;if(sceneResult[n]&&sceneResult[n].data.scene_objs_v2&&sceneResult[n].data.scene_objs_v2.screen&&Array.isArray(sceneResult[n].data.scene_objs_v2.screen.orientationData)){let o=sceneResult[n].data.scene_objs_v2.screen.orientationData,i=1e3,l=0;o.forEach(((e,o)=>{let a=e.width/e.height/(t/r),n=e.width/t,s=e.height/r,c=a>1?a:1/a,d=n>1?n:1/n,u=s>1?s:1/s;e.nrdScore=c*(d+u),e.nrdScore<i&&(i=e.nrdScore,l=o)}));let s=o[l];a.selectedResolutionIndex=l,e=String(s.width)+","+String(s.height),console.log(" _getResolution338: ",i,l,s,e)}return e}if(""==l&&(console.log(" _get2DScaleRatio: fucking lose resolutionString "),l="720,1280"),""!=l){let e=l.split(","),n=Number(e[0]),i=Number(e[1]),s=a.arfScene.clientWidth,c=a.arfScene.clientHeight;if(r=Math.abs(a.camera2D.right-a.camera2D.left),o=Math.abs(a.camera2D.bottom-a.camera2D.top),r/o>=s/c)s/c>=n/i?(t=c*(n/i)/n,console.log(" _get2DScaleRatio: 1 ",n,i,s,c,t)):(t=s/n,console.log(" _get2DScaleRatio: 2 ",n,i,s,c,t));else if(s/c>=n/i){let e=c*(n/i),a=c/(s*(o/r)),l=e/s,d=e/n;t=d,console.log(" _get2DScaleRatio: 3 ",n,i,s,c,t,a,l,d)}else{let e=c/(s*(o/r)),a=s*(i/n)/c,l=s/n;t=l,console.log(" _get2DScaleRatio: 4 ",n,i,s,c,t,e,a,l)}}else console.log(" fucking lose resolutionString ");return console.log(" _get2DScaleRatio: srxy=",t),t},this.editorVersionControllObjs=function(e){let t=e,r=window.sceneResult[t].data.scene_objs_v2;var o;if("string"!=typeof window.sceneResult[t].data.editor_ver)return console.log("three.js: _loadMakarScene: the editor_ver is not string, error and return "),-1;if(o=window.sceneResult[t].data.editor_ver.split("."),""==window.sceneResult[t].data.editor_ver){if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version empty. scene=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2}else if(3==o[0]&&0==o[1]&&o[2]<=6){if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version before 3.0.9, version=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2}else if(o[0]>=3&&(0==o[1]&&o[2]>=7||o[1]>=1))console.log("three.js: _loadMakarScene: the editor version after 3.0.7, version=",window.sceneResult[t]),r=window.sceneResult[t].data.scene_objs_v2.objs;else{if(!Array.isArray(window.sceneResult[t].data.scene_objs_v2))return console.log("three.js: _loadMakarScene the scene_objs_v2 is not Array, error",window.sceneResult[t]),-1;console.log("three.js: _loadMakarScene: the editor version unknown, use the 3.0.6 structure , please contact MIFLY for more information, sceneResult=",sceneResult),r=window.sceneResult[t].data.scene_objs_v2}return r},this.loadMakarScene=function(r,o,a,n){let s=t.sceneTargetList[r].projIndex;console.log("makar.three.js: _loadMakarScene, window.sceneResult[",s,"] = ",window.sceneResult[s]);let c=[];t.projStartTimeList.push({projIndex:s,time:(new Date).getTime()}),t.checkARSceneResultBehav(s),t.groupEventTargetDict[s]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",s):t.groupEventTargetDict[s]=JSON.parse(JSON.stringify(t.groupDict)),t.lookAtTargetDict[s]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",s):t.lookAtTargetDict[s]=[],t.lookAtTargetTimelineDict[s]?console.log("_loadMakarScene: _groupEventTargetDict: already exist ",s):t.lookAtTargetTimelineDict[s]=[];let d=window.sceneResult[s].data.scene_objs_v2;if(d=t.editorVersionControllObjs(s),!Array.isArray(d))return[];if(t.countObject2D(d),Array.isArray(window.sceneResult[s].data.module_type)){let _;if(0==window.sceneResult[s].data.module_type.length)console.log("three.js: _loadMakarScene: module_type is empty");else if(1==window.sceneResult[s].data.module_type.length)_=window.sceneResult[s].data.module_type[0],console.log("three.js: _loadMakarScene: only one module, ",_);else{let f,j=0;for(let y=0;y<window.sceneResult[s].data.module_type.length;y++)f=window.sceneResult[s].data.module_type[y],"gps"!=f&&("coloring"==f||"scratch_card"==f||"point_card"==f?(console.log("three.js: _loadMakarScene: detect module=",f),j++,_=f):console.log("three.js: _loadMakarScene: unknown modules, ",f));console.log("three.js: _loadMakarScene: currently not support mutiple modules, ",window.sceneResult[s].data.module_type)}if(_)switch(_){case"coloring":if(o.loadModule="coloring",1!=o.loadModel){o.showObjects=!1,o.coloringStatus=-1;var u=t.gcssTargets.dpi[o.GCSSID],m=t.gcssTargets.width[o.GCSSID],p=t.gcssTargets.height[o.GCSSID],h=new THREE.Mesh(new THREE.PlaneGeometry(1,1),new THREE.MeshBasicMaterial({transparent:!0,opacity:.25,color:new THREE.Color("rgb(255,0,0)")}));let w;h.position.set(25.4*m/u/2,25.4*p/u/2,0),h.updateMatrix(),w=new THREE.Vector3(25.4*m/u/2,25.4*p/u/2,.1),h.scale.copy(w.multiplyScalar(2)),h.name="coloredPlane",o.object3D.add(h),t.loadDeaultTexture2D(a,"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/coloring2.png",new THREE.Vector3(0,50,0),new THREE.Vector3(0,0,0),new THREE.Vector3(.3,.3,.3),[.5,0],{simple_behav:"coloring"})}else{o.object3D.remove(o.object3D.children[0]),a.remove(a.children[0]),o.showObjects=!0;for(let v in d){let E=(new THREE.Vector3).fromArray(d[v].transform[0].split(",").map((function(e){return Number(e)}))),k=(new THREE.Vector3).fromArray(d[v].transform[1].split(",").map((function(e){return Number(e)}))),T=(new THREE.Vector3).fromArray(d[v].transform[2].split(",").map((function(e){return Number(e)})));switch(d[v].main_type){case"model":console.log("three.js: Module: color model 3d, res =",d[v]),t.loadAframeGLTFModelWithTexture(o,d[v],t.targetCanvas,E,k,T,t.cubeTex),console.log("three.js: _loadMakarScene: coloring module, load GLTF Model done ");break;case"video":"mp4"==d[v].sub_type&&(d[v].res_url&&d[v].transform?(console.log("three.js: video mp4 3d, obj with url and transform: ",d[v]),t.loadAframeVideo(o,d[v],E,k,T)):console.log("three.js: video mp4 3d, obj without url and transform(fail): ",d[v]));break;case"text":console.log("three.js: _loadText: text: ",v,d[v]),"3d"==d[v].obj_type?t.loadAframeText(o,scene_obj,E,k,T):"2d"==d[v].obj_type&&t.loadAframeText2D(a,d[v],v,d.length,E,k,T);break;case"audio":"mp3"!=d[v].sub_type&&"wav"!=d[v].sub_type&&"ogg"!=d[v].sub_type||(d[v].res_url&&d[v].transform?t.loadAframeAudio(o,d[v],E,k,T):console.log("three.js: audio mp4 3d, obj without url and transform(fail): ",d[v]));break;case"image":let A=d[v].res_url;A=t.dealImageUrl(d[v]),"3d"==d[v].obj_type&&(A&&d[v].transform?t.loadAframeTexture(o,A,d[v],E,k,T):console.log("three.js: image 3d, obj without url and transform(fail): ",d[v])),"2d"==d[v].obj_type&&(A&&d[v].transform?(console.log("three.js: image 2d, obj with url and transform(success): ",d[v]),t.loadAframeTexture2D(a,d[v],A,v,d.length,E,k,T)):console.log("three.js: image 2d, obj without url and transform(fail): ",d[v]));break;case"light":t.loadAframeLight(o,d[v],E,k,T)}}console.log("three.js: _loadMakarScene: coloring module, already catch target, markerRoot = ",o.children)}return console.log("three.js: _loadMakarScene: coloring module, return "),c;case"scratch_card":if(console.log("three.js:_loadMakarScene: scratch_card module ",d,publishARProjs.proj_list[s],window.sceneResult[s]),!parent.mdb)return[];if(parent.userlogin);else{for(let D in d){let S=(new THREE.Vector3).fromArray(d[D].transform[0].split(",").map((function(e){return Number(e)}))),x=(new THREE.Vector3).fromArray(d[D].transform[1].split(",").map((function(e){return Number(e)}))),R=(new THREE.Vector3).fromArray(d[D].transform[2].split(",").map((function(e){return Number(e)})));if("scratch_card"==d[D].res_id&&"scratch_card"==d[D].sub_type&&Array.isArray(d[D].project_module)&&1==d[D].project_module.length){let M;M=(new Date).getTime()+"_"+e(10),localStorage.setItem("device_id",M);let C={user_id:publishARProjs.proj_list[s].user_id,playing_user:"",proj_id:publishARProjs.proj_list[s].proj_id,proj_type:"ar",card_id:d[D].project_module[0].card_id,device_id:M,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};parent.mdb.initProject(C).then((function(e){t.loadCanvas2D(a,d[D],(new THREE.Vector3).fromArray(d[D].transform[0].split(",").map((function(e){return Number(e)}))),(new THREE.Vector3).fromArray(d[D].transform[1].split(",").map((function(e){return Number(e)}))),(new THREE.Vector3).fromArray(d[D].transform[2].split(",").map((function(e){return Number(e)}))),(function(e){parent.mdb.getScratchProject(publishARProjs.proj_list[s].proj_id).then((r=>{let o;switch(r.scratchCardState){case 0:o=aScratchCard.randomChooseAward(d[D]),r.getAwardIndex=o,r.scratchCardState=1,r.scratch_image_url=d[D].project_module[0].scratch_image_url;var n=t.getDefaultImageUrl(d[D].project_module[0].award_list[o].image_url);r.awards_image_url=n,parent.mdb.setScratchProject(r),C.issuance_card=!0,C.award_list=d[D].project_module[0].award_list,console.log("three.js: scratch card init : upload to server",C),scratchCardLog(window.serverUrl,C);break;case 1:console.log("three.js: _loadMakarScene: scratch_card state[1], set award",r.getAwardIndex,e),o=r.getAwardIndex;break;case 2:console.log("three.js: _loadMakarScene: scratch_card state[2], clear scratch canvas",r.getAwardIndex,e),o=r.getAwardIndex,aScratchCard.clearScratchCanvas(e);break;case 3:console.log("three.js: _loadMakarScene: scratch_card state[3], already exchange",r.getAwardIndex,e),o=r.getAwardIndex,e.exchanged=1,aScratchCard.clearScratchCanvas(e);break;default:console.log("three.js: _loadMakarScene: scratch_card state unknow, projRet=",r)}let i=d[D].project_module[0].award_list[o].image_url;(n=t.getDefaultImageUrl(i)).indexOf("https")>=0?(d[D].sub_type="jpg",t.loadAframeTexture2D(a,d[D],n,D,d.length,S,x,R)):console.error("three.js: _loadMakarScene: scratch_card error, sceneObject.project_module[0].award_list not include [https]",d[D].project_module[0].award_list)}))}))}))}}a.loadModule="scratchCard"}break;case"point_card":if(console.log("three.js: _loadMakarScene: module point_card processing ",window.sceneResult[s].data.module_type[0],d,a),!parent.mdb)return[];a.module="PointCard",a.loadModule="pointCard";for(let I in d)if("module"==d[I].main_type&&"point_card"==d[I].sub_type){a.project_module=d[I].project_module[0],a.proj_id=publishARProjs.proj_list[s].proj_id;let P,H=(new THREE.Vector3).fromArray(d[I].transform[0].split(",").map((function(e){return Number(e)}))),B=(new THREE.Vector3).fromArray(d[I].transform[1].split(",").map((function(e){return Number(e)}))),O=(new THREE.Vector3).fromArray(d[I].transform[2].split(",").map((function(e){return Number(e)})));P=""==d[I].project_module[0].bg_image_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/PointCard_Background.png":d[I].project_module[0].bg_image_url,d[I].sub_type="jpg",t.loadAframeTexture2D(a,d[I],P,I,d.length,H,B,O),parent.userlogin;{let V;V=(new Date).getTime()+"_"+e(10),localStorage.setItem("device_id",V);let F=publishARProjs.proj_list[s];aPointCard.createPointCardContent(a),aPointCard.getPointCardProject(publishARProjs.proj_list[s].proj_id,(e=>{console.log("three.js: load pointCard, first get, getProjRet = ",e);let o=d[I].project_module[0].points.find((function(e){return e.target_id==t.sceneTargetList[r].target_id}));if(e.proj_id)aPointCard.addPoint(e,o.target_id,(function(r){for(let n=0;n<a.project_module.points.length;n++){let i=a.project_module.points[n],l=(new THREE.Vector3).fromArray(i.transform[0].split(",").map((function(e){return Number(e)}))),s=(new THREE.Vector3).fromArray(i.transform[1].split(",").map((function(e){return Number(e)}))),c=(new THREE.Vector3).fromArray(i.transform[2].split(",").map((function(e){return Number(e)})));if(r.collected_points.find((function(e){return e==a.project_module.points[n].target_id}))){""==a.project_module.points[n].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=a.project_module.points[n].collected_point_url,i.sub_type="jpg",t.loadAframeTexture2D(a,i,point_after_url,I+1,d.length,l,s,c).then((function(e){t.runAnimation2D(e,u)})),a.project_module.points[n].collected=!0;let u={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0};if(e!=r&&o.target_id==a.project_module.points[n].target_id){console.log(" three.js: _loadPointCard: new target =",a.project_module.points[n]);let e={user_id:r.user_id,playing_user:"",proj_id:r.proj_id,proj_type:"ar",card_id:r.card_id,device_id:r.device_id,can_reward_point_count:r.can_reward_point_count,target_id:o.target_id,target_img_url:a.project_module.points[n].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};pointCardLog(window.serverUrl,e)}}else{let e;e=""==a.project_module.points[n].uncollected_point_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png":a.project_module.points[n].uncollected_point_url,i.sub_type="jpg",t.loadAframeTexture2D(a,i,e,I+1,d.length,l,s,c),a.project_module.points[n].collected=!1}}aPointCard.showPointCardCanvas(a,r.collected_points.length-d[I].project_module[0].can_reward_point_count,e.is_exchanged)}));else{console.log(" ******** there are no project: getPointTarget ",o,e);let r={user_id:F.user_id,proj_id:F.proj_id,device_id:V,card_id:d[I].project_module[0].card_id,is_exchanged:!1,can_reward_point_count:d[I].project_module[0].can_reward_point_count,collected_points:[o.target_id],type:"point_card"};aPointCard.setPointCardProject(r,(r=>{console.log(" 1 ------------ setProjRet = ",r);for(let e=0;e<a.project_module.points.length;e++){let r=a.project_module.points[e],n=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)})));if(o.target_id==a.project_module.points[e].target_id){""==a.project_module.points[e].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=a.project_module.points[e].collected_point_url,r.sub_type="jpg",t.loadAframeTexture2D(a,r,point_after_url,I+1,d.length,n,i,l).then((function(e){t.runAnimation2D(e,s)})),a.project_module.points[e].collected=!0;let s={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0},c={user_id:F.user_id,playing_user:"",proj_id:F.proj_id,proj_type:"ar",card_id:d[I].project_module[0].card_id,device_id:V,can_reward_point_count:d[I].project_module[0].can_reward_point_count,target_id:o.target_id,target_img_url:a.project_module.points[e].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};pointCardLog(window.serverUrl,c)}else{let o;o=""==a.project_module.points[e].uncollected_point_url?"https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_Before.png":a.project_module.points[e].uncollected_point_url,r.sub_type="jpg",t.loadAframeTexture2D(a,r,o,I+1,d.length,n,i,l),a.project_module.points[e].collected=!1}}aPointCard.showPointCardCanvas(a,1-d[I].project_module[0].can_reward_point_count,e.is_exchanged)}))}}))}}break;case"quiz":console.log("three.js: _loadMakarScene: quiz module ",window.sceneResult[s],_,d),o.loadModule=a.loadModule="quiz";for(let L=0,z=d.length;L<z;L++){let N=d[L],U=(new THREE.Vector3).fromArray(N.transform[0].split(",").map((function(e){return Number(e)}))),q=(new THREE.Vector3).fromArray(N.transform[1].split(",").map((function(e){return Number(e)}))),G=(new THREE.Vector3).fromArray(N.transform[2].split(",").map((function(e){return Number(e)}))),W=document.getElementById("startQuiz"),Q=document.getElementById("QuizStartButton");if("2d"==N.obj_type&&"quiz"==N.sub_type){function b(){t.load2DQuiz(a,N,U,q,G),W.style.display="none",a.visible=!0}function g(){W.style.display="none",a.visible=!0,Q.onclick=null}W.style.display="block";let X=window.serverUrl,Y=localStorage.getItem("login_shared_id"),Z=publishARProjs.proj_list[s].proj_id;1==N.module[0].force_login?Y?0==N.module[0].allow_retry?(console.log("AR.js: _getRecordModule: get remote: ",Y,Z),getRecordModule(X,Y,Z,(function(e){console.log("AR.js: _getRecordModule: ret= ",e),e.data.record_module_list?(QuizStartContent.textContent=l.userAlreadyPlayed[i],Q.onclick=g):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=b)}))):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=b):(QuizStartContent.textContent=l.userNotLoginInfo[i],Q.onclick=g):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=b)}if("3d"==N.obj_type&&"quiz"==N.sub_type){W.style.display="block";let J=function(){t.loadQuiz(o,N,U,q,G),W.style.display="none",o.visible=!0,Q.removeEventListener("click",J)},K=function(){W.style.display="none",Q.removeEventListener("click",K)},$=window.serverUrl,ee=localStorage.getItem("login_shared_id"),te=publishARProjs.proj_list[s].proj_id;1==d[L].module[0].force_login?ee?0==d[L].module[0].allow_retry?(console.log("AR.js: _getRecordModule: get remote: ",ee,te),getRecordModule($,ee,te,(function(e){console.log("AR.js: _getRecordModule: ret= ",e),e.data.record_module_list?(QuizStartContent.textContent=l.userAlreadyPlayed[i],Q.onclick=K):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=J)}))):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=J):(QuizStartContent.textContent=l.userNotLoginInfo[i],Q.onclick=K):(QuizStartContent.textContent=l.clickToPlay[i],Q.onclick=J)}}break;default:console.log("three.js: _loadMakarScene: unknown module type ",window.sceneResult[s].data.module_type[0],_)}}for(let re in d){let oe=d[re],ae=(new THREE.Vector3).fromArray(oe.transform[0].split(",").map((function(e){return Number(e)}))),ne=(new THREE.Vector3).fromArray(oe.transform[1].split(",").map((function(e){return Number(e)}))),ie=(new THREE.Vector3).fromArray(oe.transform[2].split(",").map((function(e){return Number(e)})));switch(oe.main_type){case"model":if(userProjResDict[oe.res_id])console.log("three.js: _loadSceneObjects: model from user resource"),oe.res_url=userProjResDict[oe.res_id].res_url;else if(userOnlineResDict[oe.res_id])console.log("three.js: _loadSceneObjects: model from online resource",userOnlineResDict[oe.res_id].res_url),oe.res_url=userOnlineResDict[oe.res_id].res_url;else switch(oe.res_id){case"Cube":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Cube.glb";break;case"Capsule":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Capsule.glb";break;case"Sphere":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/Sphere.glb";break;case"ch_Bojue":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Bojue.glb";break;case"ch_Fei":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Fei.glb";break;case"ch_Lina":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Lina.glb";break;case"ch_Poyuan":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Poyuan.glb";break;case"ch_Roger":oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/ch_Roger.glb";break;default:if(d[s].res_gltf_resource)break;oe.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",oe.material=[],console.log("three.js: _loadSceneObjects: model not exist show missing model ")}if(oe.res_url&&oe.transform){console.log("three.js: model 3d, obj with url and transform: ",oe);let ce=t.loadAframeGLTFModel(o,oe,ae,ne,ie,t.cubeTex);c.push(ce)}else console.log("three.js: model 3d, obj without url or transform(fail): ",oe);o.visible=!0;break;case"video":if("mp4"==d[re].sub_type)if(d[re].res_url&&d[re].transform){console.log("three.js: video mp4 3d, obj with url and transform: ",d[re]);let de=t.loadAframeVideo(o,d[re],ae,ne,ie);c.push(de)}else console.log("three.js: video mp4 3d, obj without url and transform(fail): ",d[re]);break;case"text":if("3d"==d[re].obj_type){let ue=t.loadAframeText(o,oe,ae,ne,ie);c.push(ue)}else"2d"==d[re].obj_type&&t.loadAframeText2D(a,d[re],re,d.length,ae,ne,ie);break;case"audio":if("mp3"==d[re].sub_type||"wav"==d[re].sub_type||"ogg"==d[re].sub_type)if(d[re].res_url&&d[re].transform){let me=t.loadAframeAudio(o,d[re],ae,ne,ie);c.push(me)}else console.log("three.js: audio mp4 3d, obj without url and transform(fail): ",d[re]);break;case"image":let le=d[re].res_url;if(le=t.dealImageUrl(d[re]),"3d"==d[re].obj_type)if(le&&d[re].transform){let pe=t.loadAframeTexture(o,le,d[re],ae,ne,ie);c.push(pe)}else console.log("three.js: image 3d, obj without url and transform(fail): ",d[re]);"2d"==d[re].obj_type&&(le&&d[re].transform?(console.log("three.js: image 2d, obj with url and transform(success): ",d[re]),t.loadAframeTexture2D(a,d[re],le,re,d.length,ae,ne,ie)):console.log("three.js: image 2d, obj without url and transform(fail): ",d[re]));break;case"module":break;case"light":let se=t.loadAframeLight(o,d[re],ae,ne,ie);c.push(se);break;default:console.log("three.js: type unknown show cube :",d[re])}}return c},this.activeAndClearScene=function(e){let r=t.sceneTargetList[e].projIndex;for(let e in this.aframeNFTMarkers)if(e==r)this.aframeNFTMarkers[e].object3D.visible=!0,this.threeNFTMarkers2D[e].visible=!0,this.aframeNFTMarkers[e].object3D.traverse((function(e){1==e.getWorldVisible()&&("video"==e.makarType&&(1==window.Browser.mobile&&"safari"==window.Browser.name&&1!=window.allowAudioClicked||1!=window.allowAudioClicked&&location==parent.location?t.dealVideoMuted():e.el.mp4Video.play()),"audio"==e.makarType&&e.el.components.sound.playSound())}));else{if(this.aframeNFTMarkers[e].object3D.traverse((function(e){if("video"==e.makarType&&e.el.mp4Video.pause(),"audio"==e.makarType&&e.el.components.sound.stopSound(),e.behav_reference&&e.behav_reference.length>0)for(let t=0;t<e.behav_reference.length;t++)"ShowVideo"!=e.behav_reference[t].behav_name&&"ShowModel"!=e.behav_reference[t].behav_name&&"ShowImage"!=e.behav_reference[t].behav_name&&"PlayMusic"!=e.behav_reference[t].behav_name&&"ShowText"!=e.behav_reference[t].behav_name||e.el.setAttribute("visible",!1)})),this.aframeNFTMarkers[e].loadModule&&"quiz"==this.aframeNFTMarkers[e].loadModule){let o=this.aframeNFTMarkers[e];for(;o.children.length>0;)o.children[0].remove();for(let e=0;e<t.makarObjects.length;e++)null!=t.makarObjects[e].object3D.el&&null!=t.makarObjects[e].object3D.parent||t.makarObjects.splice(e,1);let a=document.getElementById("startQuiz");"quiz"==this.aframeNFTMarkers[r].loadModule||(a.style.display="none"),t.aframeNFTMarkers[e].loadedObjects=!1,t.threeNFTMarkers2D[e].loadedObjects=!1}if(0==this.aframeNFTMarkers[e].object3D.visible&&0==this.threeNFTMarkers2D[e].visible)continue;if(this.aframeNFTMarkers[e].object3D.visible=!1,this.threeNFTMarkers2D[e].visible=!1,this.threeNFTMarkers2D[e].loadModule)switch(this.threeNFTMarkers2D[e].loadModule){case"scratchCard":aScratchCard.hideScratchCanvas(this.threeNFTMarkers2D[e]);break;case"pointCard":console.log("three.js: recognize: _clearScene, processing pointCard "),aPointCard.hidePointCardCanvas(this.threeNFTMarkers2D[e]);break;case"coloring":console.log("three.js: recognize: _clearScene, not support coloring ");break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[e].loadModule)}}for(let o in this.threeNFTMarkers2D)if(o==r&&this.threeNFTMarkers2D[o].loadModule)switch(this.threeNFTMarkers2D[o].loadModule){case"scratchCard":aScratchCard.showScratchCanvas(this.threeNFTMarkers2D[o]);break;case"pointCard":console.log("three.js: recognize: _clearScene, pointCard processing ",t.threeNFTMarkers2D[o],publishARProjs.proj_list[o]),aPointCard.getPointCardProject(publishARProjs.proj_list[o].proj_id,(r=>{let a;console.log("three.js: _clearScene: _pointCard: getProjRet=",r),r.collected_points&&(a=r.collected_points.find((function(r){return r==t.sceneTargetList[e].target_id})),a?(console.log("three.js: _clearScene: _pointCard: already collected "),aPointCard.showPointCardCanvas(t.threeNFTMarkers2D[o],r.collected_points.length-t.threeNFTMarkers2D[o].project_module.can_reward_point_count,r.is_exchanged)):(console.log("three.js: _clearScene: _pointCard: not collected "),aPointCard.addPoint(r,t.sceneTargetList[e].target_id,(function(a){if(console.log("three.js: _clearScene: setProjRet",a),a.collected_points){for(let r=0;r<t.threeNFTMarkers2D[o].project_module.points.length;r++)if(t.threeNFTMarkers2D[o].project_module.points[r].target_id==t.sceneTargetList[e].target_id){""==t.threeNFTMarkers2D[o].project_module.points[r].collected_point_url?point_after_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/module/PointCard/PointCard_DefaultPoint_After.png":point_after_url=t.threeNFTMarkers2D[o].project_module.points[r].collected_point_url;let e=t.threeNFTMarkers2D[o].project_module.points[r],n=(new THREE.Vector3).fromArray(e.transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(e.transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(e.transform[2].split(",").map((function(e){return Number(e)})));e.sub_type="jpg",t.loadAframeTexture2D(t.threeNFTMarkers2D[o],e,point_after_url,t.threeNFTMarkers2D[o].children.length,t.threeNFTMarkers2D[o].children.length,n,i,l).then((function(e){t.runAnimation2D(e,s)})),t.threeNFTMarkers2D[o].project_module.points[r].collected=!0;let s={name:"runAnimation2D",dt:500,ds:new THREE.Vector3(2,2,2),reverse:!0},c={user_id:a.user_id,playing_user:"",proj_id:a.proj_id,proj_type:"ar",card_id:a.card_id,device_id:a.device_id,can_reward_point_count:a.can_reward_point_count,target_id:t.threeNFTMarkers2D[o].project_module.points[r].target_id,target_img_url:t.threeNFTMarkers2D[o].project_module.points[r].target_img_url,brand:Browser.name+Browser.version,os:Browser.platform,location_long:0,location_lan:0};console.log(" three.js: _clearScene: collect target upload=",c),pointCardLog(window.serverUrl,c)}aPointCard.showPointCardCanvas(t.threeNFTMarkers2D[o],a.collected_points.length-t.threeNFTMarkers2D[o].project_module.can_reward_point_count,r.is_exchanged)}else console.error("three.js: _clearScene: collected_points not exist, shouldnt happen ",t.threeNFTMarkers2D[o].project_module.points)}))))}));break;case"coloring":console.log("three.js: recognize: _clearScene, not support coloring ");break;default:console.log("three.js: recognize: _clearScene, not support unknown module",this.threeNFTMarkers2D[o].loadModule)}},this.load2DQuiz=function(e,o,a,n,i){console.log("three.js: _load2DQuiz : obj=",o);let l=new THREE.Object3D;l.obj_id=o.obj_id,l.makarType="quiz2D",l.makarObject=!0,e.add(l),t.makarObjects2D.push(l);let s=[];for(let e=0;e<o.module[0].question_list.length;e++)o.module[0].question_list[e].allowRandom&&s.push(e);if(!o.module[0].display_order_list||0==o.module[0].display_order_list.length)return;let c=0;for(let e=0;e<o.module[0].display_order_list.length;e++){let t=o.module[0].display_order_list[e].index;if(-1==t){let a=r(s.length),n=s[a];o.module[0].display_order_list[e].index=n,t=n,s.splice(a,1)}o.module[0].question_list[t].active_score&&(c+=1)}let d=o.module[0].display_order_list[0].index,u=o.module[0].question_list[d],m=-1;if("Total"==o.module[0].timer_type){m=o.module[0].total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(m/3600),t=Math.floor((m-3600*e)/60),r=m-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==o.module[0].timer_type){m=u.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(m/3600),t=Math.floor((m-3600*e)/60),r=m-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}let p=document.getElementById("tipButtonDiv");if(u.show_tips?(p.style.display="block",p.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=u.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):p.style.display="none",l.quizModule={json:o.module[0],quizObject:l,currentQuestionIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:c,record:new Array(o.module[0].question_list.length),timer:{currentTimer:null,counter:m},record_time:0,qClock:Date.now()},u.questions_json&&Array.isArray(u.questions_json))for(let r=0;r<u.questions_json.length;r++){let o=u.questions_json[r],a=(new THREE.Vector3).fromArray(u.questions_json[r].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(u.questions_json[r].transform[1].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(u.questions_json[r].transform[2].split(",").map((function(e){return Number(e)})));switch(u.questions_json[r].main_type){case"text":t.loadAframeText2D(e,o,r,u.questions_json.length,a,n,i);break;case"image":let l=o.res_url;l=t.dealImageUrl(o),t.loadAframeTexture2D(e,o,l,r,u.questions_json.length,a,n,i)}}if(u.options_json&&Array.isArray(u.options_json))for(let r=0;r<u.options_json.length;r++){let o,a=u.options_json[r],n=(new THREE.Vector3).fromArray(a.transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(a.transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(a.transform[2].split(",").map((function(e){return Number(e)}))),s=a.sub_type,c=a.res_url;switch(c=t.dealImageUrl(a),s){case"txt":o=t.loadAframeText2D(e,a,r,u.options_json.length,n,i,l);break;case"gif":case"jpg":case"jpeg":case"png":o=t.loadAframeTexture2D(e,a,c,r,u.options_json.length,n,i,l);break;case"button":c="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",o=t.loadAframeTexture2D(e,a,c,r,u.options_json.length,n,i,l)}"button"==s||"MutiOption_Text"!=u.option_type&&"MutiOption_Image"!=u.option_type||o.then((function(e){let t=e,r=new THREE.Vector3(0,0,0),o=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1));if(new THREE.Quaternion,"MutiOption_Text"==u.option_type){let e=t.children[0].children[1],a=e.scale.clone(),n=t.children[0].getWorldScale(new THREE.Vector3),i=Math.min(a.x*e.geometry.parameters.width,a.y*e.geometry.parameters.height,1e6);o.multiply(new THREE.Vector3(.8,.8,.8).multiplyScalar(i)),o.divide(n);let l=e.geometry.parameters.width*a.x,s=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",s.load(resUrl,(function(e){r.x=.5*-l-48*o.x;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(r.clone()),a.scale.copy(o.clone()),t.children[0].add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.children[0].add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",s.load(resUrl,(function(e){r.x=.5*-l-48*o.x;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(r.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),t.children[0].add(a)}))}else{let e=t.getWorldScale(new THREE.Vector3),a=t.scale.clone(),n=Math.max(a.x*t.children[0].geometry.parameters.width,a.y*t.children[0].geometry.parameters.height);o.multiply(new THREE.Vector3(.0025,.0025,.0025).multiplyScalar(n)),o.divide(e);let i=t.children[0].scale.clone(),l=t.children[0].geometry.parameters.height,s=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",s.load(resUrl,(function(e){r.y=i.y*l*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(r.clone()),a.scale.copy(o.clone()),t.add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",s.load(resUrl,(function(e){r.y=i.y*l*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(r.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),t.add(a)}))}}))}},this.loadQuiz=function(e,o,a,n,s){console.log("three.js: _loadQuiz: obj=",o);let c=document.createElement("a-entity");c.setAttribute("id",o.obj_id);let d=o.quaternionRotation.split(","),u=new THREE.Quaternion(Number(d[1]),Number(d[2]),Number(d[3]),Number(d[0])),m=t.gcssTargets.dpi[e.GCSSID],p=t.gcssTargets.width[e.GCSSID],h=t.gcssTargets.height[e.GCSSID];c.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: _loadQuiz: _loaded: ",c.object3D),c.object3D.makarType="quiz",c.object3D.makarObject=!0;let e=new THREE.Vector3;switch(window.serverVersion){case"2.0.0":s.multiplyScalar(1),e.addScaledVector(a,2540/m);break;case"3.0.0":e.addScaledVector(a,5080/m),s.multiplyScalar(2);break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}let r=e.y,i=e.z;e.y=i,e.z=r,t.setAframeTransform(c,e,n,s,u),c.object3D.position.add(new THREE.Vector3(25.4*p/m/2,25.4*h/m/2,0)),c.object3D.rotation.x+=90*Math.PI/180,c.object3D.updateMatrix(),c.object3D.obj_parent_id=o.obj_parent_id;let l=new THREE.Object3D;c.object3D.add(l)}})),e.appendChild(c),t.makarObjects.push(c);let b=[];for(let e=0;e<o.module[0].question_list.length;e++)o.module[0].question_list[e].allowRandom&&b.push(e);if(!o.module[0].display_order_list)return;let g=0;for(let e=0;e<o.module[0].display_order_list.length;e++){let t=o.module[0].display_order_list[e].index;if(-1==t){let a=r(b.length),n=b[a];o.module[0].display_order_list[e].index=n,t=n,b.splice(a,1)}o.module[0].question_list[t].active_score&&(g+=1)}let _=o.module[0].display_order_list[0].index,f=o.module[0].question_list[_],j=-1;if("Total"==o.module[0].timer_type){j=o.module[0].total_time,document.getElementById("timerDiv").style.display="block";let e=Math.floor(j/3600),t=Math.floor((j-3600*e)/60),r=j-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}else if("Custom"==o.module[0].timer_type){j=f.time_limit,document.getElementById("timerDiv").style.display="block";let e=Math.floor(j/3600),t=Math.floor((j-3600*e)/60),r=j-3600*e-60*t;timerContent.textContent=e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}let y=document.getElementById("tipButtonDiv");if(f.show_tips?(y.style.display="block",y.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=f.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):y.style.display="none",t.quizModule[t.currentProjectIndex]={json:o.module[0],quizEntity:c,currentQuestionIndex:0,score:0,choices:[],correctAnswer:0,totalActiveScoreQuestion:g,record:new Array(o.module[0].question_list.length),timer:{currentTimer:null,counter:j},record_time:0,qClock:Date.now()},console.log("AR.js: _loadQuiz: self.quizModule , first_question =",t.quizModule,f),document.getElementById("scoreDiv"),f.questions_json&&Array.isArray(f.questions_json))for(let r=0;r<f.questions_json.length;r++){let o=(new THREE.Vector3).fromArray(f.questions_json[r].transform[0].split(",").map((function(e){return Number(e)}))),a=(new THREE.Vector3).fromArray(f.questions_json[r].transform[1].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(f.questions_json[r].transform[2].split(",").map((function(e){return Number(e)})));switch(f.questions_json[r].main_type){case"text":t.loadAframeText(e,f.questions_json[r],o,a,n);break;case"image":let i="";i=t.dealImageUrl(f.questions_json[r]),t.loadAframeTexture(e,i,f.questions_json[r],o,a,n);break;case"video":t.loadAframeVideo(e,f.questions_json[r],o,a,n);break;case"model":t.getUserRes_onlineRes(f.questions_json[r]),t.loadAframeGLTFModel(e,f.questions_json[r],o,a,n,t.cubeTex);break;case"audio":t.loadAframeAudio(e,f.questions_json[r],o,a,n)}}if(f.options_json&&Array.isArray(f.options_json))for(let r=0;r<f.options_json.length;r++){let o,a,n=(new THREE.Vector3).fromArray(f.options_json[r].transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(f.options_json[r].transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(f.options_json[r].transform[2].split(",").map((function(e){return Number(e)}))),s=f.options_json[r].sub_type;console.log("three.js: _loadQuiz: _loadOption: ",r,s,f.options_json[r]);let c="";switch("txt"!=s&&(c=t.dealImageUrl(f.options_json[r])),s){case"txt":a=t.loadAframeText(e,f.options_json[r],n,i,l);break;case"gif":case"jpg":case"jpeg":case"png":a=t.loadAframeTexture(e,c,f.options_json[r],n,i,l);break;case"button":c="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",a=t.loadAframeTexture(e,c,f.options_json[r],n,i,l)}"button"==s||"MutiOption_Text"!=f.option_type&&"MutiOption_Image"!=f.option_type||a.then((function(e){o=e,o.object3D.matrixWorldNeedsUpdate=!0,o.object3D.updateMatrixWorld();let r=new THREE.Vector3(0,0,0),a=new THREE.Vector3(0,0,0),n=new THREE.Vector3(1,1,1),i=new THREE.Quaternion;if("MutiOption_Text"==f.option_type){let e=new THREE.Vector3(1,1,1).multiply(o.object3D.scale).multiply(o.object3D.parent.scale).multiply(o.object3D.parent.parent.scale),l=o.object3D.children[1].scale.clone().multiply(e),s=Math.max(l.x,l.y);n.multiply(new THREE.Vector3(30,30,30).multiplyScalar(s)),n.divide(e);let c=2*Math.abs(o.getObject3D("mesh").geometry.attributes.position.array[0]);r.x=.5*-n.x-.6*c;let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),d.setAttribute("id",o.object3D.parent.el.id+"_circle_base"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),t.setAframeTransform(d,r,a,n,i),o.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),u.setAttribute("id",o.object3D.parent.el.id+"_circle_out"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),t.setAframeTransform(u,r,a,n,i),o.appendChild(u);let m=document.createElement("a-plane");m.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),m.setAttribute("id",o.object3D.parent.el.id+"_circle_in"),m.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),m.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),t.setAframeTransform(m,r,a,n,i),o.appendChild(m)}else{let e=setInterval((function(){if(o.getAttribute("heightForQuiz")){let l=o.object3D.getWorldScale(new THREE.Vector3),s=o.object3D.scale.clone(),c=Math.max(s.x,s.y);n.multiply(new THREE.Vector3(50,50,50).multiplyScalar(c)),n.divide(l);let d=o.object3D.children[0].scale.clone();r.y=.5*-n.y-.6*d.y;let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id",o.id+"_circle_base"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),t.setAframeTransform(u,r,a,n,i),o.appendChild(u);let m=document.createElement("a-plane");m.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),m.setAttribute("id",o.id+"_circle_out"),m.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),t.setAframeTransform(m,r,a,n,i),o.appendChild(m);let p=document.createElement("a-plane");p.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),p.setAttribute("id",o.id+"_circle_in"),p.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),p.setAttribute("visible",!1),n.multiply(new THREE.Vector3(.7,.7,.7)),t.setAframeTransform(p,r,a,n,i),o.appendChild(p),window.clearInterval(e)}}),100)}}))}if(t.quizModule[t.currentProjectIndex].timer.counter>=0){t.quizModule[t.currentProjectIndex].qClock=Date.now();let e=setInterval((function(){t.quizModule[t.currentProjectIndex].timer.currentTimer=e,t.quizModule[t.currentProjectIndex].timer.counter-=1;let r=Math.floor(t.quizModule[t.currentProjectIndex].timer.counter/3600),a=Math.floor((t.quizModule[t.currentProjectIndex].timer.counter-3600*r)/60),n=t.quizModule[t.currentProjectIndex].timer.counter-3600*r-60*a;if(timerContent.textContent=r.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+n.toString().padStart(2,"0"),0==t.quizModule[t.currentProjectIndex].timer.counter){if(console.log("three.js: _quiz: time out ",o.module[0]),window.clearInterval(t.quizModule[t.currentProjectIndex].timer.currentTimer),"Custom"==o.module[0].timer_type)if(f.show_score){let e=document.getElementById("scoreDiv"),r=document.getElementById("score");e.style.display="block",e.onclick=function(){e.style.display="none",t.nextQuestion()},r.textContent=t.quizModule[t.currentProjectIndex].score}else t.nextQuestion();else{let e=document.getElementById("tipButtonDiv"),r=document.getElementById("tipDiv");e.style.display="none",r.style.display="none";let o=document.getElementById("startQuiz"),a=document.getElementById("QuizStartButton"),n=document.getElementById("QuizStartContent");o.style.display="block",n.textContent=l.timeIsUp[i],a.onclick=function(){o.style.display="none",t.nextQuestion()}}let e={question:_,get_score:0,answer_time:t.quizModule[t.currentProjectIndex].json.question_list[_].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};t.quizModule[t.currentProjectIndex].record[_]=e,t.quizModule[t.currentProjectIndex].record_time+=t.quizModule[t.currentProjectIndex].json.question_list[_].time_limit,t.quizModule[t.currentProjectIndex].qClock=Date.now(),console.log("three.js: _loadQuiz: module=",e,t.quizModule[t.currentProjectIndex])}}),1e3)}},this.clickQuiz2DButton=function(e){let r;e.traverseAncestors((function(t){t.quizModule&&(r=t.quizModule,console.log("three.js: _clickQuiz2DButton: get quizModule ",t,e))}));let o=[],a=!1,n=0,i=r.json.display_order_list[r.currentQuestionIndex].index,l=r.json.question_list[i],s=r.json.score_type,c=document.getElementById("makarDragon"),d=document.getElementById("makarDragonWholeMaskDiv"),u=document.getElementById("imgRight"),m=document.getElementById("imgWrong"),p=e.obj_id;if("Option_Text"==l.option_type||"Option_Image"==l.option_type){null==l.answer_list&&(l.answer_list=[]);let h=l.answer_list[0],b=l.options_json[h-1];console.log("three.js: _clickQuiz2DButton: single target=",e);for(let e=0,t=l.options_json.length;e<t;e++)l.options_json[e].obj_id==p&&o.push(e);if(b.obj_id==p){if(l.active_score)if("Custom"==s)r.score+=l.score,n=l.score;else if("Total"==s){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}a=!0,c.style.display="block",d.style.display="block",u.style.display="block",m.style.display="none",console.log("three.js: _clickQuiz2DButton: Congratulations! Correct Answer!")}else a=!1,c.style.display="block",d.style.display="block",u.style.display="none",m.style.display="block",console.log("three.js: _clickQuiz2DButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: _clickQuiz2DButton: score , currectQuestion = ",i,r,r.choices,o,n);let e={question:i,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:a};if(r.record[i]=e,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",e.onclick=function(){e.style.display="none",t.nextQuestion2D(r)},o.textContent=r.score}else t.nextQuestion2D(r)}),1600),console.log("three.js: _clickQuiz2DButton: score: ",r.score,l)}else{if("MutiOption_Text"!=l.option_type&&"MutiOption_Image"!=l.option_type)return;if("text2D"!=e.makarType&&"image2D"!=e.makarType||e.traverse((function(e){if(e.isMesh){if("circle_in"==e.name)if(e.visible=!e.visible,r.choices.includes(p)){let e=r.choices.indexOf(p);r.choices.splice(e,1)}else r.choices.push(p);"circle_out"==e.name&&("7b7b7b"==e.material.color.getHexString()?e.material.color.setStyle("#00d1c1"):"00d1c1"==e.material.color.getHexString()&&e.material.color.setStyle("#7b7b7b"))}})),"button"==e.sub_type){let e=0;null==l.answer_list&&(l.answer_list=[]);for(let t of l.answer_list)if(correctAnswer=l.options_json[t],correctAnswer)for(let t of r.choices)t==correctAnswer.obj_id&&(e+=1);for(let e=0,t=l.options_json.length;e<t;e++)for(let t=0,a=r.choices.length;t<a;t++)l.options_json[e].obj_id==r.choices[t]&&o.push(e-1);if(e==l.answer_list.length&&l.answer_list.length==r.choices.length){if(l.active_score)if("Custom"==s)r.score+=l.score,n=l.score;else if("Total"==s){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}a=!0,c.style.display="block",d.style.display="block",u.style.display="block",m.style.display="none",console.log("three.js: _clickQuiz2DButton: Congratulations! Correct Answer!")}else a=!1,c.style.display="block",u.style.display="none",m.style.display="block",console.log("three.js: _clickQuiz2DButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: _clickQuiz2DButton: score , currectQuestion = ",i,r,r.choices,o,n);let e={question:i,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:a};if(r.record[i]=e,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",e.onclick=function(){e.style.display="none",t.nextQuestion2D(r)},o.textContent=r.score}else t.nextQuestion2D(r)}),1600)}}},this.pushButton=function(e){let r=t.quizModule[t.currentProjectIndex],o=[],a=!1,n=0,i=r.json.display_order_list[r.currentQuestionIndex].index,l=r.json.question_list[i],s=r.json.score_type,c=document.getElementById("makarDragon"),d=document.getElementById("makarDragonWholeMaskDiv"),u=document.getElementById("imgRight"),m=document.getElementById("imgWrong");if(console.log("three.js: _pushButton: quizModule=",r,l),"Option_Text"==l.option_type||"Option_Image"==l.option_type){null==l.answer_list&&(l.answer_list=[]);let p=l.answer_list[0],h=l.options_json[p-1];console.log("three.js: _pushButton: single target=",e.el.id);let b=e.el.id;for(let e=0,t=l.options_json.length;e<t;e++)l.options_json[e].obj_id==b&&o.push(e);if(h.obj_id==b){if(l.active_score)if("Custom"==s)r.score+=l.score,n=l.score;else if("Total"==s){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}a=!0,c.style.display="block",d.style.display="block",u.style.display="block",m.style.display="none",console.log("three.js: _pushButton: Congratulations! Correct Answer!")}else a=!1,c.style.display="block",d.style.display="block",u.style.display="none",m.style.display="block",console.log("three.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: score , currectQuestion = ",i,r,r.choices,o,n);let e={question:i,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:a};if(r.record[i]=e,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",e.onclick=function(){e.style.display="none",t.nextQuestion()},o.textContent=r.score}else t.nextQuestion()}),1600),console.log("three.js: _pushButton: score: ",r.score,l)}else{let p;if(console.log("three.js: _pushButton: target=",e),"text"!=e.makarType&&"image"!=e.makarType||(p=e.el.id,e.traverse((function(t){if(t.isGroup&&t.el&&t.el.id==e.el.id+"_circle_in")if(console.log(" 555555555555555 _circle_in",t),t.visible=!t.visible,r.choices.includes(p)){let e=r.choices.indexOf(p);r.choices.splice(e,1)}else r.choices.push(p);t.isMesh&&t.el&&t.el.id==e.el.id+"_circle_out"&&(console.log(" 555555555555555 _circle_out",t),"7b7b7b"==t.material.color.getHexString()?t.material.color.setStyle("#00d1c1"):"00d1c1"==t.material.color.getHexString()&&t.material.color.setStyle("#7b7b7b"))}))),"button"==e.sub_type){let e=0;null==l.answer_list&&(l.answer_list=[]);for(let t of l.answer_list)if(correctAnswer=l.options_json[t],correctAnswer)for(let t of r.choices)t==correctAnswer.obj_id&&(e+=1);for(let e=0,t=l.options_json.length;e<t;e++)for(let t=0,a=r.choices.length;t<a;t++)l.options_json[e].obj_id==r.choices[t]&&o.push(e-1);if(e==l.answer_list.length&&l.answer_list.length==r.choices.length){if(l.active_score)if("Custom"==s)r.score+=l.score,n=l.score;else if("Total"==s){let e=r.json.total_score;r.correctAnswer+=1,r.score=Math.round(e*r.correctAnswer/r.totalActiveScoreQuestion),n=Math.round(e/r.totalActiveScoreQuestion)}a=!0,c.style.display="block",d.style.display="block",u.style.display="block",m.style.display="none",console.log("three.js: _pushButton: Congratulations! Correct Answer!")}else a=!1,c.style.display="block",u.style.display="none",m.style.display="block",console.log("three.js: _pushButton: 叭叭~ Incorrect Answer!");window.clearInterval(r.timer.currentTimer),setTimeout((function(){c.style.display="none",d.style.display="none",console.log("three.js: score , currectQuestion = ",i,r,r.choices,o,n);let e={question:i,get_score:n,answer_time:Math.round((Date.now()-r.qClock)/1e3),answer_options:o,answer_cloze:"",answer_is_enable:!0,answer_is:a};if(r.record[i]=e,r.record_time+=Math.round((Date.now()-r.qClock)/1e3),r.qClock=Date.now(),l.show_score){let e=document.getElementById("scoreDiv"),o=document.getElementById("score");e.style.display="block",e.onclick=function(){e.style.display="none",t.nextQuestion()},o.textContent=r.score}else t.nextQuestion()}),1600)}}},this.nextQuestion2D=function(e){console.log("three.js: _nextQuestion2D: _quizModule = ",e),e.choices=[];let r=e.quizObject,o=[];for(let e of r.children)o.push(e);if(o.forEach((function(e){for(let o=0;o<t.makarObjects2D.length;o++)if(t.makarObjects2D[o].obj_id==e.obj_id){let e=t.makarObjects2D[o];r.remove(e),t.makarObjects2D.splice(o,1)}})),e.currentQuestionIndex+=1,e.currentQuestionIndex<e.json.display_order_list.length){let o=e.json.display_order_list[e.currentQuestionIndex].index,a=e.json.question_list[o];"Custom"==e.json.timer_type&&(e.timer.counter=a.time_limit);let n=document.getElementById("tipButtonDiv");a.show_tips?(n.style.display="block",n.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=a.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):n.style.display="none";let s=r.parent;if(a.questions_json&&Array.isArray(a.questions_json))for(let e=0;e<a.questions_json.length;e++){let r,o=a.questions_json[e],n=(new THREE.Vector3).fromArray(o.transform[0].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(o.transform[1].split(",").map((function(e){return Number(e)}))),l=(new THREE.Vector3).fromArray(o.transform[2].split(",").map((function(e){return Number(e)})));switch(o.main_type){case"text":r=t.loadAframeText2D(s,o,e,a.questions_json.length,n,i,l);break;case"image":let c=a.questions_json[e].res_url;c=t.dealImageUrl(a.questions_json[e]),r=t.loadAframeTexture2D(s,o,c,e,a.questions_json.length,n,i,l)}}for(let e=0;e<a.options_json.length;e++){let r=a.options_json[e],o=(new THREE.Vector3).fromArray(r.transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(r.transform[1].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(r.transform[2].split(",").map((function(e){return Number(e)}))),l=r.sub_type;console.log("three.js: _nextQuestion2D: _loadOption: ",e,l,a.options_json[e]);let c,d=r.res_url;switch(d=t.dealImageUrl(r),l){case"txt":c=t.loadAframeText2D(s,r,e,a.options_json.length,o,n,i);break;case"gif":case"jpg":case"jpeg":case"png":c=t.loadAframeTexture2D(s,r,d,e,a.options_json.length,o,n,i);break;case"button":d="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",c=t.loadAframeTexture2D(s,r,d,e,a.options_json.length,o,n,i)}"button"==l||"MutiOption_Text"!=a.option_type&&"MutiOption_Image"!=a.option_type||c.then((function(e){let t=e,r=new THREE.Vector3(0,0,0),o=(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1));if(new THREE.Quaternion,"MutiOption_Text"==a.option_type){let e=t.children[0].children[1],a=e.scale.clone(),n=t.children[0].getWorldScale(new THREE.Vector3),i=Math.min(a.x*e.geometry.parameters.width,a.y*e.geometry.parameters.height,1e6);o.multiply(new THREE.Vector3(.8,.8,.8).multiplyScalar(i)),o.divide(n);let l=e.geometry.parameters.width*a.x,s=new THREE.TextureLoader;resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",s.load(resUrl,(function(e){r.x=.5*-l-48*o.x;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(r.clone()),a.scale.copy(o.clone()),t.children[0].add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.children[0].add(n)})),resUrl="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",s.load(resUrl,(function(e){r.x=.5*-l-48*o.x;let a=new THREE.Mesh(new THREE.PlaneBufferGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(r.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),t.children[0].add(a)}))}else{let e="",a=t.getWorldScale(new THREE.Vector3),n=t.scale.clone(),i=Math.max(n.x*t.children[0].geometry.parameters.width,n.y*t.children[0].geometry.parameters.height);o.multiply(new THREE.Vector3(.0025,.0025,.0025).multiplyScalar(i)),o.divide(a);let l=t.children[0].scale.clone(),s=t.children[0].geometry.parameters.height,c=new THREE.TextureLoader;e="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png",c.load(e,(function(e){r.y=l.y*s*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:3947580,depthWrite:!1}));a.name="circle_base",a.position.copy(r.clone()),a.scale.copy(o.clone()),t.add(a);let n=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:53697,depthWrite:!1}));n.name="circle_in",n.renderOrder=1,n.visible=!1,n.position.copy(r.clone()),n.scale.copy(o.clone().multiplyScalar(.7)),t.add(n)})),e="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png",c.load(e,(function(e){r.y=l.y*s*.5+48*o.y;let a=new THREE.Mesh(new THREE.PlaneGeometry(e.image.width,e.image.height),new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,color:8092539,depthWrite:!1}));a.name="circle_out",a.renderOrder=1,a.position.copy(r.clone()),a.scale.copy(o.clone().multiplyScalar(.9)),t.add(a)}))}}))}if("Custom"==e.json.timer_type&&e.timer.counter>=0){document.getElementById("timerDiv");let t=Math.floor(e.timer.counter/3600),r=Math.floor((e.timer.counter-3600*t)/60),o=e.timer.counter-3600*t-60*r;timerContent.textContent=t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}setTimeout((function(){if(e.timer.counter>=0){e.qClock=Date.now();let r=setInterval((function(){e.timer.currentTimer=r,e.timer.counter-=1;let n=Math.floor(e.timer.counter/3600),s=Math.floor((e.timer.counter-3600*n)/60),c=e.timer.counter-3600*n-60*s;if(timerContent.textContent=n.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+c.toString().padStart(2,"0"),0==e.timer.counter)if(window.clearInterval(e.timer.currentTimer),"Custom"==e.json.timer_type)if(a.show_score){let r=document.getElementById("scoreDiv"),o=document.getElementById("score");r.style.display="block",r.onclick=function(){r.style.display="none",t.nextQuestion()},o.textContent=e.score}else t.nextQuestion();else{let r=[],a=e.quizEntity;for(let e of a.children)r.push(e);r.forEach((function(e){if(e.obj_parent_id==a.obj_id){a.remove(e);for(let r=0,o=t.makarObjects.length;r<o;r++)t.makarObjects[r]==e&&t.makarObjects.splice(r,1)}}));let n=document.getElementById("tipButtonDiv"),s=document.getElementById("tipDiv");n.style.display="none",s.style.display="none";let c=document.getElementById("startQuiz"),d=document.getElementById("QuizStartButton"),u=document.getElementById("QuizStartContent");c.style.display="block",u.textContent=l.timeIsUp[i];let m={question:o,get_score:0,answer_time:e.json.question_list[o].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};e.record[o]=m,e.record_time+=e.json.question_list[o].time_limit,e.qClock=Date.now(),d.onclick=function(){c.style.display="none",t.nextQuestion()}}}),1e3)}}),3e3)}else{window.clearInterval(e.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let r=document.getElementById("tipButtonDiv"),o=document.getElementById("tipDiv");r.style.display="none",o.style.display="none";let a=document.getElementById("quizEndDiv");a.style.display="block",a.addEventListener("click",(function(){a.style.display="none"})),console.log("three.js: quiz end , quizModule.record = ",e.record);let n="",i="";localStorage.getItem("login_shared_id")&&(n=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(i=localStorage.getItem("device_id"));let l={user_id:publishARProjs.result[t.currentProjectIndex].user_id,playing_user:n,proj_id:publishARProjs.result[t.currentProjectIndex].proj_id,proj_type:"ar",device_id:i,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[e.json],record_time:e.record_time,record_score:e.score,record:e.record};quizLog(window.serverUrl,l)}},this.nextQuestion=function(){let e=t.quizModule[t.currentProjectIndex];e.choices=[];let r=[],o=e.quizEntity;console.log(" three,js: _nextQuestion: quizModule = ",t.currentProjectIndex,e);for(let e of o.children)r.push(e);if(r.forEach((function(e){for(let r=0;r<t.makarObjects.length;r++)if(t.makarObjects[r].id==e.id){let e=t.makarObjects[r];if(e.getAttribute("src")){let t=e.getAttribute("src").split("#")[1];document.getElementById(t)&&document.getElementById(t).remove()}e.remove(),t.makarObjects.splice(r,1)}})),e.currentQuestionIndex+=1,e.currentQuestionIndex<e.json.display_order_list.length){let r=e.json.display_order_list[e.currentQuestionIndex].index,a=e.json.question_list[r];"Custom"==e.json.timer_type&&(e.timer.counter=a.time_limit);let n=document.getElementById("tipButtonDiv");a.show_tips?(n.style.display="block",n.addEventListener("click",(function(){let e=document.getElementById("tipDiv"),t=document.getElementById("tipConfirmButton"),r=document.getElementById("tipContent");e.style.display="block",r.textContent=a.tips_content,t.addEventListener("click",(function(){e.style.display="none"}))}))):n.style.display="none";let s=o.parentEl;if(a.questions_json&&Array.isArray(a.questions_json))for(let e=0;e<a.questions_json.length;e++){let r,o=(new THREE.Vector3).fromArray(a.questions_json[e].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(a.questions_json[e].transform[1].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(a.questions_json[e].transform[2].split(",").map((function(e){return Number(e)})));switch(a.questions_json[e].main_type){case"text":r=t.loadAframeText(s,a.questions_json[e],o,n,i);break;case"image":let l="";l=t.dealImageUrl(a.questions_json[e]),r=t.loadAframeTexture(s,l,a.questions_json[e],o,n,i);break;case"video":break;case"model":t.getUserRes_onlineRes(a.questions_json[e]),t.loadAframeGLTFModel(s,a.questions_json[e],o,n,i,t.cubeTex);break;case"audio":t.loadAframeAudio(s,a.questions_json[e],o,n,i)}}for(let e=0;e<a.options_json.length;e++){let r,o=(new THREE.Vector3).fromArray(a.options_json[e].transform[0].split(",").map((function(e){return Number(e)}))),n=(new THREE.Vector3).fromArray(a.options_json[e].transform[1].split(",").map((function(e){return Number(e)}))),i=(new THREE.Vector3).fromArray(a.options_json[e].transform[2].split(",").map((function(e){return Number(e)}))),l=a.options_json[e].sub_type;console.log("three.js: _loadQuiz: _loadOption: ",e,l,a.options_json[e]);let c,d="";switch("txt"!=l&&(d=t.dealImageUrl(a.options_json[e])),l){case"txt":c=t.loadAframeText(s,a.options_json[e],o,n,i);break;case"gif":case"jpg":case"jpeg":case"png":c=t.loadAframeTexture(s,d,a.options_json[e],o,n,i);break;case"button":d="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/button_withText.png",c=t.loadAframeTexture(s,d,a.options_json[e],o,n,i)}"button"==l||"MutiOption_Text"!=a.option_type&&"MutiOption_Image"!=a.option_type||c.then((function(e){r=e,r.object3D.matrixWorldNeedsUpdate=!0,r.object3D.updateMatrixWorld();let o=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,0,0),i=new THREE.Vector3(1,1,1),l=new THREE.Quaternion;if("MutiOption_Text"==a.option_type){let e=new THREE.Vector3(1,1,1).multiply(r.object3D.scale).multiply(r.object3D.parent.scale).multiply(r.object3D.parent.parent.scale),a=r.object3D.children[1].scale.clone().multiply(e),s=Math.max(a.x,a.y);i.multiply(new THREE.Vector3(30,30,30).multiplyScalar(s)),i.divide(e);let c=2*Math.abs(r.getObject3D("mesh").geometry.attributes.position.array[0]);o.x=.5*-i.x-.6*c,console.log(" 99999999999 ",i,o);let d=document.createElement("a-plane");d.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),d.setAttribute("id",r.object3D.parent.el.id+"_circle_base"),d.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),t.setAframeTransform(d,o,n,i,l),r.appendChild(d);let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),u.setAttribute("id",r.object3D.parent.el.id+"_circle_out"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),t.setAframeTransform(u,o,n,i,l),r.appendChild(u);let m=document.createElement("a-plane");m.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),m.setAttribute("id",r.object3D.parent.el.id+"_circle_in"),m.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),m.setAttribute("visible",!1),i.multiply(new THREE.Vector3(.7,.7,.7)),t.setAframeTransform(m,o,n,i,l),r.appendChild(m)}else{let e=setInterval((function(){if(r.getAttribute("heightForQuiz")){let a=r.object3D.getWorldScale(new THREE.Vector3),s=r.object3D.scale.clone(),c=Math.max(s.x,s.y);i.multiply(new THREE.Vector3(50,50,50).multiplyScalar(c)),i.divide(a);let d=r.object3D.children[0].scale.clone();o.y=.5*-i.y-.6*d.y;let u=document.createElement("a-plane");u.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),u.setAttribute("id",r.id+"_circle_base"),u.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#3C3C3C; depthWrite:false"),t.setAframeTransform(u,o,n,i,l),r.appendChild(u);let m=document.createElement("a-plane");m.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle_frame.png"),m.setAttribute("id",r.id+"_circle_out"),m.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#7B7B7B; depthWrite:false"),t.setAframeTransform(m,o,n,i,l),r.appendChild(m);let p=document.createElement("a-plane");p.setAttribute("src","https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/button/circle.png"),p.setAttribute("id",r.id+"_circle_in"),p.setAttribute("material","shader:flat; side:double; opacity: 1.0; transparent: true; color:#00d1c1; depthWrite:false"),p.setAttribute("visible",!1),i.multiply(new THREE.Vector3(.7,.7,.7)),t.setAframeTransform(p,o,n,i,l),r.appendChild(p),window.clearInterval(e)}}),100)}}))}if("Custom"==e.json.timer_type&&e.timer.counter>=0){document.getElementById("timerDiv");let t=Math.floor(e.timer.counter/3600),r=Math.floor((e.timer.counter-3600*t)/60),o=e.timer.counter-3600*t-60*r;timerContent.textContent=t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")}setTimeout((function(){if(e.timer.counter>=0){e.qClock=Date.now();let o=setInterval((function(){e.timer.currentTimer=o,e.timer.counter-=1;let n=Math.floor(e.timer.counter/3600),s=Math.floor((e.timer.counter-3600*n)/60),c=e.timer.counter-3600*n-60*s;if(timerContent.textContent=n.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+c.toString().padStart(2,"0"),0==e.timer.counter)if(window.clearInterval(e.timer.currentTimer),"Custom"==e.json.timer_type)if(a.show_score){let r=document.getElementById("scoreDiv"),o=document.getElementById("score");r.style.display="block",r.onclick=function(){r.style.display="none",t.nextQuestion()},o.textContent=e.score}else t.nextQuestion();else{let o=[],a=e.quizEntity;for(let e of a.children)o.push(e);o.forEach((function(e){if(e.obj_parent_id==a.obj_id){a.remove(e);for(let r=0,o=t.makarObjects.length;r<o;r++)t.makarObjects[r]==e&&t.makarObjects.splice(r,1)}}));let n=document.getElementById("tipButtonDiv"),s=document.getElementById("tipDiv");n.style.display="none",s.style.display="none";let c=document.getElementById("startQuiz"),d=document.getElementById("QuizStartButton"),u=document.getElementById("QuizStartContent");c.style.display="block",u.textContent=l.timeIsUp[i];let m={question:r,get_score:0,answer_time:e.json.question_list[r].time_limit,answer_options:[],answer_cloze:"",answer_is_enable:!1,answer_is:!1};e.record[r]=m,e.record_time+=e.json.question_list[r].time_limit,e.qClock=Date.now(),d.onclick=function(){c.style.display="none",t.nextQuestion()}}}),1e3)}}),3e3)}else{window.clearInterval(e.timer.currentTimer),document.getElementById("timerDiv").style.display="none";let r=document.getElementById("tipButtonDiv"),o=document.getElementById("tipDiv");r.style.display="none",o.style.display="none";let a=document.getElementById("quizEndDiv");a.style.display="block",a.addEventListener("click",(function(){a.style.display="none"})),console.log("three.js: quiz end , quizModule.record = ",e.record);let n="",i="";localStorage.getItem("login_shared_id")&&(n=localStorage.getItem("login_shared_id")),localStorage.getItem("device_id")&&(i=localStorage.getItem("device_id"));let l={user_id:publishARProjs.result[t.currentProjectIndex].user_id,playing_user:n,proj_id:publishARProjs.result[t.currentProjectIndex].proj_id,proj_type:"ar",device_id:i,brand:"",os:navigator.userAgent,location_long:0,location_lan:0,module:[e.json],record_time:e.record_time,record_score:e.score,record:e.record};quizLog(window.serverUrl,l)}},this.checkGLTFMaterialIndex=function(e,t){if(!e||!e.object3D||!e.object3D.children[0])return void console.log("three.js: _checkGLTFMaterialIndex: target error",e);if(!t)return void console.log("three.js: _checkGLTFMaterialIndex: material error",t);let r=t.rendererIndex,o=t.materialIndex,a=-1,n=-1,i=e.object3D.children[0].ModelJson.nodes,l=-1;for(let e=0;e<i.length;e++)if("number"==typeof i[e].mesh&&l++,r==l){a=i[e].mesh;break}if(a>=0){let t=e.object3D.children[0].ModelJson.meshes[a];if(t&&t.primitives){let e=t.primitives[o];e.material>=0&&(n=e.material)}}return n},this.setGLTFMaterial=function(e,t){let r=this,o=e.getObject3D("mesh"),a=-1,n=r.cubeTex;for(let l=0;l<t.material.length;l++){o.ModelJson&&(a=r.checkGLTFMaterialIndex(e,t.material[l]));let s=t.material[l].color.split(","),c=new THREE.Color(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2]));switch(o.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),t.material[l].shader){case"Unlit/Color":o.traverse((e=>{if(e.isMesh){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material=new THREE.MeshBasicMaterial({color:c,name:e.material.name,skinning:e.material.skinning}))}}));break;case"Standard":var i=e.sceneEl.renderer;o.traverse((e=>{if(e.material){let r=e.material.name.split("_");r[r.length-1]==a&&(e.material=new THREE.MeshStandardMaterial({name:e.material.name,skinning:e.material.skinning,map:e.material.map,emissive:e.material.emissive,emissiveMap:e.material.emissiveMap,normalMap:e.material.normalMap}),e.material.color=c,e.material.metalness=t.material[l].metallic,e.material.roughness=1-t.material[l].smoothness,e.material.envMap=n.texture,e.material.envMapIntensity=1,e.material.needsUpdate=!0,e.material.reflectivity=0,e.material.side=THREE.DoubleSide,e.material.transparent=!0,e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0),0==t.material[l].mode?(e.material.opacity=1,i.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor):1==t.material[l].mode?(e.material.opacity=1,e.material.alphaTest=t.material[l].cut_off,i.setClearAlpha(1),e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.ZeroFactor,e.material.blendSrcAlpha=THREE.ZeroFactor,e.material.blendDstAlpha=THREE.OneFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[l].cut_off})):2==t.material[l].mode?(e.material.opacity=parseFloat(s[3]),e.material.depthWrite=!1,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[l].cut_off})):3==t.material[l].mode&&(e.material.opacity=Math.max(parseFloat(s[3]),t.material[l].metallic),e.material.depthWrite=!1,e.material.blending=THREE.CustomBlending,e.material.blendEquation=THREE.AddEquation,e.material.blendSrc=THREE.OneFactor,e.material.blendDst=THREE.OneMinusSrcAlphaFactor,e.material.blendSrcAlpha=THREE.OneFactor,e.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:e.material.map,alphaTest:t.material[l].cut_off})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.opacity=1,e.material.depthWrite=!1)}}));break;case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:e.material.name,skinning:e.material.skinning,map:e.material.map}),e.material.map&&(e.material.map.encoding=THREE.GammaEncoding,e.material.map.needsUpdate=!0,console.log(e.material.map)),e.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.onBeforeCompile=function(e){e.uniforms.tEquirect={value:r.cameraTexture},e.vertexShader="varying vec4 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = -vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.depthWrite=!1)}}));break;case"Blocks/BlocksGlass":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.depthWrite=!1)}}));break;default:console.log(`The shader of no. ${l} material is not supported currently.`)}}},this.loadAframeGLTFModelWithTexture=function(e,r,o,a,n,i,l){return new Promise((function(s){var c=new XMLHttpRequest;c.open("GET","https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/web_white_list/colorMeshNames.txt"),c.responseType="text",c.onload=function(d){var u=c.response.split("\n");console.log(" three.js: _loadAframeGLTFModelWithTexture , meshNameList = ",u,r);let m=t.gcssTargets.dpi[e.GCSSID],p=t.gcssTargets.width[e.GCSSID],h=t.gcssTargets.height[e.GCSSID],b=document.getElementById("makarAssets"),g=document.createElement("a-asset-item");g.setAttribute("id",r.obj_id+"_"+r.res_id),g.setAttribute("src",r.res_url),g.setAttribute("response-type","arraybuffer"),g.setAttribute("crossorigin","anonymous"),b.appendChild(g);var _,f=null;if(r.animation){f=[];for(let e=0;e<r.animation.length;e++)(r.animation[e].defaultAnimation||r.animation[e].isActive)&&(f.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),_=r.animation[e].animationName);for(let e=0;e<r.animation.length;e++)f.push({name:r.animation[e].name,animationName:r.animation[e].animationName,startTime:r.animation[e].startTime,endTime:r.animation[e].endTime,uid:r.animation[e].uid})}let j=document.createElement("a-entity");if(r.res_url){if(j.setAttribute("gltf-model","#"+r.obj_id+"_"+r.res_id),r.animation&&j.setAttribute("animation-mixer","clip: "+_),r.behav?j.setAttribute("class","clickable"):j.setAttribute("class","unclickable"),j.setAttribute("id",r.obj_id),j.setAttribute("crossorigin","anonymous"),j.setAttribute("shadow",""),r.model_shift){let e=(new THREE.Vector3).fromArray(r.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(i),a.add(e)}if(t.makarObjects.push(j),j.addEventListener("model-loaded",(function(e){if(e.target==e.currentTarget){let d=t.arfScene.renderer.capabilities.getMaxAnisotropy();j.object3D.children[0].scale.set(2540/m,2540/m,2540/m),j.object3D.children[0].rotation.y=Math.PI;let b=r.quaternionRotation.split(","),g=new THREE.Quaternion(Number(b[1]),Number(b[2]),Number(b[3]),Number(b[0])),_=new THREE.Vector3;if(r.obj_parent_id){j.object3D.obj_parent_id=r.obj_parent_id,_.addScaledVector(a,2540/m);let e=_.z;_.z=-e,t.setAframeTransform(j,_,n,i,g)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),_.addScaledVector(a,2540/m);break;case"3.0.0":i.multiplyScalar(2),_.addScaledVector(a,5080/m);break;default:console.log("three.js: loadAframeGLTFModelWithTexture: serverVersion version wrong",serverVersion)}let e=_.y,r=_.z;_.y=r,_.z=e,t.setAframeTransform(j,_,n,i,g),j.object3D.position.add(new THREE.Vector3(25.4*p/m/2,25.4*h/m/2,0)),j.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeGLTFModelWithTexture: loaded: no parent prs=",j.object3D.position,j.object3D.rotation,j.object3D.scale)}let y=j.object3D;if(y.originTransform={position:y.position.clone(),rotation:y.rotation.clone(),scale:y.scale.clone()},j.object3D.makarType="model",j.object3D.makarObject=!0,r.behav&&(j.object3D.behav=r.behav,t.setObjectBehavAll(r)),r.behav_reference&&(j.object3D.behav_reference=r.behav_reference),e.detail.model.traverse((e=>{if(!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=d,e.material.map.needsUpdate=!0),e.isMesh){for(let t=0,r=u.length;t<r;t++)e.name==u[t]&&(skinnedTexture=new THREE.CanvasTexture(o),skinnedTexture.flipY=!1,skinnedTexture.needsUpdate=!0,e.material.map=skinnedTexture,e.material.needsUpdate=!0);e.material.flatShading=!1,e.material.needsUpdate=!0}})),j.object3D){let o=j.getObject3D("mesh"),a=-1;if(r.material)for(let e=0;e<r.material.length;e++){o.ModelJson&&(a=t.checkGLTFMaterialIndex(j,r.material[e]));let n=r.material[e].color.split(","),i=new THREE.Color(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]));switch(o.traverse((e=>{e.type&&"string"==typeof e.type&&e.type.toLowerCase().includes("light")&&(e.visible=!1)})),r.material[e].shader){case"Unlit/Color":o.traverse((t=>{if(t.isMesh){let o=t.material.name.split("_");o[o.length-1]==a&&(t.material=new THREE.MeshBasicMaterial({color:i,name:r.material[e].name,skinning:t.material.skinning}))}}));break;case"Standard":var c=j.sceneEl.renderer;o.traverse((t=>{if(t.material){let o=t.material.name.split("_");o[o.length-1]==a&&(t.material=new THREE.MeshStandardMaterial({name:t.material.name,skinning:t.material.skinning,map:t.material.map,emissive:t.material.emissive,emissiveMap:t.material.emissiveMap,normalMap:t.material.normalMap}),t.material.color=i,t.material.metalness=r.material[e].metallic,t.material.roughness=1-r.material[e].smoothness,t.material.envMap=l.texture,t.material.envMapIntensity=1,t.material.needsUpdate=!0,t.material.reflectivity=0,t.material.side=THREE.DoubleSide,t.material.transparent=!0,t.material.map&&(t.material.map.encoding=THREE.GammaEncoding,t.material.map.needsUpdate=!0),0==r.material[e].mode?(t.material.opacity=1,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor):1==r.material[e].mode?(t.material.opacity=1,t.material.alphaTest=r.material[e].cut_off,c.setClearAlpha(1),t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.ZeroFactor,t.material.blendSrcAlpha=THREE.ZeroFactor,t.material.blendDstAlpha=THREE.OneFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:r.material[e].cut_off})):2==r.material[e].mode?(t.material.opacity=parseFloat(n[3]),t.material.depthWrite=!1,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:r.material[e].cut_off})):3==r.material[e].mode&&(t.material.opacity=Math.max(parseFloat(n[3]),r.material[e].metallic),t.material.depthWrite=!1,t.material.blending=THREE.CustomBlending,t.material.blendEquation=THREE.AddEquation,t.material.blendSrc=THREE.OneFactor,t.material.blendDst=THREE.OneMinusSrcAlphaFactor,t.material.blendSrcAlpha=THREE.OneFactor,t.material.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,t.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,skinning:!0,map:t.material.map,alphaTest:r.material[e].cut_off})))}}));break;case"Unlit/Transparent":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.opacity=1,e.material.depthWrite=!1)}}));break;case"Unlit/Transparent Cutout":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.opacity=1,e.material.alphaTest=.5)}}));break;case"Unlit/Texture":o.traverse((t=>{if(t.material){let o=t.material.name.split("_");o[o.length-1]==a&&(t.material=new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,1),name:r.material[e].name,skinning:t.material.skinning,map:t.material.map}),t.material.map&&(t.material.map.encoding=THREE.GammaEncoding,t.material.map.needsUpdate=!0,console.log(t.material.map)),t.material.needsUpdate=!0)}}));break;case"Unlit/ScreenCutoutShader":o.traverse((e=>{if(e.material){let r=e.material.name.split("_");r[r.length-1]==a&&(e.material.onBeforeCompile=function(e){e.uniforms.tEquirect={value:t.cameraTexture},e.vertexShader="varying vec4 vProjection;\n"+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <worldpos_vertex>",["#include <worldpos_vertex>","\tvProjection = projectionMatrix * mvPosition;"].join("\n")),e.fragmentShader="uniform sampler2D tEquirect;\nvarying vec4 vProjection;\n"+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>",["#include <dithering_fragment>","\tvec2 sampleUV;","\tsampleUV.x = vProjection.x/vProjection.w*0.5 + 0.5;","\tsampleUV.y = -vProjection.y/vProjection.w*0.5 + 0.5;","\tgl_FragColor = texture2D(tEquirect, sampleUV);"].join("\n"))})}}));break;case"Blocks/Basic":break;case"Blocks/BlocksGem":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.depthWrite=!1)}}));break;case"Blocks/BlocksGlass":o.traverse((e=>{if(e.material){let t=e.material.name.split("_");t[t.length-1]==a&&(e.material.depthWrite=!1)}}));break;default:console.log(`The shader of no. ${e} material is not supported currently.`)}}Array.isArray(e.detail.model.animations)&&e.detail.model.animations.length>0&&!j.getAttribute("animation-mixer")&&(console.log("three.js: _loadAframeGLTFModelWithTexture: the model with animation but no animation-mixer, probabily older version of editor "),j.setAttribute("animation-mixer","clip: "+e.detail.model.animations[0].name),(f=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),f.push({animationName:e.detail.model.animations[0].name,name:e.detail.model.animations[0].name,endTime:e.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),e.detail.model.animationSlices=f,s(j)}}})),0==r.active&&(j.setAttribute("visible",!1),j.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowModel"==r.behav_reference[e].behav_name){j.setAttribute("visible",!1),j.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(j),window.clearInterval(e))}),1)}else e.appendChild(j),console.log(" 222222222222222 ",e,j)}},c.send()}))},this.loadAframeGLTFModel=function(e,r,o,a,n,i){return new Promise((function(i){t.UrlExistsFetch(r.res_url).then((l=>{if(1==l){if(""==r.res_url||"glb"!=r.sub_type&&"gltf"!=r.sub_type&&"gltf_sketchFab"!=r.sub_type&&"gltf_sketchfab"!=r.sub_type&&"gltf_poly"!=r.sub_type)return console.log(" three.js: _loadAframeGLTFModel: obj not support ",r),void i(-1);let l=t.gcssTargets.dpi[e.GCSSID],d=t.gcssTargets.width[e.GCSSID],u=t.gcssTargets.height[e.GCSSID],m=t.sceneTargetList[e.GCSSID].projIndex,p=document.getElementById("makarAssets"),h=document.createElement("a-asset-item");h.setAttribute("id",r.obj_id+"_"+r.res_id),h.setAttribute("src",r.res_url),h.setAttribute("response-type","arraybuffer"),h.setAttribute("crossorigin","anonymous"),p.appendChild(h);var s,c=null;if(r.animation){c=[];let e=t.getProjectVersion(m);if(Array.isArray(e)&&3==e.length){let t=Number(e[0]),o=Number(e[1]),a=Number(e[2]);if(t>3||3==t&&o>3||3==t&&3==o&&a>8){for(let e=0;e<r.animation.length;e++)(r.animation[e].is_default||r.animation[e].is_active)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),s=r.animation[e].animation_name);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animation_name,startTime:r.animation[e].start_time,endTime:r.animation[e].end_time,uid:r.animation[e].uid})}else{for(let e=0;e<r.animation.length;e++)(r.animation[e].defaultAnimation||r.animation[e].isActive)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),s=r.animation[e].animationName);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animationName,startTime:r.animation[e].startTime,endTime:r.animation[e].endTime,uid:r.animation[e].uid})}}else{for(let e=0;e<r.animation.length;e++)(r.animation[e].is_default||r.animation[e].is_active)&&(c.push({idle:r.animation[e].uid,loop:r.animation[e].uid,uid:r.animation[e].uid,changed:!1,reset:!0,count:0}),s=r.animation[e].animation_name);for(let e=0;e<r.animation.length;e++)c.push({name:r.animation[e].name,animationName:r.animation[e].animation_name,startTime:r.animation[e].start_time,endTime:r.animation[e].end_time,uid:r.animation[e].uid})}}let b=document.createElement("a-entity");if(!r.res_url)return;if(b.setAttribute("gltf-model","#"+r.obj_id+"_"+r.res_id),r.animation&&b.setAttribute("animation-mixer","clip: "+s),r.behav?b.setAttribute("class","clickable"):b.setAttribute("class","unclickable"),b.setAttribute("id",r.obj_id),b.setAttribute("crossorigin","anonymous"),b.setAttribute("shadow",""),r.model_shift){let e=(new THREE.Vector3).fromArray(r.model_shift.split(",").map((function(e){return Number(e)})));e.multiply(n),o.add(e)}if(t.makarObjects.push(b),b.addEventListener("model-loaded",(function(e){if(e.target==e.currentTarget){let s=t.arfScene.renderer.capabilities.getMaxAnisotropy();b.object3D.children[0].scale.set(2540/l,2540/l,2540/l),b.object3D.children[0].rotation.y=Math.PI;let p=r.quaternionRotation.split(","),h=new THREE.Quaternion(Number(p[1]),Number(p[2]),Number(p[3]),Number(p[0])),g=new THREE.Vector3;if(r.obj_parent_id){b.object3D.obj_parent_id=r.obj_parent_id,g.addScaledVector(o,2540/l);let e=g.z;g.z=-e,t.setAframeTransform(b,g,a,n,h)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),g.addScaledVector(o,2540/l);break;case"3.0.0":n.multiplyScalar(2),g.addScaledVector(o,5080/l);break;default:console.log("three.js: _loadAframeGLTFModel: serverVersion version wrong",serverVersion)}let e=g.y,r=g.z;g.y=r,g.z=e,t.setAframeTransform(b,g,a,n,h),b.object3D.position.add(new THREE.Vector3(25.4*d/l/2,25.4*u/l/2,0)),b.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeGLTFModel: loaded: no parent prs=",b.object3D.position,b.object3D.rotation,b.object3D.scale)}let _=b.object3D;_.originTransform={position:_.position.clone(),rotation:_.rotation.clone(),scale:_.scale.clone()},r.blockly&&(_.resetProperty=function(){t.setGLTFMaterial(b,r)}),b.object3D.makarType="model",b.object3D.makarObject=!0,r.behav&&(b.object3D.behav=r.behav,t.setObjectBehavAll(r,m)),r.behav_reference&&(b.object3D.behav_reference=r.behav_reference),e.detail.model.traverse((e=>{!0===e.isMesh&&null!==e.material.map&&(e.material.map.anisotropy=s,e.material.map.needsUpdate=!0)})),b.object3D&&(t.setGLTFMaterial(b,r),Array.isArray(e.detail.model.animations)&&e.detail.model.animations.length>0&&!b.getAttribute("animation-mixer")&&(console.log("three.js: loadGFLTFModel: the model with animation but no animation-mixer, probabily older version of editor "),b.setAttribute("animation-mixer","clip: "+e.detail.model.animations[0].name),(c=[]).push({changed:!1,idle:"mifly168",uid:"mifly168"}),c.push({animationName:e.detail.model.animations[0].name,name:e.detail.model.animations[0].name,endTime:e.detail.model.animations[0].duration,startTime:0,uid:"mifly168"})),e.detail.model.animationSlices=c,i(b))}})),0==r.active&&(b.setAttribute("visible",!1),b.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowModel"==r.behav_reference[e].behav_name){b.setAttribute("visible",!1),b.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(b),window.clearInterval(e))}),1)}else e.appendChild(b)}else console.log("ARFunc.js: _loadAframeGLTFModel , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],t.loadAframeGLTFModel(e,r,o,a,n,t.cubeTex),i(1)}))}))},this.checkDefaultImage=function(e){switch(e.res_id){case"MakAR_Call":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Call.png";break;case"MakAR_Room":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Room.png";break;case"MakAR_Mail":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/MakAR_Mail.png";break;case"Line_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/Line_icon.png";break;case"FB_icon":e.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/2D/FB_icon.png";break;default:console.log("image: default, obj=",e)}},this.loadAframeTexture=function(e,r,o,a,n,i){return console.log("three.js: ARController: _loadAframeTexture, obj=",o,a,n,i),t.checkDefaultImage(o),new Promise((function(l){t.UrlExistsFetch(o.res_url).then((s=>{if(1==s){o.res_url=r;let s,c=t.gcssTargets.dpi[e.GCSSID],d=t.gcssTargets.width[e.GCSSID],u=t.gcssTargets.height[e.GCSSID],m=t.sceneTargetList[e.GCSSID].projIndex,p=(new THREE.TextureLoader).load(o.res_url),h=o.res_url.split(".").length,b=o.res_url.split(".")[h-1].toLowerCase();if(o.sub_type=o.sub_type.toLowerCase(),"png"==o.sub_type||"jpg"==o.sub_type||"jpeg"==o.sub_type||"bmp"==o.sub_type)b=o.sub_type,s=document.createElement("a-plane"),s.setAttribute("src",o.res_url);else if("gif"==o.sub_type)b=o.sub_type,s=document.createElement("a-entity");else{if("button"!=o.sub_type)return console.log("_loadAframeTexture: sub_type empty, create empty plane "),s=document.createElement("a-plane"),void l(s);"png"!=b&&"jpg"!=b&&"jpeg"!=b&&(b="png"),s=document.createElement("a-plane"),s.setAttribute("src",o.res_url)}s.setAttribute("id",o.obj_id),s.setAttribute("crossorigin","anonymous");let g=!1;if(o.behav)for(let e=0;e<o.behav.length;e++)"TransparentVideo"!=o.behav[e].simple_behav&&"TransparentImage"!=o.behav[e].simple_behav||(g=!0,chromaKey=o.behav[e].chromakey,slope=o.behav[e].slope,threshold=o.behav[e].threshold,transparentBehav=o.behav[e]);if(g){let e=chromaKey.split(","),t=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),r=transparentBehav.HSV.split(","),a=parseFloat(r[0]),n=parseFloat(r[1]),i=parseFloat(r[2]);"jpg"==b||"jpeg"==b||"png"==b?"RGB"==transparentBehav.mode?s.setAttribute("material","shader: chromaKey; color: #"+t.getHexString()+";transparent: true; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";"):"HSV"==transparentBehav.mode&&s.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+a+"; _keyingColorS:"+n+"; _keyingColorV:"+i+"; _deltaH:"+parseFloat(transparentBehav.hue)+"; _deltaS:"+parseFloat(transparentBehav.saturation)+"; _deltaV:"+parseFloat(transparentBehav.brightness)+";"):"gif"==b&&("RGB"==transparentBehav.mode?(s.setAttribute("geometry","primitive: plane"),s.setAttribute("material","shader:gif_RGB;  src: url("+o.res_url+"); opacity: 1; transparent: true; depthWrite:false; color: #"+t.getHexString()+"; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";")):"HSV"==transparentBehav.mode&&(s.setAttribute("geometry","primitive: plane"),s.setAttribute("material","shader:gif_HSV;  src: url("+o.res_url+"); opacity: 1; transparent: true; depthWrite:false; _keyingColorH:"+a+"; _keyingColorS:"+n+"; _keyingColorV:"+i+"; _deltaH:"+parseFloat(transparentBehav.hue)+"; _deltaS:"+parseFloat(transparentBehav.saturation)+"; _deltaV:"+parseFloat(transparentBehav.brightness)+";")))}else"jpg"==b||"jpeg"==b||"png"==b?s.setAttribute("material","shader: flat; side:double; opacity: 1.0; transparent: true; "):"gif"==b&&(s.setAttribute("geometry","primitive: plane"),s.setAttribute("material","shader:gif;  src: url("+o.res_url+"); opacity: 1; transparent: true;"));o.behav?1==o.behav.length&&g?s.setAttribute("class","unclickable"):s.setAttribute("class","clickable"):s.setAttribute("class","unclickable"),t.makarObjects.push(s);let _=t.arfScene.renderer.capabilities.getMaxAnisotropy();if(s.addEventListener("materialtextureloaded",(function(e){e.detail.texture.anisotropy=_,e.detail.texture.needsUpdate=!0})),s.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){let e=setInterval((function(){if(p.image&&s.object3D&&s.object3D.children&&s.object3D.children[0]&&s.object3D.children[0].scale){s.object3D.children[0].scale.set(25.4*p.image.width/c,25.4*p.image.height/c,1);let r=o.quaternionRotation.split(","),m=new THREE.Quaternion(Number(r[1]),Number(r[2]),Number(r[3]),Number(r[0])),h=new THREE.Vector3;if(o.obj_parent_id){s.object3D.obj_parent_id=o.obj_parent_id,h.addScaledVector(a,2540/c);let e=h.z;h.z=-e,t.setAframeTransform(s,h,n,i,m)}else{switch(window.serverVersion){case"2.0.0":i.multiplyScalar(1),h.addScaledVector(a,2540/c);break;case"3.0.0":h.addScaledVector(a,5080/c),i.multiplyScalar(2);break;default:console.log("three.js: _loadAframeTexture: serverVersion version wrong",serverVersion)}let e=h.y,r=h.z;h.y=r,h.z=e,t.setAframeTransform(s,h,n,i,m),s.object3D.position.add(new THREE.Vector3(25.4*d/c/2,25.4*u/c/2,0)),s.object3D.rotation.x+=90*Math.PI/180}let b=s.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone()},o.blockly&&(b.resetProperty=function(){}),s.setAttribute("heightForQuiz",.01*p.image.height),window.clearInterval(e),l(s)}}),1);s.object3D.makarType="image",s.object3D.makarObject=!0,o.behav&&(s.object3D.behav=o.behav,t.setObjectBehavAll(o,m)),o.behav_reference&&(s.object3D.behav_reference=o.behav_reference),"button"==o.main_type&&(s.object3D.main_type=o.main_type,s.object3D.sub_type=o.sub_type,s.setAttribute("class","clickable"),console.log("three.js: _loadAframeTexture: button ",s))}else console.log("three.js: _loadAframeTexture: loaded target different")})),0==o.active&&(s.setAttribute("visible",!1),s.setAttribute("class","unclickable")),o.behav_reference)for(let e=0;e<o.behav_reference.length;e++)if("ShowImage"==o.behav_reference[e].behav_name){s.setAttribute("visible",!1),s.setAttribute("class","unclickable");break}if(o.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(o.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(s),window.clearInterval(e))}),1)}else e.appendChild(s)}else console.log("ARFunc.js: _loadAframeTexture , obj url not exist ",o),o.main_type="model",o.sub_type="glb",o.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",o.material=[],t.loadAframeGLTFModel(e,o,a,n,i,t.cubeTex),l(1)}))}))},this.loadCanvas2D=function(e,r,o,a,n,i){let l="";if(Array.isArray(r.project_module))if(1==r.project_module.length)if(r.project_module[0].scratch_image_url){var s=this.getDefaultImageUrl(r.project_module[0].scratch_image_url);s.indexOf("https")>=0?l=s:console.error("three.js: _loadCanvas2D: error, obj.project_module[0].scratch_image_url not include [https]",r)}else console.log("three.js: _loadCanvas2D: obj.project_module[0].scratch_image_url not exist or empty, use default"),l="https://mifly0makar0assets.s3-ap-northeast-1.amazonaws.com/DefaultResource/2D/modules/scratchCard/ScratchCard_Default.png";else console.error("three.js: _loadCanvas2D: error, obj.project_module length>1",r);else console.error("three.js: _loadCanvas2D: error, obj.project_module not array",r);if(""==l)return;let c,d,u,m=t.sceneTargetList[e.GCSSID].projIndex,p=t.getProjectVersion(m);if(Array.isArray(p)&&3==p.length){let e=Number(p[0]),t=Number(p[1]),o=Number(p[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=h();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadCanvas2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadCanvas2D: rect PSO=",e,t,o,a,n),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadCanvas2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}}else{let e=h();e.rectP&&e.rectSizeDelta&&e.rectScale?(c=e.rectP,d=e.rectSizeDelta,u=e.rectScale):texture2DResolve(!1)}function h(){let e,o,i,l,s={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){let c=t.getResolutionIndex(m);Number.isFinite(c)||(console.log(" _getObj2DInfo338: error, missing _selectedResolutionIndex"),c=0);let d=r.rect_transform[c];if(d.position&&d.rotation&&d.scale){e=d.position.split(",").map((function(e){return Number(e)})),o=d.size_dalta.split(",").map((function(e){return Number(e)})),i=d.scale.split(",").map((function(e){return Number(e)})),l=d.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3])),r=new THREE.Euler;r.setFromQuaternion(t),a.z=r.z/Math.PI*180,n.x=i[0],n.y=i[1],s={rectP:e,rectSizeDelta:o,rectScale:i}}}return s}let b,g,_=t.get2DScaleRatioByProjIndex(m);b=d[0]*n.x*_,g=d[1]*n.y*_;let f=document.createElement("div");f.setAttribute("class","scratchCanvasContainer"),f.setAttribute("id",r.obj_id),f.style.width=b+"px",f.style.height=g+"px",f.style.left=innerWidth/2-b/2+c[0]*_+"px",f.style.top=innerHeight/2-g/2+-c[1]*_+"px";let j=document.createElement("canvas"),y=j.getContext("2d");j.setAttribute("class","scratchCanvas"),j.setAttribute("width",b),j.setAttribute("height",g);let w=new Image;w.onload=function(){y.drawImage(w,0,0,w.width,w.height,0,0,j.width,j.height),i&&setTimeout((function(){i(E)}),1)};let v=new XMLHttpRequest;v.open("GET",l),v.responseType="blob",v.onload=function(e){let t=(window.URL||window.webkitURL).createObjectURL(this.response);w.src=t},v.send(),f.appendChild(j),document.body.appendChild(f);let E=new THREE.Object3D;E.obj_id=r.obj_id,E.main_type="module",E.sub_type="scratch_card",E.canvasDomElement=f,r.project_module[0].password?E.password=r.project_module[0].password:E.password="",e.add(E),aScratchCard.setCanvas(j,f,E)},this.loadAframeTexture2D=function(e,r,o,a,n,i,l,s){console.log("three.js: arController: _loadAframeTexture2D , obj=",r,i,l,s,o),t.checkDefaultImage(r);let c=t.sceneTargetList[e.GCSSID].projIndex,d=t.getProjectVersion(c);return new Promise((function(i){(new THREE.TextureLoader).load(o,(function(u){let m,p,h,b,g;if(Array.isArray(d)&&3==d.length){let e=Number(d[0]),t=Number(d[1]),o=Number(d[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=_();e.rectP&&e.rectSizeDelta&&e.rectScale?(m=e.rectP,p=e.rectSizeDelta,h=e.rectScale):i(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadAframeTexture2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadAframeTexture2D: rect PSO=",e,t,o,l,s),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadAframeTexture2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(m=e.rectP,p=e.rectSizeDelta,h=e.rectScale):i(!1)}}else{let e=_();e.rectP&&e.rectSizeDelta&&e.rectScale?(m=e.rectP,p=e.rectSizeDelta,h=e.rectScale):i(!1)}function _(){let e,o,a,n,i={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){let d=t.getResolutionIndex(c);Number.isFinite(d)||(console.log(" _loadAframeTexture2D: _getObj2DInfo338: error, missing _selectedResolutionIndex"),d=0);let u=r.rect_transform[d];if(u.position&&u.rotation&&u.scale){e=u.position.split(",").map((function(e){return Number(e)})),o=u.size_dalta.split(",").map((function(e){return Number(e)})),a=u.scale.split(",").map((function(e){return Number(e)})),n=u.rotation.split(",").map((function(e){return Number(e)}));let t=new THREE.Quaternion(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),r=new THREE.Euler;r.setFromQuaternion(t),l.z=r.z/Math.PI*180,s.x=a[0],s.y=a[1],i={rectP:e,rectSizeDelta:o,rectScale:a}}}return i}u.flipY=!1,console.log("three.js: _loadAframeTexture2D: innerWH , camera2D ",innerWidth,innerHeight,t.arfScene.clientWidth,t.arfScene.clientHeight);let f=t.get2DScaleRatioByProjIndex(c);b=p[0]*f,g=p[1]*f;let j=r.sub_type,y=new THREE.Object3D;y.makarType="image2D";let w,v,E,k=!1;if(r.behav)for(let e=0;e<r.behav.length;e++)"TransparentImage"==r.behav[e].simple_behav&&(k=!0,arrayColor=r.behav[e].chromakey.split(","),slope=r.behav[e].slope,threshold=r.behav[e].threshold,w=r.behav[e],console.log("three.js: _loadAframeTexture2D: behav TransparentImage",r.behav[e]));if(k){let e,t=w.HSV.split(","),r=parseFloat(t[0]),a=parseFloat(t[1]),n=parseFloat(t[2]);"jpg"==j||"jpeg"==j||"png"==j||"button"==j?("RGB"==w.mode?e=new THREE.ChromaKeyMaterial({map:u,keyColor:arrayColor,side:THREE.DoubleSide,slope,threshold}):"HSV"==w.mode&&(e=new THREE.HSVMattingMaterial({map:u,side:THREE.DoubleSide,_keyingColorH:r,_keyingColorS:a,_keyingColorV:n,_deltaH:w.hue,_deltaS:w.saturation,_deltaV:w.brightness})),v=new THREE.Mesh(new THREE.PlaneGeometry(b,g),e)):"gif"==j&&(E=new THREE.gifAnimator,E.init({src:o,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0,chroma:w}),y.gifObject=E,E.__texture.flipY&&(E.__texture.flipY=!1),v=new THREE.Mesh(new THREE.PlaneGeometry(b,g),E.material))}else"jpg"==j||"jpeg"==j||"png"==j||"button"==j?v=new THREE.Mesh(new THREE.PlaneGeometry(b,g),new THREE.MeshBasicMaterial({map:u,side:THREE.DoubleSide,transparent:!0})):"gif"==j&&(E=new THREE.gifAnimator,E.init({src:o,side:THREE.DoubleSide,transparent:!0,opacity:1,autoplay:!0}),y.gifObject=E,E.__texture.flipY&&(E.__texture.flipY=!1),v=new THREE.Mesh(new THREE.PlaneGeometry(b,g),E.material));if(r.behav_reference){y.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowImage"==r.behav_reference[e].behav_name&&(y.visible=!1,"gif"==j&&(E.pause(),E.__autoplay=!1))}if(r.behav&&(y.behav=r.behav,t.setObjectBehavAll(r,c)),0==r.active&&(y.visible=!1),r.behav_reference){y.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowImage"==r.behav_reference[e].behav_name&&(y.visible=!1)}if("button"==r.main_type&&(y.main_type=r.main_type,y.sub_type=r.sub_type,console.log("three.js: _loadAframeTexture2D: button ",v)),r.obj_parent_id){let e=function(){let o=!1;for(let e=0;e<t.makarObjects2D.length;e++)t.makarObjects2D[e].obj_id==r.obj_parent_id&&(o=!0);if(0==o)setTimeout(e,500);else for(let e=0;e<t.makarObjects2D.length;e++)if(t.makarObjects2D[e].obj_id==r.obj_parent_id){y.translateX(m[0]*f),y.translateY(-m[1]*f);let o=new THREE.Vector3;t.makarObjects2D[e].getWorldPosition(o),y.translateZ(a/n-1-o.z),y.rotateZ(-l.z/180*Math.PI),y.scale.set(s.x,s.y,1),t.makarObjects2D[e].add(y),t.makarObjects2D.push(y),y.add(v),y.makarObject=!0,y.obj_id=r.obj_id,y.obj_parent_id=r.obj_parent_id,i(y),console.log("three.js: _loadAframeTexture2D: parent exit, set obj(parent) ",r,v)}};e()}else y.translateX(m[0]*f),y.translateY(-m[1]*f),y.translateZ(a/n-1),y.rotateZ(-l.z/180*Math.PI),y.scale.set(s.x,s.y,1),t.makarObjects2D.push(y),e.add(y),y.add(v),y.makarObject=!0,y.obj_id=r.obj_id,i(y)}),void 0,(function(e){console.error("An error happened. _loadAframeTexture2D , err=",e)}))}))},this.loadDeaultTexture2D=function(e,t,r,o,a,n,i){(new THREE.TextureLoader).load(t,(function(t){let l,s,c,d,u;l=[0,0,0],s=[150,150],c=n,t.flipY=!1,d=t.image.width*a.x*2/3,u=t.image.height*a.y*2/3;var m=new THREE.Mesh(new THREE.PlaneGeometry(d,u),new THREE.MeshBasicMaterial({map:t,side:THREE.DoubleSide,transparent:!0,opacity:1}));switch(.5==c[0]&&.5==c[1]||(1==c[0]&&.5==c[1]?m.translateX(240-1*d/2):0==c[0]&&.5==c[1]?m.translateX(1*d/2-240):.5==c[0]&&1==c[1]?m.translateY(1*u/2-320):.5==c[0]&&0==c[1]?m.translateY(320-1*u/2):0==c[0]&&1==c[1]?(m.translateX(1*d/2-240),m.translateY(1*u/2-320)):1==c[0]&&1==c[1]?(m.translateX(240-1*d/2),m.translateY(1*u/2-320)):0==c[0]&&0==c[1]?(m.translateX(1*d/2-240),m.translateY(320-1*u/2)):1==c[0]&&0==c[1]&&(m.translateX(240-1*d/2),m.translateY(320-1*u/2))),m.translateX(2*l[0]/3),m.translateY(1*-l[1]/2),m.translateX(r.x),m.translateY(-r.y),m.rotateZ(-o.z/180*Math.PI),i.simple_behav){case"coloring":if(m.behav=[{simple_behav:"Coloring",enable:!1}],m.makarObject=!0,m.name="colorButton",m.material.opacity=1,arController&&arController.arfScene&&arController.arfScene.clientHeight){let e=arController.arfScene.clientHeight;m.position.y=.35*e}break;case"snapShot":m.behav=[{simple_behav:"SnapShot",enable:!0}],m.makarObject=!0;break;case"exchangeCamera":m.behav=[{simple_behav:"exchangeCamera",enable:!0}],m.makarObject=!0;break;case"runAnimation2D":m.behav=[i],m.makarObject=!0;break;default:console.log("three.js: _loadDeaultTexture2D: default: behav=",i)}m.defaultTexture=!0,m.visible=!0,e.add(m)}),void 0,(function(e){console.error("An error happened. _loadDeaultTexture2D")}))},this.loadAframeVideo=function(e,r,o,a,n){return new Promise((function(i){t.UrlExistsFetch(r.res_url).then((l=>{if(1==l){let l=t.gcssTargets.dpi[e.GCSSID],c=t.gcssTargets.width[e.GCSSID],d=t.gcssTargets.height[e.GCSSID],u=(t.sceneTargetList[e.GCSSID].projIndex,document.getElementById("makarAssets"));var s;(s=document.createElement("video")).src=r.res_url,s.playsInline=!0,s.autoplay=!1,s.loop=!0,s.setAttribute("crossorigin","anonymous"),s.setAttribute("id",r.obj_id+"_"+r.res_id),u.appendChild(s),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&(s.muted=!0),s.onloadedmetadata=function(){var u,m;s.videoWidth>=s.videoHeight?(u=1,m=1*s.videoHeight/s.videoWidth):(u=1*s.videoWidth/s.videoHeight,m=1);let p=document.createElement("a-video"),h=!1;if(r.behav)for(let e=0;e<r.behav.length;e++)"TransparentVideo"==r.behav[e].simple_behav&&(h=!0,chromaKey=r.behav[e].chromakey,slope=r.behav[e].slope,threshold=r.behav[e].threshold,transparentBehav=r.behav[e]);if(h){let e=chromaKey.split(",");var b=new THREE.Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));let t=transparentBehav.HSV.split(","),r=parseFloat(t[0]),o=parseFloat(t[1]),a=parseFloat(t[2]);"RGB"==transparentBehav.mode?p.setAttribute("material","shader: chromaKey; color: #"+b.getHexString()+";transparent: true; _slope: "+parseFloat(slope)+"; _threshold: "+parseFloat(threshold)+";"):"HSV"==transparentBehav.mode&&p.setAttribute("material","shader: HSVMatting; transparent: true; _keyingColorH:"+r+"; _keyingColorS:"+o+"; _keyingColorV:"+a+"; _deltaH:"+transparentBehav.hue+"; _deltaS:"+transparentBehav.saturation+"; _deltaV:"+transparentBehav.brightness+";")}else p.setAttribute("material","side:double; opacity: 1.0; transparent: true; ");r.behav?1==r.behav.length&&h?p.setAttribute("class","unclickable"):p.setAttribute("class","clickable"):p.setAttribute("class","unclickable"),p.setAttribute("id",r.obj_id),p.setAttribute("src","#"+r.obj_id+"_"+r.res_id),p.mp4Video=s;let g=t.arfScene.renderer.capabilities.getMaxAnisotropy();p.addEventListener("materialtextureloaded",(function(e){console.log("three.js: _loadVideo: _materialtextureloaded: videoPlane = ",p.object3D,e),e.detail.texture.anisotropy=g,e.detail.texture.needsUpdate=!0})),p.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: videoPlane.loaded: vw vh = ",u,m,e),p.object3D.children[0].scale.set(100*u*25.4/l,100*m*25.4/l,1);let h=r.quaternionRotation.split(","),b=new THREE.Quaternion(Number(h[1]),Number(h[2]),Number(h[3]),Number(h[0])),g=new THREE.Vector3;if(r.obj_parent_id){p.object3D.obj_parent_id=r.obj_parent_id,g.addScaledVector(o,2540/l);let e=g.z;g.z=-e,t.setAframeTransform(p,g,a,n,b)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),g.addScaledVector(o,2540/l);break;case"3.0.0":n.multiplyScalar(2),g.addScaledVector(o,5080/l);break;default:console.log("three.js: _loadAframeVideo: serverVersion version wrong",serverVersion)}let e=g.y,r=g.z;g.y=r,g.z=e,t.setAframeTransform(p,g,a,n,b),p.object3D.position.add(new THREE.Vector3(25.4*c/l/2,25.4*d/l/2,0)),p.object3D.rotation.x+=90*Math.PI/180,console.log("three.js: _loadAframeVideo: loaded: no parent prs=",p.object3D.position,p.object3D.rotation,p.object3D.scale)}let _=p.object3D;_.originTransform={position:_.position.clone(),rotation:_.rotation.clone(),scale:_.scale.clone()},r.blockly&&(_.resetProperty=function(){s.pause()}),p.object3D.makarType="video",p.object3D.makarObject=!0,r.behav&&(p.object3D.behav=r.behav,t.setObjectBehavAll(r)),r.behav_reference&&(p.object3D.behav_reference=r.behav_reference),i(p)}})),t.makarObjects.push(p),0==r.active&&(p.setAttribute("visible",!1),p.setAttribute("class","unclickable"));let _=!1;if(r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowVideo"==r.behav_reference[e].behav_name){_=!0,p.setAttribute("visible",!1),p.setAttribute("class","unclickable"),s.muted=!1;break}if(r.obj_parent_id){s.autoplay=!1;let e=setInterval((function(){let o=document.getElementById(r.obj_parent_id);o&&o.object3D.children.length>0&&(o.appendChild(p),window.clearInterval(e),o.addEventListener("child-attached",(function(e){if(console.log("three.js: arController: _loadVideo,: parent child-attached, el=",e),r.blockly)p.blockly=r.blockly,s.pause(),s.currentTime=0;else{let e=!0;p.object3D.traverseAncestors((function(r){"Scene"!=r.type?(console.log("three.js: arController: _loadVideo,: traverseAncestors: not Scene parent=",r),0==r.visible&&(e=!1)):1==e&&1==p.object3D.visible&&0==_?(console.log("three.js: arController: _loadVideo,: traverseAncestors: all parent visible true=",p.object3D),s.autoplay=!0,s.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==r.location)&&t.dealVideoMuted(s)):(console.log("three.js: arController: _loadVideo,: traverseAncestors: not all parent visible true=",p.object3D),s.muted=!1,s.autoplay=!1,s.pause(),s.currentTime=0)}))}})))}),1)}else r.blockly?(p.blockly=r.blockly,s.pause(),s.currentTime=0,s.muted=!1):(s.autoplay=!0,s.play(),window.Browser&&(null==window.Browser.name||"safari"==window.Browser.name||1!=window.allowAudioClicked&&location==parent.location)&&t.dealVideoMuted(s)),e.appendChild(p)}}else console.log("ARFunc.js: _loadAframeVideo , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],t.loadAframeGLTFModel(e,r,o,a,n,t.cubeTex),i(1)}))}))},this.loadYouTubeVideo=function(e,r,o,a,n,i){var l=t.gcssTargets.dpi[e.GCSSID],s=t.gcssTargets.width[e.GCSSID],c=t.gcssTargets.height[e.GCSSID],d=!1;let u,m=r.indexOf("v=")+2,p=r.slice(m).indexOf("&");u=-1!=p?r.slice(m,m+p):r.slice(m),console.log("createCssYouTube ytID=",u);var h=document.createElement("div");h.setAttribute("id",u),document.body.appendChild(h);var b,g=(b={id:u,videoId:u},console.log("createPlayer playerInfo=",b),new YT.Player(b.id,{videoId:b.videoId,playerVars:{rel:1,fs:0,autoplay:0,showinfo:0,controls:1,disablekb:1,modestbranding:1,playsinline:1,enablejsapi:1},events:{onReady:function(e){},onStateChange:function(e){console.log("onPlayerStateChange, event.target=",e.target),console.log("onPlayerStateChange, event.data=",e.data),e.data!=YT.PlayerState.PLAYING||d||(d=!0)}}}));console.log("0 curplayer.getIframe()=",g);var _=document.createElement("div");_.setAttribute("id","divContainer"),_.style.width=g.getIframe().width/1+"px",_.style.height=g.getIframe().height/1+"px";var f=document.createElement("div");f.setAttribute("id","divMask"),f.style.backgroundColor="rgba(0, 0, 0, 0)",f.style.zIndex=5,f.style.width=g.getIframe().width/1+"px",f.style.height=g.getIframe().height/1+"px",f.style.position="absolute",_.appendChild(f),_.appendChild(g.getIframe());var j=new THREE.CSS3DObject(_);console.log("loadYouTubeVideo: dpi=",l,", GCSSWidth=",s,", GCSSHeight=",c),console.log("loadYouTubeVideo: position=",a,", rotation=",n,", scale=",i),j.rotation.x=Math.PI/2,j.position.set(25.4*s/l/2,25.4*c/l/2,0),a.x;let y=a.y,w=a.z;a.y=w,a.z=y;var v=a.clone();v.addScaledVector(a,2540/l),j.position.add(v),j.scale.set(.2,.2,.2),j.updateMatrix(),e.add(j)},this.loadAframeText=function(e,r,o,a,n){return new Promise((function(i){let l=t.gcssTargets.dpi[e.GCSSID],s=t.gcssTargets.width[e.GCSSID],c=t.gcssTargets.height[e.GCSSID],d=(t.sceneTargetList[e.GCSSID].projIndex,document.createElement("a-entity"));d.setAttribute("id",r.obj_id),t.makarObjects.push(d),r.behav||"button"==r.main_type?d.setAttribute("class","clickable"):d.setAttribute("class","unclickable");let u=document.createElement("a-text");u.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),u.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let m=r.content.split("\n"),p=0;const h=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<m.length;e++){let t=0;for(let r=0;r<m[e].length;r++)b=m[e][r],h.test(b)?t+=1.6:m[e][r]==m[e][r].toUpperCase()&&m[e][r]!=m[e][r].toLowerCase()||m[e][r]==m[e][r].toLowerCase()&&m[e][r]!=m[e][r].toUpperCase()?t+=1:isNaN(1*m[e][r])?t+=1.25:t+=1;t>p&&(p=t)}var b;u.setAttribute("value",r.content),u.setAttribute("width",.08*p),u.setAttribute("wrap-count",p+1),u.setAttribute("anchor","center"),u.setAttribute("align","left"),u.setAttribute("backcolor",r.back_color),u.setAttribute("textcolor",r.color),u.setAttribute("side","double");let g="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/",_=[g+"1-msdf.json",g+"2-msdf.json",g+"3-msdf.json",g+"4-msdf.json",g+"5-msdf.json",g+"6-msdf.json",g+"7-msdf.json",g+"8-msdf.json",g+"9-msdf.json",g+"10-msdf.json",g+"11-msdf.json",g+"12-msdf.json"];u.setAttribute("font",_),u.setAttribute("negate","false"),u.setAttribute("crossorigin","anonymous");let f=r.color.split(","),j=new THREE.Color(parseFloat(f[0]),parseFloat(f[1]),parseFloat(f[2]));u.setAttribute("color","#"+j.getHexString());let y=0;if(u.addEventListener("geometry-set",(function e(t){console.log("three.js: _loadAframeText: textEntity geometry-set: evt=",t),0==y?y=1:1==y&&i(u),u.removeEventListener("geometry-set",e)})),d.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){console.log("three.js: _loadAframeText: anchor loaded: evt=",e),u.object3D.scale.set(2540/l,2540/l,2540/l);let m=r.quaternionRotation.split(","),p=new THREE.Quaternion(Number(m[1]),Number(m[2]),Number(m[3]),Number(m[0])),h=new THREE.Vector3;if(r.obj_parent_id){d.object3D.obj_parent_id=r.obj_parent_id,h.addScaledVector(o,2540/l);let e=h.z;h.z=-e,t.setAframeTransform(d,h,a,n,p)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),h.addScaledVector(o,2540/l);break;case"3.0.0":n.multiplyScalar(2),h.addScaledVector(o,5080/l);break;default:console.log("three.js: _loadAframeText: serverVersion version wrong",serverVersion)}let e=h.y,r=h.z;h.y=r,h.z=e,t.setAframeTransform(d,h,a,n,p),d.object3D.position.add(new THREE.Vector3(25.4*s/l/2,25.4*c/l/2,0)),d.object3D.rotation.x+=90*Math.PI/180,console.log(" +++++++++ set done",d.object3D.position,d.object3D.rotation,d.object3D.scale)}let b=d.object3D;b.originTransform={position:b.position.clone(),rotation:b.rotation.clone(),scale:b.scale.clone(),textContent:r.content,textColor:j,textBackColor:r.back_color},r.blockly&&(b.resetProperty=function(){u.getAttribute("value")!=r.content||u.components.text.attrValue.color!="#"+j.getHexString()||u.components.text.attrValue.backcolor!=r.back_color?(console.log("three.js: _loadAframeText: do reset"),u.components.text.textMesh.children.length=0,u.object3D.children.length=1,u.setAttribute("value",r.content),u.setAttribute("color","#"+j.getHexString()),u.setAttribute("backcolor",r.back_color)):console.log("three.js: _loadAframeText: text same, reset do nothing ")}),d.object3D.makarObject=!0,d.object3D.makarType="text",r.behav&&(d.object3D.behav=r.behav,t.setObjectBehavAll(r)),r.behav_reference&&(d.object3D.behav_reference=r.behav_reference),"button"==r.main_type&&(d.object3D.main_type=r.main_type),0==y?y=1:1==y&&i(u)}})),d.appendChild(u),0==r.active&&(d.setAttribute("visible",!1),d.setAttribute("class","unclickable")),r.behav_reference)for(let e=0;e<r.behav_reference.length;e++)if("ShowText"==r.behav_reference[e].behav_name){d.setAttribute("visible",!1),d.setAttribute("class","unclickable");break}if(r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(d),window.clearInterval(e))}),1)}else e.appendChild(d)}))},this.loadAframeText2D=function(e,r,o,a,n,i,l){return console.log(" _loadAframeText2D: obj=",r),new Promise((function(n){let s,c,d,u,m,p=t.sceneTargetList[e.GCSSID].projIndex,h=t.getProjectVersion(p);if(Array.isArray(h)&&3==h.length){let e=Number(h[0]),t=Number(h[1]),o=Number(h[2]);if(e>3||3==e&&t>3||3==e&&3==t&&o>8){let e=b();e.rectP&&e.rectSizeDelta&&e.rectScale?(s=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}else{let e=function(){let e,t,o;return r.rect_transform?5!=r.rect_transform.length?void console.log(" _loadAframeText2D: fail, rect_transform.length !=5",r.rect_transform.length):(e=r.rect_transform[0].split(",").map((function(e){return Number(e)})),t=r.rect_transform[1].split(",").map((function(e){return Number(e)})),o=r.rect_transform[2].split(",").map((function(e){return Number(e)})),console.log(" _loadAframeText2D: rect PSO=",e,t,o,i,l),{rectP:e,rectSizeDelta:t,rectScale:o}):void console.log(" _loadAframeText2D: fail, no rect_transform")}();e.rectP&&e.rectSizeDelta&&e.rectScale?(s=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}}else{let e=b();e.rectP&&e.rectSizeDelta&&e.rectScale?(s=e.rectP,c=e.rectSizeDelta,d=e.rectScale):texture2DResolve(!1)}function b(){let e,o,a,n,s=t.getResolutionIndex(p),c={};if(r.rect_transform&&Array.isArray(r.rect_transform)&&r.rect_transform.length>0){Number.isFinite(s)||(console.log(" _loadAframeText2D: _getObj2DInfo338: error, missing _selectedResolutionIndex",s),s=0);let t=r.rect_transform[s];if(t.position&&t.rotation&&t.scale){e=t.position.split(",").map((function(e){return Number(e)})),o=t.size_dalta.split(",").map((function(e){return Number(e)})),a=t.scale.split(",").map((function(e){return Number(e)})),n=t.rotation.split(",").map((function(e){return Number(e)}));let r=new THREE.Quaternion(parseFloat(n[0]),parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),s=new THREE.Euler;s.setFromQuaternion(r),i.z=s.z/Math.PI*180,l.x=a[0],l.y=a[1],c={rectP:e,rectSizeDelta:o,rectScale:a}}}return console.log(" _loadAframeText2D: _getObj2DInfo338: tempInfo",c),c}let g=t.get2DScaleRatioByProjIndex(p);u=c[0]*g,m=c[1]*g;let _=0,f=r.content.split("\n");for(let e=0;e<f.length;e++)f[e].length>_&&(_=f[e].length);let j=u/_*1,y=m/f.length*.9,w=175*g,v=Math.min(j,y,w);console.log(" _loadAframeText2D: fontSize: ",r.content,v,_,"[",j,",",u,"]",", [",y,",",m,"], ",w);let E=new THREE.Object3D;if(E.makarType="text2D",r.behav&&(E.behav=r.behav,t.setObjectBehavAll(r)),0==r.active&&(E.visible=!1),r.behav_reference){E.behav_reference=r.behav_reference;for(let e=0;e<r.behav_reference.length;e++)"ShowText"==r.behav_reference[e].behav_name&&(E.visible=!1)}let k=document.createElement("a-text");k.setAttribute("geometry","primitive:plane; width: auto; height: auto; skipCache: true;"),k.setAttribute("material","opacity: 0.0 ; depthWrite:false; color:#000000; side:double;");let T=r.content.split("\n"),A=0;const D=/[\u4e00-\u9fff]|[\u3400-\u4dbf]|[\u{20000}-\u{2a6df}]|[\u{2a700}-\u{2b73f}]|[\u{2b740}-\u{2b81f}]|[\u{2b820}-\u{2ceaf}]|[\uf900-\ufaff]|[\u3300-\u33ff]|[\ufe30-\ufe4f]|[\uf900-\ufaff]|[\u{2f800}-\u{2fa1f}]/u;for(let e=0;e<T.length;e++){textLength=0;for(let t=0;t<T[e].length;t++)S=T[e][t],D.test(S)?textLength+=1.6:T[e][t]==T[e][t].toUpperCase()&&T[e][t]!=T[e][t].toLowerCase()||T[e][t]==T[e][t].toLowerCase()&&T[e][t]!=T[e][t].toUpperCase()?textLength+=1:isNaN(1*T[e][t])?textLength+=1.25:textLength+=1;textLength>A&&(A=textLength)}var S;k.setAttribute("value",r.content),k.setAttribute("width",.08*A),k.setAttribute("width",u),k.setAttribute("height",m),k.setAttribute("fontsize",v),k.setAttribute("wrap-count",A),k.setAttribute("anchor","left"),k.setAttribute("align","left"),k.setAttribute("baseline","top"),k.setAttribute("textcolor",r.color),k.setAttribute("side","double");var x="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/resource/fonts/";let R=[x+"1-msdf.json",x+"2-msdf.json",x+"3-msdf.json",x+"4-msdf.json",x+"5-msdf.json",x+"6-msdf.json",x+"7-msdf.json",x+"8-msdf.json",x+"9-msdf.json",x+"10-msdf.json",x+"11-msdf.json",x+"12-msdf.json"];k.setAttribute("font",R),k.setAttribute("negate","false"),k.setAttribute("crossorigin","anonymous");let M,C,I=r.color.split(","),P=new THREE.Color(parseFloat(I[0]),parseFloat(I[1]),parseFloat(I[2]));k.setAttribute("color","#"+P.getHexString()),document.getElementById("aTempScene")&&document.getElementById("aTempDiv")?C=document.getElementById("aTempScene"):(M=document.createElement("div"),M.style.display="none",C=document.createElement("a-scene"),C.setAttribute("id","aTempScene"),C.setAttribute("embedded",""),document.body.appendChild(M),M.appendChild(C)),C.appendChild(k),k.addEventListener("geometry-set",(function(e){let t=k.object3D;t&&(t.children[2]&&t.children[2],console.log("_loadAframeText2D: textEntity geometry-set: textObject=",t,e)),n(E)})),k.addEventListener("loaded",(function(n){let c=k.object3D;if("button"==r.main_type&&(E.main_type=r.main_type),c.rotation.x=Math.PI,c.scale.set(190,190,1),r.obj_parent_id){c.obj_parent_id=r.obj_parent_id;let e=function(){let n=!1;for(let e=0;e<t.makarObjects2D.length;e++)t.makarObjects2D[e].obj_id==r.obj_parent_id&&(n=!0);if(0==n)setTimeout(e,200);else for(let e=0;e<t.makarObjects2D.length;e++)if(t.makarObjects2D[e].obj_id==r.obj_parent_id){E.add(c),E.translateX(s[0]*g),E.translateY(-s[1]*g),E.translateZ(o/a-1),E.rotateZ(-i.z/180*Math.PI),E.scale.set(l.x,l.y,1),E.makarObject=!0,E.obj_id=r.obj_id,E.obj_parent_id=r.obj_parent_id,t.makarObjects2D[e].add(E),t.makarObjects2D.push(E);break}};e()}else E.add(c),E.translateX(s[0]*g),E.translateY(-s[1]*g),E.translateZ(o/a-1),E.rotateZ(-i.z/180*Math.PI),E.scale.set(l.x,l.y,1),E.makarObject=!0,E.obj_id=r.obj_id,t.makarObjects2D.push(E),e.add(E)}))}))},this.loadAframeAudio=function(e,r,o,a,n){return new Promise((function(i){t.UrlExistsFetch(r.res_url).then((l=>{if(1==l){let l=r.quaternionRotation.split(","),s=new THREE.Quaternion(Number(l[1]),Number(l[2]),Number(l[3]),Number(l[0])),c=document.getElementById("makarAssets"),d=document.createElement("audio");d.setAttribute("id",r.obj_id+"_"+r.res_id),d.setAttribute("src",r.res_url),d.setAttribute("crossorigin","anonymous"),d.setAttribute("loop",!0),d.setAttribute("preload","auto"),c.appendChild(d),d.onloadedmetadata=function(){let l=document.createElement("a-entity");l.setAttribute("sound","src: #"+r.obj_id+"_"+r.res_id+"; autoplay: true; loop: true; volume: 1; positional: false"),l.setAttribute("id",r.obj_id),t.setAframeTransform(l,o,a,n,s),t.makarObjects.push(l);let c=!0;0==r.active&&(l.setAttribute("sound","loop: false"),l.setAttribute("visible",!1),c=!1,l.setAttribute("class","unclickable"));let d=!1;if(r.behav_reference){for(let e=0;e<r.behav_reference.length;e++)if("PlayMusic"==r.behav_reference[e].behav_name){d=!0,l.setAttribute("sound","loop: false"),l.setAttribute("visible",!1),c=!1,l.setAttribute("class","unclickable"),l.setAttribute("sound","autoplay: false ");break}}else l.setAttribute("visible",!0);if(r.obj_parent_id){l.setAttribute("sound","autoplay: false");let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(l),window.clearInterval(e),t.addEventListener("child-attached",(function(e){if(r.blockly)l.blockly=r.blockly,l.setAttribute("sound","autoplay: false");else{let e=!0;l.object3D.traverseAncestors((function(t){if("Scene"!=t.type)console.log("three.js: arController: _loadAudio,: traverseAncestors: not Scene parent=",t),0==t.visible&&(e=!1);else if(1==e&&1==l.object3D.visible&&0==d&&1==c)if(console.log("three.js: arController: _loadAudio,: traverseAncestors: all parent visible true=",l.components.sound),1!=window.allowAudioClicked){l.setAttribute("sound","autoplay: false");let e=document.getElementById("clickToPlayAudio");e.style.display="block",e.addEventListener("click",(function t(){l.components.sound.playSound(),e.style.display="none",e.removeEventListener("click",t),window.allowAudioClicked=!0}))}else l.setAttribute("sound","autoplay: true");else console.log("2 three.js: arController: _loadAudio,: traverseAncestors: not all parent visible true=",l.components.sound),l.setAttribute("sound","autoplay: false")}))}})))}),1)}else{if(r.blockly)l.blockly=r.blockly,l.setAttribute("sound","autoplay: false");else if(console.log(" 6666666666666666 ",c,d),1==c&&0==d&&1!=window.allowAudioClicked){l.setAttribute("sound","autoplay: false");let e=document.getElementById("clickToPlayAudio");e.style.display="block",e.addEventListener("click",(function t(){l.components.sound.playSound(),e.style.display="none",e.removeEventListener("click",t),window.allowAudioClicked=!0}))}e.appendChild(l)}l.addEventListener("loaded",(function(e){e.target==e.currentTarget&&(l.object3D.makarType="audio",l.object3D.makarObject=!0,r.behav&&(l.object3D.behav=r.behav,t.setObjectBehavAll(r)),r.behav_reference&&(l.object3D.behav_reference=r.behav_reference),i(l))}))}}else console.log("ARFunc.js: _loadAframeAudio , obj url not exist ",r),r.main_type="model",r.sub_type="glb",r.res_url="https://s3-ap-northeast-1.amazonaws.com/makar.webar.defaultobject/makar_default_objects/3D/MissingFileBox.glb",r.material=[],t.loadAframeGLTFModel(e,r,o,a,n,t.cubeTex),i(1)})).catch((function(e){console.log("_loadAframeAudio: error ",e)}))}))},this.loadAframeLight=function(e,r,o,a,n){return new Promise((function(i){let l=t.gcssTargets.dpi[e.GCSSID],s=t.gcssTargets.width[e.GCSSID],c=t.gcssTargets.height[e.GCSSID],d=(t.sceneTargetList[e.GCSSID].projIndex,document.createElement("a-entity"));d.setAttribute("id",r.obj_id);let u="type:"+r.light.light_type,m=r.light.color.split(","),p=new THREE.Color(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]));u+="; color:#"+p.getHexString(),u+=";intensity:"+r.light.intensity,"point"!=r.light.light_type&&"spot"!=r.light.light_type||(u+=";distance:"+2*r.light.range*100*25.4/l,u+=";decay: 2"),"spot"==r.light.light_type&&(u+=";angle:"+(parseFloat(r.light.spotAngle)/2).toString(),u+=";penumbra: 0.2"),r.light.shadow,d.setAttribute("light",u),"directional"==r.light.light_type&&(d.setAttribute("castShadow",!1),d.setAttribute("light","castShadow: false; ")),0==r.active&&d.setAttribute("visible",!1);let h=r.quaternionRotation.split(","),b=new THREE.Quaternion(Number(h[1]),Number(h[2]),Number(h[3]),Number(h[0]));if(d.addEventListener("loaded",(function(e){if(e.target==e.currentTarget){if("directional"==r.light.light_type){d.object3D.children[0].position.set(0,0,0);let e=new THREE.Object3D;e.position.set(0,0,-1),d.object3D.children[0].target=e,d.object3D.add(e)}let e=new THREE.Vector3;if(r.obj_parent_id){d.object3D.obj_parent_id=r.obj_parent_id,e.addScaledVector(o,2540/l);let i=e.z;e.z=-i,t.setAframeTransform(d,e,a,n,b)}else{switch(window.serverVersion){case"2.0.0":n.multiplyScalar(1),e.addScaledVector(o,2540/l);break;case"3.0.0":n.multiplyScalar(2),e.addScaledVector(o,5080/l);break;default:console.log("three.js: _loadAframeLight: serverVersion version wrong",serverVersion)}let r=e.y,i=e.z;e.y=i,e.z=r,t.setAframeTransform(d,e,a,n,b),d.object3D.position.add(new THREE.Vector3(25.4*s/l/2,25.4*c/l/2,0)),d.object3D.rotation.x+=90*Math.PI/180}let u=d.object3D;u.originTransform={position:u.position.clone(),rotation:u.rotation.clone(),scale:u.scale.clone()},r.blockly&&(u.resetProperty=function(){u.children[0].intensity=r.light.intensity,u.children[0].color.copy(p)}),d.object3D.makarType="light",d.object3D.makarObject=!0,t.makarObjects.push(d),i(d)}})),r.obj_parent_id){let e=setInterval((function(){let t=document.getElementById(r.obj_parent_id);t&&t.object3D.children.length>0&&(t.appendChild(d),window.clearInterval(e))}),1)}else console.log("three.js: _loadAframeLight: loaded: no parent prs=",d.object3D.position,d.object3D.rotation,d.object3D.scale),e.appendChild(d)}))},this.showAframeObjectEvent=function(e,r){let o=e.obj_id,a=document.getElementById(o);if(a)if(a.getAttribute("visible")){if(a.setAttribute("visible",!1),a.setAttribute("class","unclickable"),"a-video"==a.localName){let e=a.getAttribute("src");if(null!=e){e=e.split("#").pop();let t=document.getElementById(e);t instanceof HTMLElement&&t.pause()}}window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||t.UnMutedAndPlayAllVisibleVideo()),a.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("three.js: _showObjectEvent: set false, video blockly: do nothing ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")&&a.object3D!=e)if(e.el.blockly)console.log("three.js: _showObjectEvent: set false, audio blockly: do nothing ",e);else{e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})),r&&a.object3D.traverse((function(e){"Group"==e.type&&(e.el.setAttribute("visible",!1),e.el.setAttribute("class","unclickable"))}))}else{if(window.Browser&&(null!=window.Browser.name&&"safari"!=window.Browser.name||t.UnMutedAndPlayAllVisibleVideo(a)),a.setAttribute("visible",!0),"a-video"==a.localName){let e=a.getAttribute("src");if(null!=e){e=e.split("#").pop();let t=document.getElementById(e);t instanceof HTMLElement&&(t.play(),window.allowAudioClicked=!0)}}a.object3D.behav&&a.setAttribute("class","clickable"),a.object3D.traverse((function(e){if("Group"==e.type&&e.el.getAttribute("visible")){if(e.el.object3D.behav&&e.el.setAttribute("class","clickable"),"a-video"==e.el.localName)if(e.el.blockly)console.log("three.js: _showObjectEvent: set true, video blockly: do nothing  ",e);else{let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.play()}}e.makarObject&&e.el.getAttribute("sound")&&a.object3D!=e&&(e.el.blockly?console.log("three.js: _showObjectEvent: set true, audio blockly: do nothing ",e):e.el.components.sound.playSound())}}))}else console.log("three.js: _showAframeObjectEvent: target not exist",e)},this.hideAframeGroupObjectEvent=function(e){e.getAttribute("visible")&&(e.setAttribute("visible",!1),e.setAttribute("class","unclickable"),e.object3D.traverse((function(e){if("Group"==e.type){if(e.el.setAttribute("class","unclickable"),"a-video"==e.el.localName){let t=e.el.getAttribute("src");if(null!=t){t=t.split("#").pop();let e=document.getElementById(t);e instanceof HTMLElement&&e.pause()}}if(e.makarObject&&e.el.getAttribute("sound")){e.behav_reference&&e.el.setAttribute("visible",!1);for(let t in e.children)"Audio"==e.children[t].children[0].type&&1==e.children[t].children[0].isPlaying&&e.el.components.sound.stopSound()}}})))},this.checkARSceneResultBehav=function(e){if(!Number.isFinite(Number(e)))return void console.error(" _checkARSceneResultBehav: projectIdx error ",e);if(!Array.isArray(sceneResult)||!sceneResult[e])return void console.error(" _checkARSceneResultBehav: _VRSceneResult error ",e,sceneResult);if(!sceneResult[e].data.editor_ver||"string"!=typeof sceneResult[e].data.editor_ver)return void console.error(" _checkARSceneResultBehav: editor_ver error ",sceneResult[e]);let t=sceneResult[e].data.editor_ver.split(".");console.log("_checkARSceneResultBehav: _projectIdx ",e,t);let r=this.editorVersionControllObjs(e);if(console.log("_checkARSceneResultBehav: _scene_objs ",r),!Array.isArray(r))return;let o={},a={};for(let e=0,t=r.length;e<t;e++){let t=r[e];t.behav&&(o[t.obj_id]=t.behav),t.behav_reference&&delete t.behav_reference,t.obj_id&&(a[t.obj_id]=t)}for(let e in o){let t=o[e];for(let e=0,r=t.length;e<r;e++){let r=t[e];if(r.simple_behav,r.obj_id){let e=a[r.obj_id];e&&Array.isArray(e.behav_reference)?e.behav_reference.push({behav_name:r.simple_behav,target_id:r.obj_id}):e?e.behav_reference=[{behav_name:r.simple_behav,target_id:r.obj_id}]:console.error("_checkARSceneResultBehav: cant get _behavObj ",r)}}}},this.setupSceneBehav=function(e){let t=this;for(let e=0,r=t.makarObjects.length;e<r;e++){let r=t.makarObjects[e].object3D;r?(r.behav,r.behav_reference):console.error(" _setupSceneBehav: 3d obj error",e,t.makarObjects[e])}let r=t.lookAtTargetDict[e];if(Array.isArray(r))for(let o=0,a=r.length;o<a;o++){let a=r[o],n=a.lookObjId,i=document.getElementById(n),l=a.lookBehav,s=l.obj_id,c=(l.reverse,document.getElementById(s));i&&i.object3D&&c&&c.object3D?t.addLookAtTimeLine(i,c,a,e):console.log("_setupSceneBehav: _lookAt error, obj not exist",i,c)}},this.addLookAtTimeLine=function(e,t,r,o){console.log(" _addLookAtTimeLine: ",r);let a=this.lookAtTargetTimelineDict[o],n=new THREE.Vector3;t.object3D.getWorldPosition(n);let i=gsap.timeline();a[r.lookObjId]=i,i.to(e.object3D,{duration:1100,delay:0,ease:"none",repeat:-1,onUpdate:function(){t.object3D.getWorldPosition(n),e.object3D.lookAt(n),r.lookBehav&&0==r.lookBehav.reverse&&e.object3D.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI)}})},this.setObjectBehavAll=function(e,t){let r=this.groupEventTargetDict[t],o=this.lookAtTargetDict[t];console.log(" _setObjectBehavAll: ",t);for(let t=0,a=e.behav.length;t<a;t++)if(""!=e.behav[t].group&&r[e.behav[t].group]&&r[e.behav[t].group].objs.push({behav:e.behav[t]}),"LookAt"==e.behav[t].simple_behav&&e.behav[t].obj_id){let r={lookBehav:e.behav[t],lookObjId:e.obj_id};o.push(r)}},this.dealAllGroupHide=function(e,t){let r=this,o=r.groupEventTargetDict[t];if(!o)return void console.log("_dealAllGroup: missing groupDict");let a=["ShowImage2D","ShowImage","ShowText2D","ShowText","ShowModel","PlayMusic","ShowVideo"];for(let t=0;t<e.behav.length;t++){let n=e.behav[t];""!=n.group&&o[n.group]&&o[n.group].objs.forEach(((e,t)=>{let o=e.behav.obj_id,i=r.getObjectTypeByObj_id(o);if("2d"==i.obj_type){let e=i.obj;if(n.obj_id!=o&&e.behav_reference)for(let t=0;t<e.behav_reference.length;t++)if(a.filter((r=>r==e.behav_reference[t].behav_name)).length>0){e.visible=!1;break}}else if("3d"==i.obj_type){let e=i.obj;if(e.object3D.behav_reference&&Array.isArray(e.object3D.behav_reference)&&n.obj_id!=o)for(let t=0;t<e.object3D.behav_reference.length;t++)if(a.filter((r=>r==e.object3D.behav_reference[t].behav_name)).length>0){r.hideAframeGroupObjectEvent(e);break}}}))}},this.speechTextObj=function(e){if(console.log(" _speechTextObj: _textObj: ",e),"object"==typeof speechSynthesis&&"function"==typeof SpeechSynthesisUtterance){1==speechSynthesis.speaking&&(speechSynthesis.pause(),speechSynthesis.cancel());let t=e.speed,r=e.language,o=e.content,a=new SpeechSynthesisUtterance(o);a.rate=t**3*.1837+t**2*-.9948+2.3352*t-.5196,a.pitch=1;let n="en",i="en-US";switch(r){case 0:default:n="en",i="en-US";break;case 1:n="zh-TW",i="zh-TW";break;case 2:n="zh-CN",i="zh-CN";break;case 3:n="ja",i="ja-JP";break;case 4:n="ko",i="ko-KR"}let l=setInterval((function(){let e=!1,t=speechSynthesis.getVoices();t.length>0&&(clearInterval(l),window.Browser&&"safari"!=window.Browser.name&&t.forEach((t=>{t.lang==i&&(e=!0,a.voice=t)})),0==e&&(a.lang=n),speechSynthesis.speak(a))}),1)}},this.dealVideoMuted=function(e){let r=document.getElementById("clickToPlayAudio");r.style.display="block",r.onclick=function(){t.UnMutedAndPlayAllVisibleVideo(),window.allowAudioClicked=!0,r.style.display="none",r.onclick=null,window.alreadyClicked=!0}},this.UnMutedAndPlayAllVisibleVideo=function(e){let t;e&&"a-video"==e.localName&&(t=e);let r=document.getElementsByTagName("a-video");if(console.log("three.js: _UnMutedAndPlayAllVideo: aVideos.length=",r.length),t)for(let e=0;e<r.length;e++){let o=r[e],a=r[e].mp4Video;if(o==t)t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play();else{let r=!0;o.object3D.traverseAncestors((function(n){"Scene"!=n.type?0==n.visible&&(r=!1):(console.log("three.js: _UnMutedAndPlayAllVideo: videoPlane =",e,r,o.object3D.visible,o),1==r&&1==o.object3D.visible&&(a.muted=!0,a.autoplay=!0,a.play()),t.mp4Video.muted=!1,t.mp4Video.autoplay=!0,t.mp4Video.play())}))}}else{let e=!1;for(let t=0;t<r.length;t++){let o=r[t],a=r[t].mp4Video,n=!0;o.object3D.traverseAncestors((function(r){"Scene"!=r.type?0==r.visible&&(n=!1):(console.log("three.js: _UnMutedAndPlayAllVideo: videoPlane =",t,n,o.object3D.visible,o),1!=n||1!=o.object3D.visible||o.blockly||(0==e?(console.log("three.js: _UnMutedAndPlayAllVideo: all parent visible true , _setVideoUnMuted false ",o.object3D),a.muted=!1,a.autoplay=!0,a.play(),e=!0):(console.log("three.js: _UnMutedAndPlayAllVideo: all parent visible true, _setVideoUnMuted true",o.object3D),a.muted=!0,a.autoplay=!0,a.play())))}))}}},this.entitySetTransform=function(e,t,r,o){let a=t.clone();a.multiply(new THREE.Vector3(-1,1,1)),e.setAttribute("position",a);let n=r.clone();n.multiply(new THREE.Vector3(1,-1,-1)),e.setAttribute("rotation",n),e.setAttribute("scale",o)},this.setTransform=function(e,t,r,a,n){if(e&&t&&r&&a&&n&&!(e.isObject3D&&r.isVector3&&a.isVector3&&n.isVector3))return console.warn("_setTransform warning, some parameter are not right"),-1;var i=r.clone();switch(window.serverVersion){case"2.0.0":i.addScaledVector(r,2540/t);break;case"3.0.0":i.addScaledVector(r,5080/t);break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}switch(e.position.add(i),o(e,new THREE.Vector3(1,0,0),-a.x*Math.PI/180),o(e,new THREE.Vector3(0,0,1),-a.y*Math.PI/180),e.rotateZ(a.z*Math.PI/180),window.serverVersion){case"2.0.0":e.scale.copy(n.multiplyScalar(1));break;case"3.0.0":e.scale.copy(n.multiplyScalar(2));break;default:console.log("three.js: _setTransform: serverVersion version wrong",serverVersion)}},this.setAframeTransform=function(e,t,r,o,a,n){e.setAttribute("position",t);let i=e.object3D,l=new THREE.Euler;l.setFromQuaternion(a),l.x=-l.x,l.y=-l.y;let s=new THREE.Quaternion;s.setFromEuler(l),i.setRotationFromQuaternion(s),e.setAttribute("scale",o)},this.setChildTransform=function(e,t,r,o,a,n){let i=r.z;r.z=-i;let l=o.x,s=o.y;o.x=-l,o.y=-s,e.position.add(r.multiplyScalar(2540/t));let c=new THREE.Euler;c.setFromQuaternion(n),c.x=-c.x,c.y=-c.y;let d=new THREE.Quaternion;d.setFromEuler(c),e.setRotationFromQuaternion(d),e.scale.copy(a)},this.getMakarObject=function(e){return 1!=e.makarObject?e.parent?t.getMakarObject(e.parent):0:e},this.getObjectTypeByObj_id=function(e){let t=null,r=null,o=null,a=null,n={obj_type:"",obj_index:null,obj:null};return e&&(this.makarObjects.forEach(((o,a)=>{o.id==e&&(t=o,r=a)})),this.makarObjects2D.forEach(((t,r)=>{t.obj_id==e&&(o=t,a=r)})),null!=t&&null!=r||null!=o&&null!=a?null!=t&&null!=r?(console.log("_getObjectTypeByObj_id: 3d: ",r,t),n.obj_type="3d",n.obj_index=r,n.obj=t):null!=o&&null!=a?(console.log("_getObjectTypeByObj_id: 2d: ",a,o),n.obj_type="2d",n.obj_index=a,n.obj=o):console.log("_getObjectTypeByObj_id: fucking logic trouble.",a,o):null!=t&&null!=r&&null!=o&&null!=a&&(console.log("_getObjectTypeByObj_id: warning, both 2D/3D object get",e,", 3d:",r,t,", 2d:",a,o),n.obj_type="3d",n.obj_index=r,n.obj=t)),n},this.triggerEvent=function(e,r,o){let a,n;switch(e.simple_behav){case"Click3dToPhoneCall":case"PhoneCall":if(console.log("Click3dToPhoneCall: phone=",e.phone),window.Browser)if(window.Browser.desktop){let t=window.document.getElementById("phoneCall");t.href="tel:"+e.phone,console.log("desktop telTag=",t),t.click()}else{let t=window.document.getElementById("phoneCall");t.href="tel:"+e.phone,console.log("cell phone telTag=",t),t.click()}break;case"Click3dToSendEmail":case"SendEmail":if(console.log("Click3dToSendEmail: mail=",e.mail_to),window.Browser)if(window.Browser.desktop){let t=window.document.getElementById("sendEmail");t.href="mailto:"+e.mail_to,t.click(),console.log("desktop: webTag=",t)}else{let t=window.document.getElementById("sendEmail");t.href="mailto:"+e.mail_to,t.click(),console.log("cellphone: webTag=",t)}break;case"Click3dToOpenWebBrowser":case"OpenWebPage":if(console.log("Click3dToOpenWebBrowser: url=",e.url),window.Browser)if(window.Browser.desktop){let t=window.document.getElementById("openWebBrowser");t.href=e.url,t.click(),console.log("desktop: webTag=",t)}else{let t=window.document.getElementById("openWebBrowser");t.href=e.url,t.click(),console.log("mobile: webTag=",t)}break;case"Coloring":console.log("triggerEvent: Coloring: event=",e),1==e.enable&&window.FuncColoring();break;case"SnapShot":let m=[];for(var i=0;i<t.arScene.scene2D.children.length;i++)t.arScene.scene2D.children[i].GCSSID<0&&1==t.arScene.scene2D.children[i].visible&&(m.push(i),t.arScene.scene2D.children[i].visible=!1);for(console.log("------------ self",t,this),t.GLRenderer.autoClear=!1,t.GLRenderer.render(t.arScene.videoScene,t.arScene.videoCamera),t.GLRenderer.clearDepth(),t.GLRenderer.render(t.arfScene.object3D,t.camera),t.GLRenderer.render(t.arScene.scene2D,t.arScene.camera2D),i=0;i<m.length;i++)t.arScene.scene2D.children[m[i]].visible=!0;t.GLRenderer.getSize();var l,s=t.GLRenderer.domElement.toDataURL("image/png",1),c=window.open(""),d=new Image;d.src=s,d.style.position="absolute",d.style.left="10%",d.style.width="80%",l=window.Browser?"safari"==window.Browser.name&&"iphone"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來儲存您的照片。 </p>':"chrome"==window.Browser.name&&"android"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來下載或分享您的照片。 </p>':"mozilla"==window.Browser.name&&"android"==window.Browser.platform?'<br>  <p style="font-size:36px;"> 請輕觸影像來儲存您的照片。 </p>':'<br>  <p style="font-size:36px;"> 請輕觸影像來下載您的照片. </p>':"<br>  <p>Now we can only add context beside the image, because the length of img tag too long </p> <p> 請輕觸影像來下載您的照片.. </p>",c.document.write(l+d.outerHTML);break;case"exchangeCamera":console.log(" trigger exchange camera ");break;case"runAnimation2D":this.runAnimation2D(r,e);break;case"touchPlayAnimation":console.log("three.js: trigger: touchPlayAnimation, event=",e,r),r.animationSlices&&r.animationSlices[0]&&r.animationSlices[0].index&&r.animationSlices.length>e.index&&(r.animationSlices[0].index=e.index),r.playAnimation=!0;break;case"ShowImage":case"ShowModel":case"ShowVideo":case"ShowText":t.showAframeObjectEvent(e,o);break;case"ShowImage2D":for(let r=0;r<t.makarObjects2D.length;r++)t.makarObjects2D[r].obj_id==e.obj_id&&(1==t.makarObjects2D[r].visible?t.makarObjects2D[r].visible=!1:t.makarObjects2D[r].visible=!0);break;case"ShowText2D":for(let r=0;r<t.makarObjects2D.length;r++)t.makarObjects2D[r].obj_id==e.obj_id&&(1==t.makarObjects2D[r].visible?t.makarObjects2D[r].visible=!1:t.makarObjects2D[r].visible=!0);break;case"PlayAnimation":if(console.log("three.js: trigger: PlayAnimation, event=",e,", makarObj=",r),console.log("three.js: triggerEvent: _PlayAnimation: event=",e),a=e.obj_id,n=document.getElementById(a),!n){console.log("three.js: _PlayAnimation: target not exist",n);break}var u;for(let t=1;t<n.object3D.children[0].animationSlices.length;t++)n.object3D.children[0].animationSlices[t].uid==e.uid&&(u=n.object3D.children[0].animationSlices[t].animationName);n.setAttribute("animation-mixer","clip: "+u),e.loop?(n.object3D.children[0].animationSlices[0].loop=e.uid,n.object3D.children[0].animationSlices[0].uid=e.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=!0):(n.object3D.children[0].animationSlices[0].uid=e.uid,n.object3D.children[0].animationSlices[0].changed=!0,n.object3D.children[0].animationSlices[0].reset=e.reset);break;case"PlayMusic":if(a=e.obj_id,n=document.getElementById(a),!n){console.log("three.js: _PlayMusic: target not exist",n);break}console.log("three.js: triggerEvent: _PlayMusic: event=",e),t.showAframeObjectEvent(e,o),n.object3D.children[0]&&n.object3D.children[0].children[0]&&"Audio"==n.object3D.children[0].children[0].type&&(1==n.object3D.children[0].children[0].isPlaying?n.components.sound.stopSound():n.components.sound.playSound());break;case"ReadText":if(console.log("three.js: _ReadText: ",e),e.obj_id){let r=e.obj_id,o=t.currentProjectIndex;sceneResult[o].data.scene_objs_v2.objs,sceneResult&&sceneResult[o]&&sceneResult[o].data&&sceneResult[o].data.scene_objs_v2&&sceneResult[o].data.scene_objs_v2.objs&&Array.isArray(sceneResult[o].data.scene_objs_v2.objs)&&sceneResult[o].data.scene_objs_v2.objs.forEach((e=>{e.obj_id==r&&t.speechTextObj(e)}))}break;case"FingerGesture":break;default:console.log("three.js: trigger: default, event=",e,", makarObj=",r)}},this.setViewMode=function(e=""){let t=this,r=t.aCamera,o=document.getElementById("oCamera");return new Promise((function(a){r&&o&&("AR"==e?(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,a("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: AR err=",e)}))):"model"==e?(t.camera=o.object3D.children[0],t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,a("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _model err=",e)}))):t.camera==r?(t.camera=o.object3D.children[0],t.setViewModeSceneObj("model").then((function(e){t.objectControls.enable=!1,t.enableTracking=!1,a("model")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch model err=",e)}))):(t.camera=r,t.setViewModeSceneObj("AR").then((function(e){t.objectControls.enable=!0,t.enableTracking=!0,a("AR")})).catch((function(e){console.log(" _setViewModeSceneObj: _switch AR err=",e)}))))}))},this.setViewModeSceneObj=function(e){let t=this;return new Promise((function(r,o){let a=0;parent.selectedProject&&parent.selectedProject.proj_id&&publishARProjs.result.forEach(((e,t)=>{e.proj_id==parent.selectedProject.proj_id&&(a=t,console.log(" _setViewModeSceneObj: get id ",t,e))}));let n=0;for(let e=0,r=t.sceneTargetList.length;e<r;e++)publishARProjs.result[a].target_ids.includes(t.sceneTargetList[e].target_id)&&(n=e);console.log(" _setViewModeSceneObj: sceneNo , targetIndex",a,n),null==t.currentProjectIndex?t.currentProjectIndex=a:a=t.currentProjectIndex;let i=publishARProjs.proj_list[a].proj_descr.indexOf("_coloring");i>0&&(i=!0);let l=t.aframeNFTMarkers[a],s=t.threeNFTMarkers2D[a];for(let e in t.aframeNFTMarkers)t.aframeNFTMarkers[e].object3D.visible=!1,t.aframeNFTMarkers[e].setAttribute("visible",!1);for(let e in t.threeNFTMarkers2D)t.threeNFTMarkers2D[e].visible=!1;if("AR"==e)if(1==l.loadedObjects||1==s.loadedObjects)if(s.visible=!1,l.setAttribute("visible",!1),l.object3D.visible=!1,null!=l.coloringStatus&&1==i)if(-1==l.coloringStatus||0==l.coloringStatus){for(console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),l.loadModel=!1;l.children.length>0;)l.children[0].remove();for(;s.children.length>0;)s.remove(s.children[0]);let e=t.loadMakarScene(n,l,s);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(a),r(!0)}))}else 1==l.coloringStatus&&(console.log(" _setViewModeSceneObj: model: color 1"),r(!0));else console.log(" _setViewModeSceneObj: AR: not _coloring module "),r(!0);else r(!0);else if("model"==e){if(1!=l.loadedObjects||1!=s.loadedObjects){l.loadedObjects=s.loadedObjects=!0,1==i&&(l.loadModel=!0,l.coloringStatus=0,(c=t.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",c.fillRect(0,0,t.targetCanvas.width,t.targetCanvas.height));let e=t.loadMakarScene(n,l,s);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(a),r(!0)}))}else if(t.logicList[t.currentProjectIndex]&&0==t.logicList[t.currentProjectIndex].logicSystemState&&t.logicList[t.currentProjectIndex].parseXML(),l.object3D.traverse((function(e){if(e.originTransform){let t=e.originTransform;e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),"text"!=e.makarType&&"light"!=e.makarType&&"video"!=e.makarType&&"model"!=e.makarType||e.resetProperty&&e.resetProperty()}})),null!=l.coloringStatus&&1==i)if(-1==l.coloringStatus){var c;for(console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),l.loadModel=!0,l.coloringStatus=0,(c=t.targetCanvas.getContext("2d")).fillStyle="#FFFFFF",c.fillRect(0,0,t.targetCanvas.width,t.targetCanvas.height);l.children.length>0;)l.children[0].remove();for(;s.children.length>0;)s.remove(s.children[0]);let e=t.loadMakarScene(n,l,s);if(Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]){console.log("three.js: _setViewModeSceneObj : get _logic xml ",t.currentProjectIndex,publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]);let r=t.parseLogicXML(t.currentProjectIndex,0);e.push(r)}Array.isArray(e)&&Promise.all(e).then((function(e){console.log("three.js: _setViewModeSceneObj: done: ret = ",e),Array.isArray(publishARProjs.proj_list[t.currentProjectIndex].xml_urls)&&publishARProjs.proj_list[t.currentProjectIndex].xml_urls[0]&&t.logicList[t.currentProjectIndex].parseXML(),t.setupSceneBehav(a),r(!0)}))}else console.log(" _setViewModeSceneObj: model: _coloring module ",l.coloringStatus),r(!0);else console.log(" _setViewModeSceneObj: model: not _coloring module "),r(!0);s.visible=!0;let e=t.gcssTargets.dpi[l.GCSSID],o=t.gcssTargets.width[l.GCSSID],d=t.gcssTargets.height[l.GCSSID];l.setAttribute("visible",!0),l.object3D.visible=!0,l.object3D.matrixAutoUpdate=!0,l.object3D.position.set(0,0,0),l.object3D.position.add(new THREE.Vector3(25.4*-o/e/2,25.4*-d/e/2,0)),l.object3D.rotation.x=-90*Math.PI/180,l.object3D.updateMatrix(),l.object3D.updateMatrixWorld()}else console.log(" _setViewModeSceneObj: error",e),o(e)}))},this.getSnapShot=function(){let e=this;return new Promise((function(t){if(!(e&&e.GLRenderer&&e.arScene&&e.arScene.videoScene&&e.arScene.videoCamera&&e.arScene.glScene&&e.arScene.camera&&e.arScene.scene2D&&e.arScene.camera2D&&e.GLRenderer.domElement&&e.GLRenderer.domElement.clientWidth&&e.GLRenderer.domElement.clientHeight&&e.GLRenderer.domElement.width&&e.GLRenderer.domElement.height))return console.log(" _XRController: _getSnapShot: something error ",e),void t(-1);let r=[];for(var o=0;o<e.arScene.scene2D.children.length;o++)e.arScene.scene2D.children[o].GCSSID<0&&1==e.arScene.scene2D.children[o].visible&&(r.push(o),e.arScene.scene2D.children[o].visible=!1);for(e.GLRenderer.autoClear=!1,e.GLRenderer.render(e.arScene.videoScene,e.arScene.videoCamera),e.GLRenderer.clearDepth(),e.GLRenderer.render(e.arfScene.object3D,e.camera),e.GLRenderer.render(e.arScene.scene2D,e.arScene.camera2D),o=0;o<r.length;o++)e.arScene.scene2D.children[r[o]].visible=!0;t(e.GLRenderer.domElement.toDataURL("image/png",1))}))},this.checkFBXApplication=function(e,t){if(e["LastSaved|ApplicationName"])switch(e["LastSaved|ApplicationName"].value){case"3ds Max":e.OriginalUnitScaleFactor?(console.log("LastSaved|ApplicationName = 3d Max, OriginalUnitScaleFactor exist scale*",e.OriginalUnitScaleFactor),t.multiplyScalar(e.OriginalUnitScaleFactor)):(console.log("LastSaved|ApplicationName = 3d Max, OriginalUnitScaleFactor not exist scale*100 "),t.multiplyScalar(100));break;case"Maya":e.OriginalUnitScaleFactor?(console.log("LastSaved|ApplicationName = Maya, OriginalUnitScaleFactor exist scale*",e.OriginalUnitScaleFactor),t.multiplyScalar(e.OriginalUnitScaleFactor)):console.log("LastSaved|ApplicationName = Maya, OriginalUnitScaleFactor not exist do nothong");break;default:console.log("not 3ds Max and Maya, LastSaved|ApplicationName = ",e["LastSaved|ApplicationName"])}else console.log("three.js: checkFBXApplication: object not include LastSaved|ApplicationName ")},this.runAnimation2D=function(e,t){if(!e||!t.dt)return console.warn("three.js: _runAnimation2D warning, obj is null "),-1;if(!e.isObject3D)return console.warn("three.js: _runAnimation2D warning, obj is not THREE.Object3D "),-1;if(t.dp&&t.dp.isVector3){var r=t.dp.clone().normalize(),o=t.dp.length(),a=null,n=null,i=null,l=null,s=function(c){a||(a=c),l=i?c-i:0,i=c,(n=c-a)<t.dt&&(e.translateOnAxis(r,o*(l/t.dt)),requestAnimationFrame(s))};requestAnimationFrame(s)}if(t.ds&&t.ds.isVector3){t.ds.x<0||t.ds.y<0||t.ds.z,t.ds.clone().normalize(),t.ds.length();let r=e.scale.clone(),o=t.ds,s=e.scale.clone().multiply(o),d=s.clone().sub(r),u=(new THREE.Vector3(1,1,1).divide(o),s.clone()),m=r.clone().clone().sub(u);a=null,n=null,i=null,l=null;var c=function(o){a||(a=o),l=i?o-i:0,i=o,(n=o-a)<t.dt?(e.scale.copy(r.clone().add(d.clone().multiplyScalar(n/t.dt))),requestAnimationFrame(c)):t.reverse?n<2*t.dt?(e.scale.copy(u.clone().add(m.clone().multiplyScalar((n-t.dt)/t.dt))),requestAnimationFrame(c)):(e.scale.copy(r),console.log("three.js: _runAnimation2D: ds reverse end ",e.scale)):(e.scale.copy(s),console.log("three.js: _runAnimation2D: ds end , not reverse ",e.scale))};requestAnimationFrame(c)}if(t.dopacity&&e.material&&e.material.opacity){console.log("0 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity);var d=e.material.opacity,u=d-t.dopacity,m=(a=null,n=null,function(r){a||(a=r),(n=r-a)<t.dt?(e.material.opacity=d-u*(n/t.dt),requestAnimationFrame(m)):console.log("1 three.js: _runAnimation2D: obj.material.opacity=",e.material.opacity)});requestAnimationFrame(m)}},this.switchCamera=function(e){let r=e||{facing:"environment"};"environment"==t.facing?(r.facing="user",t.facing="user"):(r.facing="environment",t.facing="environment"),t.arScene.video.srcObject.getTracks().forEach((e=>{e.stop()}));let o=function(e){if(console.log("three.js: _startWebCam: videoSuccess: stream=",e),window.videoStream=e,t.videoStreamPlane.material.map.image){let r=t.videoStreamPlane.material.map.image;r.srcObject=e,r.playsInline=!0,r.onloadedmetadata=function(){t.videoCamera?console.log("three.js: _startWebCam: videoCamera exist, donothing "):console.log("three.js: _startWebCam: videoCamera not exist, start video "),function e(){r.videoWidth>200||r.videoHeight>200?(r.play(),console.log("three.js: _switchCamera: video play  ")):setTimeout(e,100)}()},t.streamVideo=r}},a=function(e){console.log("three.js: _switchCamera: onError e = ",e)};navigator.mediaDevices.enumerateDevices().then((function(e){let t,n,i,l=!1;e=e.filter((function(e){return"videoinput"===e.kind})),n="environment"==r.facing?"back":"user"==r.facing?"front":"back";for(let r in e)-1!=e[r].label.toLowerCase().search(n)&&(t=e[r].deviceId,l=!0);if(l)console.log("three.js: _useDeviceID true, cameraID=",t),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},deviceId:{exact:t}}};else{let e;r.facing?(e=r.facing,console.log("three.js: _configuration.facing do exist: set facing = ",e),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:e}}):(console.log("api.js: _configuration.facing dosent exist: set facing = environment"),i={video:{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:800},frameRate:{min:15,ideal:30,max:60},facingMode:"environment"}})}navigator.mediaDevices.getUserMedia(i).then(o,a)}))},this.parseLogicXML=function(e,t){let r;if(publishARProjs.result[e].xml_urls&&publishARProjs.result[e].xml_urls[t]){let o=publishARProjs.result[e].xml_urls[t];console.log("three.js: _parseLogicXML: xmlURL = ",o);let a=new Logic;r=a.loadXMLtoDoc(o),arController.logicList[e]=a}return r}}function r(e){return Math.floor(Math.random()*Math.floor(e))}function o(e,t,r){let o;o=new THREE.Matrix4,o.makeRotationAxis(t.normalize(),r),o.multiply(e.matrix),e.matrix=o,e.rotation.setFromRotationMatrix(e.matrix)}};var t=document.createEvent("HTMLEvents");t.initEvent("integrated",!0,!0),t.eventType="message",document.dispatchEvent(t)}(),window.addEventListener("keyup",(function(e){13===e.keyCode&&(e.preventDefault(),console.log("enter keyup"))}))):setTimeout(n,50)};let i;if("undefined"!=typeof window&&n(),parent){let e=parent.location.pathname.indexOf("/",0),t=parent.location.pathname.indexOf("/",e+1);i=window.languageType=parent.location.pathname.substring(1,t)}i="tw";let l=window.worldContent={inputSearch:{tw:"搜尋",en:"Search"},labelSelected:{tw:"精選",en:"Selected"},userAlreadyPlayed:{tw:"此登入用戶已經遊玩過",en:"This user already played"},userNotLoginInfo:{tw:"必須要登入MAKAR後才可遊玩",en:"Please login at first"},clickToPlay:{tw:"點擊開始遊玩",en:"Click to play"},targetNumberError:{tw:"辨識圖的數量不可超過20 ",en:"the max number of image targets can't larger than 20 "},backToHome:{tw:"專案標題",en:"back"},GPSDistanceMsg:{tw:"需在GPS的範圍內才能開啟 \r\n 距離：",en:"please to the right place"},GPSErrorMsg:{tw:"GPS 錯誤",en:"GPS error"},GPSnotSupportMsg:{tw:"沒有支援 GPS ",en:"GPS not support"},comfirm:{tw:"確認",en:"comfire"},timeIsUp:{tw:"時間到",en:"Time is up"}}}();